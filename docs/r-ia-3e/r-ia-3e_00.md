# 前置内容

## 前言

没有图片或对话的书有什么用？

——爱丽丝，《爱丽丝梦游仙境》

它是神奇的，有宝藏可以满足微妙和粗俗的欲望；但它不是为胆小的人准备的。

——Q，“Q 是谁？”《星际迷航：下一代》

当我开始写这本书时，我花了很多时间去寻找一个好的引言来开始。我最终找到了两个。R 是一个探索、可视化和理解数据的奇妙灵活的平台和语言。我选择了来自《爱丽丝梦游仙境》的引言来捕捉今天统计分析的风味——一个探索、可视化和解释的互动过程。

第二个引言反映了普遍认为 R 难以学习的观点。我希望向你展示，这并不一定如此。R 广泛而强大，拥有如此多的分析和图形功能（最后统计超过 50,000 个），它很容易让新手和经验丰富的用户都感到害怕。但表面上的疯狂是有原因的。有了指导和说明，你可以导航可用的巨大资源，选择你需要来完成工作的工具，以风格、优雅、效率——以及一点点酷。

几年前，当我申请一个新的统计咨询职位时，我第一次接触到了 R。潜在的雇主在面试前的材料中问我是否熟悉 R。遵循招聘人员的标准建议，我立刻说“是”，并开始学习它。我是一名经验丰富的统计学家和研究人员，有 25 年作为 SAS 和 SPSS 程序员的经验，并且精通六种编程语言。这能有多难？这是著名的最后遗言。

当我试图尽快学习这门语言（面试即将来临）时，我发现要么是关于语言底层结构的巨著，要么是针对特定高级统计方法的密集论文，这些论文是由和为该领域专家所写。在线帮助以斯巴达风格编写，更像参考而不是教程。每次当我以为我已经掌握了 R 的整体组织和功能时，我都会发现一些新的东西，让我感到无知和渺小。

为了理解这一切，我将 R 视为一个数据科学家。我思考了成功处理、分析和理解数据需要什么，包括

+   访问数据（将数据从多个来源导入应用程序）

+   清洗数据（编码缺失数据，修复或删除错误编码的数据，将变量转换为更有用的格式）

+   注释数据（记住每一部分代表什么）

+   总结数据（获取描述性统计以帮助描述数据）

+   可视化数据（因为一张图片确实胜过千言万语）

+   模拟数据（揭示关系和测试假设）

+   准备结果（创建出版物质量的表格和图形）

然后，我试图理解如何使用 R 完成这些任务中的每一个。因为我通过教学来学习最好，所以我最终创建了一个网站 ([www.statmethods.net](http://www.statmethods.net)) 来记录我所学到的知识。

然后，大约一年后，Marjan Bace，Manning 出版社的出版人，打电话问我是否愿意写一本关于 R 的书。我已经写了 50 篇期刊文章、4 本技术手册、许多本书的章节，以及一本关于研究方法的书，所以这能有多难呢？冒着重复的风险——这是最后的遗言。

第一版于 2011 年出版，第二版于 2015 年出版。我大约两年半前开始着手编写第三版。描述 R 总是一个不断变化的目标，但最近几年发生了一场某种意义上的革命。这得益于大数据的增长、tidyverse ([tidyverse.org](http://tidyverse.org)) 软件被广泛采用、新的预测分析和机器学习方法的快速发展，以及新的、更强大的数据可视化技术的发展。我希望第三版能够公正地反映这些重要的变化。

您手中所持的这本书是我多年前一直希望拥有的。我试图为您提供一本 R 的指南，让您能够快速访问这个伟大开源项目的力量，而无需经历所有的挫折和焦虑。希望您喜欢它。

P.S. 我被提供了这份工作，但我没有接受。但是学习 R 让我的职业生涯走向了我从未预料到的方向。生活有时真的很幽默。

## 致谢

许多人努力使这本书变得更好。他们包括以下人员：

+   Marjan Bace，Manning 出版社的出版人，他最初邀请我写这本书。

+   Sebastian Stirling、Jennifer Stout 和 Karen Miller，分别负责第一版、第二版和第三版的发展编辑。他们各自投入了大量的时间来帮助我组织材料、阐明概念，并使文本更加有趣。

+   Mike Shepard，技术校对员，他帮助揭示了一些容易混淆的领域，并为测试代码提供了独立和专业的视角。我依赖他细致的审查和深思熟虑的判断。

+   Aleks Dragosavljević，我的审稿编辑，他帮助获得审稿人和协调审稿过程。

+   Deirdre Hiam，她帮助这本书顺利通过了生产过程，以及她的团队：Suzanne G. Fox，我的校对编辑，和 Katie Tennant，我的校对员。

+   那些花费自己宝贵时间仔细阅读材料、寻找错别字并提出宝贵实质性建议的同行审稿人：Alain Lompo、Alessandro Puzielli、Arav Agarwal、Ashley Paul Eatly、Clemens Baader、Daniel C Daugherty、Daniel Kenney-Jung、Erico Lendzian、James Frohnhofer、Jean-François Morin、Jenice Tom、Jim Frohnhofer、Kay Engelhardt、Kelvin Meeks、Krishna Shrestha、Luis Felipe Medeiro Alves、Mario Giesel、Martin Perry、Nick Drozd、Nicole Koenigstein、Robert Samohyl、Tiklu Ganguly、Tom Jeffries、Ulrich Gauger、Vishal Singh。

+   在书完成之前就购买了这本书的许多 Manning Early Access Program (MEAP) 参与者，提出了很好的问题，指出了错误，并提出了有用的建议。

每位贡献者都使这本书变得更好、更全面。

我还想感谢许多为使 R 成为一个如此强大的数据分析平台做出贡献的软件作者。他们不仅包括核心开发者，还包括那些无私地创建和维护贡献包的个人，极大地扩展了 R 的功能。附录 E 提供了本书中描述的贡献包作者的列表。特别是，我想提到 John Fox、Hadley Wickham、Frank E. Harrell, Jr.、Deepayan Sarkar 和 William Revelle，我非常钦佩他们的作品。我已经尽力准确地代表他们的贡献，并且我对本书中无意中包含的任何错误或扭曲负有完全责任。

我真的应该首先感谢我的妻子和伴侣，Carol Lynn。尽管她对统计学或编程没有内在的兴趣，但她阅读了每一章多次，并提出了无数次的纠正和建议。没有任何人比阅读另一人的多元统计分析更伟大的爱了。同样重要的是，她以优雅、支持和爱意忍受了我写作这本书时的漫长夜晚和周末。我无法给出合理的解释，为什么我会这么幸运。

我还想感谢另外两个人。一个是我的父亲，他对科学的热爱是鼓舞人心的，并让我对数据的价值有了认识。我非常想念他。另一个是我的研究生导师 Gary K. Burger，当我以为我想成为一名临床医生时，Gary 让我对统计学和教学产生了兴趣。这完全是他的错。

## 关于这本书

如果你拿起这本书，你可能有一些需要收集、总结、转换、探索、建模、可视化或展示的数据。如果是这样，那么 R 就是为你准备的。R 已经成为全球统计学、预测分析和数据可视化的语言。它提供了目前可用的最广泛的方法来理解数据，从最基础的到最复杂和前沿的。

作为开源项目，它可以在包括 Windows、macOS 和 Linux 在内的各种平台上免费使用。它正在不断开发中，每天都有新的程序被添加。此外，R 还得到了一个庞大且多样化的数据科学家和程序员社区的支援，他们乐于向用户提供帮助和建议。

虽然 R 可能最出名的是其创建美丽和复杂图表的能力，但它几乎可以处理任何统计问题。基础安装提供了数百个数据管理、统计和图形功能，直接从盒子里出来。但其中一些最强大的功能来自于贡献作者提供的数千个扩展（包）。

这种广度是有代价的。对于新用户来说，可能很难把握 R 是什么以及它能做什么。即使是经验最丰富的 R 用户也可能惊讶地发现他们之前不知道的功能。

《*R in Action, 第三版*》为您提供了对 R 的引导性介绍，对平台及其功能有一个 2,000 英尺的高度视角。它将向您介绍基础安装中最重要的函数以及 70 多个最有用的贡献包。在整个书中，目标是实际应用——如何理解您的数据并将这种理解传达给他人。当您完成时，您应该对 R 的工作原理、它能做什么以及您可以去哪里学习更多有很好的把握。您将能够应用各种数据可视化技术，并具备解决基本和高级数据分析问题的技能。

### 第三版的新内容

第三版有许多变化，包括对 tidyverse 数据管理和分析方法的广泛覆盖。以下是一些更显著的变化。

第二章（创建数据集）现在包括对 `readr`、`readxl` 和 `haven` 包的介绍，用于导入数据。还有一个关于 `tibbles` 的新章节，这是数据框的现代更新。

第三章（基本数据管理）和第五章（高级数据管理）包括对 `dplyr` 和 `tidyr` 包的介绍，用于数据管理、转换和汇总。

第四章（图形入门）、第六章（基本图形）、第十一章（中级图形）和第十九章（高级图形）都是新章节，对 `ggplot2` 及其扩展提供了广泛的覆盖。

第十六章（聚类分析）提供了改进的图形和关于评估数据聚类能力的新章节。

第十七章（分类）有一个关于使用分解和 Shapley 值图来理解黑盒模型的新章节。

第十八章（缺失数据的高级方法）已经扩展，新增了关于 k 近邻和随机森林方法对缺失值插补的新内容。

第二十章（高级编程）有关于非标准评估和可视调试的新章节。

第二十一章（创建动态报告）扩展了 R Markdown 的覆盖范围，并增加了关于参数化报告和常见编码错误的新章节。

第二十二章（创建包）已完全重写，以包含用于简化包创建的新工具。还有关于如何通过 CRAN、GitHub 和软件生成的网站分享和推广您的包的新章节。

附录 A（图形用户界面）已更新，以反映该领域的快速变化。

附录 B（自定义启动环境）已修订，包括新的自定义方法和对可重复研究潜在副作用敏感性的提高。

附录 F（处理大型数据集）涵盖了适用于大于 RAM 数据集的新包、针对千兆级问题的分析方法和将 R 与云服务集成的内容。

本书中有关于使用 RStudio 进行编程、调试、报告编写和包创建的新章节，散布全书。最后，全书进行了许多更新和修正。

### 适合阅读此书的人群

*《R 实战，第三版》* 应该对任何处理数据的人都有吸引力。不假设有统计编程或 R 语言的背景。尽管本书对新手来说很容易理解，但应该有足够的新颖和实用材料，甚至能满足经验丰富的 R 专家的需求。

没有统计背景但想使用 R 来操作、总结和绘图数据的用户会发现第 1-6 章、第十一章和第十九章很容易理解。第七章和第十章假设统计学为一学期课程；第八章、第九章和第 12-18 章的读者将受益于两个学期的统计学。第 20-22 章更深入地探讨了 R 语言，没有统计学先决条件。我尽量让每个章节都让初学者和专家数据分析师都能找到有趣和有用的内容。

### 本书如何组织：路线图

本书旨在为您提供一个 R 平台的导游，重点关注那些最适用于操作、可视化和理解数据的技巧。本书共有 22 章，分为 5 部分：“入门”，“基本方法”，“中级方法”，“高级方法”和“扩展技能”。七个附录中涵盖了其他主题。

第一章从介绍 R 及其作为数据分析平台如此有用的特性开始。本章涵盖了如何获取程序以及如何通过在线可用的扩展增强基本安装。本章的其余部分用于探索用户界面和了解如何运行您的第一个程序。

第二章涵盖了将数据输入 R 的许多方法。本章的前半部分介绍了 R 用于存储数据的结构。后半部分讨论了从键盘、文本文件、网页、电子表格、统计软件包和数据库导入数据到 R 的方法。

第三章涵盖了基本的数据管理，包括排序、合并和子集化数据集，以及变换、重新编码和删除变量。

第四章通过图形语法介绍数据可视化。我们回顾了创建图形、修改它们以及以各种格式保存图形的方法。

建立在第三章内容的基础上，第五章涵盖了使用函数（数学、统计、字符）和控制结构（循环、条件执行）进行数据管理的应用。然后我们讨论了如何编写自己的 R 函数以及如何以各种方式重塑和汇总数据。

第六章演示了创建常见单变量图形的方法，例如条形图、饼图、直方图、密度图、箱线图、树状图和点图。每种图形都有助于理解单个变量的分布。

第七章首先展示了如何总结数据，包括描述性统计和交叉表的使用。然后我们探讨了解释两个变量之间关系的基本方法，包括相关系数、t 检验、卡方检验和非参数方法。

第八章介绍了回归方法，用于建模数值结果变量与一组一个或多个数值预测变量之间的关系。详细讨论了拟合这些模型、评估其适当性和解释其意义的方法。

第九章通过方差分析和其变体来考虑基本实验设计的分析。在这里，我们通常对治疗组合或条件如何影响数值结果感兴趣。还涵盖了评估分析适当性和可视化结果的方法。

第十章详细介绍了功效分析。从假设检验的讨论开始，本章重点介绍了如何确定在给定置信度下检测到特定大小治疗效应所需的样本量。这可以帮助你规划可能产生有用结果的实验和准实验研究。

第十一章在第六章的基础上扩展了内容，涵盖了创建有助于可视化两个或更多变量之间关系的图形。这些包括各种类型的二维和三维散点图、散点图矩阵、线图、自相关图和 mosaic 图。

第十二章介绍了在数据来自未知或混合分布、样本量小、异常值是问题、或者基于理论分布设计适当的测试过于复杂且数学上难以处理的情况下，效果良好的分析方法。它们包括重采样和自助法——这些是易于在 R 中实现的计算密集型方法。

第十三章在第八章回归方法的基础上进行了扩展，涵盖了非正态分布的数据。章节从讨论广义线性模型开始，然后专注于尝试预测结果变量为分类（逻辑回归）或计数（泊松回归）的情况。

多变量数据问题的一个挑战是简化。第十四章描述了将大量相关变量转换成较小的一组不相关变量的方法（主成分分析），以及揭示给定变量集下潜在结构的方法（因子分析）。适当分析中涉及的许多步骤都进行了详细说明。

第十五章描述了创建、操作和建模时间序列数据的方法。它涵盖了可视化分解时间序列数据以及预测未来值的指数和 ARIMA 方法。

第十六章展示了将观测值聚类到自然发生组中的方法。章节从讨论综合聚类分析中的常见步骤开始，然后介绍了层次聚类和分区方法。还介绍了确定适当聚类数量的几种方法。

第十七章介绍了用于将观测值分类到组中的流行监督机器学习方法。依次考虑了决策树、随机森林和支持向量机。你还将了解评估每种方法准确性的方法。还介绍了理解结果的新方法。

为了保持我展示数据分析实用方法的尝试，第十八章探讨了处理缺失数据值这一普遍问题的现代方法。R 语言支持多种优雅的方法来分析不完整的数据集。这里描述了其中一些最好的方法，并提供了何时使用哪些方法以及何时避免使用哪些方法的指导。

第十九章通过深入探讨自定义坐标轴、颜色方案、字体、图例、注释和绘图区域来结束对图形的讨论。你将学习如何将多个图形组合成一个单一的图表。最后，你将学习如何将静态图形转换为基于网络的交互式可视化。

第二十章涵盖了高级编程技术。你将了解面向对象编程技术和调试方法。本章还提供了高效编程的技巧。如果你正在寻求更深入地了解 R 语言的工作原理，这将特别有帮助，并且它是第二十二章的先决条件。

第二十一章描述了从 R 语言内部创建吸引人报告的几种方法。你将学习如何从你的 R 代码生成网页、报告、文章，甚至书籍。生成的文档可以包括你的代码、结果表、图表和评论。

最后，第二十二章提供了一个创建 R 包的逐步指南。这将使你能够创建更复杂的程序，高效地记录它们，并与他人分享。关于分享和推广你的包的方法将在详细讨论。

后记会指引你到许多关于 R 语言的最佳互联网网站，帮助你加入 R 社区，解答问题，并跟上这个快速变化的产品的发展。

最后，但同样重要的是，七个附录（A 至 G）扩展了文本的范围，包括如 R 图形用户界面、定制和升级 R 安装、将数据导出到其他应用程序、使用 R 进行矩阵代数（类似于 MATLAB）、以及处理非常大的数据集等有用的主题。

我们还提供了一章额外的章节，仅在出版商的网站上提供，网址为[`www.manning.com/books/r-in-action-third-edition`](https://www.manning.com/books/r-in-action-third-edition)。在线第二十三章涵盖了`lattice`包，这是 R 语言中数据可视化的另一种方法。

### 数据挖掘者的建议

数据挖掘是分析领域的一个分支，专注于在大数据集中发现模式。许多数据挖掘专家正在转向 R 语言，因为它具有前沿的分析能力。如果你是一名正在转向 R 语言的数据挖掘者，希望尽快掌握这门语言，我建议以下阅读顺序：第一章（介绍），第二章（数据结构和与你的环境相关的数据导入部分），第四章（基本数据管理），第七章（描述性统计），第八章（第 1、2 和 6 节，回归），第十三章（第二部分，逻辑回归），第十六章（聚类），第十七章（分类），以及附录 F（处理大型数据集）。然后根据需要回顾其他章节。

### 关于代码

为了使这本书尽可能广泛地适用，我选择了来自心理学、社会学、医学、生物学、商业和工程等多个学科的例子。这些例子都不需要对该领域有专门的知识。

这些示例中使用的数据集被选中是因为它们提出了有趣的问题，并且它们很小。这让你能够专注于描述的技术，并快速理解涉及的过程。当你学习新方法时，越小越好。数据集包含在 R 的基本安装中，或者可以通过在线提供的附加包获得。

本书使用以下排版约定：

+   代码列表使用等宽字体，应直接输入。

+   等宽字体也用于一般文本中，以表示代码单词或先前定义的对象。

+   代码列表中的 *`斜体`* 表示占位符。你应该用适当的文本和值替换它们，以解决手头的问题。例如，*`path_to_my_file`* 将被替换为计算机上文件的实际路径。

+   R 是一种交互式语言，它通过提示（默认为 `>`）来指示用户输入下一行。本书中的许多列表都捕捉了交互会话。当你看到以 `>` 开头的代码行时，不要输入提示。

+   使用代码注释代替内联注释（Manning 书籍中的常见约定）。此外，一些注释带有编号的子弹点（如 ❶），它们引用文本中稍后出现的解释。

+   为了节省空间或使文本更易读，交互会话的输出可能包括额外的空白或省略与讨论点无关的文本。

你可以从本书的 liveBook（在线）版本中获取可执行的代码片段，网址为 [`livebook.manning.com/book/r-in-action-third-edition`](https://livebook.manning.com/book/r-in-action-third-edition)。书中示例的完整代码可以从 Manning 网站 [`www.manning.com/books/r-in-action-third-edition`](https://www.manning.com/books/r-in-action-third-edition) 和 GitHub [www.github.com/rkabacoff/RiA3](http://www.github.com/rkabacoff/RiA3) 下载。为了最大限度地利用本书，我建议你在阅读时尝试这些示例。

最后，有一个常见的格言说，如果你问两位统计学家如何分析一个数据集，你会得到三个答案。这个断言的反面是，每个答案都会让你更接近对数据的理解。我并不声称某个特定的分析是最佳或唯一的方法。使用本书中教授的技能，我邀请你玩转数据，看看你能学到什么。R 是交互式的，最好的学习方式就是实验。

### liveBook 讨论论坛

购买《R in Action，第三版》包括免费访问 liveBook，这是曼宁的在线阅读平台。使用 liveBook 的独家讨论功能，您可以在全球范围内或针对特定章节或段落附加评论。为自己做笔记、提问和回答技术问题，以及从作者和其他用户那里获得帮助都非常简单。要访问论坛，请访问 [`livebook.manning.com/book/r-in-action-third-edition/discussion`](https://livebook.manning.com/book/r-in-action-third-edition/discussion)。您还可以在 [`livebook.manning.com/discussion`](https://livebook.manning.com/discussion) 上了解更多关于曼宁论坛和行为准则的信息。

曼宁对读者的承诺是提供一个场所，让读者之间以及读者与作者之间可以进行有意义的对话。这不是对作者参与特定数量活动的承诺，作者对论坛的贡献仍然是自愿的（且未付费）。我们建议您尝试向作者提出一些挑战性的问题，以免他的兴趣转移。只要该书有售，论坛和先前讨论的存档将可通过出版社的网站访问。

## 关于作者

Dr. Robert Kabacoff 是韦斯利安大学定量分析学教授，同时也是一位经验丰富的数据科学家，在商业、医疗保健和政府环境中提供统计编程和数据分析支持已有 30 多年。他教授过本科生和研究生数据分析与统计编程课程，并管理着位于 [statmethods.net](http://statmethods.net) 的 Quick-R 网站，以及位于 [rkabacoff.github.io/datavis](http://rkabacoff.github.io/datavis) 的 R 数据可视化网站。

## 关于封面插图

《R in Action，第三版》封面上的图像是“来自扎达尔的人”，取自尼古拉·阿森诺维奇（Nikola Arsenović）拍摄于 19 世纪中叶的克罗地亚传统服饰专辑。

在那些日子里，人们通过他们的着装很容易就能识别出他们住在哪里，以及他们的职业或社会地位。曼宁通过基于几个世纪前丰富多样的地区文化的封面设计，庆祝计算机行业的创新和主动性，这些文化通过像这样的收藏品中的图片被重新带回生活。
