<html><head></head><body><section data-pdf-bookmark="Chapter 8. Data Manipulation and Visualization in R" data-type="chapter" epub:type="chapter"><div class="chapter" id="r-data-manipulation-visualization">&#13;
<h1><span class="label">Chapter 8. </span>Data Manipulation and Visualization in R</h1>&#13;
&#13;
&#13;
<p>American <a data-primary="data cleaning" data-type="indexterm" id="idm46274542746968"/>statistician Ronald Thisted once quipped: “Raw data, like raw potatoes, usually require cleaning before use.” Data manipulation takes time, and you’ve felt the pain if you’ve ever done the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Select, drop, or create calculated columns</p>&#13;
</li>&#13;
<li>&#13;
<p>Sort or filter rows</p>&#13;
</li>&#13;
<li>&#13;
<p>Group by and summarize categories</p>&#13;
</li>&#13;
<li>&#13;
<p>Join multiple datasets by a common field</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Chances are, you’ve <a data-primary="data manipulation" data-secondary="in Excel" data-secondary-sortas="Excel" data-type="indexterm" id="idm46274542741336"/><a data-primary="Excel" data-secondary="data manipulation with" data-type="indexterm" id="idm46274542740056"/><a data-primary="PivotTables, Excel" data-secondary="for data manipulation" data-secondary-sortas="data manipulation" data-type="indexterm" id="idm46274542739112"/><a data-primary="VLOOKUP() function, Excel" data-type="indexterm" id="idm46274542737896"/>done all of these in Excel…<em>a lot</em>, and you’ve probably dug into celebrated features like <code>VLOOKUP()</code> and PivotTables to accomplish them. In this chapter, you’ll learn the <a data-primary="data manipulation" data-secondary="in R" data-secondary-sortas="R" data-type="indexterm" id="ch8_term1"/><a data-primary="R programming language" data-secondary="data manipulation" data-type="indexterm" id="ch8_term2"/>R equivalents of these techniques, particularly with the help of <code>dplyr</code>.</p>&#13;
&#13;
<p>Data manipulation often goes hand in hand with visualization: as mentioned, humans are remarkably adept at visually processing information, so it’s a great way to size up a dataset. You’ll learn how to visualize data using the gorgeous <code>ggplot2</code> package, which like <code>dplyr</code> is part of the <code>tidyverse</code>. This will put you on solid footing to explore and test relationships in data using R, which will be covered in <a data-type="xref" href="ch09.html#r-capstone">Chapter 9</a>. Let’s get started by calling in the relevant packages. We’ll also be <a data-primary="Star dataset example" data-secondary="in R" data-secondary-sortas="R" data-type="indexterm" id="idm46274542710216"/>using the <em>star</em> dataset from the book’s <a href="https://oreil.ly/lmZb7">companion repository</a> in this chapter, so we can import it now:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">library</code><code class="p">(</code><code class="n">tidyverse</code><code class="p">)</code>&#13;
<code class="nf">library</code><code class="p">(</code><code class="n">readxl</code><code class="p">)</code>&#13;
&#13;
<code class="n">star</code> <code class="o">&lt;-</code> <code class="nf">read_excel</code><code class="p">(</code><code class="s">'datasets/star/star.xlsx'</code><code class="p">)</code>&#13;
<code class="nf">head</code><code class="p">(</code><code class="n">star</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 8</code>&#13;
<code class="c1">#&gt;   tmathssk treadssk classk            totexpk sex   freelunk race  schidkn</code>&#13;
<code class="c1">#&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1      473      447 small.class             7 girl  no       white      63</code>&#13;
<code class="c1">#&gt; 2      536      450 small.class            21 girl  no       black      20</code>&#13;
<code class="c1">#&gt; 3      463      439 regular.with.aide       0 boy   yes      black      19</code>&#13;
<code class="c1">#&gt; 4      559      448 regular                16 boy   no       white      69</code>&#13;
<code class="c1">#&gt; 5      489      447 small.class             5 boy   yes      white      79</code>&#13;
<code class="c1">#&gt; 6      454      431 regular                 8 boy   yes      white       5</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Data Manipulation with dplyr" data-type="sect1"><div class="sect1" id="idm46274542706872">&#13;
<h1>Data Manipulation with dplyr</h1>&#13;
&#13;
<p><code>dplyr</code> is a popular package built to manipulate <a data-primary="data structures" data-secondary="tabular" data-type="indexterm" id="idm46274542673496"/><a data-primary="tabular data structures" data-type="indexterm" id="idm46274542672520"/><a data-primary="data manipulation" data-secondary="dplyr for" data-type="indexterm" id="ch8_term6"/><a data-primary="dplyr, R" data-secondary="data manipulation with" data-type="indexterm" id="ch8_term7"/>tabular data structures. Its many <a data-primary="data manipulation" data-secondary="dplyr functions (verbs) for" data-type="indexterm" id="idm46274542669288"/><a data-primary="dplyr, R" data-secondary="verbs (functions) of" data-type="indexterm" id="idm46274542668376"/><a data-primary="R programming language" data-secondary="functions" data-type="indexterm" id="idm46274542667432"/>functions, or <em>verbs</em>, work similarly and can be easily used together. <a data-type="xref" href="#dplyr-grammar">Table 8-1</a> lists some <a data-primary="select() function, R" data-type="indexterm" id="ch8_term3"/><a data-primary="mutate() function, R" data-type="indexterm" id="idm46274542664072"/><a data-primary="rename() function, R and Python" data-type="indexterm" id="idm46274542663400"/><a data-primary="arrange() function, R" data-type="indexterm" id="idm46274542662760"/><a data-primary="filter() function, R" data-type="indexterm" id="idm46274542662088"/><a data-primary="group_by() function, R" data-type="indexterm" id="idm46274542661416"/><a data-primary="summarize() function, R" data-type="indexterm" id="idm46274542660744"/><a data-primary="left_join() function, R" data-type="indexterm" id="idm46274542660072"/><a data-primary="functions" data-secondary="in R" data-secondary-sortas="R" data-type="indexterm" id="idm46274542659400"/>common <code>dplyr</code> functions and their uses; this chapter covers each of these.</p>&#13;
<table id="dplyr-grammar">&#13;
<caption><span class="label">Table 8-1. </span>Frequently used verbs of <code>dplyr</code></caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Function</th>&#13;
<th>What it does</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>select()</code></p></td>&#13;
<td><p>Selects given columns</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>mutate()</code></p></td>&#13;
<td><p>Creates new columns based on existing columns</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>rename()</code></p></td>&#13;
<td><p>Renames given columns</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>arrange()</code></p></td>&#13;
<td><p>Reorders rows given criteria</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>filter()</code></p></td>&#13;
<td><p>Selects rows given criteria</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>group_by()</code></p></td>&#13;
<td><p>Groups rows by given columns</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>summarize()</code></p></td>&#13;
<td><p>Aggregates values for each group</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>left_join()</code></p></td>&#13;
<td><p>Joins matching records from Table B to Table A; result is <code>NA</code> if no match found in Table B</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>For the sake of brevity, I won’t cover all of the functions of <code>dplyr</code> or even all the ways to use the functions that we do cover. To learn more about the package, <a data-primary="R programming language" data-secondary="further reading on" data-type="indexterm" id="idm46274542638712"/><a data-primary="dplyr, R" data-secondary="further reading on" data-type="indexterm" id="idm46274542637736"/>check out <a class="orm:hideurl" href="https://oreil.ly/KGoCV"><em>R for Data Science</em></a> by Hadley Wickham and Garrett Grolemund (O’Reilly). You can also access a helpful cheat sheet summarizing how the many functions of <code>dplyr</code> work together by navigating in RStudio to Help → Cheatsheets → Data Transformation with <code>dplyr</code>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Column-Wise Operations" data-type="sect2"><div class="sect2" id="idm46274542634488">&#13;
<h2>Column-Wise Operations</h2>&#13;
&#13;
<p>Selecting and <a data-primary="data manipulation" data-secondary="in Excel" data-secondary-sortas="Excel" data-type="indexterm" id="idm46274542632504"/><a data-primary="Excel" data-secondary="data manipulation with" data-type="indexterm" id="idm46274542631224"/><a data-primary="columns" data-secondary="data manipulation operations for" data-type="indexterm" id="ch8_term4"/><a data-primary="data manipulation" data-secondary="of columns" data-secondary-sortas="columns" data-type="indexterm" id="ch8_term5"/><a data-primary="columns" data-secondary="dropping" data-type="indexterm" id="ch8_term8"/><a data-primary="dropping columns" data-type="indexterm" id="ch8_term22"/>dropping columns in Excel often requires hiding or deleting them. This can be difficult to audit or reproduce, because hidden columns are easily overlooked, and deleted columns aren’t easily recovered. The <code>select()</code> function can be used to choose given columns from a data frame in R. For <code>select()</code>, as with each of these functions, the first argument will be which data frame to work with. Additional arguments are then provided to manipulate the data in that data frame. For example, we can select <em>tmathssk</em>, <em>treadssk</em>, and <em>schidkin</em> from <code>star</code> like this:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">select</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">tmathssk</code><code class="p">,</code> <code class="n">treadssk</code><code class="p">,</code> <code class="n">schidkn</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 5,748 x 3</code>&#13;
<code class="c1">#&gt;    tmathssk treadssk schidkn</code>&#13;
<code class="c1">#&gt;       &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt;  1      473      447      63</code>&#13;
<code class="c1">#&gt;  2      536      450      20</code>&#13;
<code class="c1">#&gt;  3      463      439      19</code>&#13;
<code class="c1">#&gt;  4      559      448      69</code>&#13;
<code class="c1">#&gt;  5      489      447      79</code>&#13;
<code class="c1">#&gt;  6      454      431       5</code>&#13;
<code class="c1">#&gt;  7      423      395      16</code>&#13;
<code class="c1">#&gt;  8      500      451      56</code>&#13;
<code class="c1">#&gt;  9      439      478      11</code>&#13;
<code class="c1">#&gt; 10      528      455      66</code>&#13;
<code class="c1">#&gt; # ... with 5,738 more rows</code></pre>&#13;
&#13;
<p>We can also use the <code>-</code> operator with <code>select()</code> to <em>drop</em> given columns:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">select</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="o">-</code><code class="n">tmathssk</code><code class="p">,</code> <code class="o">-</code><code class="n">treadssk</code><code class="p">,</code> <code class="o">-</code><code class="n">schidkn</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 5,748 x 5</code>&#13;
<code class="c1">#&gt;    classk            totexpk sex   freelunk race</code>&#13;
<code class="c1">#&gt;    &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;</code>&#13;
<code class="c1">#&gt;  1 small.class             7 girl  no       white</code>&#13;
<code class="c1">#&gt;  2 small.class            21 girl  no       black</code>&#13;
<code class="c1">#&gt;  3 regular.with.aide       0 boy   yes      black</code>&#13;
<code class="c1">#&gt;  4 regular                16 boy   no       white</code>&#13;
<code class="c1">#&gt;  5 small.class             5 boy   yes      white</code>&#13;
<code class="c1">#&gt;  6 regular                 8 boy   yes      white</code>&#13;
<code class="c1">#&gt;  7 regular.with.aide      17 girl  yes      black</code>&#13;
<code class="c1">#&gt;  8 regular                 3 girl  no       white</code>&#13;
<code class="c1">#&gt;  9 small.class            11 girl  no       black</code>&#13;
<code class="c1">#&gt; 10 small.class            10 girl  no       white</code></pre>&#13;
&#13;
<p>A more elegant alternative here is to pass all unwanted columns into a <a data-primary="vectors" data-secondary="R data structures with" data-type="indexterm" id="idm46274542573736"/>vector, <em>then</em> drop it:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">select</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="o">-</code><code class="nf">c</code><code class="p">(</code><code class="n">tmathssk</code><code class="p">,</code> <code class="n">treadssk</code><code class="p">,</code> <code class="n">schidkn</code><code class="p">))</code>&#13;
<code class="c1">#&gt; # A tibble: 5,748 x 5</code>&#13;
<code class="c1">#&gt;    classk            totexpk sex   freelunk race</code>&#13;
<code class="c1">#&gt;    &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;</code>&#13;
<code class="c1">#&gt;  1 small.class             7 girl  no       white</code>&#13;
<code class="c1">#&gt;  2 small.class            21 girl  no       black</code>&#13;
<code class="c1">#&gt;  3 regular.with.aide       0 boy   yes      black</code>&#13;
<code class="c1">#&gt;  4 regular                16 boy   no       white</code>&#13;
<code class="c1">#&gt;  5 small.class             5 boy   yes      white</code>&#13;
<code class="c1">#&gt;  6 regular                 8 boy   yes      white</code>&#13;
<code class="c1">#&gt;  7 regular.with.aide      17 girl  yes      black</code>&#13;
<code class="c1">#&gt;  8 regular                 3 girl  no       white</code>&#13;
<code class="c1">#&gt;  9 small.class            11 girl  no       black</code>&#13;
<code class="c1">#&gt; 10 small.class            10 girl  no       white</code></pre>&#13;
&#13;
<p>Keep in <a data-startref="ch8_term8" data-type="indexterm" id="idm46274542510856"/><a data-startref="ch8_term22" data-type="indexterm" id="idm46274542479496"/>mind that in the previous examples, we’ve <a data-primary="functions" data-secondary="in R" data-secondary-sortas="R" data-type="indexterm" id="idm46274542478696"/>just been calling functions: we didn’t actually assign the output to an object.</p>&#13;
&#13;
<p>One more bit of shorthand for <code>select()</code> is to <a data-primary=": colon" data-type="indexterm" id="idm46274542439208"/><a data-primary="colon (:), R operator" data-type="indexterm" id="idm46274542438472"/>use the <code>:</code> operator to select everything between two columns, inclusive. This time, I will assign the results of selecting everything from <em>tmathssk</em> to <em>totexpk</em> back to <code>star</code>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="n">star</code> <code class="o">&lt;-</code> <code class="nf">select</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">tmathssk</code><code class="o">:</code><code class="n">totexpk</code><code class="p">)</code>&#13;
<code class="nf">head</code><code class="p">(</code><code class="n">star</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 4</code>&#13;
<code class="c1">#&gt;   tmathssk treadssk classk            totexpk</code>&#13;
<code class="c1">#&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1      473      447 small.class             7</code>&#13;
<code class="c1">#&gt; 2      536      450 small.class            21</code>&#13;
<code class="c1">#&gt; 3      463      439 regular.with.aide       0</code>&#13;
<code class="c1">#&gt; 4      559      448 regular                16</code>&#13;
<code class="c1">#&gt; 5      489      447 small.class             5</code>&#13;
<code class="c1">#&gt; 6      454      431 regular                 8</code></pre>&#13;
&#13;
<p>You’ve likely <a data-startref="ch8_term3" data-type="indexterm" id="idm46274542425656"/><a data-primary="columns" data-secondary="creating new" data-type="indexterm" id="idm46274542425048"/><a data-primary="mutate() function, R" data-type="indexterm" id="idm46274542424104"/>created calculated columns in Excel; <code>mutate()</code> will do the same in R. Let’s create a column <em>new_column</em> of combined reading and math scores. With <code>mutate()</code>, we’ll provide the name of the new column <em>first</em>, then an equal sign, and finally the calculation to use. We can refer to other columns as part of the formula:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="n">star</code> <code class="o">&lt;-</code> <code class="nf">mutate</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">new_column</code> <code class="o">=</code> <code class="n">tmathssk</code> <code class="o">+</code> <code class="n">treadssk</code><code class="p">)</code>&#13;
<code class="nf">head</code><code class="p">(</code><code class="n">star</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 5</code>&#13;
<code class="c1">#&gt;   tmathssk treadssk classk            totexpk new_column</code>&#13;
<code class="c1">#&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt;      &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1      473      447 small.class             7        920</code>&#13;
<code class="c1">#&gt; 2      536      450 small.class            21        986</code>&#13;
<code class="c1">#&gt; 3      463      439 regular.with.aide       0        902</code>&#13;
<code class="c1">#&gt; 4      559      448 regular                16       1007</code>&#13;
<code class="c1">#&gt; 5      489      447 small.class             5        936</code>&#13;
<code class="c1">#&gt; 6      454      431 regular                 8        885</code></pre>&#13;
&#13;
<p><code>mutate()</code> makes it easy to derive relatively more complex calculated columns such as logarithmic transformations or lagged variables; check out the help documentation for more.</p>&#13;
&#13;
<p><em>new_column</em> isn’t a particularly helpful <a data-primary="rename() function, R and Python" data-type="indexterm" id="idm46274542334200"/>name for total score. Fortunately, the <code>rename()</code> function does what it sounds like it would. We’ll specify what to name the new column in <a data-startref="ch8_term4" data-type="indexterm" id="idm46274542332904"/><a data-startref="ch8_term5" data-type="indexterm" id="idm46274542332200"/>place of the old:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="n">star</code> <code class="o">&lt;-</code> <code class="nf">rename</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">ttl_score</code> <code class="o">=</code> <code class="n">new_column</code><code class="p">)</code>&#13;
<code class="nf">head</code><code class="p">(</code><code class="n">star</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 5</code>&#13;
<code class="c1">#&gt;   tmathssk treadssk classk            totexpk ttl_score</code>&#13;
<code class="c1">#&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1      473      447 small.class             7       920</code>&#13;
<code class="c1">#&gt; 2      536      450 small.class            21       986</code>&#13;
<code class="c1">#&gt; 3      463      439 regular.with.aide       0       902</code>&#13;
<code class="c1">#&gt; 4      559      448 regular                16      1007</code>&#13;
<code class="c1">#&gt; 5      489      447 small.class             5       936</code>&#13;
<code class="c1">#&gt; 6      454      431 regular                 8       885</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Row-Wise Operations" data-type="sect2"><div class="sect2" id="idm46274542306600">&#13;
<h2>Row-Wise Operations</h2>&#13;
&#13;
<p>Thus far we’ve been operating on <em>columns</em>. Now let’s focus on <em>rows</em>; specifically sorting and filtering. In <a data-primary="Excel" data-secondary="data manipulation with" data-type="indexterm" id="idm46274542318904"/><a data-primary="data manipulation" data-secondary="in Excel" data-secondary-sortas="Excel" data-type="indexterm" id="idm46274542317928"/><a data-primary="rows" data-secondary="sorting" data-type="indexterm" id="idm46274542316712"/><a data-primary="sorting data" data-type="indexterm" id="idm46274542315768"/><a data-primary="rows" data-secondary="data manipulation operations for" data-type="indexterm" id="ch8_term9"/><a data-primary="data manipulation" data-secondary="of rows" data-secondary-sortas="rows" data-type="indexterm" id="ch8_term10"/>Excel, we can sort by multiple columns with the Custom Sort menu. Say for example we wanted to sort this data frame by <em>classk</em>, then <em>treadssk</em>, both ascending. Our menu in Excel to do this would look like <a data-type="xref" href="#custom-sort-excel">Figure 8-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="custom-sort-excel">&#13;
<img alt="Custom sort menu in Excel" src="assets/aina_0801.png"/>&#13;
<h6><span class="label">Figure 8-1. </span>The Custom Sort menu in Excel</h6>&#13;
</div></figure>&#13;
&#13;
<p>We can <a data-primary="arrange() function, R" data-type="indexterm" id="idm46274542268104"/>replicate this in <code>dplyr</code> by using the <code>arrange()</code> function, including each column in the order in which we want the data frame sorted:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">arrange</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">classk</code><code class="p">,</code> <code class="n">treadssk</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 5,748 x 5</code>&#13;
<code class="c1">#&gt;    tmathssk treadssk classk  totexpk ttl_score</code>&#13;
<code class="c1">#&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt;  1      320      315 regular       3       635</code>&#13;
<code class="c1">#&gt;  2      365      346 regular       0       711</code>&#13;
<code class="c1">#&gt;  3      384      358 regular      20       742</code>&#13;
<code class="c1">#&gt;  4      384      358 regular       3       742</code>&#13;
<code class="c1">#&gt;  5      320      360 regular       6       680</code>&#13;
<code class="c1">#&gt;  6      423      376 regular      13       799</code>&#13;
<code class="c1">#&gt;  7      418      378 regular      13       796</code>&#13;
<code class="c1">#&gt;  8      392      378 regular      13       770</code>&#13;
<code class="c1">#&gt;  9      392      378 regular       3       770</code>&#13;
<code class="c1">#&gt; 10      399      380 regular       6       779</code>&#13;
<code class="c1">#&gt; # ... with 5,738 more rows</code></pre>&#13;
&#13;
<p>We can <a data-primary="desc() function, R" data-type="indexterm" id="idm46274542217048"/>pass the <code>desc()</code> function to a column if we’d like that column to be sorted descendingly.</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="c1"># Sort by classk descending, treadssk ascending</code>&#13;
<code class="nf">arrange</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="nf">desc</code><code class="p">(</code><code class="n">classk</code><code class="p">),</code> <code class="n">treadssk</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 5,748 x 5</code>&#13;
<code class="c1">#&gt;    tmathssk treadssk classk      totexpk ttl_score</code>&#13;
<code class="c1">#&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;     &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt;  1      412      370 small.class      15       782</code>&#13;
<code class="c1">#&gt;  2      434      376 small.class      11       810</code>&#13;
<code class="c1">#&gt;  3      423      378 small.class       6       801</code>&#13;
<code class="c1">#&gt;  4      405      378 small.class       8       783</code>&#13;
<code class="c1">#&gt;  5      384      380 small.class      19       764</code>&#13;
<code class="c1">#&gt;  6      405      380 small.class      15       785</code>&#13;
<code class="c1">#&gt;  7      439      382 small.class       8       821</code>&#13;
<code class="c1">#&gt;  8      384      384 small.class      10       768</code>&#13;
<code class="c1">#&gt;  9      405      384 small.class       8       789</code>&#13;
<code class="c1">#&gt; 10      423      384 small.class      21       807</code></pre>&#13;
&#13;
<p>Excel <a data-primary="Excel" data-secondary="data manipulation with" data-type="indexterm" id="idm46274542180056"/><a data-primary="data manipulation" data-secondary="in Excel" data-secondary-sortas="Excel" data-type="indexterm" id="idm46274542178776"/><a data-primary="filtering data" data-type="indexterm" id="idm46274542177560"/><a data-primary="columns" data-secondary="filtering" data-type="indexterm" id="idm46274542147672"/>tables include helpful drop-down menus to filter any column by given conditions. To <a data-primary="filter() function, R" data-type="indexterm" id="idm46274542146600"/>filter a data frame in R, we’ll use the aptly named <code>filter()</code> function. Let’s filter <code>star</code> to keep only the records where <code>classk</code> is equal to <code>small.class</code>. Remember that because we are <a data-primary="== double equal sign" data-type="indexterm" id="idm46274542144072"/><a data-primary="double equal sign (==), for equal values in R and Python" data-type="indexterm" id="idm46274542143368"/>checking for equality rather than assigning an object, we’ll have to use <code>==</code> and not <code>=</code> here:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">filter</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">classk</code> <code class="o">==</code> <code class="s">'small.class'</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 1,733 x 5</code>&#13;
<code class="c1">#&gt;    tmathssk treadssk classk      totexpk ttl_score</code>&#13;
<code class="c1">#&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;     &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt;  1      473      447 small.class       7       920</code>&#13;
<code class="c1">#&gt;  2      536      450 small.class      21       986</code>&#13;
<code class="c1">#&gt;  3      489      447 small.class       5       936</code>&#13;
<code class="c1">#&gt;  4      439      478 small.class      11       917</code>&#13;
<code class="c1">#&gt;  5      528      455 small.class      10       983</code>&#13;
<code class="c1">#&gt;  6      559      474 small.class       0      1033</code>&#13;
<code class="c1">#&gt;  7      494      424 small.class       6       918</code>&#13;
<code class="c1">#&gt;  8      478      422 small.class       8       900</code>&#13;
<code class="c1">#&gt;  9      602      456 small.class      14      1058</code>&#13;
<code class="c1">#&gt; 10      439      418 small.class       8       857</code>&#13;
<code class="c1">#&gt; # ... with 1,723 more rows</code></pre>&#13;
&#13;
<p>We can see from the tibble output that our <code>filter()</code> operation <em>only</em> affected the number of rows, <em>not</em> the columns. Now we’ll find the records where <code>treadssk</code> is at least <code>500</code>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">filter</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">treadssk</code> <code class="o">&gt;=</code> <code class="m">500</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 233 x 5</code>&#13;
<code class="c1">#&gt;    tmathssk treadssk classk            totexpk ttl_score</code>&#13;
<code class="c1">#&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt;  1      559      522 regular                 8      1081</code>&#13;
<code class="c1">#&gt;  2      536      507 regular.with.aide       3      1043</code>&#13;
<code class="c1">#&gt;  3      547      565 regular.with.aide       9      1112</code>&#13;
<code class="c1">#&gt;  4      513      503 small.class             7      1016</code>&#13;
<code class="c1">#&gt;  5      559      605 regular.with.aide       5      1164</code>&#13;
<code class="c1">#&gt;  6      559      554 regular                14      1113</code>&#13;
<code class="c1">#&gt;  7      559      503 regular                10      1062</code>&#13;
<code class="c1">#&gt;  8      602      518 regular                12      1120</code>&#13;
<code class="c1">#&gt;  9      536      580 small.class            12      1116</code>&#13;
<code class="c1">#&gt; 10      626      510 small.class            14      1136</code>&#13;
<code class="c1">#&gt; # ... with 223 more rows</code></pre>&#13;
&#13;
<p>It’s possible to <a data-primary="&amp; ampersand" data-type="indexterm" id="idm46274542065528"/><a data-primary="ampersand (&amp;), R and Python operator" data-type="indexterm" id="idm46274542064920"/>filter by multiple conditions using the <code>&amp;</code> operator for “and” along with the <code>|</code> operator for “or.” Let’s combine our two criteria from before with <code>&amp;</code>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="c1"># Get records where classk is small.class and</code>&#13;
<code class="c1"># treadssk is at least 500</code>&#13;
<code class="nf">filter</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">classk</code> <code class="o">==</code> <code class="s">'small.class'</code> <code class="o">&amp;</code> <code class="n">treadssk</code> <code class="o">&gt;=</code> <code class="m">500</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 84 x 5</code>&#13;
<code class="c1">#&gt;    tmathssk treadssk classk      totexpk ttl_score</code>&#13;
<code class="c1">#&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;     &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt;  1      513      503 small.class       7      1016</code>&#13;
<code class="c1">#&gt;  2      536      580 small.class      12      1116</code>&#13;
<code class="c1">#&gt;  3      626      510 small.class      14      1136</code>&#13;
<code class="c1">#&gt;  4      602      518 small.class       3      1120</code>&#13;
<code class="c1">#&gt;  5      626      565 small.class      14      1191</code>&#13;
<code class="c1">#&gt;  6      602      503 small.class      14      1105</code>&#13;
<code class="c1">#&gt;  7      626      538 small.class      13      1164</code>&#13;
<code class="c1">#&gt;  8      500      580 small.class       8      1080</code>&#13;
<code class="c1">#&gt;  9      489      565 small.class      19      1054</code>&#13;
<code class="c1">#&gt; 10      576      545 small.class      19      1121</code>&#13;
<code class="c1">#&gt; # ... with 74 more rows</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Aggregating and Joining Data" data-type="sect2"><div class="sect2" id="idm46274542321064">&#13;
<h2>Aggregating and Joining Data</h2>&#13;
&#13;
<p>I like to <a data-startref="ch8_term9" data-type="indexterm" id="idm46274541976632"/><a data-startref="ch8_term10" data-type="indexterm" id="idm46274541975960"/><a data-primary="aggregating data" data-type="indexterm" id="ch8_term11"/><a data-primary="PivotTables, Excel" data-secondary="for data manipulation" data-secondary-sortas="data manipulation" data-type="indexterm" id="idm46274541974344"/><a data-primary="data manipulation" data-secondary="by aggregation and joins" data-secondary-sortas="aggregation and joins" data-type="indexterm" id="ch8_term12"/><a data-primary="data manipulation" data-secondary="in Excel" data-secondary-sortas="Excel" data-type="indexterm" id="ch8_term13"/><a data-primary="Excel" data-secondary="data manipulation with" data-type="indexterm" id="ch8_term14"/>call PivotTables “the WD-40 of Excel” because they allow us to get our data “spinning” in different directions for easy analysis. For example, let’s recreate the &#13;
<span class="keep-together">PivotTable</span> in <a data-type="xref" href="#excel-pivot-table">Figure 8-2</a> showing the <a data-primary="Star dataset example" data-secondary="in R" data-secondary-sortas="R" data-type="indexterm" id="idm46274541967128"/>average math score by class size from the <em>star</em> &#13;
<span class="keep-together">dataset</span>:</p>&#13;
&#13;
<figure class="width-60"><div class="figure" id="excel-pivot-table">&#13;
<img alt="How Excel PivotTables work" src="assets/aina_0802.png"/>&#13;
<h6><span class="label">Figure 8-2. </span>How Excel PivotTables work</h6>&#13;
</div></figure>&#13;
&#13;
<p>As <a data-type="xref" href="#excel-pivot-table">Figure 8-2</a> calls out, there are two elements to this PivotTable. First, I aggregated our data by the variable <em>classk</em>. Then, I summarized it by taking an average of <em>tmathssk</em>. In R, these are discrete steps, <a data-primary="dplyr, R" data-secondary="verbs (functions) of" data-type="indexterm" id="idm46274541959816"/>using different <code>dplyr</code> functions. First, we’ll aggregate the <a data-primary="group_by() function, R" data-type="indexterm" id="idm46274541958232"/>data using <code>group_by()</code>. Our output includes a line, <code># Groups: classk [3]</code>, indicating that <code>star_grouped</code> is split into three groups with the <code>classk</code> variable:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="n">star_grouped</code> <code class="o">&lt;-</code> <code class="nf">group_by</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">classk</code><code class="p">)</code>&#13;
<code class="nf">head</code><code class="p">(</code><code class="n">star_grouped</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 5</code>&#13;
<code class="c1">#&gt; # Groups:   classk [3]</code>&#13;
<code class="c1">#&gt;   tmathssk treadssk classk            totexpk ttl_score</code>&#13;
<code class="c1">#&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1      473      447 small.class             7       920</code>&#13;
<code class="c1">#&gt; 2      536      450 small.class            21       986</code>&#13;
<code class="c1">#&gt; 3      463      439 regular.with.aide       0       902</code>&#13;
<code class="c1">#&gt; 4      559      448 regular                16      1007</code>&#13;
<code class="c1">#&gt; 5      489      447 small.class             5       936</code>&#13;
<code class="c1">#&gt; 6      454      431 regular                 8       885</code></pre>&#13;
&#13;
<p>We’ve <em>grouped</em> our data by one variable; now <a data-primary="summarize() function, R" data-type="indexterm" id="idm46274541943608"/>let’s <em>summarize</em> it by another with the <code>summarize()</code> function (<code>summarise()</code> also works). Here we’ll specify what to name the resulting column, and how to calculate it. <a data-type="xref" href="#dplyr-agg-types">Table 8-2</a> lists some <a data-primary="aggregation functions, R and Python" data-type="indexterm" id="idm46274541911608"/><a data-primary="functions" data-secondary="in R" data-secondary-sortas="R" data-type="indexterm" id="idm46274541910888"/>common aggregation functions.</p>&#13;
<table id="dplyr-agg-types">&#13;
<caption><span class="label">Table 8-2. </span>Helpful aggregation functions for <code>dplyr</code></caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Function</th>&#13;
<th>Aggregation type</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>sum()</code></p></td>&#13;
<td><p>Sum</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>n()</code></p></td>&#13;
<td><p>Count values</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>mean()</code></p></td>&#13;
<td><p>Average</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>max()</code></p></td>&#13;
<td><p>Highest value</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>min()</code></p></td>&#13;
<td><p>Lowest value</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>sd()</code></p></td>&#13;
<td><p>Standard deviation</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>We can <a data-startref="ch8_term11" data-type="indexterm" id="idm46274541895160"/>get the average math score by class size by running <code>summarize()</code> on our grouped data frame:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">summarize</code><code class="p">(</code><code class="n">star_grouped</code><code class="p">,</code> <code class="n">avg_math</code> <code class="o">=</code> <code class="nf">mean</code><code class="p">(</code><code class="n">tmathssk</code><code class="p">))</code>&#13;
<code class="c1">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</code>&#13;
<code class="c1">#&gt; # A tibble: 3 x 2</code>&#13;
<code class="c1">#&gt;   classk            avg_math</code>&#13;
<code class="c1">#&gt;   &lt;chr&gt;                &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1 regular               483.</code>&#13;
<code class="c1">#&gt; 2 regular.with.aide     483.</code>&#13;
<code class="c1">#&gt; 3 small.class           491.</code></pre>&#13;
&#13;
<p>The <code>`summarise()` ungrouping output</code> error is a warning that you’ve ungrouped the grouped tibble by aggregating it. Minus some formatting differences, we have the same results as  <a data-type="xref" href="#excel-pivot-table">Figure 8-2</a>.</p>&#13;
&#13;
<p>If PivotTables are the WD-40 of Excel, <a data-primary="VLOOKUP() function, Excel" data-type="indexterm" id="ch8_term15"/><a data-primary="joining data" data-type="indexterm" id="ch8_term16"/><a data-primary="looking up and combining data" data-type="indexterm" id="ch8_term17"/><a data-primary="combining (joining) data" data-type="indexterm" id="ch8_term18"/>then <code>VLOOKUP()</code> is the duct tape, allowing us to easily combine data from multiple sources. In our original <em>star</em> dataset, <em>schidkin</em> is a school district indicator. We dropped this column earlier in this chapter, so let’s read it in again. But what if in addition to the indicator number we actually wanted to know the <em>names</em> of these districts? Fortunately, <em>districts.csv</em> in the book repository has this information, so let’s read both in and come up with a strategy for combining them:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="n">star</code> <code class="o">&lt;-</code> <code class="nf">read_excel</code><code class="p">(</code><code class="s">'datasets/star/star.xlsx'</code><code class="p">)</code>&#13;
<code class="nf">head</code><code class="p">(</code><code class="n">star</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 8</code>&#13;
<code class="c1">#&gt;   tmathssk treadssk classk            totexpk sex   freelunk race  schidkn</code>&#13;
<code class="c1">#&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1      473      447 small.class             7 girl  no       white      63</code>&#13;
<code class="c1">#&gt; 2      536      450 small.class            21 girl  no       black      20</code>&#13;
<code class="c1">#&gt; 3      463      439 regular.with.aide       0 boy   yes      black      19</code>&#13;
<code class="c1">#&gt; 4      559      448 regular                16 boy   no       white      69</code>&#13;
<code class="c1">#&gt; 5      489      447 small.class             5 boy   yes      white      79</code>&#13;
<code class="c1">#&gt; 6      454      431 regular                 8 boy   yes      white       5</code>&#13;
&#13;
<code class="n">districts</code> <code class="o">&lt;-</code> <code class="nf">read_csv</code><code class="p">(</code><code class="s">'datasets/star/districts.csv'</code><code class="p">)</code>&#13;
&#13;
<code class="c1">#&gt; -- Column specification -----------------------------------------------------</code>&#13;
<code class="c1">#&gt; cols(</code>&#13;
<code class="c1">#&gt;   schidkn = col_double(),</code>&#13;
<code class="c1">#&gt;   school_name = col_character(),</code>&#13;
<code class="c1">#&gt;   county = col_character()</code>&#13;
<code class="c1">#&gt; )</code>&#13;
&#13;
<code class="nf">head</code><code class="p">(</code><code class="n">districts</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 3</code>&#13;
<code class="c1">#&gt;   schidkn school_name     county</code>&#13;
<code class="c1">#&gt;     &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;</code>&#13;
<code class="c1">#&gt; 1       1 Rosalia         New Liberty</code>&#13;
<code class="c1">#&gt; 2       2 Montgomeryville Topton</code>&#13;
<code class="c1">#&gt; 3       3 Davy            Wahpeton</code>&#13;
<code class="c1">#&gt; 4       4 Steelton        Palestine</code>&#13;
<code class="c1">#&gt; 5       6 Tolchester      Sattley</code>&#13;
<code class="c1">#&gt; 6       7 Cahokia         Sattley</code></pre>&#13;
&#13;
<p>It appears that what’s needed is like a <code>VLOOKUP()</code>: we want to “read in” the <em>school_name</em> (and possibly the <em>county</em>) variables from <em>districts</em> into <em>star</em>, given the shared <em>schidkn</em> variable. To do this in R, we’ll <a data-primary="joins, methodology of" data-type="indexterm" id="idm46274541745320"/><a data-primary="tables, database" data-type="indexterm" id="idm46274541744616"/>use the methodology of <em>joins</em>, which comes from relational databases, a topic that was touched on in <a data-type="xref" href="ch05.html#data-analytics-stack">Chapter 5</a>. Closest to a <code>VLOOKUP()</code> is the left outer join, which can be <a data-primary="left outer join" data-type="indexterm" id="idm46274541742104"/><a data-primary="left_join() function, R" data-type="indexterm" id="idm46274541741400"/>done in <code>dplyr</code> with the <code>left_join()</code> function. We’ll provide the “base” table first (<em>star</em>) and then the “lookup” table (<em>districts</em>). The function will look for and return a match in <em>districts</em> for every record in <em>star</em>, or return <code>NA</code> if no match is found. I will keep only some columns from <em>star</em> for less overwhelming console output:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="c1"># Left outer join star on districts</code>&#13;
<code class="nf">left_join</code><code class="p">(</code><code class="nf">select</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">schidkn</code><code class="p">,</code> <code class="n">tmathssk</code><code class="p">,</code> <code class="n">treadssk</code><code class="p">),</code> <code class="n">districts</code><code class="p">)</code>&#13;
<code class="c1">#&gt; Joining, by = "schidkn"</code>&#13;
<code class="c1">#&gt; # A tibble: 5,748 x 5</code>&#13;
<code class="c1">#&gt;    schidkn tmathssk treadssk school_name     county</code>&#13;
<code class="c1">#&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;</code>&#13;
<code class="c1">#&gt;  1      63      473      447 Ridgeville      New Liberty</code>&#13;
<code class="c1">#&gt;  2      20      536      450 South Heights   Selmont</code>&#13;
<code class="c1">#&gt;  3      19      463      439 Bunnlevel       Sattley</code>&#13;
<code class="c1">#&gt;  4      69      559      448 Hokah           Gallipolis</code>&#13;
<code class="c1">#&gt;  5      79      489      447 Lake Mathews    Sugar Mountain</code>&#13;
<code class="c1">#&gt;  6       5      454      431 NA              NA</code>&#13;
<code class="c1">#&gt;  7      16      423      395 Calimesa        Selmont</code>&#13;
<code class="c1">#&gt;  8      56      500      451 Lincoln Heights Topton</code>&#13;
<code class="c1">#&gt;  9      11      439      478 Moose Lake      Imbery</code>&#13;
<code class="c1">#&gt; 10      66      528      455 Siglerville     Summit Hill</code>&#13;
<code class="c1">#&gt; # ... with 5,738 more rows</code></pre>&#13;
&#13;
<p><code>left_join()</code> is pretty smart: it knew to join on <code>schidkn</code>, and it “looked up” not just <em>school_name</em> but also <em>county</em>. To learn more about joining data, check out the help <a data-startref="ch8_term12" data-type="indexterm" id="idm46274541712616"/><a data-startref="ch8_term13" data-type="indexterm" id="idm46274541711912"/><a data-startref="ch8_term14" data-type="indexterm" id="idm46274541711240"/>documentation.</p>&#13;
&#13;
<p>In R, missing <a data-primary="NA (missing  observations), R" data-type="indexterm" id="idm46274541710152"/>observations are represented as the special value <code>NA</code>. For example, it appears that no match was found for the name of district 5. In a <code>VLOOKUP()</code>, this would result in an <code>#N/A</code> error. An <code>NA</code> does <em>not</em> mean that an observation is equal &#13;
<span class="keep-together">to zero,</span> only that its value is missing. You may see other special values such as &#13;
<span class="keep-together"><code>NaN</code> or <code>NULL</code></span> while programming R; to learn more about them, launch the <a data-startref="ch8_term15" data-type="indexterm" id="idm46274541651144"/><a data-startref="ch8_term16" data-type="indexterm" id="idm46274541650472"/><a data-startref="ch8_term17" data-type="indexterm" id="idm46274541649800"/><a data-startref="ch8_term18" data-type="indexterm" id="idm46274541649128"/>help &#13;
<span class="keep-together">documentation</span>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="dplyr and the Power of the Pipe (%&gt;%)" data-type="sect2"><div class="sect2" id="idm46274542002840">&#13;
<h2>dplyr and the Power of the Pipe (%&gt;%)</h2>&#13;
&#13;
<p>As you’re beginning to see, <code>dplyr</code> functions are powerful and rather intuitive to anyone who’s worked with data, including in Excel. And as anyone who’s worked with data knows, it’s <a data-primary="%&gt;% pipe" data-type="indexterm" id="ch8_term19"/><a data-primary="data manipulation" data-secondary="pipe(%&gt;%) operator for" data-type="indexterm" id="ch8_term20"/><a data-primary="pipe (%&gt;%), R operator" data-type="indexterm" id="ch8_term21"/>rare to prepare the data as needed in just one step. Take, for example, a typical data analysis task that you might want to do with <em>star</em>:</p>&#13;
<blockquote>&#13;
<p>Find the average reading score by class type, sorted high to low.</p></blockquote>&#13;
&#13;
<p>Knowing what we do about working with data, we can break this into <a data-primary="group_by() function, R" data-type="indexterm" id="idm46274541640600"/><a data-primary="sorting data" data-type="indexterm" id="idm46274541639896"/>three distinct steps:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Group our data by class type.</p>&#13;
</li>&#13;
<li>&#13;
<p>Find the average reading score for each group.</p>&#13;
</li>&#13;
<li>&#13;
<p>Sort these results from high to low.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>We could carry this out in <code>dplyr</code> doing something like the following:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="n">star_grouped</code> <code class="o">&lt;-</code> <code class="nf">group_by</code><code class="p">(</code><code class="n">star</code><code class="p">,</code> <code class="n">classk</code><code class="p">)</code>&#13;
<code class="n">star_avg_reading</code> <code class="o">&lt;-</code> <code class="nf">summarize</code><code class="p">(</code><code class="n">star_grouped</code><code class="p">,</code> <code class="n">avg_reading</code> <code class="o">=</code> <code class="nf">mean</code><code class="p">(</code><code class="n">treadssk</code><code class="p">))</code>&#13;
<code class="c1">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</code>&#13;
<code class="c1">#&gt;</code>&#13;
<code class="n">star_avg_reading_sorted</code> <code class="o">&lt;-</code> <code class="nf">arrange</code><code class="p">(</code><code class="n">star_avg_reading</code><code class="p">,</code> <code class="nf">desc</code><code class="p">(</code><code class="n">avg_reading</code><code class="p">))</code>&#13;
<code class="n">star_avg_reading_sorted</code>&#13;
<code class="c1">#&gt;</code>&#13;
<code class="c1">#&gt; # A tibble: 3 x 2</code>&#13;
<code class="c1">#&gt;   classk            avg_reading</code>&#13;
<code class="c1">#&gt;   &lt;chr&gt;                   &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1 small.class              441.</code>&#13;
<code class="c1">#&gt; 2 regular.with.aide        435.</code>&#13;
<code class="c1">#&gt; 3 regular                  435.</code></pre>&#13;
&#13;
<p>This gets us to an answer, but it took quite a few steps, and it can be hard to follow along with the various functions and object names. The alternative is to link these functions together with the <code>%&gt;%</code>, or pipe, operator. This allows us to pass the output of one function directly into the input of another, so we’re able to avoid continuously renaming our inputs and outputs. The default keyboard shortcut for this operator is Ctrl+Shift+M for Windows, Cmd-Shift-M for Mac.</p>&#13;
&#13;
<p>Let’s re-create the previous steps, this time with the pipe operator. We’ll place each function on its own line, combining them with <code>%&gt;%</code>.&#13;
While it’s not necessary to place each step on its own line, it’s often preferred for legibility. When using the pipe operator, it’s also not necessary to highlight the entire code block to run it; simply place your cursor anywhere in the following selection and execute:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"> <code class="n">star</code> <code class="o">%&gt;%</code>&#13;
   <code class="nf">group_by</code><code class="p">(</code><code class="n">classk</code><code class="p">)</code> <code class="o">%&gt;%</code>&#13;
   <code class="nf">summarise</code><code class="p">(</code><code class="n">avg_reading</code> <code class="o">=</code> <code class="nf">mean</code><code class="p">(</code><code class="n">treadssk</code><code class="p">))</code> <code class="o">%&gt;%</code>&#13;
   <code class="nf">arrange</code><code class="p">(</code><code class="nf">desc</code><code class="p">(</code><code class="n">avg_reading</code><code class="p">))</code>&#13;
<code class="c1">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</code>&#13;
<code class="c1">#&gt; # A tibble: 3 x 2</code>&#13;
<code class="c1">#&gt;   classk            avg_reading</code>&#13;
<code class="c1">#&gt;   &lt;chr&gt;                   &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1 small.class              441.</code>&#13;
<code class="c1">#&gt; 2 regular.with.aide        435.</code>&#13;
<code class="c1">#&gt; 3 regular                  435.</code></pre>&#13;
&#13;
<p>It can be pretty disorienting at first to no longer be explicitly including the data source as an argument in each function. But compare the last code block to the one before and you can see how much more efficient this <a data-startref="ch8_term6" data-type="indexterm" id="idm46274541557688"/><a data-startref="ch8_term7" data-type="indexterm" id="idm46274541557192"/>approach can be. What’s more, the pipe operator can be used with non-<code>dplyr</code> functions. For example, let’s just <a data-primary="head() method" data-secondary="in R" data-secondary-sortas="R" data-type="indexterm" id="idm46274541556072"/>assign the first few rows of the resulting operation by including <code>head()</code> at the end of <a data-startref="ch8_term19" data-type="indexterm" id="idm46274541554312"/><a data-startref="ch8_term20" data-type="indexterm" id="idm46274541553576"/><a data-startref="ch8_term21" data-type="indexterm" id="idm46274541552904"/>the pipe:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="c1"># Average math and reading score</code>&#13;
<code class="c1"># for each school district</code>&#13;
<code class="n">star</code> <code class="o">%&gt;%</code>&#13;
   <code class="nf">group_by</code><code class="p">(</code><code class="n">schidkn</code><code class="p">)</code> <code class="o">%&gt;%</code>&#13;
   <code class="nf">summarise</code><code class="p">(</code><code class="n">avg_read</code> <code class="o">=</code> <code class="nf">mean</code><code class="p">(</code><code class="n">treadssk</code><code class="p">),</code> <code class="n">avg_math</code> <code class="o">=</code> <code class="nf">mean</code><code class="p">(</code><code class="n">tmathssk</code><code class="p">))</code> <code class="o">%&gt;%</code>&#13;
   <code class="nf">arrange</code><code class="p">(</code><code class="n">schidkn</code><code class="p">)</code> <code class="o">%&gt;%</code>&#13;
   <code class="nf">head</code><code class="p">()</code>&#13;
<code class="c1">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 3</code>&#13;
<code class="c1">#&gt;   schidkn avg_read avg_math</code>&#13;
<code class="c1">#&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1       1     444.     492.</code>&#13;
<code class="c1">#&gt; 2       2     407.     451.</code>&#13;
<code class="c1">#&gt; 3       3     441      491.</code>&#13;
<code class="c1">#&gt; 4       4     422.     468.</code>&#13;
<code class="c1">#&gt; 5       5     428.     460.</code>&#13;
<code class="c1">#&gt; 6       6     428.     470.</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reshaping Data with tidyr" data-type="sect2"><div class="sect2" id="idm46274541647176">&#13;
<h2>Reshaping Data with tidyr</h2>&#13;
&#13;
<p>Although it’s <a data-primary="group_by() function, R" data-type="indexterm" id="idm46274541445432"/><a data-primary="summarize() function, R" data-type="indexterm" id="idm46274541444376"/>true that <code>group_by()</code> along with <code>summarize()</code> serve as a <a data-primary="Excel" data-secondary="data manipulation with" data-type="indexterm" id="idm46274541442712"/><a data-primary="data manipulation" data-secondary="in Excel" data-secondary-sortas="Excel" data-type="indexterm" id="idm46274541441704"/><a data-primary="PivotTables, Excel" data-secondary="for data manipulation" data-secondary-sortas="data manipulation" data-type="indexterm" id="idm46274541440488"/>PivotTable equivalent in R, these functions can’t do everything that an Excel PivotTable can do. What if, instead of just aggregating the data, you <a data-primary="data manipulation" data-secondary="by reshaping" data-secondary-sortas="reshaping" data-type="indexterm" id="ch8_term23"/><a data-primary="reshaping in data manipulation" data-type="indexterm" id="ch8_term24"/>wanted to <em>reshape</em> it, or change how rows and columns are set up? For <a data-primary="Star dataset example" data-secondary="in R" data-secondary-sortas="R" data-type="indexterm" id="idm46274541435880"/>example, our <em>star</em> data frame has two separate columns for math and reading scores, <em>tmathssk</em> and <em>treadssk</em>, respectively. I would like to combine these into one column called <em>score</em>, with another called <em>test_type</em> indicating whether each observation is for math or reading. I’d also like to keep the school indicator, <em>schidkn</em>, as part of the analysis.</p>&#13;
&#13;
<p><a data-type="xref" href="#excel-reshape">Figure 8-3</a> shows what this might look like in Excel; note that I relabeled the Values fields from <em>tmathssk</em> and <em>treadssk</em> to <em>math</em> and <em>reading</em>, respectively. If you would like to inspect this PivotTable further, it is available in the <a href="https://oreil.ly/Kq93s">book repository as <em>ch-8.xlsx</em></a>. Here I am again making use of an index column; otherwise, the PivotTable would attempt to “roll up” all values by <em>schidkn</em>.</p>&#13;
&#13;
<figure class="width-70"><div class="figure" id="excel-reshape">&#13;
<img alt="Reshaping Excel" src="assets/aina_0803.png"/>&#13;
<h6><span class="label">Figure 8-3. </span>Reshaping <em>star</em> in Excel</h6>&#13;
</div></figure>&#13;
&#13;
<p>We can <a data-primary="tidyr package, R" data-type="indexterm" id="idm46274541424184"/>use <code>tidyr</code>, a core <code>tidyverse</code> package, to reshape <em>star</em>. Adding an index <a data-primary="columns" data-secondary="data manipulation operations for" data-type="indexterm" id="idm46274541422008"/><a data-primary="data manipulation" data-secondary="of columns" data-secondary-sortas="columns" data-type="indexterm" id="idm46274541421032"/>column will also be helpful when reshaping in R, as it was in Excel. We can make one <a data-primary="row_number() function, R" data-type="indexterm" id="idm46274541419688"/>with the <code>row_number()</code> function:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="n">star_pivot</code> <code class="o">&lt;-</code> <code class="n">star</code> <code class="o">%&gt;%</code>&#13;
                <code class="nf">select</code><code class="p">(</code><code class="nf">c</code><code class="p">(</code><code class="n">schidkn</code><code class="p">,</code> <code class="n">treadssk</code><code class="p">,</code> <code class="n">tmathssk</code><code class="p">))</code> <code class="o">%&gt;%</code>&#13;
                <code class="nf">mutate</code><code class="p">(</code><code class="n">id</code> <code class="o">=</code> <code class="nf">row_number</code><code class="p">())</code></pre>&#13;
&#13;
<p>To reshape the <a data-primary="pivot_longer() function, R" data-type="indexterm" id="idm46274541403176"/><a data-primary="pivot_wider() function, R" data-type="indexterm" id="idm46274541402376"/>data frame, we’ll use <code>pivot_longer()</code> and <code>pivot_wider()</code>, both from <code>tidyr</code>. Consider in your mind’s eye and in <a data-type="xref" href="#excel-reshape">Figure 8-3</a> what would happen to our dataset if we consolidated scores from <em>tmathssk</em> and <em>treadssk</em> into one column. Would the dataset get longer or wider? We’re adding rows here, so our dataset will get longer. To use <code>pivot_longer()</code>, we’ll specify with the <code>cols</code> argument what columns to lengthen by, and use <code>values_to</code> to name the resulting column. We’ll also <a data-primary="naming/renaming in data reshaping" data-type="indexterm" id="idm46274541366344"/>use <code>names_to</code> to name the column indicating whether each score is math or reading:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="n">star_long</code> <code class="o">&lt;-</code> <code class="n">star_pivot</code> <code class="o">%&gt;%</code>&#13;
                 <code class="nf">pivot_longer</code><code class="p">(</code><code class="n">cols</code> <code class="o">=</code> <code class="nf">c</code><code class="p">(</code><code class="n">tmathssk</code><code class="p">,</code> <code class="n">treadssk</code><code class="p">),</code>&#13;
                              <code class="n">values_to</code> <code class="o">=</code> <code class="s">'score'</code><code class="p">,</code> <code class="n">names_to</code> <code class="o">=</code> <code class="s">'test_type'</code><code class="p">)</code>&#13;
<code class="nf">head</code><code class="p">(</code><code class="n">star_long</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 4</code>&#13;
<code class="c1">#&gt;   schidkn    id test_type score</code>&#13;
<code class="c1">#&gt;     &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1      63     1 tmathssk    473</code>&#13;
<code class="c1">#&gt; 2      63     1 treadssk    447</code>&#13;
<code class="c1">#&gt; 3      20     2 tmathssk    536</code>&#13;
<code class="c1">#&gt; 4      20     2 treadssk    450</code>&#13;
<code class="c1">#&gt; 5      19     3 tmathssk    463</code>&#13;
<code class="c1">#&gt; 6      19     3 treadssk    439</code></pre>&#13;
&#13;
<p>Great work. But is there a way to rename <em>tmathssk</em> and <em>treadssk</em> to <em>math</em> and <em>reading</em>, respectively? There is, <a data-primary="recode() function, R" data-type="indexterm" id="idm46274541284232"/>with <code>recode()</code>, yet another <a data-primary="data manipulation" data-secondary="dplyr for" data-type="indexterm" id="idm46274541282984"/><a data-primary="dplyr, R" data-secondary="data manipulation with" data-type="indexterm" id="idm46274541281976"/>helpful <code>dplyr</code> function that can be <a data-primary="mutate() function, R" data-type="indexterm" id="idm46274541280488"/>used with <code>mutate()</code>. <code>recode()</code> works a little differently than other functions in the package because we include the name of the “old” values <em>before</em> the equals sign, then the new. The <code>distinct()</code> function from <code>dplyr</code> will confirm that all rows have been named either <em>math</em> or <em>reading</em>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="c1"># Rename tmathssk and treadssk as math and reading</code>&#13;
<code class="n">star_long</code> <code class="o">&lt;-</code> <code class="n">star_long</code> <code class="o">%&gt;%</code>&#13;
   <code class="nf">mutate</code><code class="p">(</code><code class="n">test_type</code> <code class="o">=</code> <code class="nf">recode</code><code class="p">(</code><code class="n">test_type</code><code class="p">,</code>&#13;
                            <code class="s">'tmathssk'</code> <code class="o">=</code> <code class="s">'math'</code><code class="p">,</code> <code class="s">'treadssk'</code> <code class="o">=</code> <code class="s">'reading'</code><code class="p">))</code>&#13;
&#13;
<code class="nf">distinct</code><code class="p">(</code><code class="n">star_long</code><code class="p">,</code> <code class="n">test_type</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 2 x 1</code>&#13;
<code class="c1">#&gt;   test_type</code>&#13;
<code class="c1">#&gt;   &lt;chr&gt;</code>&#13;
<code class="c1">#&gt; 1 math</code>&#13;
<code class="c1">#&gt; 2 reading</code></pre>&#13;
&#13;
<p>Now that our data frame is lengthened, we can widen it back with <code>pivot_wider()</code>. This time, I’ll specify which column has values in its rows that should be columns with <code>values_from</code>, and what the resulting columns should be named with <code>names_from</code>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="n">star_wide</code> <code class="o">&lt;-</code> <code class="n">star_long</code> <code class="o">%&gt;%</code>&#13;
                <code class="nf">pivot_wider</code><code class="p">(</code><code class="n">values_from</code> <code class="o">=</code> <code class="s">'score'</code><code class="p">,</code> <code class="n">names_from</code> <code class="o">=</code> <code class="s">'test_type'</code><code class="p">)</code>&#13;
<code class="nf">head</code><code class="p">(</code><code class="n">star_wide</code><code class="p">)</code>&#13;
<code class="c1">#&gt; # A tibble: 6 x 4</code>&#13;
<code class="c1">#&gt;   schidkn    id  math reading</code>&#13;
<code class="c1">#&gt;     &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;</code>&#13;
<code class="c1">#&gt; 1      63     1   473     447</code>&#13;
<code class="c1">#&gt; 2      20     2   536     450</code>&#13;
<code class="c1">#&gt; 3      19     3   463     439</code>&#13;
<code class="c1">#&gt; 4      69     4   559     448</code>&#13;
<code class="c1">#&gt; 5      79     5   489     447</code>&#13;
<code class="c1">#&gt; 6       5     6   454     431</code></pre>&#13;
&#13;
<p>Reshaping data is a relatively trickier operation in R, so when in doubt, ask yourself: <em>am I making this data wider or longer? How would I do it in a PivotTable?</em> If you can logically walk through what needs to happen to achieve the desired end state, coding it will be that <a data-startref="ch8_term1" data-type="indexterm" id="idm46274541150184"/><a data-startref="ch8_term2" data-type="indexterm" id="idm46274541149576"/><a data-startref="ch8_term23" data-type="indexterm" id="idm46274541148968"/><a data-startref="ch8_term24" data-type="indexterm" id="idm46274541148328"/>much easier.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Data Visualization with ggplot2" data-type="sect1"><div class="sect1" id="idm46274541446024">&#13;
<h1>Data Visualization with ggplot2</h1>&#13;
&#13;
<p>There’s so much more that <code>dplyr</code> can do to help us manipulate data, but for now let’s turn our attention to data visualization. Specifically, we’ll <a data-primary="ggplot2, R" data-type="indexterm" id="ch8_term25"/><a data-primary="R programming language" data-secondary="visualization of data in" data-type="indexterm" id="ch8_term26"/><a data-primary="tidyverse packages, R" data-secondary="ggplot2" data-type="indexterm" id="ch8_term27"/><a data-primary="visualization of data" data-secondary="with ggplot2" data-secondary-sortas="ggplot2" data-type="indexterm" id="ch8_term28"/><a data-primary="visualization of data" data-secondary="with R" data-secondary-sortas="R" data-type="indexterm" id="ch8_term29"/>focus on another <code>tidyverse</code> package, <code>ggplot2</code>. Named and <a data-primary="Wilkinson, Leland" data-type="indexterm" id="idm46274541137368"/>modeled after the “grammar of graphics” devised by computer scientist Leland Wilkinson, <code>ggplot2</code> provides an ordered approach for constructing plots. This structure is patterned after how elements of speech come together to make a sentence, hence the “grammar” of graphics.</p>&#13;
&#13;
<p>I’ll cover some of the basic elements and plot types of <code>ggplot2</code> here. For more about the package, check out <em>ggplot2: Elegant Graphics for Data Analysis</em> by the <a data-primary="Wickham, Hadley" data-type="indexterm" id="idm46274541134408"/><a data-primary="R programming language" data-secondary="further reading on" data-type="indexterm" id="idm46274541133704"/>package’s original author, Hadley Wickham (Springer). You can also access a <a data-primary="RStudio, R" data-secondary="cheatsheets in" data-type="indexterm" id="idm46274541132632"/>helpful cheat sheet for working with the package by navigating in RStudio to Help → Cheatsheets → Data Visualization with ggplot2. Some <a data-primary="data element of ggplot2, R" data-type="indexterm" id="idm46274541131400"/><a data-primary="aes element of ggplot2, R" data-type="indexterm" id="idm46274541130760"/><a data-primary="geom element of ggplot2, R" data-type="indexterm" id="idm46274541130120"/>essential elements of <code>ggplot2</code> are found in <a data-type="xref" href="#elements-of-ggplot2">Table 8-3</a>. Other elements are available; for more information, check out the resources mentioned earlier.</p>&#13;
<table id="elements-of-ggplot2" style="width: 100%">&#13;
<caption><span class="label">Table 8-3. </span>The foundational elements of <code>ggplot2</code></caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Element</th>&#13;
<th>Description</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>data</code></p></td>&#13;
<td><p>The source data</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>aes</code></p></td>&#13;
<td><p>The aesthetic mappings from data to visual properties (x- and y-axes, color, size, and so forth)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>geom</code></p></td>&#13;
<td><p>The type of geometric object observed in the plot (lines, bars, dots, and so forth)</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>Let’s get started by visualizing the number of observations for each level of <em>classk</em> as a barplot. We’ll <a data-primary="ggplot() function, R" data-type="indexterm" id="idm46274541117800"/>start with the <code>ggplot()</code> function and specify the three elements from <a data-type="xref" href="#elements-of-ggplot2">Table 8-3</a>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">ggplot</code><code class="p">(</code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">star</code><code class="p">,</code><code> </code><a class="co" href="#callout_data_manipulation_and_visualization_in_r_CO1-1" id="co_data_manipulation_and_visualization_in_r_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
          </code><code class="nf">aes</code><code class="p">(</code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">classk</code><code class="p">)</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><a class="co" href="#callout_data_manipulation_and_visualization_in_r_CO1-2" id="co_data_manipulation_and_visualization_in_r_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
   </code><code class="nf">geom_bar</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_data_manipulation_and_visualization_in_r_CO1-3" id="co_data_manipulation_and_visualization_in_r_CO1-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_data_manipulation_and_visualization_in_r_CO1-1" id="callout_data_manipulation_and_visualization_in_r_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The data source is specified with the <code>data</code> argument.</p></dd>&#13;
<dt><a class="co" href="#co_data_manipulation_and_visualization_in_r_CO1-2" id="callout_data_manipulation_and_visualization_in_r_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The <a data-primary="aes() function, R" data-type="indexterm" id="idm46274541058152"/>aesthetic mappings from the data to the visualization are specified with the <code>aes()</code> function. Here we are calling for <em>classk</em> to be mapped to the x-axis of the eventual plot.</p></dd>&#13;
<dt><a class="co" href="#co_data_manipulation_and_visualization_in_r_CO1-3" id="callout_data_manipulation_and_visualization_in_r_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>We <a data-primary="geom_bar() function, R" data-type="indexterm" id="idm46274541025816"/>plot a geometric object based on our specified data and aesthetic mappings with the <code>geom_bar()</code> function. The results are shown in <a data-type="xref" href="#barplot-ggplot2">Figure 8-4</a>.</p></dd>&#13;
</dl>&#13;
&#13;
<figure class="width-80"><div class="figure" id="barplot-ggplot2">&#13;
<img alt="Countplot" src="assets/aina_0804.png"/>&#13;
<h6><span class="label">Figure 8-4. </span>A barplot in <code>ggplot2</code></h6>&#13;
</div></figure>&#13;
&#13;
<p>Similar to the pipe operator, it’s not necessary to place each layer of the plot on its own line, but it’s often preferred for legibility. It’s also possible to execute the entire plot by placing the cursor anywhere inside the code block and running.</p>&#13;
&#13;
<p>Because of its modular approach, it’s easy to iterate on visualizations with <code>ggplot2</code>. For example, we can <a data-primary="geom_histogram() function, R" data-type="indexterm" id="idm46274541019464"/><a data-primary="histograms" data-secondary="with R" data-secondary-sortas="R" data-type="indexterm" id="idm46274541018760"/>switch our plot to a histogram of <em>treadssk</em> by changing our <code>x</code> mapping and plotting the results with <code>geom_histogram()</code>. This results in the histogram shown in <a data-type="xref" href="#histogram-ggplot2">Figure 8-5</a>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">ggplot</code><code class="p">(</code><code class="n">data</code> <code class="o">=</code> <code class="n">star</code><code class="p">,</code> <code class="nf">aes</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">treadssk</code><code class="p">))</code> <code class="o">+</code>&#13;
  <code class="nf">geom_histogram</code><code class="p">()</code>&#13;
&#13;
<code class="c1">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>&#13;
&#13;
<figure><div class="figure" id="histogram-ggplot2">&#13;
<img alt="Histogram" src="assets/aina_0805.png"/>&#13;
<h6><span class="label">Figure 8-5. </span>A histogram in <code>ggplot2</code></h6>&#13;
</div></figure>&#13;
&#13;
<p>There are also many ways to customize <code>ggplot2</code> plots. You may have noticed, for example, that the output message for the previous plot indicated that 30 bins were used in the histogram. Let’s change that number to 25 and use a pink fill with a couple of additional arguments in <code>geom_histogram()</code>. This results in the histogram shown in <a data-type="xref" href="#custom-histogram-ggplot2">Figure 8-6</a>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">ggplot</code><code class="p">(</code><code class="n">data</code> <code class="o">=</code> <code class="n">star</code><code class="p">,</code> <code class="nf">aes</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">treadssk</code><code class="p">))</code> <code class="o">+</code>&#13;
  <code class="nf">geom_histogram</code><code class="p">(</code><code class="n">bins</code> <code class="o">=</code> <code class="m">25</code><code class="p">,</code> <code class="n">fill</code> <code class="o">=</code> <code class="s">'pink'</code><code class="p">)</code></pre>&#13;
&#13;
<figure><div class="figure" id="custom-histogram-ggplot2">&#13;
<img alt="Custom Histogram" src="assets/aina_0806.png"/>&#13;
<h6><span class="label">Figure 8-6. </span>A customized histogram in <code>ggplot2</code></h6>&#13;
</div></figure>&#13;
&#13;
<p>Use <code>geom_boxplot()</code> to <a data-primary="boxplots" data-secondary="with R" data-secondary-sortas="R" data-type="indexterm" id="ch8_term30"/><a data-primary="geom_boxplot() function, R" data-type="indexterm" id="ch8_term31"/>create a boxplot, as shown in <a data-type="xref" href="#boxplot-ggplot2">Figure 8-7</a>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">ggplot</code><code class="p">(</code><code class="n">data</code> <code class="o">=</code> <code class="n">star</code><code class="p">,</code> <code class="nf">aes</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">treadssk</code><code class="p">))</code> <code class="o">+</code>&#13;
  <code class="nf">geom_boxplot</code><code class="p">()</code></pre>&#13;
&#13;
<figure class="width-70"><div class="figure" id="boxplot-ggplot2">&#13;
<img alt="Boxplot" src="assets/aina_0807.png"/>&#13;
<h6><span class="label">Figure 8-7. </span>A boxplot</h6>&#13;
</div></figure>&#13;
&#13;
<p>In any of the cases thus far, we could have “flipped” the plot by including the <a data-primary="x-axis, mapping" data-type="indexterm" id="ch8_term32"/><a data-primary="y-axis, mapping" data-type="indexterm" id="ch8_term33"/>variable of interest in the <code>y</code> mapping instead of the <code>x</code>. Let’s try it with our boxplot. <a data-type="xref" href="#reverse-boxplot-ggplot2">Figure 8-8</a> shows the result of the following:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">ggplot</code><code class="p">(</code><code class="n">data</code> <code class="o">=</code> <code class="n">star</code><code class="p">,</code> <code class="nf">aes</code><code class="p">(</code><code class="n">y</code> <code class="o">=</code> <code class="n">treadssk</code><code class="p">))</code> <code class="o">+</code>&#13;
  <code class="nf">geom_boxplot</code><code class="p">()</code></pre>&#13;
&#13;
<figure><div class="figure" id="reverse-boxplot-ggplot2">&#13;
<img alt="Flipped boxplot" src="assets/aina_0808.png"/>&#13;
<h6><span class="label">Figure 8-8. </span>A “flipped” boxplot</h6>&#13;
</div></figure>&#13;
&#13;
<p>Now let’s make a boxplot for each level of class size by mapping <em>classk</em> to the x-axis and <em>treadssk</em> to the y, resulting in the boxplot shown in <a data-type="xref" href="#grouped-boxplot-ggplot2">Figure 8-9</a>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">ggplot</code><code class="p">(</code><code class="n">data</code> <code class="o">=</code> <code class="n">star</code><code class="p">,</code> <code class="nf">aes</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">classk</code><code class="p">,</code> <code class="n">y</code> <code class="o">=</code> <code class="n">treadssk</code><code class="p">))</code> <code class="o">+</code>&#13;
  <code class="nf">geom_boxplot</code><code class="p">()</code></pre>&#13;
&#13;
<p>Similarly, we can <a data-startref="ch8_term30" data-type="indexterm" id="idm46274540806408"/><a data-startref="ch8_term31" data-type="indexterm" id="idm46274540805800"/><a data-primary="geom_point() function, R" data-type="indexterm" id="idm46274540805160"/>use <code>geom_point()</code> to plot the relationship of <em>tmathssk</em> and <em>treadssk</em> on the x- and y-axes, respectively, as a scatterplot. This results in <a data-type="xref" href="#scatterplot-ggplot2">Figure 8-10</a>:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">ggplot</code><code class="p">(</code><code class="n">data</code> <code class="o">=</code> <code class="n">star</code><code class="p">,</code> <code class="nf">aes</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">tmathssk</code><code class="p">,</code> <code class="n">y</code> <code class="o">=</code> <code class="n">treadssk</code><code class="p">))</code> <code class="o">+</code>&#13;
  <code class="nf">geom_point</code><code class="p">()</code></pre>&#13;
&#13;
<figure><div class="figure" id="grouped-boxplot-ggplot2">&#13;
<img alt="Grouped boxplot" src="assets/aina_0809.png"/>&#13;
<h6><span class="label">Figure 8-9. </span>A boxplot by group</h6>&#13;
</div></figure>&#13;
&#13;
<figure><div class="figure" id="scatterplot-ggplot2">&#13;
<img alt="Scatterplot" src="assets/aina_0810.png"/>&#13;
<h6><span class="label">Figure 8-10. </span>A scatterplot</h6>&#13;
</div></figure>&#13;
&#13;
<p>We can <a data-primary="scatterplots" data-secondary="with R" data-secondary-sortas="R" data-type="indexterm" id="idm46274540785368"/>use some additional <code>ggplot2</code> functions to layer labels onto the x- and y-axes, along with a plot title. <a data-type="xref" href="#labeled-plot-ggplot2">Figure 8-11</a> shows the result:</p>&#13;
&#13;
<pre data-code-language="r" data-type="programlisting"><code class="nf">ggplot</code><code class="p">(</code><code class="n">data</code> <code class="o">=</code> <code class="n">star</code><code class="p">,</code> <code class="nf">aes</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">tmathssk</code><code class="p">,</code> <code class="n">y</code> <code class="o">=</code> <code class="n">treadssk</code><code class="p">))</code> <code class="o">+</code>&#13;
  <code class="nf">geom_point</code><code class="p">()</code> <code class="o">+</code>&#13;
  <code class="nf">xlab</code><code class="p">(</code><code class="s">'Math score'</code><code class="p">)</code> <code class="o">+</code> <code class="nf">ylab</code><code class="p">(</code><code class="s">'Reading score'</code><code class="p">)</code> <code class="o">+</code>&#13;
  <code class="nf">ggtitle</code><code class="p">(</code><code class="s">'Math score versus reading score'</code><code class="p">)</code></pre>&#13;
&#13;
<figure><div class="figure" id="labeled-plot-ggplot2">&#13;
<img alt="Scatterplot with custom labels and title" src="assets/aina_0811.png"/>&#13;
<h6><span class="label">Figure 8-11. </span>A scatterplot with custom axis labels and title</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conclusion" data-type="sect1"><div class="sect1" id="idm46274541146616">&#13;
<h1>Conclusion</h1>&#13;
&#13;
<p>There’s so much more that <code>dplyr</code> and <code>ggplot2</code> can do, but this is enough to get you started with the true task at hand: to explore and test relationships in <a data-startref="ch8_term25" data-type="indexterm" id="idm46274540681496"/><a data-startref="ch8_term26" data-type="indexterm" id="idm46274540680792"/><a data-startref="ch8_term27" data-type="indexterm" id="idm46274540680120"/><a data-startref="ch8_term28" data-type="indexterm" id="idm46274540679448"/><a data-startref="ch8_term29" data-type="indexterm" id="idm46274540678776"/><a data-startref="ch8_term32" data-type="indexterm" id="idm46274540678104"/><a data-startref="ch8_term33" data-type="indexterm" id="idm46274540677432"/>data. That will be the focus of <a data-type="xref" href="ch09.html#r-capstone">Chapter 9</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Exercises" data-type="sect1"><div class="sect1" id="idm46274540675704">&#13;
<h1>Exercises</h1>&#13;
&#13;
<p>The <a href="https://oreil.ly/kBk3e">book repository</a> has two files in the <em>census</em> subfolder of <em>datasets</em>, <em>census.csv</em> and <em>census-divisions.csv</em>. Read <a data-primary="R programming language" data-secondary="exercises" data-type="indexterm" id="idm46274540671400"/><a data-primary="R programming language" data-secondary="data manipulation" data-type="indexterm" id="idm46274540670392"/>these into R and do the following:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Sort the data by region ascending, division ascending, and population descending. (You will need to combine datasets to do this.) Write the results to an Excel worksheet.</p>&#13;
</li>&#13;
<li>&#13;
<p>Drop the postal code field from your merged dataset.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create a new column <em>density</em> that is a calculation of population divided by land area.</p>&#13;
</li>&#13;
<li>&#13;
<p>Visualize the relationship between land area and  population for all observations in 2015.</p>&#13;
</li>&#13;
<li>&#13;
<p>Find the total population for each region in 2015.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create a table containing state names and populations, with the population for each year 2010–2015 kept in an individual column.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>