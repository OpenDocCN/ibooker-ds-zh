<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 12. Delivering the Data" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_delivery_intro">
<h1><span class="label">Chapter 12. </span>Delivering the Data</h1>
<p><a data-type="xref" href="ch06.xhtml#chapter_heavy_scraping">Chapter 6</a> showed how to grab your data of interest from the web with a web scraper. <a data-primary="delivering data" data-type="indexterm" id="ix_delda"/>We used Scrapy to fetch a dataset of Nobel Prize winners and then in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.xhtml#chapter_cleaning">9</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch11.xhtml#chapter_pandas_exploring">11</a> we cleaned and explored the Nobel Prize dataset using pandas.</p>
<p>This chapter will show you how to deliver data statically or dynamically from a Python server to JavaScript on the client browser, using our Nobel Prize dataset as an example. This data is stored in the JSON format and consists of a list of Nobel Prize–winner objects like the one shown in <a data-type="xref" href="#delivery_JSON">Example 12-1</a>.</p>
<div data-type="example" id="delivery_JSON">
<h5><span class="label">Example 12-1. </span>Our Nobel Prize JSON data, scraped and then cleaned</h5>
<pre data-code-language="json" data-type="programlisting"><code class="p">[</code><code class="w"/>
<code class="w">  </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"category"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Physiology or Medicine"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"country"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Argentina"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"date_of_birth"</code><code class="p">:</code><code class="w"> </code><code class="s2">"1927-10-08T00:00:00.000Z"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"date_of_death"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2002-03-24T00:00:00.000Z"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"gender"</code><code class="p">:</code><code class="w"> </code><code class="s2">"male"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"link"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http:\/\/en.wikipedia.org\/wiki\/C%C3%A9sar_Milstein"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"C\u00e9sar Milstein"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"place_of_birth"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Bah\u00eda Blanca ,  Argentina"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"place_of_death"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Cambridge , England"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"text"</code><code class="p">:</code><code class="w"> </code><code class="s2">"C\u00e9sar Milstein , Physiology or Medicine, 1984"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"year"</code><code class="p">:</code><code class="w"> </code><code class="mi">1984</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"award_age"</code><code class="p">:</code><code class="w"> </code><code class="mi">57</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"born_in"</code><code class="p">:</code><code class="w"> </code><code class="s2">""</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"bio_image"</code><code class="p">:</code><code class="w"> </code><code class="s2">"full/6bf65058d573e07b72231407842018afc98fd3ea.jpg"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"mini_bio"</code><code class="p">:</code><code class="w"> </code><code class="s2">"&lt;p&gt;&lt;b&gt;César Milstein&lt;/b&gt;, &lt;a href='http://en.w..."</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="w">  </code><code class="p">[</code><code class="err">'...'</code><code class="p">]</code><code class="w"/>
<code class="p">]</code><code class="w"/></pre></div>
<p>As with the rest of this book, the emphasis will be on minimizing the amount of web development so you can get down to the business of building the web visualization in JavaScript.</p>
<div data-type="tip"><h6>Tip</h6>
<p>A good rule of thumb is to aim to do as much data manipulation as possible with Python—it’s much less painful than equivalent operations in JavaScript.<a data-primary="Python" data-secondary="data manipulation with" data-type="indexterm" id="idm45607760933248"/> Following from this, the data delivered should be as close as possible to the form it will be consumed in (i.e., for D3 this will usually be a JSON array of objects, such as the one we produced in <a data-type="xref" href="ch09.xhtml#chapter_cleaning">Chapter 9</a>).</p>
</div>
<section data-pdf-bookmark="Serving the Data" data-type="sect1"><div class="sect1" id="idm45607760994032">
<h1>Serving the Data</h1>
<p>You’ll need a web server to process <a data-primary="delivering data" data-secondary="serving the data" data-type="indexterm" id="ix_deldasrv"/>HTTP requests from the browser, for the initial static HTML and CSS files used to build the web page, and for any subsequent AJAX requests for data. During development, this server will typically be running on a port of localhost (on most systems this has an IP address of 127.0.0.1). Conventionally, an <em>index.xhtml</em> HTML file is used to initialize the website or, in our case, the <a href="https://oreil.ly/23h3Y">single-page application (SPA)</a> constituting our web visualization.<a data-primary="single-page applications (SPAs)" data-type="indexterm" id="idm45607760989904"/></p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45607760989040">
<h5>The Single-Line Servers</h5>
<p>While developing or running demos that depend on static content, it is often handy to have a little web server that just delivers the HTML, CSS, JavaScript, and JSON files to a browser running locally, usually on port 8000 or 8080.<a data-primary="single-line servers" data-type="indexterm" id="idm45607760987504"/> Python has a built-in solution with the <code>http.server</code> module, which can be fired up from the root <a data-primary="http.server module (Python)" data-type="indexterm" id="idm45607760986288"/>directory of your project with:</p>
<pre data-type="programlisting">$ python -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</pre>
<p>Node provides an alternative dev server with <code>http-server</code>, installed using <code>npm install -g http-server</code> and run from your project root like so:</p>
<pre data-type="programlisting">viz $ http-server
Starting up http-server, serving ./
...
Available on:
  http://127.0.0.1:8080
  ...
Hit CTRL-C to stop the server</pre>
</div></aside>
<p>Serving your SPA with a single-line server can be fine for visualization prototyping and sketching out ideas but gives you no control over even basic server functionality, such as URL routing or the use of dynamic templates. Thankfully, Python has a great little web server that provides all the functionality a web visualizer could need without sacrificing our aim to minimize the boilerplate standing between our Python-processed data and JavaScripted visualization masterwork. <a data-primary="Flask" data-type="indexterm" id="ix_Flask"/> Flask is the mini web server in question and a worthy addition to our best-of-breed toolchain.</p>
<section data-pdf-bookmark="Organizing Your Flask Files" data-type="sect2"><div class="sect2" id="idm45607760980928">
<h2>Organizing Your Flask Files</h2>
<p>How to organize your project files <a data-primary="Flask" data-secondary="organizing Flask files" data-type="indexterm" id="idm45607760979376"/><a data-primary="delivering data" data-secondary="serving the data" data-tertiary="organizing Flask files" data-type="indexterm" id="idm45607760978400"/>is one of those really useful bits of information that is often neglected in tutorials and the like, possibly because things can get opinionated fast and at the end of the day, it’s a personal preference. Nevertheless, good file organization can really pay off, especially when you start collaborating.</p>
<p><a data-type="xref" href="#file_structure">Figure 12-1</a> gives a rough idea of where your files should go as you move from the basic dataviz JavaScript prototype using a one-line server labeled <code>basic</code>, through a more complex project labeled <span class="keep-together"><code>basic+</code></span>,  to a typical, simple Flask setup labeled <code>flask_project</code>.</p>
<figure><div class="figure" id="file_structure">
<img alt="dpj2 1201" height="584" src="assets/dpj2_1201.png" width="1340"/>
<h6><span class="label">Figure 12-1. </span>Organizing your server project files</h6>
</div></figure>
<p>The key thing with file organization is consistency. It helps enormously to have the position of files in your procedural memory.</p>
</div></section>
<section data-pdf-bookmark="Serving Data with Flask" data-type="sect2"><div class="sect2" id="sect_serving_data_with_flask">
<h2>Serving Data with Flask</h2>
<p>If you’re using Python’s Anaconda packages (see <a data-type="xref" href="ch01.xhtml#chapter_install">Chapter 1</a>), then Flask is already available to you.<a data-primary="Flask" data-secondary="serving data with" data-type="indexterm" id="ix_Flasksrv"/> Otherwise, a simple <code>pip</code> install should make it available:</p>
<pre data-code-language="bash" data-type="programlisting">$ pip install Flask</pre>
<p>With the Flask modules in hand, we can set up a server with a few lines to serve the universal programming greeting:</p>
<pre class="pagebreak-before" data-code-language="python" data-type="programlisting"><code class="c1"># server.py</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">flask</code><code> </code><code class="kn">import</code><code> </code><code class="n">Flask</code><code>
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">Flask</code><code class="p">(</code><code class="vm">__name__</code><code class="p">)</code><code>
</code><code>
</code><code class="nd">@app</code><code class="o">.</code><code class="n">route</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="s2">"</code><code class="p">)</code><code> </code><a class="co" href="#callout_delivering_the_data_CO1-1" id="co_delivering_the_data_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="k">def</code><code> </code><code class="nf">hello</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="s2">"</code><code class="s2">Hello World!</code><code class="s2">"</code><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="vm">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s2">"</code><code class="s2">__main__</code><code class="s2">"</code><code class="p">:</code><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">port</code><code class="o">=</code><code class="mi">8000</code><code class="p">,</code><code> </code><code class="n">debug</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code> </code><a class="co" href="#callout_delivering_the_data_CO1-2" id="co_delivering_the_data_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_delivering_the_data_CO1-1" id="callout_delivering_the_data_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Flask routes allow you to direct your web traffic. This is the root route (i.e., <em>http://localhost:8000</em>).</p></dd>
<dt><a class="co" href="#co_delivering_the_data_CO1-2" id="callout_delivering_the_data_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Sets the localhost port the server will run on (default 5000). In debug mode, Flask will provide useful logging to screen and in the event of an error, a browser-based report.</p></dd>
</dl>
<p>Now, just go to the directory containing <em>nobel_viz.py</em> and run the module:</p>
<pre data-code-language="bash" data-type="programlisting">$ python server.py
 * Serving Flask app <code class="s1">'server'</code> <code class="o">(</code>lazy loading<code class="o">)</code>
 * Environment: production
   WARNING: This is a development server. Do not use it <code class="k">in</code> a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://127.0.0.1:8000/ <code class="o">(</code>Press CTRL+C to quit<code class="o">)</code></pre>
<p>You can now go to your web browser of choice and see the emphatic result shown in <a data-type="xref" href="#delivery_hello_world">Figure 12-2</a>.</p>
<figure><div class="figure" id="delivery_hello_world">
<img alt="dpj2 1202" height="70" src="assets/dpj2_1202.png" width="388"/>
<h6><span class="label">Figure 12-2. </span>A simple message served to the browser</h6>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="side_jinja2">
<h5>Templating with Jinja2</h5>
<p>By default, Flask uses the powerful and fairly intuitive <a href="https://oreil.ly/lSA7g">Jinja2 templating library</a>, which can use Python variables to configure an HTML page. <a data-primary="HTML" data-secondary="templating with Jinja2 in Flask" data-type="indexterm" id="idm45607760737104"/><a data-primary="templating with Jinja2" data-type="indexterm" id="idm45607760736192"/><a data-primary="Flask" data-secondary="templating with Jinja2" data-type="indexterm" id="idm45607760735520"/><a data-primary="Jinja2 templating language" data-type="indexterm" id="idm45607760734576"/>The following code shows a little template that loops through an array of winners to create an unordered list:</p>
<pre data-code-language="html" data-type="programlisting"><code class="cm">&lt;!-- testj2.xhtml --&gt;</code>
<code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">h2</code><code class="p">&gt;</code>\{{ heading \}}<code class="p">&lt;/</code><code class="nt">h2</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">ul</code><code class="p">&gt;</code>
    {% for winner in winners %}
    <code class="p">&lt;</code><code class="nt">li</code><code class="p">&gt;&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code><code class="s">"{{ 'http://wikipedia.com/wiki/'</code>
<code class="s">        + winner.name }}"</code><code class="p">&gt;</code>
      {{ winner.name }}<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>
      {{ ', category: ' + winner.category }}
    <code class="p">&lt;/</code><code class="nt">li</code><code class="p">&gt;</code>
    {% endfor %}
  <code class="p">&lt;/</code><code class="nt">ul</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code></pre>
<p>When using Jinja2 with Flask, you will <a data-primary="render_template method" data-type="indexterm" id="idm45607760654368"/>typically use the <code>render_template</code> method to produce an HTML response from a template in the project’s <em>templates</em> (by default) directory. Any arguments made to <code>render_template</code> after its first template file reference are made available to the template. So with <em>testj2.xhtml</em> in our project’s template directory, the following code will render the template when the user visits the <em>/demolist</em> address, producing the list shown in <a data-type="xref" href="#dev2prod_list">Figure 12-3</a>:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># server_jinja.py</code>
<code class="c1"># ...</code>
<code class="n">app</code> <code class="o">=</code> <code class="n">Flask</code><code class="p">(</code><code class="vm">__name__</code><code class="p">)</code>
<code class="c1"># ...</code>

<code class="n">winners</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code><code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Albert Einstein'</code><code class="p">,</code> <code class="s1">'category'</code><code class="p">:</code><code class="s1">'Physics'</code><code class="p">},</code>
    <code class="p">{</code><code class="s1">'name'</code><code class="p">:</code> <code class="s1">'V.S. Naipaul'</code><code class="p">,</code> <code class="s1">'category'</code><code class="p">:</code><code class="s1">'Literature'</code><code class="p">},</code>
    <code class="p">{</code><code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Dorothy Hodgkin'</code><code class="p">,</code> <code class="s1">'category'</code><code class="p">:</code><code class="s1">'Chemistry'</code><code class="p">}</code>
<code class="p">]</code>

<code class="nd">@app</code><code class="o">.</code><code class="n">route</code><code class="p">(</code><code class="s1">'/winners'</code><code class="p">)</code>
<code class="k">def</code> <code class="nf">winners_list</code><code class="p">():</code>
    <code class="k">return</code> <code class="n">render_template</code><code class="p">(</code><code class="s1">'testj2.xhtml'</code><code class="p">,</code>
                           <code class="n">heading</code><code class="o">=</code><code class="s2">"A little winners'  list"</code><code class="p">,</code>
                           <code class="n">winners</code><code class="o">=</code><code class="n">winners</code>
                           <code class="p">)</code></pre>
<figure><div class="figure" id="dev2prod_list">
<img alt="dpj2 1203" height="159" src="assets/dpj2_1203.png" width="524"/>
<h6><span class="label">Figure 12-3. </span>A winners list rendered from the <em>testj2.xhtml</em> template</h6>
</div></figure>
<p>Jinja2 is a powerful and mature templating language with <a href="https://oreil.ly/lSA7g">comprehensive docs</a>, which makes it a cinch to use data to render  HTML pages server-side.</p>
</div></aside>
<p>As we’ll see in <a data-type="xref" href="#dynamic_data">“Dynamic Data with Flask APIs”</a>, pattern matching with Flask routing makes it trivial to roll out a simple web API. It’s also easy to use templates to generate dynamic web pages as shown in <a data-type="xref" href="#flask_hello_world">Figure 12-4</a>.  Templates can be useful in visualizations for composing essentially static HTML pages server-side, but generally you’ll be delivering a simple HTML backbone on which to build a visualization with JavaScript. With the visualization being configured in JavaScript, the chief job of the server (aside from delivering the static files needed to seed the process) is to dynamically negotiate data (usually providing it) with the browser’s and  JavaScript AJAX requests.</p>
<figure><div class="figure" id="flask_hello_world">
<img alt="dpj2 1204" height="558" src="assets/dpj2_1204.png" width="1431"/>
<h6><span class="label">Figure 12-4. </span>(1) An index.xhtml template is used to create a web page using a <em>message</em> variable, which is then (2) served to the browser</h6>
</div></figure>
<p>Flask is perfectly capable of delivering full websites, with powerful
HTML templating, <a href="https://oreil.ly/Y1PxL">blueprints</a> for
modularizing large sites and supporting common usage patterns, and a slew of
useful plug-ins and extensions. <a href="https://oreil.ly/aoqYy">The Flask user’s guide</a> is a good
starting point for learning more, and the API specifics can be found
<a href="https://oreil.ly/kpFpw">in this subsection of the guide</a>. The single-page apps that
characterize most web visualizations don’t need a lot of bells and whistles
server-side to deliver the necessary static files. Our key interest in Flask is
its ability to provide simple, efficient data servers, with robust RESTful
web APIs available in a few lines of Python. But before dipping our toes in data APIs, let’s look at how we deliver and use file-based data assets such as JSON and CSV files.<a data-primary="Flask" data-secondary="serving data with" data-startref="ix_Flasksrv" data-type="indexterm" id="idm45607760527744"/><a data-primary="Flask" data-startref="ix_Flask" data-type="indexterm" id="idm45607760526592"/><a data-primary="delivering data" data-secondary="serving the data" data-startref="ix_deldasrv" data-type="indexterm" id="idm45607760525648"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Delivering Data Files" data-type="sect1"><div class="sect1" id="sect_static_delivery">
<h1>Delivering Data Files</h1>
<p>Many websites that don’t need the overhead of dynamically configured data choose to deliver their data in a <em>static</em> form, which essentially means that all the HTML files and, crucially, data (usually in JSON or CSV format), exist as files on the server’s filesystem, ready to be delivered without, for example, making calls to a database.<a data-primary="delivering data" data-secondary="data files" data-type="indexterm" id="ix_deldafile"/></p>
<p class="pagebreak-before">Static pages are easy to cache, meaning their delivery can be much
faster. <a data-primary="static data, delivering" data-type="indexterm" id="idm45607760519616"/>It can also be more secure, as those database calls can be a common attack vector for nefarious hackers (e.g., <a href="https://oreil.ly/SY92s">injection attacks</a>). The price paid for this increased speed and security is a loss of flexibility. Being limited to a set of <span class="keep-together">preassembled</span> pages means prohibiting user interactions that might demand multivariate combinations of data.</p>
<p>For the budding data visualizer, there is an attraction in supplying static data. You can easily create a standalone project without needing a web API and are able to deliver your work (in progress) as a single folder of HTML, CSS, and JSON files.</p>
<p>The simplest example of data-driven web visualizations with static files is
probably that seen in the many cool D3 examples at
<a class="bare" href="https://bl.ocks.org/mbostock"><em class="hyperlink">https://bl.ocks.org/mbostock</em></a>.<sup><a data-type="noteref" href="ch12.xhtml#idm45607760514784" id="idm45607760514784-marker">1</a></sup> They follow a similar structure to the basic page we discussed
in <a data-type="xref" href="ch04.xhtml#webdev101_basic_page">“A Basic Page with Placeholders”</a>.</p>
<p>Although the examples use <code>&lt;script&gt;</code> and <code>&lt;style&gt;</code>
tags to embed JavaScript and CSS in the HTML page, I’d recommend keeping your
CSS and JavaScript in separate files, where you get the advantages of a decent format-aware editor and easier debugging.</p>
<p><a data-type="xref" href="#delivery_static_source">Example 12-2</a> shows such an <em>index.xhtml</em> basic page with <code>&lt;h2&gt;</code> and <code>&lt;div&gt;</code> data placeholders and a <code>&lt;script&gt;</code> tag that loads a local <em>script.js</em> file. As we’re only setting the <code>font-family</code> style, we’ll inline the CSS in the page. With our <em>nobel_winners.json</em> dataset in a <em>data</em> subdirectory, this gives us the following file structure:</p>
<pre data-code-language="bash" data-type="programlisting">viz
├── data
│   └── nobel_winners.json
├── index.xhtml
└── script.js</pre>
<div data-type="example" id="delivery_static_source">
<h5><span class="label">Example 12-2. </span>A basic HTML page with data placeholders</h5>
<pre data-code-language="html" data-type="programlisting"><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
  <code class="nt">body</code><code class="p">{</code> <code class="k">font-family</code><code class="o">:</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>
<code class="nt">&lt;/style&gt;</code>

<code class="p">&lt;</code><code class="nt">h2</code> <code class="na">id</code><code class="o">=</code><code class="s">'data-title'</code><code class="p">&gt;&lt;/</code><code class="nt">h2</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">'data'</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">pre</code><code class="p">&gt;&lt;/</code><code class="nt">pre</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"lib/d3.v7.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"script.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre></div>
<p>The static data file for these examples  consists of a single JSON file (<em>nobel_winners.json</em>) sitting in a <em>data</em> subdirectory. Consuming this data requires a JavaScript <a href="https://oreil.ly/5w6MQ">AJAX</a> call to our server. <a data-primary="AJAX calls" data-type="indexterm" id="idm45607760434304"/>D3 provides convenient libraries for making AJAX calls, with D3’s format-specific <code>json</code>, <code>csv</code>, and <code>tsv</code> methods being handier for web visualizers.</p>
<p><a data-type="xref" href="#delivery_d3json">Example 12-3</a> shows how to load data with D3’s <code>json</code> method using a callback function. Behind the scenes, D3 is using JavaScript’s <a href="https://oreil.ly/D5wut">Fetch API</a> to fetch the data. <a data-primary="Fetch API (JavaScript)" data-type="indexterm" id="idm45607760429904"/><a data-primary="JavaScript" data-secondary="Fetch API delivering Promise" data-type="indexterm" id="idm45607760429168"/>This returns a JavaScript <a href="https://oreil.ly/K570a">Promise</a>, which can be resolved using its <code>then</code> method, returning the data  unless an error has occurred.<a data-primary="Promises (JavaScript)" data-type="indexterm" id="idm45607760427056"/></p>
<div data-type="example" id="delivery_d3json">
<h5><span class="label">Example 12-3. </span>Using D3’s <code>json</code> method to load data</h5>
<pre data-code-language="js" data-type="programlisting"><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"data/nobel_winners_cleaned.json"</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
  </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"h2#data-title"</code><code class="p">)</code><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"All the Nobel-winners"</code><code class="p">)</code><code class="p">;</code><code>
  </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"div#data pre"</code><code class="p">)</code><code class="p">.</code><code class="nx">html</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code><code> </code><code class="kc">null</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_delivering_the_data_CO2-1" id="co_delivering_the_data_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_delivering_the_data_CO2-1" id="callout_delivering_the_data_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>JavaScript’s <a href="https://oreil.ly/65ZTd"><code>JSON.stringify</code> method</a> is a handy way to prettify a JavaScript object for output. Here we insert some whitespace to indent the output by four spaces.<a data-primary="JSON.stringify method" data-type="indexterm" id="idm45607760333792"/></p></dd>
</dl></div>
<p>If you run a one-line server (e.g., <code>python -m http.server</code>) in your <em>viz</em> directory and<a data-primary="single-line servers" data-type="indexterm" id="idm45607760331776"/>
open the localhost page in your web browser, you should see something similar to <a data-type="xref" href="#delivery_browser_json">Figure 12-5</a>, indicating the data has been successfully delivered to  JavaScript, ready to be visualized.<a data-primary="delivering data" data-secondary="data files" data-tertiary="delivering JSON to the browser" data-type="indexterm" id="idm45607760330000"/></p>
<figure><div class="figure" id="delivery_browser_json">
<img alt="dpj2 1205" height="444" src="assets/dpj2_1205.png" width="704"/>
<h6><span class="label">Figure 12-5. </span>Delivering JSON to the browser</h6>
</div></figure>
<p>The <em>nobel_winners.json</em> dataset we’re using isn’t particularly large, but if we were to start adding biographical body text or other textual data, it could easily
grow to a size that strains available browser bandwidth and starts to make the
user wait uncomfortably. One strategy to limit loading times is to break the data down into subsets based on one of the dimensions. An obvious way to do this with our data is to store the winners by country. A few lines of pandas does the job of creating a suitable <em>data</em> directory:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code><code> </code><code class="nn">pandas</code><code> </code><code class="k">as</code><code> </code><code class="nn">pd</code><code>
</code><code>
</code><code class="n">df_winners</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">read_json</code><code class="p">(</code><code class="s1">'</code><code class="s1">data/nobel_winners.json</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="k">for</code><code> </code><code class="n">name</code><code class="p">,</code><code> </code><code class="n">group</code><code> </code><code class="ow">in</code><code> </code><code class="n">df_winners</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'</code><code class="s1">country</code><code class="s1">'</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_delivering_the_data_CO3-1" id="co_delivering_the_data_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>    </code><code class="n">group</code><code class="o">.</code><code class="n">to_json</code><code class="p">(</code><code class="s1">'</code><code class="s1">data/winners_by_country</code><code class="s1">'</code><code> </code><code class="o">+</code><code> </code><code class="n">name</code><code> </code><code class="o">+</code><code> </code><code class="s1">'</code><code class="s1">.json</code><code class="s1">'</code><code class="p">,</code><code>\
</code><code>                  </code><code class="n">orient</code><code class="o">=</code><code class="s1">'</code><code class="s1">records</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_delivering_the_data_CO3-1" id="callout_delivering_the_data_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Groups the winners DataFrame by <code>country</code> and iterates over the group name and members.</p></dd>
</dl>
<p>This should give us a <code>winners_by_country</code> <em>data</em> subdirectory:</p>
<pre data-code-language="bash" data-type="programlisting">$ ls data/winners_by_country
Argentina.json  Azerbaijan.json      Canada.json
Colombia.json   Czech Republic.json  Egypt.json  ...</pre>
<p class="pagebreak-before">We can now consume our data by country using a little tailor-made function:</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">let</code> <code class="nx">loadCountryWinnersJSON</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">country</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"data/winners_by_country/"</code> <code class="o">+</code> <code class="nx">country</code> <code class="o">+</code> <code class="s2">".json"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"h2#data-title"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code>
          <code class="s2">"All the Nobel-winners from "</code> <code class="o">+</code> <code class="nx">country</code>
        <code class="p">);</code>
        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"div#data pre"</code><code class="p">).</code><code class="nx">html</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">4</code><code class="p">));</code>
      <code class="p">})</code>
      <code class="p">.</code><code class="k">catch</code><code class="p">((</code><code class="nx">error</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">));</code>
  <code class="p">};</code></pre>
<p>The following function call will select all the Australian Nobel Prize winners, producing <a data-type="xref" href="#delivery_oz">Figure 12-6</a>:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">loadCountryWinnersJSON</code><code class="p">(</code><code class="s1">'Australia'</code><code class="p">);</code></pre>
<figure><div class="figure" id="delivery_oz">
<img alt="dpj2 1206" height="385" src="assets/dpj2_1206.png" width="594"/>
<h6><span class="label">Figure 12-6. </span>Selecting winners by country</h6>
</div></figure>
<p>For the right visualization, the ability to select winners by country could
reduce the data bandwidth and subsequent lag, but what if we wanted winners by
year or gender? Each division by dimension (categorical, temporal, etc.) would
require its own subdirectory, creating a mess of files and all the bookkeeping
that entails. What if we wanted to make fine-grained requests for data (e.g., all
US prize winners since 2000)? At this point, we need a data server that can
respond dynamically to such requests, usually driven by user interaction. The
next section will show you how to start crafting such a server with Flask.<a data-primary="delivering data" data-secondary="data files" data-startref="ix_deldafile" data-type="indexterm" id="idm45607760032144"/></p>
</div></section>
<section data-pdf-bookmark="Dynamic Data with Flask APIs" data-type="sect1"><div class="sect1" id="dynamic_data">
<h1>Dynamic Data with Flask APIs</h1>
<p>Delivering data to web pages with JSON or CSV files is the basis for many of the most impressive dataviz examples seen on the web and is perfect for small demos and prototypes. But there are constraints to the form, most obviously in the size of the datasets that can be realistically delivered. As the datasets increase in size and the files start to tip into megabytes, page loading slows down and user frustration mounts with every spin of the spinner. For much dataviz, particularly dashboards or exploratory charts, it makes sense to deliver the data as needed and in response to user requests generated by a user interface of some form. For this kind of data delivery a small data server is often perfect for the job, and Python’s Flask has everything you need to craft one of these.</p>
<p>If we’re delivering data dynamically, we’re going to need some kind of API to
enable our JavaScript to request data.</p>
<section data-pdf-bookmark="A Simple Data API with Flask" data-type="sect2"><div class="sect2" id="sect_flask_api">
<h2>A Simple Data API with Flask</h2>
<p>Using Dataset (see <a data-type="xref" href="ch03.xhtml#dataset">“Easier SQL with Dataset”</a>), we can easily adapt our existing server for an SQL database. Here we use Dataset for convenience and the specialized JSON encoder (see <a data-type="xref" href="ch03.xhtml#data_json_time">Example 3-2</a>) to convert Python datatimes to a JSON-friendly ISO string:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># server_sql.py</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">flask</code><code> </code><code class="kn">import</code><code> </code><code class="n">Flask</code><code class="p">,</code><code> </code><code class="n">request</code><code class="p">,</code><code> </code><code class="n">abort</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">dataset</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">json</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">datetime</code><code>
</code><code>
</code><code>
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">Flask</code><code class="p">(</code><code class="vm">__name__</code><code class="p">)</code><code>
</code><code class="n">db</code><code> </code><code class="o">=</code><code> </code><code class="n">dataset</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'</code><code class="s1">sqlite:///data/nobel_winners.db</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="nd">@app</code><code class="o">.</code><code class="n">route</code><code class="p">(</code><code class="s1">'</code><code class="s1">/api/winners</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="k">def</code><code> </code><code class="nf">get_country_data</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code> </code><code class="s1">'</code><code class="s1">Request args: </code><code class="s1">'</code><code> </code><code class="o">+</code><code> </code><code class="nb">str</code><code class="p">(</code><code class="nb">dict</code><code class="p">(</code><code class="n">request</code><code class="o">.</code><code class="n">args</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="n">query_dict</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">key</code><code> </code><code class="ow">in</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">country</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">category</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">year</code><code class="s1">'</code><code class="p">]</code><code class="p">:</code><code> </code><a class="co" href="#callout_delivering_the_data_CO4-1" id="co_delivering_the_data_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="n">arg</code><code> </code><code class="o">=</code><code> </code><code class="n">request</code><code class="o">.</code><code class="n">args</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">key</code><code class="p">)</code><code> </code><a class="co" href="#callout_delivering_the_data_CO4-2" id="co_delivering_the_data_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">arg</code><code class="p">:</code><code>
</code><code>            </code><code class="n">query_dict</code><code class="p">[</code><code class="n">key</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">arg</code><code>
</code><code>
</code><code>    </code><code class="n">winners</code><code> </code><code class="o">=</code><code> </code><code class="nb">list</code><code class="p">(</code><code class="n">db</code><code class="p">[</code><code class="s1">'</code><code class="s1">winners</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="n">query_dict</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_delivering_the_data_CO4-3" id="co_delivering_the_data_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="n">winners</code><code class="p">:</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">dumps</code><code class="p">(</code><code class="n">winners</code><code class="p">)</code><code>
</code><code>    </code><code class="n">abort</code><code class="p">(</code><code class="mi">404</code><code class="p">)</code><code> </code><code class="c1"># resource not found</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">JSONDateTimeEncoder</code><code class="p">(</code><code class="n">json</code><code class="o">.</code><code class="n">JSONEncoder</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_delivering_the_data_CO4-4" id="co_delivering_the_data_CO4-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">default</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">obj</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="nb">isinstance</code><code class="p">(</code><code class="n">obj</code><code class="p">,</code><code> </code><code class="p">(</code><code class="n">datetime</code><code class="o">.</code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">obj</code><code class="o">.</code><code class="n">isoformat</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="k">else</code><code class="p">:</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">JSONEncoder</code><code class="o">.</code><code class="n">default</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">obj</code><code class="p">)</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">dumps</code><code class="p">(</code><code class="n">obj</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">obj</code><code class="p">,</code><code> </code><code class="bp">cls</code><code class="o">=</code><code class="n">JSONDateTimeEncoder</code><code class="p">)</code><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="vm">__name__</code><code class="o">==</code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">port</code><code class="o">=</code><code class="mi">8000</code><code class="p">,</code><code> </code><code class="n">debug</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_delivering_the_data_CO4-1" id="callout_delivering_the_data_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Restricts our database queries to keys in this list.</p></dd>
<dt><a class="co" href="#co_delivering_the_data_CO4-2" id="callout_delivering_the_data_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p><code>request.args</code> gives us access to the arguments of the request (e.g., <code>'?country=Australia&amp;category=Chemistry'</code>).</p></dd>
<dt><a class="co" href="#co_delivering_the_data_CO4-3" id="callout_delivering_the_data_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p><code>dataset</code>’s <code>find</code> method requires our argument dictionary to be unpacked with ** (i.e., <code>find(country='Australia', category='Literature')</code>). We convert the iterator to a list, ready to serialize.</p></dd>
<dt><a class="co" href="#co_delivering_the_data_CO4-4" id="callout_delivering_the_data_CO4-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>This is the specialized JSON encoder detailed in <a data-type="xref" href="ch03.xhtml#data_json_time">Example 3-2</a>.</p></dd>
</dl>
<p>We can test this little API with <a href="https://curl.se">curl</a> after starting the server (<code>python server_sql.py</code>). Let’s get all Japanese Physics prizewinners:</p>
<pre data-type="programlisting">$ curl -d category=Physics -d country=Japan
  --get http://localhost:8000/api/

[{"index": 761, "category": "Physics", "country": "Japan",
"date_of_birth": "1907-01-23T00:00:00", "date_of_death": "1981-09-08T00:00:00",
"gender": "male", "link": "http://en.wikipedia.org/wiki/Hideki_Yukawa",
"name": "Hideki Yukawa", "place_of_birth": "Tokyo ,  Japan",
"place_of_death": "Kyoto ,  Japan", "text": "Hideki Yukawa , Physics, 1949",
"year": 1949, "award_age": 42}, {"index": 762, "category": "Physics",
"country": "Japan", "date_of_birth": "1906-03-31T00:00:00",
"date_of_death": "1979-07-08T00:00:00", "gender": "male", ... }]</pre>
<p>You’ve now seen how easy it is to start creating a simple API. There are lots of ways one can extend it, but for fast and dirty prototyping, this is a handy little form.</p>
<p>But what if you want pagination, authentication, and a host of other things a
sophisticated RESTful API would provide? In the next chapter, we’ll see how easy it is to extend our simple data API into something more powerful and extendible, using some brilliant Python libraries like marmalade.</p>
</div></section>
</div></section>
<section class="pagebreak-before less_space" data-pdf-bookmark="Using Static or Dynamic Delivery" data-type="sect1"><div class="sect1" id="idm45607760003808">
<h1>Using Static or Dynamic Delivery</h1>
<p>When to use static or dynamic delivery is highly dependent on context and is an inevitable compromise. Bandwidths vary regionally and with devices. For example, if you’re developing a visualization that should be accessible from a smartphone in a rural context, the data constraints are very different from those of an in-house data app running on a local network.</p>
<p>The ultimate guide is user experience. If a little wait at the beginning while the data caches leads to a lightning-fast JavaScript dataviz, then purely static delivery may well be the answer. If you are allowing the user to cut and slice a large, multivariate dataset, then this probably won’t be possible without an annoyingly long wait time. As a rough rule of thumb, any dataset less than 200 KB should be fine with purely static delivery. As you move into the megabytes of data and beyond, you’ll probably need a database-driven API from which to fetch your data.</p>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45607760001600">
<h1>Summary</h1>
<p>This chapter explained the rudiments of static data delivery of files on the
web server, and dynamic delivery of data, sketching the basis of a simple
Flask-based RESTful web server.  Although Flask makes rolling a basic data API
pretty trivial, adding such bells and whistles as pagination, selective data
queries, and the full complement of HTTP verbs requires a little more work. In the first edition of this book I turned to some off-the-shelf Python RESTful libraries, but these tend to have a short expiry date, probably because it’s so easy to string together some single-purpose Python libraries to achieve the same end, with more flexibility. It’s also a great way to learn those tools, so building just such a RESTful API is the topic of the next chapter.<a data-primary="delivering data" data-startref="ix_delda" data-type="indexterm" id="idm45607760000272"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45607760514784"><sup><a href="ch12.xhtml#idm45607760514784-marker">1</a></sup> Mike Bostock, D3’s creator, is a big advocate of examples. Here’s a <a href="https://oreil.ly/QsMfK">great talk</a> where he emphasizes the role examples have played in the success of D3.</p></div></div></section></div></body></html>