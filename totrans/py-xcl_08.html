<html><head></head><body>
<p id="filepos767560" class="calibre_"><span class="calibre2"><span class="bold"><span class="calibre_15">Chapter 6. Time Series Analysis with pandas</span></span></span></p><p class="calibre_16">A <span class="italic">time series</span> is <a id="filepos767771"/>a series of data points along a time-based axis that plays a central role in many different scenarios: while traders use historical stock prices to calculate risk measures, the weather forecast is based on time series generated by sensors measuring temperature, humidity, and air pressure. And the digital marketing department relies on time series generated by web pages, e.g., the source and number of page views per hour, and will use them to draw conclusions with regard to their marketing campaigns.</p><p class="calibre_6">Time series analysis <a id="filepos768348"/>is one of the main driving forces why data scientists and analysts have started to look for a better alternative to Excel. The following points summarize some of the reasons behind this move:</p><p class="calibre_6"><span class="italic">Big datasets</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">Time series can quickly grow beyond Excel’s limit of roughly one million rows per sheet. For example, if you work with intraday stock prices on a tick data level, you’re often dealing with hundreds of thousands of records—per stock and day!</blockquote></blockquote><p class="calibre_20"><span class="italic">Date and time</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">As we have seen in <a href="index_split_010.html#filepos178328"><span class="calibre_7">Chapter 3</span></a>, Excel has various limitations when it comes to handling date and time, the backbone of time series. Missing support for time zones and a number format that is limited to milliseconds are some of them. pandas supports time zones and uses NumPy’s <tt class="calibre6">datetime64[ns]</tt> data type, which offers a resolution in up to nanoseconds.</blockquote></blockquote><p class="calibre_20"><span class="italic">Missing functionality</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">Excel misses even basic tools to be able to work with time series data in a decent way. For example, if you want to turn a daily time series into a monthly time series, there is no easy way of doing this despite it being a very common task.</blockquote></blockquote><p class="calibre_16">DataFrames <a id="filepos769969"/>allow you to work with various time-based indices: <tt class="calibre6">DatetimeIndex</tt> is the most common one and represents an index with timestamps. Other index types, like <tt class="calibre6">PeriodIndex</tt>, are based on time intervals such as hours or months. In this chapter, however, we are only looking at <tt class="calibre6">DatetimeIndex</tt>, which I will introduce now in more detail.</p><p id="filepos770332" class="calibre_17"><span class="calibre3"><span class="bold"><span class="calibre_7">DatetimeIndex</span></span></span></p><p class="calibre_6">In this section, we’ll learn how to construct a <tt class="calibre6">DatetimeIndex</tt>, how to filter such an index to a specific time range, and how to work with time zones.</p><p id="filepos770653" class="calibre_17"><span class="calibre3"><span class="bold">Creating a DatetimeIndex</span></span></p><p class="calibre_6">To <a id="filepos770795"/>construct a <tt class="calibre6">DatetimeIndex</tt>, pandas offers<a id="filepos770851"/> the <tt class="calibre6">date_range</tt> function. It accepts a start date, a frequency, and either the number of periods or the end date:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Let's start by importing the packages we use in this chapter</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># and by setting the plotting backend to Plotly</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">pandas</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">pd</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">numpy</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">np</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">options</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">plotting</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">backend</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"plotly"</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">2</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># This creates a DatetimeIndex based on a start timestamp,</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># number of periods and frequency ("D" = daily).</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">daily_index</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">date_range</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2020-02-28"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">periods</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">4</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">freq</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"D"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">daily_index</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[2]: DatetimeIndex(['2020-02-28', '2020-02-29', '2020-03-01', '2020-03-02'],<br class="calibre1"/>         dtype='datetime64[ns]', freq='D')</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">3</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># This creates a DatetimeIndex based on start/end timestamp.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># The frequency is set to "weekly on Sundays" ("W-SUN").</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">weekly_index</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">date_range</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2020-01-01"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2020-01-31"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">freq</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"W-SUN"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">weekly_index</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[3]: DatetimeIndex(['2020-01-05', '2020-01-12', '2020-01-19', '2020-01-26'],<br class="calibre1"/>         dtype='datetime64[ns]', freq='W-SUN')</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">4</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Construct a DataFrame based on the weekly_index. This could be</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># the visitor count of a museum that only opens on Sundays.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">DataFrame</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">data</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">21</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">15</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">33</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">34</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">],</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                     </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">columns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"visitors"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">],</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">weekly_index</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[4]:             visitors<br class="calibre1"/>        2020-01-05        21<br class="calibre1"/>        2020-01-12        15<br class="calibre1"/>        2020-01-19        33<br class="calibre1"/>        2020-01-26        34</tt></span></blockquote><p class="calibre_32">Let’s now return to the Microsoft stock time series from the last chapter. When you take a closer look at the data types of the columns, you will notice that the <tt class="calibre6">Date</tt> column has the type <tt class="calibre6">object</tt>, which means that pandas has interpreted the timestamps as strings:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">5</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">read_csv</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"csv/MSFT.csv"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">6</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">info</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">&lt;class 'pandas.core.frame.DataFrame'&gt;<br class="calibre1"/>RangeIndex: 8622 entries, 0 to 8621<br class="calibre1"/>Data columns (total 7 columns):<br class="calibre1"/> #   Column     Non-Null Count  Dtype<br class="calibre1"/>---  ------     --------------  -----<br class="calibre1"/> 0   Date       8622 non-null   object<br class="calibre1"/> 1   Open       8622 non-null   float64<br class="calibre1"/> 2   High       8622 non-null   float64<br class="calibre1"/> 3   Low        8622 non-null   float64<br class="calibre1"/> 4   Close      8622 non-null   float64<br class="calibre1"/> 5   Adj Close  8622 non-null   float64<br class="calibre1"/> 6   Volume     8622 non-null   int64<br class="calibre1"/>dtypes: float64(5), int64(1), object(1)<br class="calibre1"/>memory usage: 471.6+ KB</tt></span></blockquote><p class="calibre_32">There are two ways to fix this and turn it into<a id="filepos783176"/> a <tt class="calibre6">datetime</tt> data type. The first one is to run the <tt class="calibre6">to_datetime</tt> function<a id="filepos783272"/> on that column. Make sure to assign the transformed column back to the original DataFrame if you want to change it at the source:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">7</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[:,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Date"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">to_datetime</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Date"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">])</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">8</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">dtypes</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[8]: Date         datetime64[ns]<br class="calibre1"/>        Open                float64<br class="calibre1"/>        High                float64<br class="calibre1"/>        Low                 float64<br class="calibre1"/>        Close               float64<br class="calibre1"/>        Adj Close           float64<br class="calibre1"/>        Volume                int64<br class="calibre1"/>        dtype: object</tt></span></blockquote><p class="calibre_32">The other possibility is to<a id="filepos786030"/> tell <tt class="calibre6">read_csv</tt> about the columns that contain timestamps by using the <tt class="calibre6">parse_dates</tt> argument. <tt class="calibre6">parse_dates</tt> expects a list of column names or indices. Also, you almost always want to turn timestamps into the index of the DataFrame since this will allow you to filter the data easily, as we will see in a moment. To spare yourself an extra <tt class="calibre6">set_index</tt> call, provide the column you would like to use as index via the <tt class="calibre6">index_col</tt> argument, again as column name or index:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">9</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">read_csv</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"csv/MSFT.csv"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                           </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index_col</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Date"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">parse_dates</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Date"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">])</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">10</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">info</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">&lt;class 'pandas.core.frame.DataFrame'&gt;<br class="calibre1"/>DatetimeIndex: 8622 entries, 1986-03-13 to 2020-05-27<br class="calibre1"/>Data columns (total 6 columns):<br class="calibre1"/> #   Column     Non-Null Count  Dtype<br class="calibre1"/>---  ------     --------------  -----<br class="calibre1"/> 0   Open       8622 non-null   float64<br class="calibre1"/> 1   High       8622 non-null   float64<br class="calibre1"/> 2   Low        8622 non-null   float64<br class="calibre1"/> 3   Close      8622 non-null   float64<br class="calibre1"/> 4   Adj Close  8622 non-null   float64<br class="calibre1"/> 5   Volume     8622 non-null   int64<br class="calibre1"/>dtypes: float64(5), int64(1)<br class="calibre1"/>memory usage: 471.5 KB</tt></span></blockquote><p class="calibre_32">As <tt class="calibre6">info</tt> reveals, you are now dealing with a DataFrame that has a <tt class="calibre6">DatetimeIndex</tt>. If you would need to change another data type (let’s say you wanted <tt class="calibre6">Volume</tt> to be a <tt class="calibre6">float</tt> instead of an <tt class="calibre6">int</tt>), you again have two options: either provide <tt class="calibre6">dtype={"Volume": float}</tt> as argument to the <tt class="calibre6">read_csv</tt> function, or apply the <tt class="calibre6">astype</tt> method as follows:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">11</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[:,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Volume"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Volume"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">astype</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"float"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Volume"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">dtype</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[11]: dtype('float64')</tt></span></blockquote><p class="calibre_32">With time series, it’s always a good idea to make sure the index is sorted properly before starting your analysis:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">12</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sort_index</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_32">And finally, if you need to access only parts of a <tt class="calibre6">DatetimeIndex</tt>, like the date part without the time, access the <tt class="calibre6">date</tt> attribute like this:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">13</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">date</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[13]: array([datetime.date(1986, 3, 13), datetime.date(1986, 3, 14),<br class="calibre1"/>                datetime.date(1986, 3, 17), ..., datetime.date(2020, 5, 22),<br class="calibre1"/>                datetime.date(2020, 5, 26), datetime.date(2020, 5, 27)],<br class="calibre1"/>               dtype=object)</tt></span></blockquote><p class="calibre_32">Instead of <tt class="calibre6">date</tt>, you can also use parts of a date like <tt class="calibre6">year</tt>, <tt class="calibre6">month</tt>, <tt class="calibre6">day</tt>, etc. To access the same functionality on a regular column with data type <tt class="calibre6">datetime</tt>, you will have to use the <tt class="calibre6">dt</tt> attribute, e.g., <tt class="calibre6">df["column_name"].dt.date</tt>.</p><p class="calibre_6">With<a id="filepos794737"/> a sorted <tt class="calibre6">DatetimeIndex</tt>, let’s see how we can filter the DataFrame to certain time periods!</p><p id="filepos794850" class="calibre_17"><span class="calibre3"><span class="bold">Filtering a DatetimeIndex</span></span></p><p class="calibre_6">If <a id="filepos794993"/>your DataFrame has a <tt class="calibre6">DatetimeIndex</tt>, there is an easy way to select rows from a specific time period by using <tt class="calibre6">loc</tt> with a string in the format <tt class="calibre6">YYYY-MM-DD HH:MM:SS</tt>. pandas will turn this string into a slice so it covers the whole period. For example, to select all rows from 2019, provide the year as a <span class="italic">string</span>, not a number:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">14</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2019"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[14]: Date<br class="calibre1"/>         2019-01-02     99.099190<br class="calibre1"/>         2019-01-03     95.453529<br class="calibre1"/>         2019-01-04     99.893005<br class="calibre1"/>         2019-01-07    100.020401<br class="calibre1"/>         2019-01-08    100.745613<br class="calibre1"/>                          ...<br class="calibre1"/>         2019-12-24    156.515396<br class="calibre1"/>         2019-12-26    157.798309<br class="calibre1"/>         2019-12-27    158.086731<br class="calibre1"/>         2019-12-30    156.724243<br class="calibre1"/>         2019-12-31    156.833633<br class="calibre1"/>         Name: Adj Close, Length: 252, dtype: float64</tt></span></blockquote><p class="calibre_32">Let’s take this a step further and plot the data between June 2019 and May 2020 (see <a href="#filepos798528"><span class="calibre_7">Figure 6-1</span></a>):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">15</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2019-06"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2020-05"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">plot</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_73"><img src="images/00028.jpg" id="filepos798528" class="calibre_76"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 6-1. Adjusted close price for MSFT</span></span></span></p><p class="calibre_24">Hover over the Plotly chart to read off the value as a tooltip and zoom in by drawing a rectangle with your mouse. Double-click the chart to get back to the default<a id="filepos798956"/> view.</p><p class="calibre_6">We’ll use the adjusted close price in the next section to learn about time zone handling.</p><p id="filepos799109" class="calibre_17"><span class="calibre3"><span class="bold">Working with Time Zones</span></span></p><p class="calibre_6">Microsoft <a id="filepos799257"/>is listed on the Nasdaq stock exchange. The Nasdaq is in New York and markets close at 4:00 p.m. To add this additional information to the DataFrame’s index, first add the closing hour to the date via <tt class="calibre6">DateOffset</tt>, then attach the correct time zone to the timestamps<a id="filepos799539"/> via <tt class="calibre6">tz_localize</tt>. Since the closing hour is only applicable to the close price, let’s create a new DataFrame with it:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">16</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Add the time information to the date</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[:,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">copy</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">+</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">DateOffset</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">hours</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">16</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">2</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[16]:                      Adj Close<br class="calibre1"/>         Date<br class="calibre1"/>         1986-03-13 16:00:00   0.062205<br class="calibre1"/>         1986-03-14 16:00:00   0.064427</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">17</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Make the timestamps time-zone-aware</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">tz_localize</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"America/New_York"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">2</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[17]:                            Adj Close<br class="calibre1"/>         Date<br class="calibre1"/>         1986-03-13 16:00:00-05:00   0.062205<br class="calibre1"/>         1986-03-14 16:00:00-05:00   0.064427</tt></span></blockquote><p class="calibre_32">If you want to convert the timestamps to UTC time zone, use<a id="filepos805006"/> the DataFrame method <tt class="calibre6">tz_convert</tt>. UTC stands for <span class="italic">Coordinated Universal Time</span> and is the successor of Greenwich Mean Time (GMT). Note how the closing hours change in UTC depending on whether daylight saving time (DST) is in effect or not in New York:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">18</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">tz_convert</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"UTC"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2020-01-02"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># 21:00 without DST</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[18]: Date<br class="calibre1"/>         2020-01-02 21:00:00+00:00    159.737595<br class="calibre1"/>         Name: Adj Close, dtype: float64</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">19</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2020-05-01"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># 20:00 with DST</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[19]: Date<br class="calibre1"/>         2020-05-01 20:00:00+00:00    174.085175<br class="calibre1"/>         Name: Adj Close, dtype: float64</tt></span></blockquote><p class="calibre_32">Preparing time series like this will allow you to compare close prices from stock exchanges across different time zones even if the time info is missing or stated in the local time zone.</p><p class="calibre_6">Now that<a id="filepos808759"/> you know what a <tt class="calibre6">DatetimeIndex</tt> is, let’s try out a few common time series manipulations in the next section by calculating and comparing stock performance.</p><p id="filepos808936" class="calibre_17"><span class="calibre3"><span class="bold"><span class="calibre_7">Common Time Series Manipulations</span></span></span></p><p class="calibre_6">In this section, I’ll show you how to perform common time series analysis tasks such as calculating stock returns, plotting the performance of various stocks, and visualizing the correlation of their returns in a heatmap. We’ll also see how to change the frequency of time series and how to calculate rolling statistics.</p><p id="filepos809440" class="calibre_17"><span class="calibre3"><span class="bold">Shifting and Percentage Changes</span></span></p><p class="calibre_6">In<a id="filepos809588"/> finance, <a id="filepos809605"/>the <span class="italic">log returns</span> of stocks are often assumed to be normally distributed. By log returns, I mean the natural logarithm of the ratio of the current and previous price. To get a feeling for the distribution of the daily log returns, let’s plot a histogram. First, however, we need to calculate the log returns. In Excel, it’s typically done with a formula that involves cells from two rows, as shown in <a href="#filepos810136"><span class="calibre_7">Figure 6-2</span></a>.</p><p class="calibre_21"><img src="images/00036.jpg" id="filepos810136" class="calibre_77"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 6-2. Calculating log returns in Excel</span></span></span></p><blockquote class="calibre_25"><span class="bold"><span class="calibre_29">LOGARITHMS IN EXCEL AND PYTHON</span></span></blockquote><blockquote class="calibre_27"><span class="calibre5">Excel uses </span><a id="filepos810574"/><span class="calibre5"><tt class="calibre6">LN</tt></span><span class="calibre5"> to denote the natural logarithm and </span><span class="calibre5"><tt class="calibre6">LOG</tt></span><span class="calibre5"> for the logarithm with base 10. Python’s math module and NumPy, however, use </span><span class="calibre5"><tt class="calibre6">log</tt></span><span class="calibre5"> for the natural logarithm and </span><span class="calibre5"><tt class="calibre6">log10</tt></span><span class="calibre5"> for the logarithm with base 10.</span></blockquote><p class="calibre_16">With pandas, rather than having a formula accessing two different rows, you use<a id="filepos811119"/> the <tt class="calibre6">shift</tt> method to shift the values down by one row. This allows you to operate on a single row so your calculations can make use of vectorization. <tt class="calibre6">shift</tt> accepts a positive or negative integer that shifts the time series down or up by the respective number of rows. Let’s first see how <tt class="calibre6">shift</tt> works:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">20</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[20]:                            Adj Close<br class="calibre1"/>         Date<br class="calibre1"/>         1986-03-13 21:00:00+00:00   0.062205<br class="calibre1"/>         1986-03-14 21:00:00+00:00   0.064427<br class="calibre1"/>         1986-03-17 21:00:00+00:00   0.065537<br class="calibre1"/>         1986-03-18 21:00:00+00:00   0.063871<br class="calibre1"/>         1986-03-19 21:00:00+00:00   0.062760</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">21</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">shift</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[21]:                            Adj Close<br class="calibre1"/>         Date<br class="calibre1"/>         1986-03-13 21:00:00+00:00        NaN<br class="calibre1"/>         1986-03-14 21:00:00+00:00   0.062205<br class="calibre1"/>         1986-03-17 21:00:00+00:00   0.064427<br class="calibre1"/>         1986-03-18 21:00:00+00:00   0.065537<br class="calibre1"/>         1986-03-19 21:00:00+00:00   0.063871</tt></span></blockquote><p class="calibre_32">You are now able to write a single vector-based formula that is easy to read and understand. To get the natural logarithm, use<a id="filepos814239"/> NumPy’s <tt class="calibre6">log</tt> ufunc, which is applied to each element. Then we can plot a histogram (see <a href="#filepos818582"><span class="calibre_7">Figure 6-3</span></a>):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">22</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">returns</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">np</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">log</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">/</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">shift</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">))</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">returns</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">returns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">rename</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">columns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">{</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"returns"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">})</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">returns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[22]:                             returns<br class="calibre1"/>         Date<br class="calibre1"/>         1986-03-13 21:00:00+00:00       NaN<br class="calibre1"/>         1986-03-14 21:00:00+00:00  0.035097<br class="calibre1"/>         1986-03-17 21:00:00+00:00  0.017082<br class="calibre1"/>         1986-03-18 21:00:00+00:00 -0.025749<br class="calibre1"/>         1986-03-19 21:00:00+00:00 -0.017547</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">23</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Plot a histogram with the daily log returns</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">returns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">plot</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">hist</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_73"><img src="images/00045.jpg" id="filepos818582" class="calibre_76"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 6-3. Histogram plot</span></span></span></p><p class="calibre_24">To<a id="filepos818833"/> get <span class="italic">simple returns</span> instead, use pandas’ built-in <tt class="calibre6">pct_change</tt> method. By default, it calculates the percentage change from the previous row, which is also the definition of simple returns:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">24</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">simple_rets</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pct_change</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">simple_rets</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">simple_rets</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">rename</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">columns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">{</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"simple rets"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">})</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">simple_rets</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[24]:                            simple rets<br class="calibre1"/>         Date<br class="calibre1"/>         1986-03-13 21:00:00+00:00          NaN<br class="calibre1"/>         1986-03-14 21:00:00+00:00     0.035721<br class="calibre1"/>         1986-03-17 21:00:00+00:00     0.017229<br class="calibre1"/>         1986-03-18 21:00:00+00:00    -0.025421<br class="calibre1"/>         1986-03-19 21:00:00+00:00    -0.017394</tt></span></blockquote><p class="calibre_32">So far, we <a id="filepos821793"/>have looked at just the Microsoft stock. In the next section, we’re going to load more time series so we can have a look at other DataFrame methods that require multiple time series.</p><p id="filepos821988" class="calibre_17"><span class="calibre3"><span class="bold">Rebasing and Correlation</span></span></p><p class="calibre_6">Things<a id="filepos822133"/> get slightly more interesting when we work with more than one time series. Let’s load a few additional adjusted close prices for Amazon (<tt class="calibre6">AMZN</tt>), Google (<tt class="calibre6">GOOGL</tt>), and Apple (<tt class="calibre6">AAPL</tt>), also downloaded from Yahoo! Finance:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">25</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">parts</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[]</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># List to collect individual DataFrames</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">for</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">ticker</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_15">in</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"AAPL"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"AMZN"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"GOOGL"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"MSFT"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># "usecols" allows us to only read in the Date and Adj Close</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">read_csv</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"csv/{ticker}.csv"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                                     </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index_col</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Date"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">parse_dates</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Date"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">],</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                                     </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">usecols</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Date"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">])</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Rename the column into the ticker symbol</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">rename</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">columns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">{</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">ticker</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">})</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Append the stock's DataFrame to the parts list</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">parts</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">append</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">26</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Combine the 4 DataFrames into a single DataFrame</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">concat</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">parts</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">axis</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[26]:                   AAPL         AMZN        GOOGL        MSFT<br class="calibre1"/>         Date<br class="calibre1"/>         1980-12-12    0.405683          NaN          NaN         NaN<br class="calibre1"/>         1980-12-15    0.384517          NaN          NaN         NaN<br class="calibre1"/>         1980-12-16    0.356296          NaN          NaN         NaN<br class="calibre1"/>         1980-12-17    0.365115          NaN          NaN         NaN<br class="calibre1"/>         1980-12-18    0.375698          NaN          NaN         NaN<br class="calibre1"/>         ...                ...          ...          ...         ...<br class="calibre1"/>         2020-05-22  318.890015  2436.879883  1413.239990  183.509995<br class="calibre1"/>         2020-05-26  316.730011  2421.860107  1421.369995  181.570007<br class="calibre1"/>         2020-05-27  318.109985  2410.389893  1420.280029  181.809998<br class="calibre1"/>         2020-05-28  318.250000  2401.100098  1418.239990         NaN<br class="calibre1"/>         2020-05-29  317.940002  2442.370117  1433.520020         NaN<br class="calibre1"/><br class="calibre1"/>         [9950 rows x 4 columns]</tt></span></blockquote><p class="calibre_32">Did you see the power<a id="filepos831244"/> of <tt class="calibre6">concat</tt>? pandas has automatically aligned the individual time series along the dates. This is why you get <tt class="calibre6">NaN</tt> values for those stocks that don’t go back as far as Apple. And since <tt class="calibre6">MSFT</tt> has <tt class="calibre6">NaN</tt> values at the most recent dates, you may have guessed that I downloaded <span class="italic">MSFT.csv</span> two days before the other ones. Aligning time series by date is a typical operation that is very cumbersome to do with Excel and therefore also very error-prone. Dropping all rows that contain missing values will make sure that all stocks have the same amount of data points:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">27</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">dropna</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">info</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">&lt;class 'pandas.core.frame.DataFrame'&gt;<br class="calibre1"/>DatetimeIndex: 3970 entries, 2004-08-19 to 2020-05-27<br class="calibre1"/>Data columns (total 4 columns):<br class="calibre1"/> #   Column  Non-Null Count  Dtype<br class="calibre1"/>---  ------  --------------  -----<br class="calibre1"/> 0   AAPL    3970 non-null   float64<br class="calibre1"/> 1   AMZN    3970 non-null   float64<br class="calibre1"/> 2   GOOGL   3970 non-null   float64<br class="calibre1"/> 3   MSFT    3970 non-null   float64<br class="calibre1"/>dtypes: float64(4)<br class="calibre1"/>memory usage: 155.1 KB</tt></span></blockquote><p class="calibre_32">Let’s now rebase the prices so that all time series start at 100. This allows us to compare their relative performance in a chart; see <a href="#filepos838207"><span class="calibre_7">Figure 6-4</span></a>. To rebase a time series, divide every value by its starting value and multiply by 100, the new base. If you did this in Excel, you would typically write a formula with a combination of absolute and relative cell references, then copy the formula for every row and every time series. In pandas, thanks to vectorization and broadcasting, you are dealing with a single formula:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">28</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Use a sample from June 2019 - May 2020</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close_sample</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2019-06"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2020-05"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:]</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">rebased_prices</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close_sample</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">/</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close_sample</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">iloc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">0</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:]</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">*</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">100</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">rebased_prices</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">2</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[28]:                   AAPL        AMZN      GOOGL        MSFT<br class="calibre1"/>         Date<br class="calibre1"/>         2019-06-03  100.000000  100.000000  100.00000  100.000000<br class="calibre1"/>         2019-06-04  103.658406  102.178197  101.51626  102.770372</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">29</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">rebased_prices</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">plot</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_73"><img src="images/00053.jpg" id="filepos838207" class="calibre_78"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 6-4. Rebased time series</span></span></span></p><p class="calibre_24">To see how independent the returns of the different stocks are, have a look at their correlations by using<a id="filepos838567"/> the <tt class="calibre6">corr</tt> method. Unfortunately, pandas doesn’t provide a built-in plot type to visualize the correlation matrix as a heatmap, so we need to use <a id="filepos838730"/>Plotly directly via its <tt class="calibre6">plotly.express</tt> interface (see <a href="#filepos846256"><span class="calibre_7">Figure 6-5</span></a>):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">30</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Correlation of daily log returns</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">returns</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">np</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">log</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">/</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">shift</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">))</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">returns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">corr</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[30]:            AAPL      AMZN     GOOGL      MSFT<br class="calibre1"/>         AAPL   1.000000  0.424910  0.503497  0.486065<br class="calibre1"/>         AMZN   0.424910  1.000000  0.486690  0.485725<br class="calibre1"/>         GOOGL  0.503497  0.486690  1.000000  0.525645<br class="calibre1"/>         MSFT   0.486065  0.485725  0.525645  1.000000</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">31</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">plotly.express</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">px</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">32</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">fig</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">px</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">imshow</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">returns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">corr</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(),</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">x</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">columns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">y</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">columns</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">color_continuous_scale</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_58">list</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_58">reversed</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">px</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">colors</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sequential</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">RdBu</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)),</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">zmin</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=-</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">zmax</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">fig</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">show</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_32">If you want to understand <a id="filepos846056"/>how <tt class="calibre6">imshow</tt> works in detail, have a look at the <a href="https://oreil.ly/O86li"><span class="calibre_7">Plotly Express API docs</span></a>.</p><p class="calibre_21"><img src="images/00064.jpg" id="filepos846256" class="calibre_79"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 6-5. Correlation heatmap</span></span></span></p><p class="calibre_24">At this point, we have already learned quite a few things about time series, including how to combine and clean them and how to calculate returns and correlations. But what if you decide that daily returns are not a good base for your analysis and you want monthly returns? How you change the frequency of time series data is the topic of <a id="filepos846848"/>the next section.</p><p id="filepos846876" class="calibre_17"><span class="calibre3"><span class="bold">Resampling</span></span></p><p class="calibre_6">A <a id="filepos847003"/>regular task with time series is <span class="italic">up-</span> and <span class="italic">downsampling</span>. Upsampling <a id="filepos847090"/>means that the time series is converted into one with a higher frequency, and downsampling means that it is converted into one with a lower frequency. On financial factsheets, you often show monthly or quarterly performance, for example. To turn the daily time series into a monthly one, use<a id="filepos847388"/> the <tt class="calibre6">resample</tt> method that accepts a frequency string like <tt class="calibre6">M</tt> for <span class="italic">end-of-calendar-month</span> or <tt class="calibre6">BM</tt> for <span class="italic">end-of-business-month</span>. You can find a list of all frequency strings in the <a href="https://oreil.ly/zStpt"><span class="calibre_7">pandas docs</span></a>. Similar to how <tt class="calibre6">groupby</tt> works, you then chain a method that defines <span class="italic">how</span> you are resampling. I am using <tt class="calibre6">last</tt> to always take the last observation of that month:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">33</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">end_of_month</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">adj_close</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">resample</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"M"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">last</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">end_of_month</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[33]:                 AAPL       AMZN      GOOGL       MSFT<br class="calibre1"/>         Date<br class="calibre1"/>         2004-08-31  2.132708  38.139999  51.236237  17.673630<br class="calibre1"/>         2004-09-30  2.396127  40.860001  64.864868  17.900215<br class="calibre1"/>         2004-10-31  3.240182  34.130001  95.415413  18.107374<br class="calibre1"/>         2004-11-30  4.146072  39.680000  91.081078  19.344421<br class="calibre1"/>         2004-12-31  3.982207  44.290001  96.491493  19.279480</tt></span></blockquote><p class="calibre_32">Instead of <tt class="calibre6">last</tt>, you can choose any other method that works on <tt class="calibre6">groupby</tt>, like <tt class="calibre6">sum</tt> or <tt class="calibre6">mean</tt>. There is also <tt class="calibre6">ohlc</tt>, which<a id="filepos850167"/> conveniently returns the open, high, low, and close values over that period. This may serve as the source to create the typical candlestick charts that are often used with stock prices.</p><p class="calibre_6">If that end-of-month time series would be all you have and you need to produce a weekly time series out of it, you have to upsample your time series. By <a id="filepos850558"/>using <tt class="calibre6">asfreq</tt>, you are telling pandas not to apply any transformation and hence you will see most of the values showing <tt class="calibre6">NaN</tt>. If you wanted to <span class="italic">forward-fill</span> the <a id="filepos850748"/>last known value instead, use the <tt class="calibre6">ffill</tt> method:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">34</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">end_of_month</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">resample</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"D"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">asfreq</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># No transformation</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[34]:                 AAPL       AMZN      GOOGL      MSFT<br class="calibre1"/>         Date<br class="calibre1"/>         2004-08-31  2.132708  38.139999  51.236237  17.67363<br class="calibre1"/>         2004-09-01       NaN        NaN        NaN       NaN<br class="calibre1"/>         2004-09-02       NaN        NaN        NaN       NaN<br class="calibre1"/>         2004-09-03       NaN        NaN        NaN       NaN<br class="calibre1"/>         2004-09-04       NaN        NaN        NaN       NaN</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">35</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">end_of_month</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">resample</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"W-FRI"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">ffill</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Forward fill</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[35]:                 AAPL       AMZN      GOOGL       MSFT<br class="calibre1"/>         Date<br class="calibre1"/>         2004-09-03  2.132708  38.139999  51.236237  17.673630<br class="calibre1"/>         2004-09-10  2.132708  38.139999  51.236237  17.673630<br class="calibre1"/>         2004-09-17  2.132708  38.139999  51.236237  17.673630<br class="calibre1"/>         2004-09-24  2.132708  38.139999  51.236237  17.673630<br class="calibre1"/>         2004-10-01  2.396127  40.860001  64.864868  17.900215</tt></span></blockquote><p class="calibre_32">Downsampling data is <a id="filepos854741"/>one way of smoothing a time series. Calculating statistics over a rolling window is another way, as we will see next.</p><p id="filepos854869" class="calibre_17"><span class="calibre3"><span class="bold">Rolling Windows</span></span></p><p class="calibre_6">When <a id="filepos855004"/>you calculate time series statistics, you often want a rolling statistic such as the <span class="italic">moving average</span>. The moving average looks at a subset of the time series (let’s say 25 days) and takes the mean from this subset before moving the window forward by one day. This will result in a new time series that is smoother and less prone to outliers. If you are into algorithmic trading, you may be looking at the intersection of the moving average with the stock price and take this (or some variation of it) as a trading signal. DataFrames have <a id="filepos855557"/>a <tt class="calibre6">rolling</tt> method, which accepts the number of observations as argument. You then chain it with the statistical method that you want to use—in the case of the moving average, it’s the <tt class="calibre6">mean</tt>. By looking at <a href="#filepos859395"><span class="calibre_7">Figure 6-6</span></a>, you are easily able to compare the original time series with the smoothed moving average:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">36</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Plot the moving average for MSFT with data from 2019</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft19</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"2019"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">copy</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Add the 25 day moving average as a new column to the DataFrame</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft19</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[:,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"25day average"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft19</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Adj Close"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">rolling</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">25</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">mean</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">msft19</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">plot</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_73"><img src="images/00072.jpg" id="filepos859395" class="calibre_80"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 6-6. Moving average plot</span></span></span></p><p class="calibre_24">Instead of <tt class="calibre6">mean</tt>, you can use many other statistical measures including <tt class="calibre6">count</tt>, <tt class="calibre6">sum</tt>, <tt class="calibre6">median</tt>, <tt class="calibre6">min</tt>, <tt class="calibre6">max</tt>, <tt class="calibre6">std</tt> (standard deviation), or <tt class="calibre6">var</tt> (variance).</p><p class="calibre_6">At this point, we have seen the most important functionality of pandas. It’s equally important, though, to understand where pandas has its limits, even though they may still be far away right now.</p><p id="filepos860113" class="calibre_17"><span class="calibre3"><span class="bold"><span class="calibre_7">Limitations with pandas</span></span></span></p><p class="calibre_6">When <a id="filepos860285"/>your DataFrames start to get bigger, it’s a good idea to know the upper limit of what a DataFrame can hold. Unlike Excel, where you have a hard limit of roughly one million rows and 12,000 columns per sheet, pandas only has a soft limit: all data must fit into the available memory of your machine. If that’s not the case, there might be some easy fixes: only load those columns from your dataset that you need or delete intermediate results to free up some memory. If that doesn’t help, there are quite a<a id="filepos860803"/> few projects that will feel familiar to pandas users but work with big data. One of the projects, <a href="https://dask.org"><span class="calibre_7">Dask</span></a>, <a id="filepos860975"/>works on top of NumPy and pandas and allows you to work with big datasets by splitting it up into multiple pandas DataFrames and distributing the workload across multiple CPU cores or machines. Other big data projects that work<a id="filepos861209"/> with some sort of DataFrame are <a href="https://oreil.ly/Wd8gi"><span class="calibre_7">Modin</span></a>, <a href="https://oreil.ly/V13Be"><span class="calibre_7">Koalas</span></a>, <a href="https://vaex.io"><span class="calibre_7">Vaex</span></a>, <a href="https://oreil.ly/E7kmX"><span class="calibre_7">PySpark</span></a>, <a href="https://oreil.ly/zaeWz"><span class="calibre_7">cuDF</span></a>, <a href="https://oreil.ly/Gw4wn"><span class="calibre_7">Ibis</span></a>, and <a href="https://oreil.ly/DQQGD"><span class="calibre_7">PyArrow</span></a>. We will briefly touch on Modin in the next chapter but other than that, this is not something we are going to explore further in this book.</p><p id="filepos861902" class="calibre_17"><span class="calibre3"><span class="bold"><span class="calibre_7">Conclusion</span></span></span></p><p class="calibre_6">Time series analysis is the area where I feel Excel has fallen behind the most, so after reading this chapter, you probably understand why pandas has such a big success in finance, an industry that heavily relies on time series. We’ve seen how easy it is to work with time zones, resample time series, or produce correlation matrices, functionality that either isn’t supported in Excel or requires cumbersome workarounds.</p><p class="calibre_6">Knowing how to use pandas doesn’t mean you have to get rid of Excel, though, as the two worlds can play very nicely together: pandas DataFrames are a great way to transfer data from one world to the other, as we will see in the next part, which is about reading and writing Excel files in ways that bypass the Excel application entirely. This is very helpful as it means you can manipulate Excel files with Python on every operating system that Python supports, including Linux. To start this journey, the next chapter will show you how pandas can be used to automate tedious manual processes like the aggregation of Excel files into summary reports.</p><div class="mbp_pagebreak" id="calibre_pb_14"/>
</body></html>