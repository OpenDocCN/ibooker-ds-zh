<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 19. Mapping with D3" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_d3_maps">
<h1><span class="label">Chapter 19. </span>Mapping with D3</h1>
<p>Building and customizing map visualizations is one of D3’s core strengths.<a data-primary="mapping with D3" data-type="indexterm" id="ix_mapD3"/><a data-primary="D3 library" data-secondary="mapping with" data-type="indexterm" id="ix_D3map"/> It has some very sophisticated libraries, allowing for all kinds of projections, from the workhorse Mercator and orthographic to more esoteric ones such as Conic Equidistant. Mapping seems to be something of an obsession for Mike Bostock and Jason Davies, D3’s core devs, and their attention to detail is striking. If you have a mapping problem, chances are D3 can do the heavy lifting required.<sup><a data-type="noteref" href="ch19.xhtml#idm45607741792448" id="idm45607741792448-marker">1</a></sup> In this chapter, we’ll use our Nobel Prize visualization (Nobel-viz) map (<a data-type="xref" href="#d3maps_target">Figure 19-1</a>) to introduce the core D3 mapping concepts.</p>
<figure><div class="figure" id="d3maps_target">
<img alt="dpj2 1503" height="356" src="assets/dpj2_1503.png" width="701"/>
<h6><span class="label">Figure 19-1. </span>This chapter’s target element</h6>
</div></figure>
<section data-pdf-bookmark="Available Maps" data-type="sect1"><div class="sect1" id="idm45607741788864">
<h1>Available Maps</h1>
<p>The most popular mapping format is the aging <a href="https://oreil.ly/XV4Cb">shapefile</a>, developed for geographic information system (GIS) software. There  are many free and proprietary desktop programs<sup><a data-type="noteref" href="ch19.xhtml#idm45607741786480" id="idm45607741786480-marker">2</a></sup> to manipulate and produce shapefiles.<a data-primary="mapping with D3" data-secondary="available maps" data-type="indexterm" id="idm45607741784976"/><a data-primary="D3 library" data-secondary="mapping with" data-tertiary="available maps" data-type="indexterm" id="idm45607741784000"/><a data-primary="shapefiles" data-type="indexterm" id="idm45607741782784"/></p>
<p>Unfortunately, shapefiles were not designed for the web, which would far rather deal in a JSON-based map format, and demands small, efficient representations to limit bandwidth and related lag.</p>
<p>The good news is that there are many convenient ways to convert shapefiles to our preferred TopoJSON format,<sup><a data-type="noteref" href="ch19.xhtml#idm45607741781184" id="idm45607741781184-marker">3</a></sup> meaning you can manipulate your shapefiles in software and then convert them to a web-friendly format. The standard way of finding maps for web dataviz is to first look for TopoJSON or GeoJSON versions, then search among the richer pool of shapefiles, and, as a last resort, roll your own using a shapefile, or equivalent, editor. Depending on how much map visualization  you intend to do, there will probably be an off-the-shelf solution. For things like world maps or continental projections (e.g., the popular Albers USA), you can usually find a number of solutions with different degrees of accuracy.</p>
<p>For our Nobel map, we want a global mapping, at least showing all 58 Nobel Prize–winning nations, with labeled shapes for pretty much all of them. Luckily, D3 provides a number of example world maps, one at 50m grid resolution, the other a smaller 110m resolution map. The latter is fine for our fairly crude requirements.<sup><a data-type="noteref" href="ch19.xhtml#idm45607741779664" id="idm45607741779664-marker">4</a></sup></p>
</div></section>
<section data-pdf-bookmark="D3’s Mapping Data Formats" data-type="sect1"><div class="sect1" id="idm45607741778976">
<h1>D3’s Mapping Data Formats</h1>
<p>D3 makes use of two JSON-based geometric data formats, <a href="https://geojson.org">GeoJSON</a> and <a href="https://oreil.ly/709GD">TopoJSON</a>, an extension of GeoJSON devised by Mike Bostock that encodes topology. <a data-primary="TopoJSON" data-type="indexterm" id="idm45607741775824"/><a data-primary="GeoJSON" data-type="indexterm" id="idm45607741775120"/><a data-primary="JSON" data-secondary="JSON-based geometric data formats" data-type="indexterm" id="idm45607741774448"/><a data-primary="mapping with D3" data-secondary="mapping data formats" data-type="indexterm" id="ix_mapD3fmt"/><a data-primary="D3 library" data-secondary="mapping with" data-tertiary="mapping data formats" data-type="indexterm" id="ix_D3mapfmt"/>GeoJSON is more intuitive to read, but TopoJSON is far more efficient in most cases. Typically, maps are converted to TopoJSON for web delivery, where size is an important consideration. The TopoJSON is then converted to GeoJSON via D3 on the browser, to simplify SVG path creation, feature optimization, and so on.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>There is a nice summation of the differences between TopoJSON and GeoJSON on <a href="https://oreil.ly/DvcaG">Stack Overflow</a>.</p>
</div>
<p>Let’s have a look at the two formats now. Understanding their basic structure is important and a little effort there will pay off, especially as your mapping endeavors become more ambitious.</p>
<section data-pdf-bookmark="GeoJSON" data-type="sect2"><div class="sect2" id="idm45607741768256">
<h2>GeoJSON</h2>
<p>GeoJSON files contain one <code>type</code> object, one of Point, MultiPoint, LineString, MultiLineString, Polygon, MultiPolygon, GeometryCollection, Feature, or FeatureCollection. <a data-primary="mapping with D3" data-secondary="mapping data formats" data-tertiary="GeoJSON" data-type="indexterm" id="idm45607741765952"/><a data-primary="GeoJSON" data-secondary="about" data-type="indexterm" id="idm45607741764704"/>The case of the type member values must be <a href="https://oreil.ly/wS4q9">CamelCase</a>, as shown here. They may also contain a <code>crs</code> member, specifying a particular coordinate reference system.<a data-primary="coordinate reference system (CRS)" data-type="indexterm" id="idm45607741762432"/><a data-primary="crs (coordinate reference system) member, GeoJSON type" data-type="indexterm" id="idm45607741761712"/><a data-primary="CamelCase in variable names" data-type="indexterm" id="idm45607741760944"/><a data-primary="type object (GeoJSON)" data-type="indexterm" id="idm45607741760256"/></p>
<p>FeatureCollections are the largest GeoJSON container, and maps with more than one region are usually specified with these. FeatureCollections contain a <code>features</code> array, each element of which is a GeoJSON object of a type listed in the previous paragraph.<a data-primary="FeatureCollections (GeoJSON)" data-type="indexterm" id="idm45607741758800"/></p>
<p><a data-type="xref" href="#d3maps_geojson">Example 19-1</a> shows a typical FeatureCollection containing an array of country maps, the boundaries of which are specified by Polygons.</p>
<div data-type="example" id="d3maps_geojson">
<h5><span class="label">Example 19-1. </span>The GeoJSON mapping data format</h5>
<pre data-code-language="js" data-type="programlisting"><code class="p">{</code><code>
  </code><code class="s2">"type"</code><code class="o">:</code><code> </code><code class="s2">"FeatureCollection"</code><code class="p">,</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO1-1" id="co_mapping_with_d3_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code class="s2">"features"</code><code class="o">:</code><code> </code><code class="p">[</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO1-2" id="co_mapping_with_d3_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="p">{</code><code>
      </code><code class="s2">"type"</code><code class="o">:</code><code> </code><code class="s2">"Feature"</code><code class="p">,</code><code>
      </code><code class="s2">"id"</code><code class="o">:</code><code> </code><code class="s2">"AFG"</code><code class="p">,</code><code>
      </code><code class="s2">"properties"</code><code class="o">:</code><code> </code><code class="p">{</code><code>
        </code><code class="s2">"name"</code><code class="o">:</code><code> </code><code class="s2">"Afghanistan"</code><code>
      </code><code class="p">}</code><code class="p">,</code><code>
      </code><code class="s2">"geometry"</code><code class="o">:</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO1-3" id="co_mapping_with_d3_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
        </code><code class="s2">"type"</code><code class="o">:</code><code> </code><code class="s2">"Polygon"</code><code class="p">,</code><code>
        </code><code class="s2">"coordinates"</code><code class="o">:</code><code> </code><code class="p">[</code><code>
          </code><code class="p">[</code><code>
            </code><code class="p">[</code><code>
              </code><code class="mf">61.210817</code><code class="p">,</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO1-4" id="co_mapping_with_d3_CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
              </code><code class="mf">35.650072</code><code>
            </code><code class="p">]</code><code class="p">,</code><code>
            </code><code class="p">[</code><code>
              </code><code class="mf">62.230651</code><code class="p">,</code><code>
              </code><code class="mf">35.270664</code><code>
            </code><code class="p">]</code><code class="p">,</code><code>
            </code><code class="p">...</code><code>
          </code><code class="p">]</code><code>
        </code><code class="p">]</code><code>
      </code><code class="p">}</code><code>
    </code><code class="p">}</code><code class="p">,</code><code>
    </code><code class="p">...</code><code>
    </code><code class="p">{</code><code>
      </code><code class="s2">"type"</code><code class="o">:</code><code> </code><code class="s2">"Feature"</code><code class="p">,</code><code>
      </code><code class="s2">"id"</code><code class="o">:</code><code> </code><code class="s2">"ZWE"</code><code class="p">,</code><code>
      </code><code class="s2">"properties"</code><code class="o">:</code><code> </code><code class="p">{</code><code>
        </code><code class="s2">"name"</code><code class="o">:</code><code> </code><code class="s2">"Zimbabwe"</code><code>
      </code><code class="p">}</code><code class="p">,</code><code>
      </code><code class="s2">"geometry"</code><code class="o">:</code><code> </code><code class="p">{</code><code>
        </code><code class="s2">"type"</code><code class="o">:</code><code> </code><code class="s2">"Polygon"</code><code class="p">,</code><code>
        </code><code class="s2">"coordinates"</code><code class="o">:</code><code> </code><code class="p">[</code><code>
          </code><code class="p">[</code><code>
            </code><code class="p">[</code><code class="p">...</code><code class="p">]</code><code> </code><code class="p">]</code><code> </code><code class="p">]</code><code>
      </code><code class="p">}</code><code>
    </code><code class="p">}</code><code>
  </code><code class="p">]</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO1-1" id="callout_mapping_with_d3_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Each GeoJSON file contains a single object with a type and containing…​</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO1-2" id="callout_mapping_with_d3_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>…​an  array of features—​in this case, country objects…​</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO1-3" id="callout_mapping_with_d3_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>…​with coordinate-based, polygonal geometry.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO1-4" id="callout_mapping_with_d3_CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Note that the geographic coordinates are given in [longitude, latitude] pairs, the reverse of conventional geographic positioning. This is because GeoJSON uses an [X,Y] coordinate scheme.</p></dd>
</dl></div>
<p>Although GeoJSON is more succinct than shapefiles and in the preferred  JSON format, there is a lot of redundancy in the encoding of maps. For example, shared boundaries are specified twice and the floating-point coordinate format is fairly inflexible and, for many jobs, too precise. The TopoJSON format was designed to address these issues and produce a far more efficient way of delivering maps to the browser.</p>
</div></section>
<section data-pdf-bookmark="TopoJSON" data-type="sect2"><div class="sect2" id="idm45607741628672">
<h2>TopoJSON</h2>
<p>Developed by Mike Bostock, TopoJSON is <a data-primary="TopoJSON" data-secondary="about" data-type="indexterm" id="ix_TopoJS"/><a data-primary="mapping with D3" data-secondary="mapping data formats" data-tertiary="TopoJSON" data-type="indexterm" id="ix_mapD3fmtTJ"/>an extension to GeoJSON that encodes topology, stitching geometries together from a shared pool of line segments called arcs. Because they reuse these arcs, TopoJSON files are typically 80% smaller than their GeoJSON equivalents! In addition, taking a topological approach to map representation enables a number of techniques that use topology. One of these is topology-preserving shape simplification,<sup><a data-type="noteref" href="ch19.xhtml#idm45607741574800" id="idm45607741574800-marker">5</a></sup> which can eliminate 95% of map points while retaining sufficient detail. Cartograms and automatic map coloring are also facilitated. <a data-type="xref" href="#d3maps_topojson_basic">Example 19-2</a>  shows the structure of a TopoJSON file.</p>
<div data-type="example" id="d3maps_topojson_basic">
<h5><span class="label">Example 19-2. </span>Structure of our TopoJSON world map</h5>
<pre data-code-language="js" data-type="programlisting"><code class="p">{</code><code>
   </code><code class="s2">"type"</code><code class="o">:</code><code> </code><code class="s2">"Topology"</code><code class="p">,</code><code>   </code><a class="co" href="#callout_mapping_with_d3_CO2-1" id="co_mapping_with_d3_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
   </code><code class="s2">"objects"</code><code class="o">:</code><code class="p">{</code><code>           </code><a class="co" href="#callout_mapping_with_d3_CO2-2" id="co_mapping_with_d3_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
      </code><code class="s2">"countries"</code><code class="o">:</code><code class="p">{</code><code>
        </code><code class="s2">"type"</code><code class="o">:</code><code> </code><code class="s2">"GeometryCollection"</code><code class="p">,</code><code>
        </code><code class="s2">"geometries"</code><code class="o">:</code><code> </code><code class="p">[</code><code class="p">{</code><code>
        </code><code class="s2">"_id"</code><code class="o">:</code><code class="mi">24</code><code class="p">,</code><code> </code><code class="s2">"arcs"</code><code class="o">:</code><code class="p">[</code><code class="p">[</code><code class="mi">6</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">8</code><code class="p">]</code><code class="p">,</code><code class="p">[</code><code class="mi">10</code><code class="p">,</code><code class="mi">11</code><code class="p">,</code><code class="mi">12</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code> </code><code class="p">...</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO2-3" id="co_mapping_with_d3_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
      </code><code class="p">...</code><code class="p">}</code><code class="p">]</code><code class="p">}</code><code class="p">,</code><code>
      </code><code class="s2">"land"</code><code class="o">:</code><code class="p">{</code><code class="p">...</code><code class="p">}</code><code class="p">,</code><code>
   </code><code class="p">}</code><code class="p">,</code><code>
   </code><code class="s2">"arcs"</code><code class="o">:</code><code class="p">[</code><code class="p">[</code><code class="p">[</code><code class="mi">67002</code><code class="p">,</code><code class="mi">72360</code><code class="p">]</code><code class="p">,</code><code class="p">[</code><code class="mi">284</code><code class="p">,</code><code class="o">-</code><code class="mi">219</code><code class="p">]</code><code class="p">,</code><code class="p">[</code><code class="mi">209</code><code class="p">.</code><code class="p">.</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code> </code><code class="cm">/*&lt;-- arc*/</code><code> </code><code class="nx">number</code><code> </code><code class="mi">0</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO2-4" id="co_mapping_with_d3_CO2-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
           </code><code class="p">[</code><code class="p">[</code><code class="mi">70827</code><code class="p">,</code><code class="mi">73379</code><code class="p">]</code><code class="p">,</code><code class="p">[</code><code class="mi">50</code><code class="p">,</code><code class="o">-</code><code class="mi">165</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code> </code><code class="p">...</code><code>      </code><code class="cm">/*&lt;-- arc number 1*/</code><code>
        </code><code class="p">]</code><code>
   </code><code class="s2">"transform"</code><code class="o">:</code><code class="p">{</code><code>        </code><a class="co" href="#callout_mapping_with_d3_CO2-5" id="co_mapping_with_d3_CO2-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code>
      </code><code class="s2">"scale"</code><code class="o">:</code><code class="p">[</code><code>
         </code><code class="mf">0.003600036</code><code class="p">...</code><code class="p">,</code><code>
         </code><code class="mf">0.001736468</code><code class="p">...</code><code class="p">,</code><code>
       </code><code class="p">]</code><code class="p">,</code><code>
       </code><code class="s2">"translate"</code><code class="o">:</code><code class="p">[</code><code>
          </code><code class="o">-</code><code class="mi">180</code><code class="p">,</code><code>
          </code><code class="o">-</code><code class="mi">90</code><code>
       </code><code class="p">]</code><code>
   </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO2-1" id="callout_mapping_with_d3_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>TopoJSON objects have a <code>Topology</code> type and must contain an <code>objects</code> object and an array of <code>arcs</code>.<a data-primary="objects object (TopoJSON)" data-type="indexterm" id="idm45607741435552"/><a data-primary="arcs (TopoJSON)" data-type="indexterm" id="idm45607741434848"/></p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO2-2" id="callout_mapping_with_d3_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>In this case, the objects are <code>countries</code> and <code>land</code>, both being arc-defined <code>GeometryCollections</code>.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO2-3" id="callout_mapping_with_d3_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Each geometry (in this case defining a country shape) is defined by a number of arc paths, comprising continuous arcs referenced by their index in the <code>arcs</code> array <img alt="4" height="12" src="assets/4.png" width="12"/>.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO2-4" id="callout_mapping_with_d3_CO2-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>An array of component arcs used to construct the objects. The arcs are referenced by index.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO2-5" id="callout_mapping_with_d3_CO2-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Numbers needed to quantize positions as integers rather than floats.</p></dd>
</dl></div>
<p>The smaller size of the TopoJSON format is obviously a big advantage if you have to fetch it to your web browser. Often only the GeoJSON format is available, so the ability to convert this to TopoJSON is a handy one. D3 provides a small command-line utility to do just this. Called <code>geo2topo</code>, it is part of the TopoJSON package and can be installed via <code>node</code>.<a data-primary="mapping with D3" data-secondary="mapping data formats" data-startref="ix_mapD3fmtTJ" data-tertiary="TopoJSON" data-type="indexterm" id="idm45607741359088"/><a data-primary="TopoJSON" data-secondary="about" data-startref="ix_TopoJS" data-type="indexterm" id="idm45607741357536"/></p>
</div></section>
<section data-pdf-bookmark="Converting Maps to TopoJSON" data-type="sect2"><div class="sect2" id="idm45607741356064">
<h2>Converting Maps to TopoJSON</h2>
<p>You can install TopoJSON via the <code>node</code> repositories (see <a data-type="xref" href="ch01.xhtml#chapter_install">Chapter 1</a>), using the <code>-g</code> flag to make it a global<sup><a data-type="noteref" href="ch19.xhtml#idm45607741352656" id="idm45607741352656-marker">6</a></sup> install:<a data-primary="TopoJSON" data-secondary="converting maps to" data-type="indexterm" id="idm45607741351504"/><a data-primary="mapping with D3" data-secondary="mapping data formats" data-tertiary="converting maps to TopoJSON" data-type="indexterm" id="idm45607741350528"/></p>
<pre data-code-language="bash" data-type="programlisting">$ npm install -g topojson</pre>
<p>With <code>topojson</code> installed, converting an existing GeoJSON into TopoJSON is as easy as can be.<a data-primary="GeoJSON" data-secondary="converting maps to TopoJSON" data-type="indexterm" id="idm45607741340080"/><a data-primary="geo2topo command-line utility" data-type="indexterm" id="idm45607741346560"/> Here we call <code>geo2topo</code> from the command line on a GeoJSON <em>geo_input.json</em> file, specifying an output file <em>topo_output.json</em>:</p>
<pre data-code-language="bash" data-type="programlisting">$ geo2topo -o topo_output.json geo_input.json</pre>
<p>Alternatively, you can pipe the result to a file:</p>
<pre data-code-language="bash" data-type="programlisting">$ geo2topo geo_input.json &gt; topo_output.json</pre>
<p><code>geo2topo</code> has a number of useful options, such as quantization, which allows you to specify your map’s precision. Playing around with this option can result in a much smaller file with little perceptible reduction in quality. You can see the full spec on the <a href="https://oreil.ly/mp0RN">geo2topo command-line reference</a>. If you want to convert your map files programmatically, there is a handy Python library for the job, <em>topojson.py</em>. You can find it on <a href="https://oreil.ly/8t7Ko">GitHub</a>.</p>
<p>Now that we’ve got our map data in a light, efficient, web-optimized format, let’s see how we use JavaScript to turn it into interactive web maps.<a data-primary="D3 library" data-secondary="mapping with" data-startref="ix_D3mapfmt" data-tertiary="mapping data formats" data-type="indexterm" id="idm45607741307792"/><a data-primary="mapping with D3" data-secondary="mapping data formats" data-startref="ix_mapD3fmt" data-type="indexterm" id="idm45607741344096"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="D3 Geo, Projections, and Paths" data-type="sect1"><div class="sect1" id="idm45607741342752">
<h1>D3 Geo, Projections, and Paths</h1>
<p>D3 has a client-side <em>topojson</em> library, dedicated to dealing with <span class="keep-together">TopoJSON</span> data. <a data-primary="D3 library" data-secondary="mapping with" data-tertiary="geo library, projections and paths" data-type="indexterm" id="ix_D3mapgeo"/>This converts the optimized, arc-based TopoJSON to the coordinate-based GeoJSON, ready to be manipulated by D3’s <code>projection</code>s and <code>paths</code>, objects in the <em>d3.geo</em> library.<a data-primary="GeoJSON" data-secondary="conversion of TopoJSON maps to" data-type="indexterm" id="idm45607741286688"/><a data-primary="topojson client-side library (D3)" data-type="indexterm" id="idm45607741285712"/><a data-primary="mapping with D3" data-secondary="d3.geo library, projections and paths" data-type="indexterm" id="ix_mapD3geo"/></p>
<p><a data-type="xref" href="#d3maps_topojsoncode">Example 19-3</a> shows the process of extracting the GeoJSON features needed by our Nobel map from the TopoJSON <em>world-100m.json</em> map. This provides us with the coordinate-based polygons representing our countries and their borders.</p>
<p>In order to extract the GeoJSON features we require from the <span class="keep-together">TopoJSON</span> <code>world</code> object just delivered to the browser, we use <em>topojson</em>’s <code>feature</code> and <code>mesh</code> methods. <code>feature</code> returns the GeoJSON Feature or FeatureCollection for the specified object and <code>mesh</code> the GeoJSON MutliLineString geometry object representing the mesh for the specified object.<a data-primary="feature method (topojson)" data-type="indexterm" id="idm45607741266320"/><a data-primary="mesh method (topojson)" data-type="indexterm" id="idm45607741265648"/></p>
<p>The <code>feature</code> and <code>mesh</code> methods take as their first argument the <span class="keep-together">TopoJSON</span> object and as their second a reference to the feature we want to extract (<code>land</code> and <code>countries</code> in <a data-type="xref" href="#d3maps_topojsoncode">Example 19-3</a>). <a data-primary="FeatureCollections (GeoJSON)" data-type="indexterm" id="idm45607741260896"/>In our world map, <code>countries</code> is a FeatureCollection with a <code>features</code> array of countries (<a data-type="xref" href="#d3maps_topojsoncode">Example 19-3</a>, <img alt="2" height="12" src="assets/2.png" width="12"/>).</p>
<p>The <code>mesh</code> method has a third argument, which specifies a filter function, taking as arguments the two geometry objects (<code>a</code> and <code>b</code>) sharing the mesh arc. If the arc is unshared, then <code>a</code> and <code>b</code> are the same, allowing us to filter out external borders in our world map (<a data-type="xref" href="#d3maps_topojsoncode">Example 19-3</a>, <img alt="3" height="12" src="assets/3.png" width="12"/>).</p>
<div data-type="example" id="d3maps_topojsoncode">
<h5><span class="label">Example 19-3. </span>Extracting our TopoJSON features</h5>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// nbviz_main.mjs
</code><code class="kr">import</code><code> </code><code class="p">{</code><code> </code><code class="nx">initMap</code><code> </code><code class="p">}</code><code> </code><code class="nx">from</code><code> </code><code class="s1">'./nbviz_map.mjs'</code><code>

</code><code class="nb">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="p">[</code><code>
   </code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s1">'static/data/world-110m.json'</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO3-1" id="co_mapping_with_d3_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
   </code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s1">'static/data/world-country-names-nobel.csv'</code><code class="p">)</code><code class="p">,</code><code>
   </code><code class="c1">// ...
</code><code> </code><code class="p">]</code><code class="p">)</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">ready</code><code class="p">)</code><code>

</code><code class="kd">function</code><code> </code><code class="nx">ready</code><code class="p">(</code><code class="p">[</code><code class="nx">worldMap</code><code class="p">,</code><code> </code><code class="nx">countryNames</code><code class="p">,</code><code> </code><code class="nx">countryData</code><code class="p">,</code><code> </code><code class="nx">winnersData</code><code class="p">]</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="c1">// ...
</code><code>    </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">initMap</code><code class="p">(</code><code class="nx">worldMap</code><code class="p">,</code><code> </code><code class="nx">countryNames</code><code class="p">)</code><code>
</code><code class="p">}</code><code>
</code><code class="c1">// nbviz_map.mjs
</code><code class="kr">export</code><code> </code><code class="kd">let</code><code> </code><code class="nx">initMap</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">world</code><code class="p">,</code><code> </code><code class="nx">names</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="c1">// EXTRACT OUR REQUIRED FEATURES FROM THE TOPOJSON
</code><code>    </code><code class="kd">let</code><code> </code><code class="nx">land</code><code> </code><code class="o">=</code><code> </code><code class="nx">topojson</code><code class="p">.</code><code class="nx">feature</code><code class="p">(</code><code class="nx">world</code><code class="p">,</code><code> </code><code class="nx">world</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">land</code><code class="p">)</code><code class="p">,</code><code>
        </code><code class="nx">countries</code><code> </code><code class="o">=</code><code> </code><code class="nx">topojson</code><code class="p">.</code><code class="nx">feature</code><code class="p">(</code><code class="nx">world</code><code class="p">,</code><code> </code><code class="nx">world</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">countries</code><code class="p">)</code><code>
                      </code><code class="p">.</code><code class="nx">features</code><code class="p">,</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO3-2" id="co_mapping_with_d3_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
        </code><code class="nx">borders</code><code> </code><code class="o">=</code><code> </code><code class="nx">topojson</code><code class="p">.</code><code class="nx">mesh</code><code class="p">(</code><code class="nx">world</code><code class="p">,</code><code> </code><code class="nx">world</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">countries</code><code class="p">,</code><code>
                    </code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code><code> </code><code class="nx">b</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><code class="k">return</code><code> </code><code class="nx">a</code><code> </code><code class="o">!==</code><code> </code><code class="nx">b</code><code class="p">;</code><code> </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO3-3" id="co_mapping_with_d3_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
    </code><code class="c1">// ...
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO3-1" id="callout_mapping_with_d3_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Load the map data using D3’s helper functions and send on to a <code>ready</code> function to initiate the map chart.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO3-2" id="callout_mapping_with_d3_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Uses <code>topojson</code> to extract our desired features from the TopoJSON data, delivering them in the GeoJSON format.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO3-3" id="callout_mapping_with_d3_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Filters for only internal borders, shared between countries. If an
arc is only used by one geometry (in this case, a country), then a
and b are identical.</p></dd>
</dl></div>
<p>Map presentation in D3 generally follows a standard pattern. We first create a D3 <code>projection</code>, using one of D3’s many and varied alternatives. We then create a <code>path</code> using this <code>projection</code>. This <code>path</code> is then used to convert the features and meshes extracted from our TopoJSON object into the SVG paths displayed in the browser window.  Let’s now look at the rich subject of D3 <code>projection</code>s.</p>
<section data-pdf-bookmark="Projections" data-type="sect2"><div class="sect2" id="sect_projections">
<h2>Projections</h2>
<p>Probably the chief challenge for maps, since the time it was appreciated that the Earth is spheroidal, is that of representing a three-dimensional globe, or significant parts of it, in a two-dimensional form.<a data-primary="projections (map)" data-type="indexterm" id="ix_projm"/><a data-primary="mapping with D3" data-secondary="d3.geo library, projections and paths" data-tertiary="projections" data-type="indexterm" id="ix_mapD3geoproj"/> In 1569, the Flemish cartographer Gerardus Mercator famously resolved this by extending lines from the Earth’s center to significant boundary coordinates and then projecting them onto a surrounding cylinder. <a data-primary="rhumb lines" data-type="indexterm" id="idm45607741033024"/>This had the useful property of representing lines of constant course, known as <em>rhumb lines</em>, as straight line segments, a very useful feature for the seafaring navigators intended to use the map. Unfortunately, the projection process distorts distances and size, magnifying the scale as one moves from the equator to the pole. As a result of this, the huge African continent appears not much bigger than Greenland when in reality it is around 14 times the size.</p>
<p>All projections are, like Mercator’s, a compromise, and what’s great about D3 is that the rich array of choices means one can balance these compromises to find the right projection for the job.<sup><a data-type="noteref" href="ch19.xhtml#idm45607741031424" id="idm45607741031424-marker">7</a></sup> <a data-type="xref" href="#d3maps_projections">Figure 19-2</a> shows some alternative <code>projection</code>s for our Nobel map, including the equirectangular one chosen for the final visualization. <a data-primary="equirectangular projection" data-type="indexterm" id="idm45607741028240"/>The constraint was to show all Nobel Prize–winning countries within the rectangular window and to try to maximize the space available, particularly in Europe where there are many countries that are small geographically but have a relatively large prize haul.</p>
<p>To create a D3 <code>projection</code>, just use one of the applicable <em>d3.geo</em> methods:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code> <code class="nx">projection</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geoEquirectangular</code><code class="p">()</code>
<code class="c1">// ...</code></pre>
<p>D3 <code>projection</code>s have a number of useful methods. It’s common to use the <code>translate</code> method to translate the map by half the width and height of the container, overriding the default of [480, 250]. <a data-primary="translate method (D3 projections)" data-type="indexterm" id="idm45607741012016"/><a data-primary="adaptive resampling (in projections)" data-type="indexterm" id="idm45607741011408"/>You can also set the precision, which affects the degree of <em>adaptive resampling</em> used in the <code>projection</code>. Adaptive resampling is a clever <span class="keep-together">technique</span> to increase the accuracy of projected lines while still performing efficiently.<sup><a data-type="noteref" href="ch19.xhtml#idm45607741009120" id="idm45607741009120-marker">8</a></sup> The scale of the map and its center’s longitude and latitude can be set by the <code>scale</code> and <code>center</code> methods.<a data-primary="scale method (D3 projections)" data-type="indexterm" id="idm45607741006208"/><a data-primary="center method (D3 projection)" data-type="indexterm" id="idm45607741005504"/></p>
<figure><div class="figure" id="d3maps_projections">
<img alt="dpj2 1902" height="701" src="assets/dpj2_1902.png" width="1125"/>
<h6><span class="label">Figure 19-2. </span>Some alternative mapping projections for the Nobel map</h6>
</div></figure>
<p>Putting the <code>projection</code> methods together, the following code is that used by our Nobel-viz world equirectangular map. Note that it’s hand-tweaked to maximize the space given to Nobel Prize–winning countries. The two poles are truncated, there being no winners in either the Arctic or Antarctic (note that equirectangular maps assume a width/height ratio of 2):</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">projection</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">geoEquirectangular</code><code class="p">(</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="mi">193</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="nx">height</code><code class="o">/</code><code class="mi">480</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO4-1" id="co_mapping_with_d3_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">center</code><code class="p">(</code><code class="p">[</code><code class="mi">15</code><code class="p">,</code><code class="mi">15</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO4-2" id="co_mapping_with_d3_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">translate</code><code class="p">(</code><code class="p">[</code><code class="nx">width</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="nx">height</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">]</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">precision</code><code class="p">(</code><code class="p">.</code><code class="mi">1</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO4-1" id="callout_mapping_with_d3_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Enlarged slightly; the default height is 480 and scale 153.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO4-2" id="callout_mapping_with_d3_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Centered at 15 degrees east, 15 degrees north.</p></dd>
</dl>
<p>With our equirectangular <code>projection</code> defined, let’s see how you use it to create a <code>path</code>, which will in turn be used to create the SVG maps.<a data-primary="projections (map)" data-startref="ix_projm" data-type="indexterm" id="idm45607740928384"/><a data-primary="mapping with D3" data-secondary="d3.geo library, projections and paths" data-startref="ix_mapD3geoproj" data-tertiary="projections" data-type="indexterm" id="idm45607740927408"/></p>
</div></section>
<section class="pagebreak-before less_space" data-pdf-bookmark="Paths" data-type="sect2"><div class="sect2" id="idm45607741089424">
<h2>Paths</h2>
<p>Once you’ve settled on an appropriate <code>projection</code> for your map, you use it to create a D3 geographic <code>path</code> generator, which is a specialized variant of the SVG <code>path</code> generator (<code>d3.svg.path</code>). <a data-primary="mapping with D3" data-secondary="d3.geo library, projections and paths" data-tertiary="paths" data-type="indexterm" id="idm45607740886048"/><a data-primary="SVG (Scalable Vector Graphics)" data-secondary="path generator in D3" data-type="indexterm" id="idm45607740884800"/><a data-primary="paths (geographic, in D3)" data-type="indexterm" id="idm45607740883888"/>This <code>path</code> takes any GeoJSON feature or geometry object, such as a FeatureCollection, Polygon, or Point, and returns the SVG path data string for the <code>d</code> element. For example, with our map <code>borders</code> object, the geographic border coordinates describing a <code>MultiLineString</code> are converted into path coordinates for SVG.<a data-primary="borders object" data-type="indexterm" id="idm45607740881344"/></p>
<p>Generally, we create our <code>path</code> and set its <code>projection</code> in one go:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">projection</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geoEquirectangular</code><code class="p">()</code>
<code class="c1">// ...</code>

<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geoPath</code><code class="p">()</code>
             <code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">);</code></pre>
<p>Typically, we <a data-primary="projections (map)" data-secondary="setting projection for a path" data-type="indexterm" id="idm45607740875616"/>use the <code>path</code> as a function to generate the <code>d</code> attribute to an SVG path, using GeoJSON data bound using the <code>datum</code> method (used to bind a single object—not array—and shorthand for <code>data([object])</code>). So to use the borders data we just extracted using <code>topojson.mesh</code> to draw our country borders, we use the <span class="keep-together">following</span>:</p>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// BOUNDRY MARKS
</code><code class="nx">svg</code><code class="p">.</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code><code> </code><code class="s2">".graticule"</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO5-1" id="co_mapping_with_d3_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">borders</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"boundary"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code><code> </code><code class="nx">path</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO5-1" id="callout_mapping_with_d3_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We want to insert the borders SVG before (below) the map’s <code>graticule</code> (grid) overlay.</p></dd>
</dl>
<p><a data-type="xref" href="#d3maps_paths">Figure 19-3</a> shows output from the Chrome Console for the <span class="keep-together">TopoJSON</span> <code>borders</code> object, extracted from our world-map data, and the resultant path generated by our <em>d3.geo</em> <code>path</code>, using the equirectangular <code>projection</code>.</p>
<p>The geo-path generator is the mainstay of D3 map presentations. I recommend playing around with different <code>projection</code>s with simple geometries to get a feel for things, investigating the astonishing number of examples found at <a href="https://bl.ocks.org/mbostock"><em>bl.ocks.org</em></a> and the docs on <a href="https://oreil.ly/2qgyf">D3’s GitHub page</a>,
and checking out this <a href="https://oreil.ly/NansT">great little demo</a>.</p>
<figure><div class="figure" id="d3maps_paths">
<img alt="dpj2 1903" height="702" src="assets/dpj2_1903.png" width="1440"/>
<h6><span class="label">Figure 19-3. </span>Path generator, from geometry to SVG path</h6>
</div></figure>
<p>Now let’s look at one of the useful <em>d3.geo</em> components you’ll use in your maps, the <code>graticule</code> (or map grid).<a data-primary="graticules (d3.geo)" data-type="indexterm" id="idm45607740758512"/></p>
</div></section>
<section data-pdf-bookmark="graticules" data-type="sect2"><div class="sect2" id="idm45607740925264">
<h2>graticules</h2>
<p>A useful component of <em>d3.geo</em> and one used <a data-primary="mapping with D3" data-secondary="d3.geo library, projections and paths" data-tertiary="graticules" data-type="indexterm" id="idm45607740755696"/>in our Nobel map is the <code>graticule</code>, one of the geo shape generators.<sup><a data-type="noteref" href="ch19.xhtml#idm45607740753936" id="idm45607740753936-marker">9</a></sup> This creates a global mesh of meridians (lines of longitude) and parallels (lines of latitude), spaced by default at 10 degrees. When our <code>path</code> is applied to this <code>graticule</code>, it generates a suitably projected grid, as shown back in <a data-type="xref" href="#d3maps_target">Figure 19-1</a>.</p>
<p><a data-type="xref" href="#d3maps_graticule">Example 19-4</a> shows how to add a <code>graticule</code> to your map. Note that if you want your grid to overlay your map paths, then its SVG path should come after the map paths in the DOM tree. As you’ll see, you can use D3’s <code>insert</code> method to enforce this order.</p>
<div data-type="example" id="d3maps_graticule">
<h5><span class="label">Example 19-4. </span>Creating a <code>graticule</code></h5>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code><code> </code><code class="nx">graticule</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">graticule</code><code class="p">(</code><code class="p">)</code><code>
                  </code><code class="p">.</code><code class="nx">step</code><code class="p">(</code><code class="p">[</code><code class="mi">20</code><code class="p">,</code><code> </code><code class="mi">20</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO6-1" id="co_mapping_with_d3_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>

</code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">graticule</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO6-2" id="co_mapping_with_d3_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"graticule"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code><code> </code><code class="nx">path</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO6-3" id="co_mapping_with_d3_CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO6-1" id="callout_mapping_with_d3_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Create a <code>graticule</code>, setting the grid spacing to 20 degrees.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO6-2" id="callout_mapping_with_d3_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Note the <code>datum</code> shorthand for data(<code>[graticule]</code>).</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO6-3" id="callout_mapping_with_d3_CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Use the <code>path</code> generator to receive the <code>graticule</code> data and return a grid path.</p></dd>
</dl></div>
<p>Now that we have our grid overlay and the ability to turn our map file into SVG paths with the required <code>projection</code>, let’s put the elements together.<a data-primary="mapping with D3" data-secondary="d3.geo library, projections and paths" data-startref="ix_mapD3geo" data-type="indexterm" id="idm45607740650384"/><a data-primary="D3 library" data-secondary="mapping with" data-startref="ix_D3mapgeo" data-tertiary="geo library, projections and paths" data-type="indexterm" id="idm45607740649248"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Putting the Elements Together" data-type="sect1"><div class="sect1" id="idm45607741338000">
<h1>Putting the Elements Together</h1>
<p>Using the <code>projection</code>, <code>path</code>, and <code>graticule</code> components discussed, we’ll now create the basic map.<a data-primary="mapping with D3" data-secondary="putting the elements together" data-type="indexterm" id="ix_mapD3together"/><a data-primary="D3 library" data-secondary="mapping with" data-tertiary="putting the elements together" data-type="indexterm" id="ix_D3mapmap"/> This map is intended to respond to user events, highlighting those countries represented by the selected winners, and reflecting the number of winners with a filled red circle at the countries’ centers. We’ll deal with this interactive update separately.</p>
<p><a data-type="xref" href="#d3maps_basic_map_code">Example 19-5</a> shows the code required to build a basic global map. It follows what should now be a familiar pattern, getting the <code>mapContainer</code> from its <code>div</code> container (ID <code>nobel-map</code>), appending an <code>&lt;svg&gt;</code> tag to it, and then proceeding to add SVG elements, which in this case are D3-generated map paths.</p>
<p>Our map has fixed components (e.g., the choice of <code>projection</code> and <code>path</code>) that are not dependent on any data change and are defined outside the initializing <code>nbviz.initMap</code> method. <code>nbviz.initMap</code> is called when the visualization is initialized with data from the server. It receives the TopoJSON <code>world</code> object and uses it to build the basic map with the <code>path</code> object. <a data-type="xref" href="#d3maps_basic_map">Figure 19-4</a> shows the result.</p>
<div data-type="example" id="d3maps_basic_map_code">
<h5><span class="label">Example 19-5. </span>Building the map basics</h5>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// DIMENSIONS AND SVG
</code><code class="kd">let</code><code> </code><code class="nx">mapContainer</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-map'</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="kd">let</code><code> </code><code class="nx">boundingRect</code><code> </code><code class="o">=</code><code> </code><code class="nx">mapContainer</code><code class="p">.</code><code class="nx">node</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">getBoundingClientRect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="kd">let</code><code> </code><code class="nx">width</code><code> </code><code class="o">=</code><code> </code><code class="nx">boundingRect</code><code class="p">.</code><code class="nx">width</code><code>
    </code><code class="nx">height</code><code> </code><code class="o">=</code><code> </code><code class="nx">boundingRect</code><code class="p">.</code><code class="nx">height</code><code class="p">;</code><code>
</code><code class="kd">let</code><code> </code><code class="nx">svg</code><code> </code><code class="o">=</code><code> </code><code class="nx">mapContainer</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'svg'</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="c1">// OUR CHOSEN PROJECTION
</code><code class="kd">let</code><code> </code><code class="nx">projection</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">equirectangular</code><code class="p">(</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="mi">193</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="nx">height</code><code class="o">/</code><code class="mi">480</code><code class="p">)</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">center</code><code class="p">(</code><code class="p">[</code><code class="mi">15</code><code class="p">,</code><code class="mi">15</code><code class="p">]</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">translate</code><code class="p">(</code><code class="p">[</code><code class="nx">width</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="nx">height</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">]</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">precision</code><code class="p">(</code><code class="p">.</code><code class="mi">1</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="c1">// CREATE PATH WITH PROJECTION
</code><code class="kd">let</code><code> </code><code class="nx">path</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">geoPath</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="c1">// ADD GRATICULE
</code><code class="kd">var</code><code> </code><code class="nx">graticule</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">geoGraticule</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">step</code><code class="p">(</code><code class="p">[</code><code class="mi">20</code><code class="p">,</code><code> </code><code class="mi">20</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">graticule</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"graticule"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code><code> </code><code class="nx">path</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="c1">// A RADIUS SCALE FOR OUR CENTROID INDICATORS
</code><code class="kd">var</code><code> </code><code class="nx">radiusScale</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">scaleSqrt</code><code class="p">(</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="p">[</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">MIN_CENTROID_RADIUS</code><code class="p">,</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">MAX_CENTROID_RADIUS</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="c1">// OBJECT TO MAP COUNTRY NAME TO GEOJSON OBJECT
</code><code class="kd">var</code><code> </code><code class="nx">cnameToCountry</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code class="p">;</code><code>
</code><code class="c1">// INITIAL MAP CREATION, USING DOWNLOADED MAP DATA
</code><code class="kr">export</code><code> </code><code class="kd">let</code><code> </code><code class="nx">initMap</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">world</code><code class="p">,</code><code> </code><code class="nx">names</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO7-1" id="co_mapping_with_d3_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="c1">// EXTRACT OUR REQUIRED FEATURES FROM THE TOPOJSON
</code><code>    </code><code class="kd">var</code><code> </code><code class="nx">land</code><code> </code><code class="o">=</code><code> </code><code class="nx">topojson</code><code class="p">.</code><code class="nx">feature</code><code class="p">(</code><code class="nx">world</code><code class="p">,</code><code> </code><code class="nx">world</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">land</code><code class="p">)</code><code class="p">,</code><code>
        </code><code class="nx">countries</code><code> </code><code class="o">=</code><code> </code><code class="nx">topojson</code><code class="p">.</code><code class="nx">feature</code><code class="p">(</code><code class="nx">world</code><code class="p">,</code><code> </code><code class="nx">world</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">countries</code><code class="p">)</code><code>
                      </code><code class="p">.</code><code class="nx">features</code><code class="p">,</code><code>
        </code><code class="nx">borders</code><code> </code><code class="o">=</code><code> </code><code class="nx">topojson</code><code class="p">.</code><code class="nx">mesh</code><code class="p">(</code><code class="nx">world</code><code class="p">,</code><code> </code><code class="nx">world</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">countries</code><code class="p">,</code><code>
                    </code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code><code> </code><code class="nx">b</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><code class="k">return</code><code> </code><code class="nx">a</code><code> </code><code class="o">!==</code><code> </code><code class="nx">b</code><code class="p">;</code><code> </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="c1">// CREATE OBJECT MAPPING COUNTRY NAMES TO GEOJSON SHAPES
</code><code>    </code><code class="kd">var</code><code> </code><code class="nx">idToCountry</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code class="p">;</code><code>
    </code><code class="nx">countries</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">c</code><code class="p">)</code><code> </code><code class="p">{</code><code>
        </code><code class="nx">idToCountry</code><code class="p">[</code><code class="nx">c</code><code class="p">.</code><code class="nx">id</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nx">c</code><code class="p">;</code><code>
    </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>

    </code><code class="nx">names</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">n</code><code class="p">)</code><code> </code><code class="p">{</code><code>
        </code><code class="nx">cnameToCountry</code><code class="p">[</code><code class="nx">n</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nx">idToCountry</code><code class="p">[</code><code class="nx">n</code><code class="p">.</code><code class="nx">id</code><code class="p">]</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO7-2" id="co_mapping_with_d3_CO7-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="c1">// MAIN WORLD MAP
</code><code>    </code><code class="nx">svg</code><code class="p">.</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code><code> </code><code class="s2">".graticule"</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO7-3" id="co_mapping_with_d3_CO7-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
        </code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">land</code><code class="p">)</code><code>                 </code><a class="co" href="#callout_mapping_with_d3_CO7-4" id="co_mapping_with_d3_CO7-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"land"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code><code> </code><code class="nx">path</code><code class="p">)</code><code>
    </code><code class="p">;</code><code>
    </code><code class="c1">// COUNTRY PATHS
</code><code>    </code><code class="nx">svg</code><code class="p">.</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"g"</code><code class="p">,</code><code> </code><code class="s2">".graticule"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s1">'countries'</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="c1">// COUNTRIES VALUE-INDICATORS
</code><code>    </code><code class="nx">svg</code><code class="p">.</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"centroids"</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="c1">// BOUNDARY LINES
</code><code>    </code><code class="nx">svg</code><code class="p">.</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code><code> </code><code class="s2">".graticule"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">borders</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"boundary"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code><code> </code><code class="nx">path</code><code class="p">)</code><code class="p">;</code><code>

</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO7-1" id="callout_mapping_with_d3_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p><code>world</code> TopoJSON object with the country features with a <code>names</code> array connecting country names to country feature IDs (e.g., <code>{id:36, name: 'Australia'}</code>).</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO7-2" id="callout_mapping_with_d3_CO7-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Object that, if given country-name key, returns its respective GeoJSON geometry.<a data-primary="paths (geographic, in D3)" data-type="indexterm" id="idm45607740327168"/></p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO7-3" id="callout_mapping_with_d3_CO7-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Note that we insert this <code>path</code> before the <code>graticule</code> grid, keeping the grid overlay on top.<a data-primary="graticules (d3.geo)" data-type="indexterm" id="idm45607739631776"/></p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO7-4" id="callout_mapping_with_d3_CO7-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Uses <code>datum</code> to assign the whole <code>land</code> object to our <code>path</code>.</p></dd>
</dl></div>
<figure><div class="figure" id="d3maps_basic_map">
<img alt="dpj2 1904" height="349" src="assets/dpj2_1904.png" width="700"/>
<h6><span class="label">Figure 19-4. </span>The basic map</h6>
</div></figure>
<p>With our map shapes in place, we can use a little CSS to style <a data-type="xref" href="#d3maps_basic_map">Figure 19-4</a>, adding a light azure for the oceans and light gray for the land. <a data-primary="CSS" data-secondary="styling basic map in D3" data-type="indexterm" id="idm45607739624128"/>The <code>graticule</code> is a half-transparent dark gray and the country boundaries white:</p>
<pre data-code-language="css" data-type="programlisting"><code class="c">/* NOBEL-MAP STYLES */</code>
<code class="nf">#nobel-map</code> <code class="p">{</code>
    <code class="k">background</code><code class="o">:</code> <code class="nb">azure</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.graticule</code> <code class="p">{</code>
    <code class="k">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="k">stroke</code><code class="o">:</code> <code class="m">#777</code><code class="p">;</code>
    <code class="k">stroke-width</code><code class="o">:</code> <code class="m">.5px</code><code class="p">;</code>
    <code class="k">stroke-opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">5</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.land</code> <code class="p">{</code>
    <code class="k">fill</code><code class="o">:</code> <code class="m">#ddd</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.boundary</code> <code class="p">{</code>
    <code class="k">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="k">stroke</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
    <code class="k">stroke-width</code><code class="o">:</code> <code class="m">.5px</code><code class="p">;</code>
<code class="p">}</code></pre>
<p>With the SVG map assembled, let’s see how we use the winners dataset to draw the Nobel Prize–winning countries and the red indicator for number of wins.<a data-primary="D3 library" data-secondary="mapping with" data-startref="ix_D3mapmap" data-tertiary="putting the elements together" data-type="indexterm" id="idm45607740607200"/><a data-primary="mapping with D3" data-secondary="putting the elements together" data-startref="ix_mapD3together" data-type="indexterm" id="idm45607740093872"/></p>
</div></section>
<section data-pdf-bookmark="Updating the Map" data-type="sect1"><div class="sect1" id="idm45607740092464">
<h1>Updating the Map</h1>
<p>The first time our Nobel map gets updated is when the visualization is initialized. <a data-primary="updates" data-secondary="updating a map in D3" data-type="indexterm" id="ix_updmap"/><a data-primary="D3 library" data-secondary="mapping with" data-tertiary="updating the map" data-type="indexterm" id="ix_D3mapupd"/><a data-primary="mapping with D3" data-secondary="updating the map" data-type="indexterm" id="ix_mapD3upd"/>At this point the selected dataset is unfiltered, containing all the Nobel Prize winners. Subsequently, in response to filters applied by the user (e.g., all the Chemistry winners or those from France), the dataset will change and our map changes to reflect that.</p>
<p>So updating the map involves sending it a dataset of the Nobel Prize–winning countries with their current prize haul, dependent on the user filters applied.  To do this, we use an <code>updateMap</code> method:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code> <code class="nx">updateMap</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">countryData</code><code class="p">)</code> <code class="p">{</code> <code class="c1">//...</code>
                <code class="p">}</code></pre>
<p>The <code>countryData</code> array has this form:</p>
<pre data-code-language="js" data-type="programlisting"><code class="p">[</code><code>
  </code><code class="p">{</code><code>
   </code><code class="nx">code</code><code class="o">:</code><code> </code><code class="s2">"USA"</code><code class="p">,</code><code>
   </code><code class="nx">key</code><code class="o">:</code><code> </code><code class="s2">"United States"</code><code class="p">,</code><code>
   </code><code class="nx">population</code><code class="o">:</code><code> </code><code class="mi">319259000</code><code class="p">,</code><code>
   </code><code class="nx">value</code><code class="o">:</code><code> </code><code class="mi">336</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO8-1" id="co_mapping_with_d3_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code class="p">}</code><code class="p">,</code><code>
  </code><code class="c1">// ... 56 more countries
</code><code class="p">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO8-1" id="callout_mapping_with_d3_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The number of winners for the US in the currently selected dataset.</p></dd>
</dl>
<p>We want to convert this array before sending it to our D3 map.  The following code does this job, providing an array of country objects with properties <code>geo</code> (the country’s GeoJSON geometry), <code>name</code> (the country name), and <code>number</code> (the country’s number of Nobel Prize <span class="keep-together">winners</span>):</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">mapData</code><code> </code><code class="o">=</code><code> </code><code class="nx">countryData</code><code>
    </code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">0</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO9-1" id="co_mapping_with_d3_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
      </code><code class="k">return</code><code> </code><code class="p">{</code><code>
        </code><code class="nx">geo</code><code class="o">:</code><code> </code><code class="nx">cnameToCountry</code><code class="p">[</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">]</code><code class="p">,</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO9-2" id="co_mapping_with_d3_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
        </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">,</code><code>
        </code><code class="nx">number</code><code class="o">:</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code>
      </code><code class="p">}</code><code>
    </code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO9-1" id="callout_mapping_with_d3_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Filters out countries with no winners—​we only display winning countries on the map.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO9-2" id="callout_mapping_with_d3_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Uses the country’s key (its name in this case) to retrieve its GeoJSON feature.</p></dd>
</dl>
<p>We want to display a red circular indicator at the center of our winning countries, indicating the number of prizes won. The circles’ areas should be proportional to the number of prizes won (absolute or per capita), which means (by circle area = pi × radius-squared) their radius should be a function of the square root of that prize number. D3 provides a handy <code>sqrt</code> scale for just such a need, allowing you to set a domain (min and max prize number in this case) and a range (min and max indicator radius).</p>
<p>Let’s see a quick example of the <code>sqrt</code> scale in action.<a data-primary="scales (D3)" data-secondary="sqrt" data-type="indexterm" id="idm45607740313872"/><a data-primary="sqrt scale" data-type="indexterm" id="idm45607740312864"/> In the following code, we set a scale with a domain between 0 and 100 and a zero-based range with a maximum area of 25 (5 × 5). This means calling the scale with 50 (half the range) should give the square root of half the maximum area (12.5):</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">sc</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleSqrt</code><code class="p">().</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">100</code><code class="p">]).</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">5</code><code class="p">]);</code>
<code class="nx">sc</code><code class="p">(</code><code class="mi">50</code><code class="p">)</code> <code class="c1">// returns 3.5353..., the square root of 12.5</code></pre>
<p>To create our indicator radius scale, we create a <code>sqrt</code> scale using  the maximum and minimum radii specified in <em>nbviz_core.js</em> to set its range:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">radiusScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleSqrt</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">MIN_CENTROID_RADIUS</code><code class="p">,</code>
    <code class="nx">nbviz</code><code class="p">.</code><code class="nx">MAX_CENTROID_RADIUS</code><code class="p">]);</code></pre>
<p>In order to get the domain to our scales, we use this <code>mapData</code> to get the maximum number of winners per country and use that value as the domain’s upper value, with <code>0</code> for its lower:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">maxWinners</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">mapData</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code> <code class="o">=&gt;</code> <code class="nx">d</code><code class="p">.</code><code class="nx">number</code><code class="p">))</code>
<code class="c1">// DOMAIN OF VALUE-INDICATOR SCALE</code>
<code class="nx">radiusScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">maxWinners</code><code class="p">]);</code></pre>
<p>To add our country shapes to the existing map, we bind <code>mapData</code> to a selection on the <code>countries</code> group of class <code>country</code> and implement an update pattern (see <a data-type="xref" href="ch17.xhtml#d3bar_update">“Updating the DOM with Data”</a>) to first add any country shapes required by the <code>mapData</code>. <a data-primary="data binding in D3" data-secondary="binding mapData to a selection on countries  group of class country" data-type="indexterm" id="idm45607740566400"/>Instead of removing unbound country paths, we use the CSS <code>opacity</code> property to make the bound countries <a data-primary="opacity property (CSS)" data-type="indexterm" id="idm45607740564912"/>visible and the unbound invisible.<a data-primary="transitions" data-secondary="D3" data-tertiary="updating a map" data-type="indexterm" id="idm45607740564080"/> A two-second transition is used to make these countries fade in and out appropriately. <a data-type="xref" href="#d3maps_update_countries_code">Example 19-6</a> shows the update pattern.</p>
<div data-type="example" id="d3maps_update_countries_code">
<h5><span class="label">Example 19-6. </span>Updating the country shapes</h5>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">countries</code><code> </code><code class="o">=</code><code> </code><code class="nx">svg</code><code>
   </code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'.countries'</code><code class="p">)</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'.country'</code><code class="p">)</code><code>
   </code><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">mapData</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code><code>
</code><code class="c1">// Use a data-join to make selected countries visible
</code><code class="c1">// and fade them in over TRANS_DURATION milliseconds
</code><code> </code><code class="nx">countries</code><code>
   </code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code>
     </code><code class="p">(</code><code class="nx">enter</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
       </code><code class="k">return</code><code> </code><code class="nx">enter</code><code>
         </code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'path'</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO10-1" id="co_mapping_with_d3_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
		 </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'d'</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
		     </code><code class="k">return</code><code> </code><code class="nx">path</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">geo</code><code class="p">)</code><code>
         </code><code class="p">}</code><code class="p">)</code><code>
         </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'class'</code><code class="p">,</code><code> </code><code class="s1">'country'</code><code class="p">)</code><code>
         </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code><code>
         </code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'mouseenter'</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">event</code><code class="p">,</code><code> </code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO10-2" id="co_mapping_with_d3_CO10-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
           </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code><code> </code><code class="kc">true</code><code class="p">)</code><code>
         </code><code class="p">}</code><code class="p">)</code><code>
         </code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'mouseout'</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
           </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code><code> </code><code class="kc">false</code><code class="p">)</code><code>
         </code><code class="p">}</code><code class="p">)</code><code>
     </code><code class="p">}</code><code class="p">,</code><code>
     </code><code class="p">(</code><code class="nx">update</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">update</code><code class="p">,</code><code>
     </code><code class="p">(</code><code class="nx">exit</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO10-3" id="co_mapping_with_d3_CO10-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
       </code><code class="k">return</code><code> </code><code class="nx">exit</code><code>
         </code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'visible'</code><code class="p">,</code><code> </code><code class="kc">false</code><code class="p">)</code><code>
         </code><code class="p">.</code><code class="nx">transition</code><code class="p">(</code><code class="p">)</code><code>
         </code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">TRANS_DURATION</code><code class="p">)</code><code>
         </code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'opacity'</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">)</code><code>
     </code><code class="p">}</code><code>
   </code><code class="p">)</code><code>
   </code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'visible'</code><code class="p">,</code><code> </code><code class="kc">true</code><code class="p">)</code><code>
   </code><code class="p">.</code><code class="nx">transition</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO10-4" id="co_mapping_with_d3_CO10-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
   </code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">TRANS_DURATION</code><code class="p">)</code><code>
   </code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'opacity'</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO10-1" id="callout_mapping_with_d3_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Use the GeoJSON data to create country map shapes using our <code>path</code> object.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO10-2" id="callout_mapping_with_d3_CO10-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>UI placeholders, which set the SVG paths to class <em>active</em> on mouse-over. Note that we use the <code>function</code> keyword here as opposed to the usual arrow notation shorthand (<code>⇒</code>). This is because we wish to use D3 to access the DOM element (map region) entered by the mouse using the <code>this</code> keyword, which is not available with arrow functions.<a data-primary="arrow functions (JavaScript)" data-type="indexterm" id="idm45607739422064"/><a data-primary="this keyword (JavaScript)" data-type="indexterm" id="idm45607739421392"/></p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO10-3" id="callout_mapping_with_d3_CO10-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>A customized <code>exit</code> function that fades out (sets opacity to 0) the country shape over 2000 (<code>TRANS_DURATION</code>) milliseconds.<a data-primary="exit method (D3)" data-type="indexterm" id="idm45607739417664"/></p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO10-4" id="callout_mapping_with_d3_CO10-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Any new countries are faded in (opacity 1) over 2000 (<code>TRANS_DURATION</code>) ms.</p></dd>
</dl></div>
<p>Note that we add a CSS <code>country</code> class to freshly entered countries, setting their color to a light green. In addition to this, the mouse events are used to class the country <code>active</code> if the cursor is over it, highlighting it with a darker green. Here are the CSS classes:</p>
<pre data-code-language="css" data-type="programlisting"><code class="nc">.country</code><code class="p">{</code>
    <code class="k">fill</code><code class="o">:</code> <code class="nb">rgb</code><code class="p">(</code><code class="m">175</code><code class="o">,</code> <code class="m">195</code><code class="o">,</code> <code class="m">186</code><code class="p">);</code> <code class="c">/* light green */</code>
<code class="p">}</code>

<code class="nc">.country.active</code><code class="p">{</code>
    <code class="k">fill</code><code class="o">:</code> <code class="nb">rgb</code><code class="p">(</code><code class="m">155</code><code class="o">,</code> <code class="m">175</code><code class="o">,</code> <code class="m">166</code><code class="p">);</code> <code class="c">/* dark green */</code>
<code class="p">}</code></pre>
<p>The update pattern shown in <a data-type="xref" href="#d3maps_update_countries_code">Example 19-6</a> will smoothly transition from old to new datasets, produced in response to user-applied filters and passed to <code>updateMap</code>. All we need now is to add similarly responsive filled circular indicators, centered on the active countries and reflecting their current value, either an absolute or relative (per capita) measure of their Nobel Prize haul.<a data-primary="D3 library" data-secondary="mapping with" data-startref="ix_D3mapupd" data-tertiary="updating the map" data-type="indexterm" id="idm45607739308272"/><a data-primary="mapping with D3" data-secondary="updating the map" data-startref="ix_mapD3upd" data-type="indexterm" id="idm45607739306880"/></p>
</div></section>
<section data-pdf-bookmark="Adding Value Indicators" data-type="sect1"><div class="sect1" id="idm45607740091552">
<h1>Adding Value Indicators</h1>
<p>To add our circular value indicators, we want an update pattern that mirrors that used to create our country SVG paths. <a data-primary="value indicators, adding to D3 map" data-type="indexterm" id="ix_valind"/><a data-primary="mapping with D3" data-secondary="adding value indicators" data-type="indexterm" id="ix_mapD3valind"/><a data-primary="D3 library" data-secondary="mapping with" data-tertiary="adding value indicators" data-type="indexterm" id="ix_D3mapaddVI"/>We want to bind to the <code>mapData</code> dataset and append, update, and remove our indicator circles accordingly. As with the country shapes, we’ll adjust the indicators’ opacity to add and remove them from the map.</p>
<p>The indicators need to be placed at the center of their respective countries. D3’s <code>path</code> generator  provides a number of useful utility methods for dealing with GeoJSON geometries. <a data-primary="paths (geographic, in D3)" data-secondary="path.centroid method" data-type="indexterm" id="idm45607739267504"/><a data-primary="centroids" data-type="indexterm" id="idm45607739266656"/>One of them is <code>centroid</code>, which computes the projected centroid for the specified feature:</p>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// Given the GeoJSON of country (country.geo)</code>
<code class="c1">// calculate x, y coords of center</code>
<code class="kd">var</code> <code class="nx">center</code> <code class="o">=</code> <code class="nx">path</code><code class="p">.</code><code class="nx">centroid</code><code class="p">(</code><code class="nx">country</code><code class="p">.</code><code class="nx">geo</code><code class="p">);</code>
<code class="c1">// center = [x, y]</code></pre>
<p>While <code>path.centroid</code> does a pretty good job as a rule, and is very useful for labeling shape, boundaries, and so on, it can produce strange results, particularly with highly concave geometries.  Handily, the world country data we stored in <a data-type="xref" href="ch05.xhtml#country_data">“Getting Country Data for the Nobel Dataviz”</a> contains the central coordinates of all our Nobel Prize countries.</p>
<p>We’ll first write a little method to retrieve those given a <code>mapData</code> object:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code><code> </code><code class="nx">getCentroid</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="kd">var</code><code> </code><code class="nx">latlng</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">countryData</code><code class="p">[</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code><code class="p">.</code><code class="nx">latlng</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO11-1" id="co_mapping_with_d3_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="k">return</code><code> </code><code class="nx">projection</code><code class="p">(</code><code class="p">[</code><code class="nx">latlng</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">,</code><code> </code><code class="nx">latlng</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO11-2" id="co_mapping_with_d3_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO11-1" id="callout_mapping_with_d3_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Get the latitude and longitude of our country’s center by name, using the stored world country data.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO11-2" id="callout_mapping_with_d3_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Use our equirectangular <code>projection</code> to turn these into SVG coordinates.<a data-primary="projections (map)" data-type="indexterm" id="idm45607739177088"/><a data-primary="equirectangular projection" data-type="indexterm" id="idm45607739176384"/></p></dd>
</dl>
<p>As shown in <a data-type="xref" href="#d3maps_centroid_code">Example 19-7</a>, we bind our <code>mapData</code> to the selection of all elements of class <code>centroid</code> in the <code>centroids</code> group we added in <a data-type="xref" href="#d3maps_basic_map_code">Example 19-5</a>. The data is bound via the <code>name</code> key.<a data-primary="data binding in D3" data-secondary="binding mapData to the selection of all elements of class centroid" data-type="indexterm" id="idm45607739137360"/></p>
<div data-type="example" id="d3maps_centroid_code">
<h5><span class="label">Example 19-7. </span>Adding prize-haul indicators to the Nobel countries’ centroids</h5>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">updateMap</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">countryData</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code class="c1">//...
</code><code>  </code><code class="c1">// BIND MAP DATA WITH NAME KEY
</code><code>  </code><code class="kd">let</code><code> </code><code class="nx">centroids</code><code> </code><code class="o">=</code><code> </code><code class="nx">svg</code><code>
     </code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'.centroids'</code><code class="p">)</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'.centroid'</code><code class="p">)</code><code>
     </code><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">mapData</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO12-1" id="co_mapping_with_d3_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code class="c1">// JOIN DATA TO CIRCLE INDICATORS
</code><code>  </code><code class="nx">centroids</code><code>
    </code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code>
      </code><code class="p">(</code><code class="nx">enter</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
        </code><code class="k">return</code><code> </code><code class="nx">enter</code><code>
          </code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code><code>
          </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"centroid"</code><code class="p">)</code><code>
          </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"name"</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code><code>
          </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">getCentroid</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO12-2" id="co_mapping_with_d3_CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
          </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">getCentroid</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code>
      </code><code class="p">}</code><code class="p">,</code><code>
      </code><code class="p">(</code><code class="nx">update</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">update</code><code class="p">,</code><code>
      </code><code class="p">(</code><code class="nx">exit</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">exit</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">)</code><code>
    </code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"active"</code><code class="p">,</code><code>
      </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code> </code><code class="o">===</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">activeCountry</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">transition</code><code class="p">(</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">TRANS_DURATION</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO12-3" id="co_mapping_with_d3_CO12-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">radiusScale</code><code class="p">(</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">number</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO12-1" id="callout_mapping_with_d3_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Binds the map data to the centroid elements using the <code>name</code> key.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO12-2" id="callout_mapping_with_d3_CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Uses the <code>getCentroid</code> function to return pixel positions for the geocoordinates of the countries’ centers.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO12-3" id="callout_mapping_with_d3_CO12-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>This 2000 ms transition fades the circular marker in by increasing its opacity while simultaneously transitioning to its new radius.</p></dd>
</dl></div>
<p>Using a bit of CSS, we can make <a data-primary="CSS" data-secondary="styling value indicators in D3 map" data-type="indexterm" id="idm45607738940000"/>the indicators red and slightly transparent, allowing map details and, where they are densely packed in Europe, other indicators to show through. If the country is selected by the user, using the country filter on the UI bar, it is classed as <code>active</code> and given a golden hue. Here’s the CSS to do that:</p>
<pre class="pagebreak-before" data-code-language="css" data-type="programlisting"><code class="nc">.centroid</code><code class="p">{</code><code>
    </code><code class="k">fill</code><code class="o">:</code><code> </code><code class="nb">red</code><code class="p">;</code><code>
    </code><code class="k">fill-opacity</code><code class="o">:</code><code> </code><code class="m">0</code><code class="o">.</code><code class="m">3</code><code class="p">;</code><code>
    </code><code class="k">pointer-events</code><code class="o">:</code><code> </code><code class="nb">none</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO13-1" id="co_mapping_with_d3_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="p">}</code><code>

</code><code class="nc">.centroid</code><code class="nc">.active</code><code> </code><code class="p">{</code><code>
    </code><code class="k">fill</code><code class="o">:</code><code> </code><code class="nb">goldenrod</code><code class="p">;</code><code>
    </code><code class="k">fill-opacity</code><code class="o">:</code><code> </code><code class="m">0</code><code class="o">.</code><code class="m">6</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO13-1" id="callout_mapping_with_d3_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>This allows mouse events to propagate to country shapes below the circles, allowing the user to still click on them.</p></dd>
</dl>
<p>The active centroid indicators we just added are the last element of our Nobel Prize map. Now let’s take a look at the complete article.<a data-primary="D3 library" data-secondary="mapping with" data-startref="ix_D3mapaddVI" data-tertiary="adding value indicators" data-type="indexterm" id="idm45607738829888"/><a data-primary="value indicators, adding to D3 map" data-startref="ix_valind" data-type="indexterm" id="idm45607738828560"/><a data-primary="mapping with D3" data-secondary="adding value indicators" data-startref="ix_mapD3valind" data-type="indexterm" id="idm45607738827712"/></p>
</div></section>
<section data-pdf-bookmark="Our Completed Map" data-type="sect1"><div class="sect1" id="idm45607739305408">
<h1>Our Completed Map</h1>
<p>With the country and indicator update patterns in place, our map should respond to user-driven filtering with a smooth transition.<a data-primary="mapping with D3" data-secondary="completed map" data-type="indexterm" id="idm45607738825232"/><a data-primary="D3 library" data-secondary="mapping with" data-tertiary="completed map" data-type="indexterm" id="idm45607738824256"/> <a data-type="xref" href="#d3maps_transition">Figure 19-5</a> shows the result of selecting Nobel Prizes for Economics. Only winning countries remain highlighted and the value indicators are resized, reflecting American dominance of this category.</p>
<figure><div class="figure" id="d3maps_transition">
<img alt="dpj2 1905" height="597" src="assets/dpj2_1905.png" width="1441"/>
<h6><span class="label">Figure 19-5. </span>(left) Shows the map with the full Nobel dataset; (right) prizes are filtered by category, showing the Economics winners (and the dominance of the US economists)</h6>
</div></figure>
<p>The map as it stands in not i<a data-primary="mouseenter callback function" data-type="indexterm" id="idm45607738787264"/><a data-primary="mouseout callback function" data-type="indexterm" id="idm45607738786656"/>nteractive but does show when a user hovers over a particular country with a mouse, by calling the <code>mouseenter</code> and <code>mouseout</code> callback functions and adding or removing an <code>active</code> class. These callbacks could easily be used to add more functionality to the map, such as tooltips or the use of the countries as clickable data filters. Let’s now use these to build a simple tooltip, to show the country the mouse is hovering over and some simple prize information.</p>
</div></section>
<section data-pdf-bookmark="Building a Simple Tooltip" data-type="sect1"><div class="sect1" id="sect_tooltip">
<h1>Building a Simple Tooltip</h1>
<p>Tooltips and other interactive widgets are the kind of thing commonly demanded of data visualizers and though they can get quite involved, particularly if they themselves are interactive (e.g., menus that appear on mouse hover), there are some simple recipes that are very handy to know.<a data-primary="D3 library" data-secondary="mapping with" data-tertiary="building a simple tooltip" data-type="indexterm" id="ix_D3maptooltp"/><a data-primary="mapping with D3" data-secondary="building a simple tooltip" data-type="indexterm" id="ix_mapD3tooltp"/><a data-primary="tooltips" data-secondary="simple tooltip for D3 map" data-type="indexterm" id="ix_tooltip"/> In this section, I’ll show how to build a simple but pretty effective tooltip. <a data-type="xref" href="#d3map_tooltip">Figure 19-6</a> shows what we’re aiming to build.</p>
<figure><div class="figure" id="d3map_tooltip">
<img alt="dpj2 1504" height="194" src="assets/dpj2_1504.png" width="469"/>
<h6><span class="label">Figure 19-6. </span>A simple tooltip for our Nobel Prize map</h6>
</div></figure>
<p>Let’s remind ourselves of our current <code>countries</code> update, where <code>mouseenter</code> and <code>mouseout</code> event handlers are added <a data-primary="data-joins (in D3)" data-secondary="countries update with mouseenter and mouseout event handlers added" data-type="indexterm" id="idm45607738774672"/>during a data-join:</p>
<pre data-code-language="js" data-type="programlisting">    <code class="c1">// ENTER AND APPEND ANY NEW COUNTRIES</code>
    <code class="nx">countries</code><code class="p">.</code><code class="nx">join</code><code class="p">((</code><code class="nx">enter</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="k">return</code> <code class="nx">enter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'path'</code><code class="p">)</code>
      <code class="c1">// ...</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'mouseenter'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code> <code class="kc">true</code><code class="p">);</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'mouseout'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code> <code class="kc">false</code><code class="p">);</code>
        <code class="p">})</code>
      <code class="p">})</code>
    <code class="p">;</code></pre>
<p>In order to add a tooltip to our map, we need to do three things:</p>
<ol>
<li>
<p>Create a tooltip box in HTML with placeholders for the information we want to display—​in this case, country name and number of wins in the selected prize category.</p>
</li>
<li>
<p>Display this HTML box over the mouse when the user moves it into a country and hide it when they move the mouse out.</p>
</li>
<li>
<p>Update the box when displayed using the data bound to the country underneath the mouse.</p>
</li>
</ol>
<p>We create the <a data-primary="HTML" data-secondary="for tooltip in D3 map" data-secondary-sortas="tooltip" data-type="indexterm" id="idm45607738688336"/>HTML for the tooltip by adding a content block to the Nobel-viz map section, with ID <code>map-tooltip</code>, an <code>&lt;h2&gt;</code> header for its title, and a <code>&lt;p&gt;</code> tag for the tooltip’s text:</p>
<pre data-code-language="html" data-type="programlisting"><code class="cm">&lt;!-- index.xhtml  --&gt;</code>
      <code class="cm">&lt;!-- ...  --&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-map"</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"map-tooltip"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">h2</code><code class="p">&gt;&lt;/</code><code class="nt">h2</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
          <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
      <code class="cm">&lt;!-- ...  --&gt;</code></pre>
<p>We’ll also need some CSS for the tooltip’s look and feel, added <a data-primary="CSS" data-secondary="setting look and feel for tooltip in D3 map" data-type="indexterm" id="idm45607738638448"/>to our <em>style.css</em> file:</p>
<pre data-code-language="css" data-type="programlisting"><code class="c">/* css/style.css */</code><code>
</code><code class="c">/* MAP TOOLTIP */</code><code>
</code><code class="nf">#map-tooltip</code><code> </code><code class="p">{</code><code>
    </code><code class="k">position</code><code class="o">:</code><code> </code><code class="nb">absolute</code><code class="p">;</code><code>
    </code><code class="k">pointer-events</code><code class="o">:</code><code> </code><code class="nb">none</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO14-1" id="co_mapping_with_d3_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="k">color</code><code class="o">:</code><code> </code><code class="m">#eee</code><code class="p">;</code><code>
    </code><code class="k">font-size</code><code class="o">:</code><code> </code><code class="m">12px</code><code class="p">;</code><code>
    </code><code class="k">opacity</code><code class="o">:</code><code> </code><code class="m">0</code><code class="o">.</code><code class="m">7</code><code class="p">;</code><code> </code><code class="c">/* a little transparent */</code><code>
    </code><code class="k">background</code><code class="o">:</code><code> </code><code class="m">#222</code><code class="p">;</code><code>
    </code><code class="k">border</code><code class="o">:</code><code> </code><code class="m">2px</code><code> </code><code class="nb">solid</code><code> </code><code class="m">#555</code><code class="p">;</code><code>
    </code><code class="k">border-color</code><code class="o">:</code><code> </code><code class="nb">goldenrod</code><code class="p">;</code><code>
    </code><code class="k">padding</code><code class="o">:</code><code> </code><code class="m">10px</code><code class="p">;</code><code>
    </code><code class="k">left</code><code class="o">:</code><code> </code><code class="m">-999px</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO14-2" id="co_mapping_with_d3_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="p">}</code><code>

</code><code class="nf">#map-tooltip</code><code> </code><code class="nt">h2</code><code> </code><code class="p">{</code><code>
    </code><code class="k">text-align</code><code class="o">:</code><code> </code><code class="nb">center</code><code class="p">;</code><code>
    </code><code class="k">padding</code><code class="o">:</code><code> </code><code class="m">0px</code><code class="p">;</code><code>
    </code><code class="k">margin</code><code class="o">:</code><code> </code><code class="m">0px</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO14-1" id="callout_mapping_with_d3_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Setting <code>pointer-events</code> to <code>none</code> effectively lets you click on things underneath the tooltip.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO14-2" id="callout_mapping_with_d3_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Initially, the tooltip is hidden far to the (virtual) left of the browser window, using a large negative x index.</p></dd>
</dl>
<p>With our tooltip’s HTML in place and the element hidden to the left of the browser window (<code>left</code> is –9999 pixels), we just need to extend our <code>mousein</code> and <code>mouseout</code> callback functions to display or hide the tooltip.<a data-primary="mousein callback function" data-type="indexterm" id="idm45607738524448"/><a data-primary="mouseout callback function" data-type="indexterm" id="idm45607738523776"/> The <code>mousein</code> function, called when the user moves the mouse into a country, does most of the work:</p>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// ...
</code><code class="nx">countries</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code>
    </code><code class="p">(</code><code class="nx">enter</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
    </code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'path'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'class'</code><code class="p">,</code><code> </code><code class="s1">'country'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'mouseenter'</code><code class="p">,</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">event</code><code class="p">)</code><code> </code><code class="p">{</code><code>

        </code><code class="kd">var</code><code> </code><code class="nx">country</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="c1">// don't do anything if the country is not visible
</code><code>        </code><code class="k">if</code><code class="p">(</code><code class="o">!</code><code class="nx">country</code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'visible'</code><code class="p">)</code><code class="p">)</code><code class="p">{</code><code> </code><code class="k">return</code><code class="p">;</code><code> </code><code class="p">}</code><code>

        </code><code class="c1">// get the country data object
</code><code>        </code><code class="kd">var</code><code> </code><code class="nx">cData</code><code> </code><code class="o">=</code><code> </code><code class="nx">country</code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="c1">// if only one prize, use singular 'prize'
</code><code>        </code><code class="kd">var</code><code> </code><code class="nx">prize_string</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="nx">cData</code><code class="p">.</code><code class="nx">number</code><code> </code><code class="o">===</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="o">?</code><code>
            </code><code class="s1">' prize in '</code><code class="o">:</code><code> </code><code class="s1">' prizes in '</code><code class="p">;</code><code>
        </code><code class="c1">// set the header and text of the tooltip
</code><code>        </code><code class="nx">tooltip</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'h2'</code><code class="p">)</code><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">cData</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="nx">tooltip</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'p'</code><code class="p">)</code><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">cData</code><code class="p">.</code><code class="nx">number</code><code>
            </code><code class="o">+</code><code> </code><code class="nx">prize_string</code><code> </code><code class="o">+</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">activeCategory</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="c1">// set the border color according to selected
</code><code>        </code><code class="c1">// prize category
</code><code>        </code><code class="kd">var</code><code> </code><code class="nx">borderColor</code><code> </code><code class="o">=</code><code>
          </code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">activeCategory</code><code> </code><code class="o">===</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">ALL_CATS</code><code class="p">)</code><code class="o">?</code><code>
            </code><code class="s1">'goldenrod'</code><code class="o">:</code><code>
            </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryFill</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">activeCategory</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="nx">tooltip</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'border-color'</code><code class="p">,</code><code> </code><code class="nx">borderColor</code><code class="p">)</code><code class="p">;</code><code>

        </code><code class="kd">var</code><code> </code><code class="nx">mouseCoords</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">pointer</code><code class="p">(</code><code class="nx">event</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO15-1" id="co_mapping_with_d3_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
        </code><code class="kd">var</code><code> </code><code class="nx">w</code><code> </code><code class="o">=</code><code> </code><code class="nb">parseInt</code><code class="p">(</code><code class="nx">tooltip</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'width'</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO15-2" id="co_mapping_with_d3_CO15-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
            </code><code class="nx">h</code><code> </code><code class="o">=</code><code> </code><code class="nb">parseInt</code><code class="p">(</code><code class="nx">tooltip</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'height'</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="nx">tooltip</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'top'</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">mouseCoords</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="nx">h</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="s1">'px'</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO15-3" id="co_mapping_with_d3_CO15-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
        </code><code class="nx">tooltip</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'left'</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">mouseCoords</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="nx">w</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="s1">'px'</code><code class="p">)</code><code class="p">;</code><code>

        </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code><code> </code><code class="kc">true</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="p">}</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'mouseout'</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
      </code><code class="nx">tooltip</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'left'</code><code class="p">,</code><code> </code><code class="s1">'-9999px'</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO15-4" id="co_mapping_with_d3_CO15-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
      </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code><code> </code><code class="kc">false</code><code class="p">)</code><code>
    </code><code class="p">}</code><code class="p">)</code><code>
  </code><code class="p">}</code><code class="p">,</code><code> </code><code class="c1">// ...
</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO15-1" id="callout_mapping_with_d3_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>D3’s <code>pointer</code> method returns the mouse coordinates from the <code>event</code> object (here, relative to the parent map group) in pixels, which we can use to position the tooltip.<a data-primary="pointer method (D3)" data-type="indexterm" id="idm45607737919696"/></p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO15-2" id="callout_mapping_with_d3_CO15-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>We get the computed width and height of the tooltip box, which has been adjusted to accommodate our country title and prize string.</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO15-3" id="callout_mapping_with_d3_CO15-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>We use the mouse coordinates and the width and height of the tooltip box to position the box centered horizontally and roughly above the mouse cursor (the width and height don’t include our 10 pixels of padding around the tooltip’s <code>&lt;div&gt;</code>).</p></dd>
<dt><a class="co" href="#co_mapping_with_d3_CO15-4" id="callout_mapping_with_d3_CO15-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>When the mouse leaves a country, we vanish the tooltip by placing it to the far left of the map.</p></dd>
</dl>
<p>With the <code>mouseenter</code> callback function written, we now only need a <code>mouseout</code> to hide the tooltip by placing it far to the<a data-primary="mouseenter callback function" data-type="indexterm" id="idm45607738164240"/> left of the browser window:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">countries</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code>
    </code><code class="p">(</code><code class="nx">enter</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
    </code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'path'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'class'</code><code class="p">,</code><code> </code><code class="s1">'country'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'mouseenter'</code><code class="p">,</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">event</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="c1">// ...
</code><code>    </code><code class="p">}</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'mouseout'</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
      </code><code class="nx">tooltip</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'left'</code><code class="p">,</code><code> </code><code class="s1">'-9999px'</code><code class="p">)</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO16-1" id="co_mapping_with_d3_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
      </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code><code> </code><code class="kc">false</code><code class="p">)</code><code>
    </code><code class="p">}</code><code class="p">)</code><code>
  </code><code class="p">}</code><code class="p">,</code><code> </code><code class="c1">// ...
</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO16-1" id="callout_mapping_with_d3_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>When the mouse leaves the country we shift the tooltip far to the left, out of the browser viewport, and remove the <code>'active'</code> class from the country, returning it to the default country color.</p></dd>
</dl>
<p>With the <code>mouseenter</code> and <code>mouseout</code> functions operating in concert, you should see the tooltip appearing and disappearing where needed, just as shown in <a data-type="xref" href="#d3map_tooltip">Figure 19-6</a>.</p>
<section data-pdf-bookmark="Updating the Map" data-type="sect2"><div class="sect2" id="idm45607738245504">
<h2>Updating the Map</h2>
<p>When the map module is imported, it appends a callback function to the callbacks array in the core module. <a data-primary="updates" data-secondary="updating D3 map with tooltip" data-type="indexterm" id="idm45607738243808"/>When data is updated in response to user interaction, this callback function is called and the bar chart updated with new country data:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">callbacks</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_mapping_with_d3_CO17-1" id="co_mapping_with_d3_CO17-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code class="kd">let</code><code> </code><code class="nx">data</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">getCountryData</code><code class="p">(</code><code class="p">)</code><code>
  </code><code class="nx">updateMap</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code>
</code><code class="p">}</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_mapping_with_d3_CO17-1" id="callout_mapping_with_d3_CO17-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>This anonymous function is called in the core module when data is updated.</p></dd>
</dl>
<p>Now that we’ve built the map component of our Nobel dataviz, let’s summarize what we’ve learned before moving on to show how user input drives the visualization.<a data-primary="D3 library" data-secondary="mapping with" data-startref="ix_D3maptooltp" data-tertiary="building a simple tooltip" data-type="indexterm" id="idm45607738382064"/><a data-primary="mapping with D3" data-secondary="building a simple tooltip" data-startref="ix_mapD3tooltp" data-type="indexterm" id="idm45607738380576"/><a data-primary="tooltips" data-secondary="simple tooltip for D3 map" data-startref="ix_tooltip" data-type="indexterm" id="idm45607738379392"/></p>
</div></section>
</div></section>
<section class="pagebreak-before less_space" data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45607738783488">
<h1>Summary</h1>
<p>D3 mapping is a rich area, with many varied projections and lots of utility methods to help with manipulating geometries. But building a map follows a fairly standard procedure, as demonstrated in the chapter: you first choose your projection—say, a Mercator or maybe the <a href="https://oreil.ly/Nz6Ar">Albers conic projection</a> commonly used for mapping the US. You then use this projection to create a D3 <code>path</code> generator, which turns GeoJSON features into SVG paths, creating the map you see. The GeoJSON will normally be extracted from more efficient <span class="keep-together">TopoJSON</span> data.</p>
<p>This chapter also demonstrated how easy it is with D3 to interactively highlight your map and deal with cursor movements. Taken together, the basic set of skills should allow you to start building your own mapping visualizations.</p>
<p>Now that we’ve constructed all of our SVG-based graphical elements, let’s see how well D3 works with conventional HTML elements by building our winners list and an individual’s biography box.<a data-primary="D3 library" data-secondary="mapping with" data-startref="ix_D3map" data-type="indexterm" id="idm45607738347904"/><a data-primary="mapping with D3" data-startref="ix_mapD3" data-type="indexterm" id="idm45607738346656"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45607741792448"><sup><a href="ch19.xhtml#idm45607741792448-marker">1</a></sup> The math of geometric projections, for example, can get complicated fast.</p><p data-type="footnote" id="idm45607741786480"><sup><a href="ch19.xhtml#idm45607741786480-marker">2</a></sup> I use and thoroughly recommend the open source <a href="https://www.qgis.org/en/site">QGIS</a>.</p><p data-type="footnote" id="idm45607741781184"><sup><a href="ch19.xhtml#idm45607741781184-marker">3</a></sup> Python’s <em>topojson.py</em> and the TopoJSON command-line program.</p><p data-type="footnote" id="idm45607741779664"><sup><a href="ch19.xhtml#idm45607741779664-marker">4</a></sup> As we’ll see, it does lack a couple of our Nobel Prize countries, but these are too small to be clickable and we have the coordinates of their centers, allowing for a visual cue to be overlaid.</p><p data-type="footnote" id="idm45607741574800"><sup><a href="ch19.xhtml#idm45607741574800-marker">5</a></sup> See <a href="https://bost.ocks.org/mike/simplify">this site by Mike Bostock</a> for a very cool example.</p><p data-type="footnote" id="idm45607741352656"><sup><a href="ch19.xhtml#idm45607741352656-marker">6</a></sup> By installing globally, you can use the <code>geo2topo</code> command in any directory.</p><p data-type="footnote" id="idm45607741031424"><sup><a href="ch19.xhtml#idm45607741031424-marker">7</a></sup> The <a href="https://oreil.ly/14vLd">extended set of D3 <code>projection</code>s</a> is part of an extension of D3, not in the main library.</p><p data-type="footnote" id="idm45607741009120"><sup><a href="ch19.xhtml#idm45607741009120-marker">8</a></sup> See <a class="bare" href="https://oreil.ly/oAppn"><em class="hyperlink">https://oreil.ly/oAppn</em></a> for a nice demonstration.</p><p data-type="footnote" id="idm45607740753936"><sup><a href="ch19.xhtml#idm45607740753936-marker">9</a></sup> See <a href="https://oreil.ly/KqnF6">the D3 GitHub</a> for a full list.</p></div></div></section></div></body></html>