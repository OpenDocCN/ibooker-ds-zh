<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 17. Introducing D3—​The Story of a Bar Chart" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_d3_intro">
<h1><span class="label">Chapter 17. </span>Introducing D3—​The Story of a Bar Chart</h1>
<p>In <a data-type="xref" href="ch16.xhtml#chapter_building_viz">Chapter 16</a>, we imagined our Nobel Prize visualization by breaking it into component elements. <a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-type="indexterm" id="ix_D3intr"/><a data-primary="bar charts" data-secondary="building with D3" data-seealso="D3 library" data-type="indexterm" id="idm45607748036864"/>In this chapter, I will gently introduce you to D3 by showing you how to build the bar chart we need (<a data-type="xref" href="#target_barchart">Figure 17-1</a>).</p>
<figure><div class="figure" id="target_barchart">
<img alt="dpj2 1701" height="218" src="assets/dpj2_1701.png" width="666"/>
<h6><span class="label">Figure 17-1. </span>This chapter’s target bar chart</h6>
</div></figure>
<p>D3 is much more than a charting library. It’s a library you use to build charting libraries, among other things. So why am I introducing you to D3 by way of that ultra-conventional visualization, the bar chart? First, because there should be a little thrill in crafting one from scratch for the first time, having total control over the look and feel of the chart and being unconstrained by whatever prejudices a particular charting library has. And second, because it just happens to be a great way to cover the fundamental elements of D3, particularly data joining and the enter-exit-remove update pattern, now nicely encapsulated by D3’s newish <code>join</code> method.<a data-primary="join method (D3)" data-type="indexterm" id="idm45607748031808"/> If you get those fundamentals in place, you’re well on your way to employing the full power and expressivity D3 offers, and producing something more novel than a bar chart.</p>
<p>We’ll be using some of the webdev covered in <a data-type="xref" href="ch04.xhtml#chapter_webdev101">Chapter 4</a>, particularly the SVG graphics that are D3’s specialty (see <a data-type="xref" href="ch04.xhtml#sect_svg">“Scalable Vector Graphics”</a>). You can try out the code snippets using an online editor like <a href="https://codepen.io">CodePen’s</a> or <a href="https://vizhub.com">VizHub’s</a> (which also has a huge number of curated dataviz examples).<a data-primary="editors" data-secondary="online, for D3 code" data-type="indexterm" id="idm45607748027488"/></p>
<p>Before we begin building the bar chart, let’s consider its elements.</p>
<section data-pdf-bookmark="Framing the Problem" data-type="sect1"><div class="sect1" id="idm45607748026000">
<h1>Framing the Problem</h1>
<p>A bar chart has three key components: the axes, legends, and labels, and, of course, the bars. <a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-tertiary="framing the problem" data-type="indexterm" id="idm45607748024304"/>As we’re producing a modern, interactive bar chart component, we’ll need the axes and bars to transform in response to user interaction—​namely, filtering the set of prize winners via the top selectors (see <a data-type="xref" href="ch15.xhtml#imagine_ui">Figure 15-1</a>).</p>
<p>We’ll build the chart one step at a time, ending with D3 transitions, which can make your D3 creations more engaging and attractive.  But first we’ll cover the basics of D3:</p>
<ul>
<li>
<p>Selecting DOM elements in your web page</p>
</li>
<li>
<p>Getting and setting their attributes, properties, and styles</p>
</li>
<li>
<p>Appending and inserting DOM elements</p>
</li>
</ul>
<p>With these basics firmly in place, we’ll move on to the joys of data binding, where D3 begins to flex its muscles.</p>
</div></section>
<section data-pdf-bookmark="Working with Selections" data-type="sect1"><div class="sect1" id="idm45607748017712">
<h1>Working with Selections</h1>
<p>Selections are the backbone of D3. Using jQuery-like CSS selectors, D3 can select and manipulate individual and grouped DOM elements.<a data-primary="DOM (Document Object Model)" data-secondary="selecting and manipulating elements with D3" data-type="indexterm" id="ix_DOMselD3"/><a data-primary="selections (D3)" data-type="indexterm" id="ix_slct"/><a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-tertiary="working with selections" data-type="indexterm" id="ix_D3intrSel"/> All D3 chained operations begin by selecting a DOM element or set of elements using the <code>select</code> and <code>selectAll</code> methods. <code>select</code> returns the first matching element; <code>selectAll</code> returns the set of matching elements.<a data-primary="select method (D3)" data-type="indexterm" id="idm45607748009760"/><a data-primary="selectAll method (D3)" data-type="indexterm" id="idm45607748009056"/></p>
<p><a data-type="xref" href="#d3bar_selections">Figure 17-2</a> shows examples of D3 selections, using the <code>select</code> and <code>selectAll</code> methods. These selections are used to change the <code>height</code> attribute of one or more bars. The <code>select</code> method returns the first <code>rect</code> (ID <code>barL</code>) with class <code>bar</code>, whereas <span class="keep-together"><code>selectAll</code></span> can return any combination of the <code>rect</code>s depending on the query <span class="keep-together">provided</span>.</p>
<figure><div class="figure" id="d3bar_selections">
<img alt="dpj2 1702" height="1439" src="assets/dpj2_1702.png" width="1432"/>
<h6><span class="label">Figure 17-2. </span>Selecting elements and changing attributes: three rectangles are built with the initial HTML. Selections are then made and the height attributes of one or more bars are adjusted.</h6>
</div></figure>
<p>In addition to setting attributes (the named strings on the DOM elements; e.g., <code>id</code> or <code>class</code>), D3 allows you to set elements’ CSS styles, properties (e.g., whether a checkbox is checked), text, and HTML.<a data-primary="CSS" data-secondary="setting for DOM elements with D3" data-type="indexterm" id="idm45607747998816"/><a data-primary="properties" data-secondary="setting for DOM elements with D3" data-type="indexterm" id="idm45607747997824"/></p>
<p><a data-type="xref" href="#d3bar_selects">Figure 17-3</a> shows all the ways in which a DOM element can be changed with D3. With these few methods, you can achieve pretty much any look and feel you want.</p>
<figure><div class="figure" id="d3bar_selects">
<img alt="dpj2 1703" height="252" src="assets/dpj2_1703.png" width="1342"/>
<h6><span class="label">Figure 17-3. </span>Changing a DOM element with D3</h6>
</div></figure>
<p><a data-type="xref" href="#d3bar_setting_bar">Figure 17-4</a> shows how we can apply CSS styling by adding a class to the element or directly setting a style. We first select the middle bar using its ID <code>barM</code>. The <code>classed</code> method is then used to apply a yellow highlight (see the CSS) and the <code>height</code> attribute set to 50 px. The <code>style</code> method is then used to apply a red fill to the bar directly.</p>
<figure><div class="figure" id="d3bar_setting_bar">
<img alt="dpj2 1704" height="432" src="assets/dpj2_1704.png" width="1430"/>
<h6><span class="label">Figure 17-4. </span>Setting attributes and style</h6>
</div></figure>
<p>D3’s <code>text</code> method sets the text content of applicable DOM tags, such as <code>div</code>, <code>p</code>, <code>h*</code> headers, and SVG text elements.<a data-primary="text" data-secondary="setting text content of DOM elements with D3" data-type="indexterm" id="idm45607747986352"/> To see the <code>text</code> method in action, let’s create a little title placeholder with some HTML:</p>
<pre data-type="programlisting">&lt;!DOCTYPE html&gt;
&lt;meta charset="utf-8"&gt;

&lt;style&gt;font-family: sans-serif;&lt;/style&gt;

&lt;body&gt;
  &lt;h2 id="title"&gt;title holder&lt;/h2&gt;
&lt;/body&gt;</pre>
<p><a data-type="xref" href="#d3bar_text">Figure 17-5</a> (before) shows the resulting browser page.</p>
<p>Now let’s create a <code>fancy-title</code> CSS class with a large, bold font:</p>
<pre data-code-language="css" data-type="programlisting"><code class="nc">.fancy-title</code> <code class="p">{</code>
    <code class="k">font-size</code><code class="o">:</code> <code class="m">24px</code><code class="p">;</code>
    <code class="k">font-weight</code><code class="o">:</code> <code class="nb">bold</code><code class="p">;</code>
<code class="p">}</code></pre>
<p>We can now use D3 to select the title header, add the <code>fancy-title</code> class to it, and then set its text to My Bar Chart:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#title'</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'fancy-title'</code><code class="p">,</code> <code class="kc">true</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s1">'My Bar Chart'</code><code class="p">);</code></pre>
<p><a data-type="xref" href="#d3bar_text">Figure 17-5</a> (after) shows the resulting enlarged and emboldened title.</p>
<figure><div class="figure" id="d3bar_text">
<img alt="dpj2 1705" height="239" src="assets/dpj2_1705.png" width="1410"/>
<h6><span class="label">Figure 17-5. </span>Setting text and style with D3</h6>
</div></figure>
<p>In addition to setting the properties of DOM elements, we can use selections to get those properties. <a data-primary="properties" data-secondary="getting for DOM elements with D3" data-type="indexterm" id="idm45607747920416"/>Leaving out the second argument to one of the methods listed in <a data-type="xref" href="#d3bar_selects">Figure 17-3</a> allows you to get information about the web page’s setup.</p>
<p><a data-type="xref" href="#d3bar_getter_bar">Figure 17-6</a> shows how to get the key properties from an SVG rectangle. As we’ll see, getting attributes like <code>width</code> and <code>height</code> from an SVG element can be very useful for programmatic adaptation and adjustment.</p>
<figure><div class="figure" id="d3bar_getter_bar">
<img alt="dpj2 1706" height="327" src="assets/dpj2_1706.png" width="1172"/>
<h6><span class="label">Figure 17-6. </span>Getting a <code>rect</code> bar’s details</h6>
</div></figure>
<p><a data-type="xref" href="#d3bar_getter_text">Figure 17-7</a> demonstrates the <code>html</code> and <code>text</code> getter methods. After creating a little list (ID <code>silly-list</code>), we use D3 to select it and get various properties.  <a data-primary="HTML" data-secondary="html method of D3" data-type="indexterm" id="idm45607747911440"/><a data-primary="text" data-secondary="getting for DOM elements with D3" data-type="indexterm" id="idm45607747910464"/>The <code>html</code> method returns the HTML of the list’s child <code>&lt;li&gt;</code> tags, while the <code>text</code> method returns the text contained in the list, with the HTML tags stripped. Note that for parent tags, the formatting of any text returned is a little messy, but maybe good enough for a string search or two.</p>
<figure><div class="figure" id="d3bar_getter_text">
<img alt="dpj2 1707" height="593" src="assets/dpj2_1707.png" width="1386"/>
<h6><span class="label">Figure 17-7. </span>Getting HTML and text from a <code>list</code> tag</h6>
</div></figure>
<p>So far we’ve been manipulating the attributes, styles, and properties of existing DOM elements. This is a useful skill, but D3 comes into its own when we start creating DOM elements programmatically using its <code>append</code> and <code>insert</code> methods. Let’s look at these now.<a data-primary="DOM (Document Object Model)" data-secondary="selecting and manipulating elements with D3" data-startref="ix_DOMselD3" data-type="indexterm" id="idm45607747904576"/><a data-primary="selections (D3)" data-startref="ix_slct" data-type="indexterm" id="idm45607747903392"/><a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-startref="ix_D3intrSel" data-tertiary="working with selections" data-type="indexterm" id="idm45607747902448"/></p>
</div></section>
<section data-pdf-bookmark="Adding DOM Elements" data-type="sect1"><div class="sect1" id="idm45607748016800">
<h1>Adding DOM Elements</h1>
<p>We’ve seen how to select  and manipulate the attributes, styles, and properties of DOM elements. <a data-primary="D3 library" data-secondary="adding DOM elements with" data-type="indexterm" id="ix_D3addDOM"/><a data-primary="DOM (Document Object Model)" data-secondary="adding elements using D3" data-type="indexterm" id="ix_DOMaddD3"/>Now we’ll see how D3 allows us to append and insert elements, programmatically adapting the DOM tree.</p>
<p>We’ll start with a little HTML skeleton containing a <code>nobel-bar</code> placeholder:</p>
<pre data-code-language="html" data-type="programlisting"><code class="cp">&lt;!DOCTYPE html&gt;</code><code>
</code><code class="p">&lt;</code><code class="nt">meta</code><code> </code><code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code><code>
</code><code class="p">&lt;</code><code class="nt">link</code><code> </code><code class="na">rel</code><code class="o">=</code><code class="s">"stylesheet"</code><code> </code><code class="na">href</code><code class="o">=</code><code class="s">"style.css"</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>

</code><code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">id</code><code class="o">=</code><code class="s">'nobel-bar'</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>

  </code><code class="p">&lt;</code><code class="nt">script</code><code>
    </code><code class="na">src</code><code class="o">=</code><code class="s">"https://cdnjs.cloudflare.com/ajax/libs/d3/7.3.1/d3.min.js"</code><code class="p">&gt;</code><code class="w">
  </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">script</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">script</code><code> </code><code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code><code> </code><code class="na">src</code><code class="o">=</code><code class="s">"script.js"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">script</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO1-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">body</code><code class="p">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO1-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The <em>script.js</em> file is where we’ll add our bar chart’s JavaScript code.</p></dd>
</dl>
<p>Let’s set the size of the <code>nobel-bar</code> element with a little CSS, placed in <em>style.css</em>:</p>
<pre data-code-language="css" data-type="programlisting"><code class="nf">#nobel-bar</code> <code class="p">{</code>
  <code class="k">width</code><code class="o">:</code> <code class="m">600px</code><code class="p">;</code>
  <code class="k">height</code><code class="o">:</code> <code class="m">400px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.bar</code> <code class="p">{</code>
    <code class="k">fill</code><code class="o">:</code> <code class="nb">blue</code><code class="p">;</code> <code class="c">/* blue bars for the chapter */</code>
<code class="p">}</code></pre>
<p>Usually the first thing one does when creating a chart with D3 is to provide an SVG frame for it. <a data-primary="SVG (Scalable Vector Graphics)" data-secondary="frame for charts created in D3" data-type="indexterm" id="idm45607747751408"/>This involves appending an <code>&lt;svg&gt;</code> canvas element to a <code>div</code> chartholder and then appending a <code>&lt;g&gt;</code> group to the <code>&lt;svg&gt;</code> to hold specific chart elements (in our case, the chart bars).<a data-primary="svg canvas element" data-type="indexterm" id="idm45607747748832"/> This group has margins to accommodate axes, axes labels, and titles.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45607747748000">
<h5>Getting the Dimensions of an Element</h5>
<p>It’s very common when programming in D3, or any other JavaScript visualization library, to require the width and height of an SVG or HTML element to use as the basis for setting the size of component elements. <a data-primary="D3 library" data-secondary="style component, using to get CSS dimensions for elements and using parseInt function on" data-type="indexterm" id="idm45607747746496"/><a data-primary="parseInt function (D3)" data-type="indexterm" id="idm45607747745328"/><a data-primary="style method (D3)" data-type="indexterm" id="idm45607747744768"/>One way of doing this is to use D3’s <code>style</code> component to grab the CSS dimensions and then use the <code>parseInt</code> function to get an integer value:</p>
<pre data-code-language="js" data-type="programlisting"><code class="cm">/* CSS: #nobel-bar { width: 600px }; */</code><code>

</code><code class="kd">var</code><code> </code><code class="nx">width</code><code> </code><code class="o">=</code><code> </code><code class="nb">parseInt</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-bar'</code><code class="p">)</code><code>
                       </code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'width'</code><code class="p">)</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO2-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO2-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The result of calling the <code>style</code> method is the string <code>'600px'</code>, which we can convert to the number 600 using the <code>parseInt</code> function.</p></dd>
</dl>
<p>This method works pretty well as a rule, although the <code>parseInt</code> feels a bit hacky, turning the string <code>'600px'</code> into the number 600. It will also fail if the width is specified by a percentage of the parent container.</p>
<p>Arguably, a better, more robust approach is to get the dimensions of the bounding box of the HTML or SVG element in question.<a data-primary="HTML" data-secondary="getting dimensions of bounding box of elements" data-type="indexterm" id="idm45607747696368"/><a data-primary="SVG (Scalable Vector Graphics)" data-secondary="getting dimensions of bounding box of elements" data-type="indexterm" id="idm45607747695424"/> These give both the width, height, and relative position of the element, using the <code>node</code> method to get the DOM element:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code> <code class="nx">ele</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#chart-holder"</code><code class="p">)</code>
<code class="c1">// For an HTML element, starting with the D3 +ele+ selection</code>
<code class="kd">let</code> <code class="nx">bRect</code> <code class="o">=</code> <code class="nx">ele</code><code class="p">.</code><code class="nx">node</code><code class="p">().</code><code class="nx">getBoundingClientRect</code><code class="p">();</code>
<code class="c1">// e.g., bRect is {width: 600, height: 400, ... }</code>
<code class="c1">// For an SVG element use the getBBox method:</code>
<code class="kd">let</code> <code class="nx">bBox</code> <code class="o">=</code> <code class="nx">eleSVG</code><code class="p">.</code><code class="nx">node</code><code class="p">().</code><code class="nx">getBBox</code><code class="p">();</code>
<code class="c1">// e.g., bBox is {width: 600, height: 400, x: 100, y: 100}</code></pre>
</div></aside>
<p class="pagebreak-before">Conventionally, you will specify the margin of your chart in a <code>margin</code> object and then use that and the CSS-specified width and height of the chart container to derive the width and height of your chart group.<a data-primary="margin object" data-type="indexterm" id="idm45607747642528"/> The required JavaScript looks like <a data-type="xref" href="#d3bar_dimensions_code">Example 17-1</a>.</p>
<div data-type="example" id="d3bar_dimensions_code">
<h5><span class="label">Example 17-1. </span>Getting our bar chart’s dimensions</h5>
<pre data-code-language="js" data-type="programlisting"><code>    </code><code class="kd">var</code><code> </code><code class="nx">chartHolder</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nobel-bar"</code><code class="p">)</code><code class="p">;</code><code>

    </code><code class="kd">var</code><code> </code><code class="nx">margin</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="nx">top</code><code class="o">:</code><code class="mi">20</code><code class="p">,</code><code> </code><code class="nx">right</code><code class="o">:</code><code class="mi">20</code><code class="p">,</code><code> </code><code class="nx">bottom</code><code class="o">:</code><code class="mi">30</code><code class="p">,</code><code> </code><code class="nx">left</code><code class="o">:</code><code class="mi">40</code><code class="p">}</code><code class="p">;</code><code>

    </code><code class="kd">var</code><code> </code><code class="nx">boundingRect</code><code> </code><code class="o">=</code><code> </code><code class="nx">chartHolder</code><code class="p">.</code><code class="nx">node</code><code class="p">(</code><code class="p">)</code><code>
      </code><code class="p">.</code><code class="nx">getBoundingClientRect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO3-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="kd">var</code><code> </code><code class="nx">width</code><code> </code><code class="o">=</code><code> </code><code class="nx">boundingRect</code><code class="p">.</code><code class="nx">width</code><code> </code><code class="o">-</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code> </code><code class="o">-</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code><code>
    </code><code class="nx">height</code><code> </code><code class="o">=</code><code> </code><code class="nx">boundingRect</code><code class="p">.</code><code class="nx">height</code><code> </code><code class="o">-</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">top</code><code> </code><code class="o">-</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO3-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Gets the bounding rectangle for our Nobel bar chart’s panel, using it to set the width and height of its bar container group.</p></dd>
</dl></div>
<p>With the width and height of our bar group in hand, we use D3 to build our chart’s frame, appending the required <code>&lt;svg&gt;</code> and <code>&lt;g&gt;</code> tags and specifying the size of the SVG canvas and translation of the bar group:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-bar'</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'chart'</code><code class="p">,</code> <code class="kc">true</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code>
                                  <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code></pre>
<p>This changes the HTML of the <code>nobel-bar</code> content block:</p>
<pre data-code-language="html" data-type="programlisting">...
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-bar"</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">svg</code> <code class="na">width</code><code class="o">=</code><code class="s">"600"</code> <code class="na">height</code><code class="o">=</code><code class="s">"400"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">g</code> <code class="na">class</code><code class="o">=</code><code class="s">"chart"</code> <code class="na">transform</code><code class="o">=</code><code class="s">"translate(40, 20)"</code><code class="p">&gt;&lt;/</code><code class="nt">g</code><code class="p">&gt;</code>
      <code class="p">&lt;/</code><code class="nt">svg</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
...</pre>
<p>The resulting SVG framework is shown in <a data-type="xref" href="#d3bar_frame">Figure 17-8</a>.  The <code>&lt;svg&gt;</code> element’s width and height are the sum of its child group and the surrounding margins. The child group is offset using <code>transform</code> to translate it <code>margin.left</code> pixels to the right and <code>margin.top</code> pixels down (by SVG convention, in the positive y direction).</p>
<figure><div class="figure" id="d3bar_frame">
<img alt="dpj2 1708" height="575" src="assets/dpj2_1708.png" width="1290"/>
<h6><span class="label">Figure 17-8. </span>Building our bar chart’s frame</h6>
</div></figure>
<p>With our frame in place, let’s use <code>append</code> to add a few bars. We’ll use a little dummy data: an array of objects with the top slice of Nobel Prize–winning countries by prize number:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">nobelData</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'United States'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">336</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'United Kingdom'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">98</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Germany'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">79</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'France'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">60</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Sweden'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">29</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Switzerland'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">23</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Japan'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">21</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Russia'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">19</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Netherlands'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">17</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Austria'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">14</code><code class="p">}</code>
<code class="p">];</code></pre>
<p>To build a crude bar chart,<sup><a data-type="noteref" href="ch17.xhtml#idm45607747286016" id="idm45607747286016-marker">1</a></sup> we can iterate through the <code>nobelData</code> array, appending a bar to the chart group as we go. <a data-type="xref" href="#d3bar_10bars_crude_code">Example 17-2</a> demonstrates this. After building a basic frame for our chart, we iterate through the <code>nobelData</code> array, using the <code>value</code> fields to set the bar’s height and y-position. <a data-type="xref" href="#d3bar_10bars">Figure 17-9</a> shows how the object values are used to append bars to our chart group. <a data-primary="append method (D3)" data-type="indexterm" id="idm45607747245568"/>Note that because SVG uses a downward y-axis, you have to displace the bars by the height of the bar chart minus that of the bar in order to put the bar chart the right way up. As we’ll see later, by using D3’s scales, we can limit such geometric bookkeeping.</p>
<div data-type="example" id="d3bar_10bars_crude_code">
<h5><span class="label">Example 17-2. </span>Building a crude bar chart with <code>append</code></h5>
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">var</code><code> </code><code class="nx">buildCrudeBarchart</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>

    </code><code class="kd">var</code><code> </code><code class="nx">chartHolder</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nobel-bar"</code><code class="p">)</code><code class="p">;</code><code>

    </code><code class="kd">var</code><code> </code><code class="nx">margin</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="nx">top</code><code class="o">:</code><code class="mi">20</code><code class="p">,</code><code> </code><code class="nx">right</code><code class="o">:</code><code class="mi">20</code><code class="p">,</code><code> </code><code class="nx">bottom</code><code class="o">:</code><code class="mi">30</code><code class="p">,</code><code> </code><code class="nx">left</code><code class="o">:</code><code class="mi">40</code><code class="p">}</code><code class="p">;</code><code>
    </code><code class="kd">var</code><code> </code><code class="nx">boundingRect</code><code> </code><code class="o">=</code><code> </code><code class="nx">chartHolder</code><code class="p">.</code><code class="nx">node</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">getBoundingClientRect</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="kd">var</code><code> </code><code class="nx">width</code><code> </code><code class="o">=</code><code> </code><code class="nx">boundingRect</code><code class="p">.</code><code class="nx">width</code><code> </code><code class="o">-</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code> </code><code class="o">-</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code><code>
    </code><code class="nx">height</code><code> </code><code class="o">=</code><code> </code><code class="nx">boundingRect</code><code class="p">.</code><code class="nx">height</code><code> </code><code class="o">-</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">top</code><code> </code><code class="o">-</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code><code>
    </code><code class="kd">var</code><code> </code><code class="nx">barWidth</code><code> </code><code class="o">=</code><code> </code><code class="nx">width</code><code class="o">/</code><code class="nx">nobelData</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code><code>

    </code><code class="kd">var</code><code> </code><code class="nx">svg</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-bar'</code><code class="p">)</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code><code> </code><code class="nx">width</code><code> </code><code class="o">+</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code> </code><code class="o">+</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code><code> </code><code class="nx">height</code><code> </code><code class="o">+</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">top</code><code> </code><code class="o">+</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'chart'</code><code class="p">,</code><code> </code><code class="kc">true</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code><code> </code><code class="s2">"translate("</code><code> </code><code class="o">+</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code> </code><code class="o">+</code><code> </code><code class="s2">","</code><code>
        </code><code class="o">+</code><code> </code><code class="nx">margin</code><code class="p">.</code><code class="nx">top</code><code> </code><code class="o">+</code><code> </code><code class="s2">")"</code><code class="p">)</code><code class="p">;</code><code>

    </code><code class="nx">nobelData</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code> </code><code class="nx">i</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO4-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
        </code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'rect'</code><code class="p">)</code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'bar'</code><code class="p">,</code><code> </code><code class="kc">true</code><code class="p">)</code><code>
            </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'height'</code><code class="p">,</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code><code>
            </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'width'</code><code class="p">,</code><code> </code><code class="nx">barWidth</code><code class="p">)</code><code>
            </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'y'</code><code class="p">,</code><code> </code><code class="nx">height</code><code> </code><code class="o">-</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code><code>
            </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'x'</code><code class="p">,</code><code> </code><code class="nx">i</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="nx">barWidth</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO4-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Iterates through each of the objects in <code>nobelData</code>, the <code>forEach</code> method providing object and array index to an anonymous function.</p></dd>
</dl></div>
<figure><div class="figure" id="d3bar_10bars">
<img alt="dpj2 1709" height="773" src="assets/dpj2_1709.png" width="1440"/>
<h6><span class="label">Figure 17-9. </span>Programming a basic bar chart with D3</h6>
</div></figure>
<p>The other way in which D3 can add elements to the DOM tree is with its <code>insert</code> method. <code>insert</code> works like <code>append</code> but adds<a data-primary="insert method (D3)" data-type="indexterm" id="idm45607747141680"/> a second selector argument to allow you to place elements before a particular position in an sequence of tags, such as at the beginning of an ordered list. <a data-type="xref" href="#d3bar_insert">Figure 17-10</a> demonstrates the use of <code>insert</code>: list items in the <code>silly-list</code> are selected just like <code>append</code> and then a second argument (e.g., <code>':first-child'</code>) specifies the element to insert before.</p>
<figure><div class="figure" id="d3bar_insert">
<img alt="dpj2 1710" height="726" src="assets/dpj2_1710.png" width="1231"/>
<h6><span class="label">Figure 17-10. </span>Using D3’s <code>insert</code> method to add list items</h6>
</div></figure>
<p>For SVG elements, positioned directly within their parent group using x and y coordinates, <code>insert</code> might seem redundant. But, as discussed in <a data-type="xref" href="ch04.xhtml#sect_svg_layering">“Layering and Transparency”</a>, DOM ordering is important in SVG as elements are layered, meaning that the last element in the DOM tree overlays any previous. We’ll see an example of this in <a data-type="xref" href="ch19.xhtml#chapter_d3_maps">Chapter 19</a> where we have a grid overlay (or <code>graticule</code>) for our world map. We want this grid to be drawn above all other map elements so use <code>insert</code> to place those elements before it.</p>
<p>Our crude bar chart in <a data-type="xref" href="#d3bar_10bars">Figure 17-9</a> is crying out for a little refinement. Let’s see how we can improve things, first with D3’s powerful <code>scale</code> objects and then with D3’s biggest idea, data binding.<a data-primary="D3 library" data-secondary="adding DOM elements with" data-startref="ix_D3addDOM" data-type="indexterm" id="idm45607747130544"/><a data-primary="DOM (Document Object Model)" data-secondary="adding elements using D3" data-startref="ix_DOMaddD3" data-type="indexterm" id="idm45607747129328"/></p>
</div></section>
<section data-pdf-bookmark="Leveraging D3" data-type="sect1"><div class="sect1" id="idm45607747881392">
<h1>Leveraging D3</h1>
<p>In <a data-type="xref" href="#d3bar_10bars_crude_code">Example 17-2</a>, we built a basic,  no-frills bar chart with D3. This chart had a number of problems. <a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-tertiary="leveraging D3" data-type="indexterm" id="idm45607747126304"/>First, looping through the data array is a bit clunky. What if we wanted to adapt the dataset for our chart? We’d need some way of adding or removing bars in response and then updating the resulting bars with the new data and redrawing everything. We’d also need to keep scaling the bar dimensions in x and y to reflect the different number of bars and a different maximum bar value. That’s quite a lot of bookkeeping already, and things could get messy fast. Also, where do we keep the changing datasets? Every data-driven change to our chart would require passing the dataset around and then constructing a loop to iterate over elements. It feels as if the data exists outside the chained D3 workflow when it really needs to be integral to it.</p>
<p>The solution to elegantly integrating our dataset with D3 lies in the concept of data binding, D3’s biggest idea.<a data-primary="data binding in D3" data-type="indexterm" id="idm45607747124432"/> The scaling problems are sorted by one of D3’s most useful utility libraries: scale. We’ll take a look at these now and then unleash the power of D3 with some data binding.</p>
</div></section>
<section data-pdf-bookmark="Measuring Up with D3’s Scales" data-type="sect1"><div class="sect1" id="idm45607747123344">
<h1>Measuring Up with D3’s Scales</h1>
<p>The fundamental idea behind D3’s scales is a mapping from an input domain to an output range. <a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-tertiary="measuring up with D3 scales" data-type="indexterm" id="ix_D3intrscale"/><a data-primary="scales (D3)" data-type="indexterm" id="ix_scaleD3"/><a data-primary="domains" data-secondary="mapping from input domain to output range in D3 scales" data-type="indexterm" id="idm45607747119184"/><a data-primary="ranges" data-secondary="mapping from input domain to output range in D3 scales" data-type="indexterm" id="idm45607747118272"/>This simple procedure can remove a lot of the persnickety aspects of building charts, visualizations, and the like. As you get more comfortable with scales, you’ll find more and more situations where you can apply them. Mastering them is a key component to relaxed, effortless D3.</p>
<p>D3 provides a lot of scales, dividing them into three main categories: quantitative, ordinal, and time<sup><a data-type="noteref" href="ch17.xhtml#idm45607747116736" id="idm45607747116736-marker">2</a></sup> scales. There are exotic mappings to suit most conceivable situations, but you’ll probably find yourself using the linear and ordinal scales much of the time.</p>
<p>In use, D3 scales can appear slightly strange because they are part object, part function. <a data-primary="domains" data-secondary="D3 Nobel Prize bar chart" data-type="indexterm" id="idm45607747037504"/>What this means is that after creating your scale, you can call various methods on it to set its properties (e.g., <code>domain</code> to set its domain), but you can also call it as a function with a domain argument to return a range value. <a data-primary="ranges" data-secondary="D3 Nobel Prize bar chart" data-type="indexterm" id="idm45607747035696"/>The following example should make the distinction clear:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code><code> </code><code class="nx">scale</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">// create a linear scale
</code><code class="nx">scale</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">100</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO5-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="nx">scale</code><code class="p">(</code><code class="mf">0.5</code><code class="p">)</code><code> </code><code class="c1">// returns 50 </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO5-2" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO5-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We use the scale’s <code>domain</code> and <code>range</code> methods to map from 0 → 1 to 0 → 100.</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO5-2" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>We call the scale like a function with a domain argument of <code>0.5</code>, returning a range value of <code>50</code>.</p></dd>
</dl>
<p>Let’s look at the two main D3 scales, the quantitative and the ordinal, showing how we use them to build our bar chart as we go.</p>
<section data-pdf-bookmark="Quantitative Scales" data-type="sect2"><div class="sect2" id="idm45607746921280">
<h2>Quantitative Scales</h2>
<p>A D3 quantitative scale you’ll usually employ when building line charts, bar charts, scatter plots, and the like is <code>linear</code>, mapping a continuous domain to a continuous range. <a data-primary="scales (D3)" data-secondary="quantitative" data-type="indexterm" id="idm45607746918784"/><a data-primary="quantitative scales" data-type="indexterm" id="idm45607746917808"/><a data-primary="linear scale" data-type="indexterm" id="idm45607746917136"/>For example, we want our bar heights to be a linear function of the <code>nobelData</code> values. <a data-primary="quantitative scales" data-secondary="linear" data-type="indexterm" id="idm45607746915952"/>The range of values to be mapped to is between the maximum and minimum height of the bars in pixels (400 pixels to 0 pixels) and the domain to be mapped from is between the smallest conceivable value (0) and, in our case, the largest value in the array (336 US winners). In the following code, we first use D3’s <code>max</code> method to<a data-primary="max method (D3)" data-type="indexterm" id="idm45607746989840"/> get the largest value in our <code>nobelData</code> array, using that to specify the end of our domain:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">maxWinners</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">nobelData</code><code class="p">,</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code class="p">{</code><code>
                   </code><code class="k">return</code><code> </code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO6-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
                 </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>

</code><code class="kd">let</code><code> </code><code class="nx">yScale</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">(</code><code class="p">)</code><code>
                 </code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="nx">maxWinners</code><code class="p">]</code><code class="p">)</code><code> </code><code class="cm">/* [0, 336] */</code><code>
                 </code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="p">[</code><code class="nx">height</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO6-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>If there’s a chance, as is common with JSON encoded data, that the value is a string, prefixing <em>+</em> coerces it to a number.</p></dd>
</dl>
<p>One little trick to note is that our range decreases from its maximum. This is because we want to use it to specify a positive displacement along the SVG downward y-axis in order to make the bar chart’s y-axis point upward (i.e., the smaller the bar height, the larger the y displacement required). Conversely, you can see that the largest bar (the US winners tally) isn’t displaced at all (see <a data-type="xref" href="#d3bar_scales_y">Figure 17-11</a>).</p>
<figure><div class="figure" id="d3bar_scales_y">
<img alt="dpj2 1711" height="541" src="assets/dpj2_1711.png" width="1440"/>
<h6><span class="label">Figure 17-11. </span>Using D3’s linear scale to fix the domain and range of our bar chart’s y-axis</h6>
</div></figure>
<p>We’re using the simplest possible linear scale for our bar chart’s y-axis, mapping from one numeric range to another, but D3’s linear scales can do a lot more.<a data-primary="interpolate method (D3)" data-type="indexterm" id="idm45607747100608"/> The key to understanding this is D3’s <code>interpolate</code> method.<sup><a data-type="noteref" href="ch17.xhtml#idm45607747099392" id="idm45607747099392-marker">3</a></sup> This takes two values and returns an <code>interpolator</code> between them. So, for the range of our <code>yScale</code> in <a data-type="xref" href="#d3bar_scales_y">Figure 17-11</a>, <code>interpolate</code> returns a numeric <code>interpolator</code> for the values <code>400</code> and <code>0</code>:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code><code> </code><code class="nx">numInt</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">interpolate</code><code class="p">(</code><code class="mi">400</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">)</code><code class="p">;</code><code>

</code><code class="nx">numInt</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">//   400 </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO7-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="c1">
</code><code class="nx">numInt</code><code class="p">(</code><code class="mf">0.5</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">// 200
</code><code class="nx">numInt</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">//   0</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO7-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Interpolators have a default domain of [0,1].</p></dd>
</dl>
<p>The <code>interpolate</code> method can deal with more than just numbers. Strings, color codes, and even objects are handled sensibly. You can also specify more than two numbers for your domain array—just make sure that domain and range arrays are the same size.<sup><a data-type="noteref" href="ch17.xhtml#idm45607746591792" id="idm45607746591792-marker">4</a></sup> We can combine these two facts to create a useful colormap:<sup><a data-type="noteref" href="ch17.xhtml#idm45607746591168" id="idm45607746591168-marker">5</a></sup></p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">])</code>
    <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="s2">"red"</code><code class="p">,</code> <code class="s2">"green"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">]);</code>

<code class="nx">color</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code> <code class="c1">// "#008000" green's hex code</code>
<code class="nx">color</code><code class="p">(</code><code class="mf">0.5</code><code class="p">)</code> <code class="c1">// "004080" slate blue</code></pre>
<p>D3’s linear scales have a lot of useful utility methods and rich functionality. The numeric maps will probably be your workhorse scale, but I recommend reading the <a href="https://oreil.ly/lZy94">D3 docs</a> to fully appreciate how flexible the linear scales are. <a data-primary="quantitative scales" data-secondary="types of" data-type="indexterm" id="idm45607746534608"/>On that web page, you’ll find D3’s other quantitative scales, to suit almost every quantitative occasion:</p>
<ul>
<li>
<p>Power scales, similar to linear but with exponential transform (e.g., <code>sqrt</code>).</p>
</li>
<li>
<p>Log scales, similar to linear but with logarithmic transform.</p>
</li>
<li>
<p>Quantize scales, a variant of linear with a discrete range; that is, although the input is continuous, the output is divided into segments or buckets (e.g., [1, 2, 3, 4, 5]).</p>
</li>
<li>
<p>Quantile scales, often used for color palettes, are similar to quantize scales but have discrete or bucketed domains as well as ranges.</p>
</li>
<li>
<p>Identity scales, linear with the same domain and range (fairly esoteric).</p>
</li>
</ul>
<p>Quantitative scales are great for manipulating continuously valued quantities, but often we want to get values based on a discrete domain (e.g., names or categories). D3 has a specialized set of ordinal scales to meet this need.</p>
</div></section>
<section data-pdf-bookmark="Ordinal Scales" data-type="sect2"><div class="sect2" id="idm45607746920656">
<h2>Ordinal Scales</h2>
<p>Ordinal scales take an array of values as their domain and map these to discrete or continuous ranges, producing a single mapped value for each.<a data-primary="ranges" data-secondary="ordinal scale in D3" data-type="indexterm" id="idm45607746486320"/><a data-primary="ordinal scales" data-type="indexterm" id="idm45607746485472"/><a data-primary="scales (D3)" data-secondary="ordinal" data-type="indexterm" id="idm45607746484864"/> To explicitly create a one-to-one mapping, we use the scale’s <code>range</code> method:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">oScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleOrdinal</code><code class="p">()</code>
               <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">,</code> <code class="s1">'d'</code><code class="p">,</code> <code class="s1">'e'</code><code class="p">])</code>
               <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">]);</code>

<code class="nx">oScale</code><code class="p">(</code><code class="s1">'c'</code><code class="p">);</code> <code class="c1">// 3</code></pre>
<p>In the case of our bar chart, we want to map an array of indices to a continuous range, to provide our bars’ x-coordinates. <a data-primary="x-scale, setting domain and range for bar chart" data-type="indexterm" id="idm45607746480240"/><a data-primary="indices" data-secondary="mapping array of indices to a continuous range, to provide bars' x-coordinates" data-type="indexterm" id="idm45607746430304"/><a data-primary="range method (D3)" data-type="indexterm" id="idm45607746429456"/><a data-primary="scaleBand (D3)" data-type="indexterm" id="idm45607746428816"/><a data-primary="rangeRound method (D3)" data-type="indexterm" id="idm45607746428144"/>For this, we can use the band scale <code>scaleBand</code> <code>range</code> or the <code>rangeRound</code> methods, the latter snapping output values to individual pixels. Here, we use <code>rangeRound</code> to map an array of numbers to a continuous range, rounding to integer pixel values:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">oScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleBand</code><code class="p">()</code>
               <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">])</code>
               <code class="p">.</code><code class="nx">rangeRound</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">400</code><code class="p">]);</code>

<code class="nx">oScale</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code> <code class="c1">// 160</code>
<code class="nx">oScale</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code> <code class="c1">// 320</code></pre>
<p>In building our original crude bar chart (<a data-type="xref" href="#d3bar_10bars_crude_code">Example 17-2</a>), we used a <code>barWidth</code> variable to size the bars. Implementing padding between the bars would have required a padding variable and necessary adjustments to <code>barWidth</code> and the bar positions. With our new ordinal band scale, we get these things for free, removing the fiddly bookkeeping. Calling the <code>xScale</code>’s <code>bandwidth</code>  method provides the calculated bar widths. <a data-primary="padding method (D3 scales)" data-type="indexterm" id="idm45607746344640"/>We can also use the scale’s <code>padding</code> method to specify the padding between the bars as a fraction of the space occupied by each bar. The <code>bandwidth</code> value is adjusted accordingly. Here are some examples of this in action:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code><code> </code><code class="nx">oScale</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">scaleBand</code><code class="p">(</code><code class="p">)</code><code>
               </code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>

</code><code class="nx">oScale</code><code class="p">.</code><code class="nx">rangeRound</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">100</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-2" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="nx">oScale</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">// 50
</code><code class="nx">oScale</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">// 50
</code><code>

</code><code class="nx">oScale</code><code class="p">.</code><code class="nx">rangeRound</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">100</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="nx">oScale</code><code class="p">.</code><code class="nx">padding</code><code class="p">(</code><code class="mf">0.1</code><code class="p">)</code><code> </code><code class="c1">// pBpBp </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-3" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="c1">
</code><code class="nx">oScale</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">// 5
</code><code class="nx">oScale</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">// 52
</code><code class="nx">oScale</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">// 42, the padded bar width</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Stores the scale with a fixed domain; useful if we anticipate the range changing.</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-2" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p><code>rangeRound</code> snaps (rounds) the output values to integers.</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-3" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO8-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>We specify a padding (<code>p</code>) factor of <code>0.1</code> * allocated bar(<code>B</code>)-space.</p></dd>
</dl>
<p><a data-type="xref" href="#d3bar_scales_x">Figure 17-12</a> shows our bar chart’s band x-scale with a padding factor of <code>0.1</code>. The continuous range is 600 (pixels), which is the width of the bar chart, and the domain is an array of integers representing the individual bars. As shown, providing <code>xScale</code> with a bar’s index number returns its position on the x-axis.<a data-primary="domains" data-secondary="setting domain for D3 bar chart x-scale" data-type="indexterm" id="idm45607746201280"/><a data-primary="ranges" data-secondary="setting range for D3 bar chart x-sale" data-type="indexterm" id="idm45607746200432"/></p>
<figure><div class="figure" id="d3bar_scales_x">
<img alt="dpj2 1712" height="615" src="assets/dpj2_1712.png" width="1046"/>
<h6><span class="label">Figure 17-12. </span>Setting the domain and range of our bar chart’s x-scale, using a padding factor of 0.1</h6>
</div></figure>
<p>Armed with our D3 scales, let’s turn to D3’s central concept, binding data to the DOM in order to drive changes to it.<a data-primary="scales (D3)" data-startref="ix_scaleD3" data-type="indexterm" id="idm45607746197072"/><a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-startref="ix_D3intrscale" data-tertiary="measuring up with D3 scales" data-type="indexterm" id="idm45607746196096"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Unleashing the Power of D3 with Data Binding/Joining" data-type="sect1"><div class="sect1" id="idm45607746527088">
<h1>Unleashing the Power of D3 with Data Binding/Joining</h1>
<p>D3 stands for <em>Data-Driven Documents</em>, and up to now we haven’t really been driving with our data. <a data-primary="data binding in D3" data-secondary="unleashing power of D3 with" data-type="indexterm" id="idm45607746192832"/><a data-primary="Data-Driven Documents" data-see="D3 library" data-type="indexterm" id="idm45607746191776"/><a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-tertiary="unleashing power of D3 with data binding/joining" data-type="indexterm" id="idm45607746190832"/><a data-primary="joining data in D3" data-type="indexterm" id="idm45607746189616"/>In order to unleash D3, we need to embrace its big idea, which is binding or joining (both terms are used online) the data in our dataset to its respective DOM elements and updating the web page (document) based on this integration.<a data-primary="updates" data-secondary="updating web page by binding/joining data to DOM elements using D3" data-type="indexterm" id="idm45607746188816"/><a data-primary="DOM (Document Object Model)" data-secondary="binding/joining data to DOM elements in D3" data-type="indexterm" id="idm45607746187824"/> This small step of joining data to the DOM enables a huge amount of functionality when combined with the most powerful D3 methods, <code>enter</code> and <code>exit</code>.</p>
<p>After a number of iterations, D3 (version 5 and above) now provides the <code>join</code> method, which considerably simplifies the use of <code>enter</code> and <code>exit</code>. The <code>join</code> method will be the focus of this chapter.<a data-primary="enter method (D3)" data-type="indexterm" id="idm45607746183616"/><a data-primary="exit method (D3)" data-type="indexterm" id="idm45607746182912"/></p>
<p>In order to interpret the thousands of examples online that use the older <code>enter</code>, <code>exit</code>, <code>remove</code> update patterns, it helps to know a little more about what’s going on under the hood when D3 joins data. See <a data-type="xref" href="app01.xhtml#appendix">Appendix A</a> for details.</p>
</div></section>
<section data-pdf-bookmark="Updating the DOM with Data" data-type="sect1"><div class="sect1" id="d3bar_update">
<h1>Updating the DOM with Data</h1>
<p>I think it’s fair to say that using D3 to update the DOM with new data has not been particularly easy to grasp historically (footnote: You really appreciate this when you try to teach it or write a book chapter on it). <a data-primary="data binding in D3" data-secondary="updating the DOM with data" data-type="indexterm" id="idm45607746177088"/><a data-primary="updates" data-secondary="updating the DOM with data using D3" data-type="indexterm" id="ix_updDOM"/><a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-tertiary="updating the DOM with data" data-type="indexterm" id="ix_D3intrupdDOM"/><a data-primary="DOM (Document Object Model)" data-secondary="updating with data using D3" data-type="indexterm" id="ix_DOMupd"/>There have been a number of implementations such as the <a href="https://oreil.ly/sYrAG">general update pattern</a> that have themselves gone through a number of incompatible forms. This means a lot of popular examples on the web, using older version of D3, will steer you down the wrong path.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Although you may anticipate building one-off charts, with a single data-binding process, it’s good to get into the habit of asking yourself, “What if I need to change the data dynamically?” If the answer is not immediately obvious, you have probably implemented a bad D3 design. Catching yourself in the act means you can do a little code audit and make the necessary changes before things start to deteriorate. It’s good to kick yourself out of this habit, but also, because D3 is somewhat of a craft skill, constantly reaffirming that best practice will pay off when you need it.</p>
</div>
<p>The good news is that recent versions of D3 have solidified the basic methods and made them a lot simpler as well.  <a data-primary="data-joins (in D3)" data-type="indexterm" id="ix_dajoin"/><a data-primary="join method (D3)" data-type="indexterm" id="ix_joinD3"/>So employing <code>enter</code>, <code>exit</code>, and <code>remove</code>, the three key D3 methods used in data-joining, can now be done with a single <code>join</code> method, which has sensible defaults. In this section, we’ll see how to use these four methods to update our bar chart in response to new data, in this case Nobel Prize–winning countries.</p>
<p>Probably the most fundamental concept behind D3 is that of the data-join. In essence, a dataset (usually an array of data objects) is used to create some visual elements, e.g., the rectangular bars of a bar chart. Any change to this data is reflected in a changing visualization, e.g., the number of bars in the bar chart or the heights or placement of existing bars. We can break this operation into three stages:</p>
<ol class="pagebreak-before">
<li>
<p>Create a visual element for any data without one using <code>enter</code>.</p>
</li>
<li>
<p>Update the attributes and styles of these and, if required, any existing elements.</p>
</li>
<li>
<p>Remove any old visual elements that no longer have any data joined to them using the <code>exit</code>  and <code>remove</code> methods.<a data-primary="remove method (D3)" data-type="indexterm" id="idm45607746160656"/></p>
</li>
</ol>
<p>Whereas in the past D3 required you to implement the update pattern yourself, using <code>enter</code>, <code>exit</code>, and (briefly) a <code>merge</code> method, the new <a href="https://oreil.ly/4mg8b"><code>join</code></a> method combines these methods in one user-friendly package. Often you can just call it with a single argument, specifying the visual element to be joined to the data (e.g., an SVG rect or circle), but it also has more fine-grained control, allowing you to pass in <code>enter</code>, <code>exit</code>, and <code>update</code> callback functions.</p>
<p>Let’s see how easy it now is to join data and visual elements by joining some horizontal bars, constructed of SVG rectangles, to our dummy Nobel dataset. We’ll join the following dataset to the group of rectangles and use it to create some horizontal bars. You can find a working code example in <a href="https://oreil.ly/YOnzx">CodePen</a>.</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">let</code> <code class="nx">nobelData</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="s2">"United States"</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">336</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="s2">"United Kingdom"</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">98</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="s2">"Germany"</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">79</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="s2">"France"</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">60</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="s2">"Sweden"</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">29</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="s2">"Switzerland"</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">23</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="s2">"Japan"</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">21</code> <code class="p">}</code>
<code class="p">];</code></pre>
<p>We’ll use a little  HTML and CSS to create an SVG group to put the bars in and a bar class with blue fill:</p>
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-bars"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">svg</code> <code class="na">width</code><code class="o">=</code><code class="s">"600"</code> <code class="na">height</code><code class="o">=</code><code class="s">"400"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">g</code> <code class="na">class</code><code class="o">=</code><code class="s">"bars"</code> <code class="na">transform</code><code class="o">=</code><code class="s">"translate(40, 20)"</code><code class="p">&gt;&lt;/</code><code class="nt">g</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">svg</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="nc">.bar</code> <code class="p">{</code>
  <code class="k">fill</code><code class="o">:</code> <code class="nb">blue</code><code class="p">;</code>
<code class="p">}</code>
<code class="nt">&lt;/style&gt;</code></pre>
<p>With data and HTML scaffold to hand, let’s see D3’s <code>join</code> in action. We’ll create an <code>updateBars</code> function that will accept a data array of key-value countries and join it to some SVG rectangles.<a data-primary="SVG (Scalable Vector Graphics)" data-secondary="joining all existing bars data to SVG rect elements" data-type="indexterm" id="idm45607745996048"/></p>
<p>The <code>updateBars</code> function accepts a data array and first adds it to a selection of class <code>'bar'</code> using the <code>data</code> method. As seen in <a data-type="xref" href="#d3_update_bars">Example 17-3</a>, it then joins this <code>bars</code> selection to some SVG rectangles, using the <code>join</code> method.</p>
<div data-type="example" id="d3_update_bars">
<h5><span class="label">Example 17-3. </span>Joining our country data to some SVG bars</h5>
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code><code> </code><code class="nx">updateBars</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code> </code><code class="p">{</code><code>
  </code><code class="c1">// select and store the SVG bars group
</code><code>  </code><code class="kd">let</code><code> </code><code class="nx">svg</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nobel-bars g"</code><code class="p">)</code><code class="p">;</code><code>
  </code><code class="kd">let</code><code> </code><code class="nx">bars</code><code> </code><code class="o">=</code><code> </code><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".bar"</code><code class="p">)</code><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code class="p">;</code><code>

  </code><code class="nx">bars</code><code>
    </code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO9-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"bar"</code><code class="p">,</code><code> </code><code class="kc">true</code><code class="p">)</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO9-2" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code> </code><code class="nx">i</code><code class="p">)</code><code> </code><code class="p">{</code><code>
      </code><code class="k">return</code><code> </code><code class="nx">i</code><code> </code><code class="o">*</code><code> </code><code class="mi">12</code><code class="p">;</code><code>
    </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO9-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>This joins all existing bars data to SVG <code>rect</code> elements.</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO9-2" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p><code>join</code> returns all existing <code>rect</code>s, which we then update using their joined data.</p></dd>
</dl></div>
<p>After calling the <code>join</code> method, D3 is doing the sensible thing, using <code>enter</code>, <code>exit</code>, and <code>remove</code> to keep the data and visual elements in sync.<a data-primary="enter method (D3)" data-type="indexterm" id="idm45607745861744"/><a data-primary="exit method (D3)" data-type="indexterm" id="idm45607745861040"/><a data-primary="remove method (D3)" data-type="indexterm" id="idm45607745860368"/> Let’s demonstrate this by calling the <code>updateBars</code> function a few times with changing data. First, we’ll slice the first four members of our Nobel dataset and use those to update the bars:</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">updateBars</code><code class="p">(</code><code class="nx">nobelData</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">4</code><code class="p">));</code></pre>
<p>That produces the bars shown here:</p>
<p id="join_four_bars"><img alt="dpj2 17in01" height="46" src="assets/dpj2_17in01.png" width="336"/></p>
<p>Now let’s update the data-join, using only the first two members of the Nobel data array:</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">updateBars</code><code class="p">(</code><code class="nx">nobelData</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">2</code><code class="p">));</code></pre>
<p id="join_two_bars"><img alt="dpj2 17in02" height="22" src="assets/dpj2_17in02.png" width="336"/></p>
<p>Calling this method produces the two bars shown in the preceding image. Behind the scenes, D3’s bookkeeping has removed the redundant rectangles which, with a smaller dataset, are no longer joined to any data.</p>
<p>Now let’s go the other way and see what happens if we use a bigger dataset, this time the first six members of the Nobel array:</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">updateBars</code><code class="p">(</code><code class="nx">nobelData</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>
<p id="join_six_bars"><img alt="dpj2 17in03" height="70" src="assets/dpj2_17in03.png" width="336"/></p>
<p>Once again, D3 does the expected thing (see preceding image), this time appending new rectangles to join to the new data objects.</p>
<p>Having demonstrated that D3’s join successfully keeps data and visual elements in sync, adding and removing rectangles as required, we have the basis for our Nobel bar chart.<a data-primary="updates" data-secondary="updating the DOM wih data using D3" data-startref="ix_updDOM" data-type="indexterm" id="idm45607745731344"/><a data-primary="DOM (Document Object Model)" data-secondary="updating with data using D3" data-startref="ix_DOMupd" data-type="indexterm" id="idm45607745730128"/><a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-startref="ix_D3intrupdDOM" data-tertiary="updating the DOM with data" data-type="indexterm" id="idm45607745761664"/><a data-primary="data-joins (in D3)" data-startref="ix_dajoin" data-type="indexterm" id="idm45607745760240"/><a data-primary="join method (D3)" data-startref="ix_joinD3" data-type="indexterm" id="idm45607745759296"/></p>
</div></section>
<section data-pdf-bookmark="Putting the Bar Chart Together" data-type="sect1"><div class="sect1" id="d3_putting_barchart_together">
<h1>Putting the Bar Chart Together</h1>
<p>Now let’s put together what we’ve currently learned in this chapter and build the main elements of our bar chart.<a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-tertiary="putting the bar chart together" data-type="indexterm" id="ix_D3intrcht"/> We’ll be putting D3’s scales to good use here.</p>
<p>First, we’ll select the container for our bar chart by ID <em>#nobel-bar</em> and use its dimensions (from <code>boundingClientRectangle</code>) and some margin settings to get the width and height of the chart:</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">let</code> <code class="nx">chartHolder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-bar'</code><code class="p">)</code>
<code class="kd">let</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">35</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code> <code class="p">}</code>
<code class="kd">let</code> <code class="nx">boundingRect</code> <code class="o">=</code> <code class="nx">chartHolder</code><code class="p">.</code><code class="nx">node</code><code class="p">().</code><code class="nx">getBoundingClientRect</code><code class="p">()</code>
<code class="kd">let</code> <code class="nx">width</code> <code class="o">=</code> <code class="nx">boundingRect</code><code class="p">.</code><code class="nx">width</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
<code class="nx">height</code> <code class="o">=</code> <code class="nx">boundingRect</code><code class="p">.</code><code class="nx">height</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code>
<code class="c1">// some left-padding for the y-axis label</code>
<code class="kd">var</code> <code class="nx">xPaddingLeft</code> <code class="o">=</code> <code class="mi">20</code></pre>
<p>Now we’ll set our scales using the width and height:</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">let</code> <code class="nx">xScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleBand</code><code class="p">()</code>
  <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">xPaddingLeft</code><code class="p">,</code> <code class="nx">width</code><code class="p">])</code> <code class="c1">// left-padding for y-label</code>
  <code class="p">.</code><code class="nx">padding</code><code class="p">(</code><code class="mf">0.1</code><code class="p">)</code>

<code class="kd">let</code> <code class="nx">yScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">])</code></pre>
<p>Now we’ll  create our SVG chart group using width, height, and margins and store it to a variable:</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">chartHolder</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'svg'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'width'</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'height'</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'g'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'transform'</code><code class="p">,</code> <code class="s1">'translate('</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s1">','</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s1">')'</code><code class="p">)</code></pre>
<p>With our HTML and SVG scaffold in place, let’s adapt the <code>updateBars</code> function (see <a data-type="xref" href="#d3_update_bars">Example 17-3</a>) to respond to changes in our real Nobel data. The update function will receive a data array of the form:</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="p">[</code> <code class="p">{</code><code class="nx">key</code><code class="o">:</code> <code class="s1">'United States'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">336</code><code class="p">,</code> <code class="nx">code</code><code class="o">:</code> <code class="s1">'USA'</code><code class="p">}</code>
  <code class="p">{</code><code class="nx">key</code><code class="o">:</code> <code class="s1">'United Kingdom'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">98</code><code class="p">,</code> <code class="nx">code</code><code class="o">:</code> <code class="s1">'GBR'</code><code class="p">}</code>
  <code class="p">{</code><code class="nx">key</code><code class="o">:</code> <code class="s1">'Germany'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">79</code><code class="p">,</code> <code class="nx">code</code><code class="o">:</code> <code class="s1">'DEU'</code><code class="p">}</code> <code class="p">...</code> <code class="p">]</code></pre>
<p>On being called with new data, the <code>updateBarchart</code> function first filters out any zero prize-winning countries and then updates the x and y scale domains to reflect the number of bars/countries and the maximum prizes won, as seen in <a data-type="xref" href="#update_bar_chart">Example 17-4</a>.</p>
<div data-type="example" id="update_bar_chart">
<h5><span class="label">Example 17-4. </span>Updating the bar chart</h5>
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">let</code> <code class="nx">updateBarChart</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// filter out any countries with zero prizes by value</code>
  <code class="nx">data</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">&gt;</code> <code class="mi">0</code>
  <code class="p">})</code>
  <code class="c1">// change the scale domains to reflect the newly filtered data</code>
  <code class="c1">// this produces an array of country codes: ['USA', 'DEU', 'FRA' ...]</code>
  <code class="nx">xScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code> <code class="o">=&gt;</code> <code class="nx">d</code><code class="p">.</code><code class="nx">code</code><code class="p">)</code>
  <code class="p">)</code>
  <code class="c1">// we want to scale the highest number of prizes won, e.g., USA: 336</code>
  <code class="nx">yScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code>
    <code class="mi">0</code><code class="p">,</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">d</code> <code class="o">=&gt;</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code>
  <code class="p">])</code>
<code class="c1">// ...</code>
<code class="p">}</code></pre></div>
<p>With updated scales we can use a data-join to create the bars necessary for the data provided. This is essentially the same as the function shown in <a data-type="xref" href="#d3_update_bars">Example 17-3</a> but using scales to size the bars and with a customized <code>entry</code> method, to add a class and left-padding to newly minted bars:</p>
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">bars</code><code> </code><code class="o">=</code><code> </code><code class="nx">svg</code><code>
     </code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'.bar'</code><code class="p">)</code><code>
     </code><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code>
     </code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code>
       </code><code class="p">(</code><code class="nx">enter</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO10-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
         </code><code class="k">return</code><code> </code><code class="nx">enter</code><code>
           </code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'rect'</code><code class="p">)</code><code>
           </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'class'</code><code class="p">,</code><code> </code><code class="s1">'bar'</code><code class="p">)</code><code>
           </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'x'</code><code class="p">,</code><code> </code><code class="nx">xPaddingLeft</code><code class="p">)</code><code>
       </code><code class="p">}</code><code>
     </code><code class="p">)</code><code>
     </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'x'</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">code</code><code class="p">)</code><code class="p">)</code><code>
     </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'width'</code><code class="p">,</code><code> </code><code class="nx">xScale</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
     </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'y'</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code><code class="p">)</code><code>
     </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'height'</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">height</code><code> </code><code class="o">-</code><code> </code><code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO10-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We customize the <code>enter</code> method to add a <code>bar`</code> class to the rectangle. Note that we need to return the <code>enter</code> object to use after the <code>join</code> call.</p></dd>
</dl>
<p>We now have a bar chart that responds to changes in the data, initiated in this case by the user. Filtering the data for all Chemistry prizes shows the result in <a data-type="xref" href="#d3_final_chart">Figure 17-13</a>. Although lacking a few crucial elements, the hard work has been done building a bar chart. Now let’s add axes and some cool transitional effects to make the finishing touches.<a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-startref="ix_D3intrcht" data-tertiary="putting the bar chart together" data-type="indexterm" id="idm45607745136832"/></p>
<figure><div class="figure" id="d3_final_chart">
<img alt="dpj2 1713" height="167" src="assets/dpj2_1713.png" width="570"/>
<h6><span class="label">Figure 17-13. </span>Final bar chart</h6>
</div></figure>
</div></section>
<section data-pdf-bookmark="Axes and Labels" data-type="sect1"><div class="sect1" id="sect_axes_labels">
<h1>Axes and Labels</h1>
<p>Now that we have a working update pattern, we will add the axes and axes labels that any self-respecting bar chart needs<a data-primary="labels" data-secondary="axes labels in D3 chart" data-type="indexterm" id="ix_lblD3"/><a data-primary="axes" data-secondary="in D3 chart" data-secondary-sortas="D3" data-type="indexterm" id="ix_axesD3"/><a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-tertiary="axes and labels" data-type="indexterm" id="ix_D3intraxeslbl"/>.</p>
<p>D3 doesn’t offer a lot in the way of high-level chart elements, encouraging you to roll your own. But it does provide a convenient <code>axis</code> object, which takes the sting out of having to craft the SVG elements yourself. It’s easy to use and, as you would expect, plays nicely with our data update patterns, allowing for axes ticks and labels that change in response to the data presented.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45607745080192">
<h5>D3 Axes</h5>
<p>D3 axes can be confusing at first, feeling just a little bit magical. It’s best to think of them as a plug-in<sup><a data-type="noteref" href="ch17.xhtml#idm45607745078384" id="idm45607745078384-marker">6</a></sup> that generates the correct axis HTML (lines, ticks, tick labels, etc.) for you and which can respond sensibly to changes in data (i.e., if you change the range of your scales, the axes can change in response using nice, smooth transitions that look pretty cool).<a data-primary="ranges" data-secondary="changing for scales in D3, causing smooth transition in axes" data-type="indexterm" id="idm45607745076032"/></p>
<p>Generally with a D3 axis, you will create an SVG group to hold it and then call the axis on it, having set the scale it will represent. During the <code>call</code>, the axis object will <em>stamp</em> the correct HTML on the DOM. So, as a simple demo,  the following code describes a simple chart setup with an SVG <code>x-axis</code> group and a D3 axis. Calling the axis on the axis group generates the HTML lines and text needed for an axis (find a working example in <a href="https://oreil.ly/pYb4c">CodePen</a>).</p>
<pre data-code-language="html" data-type="programlisting"><code class="cp">&lt;!DOCTYPE html&gt;</code><code>
</code><code class="p">&lt;</code><code class="nt">meta</code><code> </code><code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code><code>
</code><code class="p">&lt;</code><code class="nt">script</code><code> </code><code class="na">src</code><code class="o">=</code><code class="s">"static/libs/d3.min.js"</code><code class="p">&gt;</code><code class="w">
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">script</code><code class="p">&gt;</code><code>
</code><code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code><code>
  </code><code class="nt">svg</code><code> </code><code class="p">{</code><code>
    </code><code class="k">width</code><code class="o">:</code><code> </code><code class="m">600px</code><code class="p">;</code><code>
    </code><code class="k">height</code><code class="o">:</code><code> </code><code class="m">400px</code><code>
  </code><code class="p">}</code><code>
</code><code class="nt">&lt;/style&gt;</code><code>

</code><code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">svg</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="nt">g</code><code> </code><code class="na">id</code><code class="o">=</code><code class="s">'chart'</code><code> </code><code class="na">transform</code><code class="o">=</code><code class="s">'translate(20,20)'</code><code class="p">&gt;</code><code>
      </code><code class="p">&lt;</code><code class="nt">g</code><code> </code><code class="na">id</code><code class="o">=</code><code class="s">'x-axis'</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">g</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">g</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">svg</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code><code class="w">
    </code><code class="kd">var</code><code class="w"> </code><code class="nx">scale</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">(</code><code class="p">)</code><code class="w">
      </code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="p">[</code><code class="mf">0</code><code class="p">,</code><code class="w"> </code><code class="mf">10</code><code class="p">]</code><code class="p">)</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="p">[</code><code class="mf">0</code><code class="p">,</code><code class="w"> </code><code class="mf">400</code><code class="p">]</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
    </code><code class="kd">var</code><code class="w"> </code><code class="nx">xaxis</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">scale</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-2" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
    </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#x-axis'</code><code class="p">)</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xaxis</code><code class="p">)</code><code class="w"> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-3" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
  </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">script</code><code class="p">&gt;</code><code>
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">body</code><code class="p">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Creates a scale with a domain of 0 to 10 and a range of 400 (pixels).</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-2" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Creates a D3 bottom axis, using the scale just defined.</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-3" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO11-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Calling the D3 axis on our <code>x-axis</code> group creates the axis HTML branch shown in <a data-type="xref" href="#d3bar_axis_side_html">Figure 17-15</a>, which looks like <a data-type="xref" href="#d3bar_axis_side">Figure 17-14</a>.</p></dd>
</dl>
<figure><div class="figure" id="d3bar_axis_side">
<img alt="dpj2 1714" height="56" src="assets/dpj2_1714.png" width="749"/>
<h6><span class="label">Figure 17-14. </span>A simple D3 axis</h6>
</div></figure>
<figure><div class="figure" id="d3bar_axis_side_html">
<img alt="dpj2 1715" height="253" src="assets/dpj2_1715.png" width="825"/>
<h6><span class="label">Figure 17-15. </span>The HTML branch created by a D3 axis instance</h6>
</div></figure>
<p>Using the <code>call</code> method on a selection is a common D3 technique to create plug-ins such as tooltips and brushes. There are loads of examples on <em>bl.ocks.org</em> like <a href="https://oreil.ly/J0Hrd">this one</a> by Charl Botha.  The main takeaway is that it’s not magic and it’s certainly important that you understand the basics of what’s happening during that <code>call</code> method.</p>
</div></aside>
<p>In order to define our x and y axes, we need to know what ranges and domains we want our axes to represent. In our case, it’s the same one as the ranges and domains of our x and y scales, so we supply these to the axes’ <code>scale</code> method. D3 axes also allow you to specify their orientation, which will fix the relative position of ticks and tick labels. With our bar chart, we want the x-axis on the bottom and the y-axis on the left. Our ordinal x-axis will have a label for each bar, but with our y-axis, the choice of tick numbers is arbitrary. <a data-primary="ticks method (D3)" data-type="indexterm" id="idm45607744860064"/><a data-primary="labels" data-secondary="axes labels in D3 chart" data-tertiary="format of tick labels changing with chosen metric" data-type="indexterm" id="idm45607744859360"/>Ten seems like a reasonable number, so we set that using the <code>ticks</code> method.  The following code shows how we declare our bar chart’s axes:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">xAxis</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">)</code><code>

</code><code class="kd">let</code><code> </code><code class="nx">yAxis</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code>
  </code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">yScale</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">valuePerCapita</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO12-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
      </code><code class="k">return</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">toExponential</code><code class="p">(</code><code class="p">)</code><code>
    </code><code class="p">}</code><code>
    </code><code class="k">return</code><code> </code><code class="nx">d</code><code>
  </code><code class="p">}</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO12-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We want the format of our tick labels to change with our chosen metric, per capita or absolute. Per capita produces a very small number that is best represented in exponential form (e.g., 0.000005 → 5e-6). The <code>tickFormat</code> method allows you to take the data value at each tick and return the desired tick string.</p></dd>
</dl>
<p>We’ll also need a little bit of CSS to style the axes correctly, removing the default <code>fill</code>, setting the stroke color to black, and making the shape render crisply. <a data-primary="CSS" data-secondary="styling axes in D3 bar chart" data-type="indexterm" id="idm45607744793392"/>We’ll also specify the font size and family while we’re at it:</p>
<pre data-code-language="css" data-type="programlisting"><code class="c">/* style.css */</code>
<code class="nc">.axis</code> <code class="p">{</code> <code class="k">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code> <code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="k">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="k">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
    <code class="k">shape-rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code></pre>
<p>Now that we have our <code>axis</code> generators, we need a couple of SVG groups to hold the axes they produce. Let’s add these to our main <code>svg</code> selector as groups with sensible class names:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"x axis"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code><code> </code><code class="s2">"translate(0,"</code><code> </code><code class="o">+</code><code> </code><code class="nx">height</code><code> </code><code class="o">+</code><code> </code><code class="s2">")"</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO13-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>

</code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"y axis"</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO13-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>By SVG’s convention, y is measured from the top down, so we want our <em>bottom</em>-oriented x-axis translated from the chart’s top by <em>height</em> pixels.</p></dd>
</dl>
<p>Our bar chart’s axes have fixed ranges (the width and height of the chart), but their domains will change as the user filters the dataset.<a data-primary="domains" data-secondary="changing by data filtering for D3 bar chart axes" data-type="indexterm" id="idm45607744657040"/><a data-primary="ranges" data-secondary="fixed, for D3 bar chart axes" data-type="indexterm" id="idm45607744656096"/><a data-primary="filtering data" data-secondary="in D3 bar chart" data-secondary-sortas="D3" data-type="indexterm" id="idm45607744655184"/> For example, the number of (country) bars will be reduced if the user filters the data by Economics category: this will change the domain of the ordinal x-scale (number of bars) and the quantitative y-scale (maximum number of winners). We want the displayed axes to change with these changing domains, with a nice transition for good measure.</p>
<p><a data-type="xref" href="#d3bar_axes_code">Example 17-5</a> shows how the axes are updated. First, we update our scale domains using the new data (A). These new scale domains are reflected when the axes generators (which are linked to them) are called on their respective axis groups.</p>
<div data-type="example" id="d3bar_axes_code">
<h5><span class="label">Example 17-5. </span>Updating our bar chart’s axes</h5>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">updateBarChart</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="c1">// A. Update scale domains with new data
</code><code>    </code><code class="nx">xScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code> </code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">code</code><code class="p">)</code><code> </code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="nx">yScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code><code class="p">]</code><code class="p">)</code><code>
    </code><code class="c1">// B. Use the axes generators with the new scale domains
</code><code>    </code><code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'.x.axis'</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">)</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO14-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
        </code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO14-2" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
        </code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code><code> </code><code class="s2">"end"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code><code> </code><code class="s2">"-.8em"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code><code> </code><code class="s2">".15em"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code><code> </code><code class="s2">"rotate(-65)"</code><code class="p">)</code><code class="p">;</code><code>

    </code><code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'.y.axis'</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="c1">// ...
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO14-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Calling the D3 <code>axis</code> on our x-axis group element builds all the necessary axis SVG in it, including ticks and tick labels. D3 <code>axis</code> uses an internal update pattern to enable transitions to newly bound data.</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO14-2" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>After creating the x-axis, we perform some SVG manipulations of the text labels generated.<a data-primary="labels" data-secondary="axes labels in D3 chart" data-tertiary="reoriented tick labels on x-axis" data-type="indexterm" id="idm45607744504880"/> First, we select the <code>text</code> elements of the axis, the tick labels. We then place their text anchors at the end of the element and shift their position a bit. This is because the text is rotated about its anchor and we want to rotate about the end of the country labels, now positioned under the tick lines. The result of our manipulations is shown in <a data-type="xref" href="#d3bar_x_axis">Figure 17-16</a>. Note that without rotating our labels, they would merge into one another.</p></dd>
</dl></div>
<figure><div class="figure" id="d3bar_x_axis">
<img alt="dpj2 1716" height="358" src="assets/dpj2_1716.png" width="877"/>
<h6><span class="label">Figure 17-16. </span>Reoriented tick labels on the x-axis</h6>
</div></figure>
<p>Now that we have our working axes, let’s add a little label to the x-axis and then see how the bar chart copes with our real data:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">xPaddingLeft</code><code> </code><code class="o">=</code><code> </code><code class="mi">20</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>

</code><code class="kd">let</code><code> </code><code class="nx">xScale</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">scaleBand</code><code class="p">(</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="p">[</code><code class="nx">xPaddingLeft</code><code class="p">,</code><code> </code><code class="nx">width</code><code class="p">]</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">padding</code><code class="p">(</code><code class="mf">0.1</code><code class="p">)</code><code>
</code><code class="c1">//...
</code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"y axis"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'id'</code><code class="p">,</code><code> </code><code class="s1">'y-axis-label'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code><code> </code><code class="s2">"rotate(-90)"</code><code class="p">)</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-2" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code><code> </code><code class="s2">".71em"</code><code class="p">)</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-3" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code><code> </code><code class="s2">"end"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s1">'Number of winners'</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>A left padding constant, in pixels, to make way for the y-axis label.</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-2" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Rotates the text anticlockwise to the upright position.</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-3" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO15-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p><code>dy</code> is a relative coordinate [relative to the <em>y</em> coordinate just specified (6)]. By using the <code>em</code> unit (relative to font size), we can make handy adjustments to the text margin and baseline.</p></dd>
</dl>
<p><a data-type="xref" href="#d3bar_update_lit">Figure 17-17</a> shows the result of filtering our Nobel Prize winners dataset for Chemistry winners, using our category selector filter. The bar widths increase to reflect the reduced number of countries, and both axes adapt to the new dataset.</p>
<figure><div class="figure" id="d3bar_update_lit">
<img alt="dpj2 1717" height="1174" src="assets/dpj2_1717.png" width="1440"/>
<h6><span class="label">Figure 17-17. </span>The Nobel Prize bar chart before and after we apply the category filter for Chemistry winners</h6>
</div></figure>
<p>We now have a working bar chart, using the update pattern to adjust itself as the user-driven dataset changes. But although it’s functional, the transition in response to data change is visually stark, even jarring. One way to make the change much more engaging and even informative would be to have the chart update continuously over a short time period, with preserved country bars moving from their old to new position while simultaneously adapting their height and width. Such continuous transitions really add life to a visualization and are seen in many of the most impressive D3 pieces. The good news is that transitions are tightly integrated into D3’s workflow, which means you can achieve these cool visual effects for the cost of a few lines of code.<a data-primary="labels" data-secondary="axis labels in D3 chart" data-startref="ix_lblD3" data-type="indexterm" id="idm45607744300368"/><a data-primary="axes" data-secondary="in D3 chart" data-secondary-sortas="D3" data-startref="ix_axesD3" data-type="indexterm" id="idm45607744299280"/><a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-startref="ix_D3intraxeslbl" data-tertiary="axes and labels" data-type="indexterm" id="idm45607744297952"/></p>
</div></section>
<section data-pdf-bookmark="Transitions" data-type="sect1"><div class="sect1" id="sect_transitions">
<h1>Transitions</h1>
<p>As it stands, our bar chart is perfectly functional. <a data-primary="transitions" data-secondary="D3" data-type="indexterm" id="ix_transitD3"/><a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-tertiary="transitions" data-type="indexterm" id="ix_D3intrtransit"/>It responds to data changes by adding or removing bar elements and then updating them using the new data. But the immediate change from one reflection of the data to another feels a little stark and visually <span class="keep-together">jarring</span>.</p>
<p>D3’s transitions provide the ability to smooth the visual update of our elements, making them change continuously over a set time period. This can be both aesthetically appealing and, on occasion, informative.<sup><a data-type="noteref" href="ch17.xhtml#idm45607744290752" id="idm45607744290752-marker">7</a></sup>  The important thing is that D3 transitions can be very engaging for the user, which is reason enough to want to master them.</p>
<p><a data-type="xref" href="#d3bar_transitions">Figure 17-18</a> shows the effect we are aiming at. When the bar chart is updated with a newly selected dataset, we want the bars of any countries present before and after the transition to morph smoothly from their old to new positions and dimensions.<sup><a data-type="noteref" href="ch17.xhtml#idm45607744288976" id="idm45607744288976-marker">8</a></sup> So in <a data-type="xref" href="#d3bar_transitions">Figure 17-18</a> the bar for France grows from start to finish over the course of the transition—​say, a couple of seconds—​with intermediate bars of increasing width and height. The axes ticks and labels will adapt too as the x and y scales change.</p>
<figure><div class="figure" id="d3bar_transitions">
<img alt="dpj2 1718" height="634" src="assets/dpj2_1718.png" width="558"/>
<h6><span class="label">Figure 17-18. </span>Smooth bar transitions on update</h6>
</div></figure>
<p>The effect shown in <a data-type="xref" href="#d3bar_transitions">Figure 17-18</a> is surprisingly easy to achieve but involves understanding the precise way data is joined in D3. By default, when new data is bound to existing DOM elements, it is done by array index. <a data-type="xref" href="#d3bar_data_index">Figure 17-19</a> shows how this works, using our selected bars as an example. The first bar (B0), previously bound to the USA’s data, is now bound to France’s. It stays in first position and updates its size and tick label. Essentially, the USA’s bar becomes France’s.<sup><a data-type="noteref" href="ch17.xhtml#idm45607744282224" id="idm45607744282224-marker">9</a></sup></p>
<figure><div class="figure" id="d3bar_data_index">
<img alt="dpj2 1719" height="564" src="assets/dpj2_1719.png" width="901"/>
<h6><span class="label">Figure 17-19. </span>By default, new data is joined by index</h6>
</div></figure>
<p>In order to get continuity during our transitions (i.e., for the USA bar to move to its new position while changing to its new height and width), we need the new data to be bound by a unique key, not the index.<a data-primary="data-joins (in D3)" data-secondary="getting continuity during transitions" data-type="indexterm" id="idm45607744278544"/> D3 allows you to specify a function as a second argument to the <code>data</code> method, which returns a key from the object data to use to bind the new data to the correct respective bars, assuming they still exist. <a data-type="xref" href="#d3bar_data_key">Figure 17-20</a> shows how this is done. Now, the first bar (0) is bound to the new USA data, changing its position by index as well as its width and height to that of the new American bar.</p>
<figure><div class="figure" id="d3bar_data_key">
<img alt="dpj2 1720" height="606" src="assets/dpj2_1720.png" width="901"/>
<h6><span class="label">Figure 17-20. </span>Using an object key to join new data</h6>
</div></figure>
<p>Joining the data by key gives us the correct start and endpoints for our national bars. Now all we need is a way to create a smooth transition between them. We can do this by using a couple of D3’s coolest methods, <code>transition</code> and <code>duration</code>. By calling these before we change our bar dimension and position attributes, D3 magically performs a smooth transition between them, as shown in <a data-type="xref" href="#d3bar_transitions">Figure 17-18</a>. Adding transitions to our bar chart update requires only a few lines of code:</p>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// nbviz_core.mjs
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">TRANS_DURATION</code><code> </code><code class="o">=</code><code> </code><code class="mi">2000</code><code> </code><code class="c1">// time in milliseconds
</code><code class="c1">// nbviz_bar.mjs
</code><code class="kr">import</code><code> </code><code class="nx">nbviz</code><code> </code><code class="nx">from</code><code> </code><code class="p">.</code><code class="o">/</code><code class="nx">nbviz_core</code><code class="p">.</code><code class="nx">mjs</code><code>
</code><code class="c1">//...
</code><code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'.x.axis'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">transition</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">TRANS_DURATION</code><code class="p">)</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">)</code><code> </code><code class="c1">//...
</code><code class="c1">//...
</code><code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'.y.axis'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">transition</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">TRANS_DURATION</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="c1">//...
</code><code class="kd">var</code><code> </code><code class="nx">bars</code><code> </code><code class="o">=</code><code> </code><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".bar"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">code</code><code class="p">)</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-2" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="c1">//...
</code><code class="kd">let</code><code> </code><code class="nx">bars</code><code> </code><code class="o">=</code><code> </code><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'.bar'</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">code</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code>
   </code><code class="c1">// ...
</code><code>  </code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="k">return</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code> </code><code class="o">===</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">activeCountry</code><code>
  </code><code class="p">}</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">transition</code><code class="p">(</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">TRANS_DURATION</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">code</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-3" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
  </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code><code> </code><code class="nx">xScale</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">height</code><code> </code><code class="o">-</code><code> </code><code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>A transition with duration of two seconds, which is our <code>TRANS_DURATION</code> constant of 2000 (ms).</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-2" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Using the data object’s <code>code</code> property to make the continuous data-joins.</p></dd>
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-3" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO16-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The <code>x</code>, <code>y</code>, <code>width</code>, and <code>height</code> attributes will be smoothly morphed from current values to those defined here.<a data-primary="DOM (Document Object Model)" data-secondary="D3 transitions on existing elements" data-type="indexterm" id="idm45607744054480"/></p></dd>
</dl>
<p>Transitions will work on most obvious attributes and styles of an existing DOM element.<sup><a data-type="noteref" href="ch17.xhtml#idm45607744053184" id="idm45607744053184-marker">10</a></sup></p>
<p>The transitions just shown perform a smooth change of the attributes from starting point to end goal, but D3 allows for a lot of tuning for these effects.  <a data-primary="delay method (D3)" data-type="indexterm" id="idm45607744051824"/>You can, for example, use the <code>delay</code> method to specify the time before the transition starts. This delay can also be a function of the data.</p>
<p>Probably the most<a data-primary="ease method (D3)" data-type="indexterm" id="idm45607743968336"/> useful extra transitioning method is <code>ease</code>, which allows you to specify the way in which the elements’ attributes are updated over the transition’s duration. The default easing function is <a href="https://oreil.ly/zP5FO"><code>CubicInOut</code></a>, but you can also specify things like <code>quad</code>, which speeds things up as the transition progresses, or <code>bounce</code> and <code>elastic</code>, which do pretty much what it says on the tin, giving a bouncy feel to the change. There’s also <code>sin</code>, which speeds up at the beginning and slows down toward the end. See <a class="orm:hideurl" href="https://easings.net"><em>easings.net</em></a> for a nice description of different easing functions and <a href="https://oreil.ly/crI0I">observablehq</a> for a comprehensive runthrough of D3’s easing functions, assisted by interactive charts.</p>
<p>If the easing functions available to D3 don’t suit your needs or you’re feeling particularly ambitious, as with most things D3 you can roll your own to fit any subtle requirements. The <code>tween</code> method provides the fine-grained control you might need.<a data-primary="tween method (D3)" data-type="indexterm" id="idm45607743962160"/></p>
<p>With a working <code>join</code>-based update pattern and some cool transitions, we have completed our Nobel-viz bar chart. There’s always room for refinement, but this bar chart will more than do the job. Let’s summarize what we’ve learned in this rather large chapter before moving on to the other components of our Nobel Prize visualization.</p>
<section data-pdf-bookmark="Updating the Bar Chart" data-type="sect2"><div class="sect2" id="idm45607743960656">
<h2>Updating the Bar Chart</h2>
<p>When the bar chart module is imported, it appends a callback function to the callbacks array in the core module. <a data-primary="updates" data-secondary="updating the bar chart in D3" data-type="indexterm" id="idm45607743959392"/>When data is updated in response to user interaction, this callback function is called and the bar chart updated with new country data:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">callbacks</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO17-1" id="co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO17-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code class="kd">let</code><code> </code><code class="nx">data</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">getCountryData</code><code class="p">(</code><code class="p">)</code><code>
  </code><code class="nx">updateBarChart</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code>
</code><code class="p">}</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO17-1" id="callout_introducing_d3__8212___8203_the_story_of_a_bar_chart_CO17-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>This anonymous function is called in the core module when data is updated.</p></dd>
</dl>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45607743931296">
<h1>Summary</h1>
<p>This has been a large and quite challenging chapter. <a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-startref="ix_D3intrtransit" data-tertiary="transitions" data-type="indexterm" id="idm45607743930000"/><a data-primary="transitions" data-secondary="D3" data-startref="ix_transitD3" data-type="indexterm" id="idm45607743928512"/>D3 isn’t the easiest library to learn, but I have smoothed the learning curve by breaking things down into digestible chunks. Take your time absorbing the fundamental ideas and, crucially, start setting yourself little objectives to stretch your D3 knowledge. I think D3 is very much an art form and, more than most libraries, one learns while doing.</p>
<p>The key elements to understanding D3 and applying it effectively are the update pattern and the data binding involved.  If you understand this at a fundamental level, most of D3’s other pyrotechnics slot nicely into place. Focus on the <code>data</code>, <code>enter</code>, <code>exit</code>, and <code>remove</code> methods and make sure you really understand what’s going on. It’s the only way to advance from much of the cut-and-paste style of D3 programming, which is initially productive (there being so many cool examples out there), but will eventually frustrate. Use your browser’s developer console (currently Chrome and Chromium have the best tools here) to inspect DOM elements, to see what data is bound to them via the <code>__data__</code> variable. If it doesn’t match your expectations, you’ll learn a lot by finding out why.</p>
<p>You should now have a pretty good grounding in D3’s core techniques. In the next chapter, we’ll aim to challenge those new skills with a rather more ambitious chart, our Nobel Prize timeline.<a data-primary="D3 library" data-secondary="introduction to, building a bar chart" data-startref="ix_D3intr" data-type="indexterm" id="idm45607743895696"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45607747286016"><sup><a href="ch17.xhtml#idm45607747286016-marker">1</a></sup> We’ll be dealing with axes, labels, and the like later in the chapter when we put D3 into top gear and start binding data.</p><p data-type="footnote" id="idm45607747116736"><sup><a href="ch17.xhtml#idm45607747116736-marker">2</a></sup> See <a href="https://oreil.ly/xiKUs">D3’s GitHub page</a> for a comprehensive list.</p><p data-type="footnote" id="idm45607747099392"><sup><a href="ch17.xhtml#idm45607747099392-marker">3</a></sup> See <a href="https://oreil.ly/2IXaF">the D3 docs</a> for full details.</p><p data-type="footnote" id="idm45607746591792"><sup><a href="ch17.xhtml#idm45607746591792-marker">4</a></sup> D3 will truncate whichever is bigger.</p><p data-type="footnote" id="idm45607746591168"><sup><a href="ch17.xhtml#idm45607746591168-marker">5</a></sup> D3 has many built-in colormaps and sophisticated color handling with RGB, HCL, etc. We’ll see a few of these in action in the coming chapters.</p><p data-type="footnote" id="idm45607745078384"><sup><a href="ch17.xhtml#idm45607745078384-marker">6</a></sup> Axes follow a similar pattern to that proposed by Mike Bostock in <a href="https://oreil.ly/FOEoe"><em>Towards Reusable Charts</em></a>, using the JavaScript objects’ <a href="https://oreil.ly/4vVp3"><code>call</code></a> method to build HTML on the selected DOM element(s).</p><p data-type="footnote" id="idm45607744290752"><sup><a href="ch17.xhtml#idm45607744290752-marker">7</a></sup> For example, when we change our measurement of Nobel Prize wins by country from absolute to per capita, the large amount of movement displayed as the country bars change their order emphasizes the difference between the two metrics.</p><p data-type="footnote" id="idm45607744288976"><sup><a href="ch17.xhtml#idm45607744288976-marker">8</a></sup> In animation and computer graphics circles, this effect is known as <em>tweening</em> (see <a href="https://oreil.ly/vr9QY">this Wikipedia page</a>).</p><p data-type="footnote" id="idm45607744282224"><sup><a href="ch17.xhtml#idm45607744282224-marker">9</a></sup> See Mike Bostock’s nice demonstration of object constancy at <a href="https://oreil.ly/QZuYK">his site</a>.</p><p data-type="footnote" id="idm45607744053184"><sup><a href="ch17.xhtml#idm45607744053184-marker">10</a></sup> Transitions only apply to existing elements—you can’t fade in the creation of a DOM element, for example. You could, however, fade it in and out using the <code>opacity</code> CSS style.</p></div></div></section></div></body></html>