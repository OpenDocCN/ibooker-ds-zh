<html><head></head><body>
<p id="filepos1487255" class="calibre_"><span class="calibre2"><span class="bold"><span class="calibre_15">Chapter 11. The Python Package Tracker</span></span></span></p><p class="calibre_16">In this <a/>chapter, we will create a typical business application that downloads data from the internet and stores it in a database before visualizing it in Excel. This will help you understand what role xlwings plays in such an application and allows you to see how easy it is to connect to external systems with Python. In an attempt to build a project that is close to a real-world application yet relatively simple to follow, I have come up with the <span class="italic">Python Package Tracker</span>, an Excel tool that shows the number of releases per year for a given Python package. Despite being a case study, you might actually find the tool useful to understand if a certain Python package is being actively developed or not.</p><p class="calibre_6">After getting acquainted with the application, we’ll go through a few topics that we need to understand to be able to follow its code: we’ll see how we can download data from the internet and how we can interact with databases before we learn about exception handling in Python, an important concept when it comes to application development. Once we’re done with these preliminaries, we’ll go through the components of the Python Package Tracker to see how everything fits together. To wrap this chapter up, we’ll look into how debugging xlwings code works. Like the last two chapters, this chapter requires you to have an installation of Microsoft Excel on either Windows or macOS. Let’s get started by taking the Python Package Tracker for a test drive!</p><p id="filepos1488972" class="calibre_17"><span class="calibre3"><span class="bold"><span class="calibre_7">What We Will Build</span></span></span></p><p class="calibre_6">Head over <a id="filepos1489144"/>to the companion repository, where you will find the <span class="italic">packagetracker</span> folder. There are a couple of files in that folder, but for now just open the Excel file <span class="italic">packagetracker.xlsm</span> and head over to the Database sheet: we first need to get some data into the database to have something to work with. As shown in <a href="#filepos1490382"><span class="calibre_7">Figure 11-1</span></a>, type in a package name, for example “xlwings,” then click on Add Package. You can choose any package name that exists on <a id="filepos1489666"/>the <a href="https://pypi.org"><span class="calibre_7">Python Package Index</span></a> (PyPI).</p><blockquote class="calibre_25"><span class="bold"><span class="calibre_29">MACOS: CONFIRM ACCESS TO FOLDER</span></span></blockquote><blockquote class="calibre_27"><span class="calibre5">When you add the very first package on macOS, you will have to confirm a pop-up so that the application can access the </span><span class="calibre5"><span class="italic">packagetracker</span></span><span class="calibre5"> folder. This is the same pop-up we already came across in </span><a href="index_split_024.html#filepos1235764"><span class="calibre5"><span class="calibre_7">Chapter 9</span></span></a><span class="calibre5">.</span></blockquote><p class="calibre_3"><img src="images/00051.jpg" id="filepos1490382" class="calibre_106"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 11-1. The Python Package Tracker (Database sheet)</span></span></span></p><p class="calibre_24">If everything works according to plan, you will see the message “Added xlwings successfully” to the right of where you typed in the package name. Also, you will see a Last updated timestamp under the Update Database section as well as an updated Log section where it says that it downloaded xlwings successfully and stored it to the database. Let’s do this one more time and add the pandas package so we have some more data to play around with. Now, switch to the Tracker sheet and select xlwings from the dropdown in cell B5 before clicking on Show History. Your screen should now look similar to <a href="#filepos1491484"><span class="calibre_7">Figure 11-2</span></a>, showing the latest release of the package as well as a chart with the number of releases over the years.</p><p class="calibre_21"><img src="images/00068.jpg" id="filepos1491484" class="calibre_107"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 11-2. The Python Package Tracker (Tracker sheet)</span></span></span></p><p class="calibre_24">You could now go back to the Database sheet and add additional packages. Whenever you want to update the database with the latest information from PyPI, click on the Update Database button: this will synchronize your database with the latest data <a id="filepos1492009"/>from PyPI.</p><p class="calibre_6">After taking a look at how the Python Package Tracker works from a user’s perspective, let’s now introduce its core functionality.</p><p id="filepos1492209" class="calibre_17"><span class="calibre3"><span class="bold"><span class="calibre_7">Core Functionality</span></span></span></p><p class="calibre_6">In this section, I will introduce you to the core functionality of the Python Package Tracker: how to fetch data via web APIs and how to query databases. I’ll also show you how to handle exceptions, a topic that will inevitably arise when writing application code. Let’s get started with web APIs!</p><p id="filepos1492676" class="calibre_17"><span class="calibre3"><span class="bold">Web APIs</span></span></p><p class="calibre_6">Web APIs <a id="filepos1492808"/>are one of the most popular ways for an application to fetch data from the internet: API stands<a id="filepos1492910"/> for <span class="italic">application programming interface</span> and defines how you interact with an application programmatically. A web API, therefore, is an API that is accessed over a network, usually the internet. To understand how web APIs work, let’s take a step back and see what happens (in simplified terms) when you open a web page in your browser: after entering a URL into the address bar, your browser sends <a id="filepos1493322"/>a <span class="italic">GET request</span> to the server, asking for the web page you want. A GET request is a method of the HTTP protocol that your browser uses to communicate with the server. When the server receives the request, it responds by sending back the requested HTML document, which your browser displays: <span class="italic">voilà</span>, your web page has loaded. The HTTP protocol has various other methods; the most common one—apart from the GET request—is the <span class="italic">POST request</span>, <a id="filepos1493790"/>which is used to send data to the server (for example, when you fill in a contact form on a web page).</p><p class="calibre_6">While it makes sense for servers to send back a nicely formatted HTML page to interact with humans, applications don’t care about design and are only interested in the data. Therefore, a GET request to a web API works like requesting a web page, but you usually get back the data<a id="filepos1494225"/> in <span class="italic">JSON</span> instead of HTML format. JSON stands for <span class="italic">JavaScript Object Notation</span> and is a data structure that is understood by pretty much every programming language, which makes it ideal to exchange data between different systems. Although the notation is using JavaScript syntax, it’s very close to how you use (nested) dictionaries and lists in Python. The differences are the following:</p><div class="calibre_8"> </div><ul class="calibre_9"><li value="1" class="calibre_13"><blockquote class="calibre_18"><blockquote class="calibre4"><blockquote class="calibre4"><blockquote class="calibre_19">JSON only accepts double quotes for strings</blockquote></blockquote></blockquote></blockquote></li><li value="2" class="calibre_10"><blockquote class="calibre_18"><blockquote class="calibre4"><blockquote class="calibre4"><blockquote class="calibre_19">JSON uses <tt class="calibre6">null</tt> where Python uses <tt class="calibre6">None</tt></blockquote></blockquote></blockquote></blockquote></li><li value="3" class="calibre_10"><blockquote class="calibre_18"><blockquote class="calibre4"><blockquote class="calibre4"><blockquote class="calibre_19">JSON uses lowercase <tt class="calibre6">true</tt> and <tt class="calibre6">false</tt> while they are capitalized in Python</blockquote></blockquote></blockquote></blockquote></li><li value="4" class="calibre_10"><blockquote class="calibre_18"><blockquote class="calibre4"><blockquote class="calibre4"><blockquote class="calibre_19">JSON only accepts strings as keys whereas Python dictionaries accept a wide range of objects as keys</blockquote></blockquote></blockquote></blockquote></li></ul><p class="calibre_14">The <tt class="calibre6">json</tt> module<a id="filepos1495827"/> from the standard library allows you to convert a Python dictionary to a JSON string and vice versa:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">json</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">2</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># A Python dictionary...</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">user_dict</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">{</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"name"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Jane Doe"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                     </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"age"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">23</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                     </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"married"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_58">False</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                     </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"children"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_58">None</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                     </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"hobbies"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"hiking"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"reading"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]}</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">3</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># ...converted to a JSON string</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># by json.dumps ("dump string"). The "indent" parameter is</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># optional and prettifies the printing.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">user_json</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">json</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">dumps</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">user_dict</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">indent</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">4</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">user_json</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">{<br class="calibre1"/>    "name": "Jane Doe",<br class="calibre1"/>    "age": 23,<br class="calibre1"/>    "married": false,<br class="calibre1"/>    "children": null,<br class="calibre1"/>    "hobbies": [<br class="calibre1"/>        "hiking",<br class="calibre1"/>        "reading"<br class="calibre1"/>    ]<br class="calibre1"/>}</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">4</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Convert the JSON string back to a native Python data structure</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">json</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loads</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">user_json</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[4]: {'name': 'Jane Doe',<br class="calibre1"/>         'age': 23,<br class="calibre1"/>         'married': False,<br class="calibre1"/>         'children': None,<br class="calibre1"/>         'hobbies': ['hiking', 'reading']}</tt></span></blockquote><blockquote class="calibre_25"><span class="bold">REST API</span></blockquote><blockquote class="calibre_27">Instead of<a id="filepos1503021"/> web API, you will often see the term <span class="italic">REST</span> or <span class="italic">RESTful</span> API. REST stands for <span class="italic">representational state transfer</span> and defines a web API that adheres to certain constraints. At its core, the idea of REST is that you access information in the form of <span class="italic">stateless resources</span>. Stateless<a id="filepos1503328"/> means that every request to a REST API is completely independent of any other request and needs to always provide the full set of information that it requests. Note that the term <span class="italic">REST API</span> is often misused to mean any sort of web API, even if it doesn’t adhere to the REST constraints.</blockquote><p class="calibre_17">Consuming<a id="filepos1503692"/> web APIs is usually really simple (we’ll see how this works with Python in a moment), and almost every service offers one. If you want to download your favorite Spotify playlist, you would issue the following GET request (see the <a href="https://oreil.ly/zcyUh"><span class="calibre_7">Spotify Web API Reference</span></a>):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>GET https://api.spotify.com/v1/playlists/</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">playlist_id</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span></blockquote><p class="calibre_32">Or, if you want to get information about your latest Uber trips, you would run the following GET request (see the <a href="https://oreil.ly/FTp-Y"><span class="calibre_7">Uber REST API</span></a>):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">GET https://api.uber.com/v1.2/history</tt></span></blockquote><p class="calibre_32">To use these<a id="filepos1504690"/> APIs, though, you need to be authenticated, which usually means that you require an account and a token that you can send along with your requests. For the Python Package Tracker, we’ll need to fetch data from PyPI to get information about the releases of a specific package. Fortunately, PyPI’s web API doesn’t require any authentication, so we have one thing less to worry about. When you have a look at the <a href="https://oreil.ly/yTVjL"><span class="calibre_7">PyPI JSON API docs</span></a>, you will see that there are only<a id="filepos1505232"/> two <span class="italic">endpoints</span>, i.e., URL fragments that are appended to the common <span class="italic">base URL</span>, <a href="https://pypi.org/pypi"><span class="italic"><span class="calibre_7">https://pypi.org/pypi</span></span></a>:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>GET /</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">project_name</span></tt></span><span class="calibre5"><tt class="calibre6">/json<br class="calibre1"/>GET /</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">project_name</span></tt></span><span class="calibre5"><tt class="calibre6">/</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">version</span></tt></span><span class="calibre5"><tt class="calibre6">/json<br class="calibre1"/></tt></span></blockquote><p class="calibre_32">The second endpoint gives you the same information as the first one, but for a specific version only. For the Python Package Tracker, the first endpoint is all we need to get the details about the past releases of a package, so let’s see how this works. In Python, a simple way to interact with a web API is by using the <a id="filepos1506175"/>Requests package that comes preinstalled with Anaconda. Run the following commands to fetch PyPI data about pandas:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">5</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">requests</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">6</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">response</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">requests</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">get</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"https://pypi.org/pypi/pandas/json"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">response</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">status_code</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[6]: 200</tt></span></blockquote><p class="calibre_32">Every response comes with an <a id="filepos1508263"/>HTTP status code: for example, <tt class="calibre6">200</tt> means <span class="italic">OK</span> and <tt class="calibre6">404</tt> means <span class="italic">Not Found</span>. You can look up the full list of HTTP response status codes in the <a href="https://oreil.ly/HySVq"><span class="calibre_7">Mozilla web docs</span></a>. You may be familiar with the status code <tt class="calibre6">404</tt> as your browser sometimes displays it when you click on a dead link or type in an address that doesn’t exist. Similarly, you will also get a <tt class="calibre6">404</tt> status code if you run a GET request with a package name that doesn’t exist on PyPI. To look at the content of the response, it’s easiest to call the <tt class="calibre6">json</tt> method of the response object, which will transform the JSON string of the response into a Python dictionary:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">7</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">response</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">json</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_32">The response is very long, so I am printing a short subset here to allow you to understand the structure:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[7]: {<br class="calibre1"/>            'info': {<br class="calibre1"/>                'bugtrack_url': None,<br class="calibre1"/>                'license': 'BSD',<br class="calibre1"/>                'maintainer': 'The PyData Development Team',<br class="calibre1"/>                'maintainer_email': 'pydata@googlegroups.com',<br class="calibre1"/>                'name': 'pandas'<br class="calibre1"/>            },<br class="calibre1"/>            'releases': {<br class="calibre1"/>                '0.1': [<br class="calibre1"/>                    {<br class="calibre1"/>                        'filename': 'pandas-0.1.tar.gz',<br class="calibre1"/>                        'size': 238458,<br class="calibre1"/>                        'upload_time': '2009-12-25T23:58:31'<br class="calibre1"/>                    },<br class="calibre1"/>                    {<br class="calibre1"/>                        'filename': 'pandas-0.1.win32-py2.5.exe',<br class="calibre1"/>                        'size': 313639,<br class="calibre1"/>                        'upload_time': '2009-12-26T17:14:35'<br class="calibre1"/>                    }<br class="calibre1"/>                ]<br class="calibre1"/>            }<br class="calibre1"/>        }</tt></span></blockquote><p class="calibre_32">To get a list with all releases and their dates, something we need for the Python Package Tracker, we can run the following code to loop through the <tt class="calibre6">releases</tt> dictionary:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">8</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">releases</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[]</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">for</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">version</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">files</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_15">in</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">response</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">json</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">'releases'</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">items</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">():</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>            </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">releases</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">append</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"{version}: {files[0]['upload_time']}"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">releases</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[:</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">3</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># show the first 3 elements of the list</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[8]: ['0.1: 2009-12-25T23:58:31',<br class="calibre1"/>         '0.10.0: 2012-12-17T16:52:06',<br class="calibre1"/>         '0.10.1: 2013-01-22T05:22:09']</tt></span></blockquote><p class="calibre_32">Note that we are arbitrarily picking the release timestamp from the package that appears first in the list. A specific release often has multiple packages to account for different versions of Python and operating systems. To wrap this topic up, you may remember from <a href="index_split_015.html#filepos482650"><span class="calibre_7">Chapter 5</span></a> that pandas has a <tt class="calibre6">read_json</tt> method to return a DataFrame directly from a JSON string. This, however, wouldn’t help us here as the response from PyPI isn’t in a structure that can be directly transformed into a DataFrame.</p><p class="calibre_6">This was a short introduction <a id="filepos1515072"/>to web APIs to understand their use in the code base of the Python Package Tracker. Let’s now see how we can communicate with databases, the other external system that we make use of in our application!</p><p id="filepos1515287" class="calibre_17"><span class="calibre3"><span class="bold">Databases</span></span></p><p class="calibre_6">To be <a id="filepos1515417"/>able to use the data from PyPI even when you’re not connected to the internet, you need to store it after downloading. While you could store your JSON responses as text files on disk, a far more comfortable solution is to use a database: this allows you to query your data in an easy way. The Python Package Tracker is using <a href="https://sqlite.org"><span class="calibre_7">SQLite</span></a>, <a id="filepos1515821"/>a <span class="italic">relational database</span>. Relational database systems get their name from <span class="italic">relation</span>, which refers to the database table itself (and not to the relation between tables, which is a common misconception): their highest goal is data integrity, which they achieve by splitting the data up into different tables (a process called <span class="italic">normalization</span>) and<a id="filepos1516187"/> by applying constraints to avoid inconsistent and redundant data. Relational databases use SQL (Structured Query Language) to perform database queries and are among the most <a id="filepos1516369"/>popular server-based relational database systems are <a href="https://oreil.ly/XZOI9"><span class="calibre_7">SQL Server</span></a>, <a href="https://oreil.ly/VKWE0"><span class="calibre_7">Oracle</span></a>, <a href="https://oreil.ly/VAEqY"><span class="calibre_7">PostgreSQL</span></a>, and <a href="https://mysql.com"><span class="calibre_7">MySQL</span></a>. As an Excel user, you may also be familiar with the file-based <a href="https://oreil.ly/bRh6Q"><span class="calibre_7">Microsoft Access</span></a> database.</p><blockquote class="calibre_39"><span class="bold">NOSQL DATABASES</span></blockquote><blockquote class="calibre_27">These <a id="filepos1517033"/>days, relational databases have strong competition from <span class="italic">NoSQL</span> databases that store redundant data in an attempt to achieve the following advantages:</blockquote><blockquote class="calibre_27"><span class="italic">No table joins</span></blockquote><blockquote class="calibre_18"><blockquote class="calibre_19">Since relational databases split their data across multiple tables, you often need to combine the information from two or more tables by <span class="italic">joining</span> them, which sometimes can be slow. This is not required with NoSQL databases, which can result in better performance for certain types of queries.</blockquote><a id="filepos1517665"/></blockquote><blockquote class="calibre_1"><span class="italic">No database migrations</span></blockquote><blockquote class="calibre_18"><blockquote class="calibre_19">With relational database systems, every time you make a change to the table structure, e.g., by adding a new column to a table, you must run a database <span class="italic">migration</span>. A migration is a script that brings the database into the desired new structure. This makes the deployment of new versions of an application more complex, potentially resulting in downtime, something that is easier to avoid with NoSQL databases.</blockquote><a id="filepos1518267"/></blockquote><blockquote class="calibre_1"><span class="italic">Easier to scale</span></blockquote><blockquote class="calibre_18"><blockquote class="calibre_19">NoSQL databases are easier to distribute across multiple servers as there are no tables that are dependent on each other. This means that an application that uses a NoSQL database may scale better when your user base skyrockets.</blockquote></blockquote><blockquote class="calibre_33">NoSQL databases come in many flavors: some databases are simple key-value stores, i.e., work similarly to a dictionary in Python (e.g., <a href="https://redis.io"><span class="calibre_7">Redis</span></a>); <a id="filepos1518942"/>others allow the storage of documents, often in JSON format (e.g., <a href="https://mongodb.com"><span class="calibre_7">MongoDB</span></a>). Some databases even combine the relational and NoSQL worlds: PostgreSQL, which happens to be one of the most popular databases in the Python community, is traditionally a relational database but also allows you to store data in JSON format—without losing the ability to query it via SQL.</blockquote><p class="calibre_17">SQLite, the<a id="filepos1519443"/> database we’re going to use, is a file-based database like Microsoft Access. However, in contrast to Microsoft Access, which only works on Windows, SQLite works on all platforms that Python supports. On the other hand, SQLite doesn’t allow you to build a user interface like Microsoft Access, but Excel comes in handy for <a id="filepos1519777"/> this part.</p><p class="calibre_6">Let’s now have a look at the structure of the Package Tracker’s database before finding out how we can use Python to connect to databases and make SQL queries. Then, to conclude this introduction about databases, we’ll have a look at SQL injections, a popular vulnerability of database-driven applications.</p><p class="calibre_20"><span class="bold"><span class="calibre_5">The Package Tracker database</span></span></p><p class="calibre_6">The <a id="filepos1520310"/>database of the Python Package Tracker couldn’t be any simpler as it only has two tables: the table <tt class="calibre6">packages</tt> stores the package name and the table <tt class="calibre6">package_versions</tt> stores the version strings and the date of the upload. The two tables can be joined on the <tt class="calibre6">package_id</tt>: rather than storing the <tt class="calibre6">package_name</tt> with every row in the <tt class="calibre6">package_versions</tt> table, it has been <span class="italic">normalized</span> into<a id="filepos1520748"/> the <tt class="calibre6">packages</tt> table. This gets rid of redundant data—name changes, for example, only have to be done in a single field across the entire database. To get a better idea about how the database looks with the xlwings and pandas packages loaded, have a look at Tables <a href="#filepos1521167"><span class="calibre_7">11-1</span></a> and <a href="#filepos1522247"><span class="calibre_7">11-2</span></a>.</p><p class="calibre1" style="margin:0pt; border:0pt; height:1em"> </p><table valign="top" id="filepos1521167" class="calibre_47"><caption valign="top" class="calibre_48"><span class="italic">Table 11-1. The packages table</span></caption><tr valign="top" class="calibre_49"><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> package_id </span></span><span class="bold">
</span></th><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> package_name </span></span><span class="bold">
</span></th></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">1</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">xlwings</tt></span></p></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">pandas</tt></span></p></td></tr></table><p class="calibre1" style="margin:0pt; border:0pt; height:1em"> </p><table valign="top" id="filepos1522247" class="calibre_47"><caption valign="top" class="calibre_48"><span class="italic">Table 11-2. The package_versions table (first three rows of each package_id)</span></caption><tr valign="top" class="calibre_49"><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> package_id </span></span><span class="bold">
</span></th><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> version_string </span></span><span class="bold">
</span></th><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> uploaded_at </span></span><span class="bold">
</span></th></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">1</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">0.1.0</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2014-03-19 18:18:49.000000</tt></span></p></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">1</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">0.1.1</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2014-06-27 16:26:36.000000</tt></span></p></td></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">1</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">0.2.0</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2014-07-29 17:14:22.000000</tt></span></p></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">...</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">...</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">...</tt></span></p></td></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">0.1</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2009-12-25 23:58:31.000000</tt></span></p></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">0.2beta</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2010-05-18 15:05:11.000000</tt></span></p></td></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">0.2b1</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">2010-05-18 15:09:05.000000</tt></span></p></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">...</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">...</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">...</tt></span></p></td></tr></table><p class="calibre_17"><a href="#filepos1528772"><span class="calibre_7">Figure 11-3</span></a> is a database diagram that shows the two tables again schematically. You can read off the table and column names and get information about the primary and foreign keys:</p><p class="calibre_6"><span class="italic">Primary key</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">Relational databases require every table to have a <span class="italic">primary key</span>. A primary key is one or more columns that uniquely identify a row (a row is also called a <span class="italic">record</span>). In the case of the <tt class="calibre6">packages</tt> table, the primary key is <tt class="calibre6">package_id</tt> and in the case of the <tt class="calibre6">package_versions</tt> table, the primary key is a so-called <span class="italic">composite key</span>, i.e., a combination of <tt class="calibre6">package_id</tt> and <tt class="calibre6">version_string</tt>.</blockquote><a id="filepos1527951"/></blockquote><p class="calibre_20"><span class="italic">Foreign key</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">The column <tt class="calibre6">package_id</tt> in the <tt class="calibre6">package_versions</tt> table is a <span class="italic">foreign key</span> to the same column in the <tt class="calibre6">packages</tt> table, symbolized by the line that connects the tables: a foreign key is a constraint that, in our case, ensures that every <tt class="calibre6">package_id</tt> in the <tt class="calibre6">package_versions</tt> table exists in the <tt class="calibre6">packages</tt> table—this guarantees data integrity. The branches at the right end of the connection line symbolize the nature of the relationship: one <tt class="calibre6">package</tt> can have many <tt class="calibre6">package_versions</tt>, which is called a <span class="italic">one-to-many</span> relationship.</blockquote><a id="filepos1528709"/></blockquote><p class="calibre_3"><img src="images/00041.jpg" id="filepos1528772" class="calibre_108"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 11-3. Database diagram (primary keys are bold)</span></span></span></p><p class="calibre_24">To have a look at the content of the database tables and run SQL queries, you could install a VS Code extension <a id="filepos1529158"/>called SQLite (please see the <a href="https://oreil.ly/nP4mC"><span class="calibre_7">SQLite extension docs</span></a> for more details) or use a dedicated SQLite management software, of which there are plenty. We, however, will be using<a id="filepos1529401"/> Python to run SQL queries. Before anything else, let’s see how we can connect to a database!</p><p class="calibre_20"><span class="bold"><span class="calibre_5">Database connections</span></span></p><p class="calibre_6">To <a id="filepos1529652"/>connect to a database from Python, you need a <span class="italic">driver</span>, i.e., a Python package that knows how to communicate with the database you are using. Each database requires a different driver and each driver uses a different syntax, but luckily, there is a powerful package called <a href="https://sqlalchemy.org"><span class="calibre_7">SQLAlchemy</span></a> that abstracts away most of the differences between the various databases and drivers. SQLAlchemy is mostly used as <a id="filepos1530130"/>an <span class="italic">object relational mapper</span> (ORM) that translates your database records into Python objects, a concept that many developers—albeit not all—find more natural to work with. To keep things simple, we’re ignoring the ORM functionality and only using SQLAlchemy to make it easier to run raw SQL queries. SQLAlchemy is also used behind the scenes when you use pandas to read and write database tables in the form of DataFrames. Running a database query from pandas involves three levels of packages—pandas, SQLAlchemy, and the database driver—as shown in <a href="#filepos1530880"><span class="calibre_7">Figure 11-4</span></a>. You can run database queries from each of these three levels.</p><p class="calibre_21"><img src="images/00057.jpg" id="filepos1530880" class="calibre_109"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 11-4. Accessing databases from Python</span></span></span></p><p class="calibre_24"><a href="#filepos1531478"><span class="calibre_7">Table 11-3</span></a> shows you which driver SQLAlchemy uses by default (some databases can be used with more than one driver). It also gives you the format of the database connection string—we’ll use the connection string in a moment when we will run actual SQL queries.</p><p class="calibre1" style="margin:0pt; border:0pt; height:1em"> </p><table valign="top" id="filepos1531478" class="calibre_47"><caption valign="top" class="calibre_48"><span class="italic">Table 11-3. SQLAlchemy default drivers and connection strings</span></caption><tr valign="top" class="calibre_49"><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> Database </span></span><span class="bold">
</span></th><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> Default Driver </span></span><span class="bold">
</span></th><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> Connection String </span></span><span class="bold">
</span></th></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">SQLite </span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">sqlite3</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">sqlite:///</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">filepath</span></tt></span></p></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">PostgreSQL </span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">psycopg2</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">postgresql://</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">username</span></tt></span><span class="calibre5"><tt class="calibre6">:</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">password</span></tt></span><span class="calibre5"><tt class="calibre6">@</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">host</span></tt></span><span class="calibre5"><tt class="calibre6">:</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">port</span></tt></span><span class="calibre5"><tt class="calibre6">/</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">database</span></tt></span></p></td></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">MySQL </span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">mysql-python</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">mysql://</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">username</span></tt></span><span class="calibre5"><tt class="calibre6">:</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">password</span></tt></span><span class="calibre5"><tt class="calibre6">@</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">host</span></tt></span><span class="calibre5"><tt class="calibre6">:</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">port</span></tt></span><span class="calibre5"><tt class="calibre6">/</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">database</span></tt></span></p></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">Oracle </span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">cx_oracle</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">oracle://</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">username</span></tt></span><span class="calibre5"><tt class="calibre6">:</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">password</span></tt></span><span class="calibre5"><tt class="calibre6">@</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">host</span></tt></span><span class="calibre5"><tt class="calibre6">:</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">port</span></tt></span><span class="calibre5"><tt class="calibre6">/</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">database</span></tt></span></p></td></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">SQL Server </span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">pyodbc</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">mssql+pyodbc://</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">username</span></tt></span><span class="calibre5"><tt class="calibre6">:</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">password</span></tt></span><span class="calibre5"><tt class="calibre6">@</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">host</span></tt></span><span class="calibre5"><tt class="calibre6">:</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">port</span></tt></span><span class="calibre5"><tt class="calibre6">/</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic">database</span></tt></span></p></td></tr></table><p class="calibre_17">Except for SQLite, you usually need a password to connect to a database. And since connection strings are URLs, you will have to use the URL encoded version of your passwords if you have any special characters in them. Here is how you can print the URL encoded version of your password:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">9</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">urllib.parse</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">10</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">urllib</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">parse</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">quote_plus</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"pa$$word"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[10]: 'pa%24%24word'</tt></span></blockquote><p class="calibre_32">Having introduced pandas, <a id="filepos1537920"/>SQLAlchemy, and the database driver as the three levels from which we can connect to databases, let’s see how they compare in practice by making a few SQL queries!</p><p class="calibre_20"><span class="bold"><span class="calibre_5">SQL queries</span></span></p><p class="calibre_6">Even<a id="filepos1538233"/> if you are new to SQL, you should have no trouble understanding the few SQL queries that I will use in the following samples and in the Python Package Tracker. SQL is <a id="filepos1538408"/>a <span class="italic">declarative language</span>, which means that you tell the database <span class="italic">what you want</span> instead of <span class="italic">what to do</span>. Some queries almost read like plain English:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">SELECT</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">*</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">FROM</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">packages</span></tt></span></blockquote><p class="calibre_32">This tells the database that you want to <span class="italic">select all columns from the packages table</span>. In production code, you wouldn’t want to use the wildcard <tt class="calibre6">*</tt> which means <span class="italic">all columns</span> but rather specify each column explicitly as this makes your query less error-prone:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">SELECT</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_id</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_name</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">FROM</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">packages</span></tt></span></blockquote><blockquote class="calibre_25"><span class="bold"><span class="calibre_26">DATABASE QUERIES VS. PANDAS DATAFRAMES</span></span></blockquote><blockquote class="calibre_27"><span class="calibre5">SQL is a </span><a id="filepos1540168"/><span class="calibre5"><span class="italic">set-based</span></span><span class="calibre5"> language, which means that you operate on a set of rows rather than looping through individual rows. This is very similar to how you work with pandas DataFrames. The SQL query:</span></blockquote><blockquote class="calibre_46"><blockquote class="calibre_19"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">SELECT</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_id</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_name</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">FROM</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">packages</span></tt></span></blockquote></blockquote><blockquote class="calibre_31"><span class="calibre5">corresponds to the following pandas expression (assuming that </span><span class="calibre5"><tt class="calibre6">packages</tt></span><span class="calibre5"> is a DataFrame):</span></blockquote><blockquote class="calibre_46"><blockquote class="calibre_19"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">packages</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[:,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"package_id"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"package_name"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]]</span></tt></span></blockquote></blockquote><p class="calibre_16">The following code samples use the <span class="italic">packagetracker.db</span> file that you will find in the <span class="italic">packagetracker</span> folder of the companion repo. The examples expect that you have already added xlwings and pandas to the database via the Python Package Tracker’s Excel frontend like we did at the beginning of this chapter—otherwise you would get only empty results. Following <a href="#filepos1530880"><span class="calibre_7">Figure 11-4</span></a> from bottom to top, we will first make our SQL query from the driver directly, then use SQLAlchemy and finally pandas:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">11</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Let's start with the imports</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">sqlite3</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">from</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">sqlalchemy</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">create_engine</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">pandas</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">pd</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">12</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Our SQL query: "select all columns from the packages table"</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sql</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"SELECT * FROM packages"</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">13</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Option 1: Database driver (sqlite3 is part of the standard library)</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Using the connection as context manager automatically commits</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># the transaction or rolls it back in case of an error.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">with</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sqlite3</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">connect</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"packagetracker/packagetracker.db"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">con</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">cursor</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">con</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">cursor</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># We need a cursor to run SQL queries</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">cursor</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">execute</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">fetchall</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Return all records</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[13]: [(1, 'xlwings'), (2, 'pandas')]</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">14</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Option 2: SQLAlchemy</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># "create_engine" expects the connection string of your database.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Here, we can execute a query as a method of the connection object.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">create_engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"sqlite:///packagetracker/packagetracker.db"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">with</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">connect</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">con</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">con</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">execute</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">fetchall</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[14]: [(1, 'xlwings'), (2, 'pandas')]</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">15</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Option 3: pandas</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Providing a table name to "read_sql" reads the full table.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Pandas requires an SQLAlchemy engine that we reuse from</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># the previous example.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">df</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">read_sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"packages"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index_col</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"package_id"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">df</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[15]:            package_name<br class="calibre1"/>         package_id<br class="calibre1"/>         1               xlwings<br class="calibre1"/>         2                pandas</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">16</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># "read_sql" also accepts an SQL query</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">read_sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index_col</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"package_id"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[16]:            package_name<br class="calibre1"/>         package_id<br class="calibre1"/>         1               xlwings<br class="calibre1"/>         2                pandas</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">17</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># The DataFrame method "to_sql" writes DataFrames to tables</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># "if_exists" has to be either "fail", "append" or "replace"</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># and defines what happens if the table already exists</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">df</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">to_sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"packages2"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">con</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">if_exists</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"append"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">18</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># The previous command created a new table "packages2" and</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># inserted the records from the DataFrame df as we can</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># verify by reading it back</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">read_sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"packages2"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index_col</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"package_id"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[18]:            package_name<br class="calibre1"/>         package_id<br class="calibre1"/>         1               xlwings<br class="calibre1"/>         2                pandas</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">19</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Let's get rid of the table again by running the</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># "drop table" command via SQLAlchemy</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">with</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">connect</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">con</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">con</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">execute</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"DROP TABLE packages2"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><p class="calibre_32">Whether you should use the database driver, SQLAlchemy, or pandas to run your queries largely depends on your preferences: I personally like the fine-grained control you get by using SQLAlchemy and enjoy that I can use the same syntax with different databases. On the other hand, pandas’ <tt class="calibre6">read_sql</tt> is convenient to get the result of a query in the form of a DataFrame.</p><blockquote class="calibre_25"><span class="bold"><span class="calibre_29">FOREIGN KEYS WITH SQLITE</span></span></blockquote><blockquote class="calibre_27"><span class="calibre5">Somewhat surprisingly, SQLite does not respect foreign keys by default when running queries. However, if you use SQLAlchemy, you can easily enforce foreign keys; see the </span><a id="filepos1562373"/><a href="https://oreil.ly/6YPvC"><span class="calibre5"><span class="calibre_7">SQLAlchemy docs</span></span></a><span class="calibre5">. This will also work if you run the queries from pandas. You will find the respective code at the top of the </span><span class="calibre5"><span class="italic">database.py</span></span><span class="calibre5"> module in the </span><span class="calibre5"><span class="italic">packagetracker</span></span><span class="calibre5"> folder of the companion repository.</span></blockquote><p class="calibre_16">Now that you know how to run simple<a id="filepos1562882"/> SQL queries, let’s wrap this section up by looking at SQL injections, which can pose a security risk to your application.</p><p class="calibre_20"><span class="bold"><span class="calibre_5">SQL injection</span></span></p><p class="calibre_6">If you<a id="filepos1563158"/> don’t protect your SQL queries properly, a malicious user can run arbitrary SQL code by injecting SQL statements into data input fields: for example, instead of selecting a package name like xlwings in the dropdown of the Python Package Tracker, they could send an SQL statement that changes your intended query. This can expose sensitive information or perform destructive actions like deleting a table. How can you prevent this? Let’s first have a look at the following database query, which the Package Tracker runs when you select xlwings and click on Show History:<a id="filepos1563739"/><a href="#filepos1652489"><span class="calibre5"><span class="calibre_7">1</span></span></a></p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">SELECT</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">v</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">uploaded_at</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">v</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">version_string</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">FROM</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">packages</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">p</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">INNER</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">JOIN</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_versions</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">v</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">ON</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">p</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_id</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">v</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_id</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">WHERE</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">p</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_id</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span></blockquote><p class="calibre_32">This query joins the two tables together and only returns those rows where the <tt class="calibre6">package_id</tt> is <tt class="calibre6">1</tt>. To help you understand this query based on what we learned in <a href="index_split_015.html#filepos482650"><span class="calibre_7">Chapter 5</span></a>, if <tt class="calibre6">packages</tt> and <tt class="calibre6">package_versions</tt> were pandas DataFrames, you could write:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">df</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">packages</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">merge</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_versions</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">how</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"inner"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">on</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"package_id"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">df</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">loc</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">df</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"package_id"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">==</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"uploaded_at"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"version_string"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]]</span></tt></span></blockquote><p class="calibre_32">It’s obvious that the <tt class="calibre6">package_id</tt> needs to be a variable where we now have a hardcoded <tt class="calibre6">1</tt> to return the correct rows depending on the package that is selected. Knowing about f-strings from <a href="index_split_010.html#filepos178328"><span class="calibre_7">Chapter 3</span></a>, you could be tempted to change the last line of the SQL query like this:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"WHERE p.package_id = {package_id}"</span></tt></span></blockquote><p class="calibre_32">While this would technically work, you must never do this as it opens up the door for SQL injection: for example, somebody could send <tt class="calibre6">'1 OR TRUE'</tt> instead of an integer representing the <tt class="calibre6">package_id</tt>. The resulting query would return the rows of the whole table instead of just those where the <tt class="calibre6">package_id</tt> is <tt class="calibre6">1</tt>. Therefore, always use the syntax that SQLAlchemy offers you for placeholders (they start with a colon):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">20</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Let's start by importing SQLAlchemy's text function</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">from</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">sqlalchemy.sql</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">text</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">21</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># ":package_id" is the placeholder</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sql</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"""</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">         SELECT v.uploaded_at, v.version_string</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">         FROM packages p</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">         INNER JOIN package_versions v ON p.package_id = v.package_id</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">         WHERE p.package_id = :package_id</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">         ORDER BY v.uploaded_at</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">         """</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">22</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Via SQLAlchemy</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">with</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">connect</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">con</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">con</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">execute</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">text</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">),</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_id</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">fetchall</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[:</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">3</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Print the first 3 records</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[22]: [('2014-03-19 18:18:49.000000', '0.1.0'),<br class="calibre1"/>          ('2014-06-27 16:26:36.000000', '0.1.1'),<br class="calibre1"/>          ('2014-07-29 17:14:22.000000', '0.2.0')]</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">23</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Via pandas</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>         </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">pd</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">read_sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">text</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sql</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">),</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">parse_dates</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"uploaded_at"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">],</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                     </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">params</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">{</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"package_id"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">},</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                     </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">index_col</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"uploaded_at"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">])</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">head</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">3</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Out[23]:                     version_string<br class="calibre1"/>         uploaded_at<br class="calibre1"/>         2014-03-19 18:18:49          0.1.0<br class="calibre1"/>         2014-06-27 16:26:36          0.1.1<br class="calibre1"/>         2014-07-29 17:14:22          0.2.0</tt></span></blockquote><p class="calibre_32">Wrapping<a id="filepos1579180"/> the SQL query with SQLAlchemy’s <tt class="calibre6">text</tt> function has the advantage that you can use the same syntax for placeholders across different databases. Otherwise, you’d have to use the placeholder that the database driver uses: <tt class="calibre6">sqlite3</tt> uses <tt class="calibre6">?</tt> and <tt class="calibre6">psycopg2</tt> uses <tt class="calibre6">%s</tt>, for example.</p><p class="calibre_6">You may argue that SQL injection isn’t much of an issue when your users have direct access to Python and could run arbitrary code on the database anyway. But if you take your xlwings prototype and transform it into a web application one day, it will become a huge issue, so it’s better to do it properly from the beginning.</p><p class="calibre_6">Besides web APIs and <a id="filepos1579942"/>databases, there is another topic that we have jumped over so far that is indispensable for solid application development: exception handling. Let’s see how it works!</p><p id="filepos1580121" class="calibre_17"><span class="calibre3"><span class="bold">Exceptions</span></span></p><p class="calibre_6">I mentioned<a id="filepos1580257"/> exception handling in <a href="index_split_007.html#filepos32075"><span class="calibre_7">Chapter 1</span></a> as an example of where VBA with its <span class="italic">GoTo</span> mechanism has fallen behind. In this section, I show you how Python uses the <span class="italic">try/except</span> mechanism to handle errors in your programs. Whenever something is outside of your control, errors can and will happen. For example, the email server may be down when you try to send an email, or a file may be missing that your program expects—in the case of the Python Package Tracker, this could be the database file. Dealing with user input is another area where you have to prepare for inputs that don’t make sense. Let’s get some practice—if the following function is called with a zero, you will get a <tt class="calibre6">ZeroDivisionError</tt>:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">24</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">def</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_62">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">number</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">):</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">/</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">number</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"The reciprocal is: {result}"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">25</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">0</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6">  </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># This will raise an error</span></span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">---------------------------------------------------------------------------<br class="calibre1"/>ZeroDivisionError                         Traceback (most recent call last)<br class="calibre1"/>&lt;ipython-input-25-095f19ebb9e9&gt; in &lt;module&gt;<br class="calibre1"/>----&gt; 1 print_reciprocal(0)  # This will raise an error<br class="calibre1"/><br class="calibre1"/>&lt;ipython-input-24-88fdfd8a4711&gt; in print_reciprocal(number)<br class="calibre1"/>      1 def print_reciprocal(number):<br class="calibre1"/>----&gt; 2     result = 1 / number<br class="calibre1"/>      3     print(f"The reciprocal is: {result}")<br class="calibre1"/><br class="calibre1"/>ZeroDivisionError: division by zero</tt></span></blockquote><p class="calibre_32">To let your program react gracefully to such errors, use the try/except statements (this is the equivalent of the VBA sample in <a href="index_split_007.html#filepos32075"><span class="calibre_7">Chapter 1</span></a>):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">26</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">def</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_62">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">number</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">):</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">try</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">/</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">number</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">except</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_110">Exception</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">e</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># "as e" makes the Exception object available as variable "e"</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># "repr" stands for "printable representation" of an object</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># and gives you back a string with the error message</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"There was an error: {repr(e)}"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"N/A"</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">else</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"There was no error!"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">finally</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"The reciprocal is: {result}"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><p class="calibre_32">Whenever an error occurs in the <tt class="calibre6">try</tt> block, code execution moves on to the <tt class="calibre6">except</tt> block where you can handle the error: this allows you to give the user helpful feedback or write the error to a log file. The <tt class="calibre6">else</tt> clause only runs if there is no error raised during the <tt class="calibre6">try</tt> block and the <tt class="calibre6">finally</tt> block runs always, whether or not an error was raised. Often, you will get away with just the <tt class="calibre6">try</tt> and <tt class="calibre6">except</tt> blocks. Let’s see the output of the function given different inputs:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">27</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">10</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">There was no error!<br class="calibre1"/>The reciprocal is: 0.1</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">28</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"a"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">There was an error: TypeError("unsupported operand type(s) for /: 'int'<br class="calibre1"/> and 'str'")<br class="calibre1"/>The reciprocal is: N/A</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">29</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">0</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">There was an error: ZeroDivisionError('division by zero')<br class="calibre1"/>The reciprocal is: N/A</tt></span></blockquote><p class="calibre_32">The way that I have used the except statement means that any exception that happens in the <tt class="calibre6">try</tt> block will cause the code execution to continue in the <tt class="calibre6">except</tt> block. Usually, that is not what you want. You want to check for an error as specific as possible and handle only those you expect. Your program may otherwise fail for something completely unexpected, which makes it hard to debug. To fix this, rewrite the function as follows, checking explicitly for the two errors that we expect (I am leaving away the <tt class="calibre6">else</tt> and <tt class="calibre6">finally</tt> statements):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">30</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">def</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_62">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">number</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">):</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">try</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">/</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">number</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"The reciprocal is: {result}"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">except</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_110">TypeError</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_110">ZeroDivisionError</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">):</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Please type in any number except 0."</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><p class="calibre_32">Let’s run the code again:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">31</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"a"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Please type in any number except 0.</tt></span></blockquote><p class="calibre_32">If you want to handle an error differently depending on the exception, handle them separately:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">32</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">def</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_62">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">number</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">):</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">try</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">result</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">/</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">number</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"The reciprocal is: {result}"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">except</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_110">TypeError</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Please type in a number."</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>             </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">except</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_110">ZeroDivisionError</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                 </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">print</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"The reciprocal of 0 is not defined."</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">33</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"a"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">Please type in a number.</tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">In</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">34</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">print_reciprocal</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">0</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6">The reciprocal of 0 is not defined.</tt></span></blockquote><p class="calibre_32">Now that you know about<a id="filepos1601081"/> error handling, web APIs, and databases, you are ready to move on to the next section, where we’ll go through each component of the Python Package Tracker.</p><p id="filepos1601250" class="calibre_17"><span class="calibre3"><span class="bold"><span class="calibre_7">Application Structure</span></span></span></p><p class="calibre_6">In <a id="filepos1601418"/>this section, we’ll look behind the scenes of the Python Package Tracker to understand how everything works. First, we’ll walk through the application’s frontend, i.e., the Excel file, before looking at its backend, i.e., the Python code. To wrap this section up, we’ll see how debugging an xlwings project works, a useful skill with projects of the size and complexity of the Package Tracker.</p><p class="calibre_6">In the <span class="italic">packagetracker</span> directory in the companion repo, you’ll find four files. Do you remember when I talked <a id="filepos1601989"/>about <span class="italic">separation of concerns</span> in <a href="index_split_007.html#filepos32075"><span class="calibre_7">Chapter 1</span></a>? We are now able to map these files to the different layers as shown in <a href="#filepos1602253"><span class="calibre_7">Table 11-4</span></a>:</p><p class="calibre1" style="margin:0pt; border:0pt; height:1em"> </p><table valign="top" id="filepos1602253" class="calibre_47"><caption valign="top" class="calibre_48"><span class="italic">Table 11-4. Separation of concerns</span></caption><tr valign="top" class="calibre_49"><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> Layer </span></span><span class="bold">
</span></th><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> File </span></span><span class="bold">
</span></th><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> Description </span></span><span class="bold">
</span></th></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">Presentation layer </span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">packagetracker.xlsm</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">This is the frontend and as such the only file the end-user interacts with. </span></p></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">Business layer </span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">packagetracker.py</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">This module handles the data download via web API and does the number crunching with pandas. </span></p></td></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">Data layer </span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">database.py</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">This module handles all database queries. </span></p></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">Database </span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">packagetracker.db</tt></span></p></td><td class="calibre_51"><span class="calibre5"> </span><p class="calibre_6"><span class="calibre5">This is an SQLite database file. </span></p></td></tr></table><p class="calibre_17">In this context, it’s worth mentioning that the presentation layer, i.e., the Excel file, doesn’t contain a single cell formula, which makes the tool much easier to audit and control.</p><blockquote class="calibre_39"><span class="bold">MODEL-VIEW-CONTROLLER (MVC)</span></blockquote><blockquote class="calibre_27">Separation of concerns has many faces and the breakdown as shown in <a href="#filepos1602253"><span class="calibre_7">Table 11-4</span></a> is just one possibility. Another popular design pattern that you may run into relatively quickly is<a id="filepos1605468"/> called <span class="italic">model-view-controller</span> (MVC). In the MVC world, the core of the application is the <span class="italic">model</span> where all the data and usually most of the business logic is handled. While the <span class="italic">view</span> corresponds to the presentation layer, the <span class="italic">controller</span> is only a thin layer that sits between the model and the view to make sure that they are always in sync. To keep things simple, I am not using the MVC pattern in this book.</blockquote><p class="calibre_17">Now that you know what each file is responsible for, let’s move on and have a closer look at how the Excel frontend has been set up!</p><p id="filepos1606102" class="calibre_17"><span class="calibre3"><span class="bold">Frontend</span></span></p><p class="calibre_6">When <a id="filepos1606230"/>you build a web application, you differentiate between <a id="filepos1606292"/>the <span class="italic">frontend</span>, which is the part of the application that runs in your browser, and <a id="filepos1606388"/>the <span class="italic">backend</span>, which is the code that runs on the server. We can apply the same terminology with xlwings tools: the frontend is the Excel file and the backend is the Python code that you call via <tt class="calibre6">RunPython</tt>. If you want to build the frontend from scratch, begin with running the following command on an Anaconda Prompt (make sure to <tt class="calibre6">cd</tt> first into the directory of your choice):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>(base)&gt; </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold">xlwings quickstart packagetracker</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span></blockquote><p class="calibre_32">Navigate to the <span class="italic">packagetracker</span> directory and open <span class="italic">packagetracker.xlsm</span> in Excel. Start by adding the three tabs, Tracker, Database and Dropdown, as shown in <a href="#filepos1607351"><span class="calibre_7">Figure 11-5</span></a>.</p><p class="calibre_21"><img src="images/00024.jpg" id="filepos1607351" class="calibre_111"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 11-5. Building the user interface</span></span></span></p><p class="calibre_24">While you should be able to take over the text and formatting from <a href="#filepos1607351"><span class="calibre_7">Figure 11-5</span></a>, I need to give you a few more details about the things that aren’t visible:</p><p class="calibre_6"><span class="italic">Buttons</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">To make the tool look a bit less like Windows 3.1, I didn’t use the standard macro buttons that we used in the previous chapter. Instead, I went to Insert &gt; Shapes and inserted a Rounded Rectangle. If you want to use the standard button, that’s fine, too, but at this point, don’t assign a macro just yet.</blockquote></blockquote><p class="calibre_20"><span class="italic">Named ranges</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">To make the tool a little easier to maintain, we will use named ranges rather than cell addresses in the Python code. Therefore, add the named ranges as shown in <a href="#filepos1608689"><span class="calibre_7">Table 11-5</span></a>.</blockquote><a id="filepos1608660"/></blockquote><p class="calibre1" style="margin:0pt; border:0pt; height:1em"> </p><table valign="top" id="filepos1608689" class="calibre_47"><caption valign="top" class="calibre_48"><span class="italic">Table 11-5. Named ranges</span></caption><tr valign="top" class="calibre_49"><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> Sheet </span></span><span class="bold">
</span></th><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> Cell </span></span><span class="bold">
</span></th><th valign="top" class="calibre_50"><span class="calibre5"><span class="bold"> Name </span></span><span class="bold">
</span></th></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">Tracker </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">B5 </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">package_selection</tt></span></blockquote></blockquote></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">Tracker </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">B11 </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">latest_release</tt></span></blockquote></blockquote></td></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">Database </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">B5 </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">new_package</tt></span></blockquote></blockquote></td></tr><tr valign="top" class="calibre_52"><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">Database </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">B13 </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">updated_at</tt></span></blockquote></blockquote></td></tr><tr valign="top" class="calibre_49"><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">Database </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5">B18 </span></blockquote></blockquote></td><td class="calibre_51"><span class="calibre5"> </span><blockquote class="calibre4"><blockquote class="calibre_19"><span class="calibre5"> </span><span class="calibre5"><tt class="calibre6">log</tt></span></blockquote></blockquote></td></tr></table><blockquote class="calibre_112"><blockquote class="calibre_19">One way to add named ranges is to select the cell, then write the name into the Name Box and finally confirm by hitting Enter, as in <a href="#filepos1612557"><span class="calibre_7">Figure 11-6</span></a>.</blockquote></blockquote><blockquote class="calibre_100"><blockquote class="calibre_101"><img src="images/00019.jpg" class="calibre_113"/>
</blockquote><a id="filepos1612557"/></blockquote><blockquote class="calibre_103"><blockquote class="calibre_101"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 11-6. The Name Box</span></span></span></blockquote></blockquote><p class="calibre_32"><span class="italic">Tables</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">On the Dropdown sheet, after typing “packages” into cell A1, select A1, then go to Insert &gt; Table and make sure to activate the checkbox next to “My table has headers.” To finalize, with the table selected, go to the ribbon tab Table Design (Windows) or Table (macOS) and rename the table from <tt class="calibre6">Table1</tt> to <tt class="calibre6">dropdown_content</tt>, as shown in <a href="#filepos1613484"><span class="calibre_7">Figure 11-7</span></a>.</blockquote><a id="filepos1613315"/></blockquote><blockquote class="calibre_100"><blockquote class="calibre_101"><img src="images/00010.jpg" class="calibre_114"/>
</blockquote><a id="filepos1613484"/></blockquote><blockquote class="calibre_103"><blockquote class="calibre_101"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 11-7. Renaming an Excel table</span></span></span></blockquote></blockquote><p class="calibre_32"><span class="italic">Data Validation</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">We use data validation to provide the dropdown in cell B5 on the Tracker sheet. To add it, select cell B5, then go to Data &gt; Data Validation and under Allow, select List. Under source set the following formula:</blockquote><a id="filepos1614044"/></blockquote><blockquote class="calibre_46"><blockquote class="calibre_19"><span class="calibre5"><tt class="calibre6">=INDIRECT("dropdown_content[packages]")</tt></span></blockquote></blockquote><blockquote class="calibre_46"><blockquote class="calibre_19">Then, confirm with OK. This is just a reference to the body of the table, but since Excel doesn’t accept a table reference directly, we have to wrap it in an <tt class="calibre6">INDIRECT</tt> formula, which resolves the table to its address. Still, by using a table, it will properly resize the range that is shown in the dropdown when we add more packages.</blockquote></blockquote><p class="calibre_20"><span class="italic">Conditional Formatting</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">When you add a package, there can be a few errors that we’d like to show to the user: the field could be empty, the package may already exist on the database, or it may be missing on PyPI. To show the error in red and other messages in black, we’ll use a simple trick based on conditional formatting: we want a red font whenever the message contains the word “error.” On the Database sheet, select cell C5, which is where we’ll write out the message. Then go to Home &gt; Conditional Formatting &gt; Highlight Cells Rules &gt; Text that contains. Enter the value <tt class="calibre6"><span class="bold">error</span></tt> and select Red Text in the dropdown as shown in <a href="#filepos1615769"><span class="calibre_7">Figure 11-8</span></a>, then click on OK. Apply the same conditional format to cell C5 on the Tracker sheet.</blockquote><a id="filepos1615600"/></blockquote><blockquote class="calibre_100"><blockquote class="calibre_101"><img src="images/00029.jpg" class="calibre_115"/>
</blockquote><a id="filepos1615769"/></blockquote><blockquote class="calibre_103"><blockquote class="calibre_101"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 11-8. Conditional Formatting on Windows (left) and macOS (right)</span></span></span></blockquote></blockquote><p class="calibre_32"><span class="italic">Gridlines</span></p><blockquote class="calibre_18"><blockquote class="calibre_19">On the Tracker and Database sheets, the gridlines have been hidden by unchecking the View checkbox under Page Layout &gt; Gridlines.</blockquote><a id="filepos1616277"/></blockquote><p class="calibre_16">At this point, the user interface is complete and should look like <a href="#filepos1607351"><span class="calibre_7">Figure 11-5</span></a>. We now need to add the <tt class="calibre6">RunPython</tt> calls in the VBA editor and <a id="filepos1616544"/>connect them with the buttons. Click Alt+F11 (Windows) or Option-F11 (macOS) to open the VBA editor, then, under the VBAProject of <span class="italic">packagetracker.xlsm</span>, double-click Module1 on the lefthand side under Modules to open it. Delete the existing <tt class="calibre6">SampleCall</tt> code and replace it with the following macros:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">Sub</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_62">AddPackage</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">RunPython</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"import packagetracker; packagetracker.add_package()"</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">End</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">Sub</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">Sub</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_62">ShowHistory</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">RunPython</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"import packagetracker; packagetracker.show_history()"</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">End</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">Sub</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">Sub</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_62">UpdateDatabase</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">RunPython</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"import packagetracker; packagetracker.update_database()"</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">End</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">Sub</span></span></tt></span></blockquote><p class="calibre_32">Next, right-click on each button, select Assign Macro and select the macro that corresponds to the button. <a href="#filepos1619526"><span class="calibre_7">Figure 11-9</span></a> shows the Show History button, but it works the same for the Add Package and Update Database buttons.</p><p class="calibre_21"><img src="images/00037.jpg" id="filepos1619526" class="calibre_116"/>
</p><p class="calibre_23"><span class="calibre5"><span class="italic"><span class="calibre_15">Figure 11-9. Assign the ShowHistory macro to the Show History button</span></span></span></p><p class="calibre_24">The frontend<a id="filepos1619827"/> is now done and we can move on with the Python backend.</p><p id="filepos1619894" class="calibre_17"><span class="calibre3"><span class="bold">Backend</span></span></p><p class="calibre_6">The <a id="filepos1620020"/>code of the two Python files <span class="italic">packagetracker.py</span> and <span class="italic">database.py</span> is too long to be shown here, so you will need to open them from the companion repository in VS Code. I will, however, refer to a couple of code snippets in this section to explain a few key concepts. Let’s see what happens when you click the Add Package button on the Database sheet. The button has the following VBA macro assigned:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">Sub</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_62">AddPackage</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">RunPython</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"import packagetracker; packagetracker.add_package()"</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">End</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">Sub</span></span></tt></span></blockquote><p class="calibre_32">As you see, the <tt class="calibre6">RunPython</tt> function calls the <tt class="calibre6">add_package</tt> Python function in the <tt class="calibre6">packagetracker</tt> module as shown <a id="filepos1621394"/>in <a href="#filepos1621971"><span class="calibre_7">Example 11-1</span></a>.</p><blockquote class="calibre_25"><span class="bold"><span class="calibre_26">NO PRODUCTION CODE</span></span></blockquote><blockquote class="calibre_27"><span class="calibre5">The application is kept as simple as possible to make it easy to follow—it doesn’t check for every possible thing that can go wrong. In a production environment, you’d want to make it more robust: for example, you would show a user-friendly error if it can’t find the database file.</span></blockquote><p id="filepos1621971" class="calibre_16"><span class="italic">Example 11-1. The </span><tt class="calibre6"><span class="italic">add_package</span></tt><span class="italic"> function in packagetracker.py (without comments)</span></p><p class="calibre_63"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">def</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_62">add_package</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">():</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">db_sheet</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">xw</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">Book</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">caller</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sheets</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Database"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_name</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">db_sheet</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"new_package"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">value</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">feedback_cell</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">db_sheet</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"new_package"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">offset</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">column_offset</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">1</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">feedback_cell</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">clear_contents</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">if</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_15">not</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_name</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">feedback_cell</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">value</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Error: Please provide a name!"</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><img src="images/00031.jpg" class="calibre_65"/><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">return</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">if</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">requests</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">get</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"{BASE_URL}/{package_name}/json"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">,</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>                    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">timeout</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">6</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">status_code</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">!=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_37">200</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><img src="images/00039.jpg" class="calibre_65"/><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">feedback_cell</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">value</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Error: Package not found!"</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">return</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">error</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">database</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">store_package</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">package_name</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><img src="images/00050.jpg" class="calibre_65"/><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">db_sheet</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">[</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"new_package"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">]</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">clear_contents</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">if</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">error</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">feedback_cell</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">value</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Error: {error}"</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">else</span></span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">feedback_cell</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">value</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"Added {package_name} successfully."</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">update_database</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><img src="images/00067.jpg" class="calibre_65"/><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>        </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">refresh_dropdown</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><img src="images/00058.jpg" class="calibre_65"/></p><p class="calibre_32"><img src="images/00031.jpg" class="calibre_65"/></p><blockquote class="calibre4"><blockquote class="calibre_19">The “error” in the feedback message will trigger the red font in Excel via conditional formatting.</blockquote></blockquote><p class="calibre_20"><img src="images/00039.jpg" class="calibre_65"/></p><blockquote class="calibre4"><blockquote class="calibre_19">By default, Requests is waiting forever for a response which could lead the application to “hang” in cases where PyPI has an issue and is responding slowly. That’s why for production code, you should always include an explicit <tt class="calibre6">timeout</tt> parameter.</blockquote></blockquote><p class="calibre_20"><img src="images/00050.jpg" class="calibre_65"/></p><blockquote class="calibre4"><blockquote class="calibre_19">The <tt class="calibre6">store_package</tt> function returns <tt class="calibre6">None</tt> if the operation was successful and a string with the error message otherwise.</blockquote></blockquote><p class="calibre_20"><img src="images/00067.jpg" class="calibre_65"/></p><blockquote class="calibre4"><blockquote class="calibre_19">To keep things simple, the whole database is updated. In a production environment, you would only add the records of the new package.</blockquote></blockquote><p class="calibre_20"><img src="images/00058.jpg" class="calibre_65"/></p><blockquote class="calibre4"><blockquote class="calibre_19">This will update the table on the Dropdown sheet with the content of the <tt class="calibre6">packages</tt> table. Together with the data validation that we have set up in Excel, this makes sure that all packages appear in the dropdown on the Tracker sheet. You would need to give the users a way to call this function directly if you allow the database to be populated from outside of your Excel file. This is the case as soon as you have multiple users using the same database from different  Excel files.</blockquote><a id="filepos1633823"/></blockquote><p class="calibre_16">You should be able to follow the other functions in the <span class="italic">packagetracker.py</span> file with the help of the comments in the code. Let’s now turn our attention to <a id="filepos1634047"/>the <span class="italic">database.py</span> file. The first few lines are shown in <a href="#filepos1634189"><span class="calibre_7">Example 11-2</span></a>.</p><p id="filepos1634189" class="calibre_6"><span class="italic">Example 11-2. database.py (excerpt with the relevant imports)</span></p><p class="calibre_63"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">from</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">pathlib</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">Path</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">sqlalchemy</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">import</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">pandas</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">as</span></span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_64">pd</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">...</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># We want the database file to sit next to this file.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Here, we are turning the path into an absolute path.</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">this_dir</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">Path</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6">__file__</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">resolve</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">parent</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><img src="images/00031.jpg" class="calibre_65"/><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">db_path</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">this_dir</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">/</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"packagetracker.db"</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="italic"><span class="calibre_43"># Database engine</span></span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sqlalchemy</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">create_engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">f</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"sqlite:///{db_path}"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></p><p class="calibre_32"><img src="images/00031.jpg" class="calibre_65"/></p><blockquote class="calibre4"><blockquote class="calibre_19">If you need a refresher of what this line does, have a look at the beginning of <a href="index_split_019.html#filepos863345"><span class="calibre_7">Chapter 7</span></a>, where I explain it in the code of the sales report.</blockquote></blockquote><p class="calibre_16">While this snippet is concerned with putting together the path of the database file, it also shows you how to get around a <a id="filepos1638593"/>common error when you work with any sort of file, whether that’s a picture, a CSV file, or, like in this case, a database file. When you put together a quick Python script, you may just use a relative path as I have done in most of the Jupyter notebook samples:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="calibre_36">engine</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">=</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">sqlalchemy</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">create_engine</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"sqlite:///packagetracker.db"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span></blockquote><p class="calibre_32">This works as long as your file is in your working directory. However, when you run this code from Excel via <tt class="calibre6">RunPython</tt>, the working directory can be different, which will cause Python to look for the file in the wrong folder—you will get a <tt class="calibre6">File not found</tt> error. You can solve this issue by providing an absolute path or by creating a path the way we do in <a href="#filepos1634189"><span class="calibre_7">Example 11-2</span></a>. This makes sure that Python is looking for the file in the same directory as the source file even if you execute the code from Excel via <tt class="calibre6">RunPython</tt>.</p><p class="calibre_6">If you want to create the Python Package Tracker from scratch, you will need to create the database manually: run the <span class="italic">database.py</span> file as a script, for example by clicking the Run File button in VS Code. This will create the database file <span class="italic">packagetracker.db</span> with the two tables. The code that creates the database is found at the very bottom of <span class="italic">database.py</span>:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">if</span></span></tt></span><span class="calibre5"><tt class="calibre6"> __name__ </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">==</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"__main__"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">create_db</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_32">While the last line calls the <tt class="calibre6">create_db</tt> function, the meaning of the preceding <tt class="calibre6">if</tt> statement is explained in the following tip.</p><blockquote class="calibre_25"><span class="bold"><span class="calibre_26">IF __NAME__ == “__MAIN__”</span></span></blockquote><blockquote class="calibre_27"><span class="calibre5">You will see this </span><a id="filepos1641594"/><span class="calibre5"><tt class="calibre6">if</tt></span><span class="calibre5"> statement at the bottom of many Python files. It makes sure that this code only runs when you run the file </span><span class="calibre5"><span class="italic">as a script</span></span><span class="calibre5">, for example, from an Anaconda Prompt by running </span><span class="calibre5"><tt class="calibre6">python database.py</tt></span><span class="calibre5"> or by clicking the Run File button in VS Code. It, however, will not be triggered when you run the file </span><span class="calibre5"><span class="italic">by importing it as a module</span></span><span class="calibre5">, i.e., by doing </span><span class="calibre5"><tt class="calibre6">import database</tt></span><span class="calibre5"> in your code. The reason for this is that Python assigns the name </span><span class="calibre5"><tt class="calibre6">__main__</tt></span><span class="calibre5"> to the file if you run it directly as script, whereas it will be called by its module name (</span><span class="calibre5"><tt class="calibre6">database</tt></span><span class="calibre5">) when you run it via the </span><span class="calibre5"><tt class="calibre6">import</tt></span><span class="calibre5"> statement. Since Python tracks the file name in a variable called </span><span class="calibre5"><tt class="calibre6">__name__</tt></span><span class="calibre5">, the </span><span class="calibre5"><tt class="calibre6">if</tt></span><span class="calibre5"> statement will evaluate to </span><span class="calibre5"><tt class="calibre6">True</tt></span><span class="calibre5"> only when you run it as script; it will not be triggered when you import it from the </span><span class="calibre5"><span class="italic">packagetracker.py</span></span><span class="calibre5"> file.</span></blockquote><p class="calibre_16">The rest of the <tt class="calibre6">database</tt> module runs SQL statements both via SQLAlchemy and pandas’ <tt class="calibre6">to_sql</tt> and <tt class="calibre6">read_sql</tt> methods so you get a feeling for both approaches.</p><blockquote class="calibre_39"><span class="bold">MOVING TO POSTGRESQL</span></blockquote><blockquote class="calibre_27">If you<a id="filepos1643404"/> wanted to replace SQLite with PostgreSQL, a server-based database, there are only a few things you need to change. First of all, you need to run <tt class="calibre6">conda install psycopg2</tt> (or <tt class="calibre6">pip install psycopg2-binary</tt> if you are not using the Anaconda distribution) to install the PostgreSQL driver. Then, in <span class="italic">database.py</span>, change the connection string in the <tt class="calibre6">create_engine</tt> function to the PostgreSQL version as shown in <a href="#filepos1531478"><span class="calibre_7">Table 11-3</span></a>. Finally, to create the tables, you would need to change the <tt class="calibre6">INTEGER</tt> data type of <tt class="calibre6">packages.package_id</tt> to the PostgreSQL specific notation of <tt class="calibre6">SERIAL</tt>. Creating an auto-incrementing primary key is an example of where the SQL dialects differ.</blockquote><p class="calibre_17">When you<a id="filepos1644241"/> create tools of the complexity of the Python Package Tracker, you probably run into a few issues along the way: for example, you might have renamed a named range in Excel and forgot to adjust the Python code accordingly. This is a good moment to look into how debugging works!</p><p id="filepos1644529" class="calibre_17"><span class="calibre3"><span class="bold">Debugging</span></span></p><p class="calibre_6">To <a id="filepos1644656"/>easily debug your xlwings scripts, run your functions directly from VS Code, instead of running them by clicking a button in Excel. The following lines at the very bottom of the <span class="italic">packagetracker.py</span> file will help you with debugging the <tt class="calibre6">add_package</tt> function (this is the same code that you will also find at the bottom of a <tt class="calibre6">quickstart</tt> project):</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">if</span></span></tt></span><span class="calibre5"><tt class="calibre6"> __name__ </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">==</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"__main__"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><img src="images/00031.jpg" class="calibre_65"/><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">xw</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">Book</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"packagetracker.xlsm"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">set_mock_caller</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><img src="images/00039.jpg" class="calibre_65"/><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">add_package</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_17"><img src="images/00031.jpg" class="calibre_65"/></p><blockquote class="calibre4"><blockquote class="calibre_19">We have just seen how this if statement works when we were looking at the <span class="italic">database.py</span> code; see the previous tip.</blockquote></blockquote><p class="calibre_20"><img src="images/00039.jpg" class="calibre_65"/></p><blockquote class="calibre4"><blockquote class="calibre_19">As this code is only executed when you run the file directly from Python as a script, the <tt class="calibre6">set_mock_caller()</tt> command is only meant for debugging purposes: when you run the file in VS Code or from an Anaconda Prompt, it sets the <tt class="calibre6">xw.Book.caller()</tt> to <tt class="calibre6">xw.Book("packagetracker.xlsm")</tt>. The only purpose of doing this is to be able to run your script from both sides, Python and Excel, without having to switch the book object within the <tt class="calibre6">add_package</tt> function back and forth between <tt class="calibre6">xw.Book("packagetracker.xlsm")</tt> (when you call it from VS Code) and <tt class="calibre6">xw.Book.caller()</tt> (when you call it from Excel).</blockquote></blockquote><p class="calibre_16">Open <span class="italic">packagetracker.py</span> in VS Code and set a breakpoint on any line within the <tt class="calibre6">add_package</tt> function by clicking to the left of the line numbers. Then hit F5 and select “Python File” in the dialog to start the debugger and to make your code stop at the breakpoint. Make sure to hit F5 instead of using the Run File button, as the Run File button ignores breakpoints.</p><blockquote class="calibre_25"><span class="bold"><span class="calibre_29">DEBUGGING WITH VS CODE AND ANACONDA</span></span></blockquote><blockquote class="calibre_27"><span class="calibre5">On Windows, when you run the VS Code debugger for the first time with code that uses pandas, you might be greeted by an error: “Exception has occurred: ImportError, Unable to import required dependencies: numpy.” This happens because the debugger is up and running before the Conda environment has been activated properly. As a workaround, stop the debugger by clicking the stop icon and hit F5 again—it will work the second time.</span><a id="filepos1648684"/></blockquote><p class="calibre_16">If you are not familiar with how the debugger in VS Code works, have a look at <a href="index_split_030.html#filepos1820886"><span class="calibre_7">Appendix B</span></a> where I explain all the relevant functionality and buttons. We will also pick the topic up again in the respective section of the next chapter. If you want to debug a different function, stop the current debug session, then adjust the function name at the bottom of your file. For example, to debug the <tt class="calibre6">show_history</tt> function, change the last line in <span class="italic">packagetracker.py</span> as follows before hitting F5 again:</p><blockquote class="calibre_31"><span class="calibre5"><tt class="calibre6"><span class="bold"><span class="calibre_35">if</span></span></tt></span><span class="calibre5"><tt class="calibre6"> __name__ </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">==</span></tt></span><span class="calibre5"><tt class="calibre6">
</tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"__main__"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">:</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">xw</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">Book</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">(</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_38">"packagetracker.xlsm"</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">)</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_5">.</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">set_mock_caller</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span><span class="calibre5"><tt class="calibre6"><br class="calibre1"/>    </tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_36">show_history</span></tt></span><span class="calibre5"><tt class="calibre6"><span class="calibre_15">()</span></tt></span></blockquote><p class="calibre_32">On Windows, you could also activate the <a id="filepos1650611"/>Show Console checkbox in the xlwings add-in, which will show a Command Prompt while the <tt class="calibre6">RunPython</tt> call is running.<a id="filepos1650741"/><a href="#filepos1652845"><span class="calibre5"><span class="calibre_7">2</span></span></a> This allows you to print additional information to help you debug the issue. For example, you could print the value of a variable to inspect it on the Command Prompt. After the code has been run, however, the Command Prompt will be closed. If you need to keep it open for a little longer, there is an easy trick: add <tt class="calibre6">input()</tt> as the last line in your function. This causes Python to wait for user input instead of closing the Command Prompt right away. When you’re done with inspecting the output, hit Enter in the Command Prompt to close it—just make sure to remove the <tt class="calibre6">input()</tt> line again before unchecking the <a id="filepos1651460"/>Show Console option!</p><p id="filepos1651491" class="calibre_17"><span class="calibre3"><span class="bold"><span class="calibre_7">Conclusion</span></span></span></p><p class="calibre_6">This chapter showed you that it’s possible to build reasonably complex applications with a minimum of effort. Being able to leverage powerful Python packages like Requests or SQLAlchemy makes all the difference to me when I compare this with VBA, where talking to external systems is so much harder. If you have similar use cases, I would highly recommend you look more closely into both Requests and SQLAlchemy—being able to efficiently deal with external data sources will allow you to make copy/paste a thing of the past.</p><p class="calibre_6">Instead of clicking buttons, some users prefer to create their Excel tools by using cell formulas. The next chapter shows you how xlwings enables you to write user-defined functions in Python, allowing you to reuse most of the xlwings concepts we’ve learned so far.</p><blockquote id="filepos1652489" class="calibre_33"><a href="#filepos1563739"><span class="calibre5"><span class="calibre_7">1  </span></span></a><span class="calibre5"> In reality, the tool uses </span><span class="calibre5"><tt class="calibre6">package_name</tt></span><span class="calibre5"> instead of </span><span class="calibre5"><tt class="calibre6">package_id</tt></span><span class="calibre5"> to simplify the code.</span></blockquote><blockquote id="filepos1652845" class="calibre_27"><a href="#filepos1650741"><span class="calibre5"><span class="calibre_7">2  </span></span></a><span class="calibre5"> At the time of this writing, this option is not yet available on macOS.</span></blockquote><div class="mbp_pagebreak" id="calibre_pb_22"/>
</body></html>