<html><head></head><body><section data-pdf-bookmark="Chapter 9. Wrangling Dataframes" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch-wrangling">&#13;
<h1><span class="label">Chapter 9. </span>Wrangling Dataframes</h1>&#13;
&#13;
<p>We often need<a contenteditable="false" data-primary="dataframes" data-type="indexterm" id="ix_dataframe_ch9"/> to perform preparatory work on our data before we can begin our analysis. The amount of preparation can vary widely, but there are a few basic steps to move from raw data to data ready for analysis. <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a> addressed the initial steps of creating a dataframe from a plain-text source. In this chapter, we assess quality. To do this, we perform validity checks on individual data values and entire columns. In addition to checking the quality of the data, we determine whether or not the data need to be transformed and reshaped to get ready for analysis. Quality checking (and fixing) and transformation are often cyclical: the quality checks point us toward transformations we need to make, and when we check the transformed columns to confirm that our data are ready for analysis, we may discover they need further <span class="keep-together">cleaning</span>.</p>&#13;
&#13;
<p>Depending on the data source, we often have different expectations for quality. Some datasets require extensive wrangling to get them into an analyzable form, and others arrive clean and we can quickly launch into modeling. Here are some examples of data sources and how much wrangling we might expect to do:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Data from a scientific experiment or study are typically clean, are well documented, and have a simple structure. These data are organized to be broadly shared so that others can build on or reproduce the findings. They are typically ready for analysis after little to no wrangling.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Data from government surveys often come with very detailed codebooks and metadata describing how the data are collected and formatted, and these datasets are also typically ready for exploration and analysis right out of the box.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Administrative<a contenteditable="false" data-primary="cleaning data" data-type="indexterm" id="id1109"/> data can be clean, but without inside knowledge of the source, we may need to extensively check their quality. Also, since we often use these data for a purpose other than why they were collected in the first place, we may need to transform features or combine data tables.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Informally collected data, such as data scraped from the web, can be quite messy and tends to come with little documentation. For example, texts, tweets, blogs, and Wikipedia tables usually require formatting and cleaning to transform them into information ready for analysis.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>In this chapter, we break down data wrangling into the following stages: assess data quality, handle missing values, transform features, and reshape the data by modifying its structure and granularity. An important step in assessing the quality of the data is to consider its scope. Data scope was covered in <a class="reference internal" data-type="xref" href="ch02.html#ch-data-scope">Chapter 2</a>, and we refer you there for a fuller treatment of the topic.</p>&#13;
&#13;
<p>To clean and prepare data, we also rely on exploratory data analysis, especially visualizations. In this chapter, however, we focus on data wrangling and cover these other, related topics in more detail in Chapters <a class="reference internal" data-type="xref" data-xrefstyle="select:labelnumber" href="ch10.html#ch-eda">10</a> and <a class="reference internal" data-type="xref" data-xrefstyle="select:labelnumber" href="ch11.html#ch-viz">11</a>.</p>&#13;
&#13;
<p>We use the datasets introduced in <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a>: the DAWN government survey of emergency room visits related to drug abuse, and the San Francisco administrative data on food safety inspections of restaurants. But we begin by introducing the various data wrangling concepts through another example that is simple enough and clean enough that we can limit our focus in each of the wrangling steps.</p>&#13;
&#13;
<section data-pdf-bookmark="Example: Wrangling CO2 Measurements from the Mauna Loa Observatory" data-type="sect1"><div class="sect1" id="ch-wrangling-co2">&#13;
<h1>Example: Wrangling CO<sub>2</sub> Measurements from the <span class="keep-together">Mauna Loa Observatory</span></h1>&#13;
&#13;
<p>We saw in <a class="reference internal" data-type="xref" href="ch02.html#ch-data-scope">Chapter 2</a> that the <a class="reference external" href="https://www.noaa.gov">National Oceanic and Atmospheric Administration (NOAA)</a> monitors CO<sub>2</sub> concentrations<a contenteditable="false" data-primary="CO₂ measurements, Mauna Loa Observatory" data-type="indexterm" id="ix_co2_meas"/><a contenteditable="false" data-primary="dataframes" data-secondary="CO₂ measurements at Mauna Loa Observatory" data-type="indexterm" id="ix_df_co2_meas"/> in the air at the <a class="reference external" href="https://oreil.ly/7HsQh">Mauna Loa Observatory</a>. We continue with this example and use it to introduce how to make data-quality checks, handle missing values, transform features, and reshape tables. These data are in the file <em>data/co2_mm_mlo.txt</em>. Let’s begin by figuring out the formatting, encoding, and size of the source before we load it into a dataframe (see <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a>):</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">from</code></span><code> </code><span><code class="nn">pathlib</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">Path</code></span><code>&#13;
</code><span><code class="kn">import</code></span><code> </code><span><code class="nn">os</code></span><code>&#13;
</code><span><code class="kn">import</code></span><code> </code><span><code class="nn">chardet</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">co2_file_path</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code></span><span><code class="p">)</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">co2_mm_mlo.txt</code><code class="s1">'</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="p">[</code></span><span><code class="n">os</code></span><span><code class="o">.</code></span><span><code class="n">path</code></span><span><code class="o">.</code></span><span><code class="n">getsize</code></span><span><code class="p">(</code></span><span><code class="n">co2_file_path</code></span><span><code class="p">)</code><code class="p">,</code></span><code> </code><code>&#13;
</code><code> </code><span><code class="n">chardet</code></span><span><code class="o">.</code></span><span><code class="n">detect</code></span><span><code class="p">(</code></span><span><code class="n">co2_file_path</code></span><span><code class="o">.</code></span><span><code class="n">read_bytes</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">encoding</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
[51131, 'ascii']&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We have found that the file is plain text with ASCII encoding and about 50 KiB in size. Since the file is not particularly large, we should have no trouble loading it into a dataframe, but first we need to determine the file’s format. Let’s look at the first few lines in the file:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">lines</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">co2_file_path</code></span><span><code class="o">.</code></span><span><code class="n">read_text</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">split</code></span><span><code class="p">(</code></span><span><code class="s1">'</code></span><span><code class="se">\n</code></span><span><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="nb">len</code></span><span><code class="p">(</code></span><span><code class="n">lines</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
811&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">lines</code></span><span><code class="p">[</code><code class="p">:</code></span><span><code class="mi">6</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
['# --------------------------------------------------------------------',&#13;
 '# USE OF NOAA ESRL DATA',&#13;
 '# ',&#13;
 '# These data are made freely available to the public and the',&#13;
 '# scientific community in the belief that their wide dissemination',&#13;
 '# will lead to greater understanding and new scientific insights.']&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We see that the file begins with information about the data source. We should read this documentation before starting our analysis, but sometimes the urge to plunge into the analysis wins over and we just start mucking about and discover properties of the data as we go. So let’s quickly find where the actual data values are located:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">lines</code></span><span><code class="p">[</code></span><span><code class="mi">69</code></span><span><code class="p">:</code></span><span><code class="mi">75</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
['#',&#13;
 '#            decimal     average   interpolated    trend    #days',&#13;
 '#             date                             (season corr)',&#13;
 '1958   3    1958.208      315.71      315.71      314.62     -1',&#13;
 '1958   4    1958.292      317.45      317.45      315.29     -1',&#13;
 '1958   5    1958.375      317.50      317.50      314.71     -1']&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We have found that the data begins on the 73rd line of the file. We also spot some relevant characteristics:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>The values are separated by whitespace, possibly tabs.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>The data line up in precise columns. For example, the month appears in the seventh to eighth position of each line.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>The column headings are split over two lines.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>We can<a contenteditable="false" data-primary="read_csv function" data-type="indexterm" id="id1110"/> use <code>read_csv</code> to read the data into a <code>pandas</code> <code>DataFrame</code> and provide arguments to specify that the separators are whitespace, there is no header (we will set our own column names), and to skip the first 72 rows of the file:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">co2</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/co2_mm_mlo.txt</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><code>&#13;
</code><code>                  </code><span><code class="n">header</code></span><span><code class="o">=</code></span><span><code class="kc">None</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">skiprows</code></span><span><code class="o">=</code></span><span><code class="mi">72</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">sep</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">\</code><code class="s1">s+</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>                  </code><span><code class="n">names</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">Yr</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Mo</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">DecDate</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Avg</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Int</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Trend</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">days</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">co2</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">3</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>Yr</th>&#13;
			<th>Mo</th>&#13;
			<th>DecDate</th>&#13;
			<th>Avg</th>&#13;
			<th>Int</th>&#13;
			<th>Trend</th>&#13;
			<th>days</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>1958</td>&#13;
			<td>3</td>&#13;
			<td>1958.21</td>&#13;
			<td>315.71</td>&#13;
			<td>315.71</td>&#13;
			<td>314.62</td>&#13;
			<td>-1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>1958</td>&#13;
			<td>4</td>&#13;
			<td>1958.29</td>&#13;
			<td>317.45</td>&#13;
			<td>317.45</td>&#13;
			<td>315.29</td>&#13;
			<td>-1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>1958</td>&#13;
			<td>5</td>&#13;
			<td>1958.38</td>&#13;
			<td>317.50</td>&#13;
			<td>317.50</td>&#13;
			<td>314.71</td>&#13;
			<td>-1</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We have successfully loaded the file contents into a dataframe, and we can see that the granularity of the data is a monthly average CO<sub>2</sub>, from 1958 through 2019. Also, the table shape is 738 by 7.</p>&#13;
&#13;
<p>Since scientific studies tend to have very clean data, it’s tempting to jump right in and make a plot to see how CO<sub>2</sub> monthly averages have changed. The field <code>DecDate</code> conveniently represents the month and year as a numeric feature, so we can easily make a line plot:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
	<code class="n">px</code><code class="o">.</code><code class="n">line</code><code class="p">(</code><code class="n">co2</code><code class="p">,</code> <code class="n">x</code><code class="o">=</code><code class="s1">'DecDate'</code><code class="p">,</code> <code class="n">y</code><code class="o">=</code><code class="s1">'Avg'</code><code class="p">,</code> <code class="n">width</code><code class="o">=</code><code class="mi">350</code><code class="p">,</code> <code class="n">height</code><code class="o">=</code><code class="mi">250</code><code class="p">,</code>&#13;
			<code class="n">labels</code><code class="o">=</code><code class="p">{</code><code class="s1">'DecDate'</code><code class="p">:</code><code class="s1">'Date'</code><code class="p">,</code> <code class="s1">'Avg'</code><code class="p">:</code><code class="s1">'Average monthly CO₂'</code><code class="p">})</code>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_09in01.png"/></div></figure>&#13;
&#13;
<p>Yikes! Plotting the data has uncovered a problem. The four dips in the line plot look odd. What happened here? We can check a few percentiles of the dataframe to see if we can spot the problem:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">co2</code></span><span><code class="o">.</code></span><span><code class="n">describe</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">[</code></span><span><code class="mi">3</code></span><span><code class="p">:</code><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>Yr</th>&#13;
			<th>Mo</th>&#13;
			<th>DecDate</th>&#13;
			<th>Avg</th>&#13;
			<th>Int</th>&#13;
			<th>Trend</th>&#13;
			<th>days</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>min</strong></td>&#13;
			<td>1958.0</td>&#13;
			<td>1.0</td>&#13;
			<td>1958.21</td>&#13;
			<td>-99.99</td>&#13;
			<td>312.66</td>&#13;
			<td>314.62</td>&#13;
			<td>-1.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>25%</strong></td>&#13;
			<td>1973.0</td>&#13;
			<td>4.0</td>&#13;
			<td>1973.56</td>&#13;
			<td>328.59</td>&#13;
			<td>328.79</td>&#13;
			<td>329.73</td>&#13;
			<td>-1.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>50%</strong></td>&#13;
			<td>1988.0</td>&#13;
			<td>6.0</td>&#13;
			<td>1988.92</td>&#13;
			<td>351.73</td>&#13;
			<td>351.73</td>&#13;
			<td>352.38</td>&#13;
			<td>25.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>75%</strong></td>&#13;
			<td>2004.0</td>&#13;
			<td>9.0</td>&#13;
			<td>2004.27</td>&#13;
			<td>377.00</td>&#13;
			<td>377.00</td>&#13;
			<td>377.18</td>&#13;
			<td>28.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>max</strong></td>&#13;
			<td>2019.0</td>&#13;
			<td>12.0</td>&#13;
			<td>2019.62</td>&#13;
			<td>414.66</td>&#13;
			<td>414.66</td>&#13;
			<td>411.84</td>&#13;
			<td>31.0</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>This time, looking a bit more closely at the range of values, we see that some data have unusual values like <code>-1</code> and <code>-99.99</code>. If we read the information at the top of the file more carefully, we find that <code>-99.99</code> denotes a missing monthly average and <code>-1</code> signifies a missing value for the number of days the equipment was in operation that month. Even with relatively clean data, it’s a good practice to read the documentation and make a few quality checks before jumping into the analysis stage.</p>&#13;
&#13;
<section data-pdf-bookmark="Quality Checks" data-type="sect2"><div class="sect2" id="quality-checks">&#13;
<h2>Quality Checks</h2>&#13;
&#13;
<p>Let’s step back for a moment and perform some quality checks. We might confirm that we have the expected number of observations, look for unusual values, and cross-check anomalies that we find against the values in other features.</p>&#13;
&#13;
<p>First, we consider the shape of the data. How many rows should we have? From looking at the head and tail of the dataframe, the data appear to be in chronological order, beginning with March 1958 and ending with August 2019. This means we should have <span class="math notranslate nohighlight"><math> <mn>12</mn> <mo>×</mo> <mo stretchy="false">(</mo> <mn>2019</mn> <mo>−</mo> <mn>1957</mn> <mo stretchy="false">)</mo> <mo>−</mo> <mn>2</mn> <mo>−</mo> <mn>4</mn> <mo>=</mo> <mn>738</mn> </math></span> records, which we can check against the shape of the dataframe:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">co2</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
(738, 7)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Our calculations match the number of rows in the data table.</p>&#13;
&#13;
<p>Next, let’s check the quality of the features, starting with <code>Mo</code>. We expect the values to range from 1 to 12, and each month should have 2019 – 1957 = 62 or 61 instances (since the recordings begin in March of the first year and end in August of the most recent year):</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">co2</code></span><span><code class="p">[</code></span><span><code class="s2">"</code><code class="s2">Mo</code><code class="s2">"</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">reindex</code></span><span><code class="p">(</code></span><span><code class="nb">range</code></span><span><code class="p">(</code></span><span><code class="mi">1</code></span><span><code class="p">,</code></span><span><code class="mi">13</code></span><span><code class="p">)</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">tolist</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
[61, 61, 62, 62, 62, 62, 62, 62, 61, 61, 61, 61]&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>As expected, Jan, Feb, Sep, Oct, Nov, and Dec have 61 occurrences and the rest 62.</p>&#13;
&#13;
<p>Now let’s examine the column called <code>days</code> with a histogram:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">histogram</code></span><span><code class="p">(</code></span><span><code class="n">co2</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">days</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">350</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>            </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">days</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">Days operational in a month</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_09in02.png"/></div></figure>&#13;
&#13;
<p>We see that a handful of months have averages based on measurements taken on fewer than half the days. In addition, there are nearly 200 missing values. A scatterplot can help us cross-check missing data against the year of the recording:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">scatter</code></span><span><code class="p">(</code></span><span><code class="n">co2</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">Yr</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">days</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">350</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>           </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">Yr</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">Year</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">days</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">Days operational in month</code><code class="s1">'</code></span><code> </code><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal width-60"><div class="figure"><img src="assets/leds_09in03.png"/></div></figure>&#13;
&#13;
<p>The line along the bottom left of the plot shows us that all of the missing data are in the early years of operation. The number of days of operation of the equipment may not have been collected in the early days. It also appears that there might have been problems with the equipment in the mid- to late ’80s. What do we do with these conjectures? We can try to confirm them by looking through documentation about the historical readings. If we are concerned about the impact on the CO<sub>2</sub> averages for records with missing values for the number of days of operation, then a simple solution would be to drop the earliest recordings. However, we would want to delay such action until after we have examined the time trends and assess whether there are any potential problems with the CO<sub>2</sub> averages in those early days.</p>&#13;
&#13;
<p>Next, let’s return to the <code>-99.99</code> values for the average CO<sub>2</sub> measurement and begin our checks with a histogram:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">histogram</code></span><span><code class="p">(</code></span><span><code class="n">co2</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">Avg</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">350</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>             </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">Avg</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">Average monthly CO₂</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_09in04.png"/></div></figure>&#13;
&#13;
<p>The recorded values are in the 300–400 range, which is what we expect based on our research into CO<sub>2</sub> levels. We also see that there are only a few missing values. Since there aren’t many missing values, we can examine all of them:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">co2</code></span><span><code class="p">[</code></span><span><code class="n">co2</code></span><span><code class="p">[</code></span><span><code class="s2">"</code><code class="s2">Avg</code><code class="s2">"</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">&lt;</code></span><code> </code><span><code class="mi">0</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>Yr</th>&#13;
			<th>Mo</th>&#13;
			<th>DecDate</th>&#13;
			<th>Avg</th>&#13;
			<th>Int</th>&#13;
			<th>Trend</th>&#13;
			<th>days</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>1958</td>&#13;
			<td class="right">6</td>&#13;
			<td>1958.46</td>&#13;
			<td>-99.99</td>&#13;
			<td>317.10</td>&#13;
			<td>314.85</td>&#13;
			<td class="right">-1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>7</strong></td>&#13;
			<td>1958</td>&#13;
			<td class="right">10</td>&#13;
			<td>1958.79</td>&#13;
			<td>-99.99</td>&#13;
			<td>312.66</td>&#13;
			<td>315.61</td>&#13;
			<td class="right">-1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>71</strong></td>&#13;
			<td>1964</td>&#13;
			<td class="right">2</td>&#13;
			<td>1964.12</td>&#13;
			<td>-99.99</td>&#13;
			<td>320.07</td>&#13;
			<td>319.61</td>&#13;
			<td class="right">-1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>72</strong></td>&#13;
			<td>1964</td>&#13;
			<td class="right">3</td>&#13;
			<td>1964.21</td>&#13;
			<td>-99.99</td>&#13;
			<td>320.73</td>&#13;
			<td>319.55</td>&#13;
			<td class="right">-1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>73</strong></td>&#13;
			<td>1964</td>&#13;
			<td class="right">4</td>&#13;
			<td>1964.29</td>&#13;
			<td>-99.99</td>&#13;
			<td>321.77</td>&#13;
			<td>319.48</td>&#13;
			<td class="right">-1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>213</strong></td>&#13;
			<td>1975</td>&#13;
			<td class="right">12</td>&#13;
			<td>1975.96</td>&#13;
			<td>-99.99</td>&#13;
			<td>330.59</td>&#13;
			<td>331.60</td>&#13;
			<td class="right">0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>313</strong></td>&#13;
			<td>1984</td>&#13;
			<td class="right">4</td>&#13;
			<td>1984.29</td>&#13;
			<td>-99.99</td>&#13;
			<td>346.84</td>&#13;
			<td>344.27</td>&#13;
			<td class="right">2</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We are faced with the question of what to do with the <code>-99.99</code> values. We have seen already the problems of leaving these values as is in a line plot. There are several options, and we describe them next.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Addressing Missing Data" data-type="sect2"><div class="sect2" id="addressing-missing-data">&#13;
<h2>Addressing Missing Data</h2>&#13;
&#13;
<p>The <code>-99.99</code>s for average<a contenteditable="false" data-primary="missing values and records" data-secondary="CO₂ tracking on Mauna Loa example" data-type="indexterm" id="ix_mis_val_co2"/> CO<sub>2</sub> levels indicate missing recordings. These interfere with our statistical summaries and plots. It’s good to know which values are missing, but we need to do something about them. We might drop those records, replace <code>-99.99</code> with <code>NaN</code>, or substitute <code>99.99</code> with a likely value for the average CO<sub>2</sub>. Let’s examine each of these three options.</p>&#13;
&#13;
<p>Note that the table<a contenteditable="false" data-primary="visualization, data" data-secondary="adding context" data-type="indexterm" id="id1111"/><a contenteditable="false" data-primary="captions, text context in plots" data-type="indexterm" id="id1112"/><a contenteditable="false" data-primary="labels" data-type="indexterm" id="id1113"/><a contenteditable="false" data-primary="text" data-secondary="additions to visualization plots" data-type="indexterm" id="id1114"/> already comes with a substitute value for the <code>-99.99</code>. The column labeled <code>Int</code> has values that exactly match those in <code>Avg</code>, except when <code>Avg</code> is <code>-99.99</code>, and then a “reasonable” estimate is used instead.</p>&#13;
&#13;
<p>To see the effect of each option<a contenteditable="false" data-primary="missing values and records" data-secondary="time series" data-type="indexterm" id="id1115"/><a contenteditable="false" data-primary="times and dates" data-secondary="missing data in time series" data-type="indexterm" id="id1116"/>, let’s zoom in on a short time period—say the measurements in 1958—where we know we have two missing values. We can create a time-series plot for the three cases: drop the records with <code>-99.99</code>s (left plot), use <code>NaN</code> for missing values (middle plot), and substitute an estimate for <code>-99.99</code> (right plot):</p>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_09in05.png"/></div></figure>&#13;
&#13;
<p>When we look closely, we can see the difference between each of these plots. The leftmost plot connects dots across a two-month time period, rather than one month. In the middle plot, the line breaks where the data are missing, and on the right, we can see that months 6 and 10 now have values. In the big picture, since there are only seven values missing from the 738 months, all of these options work. However, there is some appeal to the right plot since the seasonal trends are more cleanly discernible.</p>&#13;
&#13;
<p>The method used to interpolate the CO<sub>2</sub> measurements for the missing values is an averaging process that takes into consideration the month and year. The idea is to reflect both seasonal changes and the long-term trend. This technique is described in greater detail in the documentation at the top of the datafile.</p>&#13;
&#13;
<p>These plots have shown the granularity of the data to be monthly measurements, but other granularity options are available to us. We discuss this next<a contenteditable="false" data-primary="" data-startref="ix_mis_val_co2" data-type="indexterm" id="id1117"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Reshaping the Data Table" data-type="sect2"><div class="sect2" id="reshaping-the-data-table">&#13;
<h2>Reshaping the Data Table</h2>&#13;
&#13;
<p>The CO<sub>2</sub> measurements<a contenteditable="false" data-primary="data tables" data-secondary="granularity" data-type="indexterm" id="id1118"/><a contenteditable="false" data-primary="granularity, data table" data-secondary="CO₂ emissions" data-type="indexterm" id="id1119"/><a contenteditable="false" data-primary="shape of data table" data-secondary="finding" data-type="indexterm" id="id1120"/> taken at the Mauna Loa Observatory are also available both daily and hourly. The hourly data has a <em>finer granularity</em> than the daily data; reciprocally, the daily data is <em>coarser</em> than the hourly data.</p>&#13;
&#13;
<p>Why not always just use the data with the finest granularity available? On a computational level, fine-grained data can become quite large. The Mauna Loa Observatory started recording CO<sub>2</sub> levels in 1958. Imagine how many rows the data table would contain if the facility provided measurements every single second! But more importantly, we want the granularity of the data to match our research question. Suppose we want to see whether CO<sub>2</sub> levels have risen over the past 50+ years, consistent with global warming predictions. We don’t need a CO<sub>2</sub> measurement every second. <span class="keep-together">In fact, we</span> might well be content with yearly averages where the seasonal patterns are smoothed away. We can aggregate<a contenteditable="false" data-primary="aggregation" data-secondary="CO₂ data from Mauna Loa dataset" data-type="indexterm" id="id1121"/> the monthly measurements, changing the granularity to annual averages, and make a plot to display the general trend. We can use <em>aggregation</em> to go to a coarser granularity—in <code>pandas</code>, we use <code>.groupby()</code> and <code>.agg()</code>:</p>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_09in06.png"/></div></figure>&#13;
&#13;
<p>Indeed, we see a rise by nearly 100 ppm of CO<sub>2</sub> since Mauna Loa began recording in 1958.</p>&#13;
&#13;
<p>To recap, after reading the whitespace-separated, plain-text file into a dataframe, we began to check its quality. We used the scope and context of the data to affirm that its shape matched the range of dates of collection. We confirmed that the values and counts for the month were as expected. We ascertained the extent of missing values in the features, and we looked for connections between missing values and other features. We considered three approaches to handling the missing data: drop records, work with <code>NaN</code> values, and impute values to have a full table. And, finally, we changed the granularity of the dataframe by rolling it up from a monthly to an annual average. This change in granularity removed seasonal fluctuations and focused on the long-term trend in the level of CO<sub>2</sub> in the atmosphere. The next four sections of this chapter expand on these actions to wrangle data into a form suitable for analysis: quality checks, missing value treatments, transformations, and shape adjustments. We begin with quality checks<a contenteditable="false" data-primary="" data-startref="ix_df_co2_meas" data-type="indexterm" id="id1122"/><a contenteditable="false" data-primary="" data-startref="ix_co2_meas" data-type="indexterm" id="id1123"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Quality Checks" data-type="sect1"><div class="sect1" id="ch-wrangling-checks">&#13;
<h1>Quality Checks</h1>&#13;
&#13;
<p>Once your data<a contenteditable="false" data-primary="quality checks, dataframes" data-type="indexterm" id="ix_qual_chk_df"/><a contenteditable="false" data-primary="dataframes" data-secondary="quality checks" data-type="indexterm" id="ix_df_qual_chk"/> are in a table and you understand the scope and granularity, it’s time to inspect for quality. You may have come across errors<a contenteditable="false" data-primary="errors" data-secondary="and quality checks" data-secondary-sortas="quality checks" data-type="indexterm" id="id1124"/> in the source as you examined and wrangled the file into a dataframe. In this section, we describe how to continue this inspection and carry out a more comprehensive assessment of the quality of the features and their values. We consider data quality from four vantage points:</p>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Scope</dt>&#13;
	<dd>&#13;
	<p>Do the data<a contenteditable="false" data-primary="data scope" data-secondary="quality checks" data-type="indexterm" id="id1125"/> match your understanding of the population?</p>&#13;
	</dd>&#13;
	<dt>Measurements and values</dt>&#13;
	<dd>&#13;
	<p>Are the values<a contenteditable="false" data-primary="measurements and values, quality checks" data-type="indexterm" id="id1126"/> reasonable?</p>&#13;
	</dd>&#13;
	<dt>Relationships</dt>&#13;
	<dd>&#13;
	<p>Are related features in agreement?</p>&#13;
	</dd>&#13;
	<dt>Analysis</dt>&#13;
	<dd>&#13;
	<p>Which features<a contenteditable="false" data-primary="analysis value, quality checks" data-type="indexterm" id="id1127"/> might be useful in a future analysis?</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<p>We describe each of these points in turn, beginning with scope.</p>&#13;
&#13;
<section data-pdf-bookmark="Quality Based on Scope" data-type="sect2"><div class="sect2" id="quality-based-on-scope">&#13;
<h2>Quality Based on Scope</h2>&#13;
&#13;
<p>In <a class="reference internal" data-type="xref" href="ch02.html#ch-data-scope">Chapter 2</a>, we addressed whether or not the data that have been collected can adequately address the problem at hand. There, we identified the target population, access frame, and sample in collecting the data. That framework helps us consider possible limitations that might impact the generalizability of our findings.</p>&#13;
&#13;
<p>While these broader data-scope considerations are important as we deliberate our final conclusions, they are also useful for checking data quality. For example, for the San Francisco restaurant inspections data introduced in <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a>, a side investigation tells us that zip codes in the city should start with 941. But a quick check shows that several zip codes begin with other digits:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">bus</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">postal_code</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">tail</code></span><span><code class="p">(</code></span><span><code class="mi">10</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
92672        1&#13;
64110        1&#13;
94120        1&#13;
            ..&#13;
94621        1&#13;
941033148    1&#13;
941          1&#13;
Name: postal_code, Length: 10, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>This verification using scope helps us spot potential problems.</p>&#13;
&#13;
<p>As another example, a bit of background reading at <a class="orm:hideurl" href="https://www.climate.gov">Climate.gov</a> and <a class="reference external" href="https://oreil.ly/UBPDY">NOAA</a> on the topic of atmospheric CO<sub>2</sub> reveals that typical measurements are about 400 ppm worldwide. So we can check whether the monthly averages of CO<sub>2</sub> at Mauna Loa lie between 300 and 450 ppm.</p>&#13;
&#13;
<p>Next, we check data values against codebooks and the like.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Quality of Measurements and Recorded Values" data-type="sect2"><div class="sect2" id="quality-of-measurements-and-recorded-values">&#13;
<h2>Quality of Measurements and Recorded Values</h2>&#13;
&#13;
<p>We can use also check<a contenteditable="false" data-primary="measurements and values, quality checks" data-type="indexterm" id="id1128"/> the quality of measurements by considering what might be a reasonable value for a feature. For example, imagine what might be a reasonable range for the number of violations in a restaurant inspection: possibly, 0 to 5. Other checks can be based on common knowledge of ranges: a restaurant inspection score must be between 0 and 100; months run between 1 and 12. We can use documentation to tell us the expected values for a feature. For example, the type of emergency room visit in the DAWN<a contenteditable="false" data-primary="DAWN (Drug Abuse Warning Network) survey" data-type="indexterm" id="id1129"/> survey, introduced in <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a>, has been coded as 1, 2, …, 8 (see <a class="reference internal" data-type="xref" href="#dawn-codebook">Figure 9-1</a>). So we can confirm that all values for the type of visit are indeed integers between 1 and 8.</p>&#13;
&#13;
<figure><div class="figure" id="dawn-codebook"><img src="assets/leds_0901.png"/>&#13;
<h6><span class="label">Figure 9-1. </span>Screenshot of the description of the emergency room visit type (CASETYPE) variable in the DAWN survey (the typo SUICICDE appears in the actual codebook)</h6>&#13;
</div></figure>&#13;
&#13;
<p>We also want to ensure that the data type matches our expectations. For example, we expect a price to be a number, whether or not it’s stored as integer, floating point, or string. Confirming that the units of measurement match what is expected can be another useful quality check to perform (for example, weight values recorded in pounds, not kilograms). We can devise checks for all of these situations.</p>&#13;
&#13;
<p>Other checks can be devised by comparing two related features.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Quality Across Related Features" data-type="sect2"><div class="sect2" id="quality-across-related-features">&#13;
<h2>Quality Across Related Features</h2>&#13;
&#13;
<p>At times, two features<a contenteditable="false" data-primary="features and feature types" data-secondary="related features, quality across" data-type="indexterm" id="id1130"/><a contenteditable="false" data-primary="features and feature types" data-seealso="variables and variable types" data-type="indexterm" id="id1131"/> have built-in conditions on their values that we can cross-check for internal consistency. For example, according to the documentation for the DAWN study, alcohol consumption is only considered a valid reason for a visit to the ER for patients under age 21, so we can check that any record with “alcohol” for the type of visit has an age under 21. A cross-tabulation of the features <code>type</code> and <code>age</code> can confirm that this constraint is met:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">display_df</code><code class="p">(</code><code class="n">pd</code><code class="o">.</code><code class="n">crosstab</code><code class="p">(</code><code class="n">dawn</code><code class="p">[</code><code class="s1">'age'</code><code class="p">],</code> <code class="n">dawn</code><code class="p">[</code><code class="s1">'type'</code><code class="p">]),</code> <code class="n">rows</code><code class="o">=</code><code class="mi">12</code><code class="p">)</code>&#13;
</pre>&#13;
&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th>type</th>&#13;
			<th>1</th>&#13;
			<th>2</th>&#13;
			<th>3</th>&#13;
			<th>4</th>&#13;
			<th>5</th>&#13;
			<th>6</th>&#13;
			<th>7</th>&#13;
			<th>8</th>&#13;
		</tr>&#13;
		<tr>&#13;
			<th>age</th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>-8</strong></td>&#13;
			<td class="right">2</td>&#13;
			<td class="right">2</td>&#13;
			<td class="right">0</td>&#13;
			<td class="right">21</td>&#13;
			<td class="right">5</td>&#13;
			<td class="right">1</td>&#13;
			<td class="right">1</td>&#13;
			<td class="right">36</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td class="right">0</td>&#13;
			<td class="right">6</td>&#13;
			<td class="right">20</td>&#13;
			<td class="right">6231</td>&#13;
			<td class="right">313</td>&#13;
			<td class="right">4</td>&#13;
			<td class="right">2101</td>&#13;
			<td class="right">69</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td class="right">8</td>&#13;
			<td class="right">2</td>&#13;
			<td class="right">15</td>&#13;
			<td class="right">1774</td>&#13;
			<td class="right">119</td>&#13;
			<td class="right">4</td>&#13;
			<td class="right">119</td>&#13;
			<td class="right">61</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td class="right">914</td>&#13;
			<td class="right">121</td>&#13;
			<td class="right">2433</td>&#13;
			<td class="right">2595</td>&#13;
			<td class="right">1183</td>&#13;
			<td class="right">48</td>&#13;
			<td class="right">76</td>&#13;
			<td class="right">4563</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4</strong></td>&#13;
			<td class="right">817</td>&#13;
			<td class="right">796</td>&#13;
			<td class="right">4953</td>&#13;
			<td class="right">3111</td>&#13;
			<td class="right">1021</td>&#13;
			<td class="right">95</td>&#13;
			<td class="right">44</td>&#13;
			<td class="right">6188</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>5</strong></td>&#13;
			<td class="right">983</td>&#13;
			<td class="right">1650</td>&#13;
			<td class="right">0</td>&#13;
			<td class="right">4404</td>&#13;
			<td class="right">1399</td>&#13;
			<td class="right">170</td>&#13;
			<td class="right">48</td>&#13;
			<td class="right">9614</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>6</strong></td>&#13;
			<td class="right">1068</td>&#13;
			<td class="right">1965</td>&#13;
			<td class="right">0</td>&#13;
			<td class="right">5697</td>&#13;
			<td class="right">1697</td>&#13;
			<td class="right">140</td>&#13;
			<td class="right">62</td>&#13;
			<td class="right">11408</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>7</strong></td>&#13;
			<td class="right">957</td>&#13;
			<td class="right">1748</td>&#13;
			<td class="right">0</td>&#13;
			<td class="right">5262</td>&#13;
			<td class="right">1527</td>&#13;
			<td class="right">100</td>&#13;
			<td class="right">60</td>&#13;
			<td class="right">10296</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>8</strong></td>&#13;
			<td class="right">1847</td>&#13;
			<td class="right">3411</td>&#13;
			<td class="right">0</td>&#13;
			<td class="right">10221</td>&#13;
			<td class="right">2845</td>&#13;
			<td class="right">113</td>&#13;
			<td class="right">115</td>&#13;
			<td class="right">18366</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>9</strong></td>&#13;
			<td class="right">1616</td>&#13;
			<td class="right">3770</td>&#13;
			<td class="right">0</td>&#13;
			<td class="right">12404</td>&#13;
			<td class="right">3407</td>&#13;
			<td class="right">75</td>&#13;
			<td class="right">150</td>&#13;
			<td class="right">18381</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>10</strong></td>&#13;
			<td class="right">616</td>&#13;
			<td class="right">1207</td>&#13;
			<td class="right">0</td>&#13;
			<td class="right">12291</td>&#13;
			<td class="right">2412</td>&#13;
			<td class="right">31</td>&#13;
			<td class="right">169</td>&#13;
			<td class="right">7109</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>11</strong></td>&#13;
			<td class="right">205</td>&#13;
			<td class="right">163</td>&#13;
			<td class="right">0</td>&#13;
			<td class="right">24085</td>&#13;
			<td class="right">2218</td>&#13;
			<td class="right">12</td>&#13;
			<td class="right">308</td>&#13;
			<td class="right">1537</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<p>The cross-tabulation confirms that all of the alcohol cases (<code>type</code> is 3) have an age under 21 (these are coded as 1, 2, 3, and 4). The data values are as expected.</p>&#13;
&#13;
<p>One last type of quality check pertains to the amount of information found in a <span class="keep-together">feature</span>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Quality for Analysis" data-type="sect2"><div class="sect2" id="quality-for-analysis">&#13;
<h2>Quality for Analysis</h2>&#13;
&#13;
<p>Even when data pass the previous quality checks, problems can arise with its usefulness. For example, if all but a handful of values for a feature are identical, then that feature adds little to the understanding of underlying patterns and relationships. Or if there are too many missing values, especially if there is a discernible pattern in the missing values, our findings may be limited. Plus, if a feature has many bad/corrupted values, then we might question the accuracy of even those values that fall in the appropriate range.</p>&#13;
&#13;
<p>We see in the following code that the type of restaurant inspection in San Francisco can be either routine or from a complaint. Since only one of the 14,000+ inspections was from a complaint, we lose little if we drop this feature, and we might also want to drop that single inspection since it represents an anomaly:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code></span><span><code class="n">insp</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
routine      14221&#13;
complaint        1&#13;
Name: type, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Once we find problems with our data, we need to figure out what to do.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Fixing the Data or Not" data-type="sect2"><div class="sect2" id="fixing-the-data-or-not">&#13;
<h2>Fixing the Data or Not</h2>&#13;
&#13;
<p>When you uncover problems with the data, essentially you have four options: leave the data as is, modify values, remove features, or drop records.</p>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Leave it as is</dt>&#13;
	<dd>&#13;
	<p>Not every unusual aspect of the data needs to be fixed. You might have discovered a characteristic of your data that will inform you about how to do your analysis and otherwise does not need correcting. Or you might find that the problem is relatively minor and most likely will not impact your analysis, so you can leave the data as is. Or, you might want to replace corrupted values with <code>NaN</code>.</p>&#13;
	</dd>&#13;
	<dt>Modify individual values</dt>&#13;
	<dd>&#13;
	<p>If you have figured out what went wrong and can correct the value, then you can opt to change it. In this case, it’s a good practice to create a new feature with the modified value and preserve the original feature, like in the CO<sub>2</sub> example.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Remove a column</dt>&#13;
	<dd>&#13;
	<p>If many values in a feature have problems, then consider eliminating that feature entirely. Rather than excluding a feature, there may be a transformation that allows you to keep the feature while reducing the level of detail recorded.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Drop records</dt>&#13;
	<dd>&#13;
	<p>In general, we do not want to drop a large number of observations from a dataset without good reason. Instead, try to scale back your investigation to a particular subgroup of the data that is clearly defined by some criteria, and does not simply correspond dropped records with corrupted values. When you discover that an unusual value is in fact correct, you still might decide to exclude the record from your analysis because it’s so different from the rest of your data and you do not want it to overly influence your analysis.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<p>Whatever approach you take, you will want to study the possible impact of the changes that you make on your analysis. For example, try to determine whether the records with corrupted values are similar to one another, and different from the rest of the data.</p>&#13;
&#13;
<p>Quality checks can reveal issues in the data that need to be addressed before proceeding with analysis. One particularly important type of check is to look for missing values. We suggested that there may be times when you want to replace corrupted data values with <code>NaN</code>, and hence treat them as missing. At other times, data might arrive missing. What to do with missing data is an important topic, and there is a lot of research on this problem; we cover ways to address missing data in the next section<a contenteditable="false" data-primary="" data-startref="ix_df_qual_chk" data-type="indexterm" id="id1132"/><a contenteditable="false" data-primary="" data-startref="ix_qual_chk_df" data-type="indexterm" id="id1133"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Missing Values and Records" data-type="sect1"><div class="sect1" id="ch-wrangling-missing">&#13;
<h1>Missing Values and Records</h1>&#13;
&#13;
<p>In <a class="reference internal" data-type="xref" href="ch03.html#ch-theory-datadesign">Chapter 3</a>, we considered<a contenteditable="false" data-primary="missing values and records" data-secondary="dataframe wrangling" data-type="indexterm" id="ix_miss_val_df"/><a contenteditable="false" data-primary="dataframes" data-secondary="missing values and records" data-type="indexterm" id="ix_df_miss_val"/> the potential problems when the population and the access frame are not in alignment, so we can’t access everyone we want to study. We also described problems when someone refuses to participate in the study. In these cases, entire records/rows are missing, and we discussed the kinds of bias that can occur due to missing records. If nonrespondents differ in critical ways from respondents or if the nonresponse rate is not negligible, then our analysis may be seriously flawed. The example in <a class="reference internal" data-type="xref" href="ch03.html#ch-theory-datadesign">Chapter 3</a> on election polls showed that increasing the sample size without addressing nonresponse does not reduce nonresponse bias. Also in that chapter, we discussed ways to prevent nonresponse. These preventive measures include using incentives to encourage response, keeping surveys short, writing clear questions, training interviewers, and investing in extensive follow-up procedures. Unfortunately, despite these efforts, some amount of nonresponse is unavoidable.</p>&#13;
&#13;
<p>When a record is not entirely missing, but a particular field in a record is unavailable, we have nonresponse at the field level. Some datasets use a special coding to signify that the information is missing. We saw that the Mauna Loa data uses <code>-99.99</code> to indicate a missing CO<sub>2</sub> measurement. We found only seven of these values among 738 rows in the table. In this case, we showed that these missing values have little impact on the analysis.</p>&#13;
&#13;
<p>The values for a feature<a contenteditable="false" data-primary="missing completely at random data" data-type="indexterm" id="id1134"/> are called <em>missing completely at random</em> when those records with the missing data are like a randomly chosen subset of records. That is, whether or not a record has a missing value does not depend on the unobserved feature, the values of other features, or the sampling design. For example, if someone accidentally breaks the laboratory equipment at Mauna Loa and CO<sub>2</sub> is not recorded for a day, there is no reason to think that the level of CO<sub>2</sub> that day had something to do with the lost measurements.</p>&#13;
&#13;
<p>At other times<a contenteditable="false" data-primary="missing at random given covariates data" data-type="indexterm" id="id1135"/>, we consider values <em>missing at random given covariates</em> (covariates are other features in the dataset). For example, the type of an ER visit in the DAWN survey is missing at random given covariates if, say, the nonresponse depends only on race and sex (and not on the type of visit or anything else). In these limited cases, the observed data can be weighted to accommodate for nonresponse.</p>&#13;
&#13;
<p>In some surveys<a contenteditable="false" data-primary="nonresponse bias" data-type="indexterm" id="id1136"/><a contenteditable="false" data-primary="bias" data-secondary="types of" data-type="indexterm" id="id1137"/>, missing information is further categorized as to whether the respondent refused to answer, the respondent was unsure of the answer, or the interviewer didn’t ask the question. Each of these types of missing values is recorded using a different value. For example, according to the <a class="reference external" href="https://oreil.ly/lwBYh">codebook</a>, many questions in the DAWN survey use a code of <code>-7</code> for not applicable, <code>-8</code> for not documented, and <code>-9</code> for missing. Codings such as these can help us further refine our study of nonresponse.</p>&#13;
&#13;
<p>After nonresponse has occurred, it is sometimes possible to use models to predict the missing data. We describe this process next. But remember, predicting missing observations is never as good as observing them in the first place.</p>&#13;
&#13;
<p>At times, we substitute a reasonable value for a missing one to create a “clean” dataframe. This process<a contenteditable="false" data-primary="imputation of missing values" data-type="indexterm" id="id1138"/> is called <em>imputation</em>. Some common approaches for imputing values are <em>deductive</em>, <em>mean</em>, and <em>hot-deck</em> imputation.</p>&#13;
&#13;
<p>In deductive<a contenteditable="false" data-primary="deductive imputation" data-type="indexterm" id="id1139"/> imputation, we fill in a value through logical relationships with other features. For example, here is a row in the business dataframe for San Francisco restaurant inspections. The zip code is erroneously marked as “Ca” and latitude and longitude are missing:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">bus</code></span><span><code class="p">[</code></span><span><code class="n">bus</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">postal_code</code><code class="s1">'</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">==</code></span><code> </code><span><code class="s2">"</code><code class="s2">Ca</code><code class="s2">"</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>name</th>&#13;
			<th>address</th>&#13;
			<th>city</th>&#13;
			<th>...</th>&#13;
			<th>postal_code</th>&#13;
			<th>latitude</th>&#13;
			<th>longitude</th>&#13;
			<th>phone_number</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>5480</strong></td>&#13;
			<td>88139</td>&#13;
			<td>TACOLICIOUS</td>&#13;
			<td>2250 CHESTNUT ST</td>&#13;
			<td>San Francisco</td>&#13;
			<td>...</td>&#13;
			<td>Ca</td>&#13;
			<td>NaN</td>&#13;
			<td>NaN</td>&#13;
			<td>+14156496077</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
1 row × 9 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can look up the address on the USPS website to get the correct zip code, and we can use Google Maps to find the latitude and longitude of the restaurant to fill in these missing values.</p>&#13;
&#13;
<p>Mean<a contenteditable="false" data-primary="mean imputation" data-type="indexterm" id="id1140"/> imputation uses an average value from rows in the dataset that aren’t missing. As a simple example, if a dataset on test scores is missing scores for some students, mean imputation would fill in the missing value using the mean of the nonmissing scores. A key issue with mean imputation is that the variability in the imputed feature will be smaller because the feature now has values that are identical to the mean. This affects later analysis if not handled properly—for instance, confidence intervals will be smaller than they should be (these topics are covered in <a class="reference internal" data-type="xref" href="ch17.html#ch-inf-pred-theory">Chapter 17</a>). The missing values for CO<sub>2</sub> in Mauna Loa used a more sophisticated averaging technique that included neighboring seasonal values.</p>&#13;
&#13;
<p>Hot-deck imputation<a contenteditable="false" data-primary="hot-deck imputation" data-type="indexterm" id="id1141"/> uses a chance process to select a value at random from rows that have values. As a simple example, hot-deck imputation could fill in missing test scores by randomly choosing another test score in the dataset. A potential problem with hot-deck imputation is that the strength of a relationship between the features might weaken because we have added randomness.</p>&#13;
&#13;
<p>For mean and hot-deck imputation, we often impute values based on other records in the dataset that have similar values in other features. More sophisticated imputation techniques use nearest-neighbor methods to find similar subgroups of records and others use regression techniques to predict the missing value.</p>&#13;
&#13;
<p>With all of these types of imputation, we should create a new feature that contains the altered data or a new feature to indicate whether or not the response in the original feature has been imputed so that we can track our changes.</p>&#13;
&#13;
<p>Decisions<a contenteditable="false" data-primary="errors" data-secondary="and missing value handling" data-secondary-sortas="missing value handling" data-type="indexterm" id="id1142"/> to keep or drop a record with a missing value, to change a value, or to remove a feature may seem small, but they can be critical. One anomalous record can seriously impact your findings. Whatever you decide, be sure to check the impact of dropping or changing features and records. And be transparent and thorough in reporting any modifications you make to the data. It’s best to make these changes programmatically to reduce potential errors and enable others to confirm exactly what you have done by reviewing your code.</p>&#13;
&#13;
<p>The same transparency and reproducible precautions hold for data transformations, which we discuss next<a contenteditable="false" data-primary="" data-startref="ix_miss_val_df" data-type="indexterm" id="id1143"/><a contenteditable="false" data-startref="ix_df_miss_val" data-type="indexterm" id="id1144"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Transformations and Timestamps" data-type="sect1"><div class="sect1" id="ch-wrangling-transformations">&#13;
<h1>Transformations and Timestamps</h1>&#13;
&#13;
<p>Sometimes<a contenteditable="false" data-primary="transformations" data-type="indexterm" id="ix_transf_ch9"/><a contenteditable="false" data-primary="dataframes" data-secondary="transforming" data-type="indexterm" id="ix_df_transf2"/> a feature is not in a form well-suited for analysis, and so we transform it. There are many reasons a feature might need a transformation: the value codings might not be useful for analysis, we may want to apply a mathematical function to a feature, or we might want to pull information out of a feature and create a new feature. We describe these three basic kinds of transformations: type conversions, mathematical transformations, and extractions:</p>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Type conversion</dt>&#13;
	<dd>&#13;
	<p>This kind<a contenteditable="false" data-primary="type conversion" data-type="indexterm" id="id1145"/> of transformation occurs when we convert the data from one format to another to make the data more useful for analysis. We might convert information stored as a string to another format. For example, we would want to convert prices reported as strings to numbers (like changing the string <code>"$2.17"</code> to the number 2.17) so that we can compute summary statistics. Or we might want to convert a time stored as a string, such as <code>"1955-10-12"</code>, to a <code>pandas <span class="pre">Timestamp</span></code> object. Yet another example occurs when we lump categories together, such as reducing the 11 categories for age in DAWN to 5 groupings.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Mathematical transformation</dt>&#13;
	<dd>&#13;
	<p>One kind<a contenteditable="false" data-primary="mathematical transformation" data-type="indexterm" id="id1146"/><a contenteditable="false" data-primary="transformations" data-secondary="mathematical" data-type="indexterm" id="id1147"/> of mathematical transformation is when we change the units of a measurement from, say, pounds to kilograms. We might make unit conversions so that statistics on our data can be directly compared to statistics on other datasets. Yet another reason to transform a feature is to make its distribution more symmetric (this notion is covered in more detail in <a class="reference internal" data-type="xref" href="ch10.html#ch-eda">Chapter 10</a>). The most common transformation for handling asymmetry is the logarithm. Lastly, we might want to create a new feature from arithmetic operations. For example, we can combine heights and weights to create body mass indexes by calculating <span class="math notranslate nohighlight"><math> <mtext>height</mtext> <mrow> <mo>/</mo> </mrow> <msup> <mtext>weight</mtext> <mn>2</mn> </msup> </math></span>.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Extraction</dt>&#13;
	<dd>&#13;
	<p>Sometimes<a contenteditable="false" data-primary="extraction, transformation type" data-type="indexterm" id="id1148"/> we want to create a feature by extraction, where the new feature contains partial information taken from another feature. For example, the inspection violations consist of strings with descriptions of violations, and we may only be interested in whether the violation is related to, say, vermin. We can create a new feature that is <code>True</code> if the violation contains the word <em>vermin</em> in its text description and <code>False</code> otherwise. This conversion of information to logical values (or 0–1 values) is extremely useful in data science. The upcoming example in this chapter gives a concrete use-case for these binary features.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<p>We cover many other examples of useful transformations in <a class="reference internal" data-type="xref" href="ch10.html#ch-eda">Chapter 10</a>. For the rest of this section, we explain one more kind of transformation related to working with dates and times. Dates and times appear in many kinds of data, so it’s worth learning how to work with these data types.</p>&#13;
&#13;
<section data-pdf-bookmark="Transforming Timestamps" data-type="sect2"><div class="sect2" id="transforming-timestamps">&#13;
<h2>Transforming Timestamps</h2>&#13;
&#13;
<p>A <em>timestamp</em> is a data value<a contenteditable="false" data-primary="transformations" data-secondary="and timestamps" data-secondary-sortas="timestamps" data-type="indexterm" id="id1149"/><a contenteditable="false" data-primary="restaurant food safety dataset" data-secondary="timestamp transformation" data-type="indexterm" id="ix_rest_dataset_time"/><a contenteditable="false" data-primary="timestamps" data-type="indexterm" id="ix_time_stamp2"/><a contenteditable="false" data-primary="dataframes" data-secondary="timestamps" data-type="indexterm" id="ix_df_time"/><a contenteditable="false" data-primary="data types" data-secondary="temporal" data-type="indexterm" id="id1150"/> that records a specific date and time. For instance, a timestamp could be recorded like <code>Jan <span class="pre">1</span> <span class="pre">2020</span> <span class="pre">2pm</span></code> or <code>2021-01-31 <span class="pre">14:00:00</span></code> or <code>2017 <span class="pre">Mar</span> <span class="pre">03</span> <span class="pre">05:12:41.211</span> <span class="pre">PDT</span></code>. Timestamps come in many different formats! This kind of information can be useful for analysis, because it lets us answer questions like, “What times of day do we have the most website traffic?” When we work with timestamps, we often need to parse them for easier analysis.</p>&#13;
&#13;
<p>Let’s take a look at an example. The inspections dataframe for the San Francisco restaurants includes the date when restaurant inspections happened:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">insp</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">4</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe pagebreak-before less_space">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>score</th>&#13;
			<th>date</th>&#13;
			<th>type</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>94</td>&#13;
			<td>20160513</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>19</td>&#13;
			<td>94</td>&#13;
			<td>20171211</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>24</td>&#13;
			<td>98</td>&#13;
			<td>20171101</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>24</td>&#13;
			<td>98</td>&#13;
			<td>20161005</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>By default, however, <code>pandas</code> reads in the <code>date</code> column as an integer:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">insp</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">dtype</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
dtype('int64')&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>This storage<a contenteditable="false" data-primary="pd.Timestamp object" data-type="indexterm" id="id1151"/> type makes it hard to answer some useful questions about the data. Let’s say we want to know whether inspections happen more often on weekends or weekdays. To answer this question, we want to convert the <code>date</code> column to the <code>pandas</code> <code>Timestamp</code> storage type and extract the day of the week.</p>&#13;
&#13;
<p>The date values<a contenteditable="false" data-primary="to_datetime() method" data-type="indexterm" id="id1152"/> appear to come in the format <code>YYYYMMDD</code>, where <code>YYYY</code>, <code>MM</code>, and <code>DD</code> correspond to the four-digit year, two-digit month, and two-digit day, respectively. The <code>pd.to_datetime()</code> method can parse the date strings into objects, where we can pass in the format of the dates as a <a class="reference external" href="https://oreil.ly/TFWcU">date format</a> string:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">date_format</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="si">%Y</code><code class="si">%m</code></span><span><code class="si">%d</code></span><span><code class="s1">'</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">insp_dates</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">to_datetime</code></span><span><code class="p">(</code></span><span><code class="n">insp</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="nb">format</code></span><span><code class="o">=</code></span><span><code class="n">date_format</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">insp_dates</code></span><span><code class="p">[</code><code class="p">:</code></span><span><code class="mi">3</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
0   2016-05-13&#13;
1   2017-12-11&#13;
2   2017-11-01&#13;
Name: date, dtype: datetime64[ns]&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can see that <code>insp_dates</code> now has a <code>dtype</code> of <code>datetime64[ns]</code>, which means that the values were successfully converted into <code>pd.Timestamp</code> objects.<sup><a data-type="noteref" href="ch09.html#id1153" id="id1153-marker">1</a></sup></p>&#13;
&#13;
<p><code>pandas</code> has special methods and properties for <code>Series</code> objects that hold timestamps using the <code>.dt</code> accessor. For instance, we can easily pull out the year for each <span class="keep-together">timestamp</span>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">insp_dates</code></span><span><code class="o">.</code></span><span><code class="n">dt</code></span><span><code class="o">.</code></span><span><code class="n">year</code></span><span><code class="p">[</code><code class="p">:</code></span><span><code class="mi">3</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
0    2016&#13;
1    2017&#13;
2    2017&#13;
Name: date, dtype: int32&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The <code>pandas</code> documentation<a contenteditable="false" data-primary="dataframes" data-secondary="day_of_week attribute" data-type="indexterm" id="id1154"/><a contenteditable="false" data-primary="dt accessor" data-type="indexterm" id="id1155"/><a contenteditable="false" data-primary="times and dates" data-secondary="day_of_week attribute" data-type="indexterm" id="id1156"/> has the complete details on the <a class="reference external" href="https://oreil.ly/_ceNL"><code>.dt</code> accessor</a>. By looking at the documentation, we see that the <code>.dt.day_of_week</code> attribute gets the day of the week for each timestamp (Monday = 0, Tuesday = 1, …, Sunday = 6). So let’s assign new columns to the dataframe that contain both the parsed timestamps and the day of the week:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">insp</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">insp</code></span><span><code class="o">.</code></span><span><code class="n">assign</code></span><span><code class="p">(</code></span><span><code class="n">timestamp</code></span><span><code class="o">=</code></span><span><code class="n">insp_dates</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>                   </code><span><code class="n">dow</code></span><span><code class="o">=</code></span><span><code class="n">insp_dates</code></span><span><code class="o">.</code></span><span><code class="n">dt</code></span><span><code class="o">.</code></span><span><code class="n">dayofweek</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">insp</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">3</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>score</th>&#13;
			<th>date</th>&#13;
			<th>type</th>&#13;
			<th>timestamp</th>&#13;
			<th>dow</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>94</td>&#13;
			<td>20160513</td>&#13;
			<td>routine</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>4</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>19</td>&#13;
			<td>94</td>&#13;
			<td>20171211</td>&#13;
			<td>routine</td>&#13;
			<td>2017-12-11</td>&#13;
			<td>0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>24</td>&#13;
			<td>98</td>&#13;
			<td>20171101</td>&#13;
			<td>routine</td>&#13;
			<td>2017-11-01</td>&#13;
			<td>2</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now we can see whether restaurant inspectors favor a certain day of the week by grouping on the day of the week:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">insp</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">dow</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">reset_index</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>dow</th>&#13;
			<th>count</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>2</td>&#13;
			<td class="right">3281</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>1</td>&#13;
			<td class="right">3264</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>3</td>&#13;
			<td>2497</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>0</td>&#13;
			<td class="right">2464</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4</strong></td>&#13;
			<td>4</td>&#13;
			<td class="right">2101</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>5</strong></td>&#13;
			<td>6</td>&#13;
			<td class="right">474</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>6</strong></td>&#13;
			<td>5</td>&#13;
			<td class="right">141</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_09in07.png"/></div></figure>&#13;
&#13;
<p>As expected, inspections rarely happen on the weekend. We also find that Tuesday and Wednesday are the most popular days for an inspection.</p>&#13;
&#13;
<p>We have performed many wranglings on the inspections table. One approach to tracking these modifications is to pipe these actions from one to the next. We describe the idea of piping next<a contenteditable="false" data-primary="" data-startref="ix_time_stamp2" data-type="indexterm" id="id1157"/><a contenteditable="false" data-primary="" data-startref="ix_transf_time" data-type="indexterm" id="id1158"/><a contenteditable="false" data-primary="" data-startref="ix_rest_dataset_time" data-type="indexterm" id="id1159"/><a contenteditable="false" data-startref="ix_df_time" data-type="indexterm" id="id1160"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Piping for Transformations" data-type="sect2"><div class="sect2" id="piping-for-transformations">&#13;
<h2>Piping for Transformations</h2>&#13;
&#13;
<p>In data analyses<a contenteditable="false" data-primary="transformations" data-secondary="piping for" data-type="indexterm" id="id1161"/><a contenteditable="false" data-primary="pd.Dataframe object" data-type="indexterm" id="id1162"/><a contenteditable="false" data-primary="Dataframe object" data-type="indexterm" id="id1163"/><a contenteditable="false" data-primary="dataframes" data-secondary="piping for transformations" data-type="indexterm" id="id1164"/>, we typically apply many transformations to the data, and it is easy to introduce bugs when we repeatedly mutate a dataframe, in part because Jupyter notebooks let us run cells in any order we want. As a good practice, we recommend putting transformation code into functions with helpful names and using the <code>DataFrame.pipe()</code> method to chain transformations together.</p>&#13;
&#13;
<p>Let’s rewrite the earlier<a contenteditable="false" data-primary="functions" data-secondary="piping transformations" data-type="indexterm" id="id1165"/><a contenteditable="false" data-primary="pipe() method" data-type="indexterm" id="id1166"/> timestamp parsing code into a function and add the timestamps back into the dataframe as a new column, along with a second column containing the year of the timestamp:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">date_format</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="si">%Y</code><code class="si">%m</code></span><span><code class="si">%d</code></span><span><code class="s1">'</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="k">def</code></span><code> </code><span><code class="nf">parse_dates_and_years</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">column</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">dates</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">to_datetime</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">[</code></span><span><code class="n">column</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="nb">format</code></span><span><code class="o">=</code></span><span><code class="n">date_format</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="n">years</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">dates</code></span><span><code class="o">.</code></span><span><code class="n">dt</code></span><span><code class="o">.</code></span><span><code class="n">year</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">assign</code></span><span><code class="p">(</code></span><span><code class="n">timestamp</code></span><span><code class="o">=</code></span><span><code class="n">dates</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">year</code></span><span><code class="o">=</code></span><span><code class="n">years</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now we can pipe the <code>insp</code> dataframe through this function using <code>.pipe()</code>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">insp</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2">data/inspections.csv</code><code class="s2">"</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>        </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">parse_dates_and_years</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can chain many <code>.pipe()</code> calls together. For example, we can extract the day of the week from the timestamps:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">extract_day_of_week</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">col</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">assign</code></span><span><code class="p">(</code></span><span><code class="n">dow</code></span><span><code class="o">=</code></span><span><code class="n">df</code></span><span><code class="p">[</code></span><span><code class="n">col</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">dt</code></span><span><code class="o">.</code></span><span><code class="n">day_of_week</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">insp</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2">data/inspections.csv</code><code class="s2">"</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>        </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">parse_dates_and_years</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>        </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">extract_day_of_week</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">insp</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>score</th>&#13;
			<th>date</th>&#13;
			<th>type</th>&#13;
			<th>timestamp</th>&#13;
			<th>year</th>&#13;
			<th>dow</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td class="right">94</td>&#13;
			<td>20160513</td>&#13;
			<td>routine</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>2016</td>&#13;
			<td>4</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>19</td>&#13;
			<td class="right">94</td>&#13;
			<td>20171211</td>&#13;
			<td>routine</td>&#13;
			<td>2017-12-11</td>&#13;
			<td>2017</td>&#13;
			<td>0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>24</td>&#13;
			<td class="right">98</td>&#13;
			<td>20171101</td>&#13;
			<td>routine</td>&#13;
			<td>2017-11-01</td>&#13;
			<td>2017</td>&#13;
			<td>2</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>...</strong></td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>14219</strong></td>&#13;
			<td>94142</td>&#13;
			<td class="right">100</td>&#13;
			<td>20171220</td>&#13;
			<td>routine</td>&#13;
			<td>2017-12-20</td>&#13;
			<td>2017</td>&#13;
			<td>2</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>14220</strong></td>&#13;
			<td>94189</td>&#13;
			<td class="right">96</td>&#13;
			<td>20171130</td>&#13;
			<td>routine</td>&#13;
			<td>2017-11-30</td>&#13;
			<td>2017</td>&#13;
			<td>3</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>14221</strong></td>&#13;
			<td>94231</td>&#13;
			<td class="right">85</td>&#13;
			<td>20171214</td>&#13;
			<td>routine</td>&#13;
			<td>2017-12-14</td>&#13;
			<td>2017</td>&#13;
			<td>3</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
14222 rows × 7 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>There are several key advantages of using <code>pipe()</code>. When there are many transformations on a single dataframe, it’s easier to see what transformations happen since we can simply read the function names. Also, we can reuse transformation functions for different dataframes. For instance, the <code>viol</code> dataframe, which contains restaurant safety violations, also has a <code>date</code> column. This means we can use <code>.pipe()</code> to reuse the timestamp parsing function without needing to write extra code. Convenient!</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">viol</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2">data/violations.csv</code><code class="s2">"</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>        </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">parse_dates_and_years</code></span><span><code class="p">)</code><code class="p">)</code></span><code> </code><code>&#13;
</code><span><code class="n">viol</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">2</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>date</th>&#13;
			<th>description</th>&#13;
			<th>timestamp</th>&#13;
			<th>year</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>20171211</td>&#13;
			<td>Inadequate food safety knowledge or lack of ce...</td>&#13;
			<td>2017-12-11</td>&#13;
			<td>2017</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>19</td>&#13;
			<td>20171211</td>&#13;
			<td>Unapproved or unmaintained equipment or utensils</td>&#13;
			<td>2017-12-11</td>&#13;
			<td>2017</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>A different sort of transformation changes the shape of a dataframe by dropping unneeded columns, taking a subset of the rows, or rolling up the rows to a coarser granularity. We describe these structural changes next<a contenteditable="false" data-primary="" data-startref="ix_transf_ch9" data-type="indexterm" id="id1167"/><a contenteditable="false" data-primary="" data-startref="ix_df_transf2" data-type="indexterm" id="id1168"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Modifying Structure" data-type="sect1"><div class="sect1" id="ch-wrangling-structure">&#13;
<h1>Modifying Structure</h1>&#13;
&#13;
<p>If a dataframe has an inconvenient structure<a contenteditable="false" data-primary="dataframe structure" data-secondary="modifying" data-type="indexterm" id="ix_dstruct_mod"/><a contenteditable="false" data-primary="dataframes" data-secondary="modifying structure" data-type="indexterm" id="ix_df_mod_struct"/>, it can be difficult to do the analysis that we want. The wrangling process often reshapes the dataframe in some way to make the analysis easier and more natural. These changes can simply take a subset of the rows and/or columns from the table or change the table’s granularity in a more fundamental way. In this section, we use the techniques from <a class="reference internal" data-type="xref" href="ch06.html#ch-pandas">Chapter 6</a> to show how to modify structure in the following ways:</p>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Simplify the structure</dt>&#13;
	<dd>&#13;
	<p>If a dataframe has features that are not needed in our analysis, then we may want to drop these extraneous columns to make handling the dataframe easier. Or if we want to focus on a particular period of time or geographic area, we may want to take a subset of the rows (subsetting is covered in <a class="reference internal" data-type="xref" href="ch06.html#ch-pandas">Chapter 6</a>). In <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a>, we’ll read into our dataframe a small set of features from the hundreds available in the DAWN survey because we are interested in understanding the patterns of types of ER visit by demographics of the patient. In <a class="reference internal" data-type="xref" href="ch10.html#ch-eda">Chapter 10</a>, we’ll restrict an analysis of home sale prices to one year and a few cities in an effort to reduce the impact of inflation and to better study the effect of location on sale price.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Adjust the granularity</dt>&#13;
	<dd>&#13;
	<p>In an earlier<a contenteditable="false" data-primary="granularity, data table" data-secondary="modifying" data-type="indexterm" id="id1169"/><a contenteditable="false" data-primary="data tables" data-secondary="granularity" data-type="indexterm" id="id1170"/> example in this chapter, CO<sub>2</sub> measurements were aggregated from monthly averages to yearly averages in order to better visualize annual trends. In the next section, we provide another example where we aggregate violation-level data to the inspection level so that it can be combined with the restaurant inspection scores. In both of these examples, we adjust the granularity of the dataframe to work with a coarser granularity by grouping together records and aggregating values. With the CO<sub>2</sub> measurements, we grouped the monthly values from the same year and then averaged them. Other common aggregations of a group are the number of records, sum, minimum, maximum, and first or last value in the group. The details of adjusting granularity of <code>pandas</code> dataframes can be found in <a class="reference internal" data-type="xref" href="ch06.html#ch-pandas">Chapter 6</a>, including how to group by multiple column values.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Address mixed granularity</dt>&#13;
	<dd>&#13;
	<p>At times, a dataset<a contenteditable="false" data-primary="granularity, data table" data-secondary="mixed, addressing" data-type="indexterm" id="id1171"/><a contenteditable="false" data-primary="mixed granularity, addressing" data-type="indexterm" id="id1172"/> might have mixed granularity, where records are at different levels of detail. A common case is in data provided by government agencies where data at the county and state levels are included in the same file. When this happens, we usually want to split the dataframe into two, one at the county level and the other at the state level. This makes county-level and state-level analyses much easier, even feasible, to perform.</p>&#13;
	</dd>&#13;
	<dt>Reshape the structure</dt>&#13;
	<dd>&#13;
	<p>Data, especially from government<a contenteditable="false" data-primary="shape of data table" data-secondary="CO₂ measurements, Mauna Loa Observatory" data-type="indexterm" id="id1173"/><a contenteditable="false" data-primary="CO₂ measurements, Mauna Loa Observatory" data-type="indexterm" id="id1174"/><a contenteditable="false" data-primary="tidy data" data-type="indexterm" id="id1175"/><a contenteditable="false" data-primary="shape of data table" data-secondary="restructuring" data-type="indexterm" id="id1176"/><a contenteditable="false" data-primary="pivot tables" data-type="indexterm" id="id1177"/><a contenteditable="false" data-primary="long form data" data-type="indexterm" id="id1178"/> sources, can be shared as pivot tables. These <em>wide</em> tables have data values as column names and are often difficult to use in analysis. We may need to reshape them into a <em>long</em> form. <a class="reference internal" data-type="xref" href="#wide-vs-long">Figure 9-2</a> depicts the same data stored in both wide and long data tables. Each row of the wide data table maps to three rows in the long data table, as highlighted in the tables. Notice that in the wide data table, each row has three values, one for each month. In the long data table, each row only has a value for one month. Long data tables are generally easier to aggregate for future analysis. Because of this, long-form data is also frequently called <a class="reference external" href="https://doi.org/10.18637/jss.v059.i10"><em>tidy data</em></a>.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="wide-vs-long"><img src="assets/leds_0902.png"/>&#13;
<h6><span class="label">Figure 9-2. </span>An example of a wide data table (top) and a long data table (bottom) containing the same data</h6>&#13;
</div></figure>&#13;
&#13;
<p>To demonstrate reshaping, we can put the CO<sub>2</sub> data into a wide dataframe that is like a pivot table in shape. There is a column for each month and a row for each year:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">co2_pivot</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">pivot_table</code></span><span><code class="p">(</code></span><code>&#13;
</code><code>    </code><span><code class="n">co2</code></span><span><code class="p">[</code></span><span><code class="mi">10</code></span><span><code class="p">:</code></span><span><code class="mi">34</code></span><span><code class="p">]</code><code class="p">,</code></span><code>&#13;
</code><code>    </code><span><code class="n">index</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">Yr</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>   </code><span><code class="c1"># Column to turn into new index</code></span><code>&#13;
</code><code>    </code><span><code class="n">columns</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">Mo</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>  </code><span><code class="c1"># Column to turn into new columns</code></span><code>&#13;
</code><code>    </code><span><code class="n">values</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">Avg</code><code class="s1">'</code></span><span><code class="p">)</code></span><code> </code><span><code class="c1"># Column to aggregate </code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">co2_wide</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">co2_pivot</code></span><span><code class="o">.</code></span><span><code class="n">reset_index</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">display_df</code></span><span><code class="p">(</code></span><span><code class="n">co2_wide</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">cols</code></span><span><code class="o">=</code></span><span><code class="mi">10</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th>Mo</th>&#13;
			<th>Yr</th>&#13;
			<th>1</th>&#13;
			<th>2</th>&#13;
			<th>3</th>&#13;
			<th>4</th>&#13;
			<th>...</th>&#13;
			<th>8</th>&#13;
			<th>9</th>&#13;
			<th>10</th>&#13;
			<th>11</th>&#13;
			<th>12</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>1959</td>&#13;
			<td>315.62</td>&#13;
			<td>316.38</td>&#13;
			<td>316.71</td>&#13;
			<td>317.72</td>&#13;
			<td>...</td>&#13;
			<td>314.80</td>&#13;
			<td>313.84</td>&#13;
			<td>313.26</td>&#13;
			<td>314.8</td>&#13;
			<td>315.58</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>1960</td>&#13;
			<td>316.43</td>&#13;
			<td>316.97</td>&#13;
			<td>317.58</td>&#13;
			<td>319.02</td>&#13;
			<td>...</td>&#13;
			<td>315.91</td>&#13;
			<td>314.16</td>&#13;
			<td>313.83</td>&#13;
			<td>315.0</td>&#13;
			<td>316.19</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
2 rows × 13 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The column headings are months, and the cell values in the grid are the CO<sub>2</sub> monthly averages. We can turn this dataframe back into a long, aka <em>tall</em>, dataframe, where the column names become a feature, called <code>month</code>, and the values in the grid are reorganized into a second feature, called <code>average</code>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">co2_long</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">co2_wide</code></span><span><code class="o">.</code></span><span><code class="n">melt</code></span><span><code class="p">(</code></span><span><code class="n">id_vars</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">Yr</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code>&#13;
</code><code>                         </code><span><code class="n">var_name</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">month</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>                         </code><span><code class="n">value_name</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">average</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">display_df</code></span><span><code class="p">(</code></span><span><code class="n">co2_long</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">rows</code></span><span><code class="o">=</code></span><span><code class="mi">4</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>Yr</th>&#13;
			<th>month</th>&#13;
			<th>average</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>1959</td>&#13;
			<td>1</td>&#13;
			<td>315.62</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>1960</td>&#13;
			<td>1</td>&#13;
			<td>316.43</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>...</strong></td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>22</strong></td>&#13;
			<td>1959</td>&#13;
			<td>12</td>&#13;
			<td>315.58</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>23</strong></td>&#13;
			<td>1960</td>&#13;
			<td>12</td>&#13;
			<td>316.19</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
24 rows × 3 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Notice that the data<a contenteditable="false" data-primary="melt() method" data-type="indexterm" id="id1179"/> has been recaptured in its original shape (although the rows are not in their original order). Wide-form data is more common when we expect readers to look at the data table itself, like in an economics article or news story. But long-form data is more useful for data analysis. For instance, <code>co2_long</code> lets us write short <code>pandas</code> code to group by either year or month, while the wide-form data makes it difficult to group by year. The <code>.melt()</code> method is particularly useful for converting wide-form into long-form data.</p>&#13;
&#13;
<p>These structural modifications have focused on a single table. However, we often want to combine information that is spread across multiple tables. In the next section, we combine the techniques introduced in this chapter to wrangle the restaurant inspection data and address joining tables<a contenteditable="false" data-primary="" data-startref="ix_dstruct_mod" data-type="indexterm" id="id1180"/><a contenteditable="false" data-primary="" data-startref="ix_df_mod_struct" data-type="indexterm" id="id1181"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Example: Wrangling Restaurant Safety Violations" data-type="sect1"><div class="sect1" id="ch-wrangling-restaurants">&#13;
<h1>Example: Wrangling Restaurant Safety Violations</h1>&#13;
&#13;
<p>We wrap up this chapter<a contenteditable="false" data-primary="restaurant food safety dataset" data-secondary="inspections and violations" data-type="indexterm" id="ix_rest_food_dataset_insp"/><a contenteditable="false" data-primary="dataframes" data-secondary="restaurant safety violations" data-type="indexterm" id="ix_df_rest_safe"/> with an example that demonstrates many data wrangling techniques. Recall from <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a> that the San Francisco restaurant inspection data are stored in three tables: <code>bus</code> (for businesses/restaurants), <code>insp</code> (for inspections), and <code>viol</code> (for safety violations). The violations dataset contains detailed descriptions of violations found during an inspection. We would like to capture some of this information and connect it to the inspection score, which is an inspection-level dataset.</p>&#13;
&#13;
<p>Our goal is to figure out the kinds of safety violations associated with lower restaurant safety scores. This example covers several key ideas in data wrangling related to changing structure:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Filtering to focus on a narrower segment of data</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Aggregation to modify the granularity of a table</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Joining to bring together information across tables</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>Additionally, an important part of this example demonstrates how we transform text data into numeric quantities for analysis.</p>&#13;
&#13;
<p>As a first step, let’s simplify the structure by reducing the data to inspections from one year. (Recall that this dataset contains four years of inspection information.) In the following code, we tally the number of records for each year in the inspections table:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code></span><span><code class="n">insp</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">year</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
year&#13;
2016    5443&#13;
2017    5166&#13;
2015    3305&#13;
2018     308&#13;
Name: count, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Reducing the data to cover one year of inspections will simplify our analysis. Later, if we want, we can return to carry out an analysis with all four years of data.</p>&#13;
&#13;
<section data-pdf-bookmark="Narrowing the Focus" data-type="sect2"><div class="sect2" id="narrowing-the-focus">&#13;
<h2>Narrowing the Focus</h2>&#13;
&#13;
<p>We restrict our data<a contenteditable="false" data-primary="filtering data" data-secondary="restaurant food safety focus" data-type="indexterm" id="id1182"/> wrangling to inspections that took place in 2016. Here, we can use the <code>pipe</code> function again in order to apply the same reshaping to both the inspections and violations dataframes:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">subset_2016</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">query</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">year == 2016</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">vio2016</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">viol</code></span><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">subset_2016</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">ins2016</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">insp</code></span><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">subset_2016</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ins2016</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">5</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>score</th>&#13;
			<th>date</th>&#13;
			<th>type</th>&#13;
			<th>timestamp</th>&#13;
			<th>year</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>94</td>&#13;
			<td>20160513</td>&#13;
			<td>routine</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>24</td>&#13;
			<td>98</td>&#13;
			<td>20161005</td>&#13;
			<td>routine</td>&#13;
			<td>2016-10-05</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4</strong></td>&#13;
			<td>24</td>&#13;
			<td>96</td>&#13;
			<td>20160311</td>&#13;
			<td>routine</td>&#13;
			<td>2016-03-11</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>6</strong></td>&#13;
			<td>45</td>&#13;
			<td>78</td>&#13;
			<td>20160104</td>&#13;
			<td>routine</td>&#13;
			<td>2016-01-04</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>9</strong></td>&#13;
			<td>45</td>&#13;
			<td>84</td>&#13;
			<td>20160614</td>&#13;
			<td>routine</td>&#13;
			<td>2016-06-14</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>In <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a>, we found that <code>business_id</code> and <code>timestamp</code> together uniquely identify the inspections (with a couple of exceptions). We also see here that restaurants can receive multiple inspections in a year—business #24 had two inspections in 2016, one in March and another in October.</p>&#13;
&#13;
<p>Next, let’s look at a few records from the violations table:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">vio2016</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">5</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe pagebreak-before less_space">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>date</th>&#13;
			<th>description</th>&#13;
			<th>timestamp</th>&#13;
			<th>year</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>19</td>&#13;
			<td>20160513</td>&#13;
			<td>Unapproved or unmaintained equipment or utensi...</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>19</td>&#13;
			<td>20160513</td>&#13;
			<td>Unclean or degraded floors walls or ceilings ...</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4</strong></td>&#13;
			<td>19</td>&#13;
			<td>20160513</td>&#13;
			<td>Food safety certificate or food handler card n...</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>6</strong></td>&#13;
			<td>24</td>&#13;
			<td>20161005</td>&#13;
			<td>Unclean or degraded floors walls or ceilings ...</td>&#13;
			<td>2016-10-05</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>7</strong></td>&#13;
			<td>24</td>&#13;
			<td>20160311</td>&#13;
			<td>Unclean or degraded floors walls or ceilings ...</td>&#13;
			<td>2016-03-11</td>&#13;
			<td>2016</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Notice that the first few records are for the same restaurant. If we want to bring violation information into the inspections table, we need to address the different granularities of these tables. One approach is to aggregate the violations in some way. We discuss this next.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Aggregating Violations" data-type="sect2"><div class="sect2" id="aggregating-violations">&#13;
<h2>Aggregating Violations</h2>&#13;
&#13;
<p>One simple aggregation<a contenteditable="false" data-primary="aggregation" data-secondary="restaurant safety violations dataset" data-type="indexterm" id="ix_agg_rest_safe"/><a contenteditable="false" data-primary="grouping in data tables" data-secondary="changing granularity with" data-type="indexterm" id="id1183"/> of the violations is to count them and add that count to the inspections data table. To find the number of violations at an inspection, we can group the violations by <code>business_id</code> and <code>timestamp</code> and then find the size of each group. Essentially, this grouping changes the granularity of violations to an inspection level:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">num_vios</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">vio2016</code></span><code>&#13;
</code><code>            </code><span><code class="o">.</code></span><span><code class="n">groupby</code></span><span><code class="p">(</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">business_id</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code><code>            </code><span><code class="o">.</code></span><span><code class="n">size</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>            </code><span><code class="o">.</code></span><span><code class="n">reset_index</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>            </code><span><code class="o">.</code></span><span><code class="n">rename</code></span><span><code class="p">(</code></span><span><code class="n">columns</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="mi">0</code></span><span><code class="p">:</code></span><code> </code><span><code class="s1">'</code><code class="s1">num_vio</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></span><code>&#13;
</code><span><code class="n">num_vios</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">3</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>timestamp</th>&#13;
			<th>num_vio</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>3</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>24</td>&#13;
			<td>2016-03-11</td>&#13;
			<td>2</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>24</td>&#13;
			<td>2016-10-05</td>&#13;
			<td>1</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now we need<a contenteditable="false" data-primary="left joins" data-type="indexterm" id="id1184"/> to merge this new information with <code>ins2016</code>. Specifically, we want to <em>left-join</em> <code>ins2016</code> with <code>num_vios</code> because there could be inspections that do not have any violations and we don’t want to lose them:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">left_join_vios</code></span><span><code class="p">(</code></span><span><code class="n">ins</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">ins</code></span><span><code class="o">.</code></span><span><code class="n">merge</code></span><span><code class="p">(</code></span><span><code class="n">num_vios</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">on</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">business_id</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">how</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">left</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">ins_and_num_vios</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">ins2016</code></span><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">left_join_vios</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">ins_and_num_vios</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe pagebreak-before less_space">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>score</th>&#13;
			<th>date</th>&#13;
			<th>type</th>&#13;
			<th>timestamp</th>&#13;
			<th>year</th>&#13;
			<th>num_vio</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>94</td>&#13;
			<td>20160513</td>&#13;
			<td>routine</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>2016</td>&#13;
			<td>3.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>24</td>&#13;
			<td>98</td>&#13;
			<td>20161005</td>&#13;
			<td>routine</td>&#13;
			<td>2016-10-05</td>&#13;
			<td>2016</td>&#13;
			<td>1.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>24</td>&#13;
			<td>96</td>&#13;
			<td>20160311</td>&#13;
			<td>routine</td>&#13;
			<td>2016-03-11</td>&#13;
			<td>2016</td>&#13;
			<td>2.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>...</strong></td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>5440</strong></td>&#13;
			<td>90096</td>&#13;
			<td>91</td>&#13;
			<td>20161229</td>&#13;
			<td>routine</td>&#13;
			<td>2016-12-29</td>&#13;
			<td>2016</td>&#13;
			<td>2.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>5441</strong></td>&#13;
			<td>90268</td>&#13;
			<td>100</td>&#13;
			<td>20161229</td>&#13;
			<td>routine</td>&#13;
			<td>2016-12-29</td>&#13;
			<td>2016</td>&#13;
			<td>NaN</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>5442</strong></td>&#13;
			<td>90269</td>&#13;
			<td>100</td>&#13;
			<td>20161229</td>&#13;
			<td>routine</td>&#13;
			<td>2016-12-29</td>&#13;
			<td>2016</td>&#13;
			<td>NaN</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
5443 rows × 7 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>When there are no violations at an inspection, the feature <code>num_vio</code> has a missing value (<code>NaN</code>). We can check how many values are missing:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ins_and_num_vios</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">num_vio</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">isnull</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">sum</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
833&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>About 15% of restaurant inspections in 2016 had no safety violations recorded. We can correct these missing values by setting them to 0 if the restaurant had a perfect safety score of 100. This is an example of deductive<a contenteditable="false" data-primary="deductive imputation" data-type="indexterm" id="id1185"/> imputation since we’re using domain knowledge to fill in missing values:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">zero_vios_for_perfect_scores</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">df</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">copy</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">loc</code></span><span><code class="p">[</code></span><span><code class="n">df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">score</code><code class="s1">'</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">==</code></span><code> </code><span><code class="mi">100</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">num_vio</code><code class="s1">'</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">0</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">df</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">ins_and_num_vios</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">ins2016</code></span><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">left_join_vios</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>                    </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">zero_vios_for_perfect_scores</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can count<a contenteditable="false" data-primary="missing values and records" data-secondary="aggregating in restaurant safety data" data-type="indexterm" id="id1186"/> the number of inspections with missing violation counts again:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ins_and_num_vios</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">num_vio</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">isnull</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">sum</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
65&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We have corrected a large number of missing values. With further investigation, we find that some of the businesses have inspection dates that are close but don’t quite match. We could do a fuzzy match where inspections with dates that are only one or two days apart are matched. But for now, we just leave them as <code>NaN</code>.</p>&#13;
&#13;
<p>Let’s examine the relationship between the number of violations and the inspection score:</p>&#13;
&#13;
<figure class="informal width-60"><div class="figure"><img src="assets/leds_09in08.png"/></div></figure>&#13;
&#13;
<p>As we might expect, there is a negative relationship between the inspection score and the number of violations. We can also see variability in scores. The variability in scores grows with the number of violations. It appears that some violations are more serious than others and have a greater impact on the score. We extract information about the kinds of violations next<a contenteditable="false" data-primary="" data-startref="ix_agg_rest_safe" data-type="indexterm" id="id1187"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Extracting Information from Violation Descriptions" data-type="sect2"><div class="sect2" id="extracting-information-from-violation-descriptions">&#13;
<h2>Extracting Information from Violation Descriptions</h2>&#13;
&#13;
<p>We saw earlier<a contenteditable="false" data-primary="feature extraction" data-type="indexterm" id="ix_feat_extract"/><a contenteditable="false" data-primary="extraction, transformation type" data-type="indexterm" id="ix_extract_transf"/> that the feature description in the violations dataframe has a lot of text, including information in square brackets about when the violation was corrected. We can tally the descriptions and examine the most common violations:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">display_df</code><code class="p">(</code><code class="n">vio2016</code><code class="p">[</code><code class="s1">'description'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">()</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="mi">15</code><code class="p">)</code><code class="o">.</code><code class="n">to_frame</code><code class="p">(),</code> <code class="n">rows</code><code class="o">=</code><code class="mi">15</code><code class="p">)</code>&#13;
</pre>&#13;
&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>description</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>Unclean or degraded floors walls or ceilings</strong></td>&#13;
			<td>161</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Unapproved or unmaintained equipment or utensils</strong></td>&#13;
			<td>99</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Moderate risk food holding temperature</strong></td>&#13;
			<td>95</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Inadequate and inaccessible handwashing facilities</strong></td>&#13;
			<td>93</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Inadequately cleaned or sanitized food contact surfaces</strong></td>&#13;
			<td>92</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Improper food storage</strong></td>&#13;
			<td>81</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Wiping cloths not clean or properly stored or inadequate sanitizer</strong></td>&#13;
			<td>71</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Food safety certificate or food handler card not available</strong></td>&#13;
			<td>64</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Moderate risk vermin infestation</strong></td>&#13;
			<td>58</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Foods not protected from contamination</strong></td>&#13;
			<td>56</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Unclean nonfood contact surfaces</strong></td>&#13;
			<td>54</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Inadequate food safety knowledge or lack of certified food safety manager</strong></td>&#13;
			<td>52</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Permit license or inspection report not posted</strong></td>&#13;
			<td>41</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Improper storage of equipment utensils or linens</strong></td>&#13;
			<td>41</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>Low risk vermin infestation</strong></td>&#13;
			<td>34</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<p>Reading through these wordy descriptions, we see that some are related to the cleanliness of facilities, others to food storage, and still others to cleanliness of the staff.</p>&#13;
&#13;
<p>Since there are many types<a contenteditable="false" data-primary="categorical data" data-secondary="transforming data to identify" data-type="indexterm" id="id1188"/><a contenteditable="false" data-primary="transformations" data-secondary="to identify categorical data" data-secondary-sortas="identify categorical data" data-type="indexterm" id="id1189"/> of violations, we can try to group them together into larger categories. One way to do this is to create<a contenteditable="false" data-primary="boolean conditions" data-secondary="extracting information from strings" data-type="indexterm" id="id1190"/> a simple boolean flag depending on whether the text contains a special term, like <em>vermin</em>, <em>hand</em>, or <em>high risk</em>.</p>&#13;
&#13;
<p>With this approach, we create eight new features for different categories of violations. Don’t worry about the particular details of the code for now—this code uses regular expressions, covered in <a class="reference internal" data-type="xref" href="ch13.html#ch-text">Chapter 13</a>. The important idea is that this code creates features containing <code>True</code> or <code>False</code> based on whether the violation description contains specific words:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">make_vio_categories</code></span><span><code class="p">(</code></span><span><code class="n">vio</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="k">def</code></span><code> </code><span><code class="nf">has</code></span><span><code class="p">(</code></span><span><code class="n">term</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>        </code><span><code class="k">return</code></span><code> </code><span><code class="n">vio</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">description</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">str</code></span><span><code class="o">.</code></span><span><code class="n">contains</code></span><span><code class="p">(</code></span><span><code class="n">term</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">vio</code></span><span><code class="p">[</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">business_id</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">assign</code></span><span><code class="p">(</code></span><code>&#13;
</code><code>        </code><span><code class="n">high_risk</code></span><code>        </code><span><code class="o">=</code></span><code> </code><span><code class="n">has</code></span><span><code class="p">(</code></span><span><code class="sa">r</code></span><span><code class="s2">"</code><code class="s2">high risk</code><code class="s2">"</code></span><span><code class="p">)</code><code class="p">,</code></span><code>&#13;
</code><code>        </code><span><code class="n">clean</code></span><code>            </code><span><code class="o">=</code></span><code> </code><span><code class="n">has</code></span><span><code class="p">(</code></span><span><code class="sa">r</code></span><span><code class="s2">"</code><code class="s2">clean|sanit</code><code class="s2">"</code></span><span><code class="p">)</code><code class="p">,</code></span><code>&#13;
</code><code>        </code><span><code class="n">food_surface</code></span><code>     </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">has</code></span><span><code class="p">(</code></span><span><code class="sa">r</code></span><span><code class="s2">"</code><code class="s2">surface</code><code class="s2">"</code></span><span><code class="p">)</code></span><code> </code><span><code class="o">&amp;</code></span><code> </code><span><code class="n">has</code></span><span><code class="p">(</code></span><span><code class="sa">r</code></span><span><code class="s2">"</code><code class="s2">\</code><code class="s2">Wfood</code><code class="s2">"</code></span><span><code class="p">)</code><code class="p">)</code><code class="p">,</code></span><code>&#13;
</code><code>        </code><span><code class="n">vermin</code></span><code>           </code><span><code class="o">=</code></span><code> </code><span><code class="n">has</code></span><span><code class="p">(</code></span><span><code class="sa">r</code></span><span><code class="s2">"</code><code class="s2">vermin</code><code class="s2">"</code></span><span><code class="p">)</code><code class="p">,</code></span><code>&#13;
</code><code>        </code><span><code class="n">storage</code></span><code>          </code><span><code class="o">=</code></span><code> </code><span><code class="n">has</code></span><span><code class="p">(</code></span><span><code class="sa">r</code></span><span><code class="s2">"</code><code class="s2">thaw|cool|therm|storage</code><code class="s2">"</code></span><span><code class="p">)</code><code class="p">,</code></span><code>&#13;
</code><code>        </code><span><code class="n">permit</code></span><code>           </code><span><code class="o">=</code></span><code> </code><span><code class="n">has</code></span><span><code class="p">(</code></span><span><code class="sa">r</code></span><span><code class="s2">"</code><code class="s2">certif|permit</code><code class="s2">"</code></span><span><code class="p">)</code><code class="p">,</code></span><code>&#13;
</code><code>        </code><span><code class="n">non_food_surface</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">has</code></span><span><code class="p">(</code></span><span><code class="sa">r</code></span><span><code class="s2">"</code><code class="s2">wall|ceiling|floor|surface</code><code class="s2">"</code></span><span><code class="p">)</code><code class="p">,</code></span><code>&#13;
</code><code>        </code><span><code class="n">human</code></span><code>            </code><span><code class="o">=</code></span><code> </code><span><code class="n">has</code></span><span><code class="p">(</code></span><span><code class="sa">r</code></span><span><code class="s2">"</code><code class="s2">hand|glove|hair|nail</code><code class="s2">"</code></span><span><code class="p">)</code><code class="p">,</code></span><code>&#13;
</code><code>    </code><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">vio_ctg</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">vio2016</code></span><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">make_vio_categories</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">vio_ctg</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>timestamp</th>&#13;
			<th>high_risk</th>&#13;
			<th>clean</th>&#13;
			<th>...</th>&#13;
			<th>storage</th>&#13;
			<th>permit</th>&#13;
			<th>non_food_surface</th>&#13;
			<th>human</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>19</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>...</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>19</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>False</td>&#13;
			<td>True</td>&#13;
			<td>...</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>True</td>&#13;
			<td>False</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4</strong></td>&#13;
			<td>19</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>...</td>&#13;
			<td>False</td>&#13;
			<td>True</td>&#13;
			<td>False</td>&#13;
			<td>True</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>...</strong></td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>38147</strong></td>&#13;
			<td>89900</td>&#13;
			<td>2016-12-06</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>...</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>38220</strong></td>&#13;
			<td>90096</td>&#13;
			<td>2016-12-29</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>...</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>38221</strong></td>&#13;
			<td>90096</td>&#13;
			<td>2016-12-29</td>&#13;
			<td>False</td>&#13;
			<td>True</td>&#13;
			<td>...</td>&#13;
			<td>False</td>&#13;
			<td>False</td>&#13;
			<td>True</td>&#13;
			<td>False</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
15624 rows × 10 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now that we have these new features in <code>vio_ctg</code>, we can find out whether certain violation categories are more impactful than others. For example, are restaurant scores impacted more for vermin-related violations than permit-related violations?</p>&#13;
&#13;
<p>To do this, we want to first count up the violations per business. Then we can merge this information with the inspection information. First, let’s sum the number of violations for each business:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">vio_counts</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">vio_ctg</code></span><span><code class="o">.</code></span><span><code class="n">groupby</code></span><span><code class="p">(</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">business_id</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">sum</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">reset_index</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">vio_counts</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>timestamp</th>&#13;
			<th>high_risk</th>&#13;
			<th>clean</th>&#13;
			<th>...</th>&#13;
			<th>storage</th>&#13;
			<th>permit</th>&#13;
			<th>non_food_surface</th>&#13;
			<th>human</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>0</td>&#13;
			<td>1</td>&#13;
			<td>...</td>&#13;
			<td>0</td>&#13;
			<td>1</td>&#13;
			<td>1</td>&#13;
			<td>1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>24</td>&#13;
			<td>2016-03-11</td>&#13;
			<td>0</td>&#13;
			<td>2</td>&#13;
			<td>...</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
			<td>2</td>&#13;
			<td>0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>24</td>&#13;
			<td>2016-10-05</td>&#13;
			<td>0</td>&#13;
			<td>1</td>&#13;
			<td>...</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
			<td>1</td>&#13;
			<td>0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>...</strong></td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4803</strong></td>&#13;
			<td>89790</td>&#13;
			<td>2016-11-29</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
			<td>...</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
			<td>1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4804</strong></td>&#13;
			<td>89900</td>&#13;
			<td>2016-12-06</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
			<td>...</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4805</strong></td>&#13;
			<td>90096</td>&#13;
			<td>2016-12-29</td>&#13;
			<td>0</td>&#13;
			<td>1</td>&#13;
			<td>...</td>&#13;
			<td>0</td>&#13;
			<td>0</td>&#13;
			<td>1</td>&#13;
			<td>0</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
4806 rows × 10 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Once again, we use a left join to merge these new features into the inspection-level dataframe. And for the special case of a score of 100, we set all of the new features <span class="keep-together">to <code>0</code>:</span></p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">feature_names</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">high_risk</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">clean</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">food_surface</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">vermin</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>                 </code><span><code class="s1">'</code><code class="s1">storage</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">permit</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">non_food_surface</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">human</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="k">def</code></span><code> </code><span><code class="nf">left_join_features</code></span><span><code class="p">(</code></span><span><code class="n">ins</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">ins</code></span><span><code class="p">[</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">business_id</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">score</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">]</code></span><code>&#13;
</code><code>            </code><span><code class="o">.</code></span><span><code class="n">merge</code></span><span><code class="p">(</code></span><span><code class="n">vio_counts</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">on</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">business_id</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">how</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">left</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="k">def</code></span><code> </code><span><code class="nf">zero_features_for_perfect_scores</code></span><span><code class="p">(</code></span><span><code class="n">ins</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">ins</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">ins</code></span><span><code class="o">.</code></span><span><code class="n">copy</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="n">ins</code></span><span><code class="o">.</code></span><span><code class="n">loc</code></span><span><code class="p">[</code></span><span><code class="n">ins</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">score</code><code class="s1">'</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">==</code></span><code> </code><span><code class="mi">100</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">feature_names</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">0</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">ins</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ins_and_vios</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">ins2016</code></span><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">left_join_features</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>                </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">zero_features_for_perfect_scores</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">ins_and_vios</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">3</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>timestamp</th>&#13;
			<th>score</th>&#13;
			<th>high_risk</th>&#13;
			<th>...</th>&#13;
			<th>storage</th>&#13;
			<th>permit</th>&#13;
			<th>non_food_surface</th>&#13;
			<th>human</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<th>0</th>&#13;
			<td>19</td>&#13;
			<td>2016-05-13</td>&#13;
			<td>94</td>&#13;
			<td>0.0</td>&#13;
			<td>...</td>&#13;
			<td>0.0</td>&#13;
			<td>1.0</td>&#13;
			<td>1.0</td>&#13;
			<td>1.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<th>1</th>&#13;
			<td>24</td>&#13;
			<td>2016-10-05</td>&#13;
			<td>98</td>&#13;
			<td>0.0</td>&#13;
			<td>...</td>&#13;
			<td>0.0</td>&#13;
			<td>0.0</td>&#13;
			<td>1.0</td>&#13;
			<td>0.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<th>2</th>&#13;
			<td>24</td>&#13;
			<td>2016-03-11</td>&#13;
			<td>96</td>&#13;
			<td>0.0</td>&#13;
			<td>...</td>&#13;
			<td>0.0</td>&#13;
			<td>0.0</td>&#13;
			<td>2.0</td>&#13;
			<td>0.0</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
3 rows × 11 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>To see how each violation category relates to the score, we can make a collection of box plots that compare the score distributions with and without each violation<a contenteditable="false" data-primary="" data-startref="ix_feat_extract" data-type="indexterm" id="id1191"/><a contenteditable="false" data-primary="" data-startref="ix_extract_transf" data-type="indexterm" id="id1192"/><a contenteditable="false" data-primary="" data-startref="ix_df_rest_safe" data-type="indexterm" id="id1193"/><a contenteditable="false" data-primary="" data-startref="ix_rest_food_dataset_insp" data-type="indexterm" id="id1194"/>. Since our focus here is on the data’s patterns, not the visualization code, we hide the code (you can see it larger <a href="https://oreil.ly/go29H">online</a>):</p>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_09in09.png"/></div></figure>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="ch-wrangling-summary">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>Data wrangling is an essential part of data analysis. Without it, we risk overlooking problems in data that can have major consequences for our future analysis. This chapter covered several important data wrangling steps that we use in nearly every analysis<a contenteditable="false" data-primary="" data-startref="ix_dataframe_ch9" data-type="indexterm" id="id1195"/>.</p>&#13;
&#13;
<p>We described what to look for in a dataset after we’ve read it into a dataframe. Quality checks help us spot problems in the data. To find bad and missing values, we can take many approaches:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Check summary statistics, distributions, and value counts. <a class="reference internal" data-type="xref" href="ch10.html#ch-eda">Chapter 10</a> provides examples and guidance on how to go about checking the quality of your data using visualizations and summary statistics. We briefly mentioned a few approaches here. A table of counts of unique values in a feature can uncover unexpected encodings and lopsided distributions, where one option is a rare occurrence. Percentiles can be helpful in revealing the proportion of values with unusually high (or low) values.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Use logical expressions to identify records with values that are out of range or relationships that are out of whack. Simply computing the number of records that do not pass the quality check can quickly reveal the size of the problem.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Examine the whole record for those records with problematic values in a particular feature. At times, an entire record is garbled when, for example, a comma is misplaced in a CSV-formatted file. Or the record might represent an unusual <span class="keep-together">situation</span> (such as ranches being included in data on house sales), and you will need to decide whether it should be included in your analysis.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Refer to an external source to figure out if there’s a reason for the anomaly.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>The biggest takeaway for this chapter is to be curious about your data. Look for clues that can reveal the quality of your data. The more evidence you find, the more confidence you will have in your findings. And if you uncover problems, dig deeper. Try to understand and explain any unusual phenomena. A good understanding of your data will help you assess whether an issue that you found is small and can be ignored or corrected, or whether it poses a serious limitation on the usefulness of your data. This curiosity mindset is closely connected to exploratory data analysis, the topic of the next chapter.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id1153"><sup><a href="ch09.html#id1153-marker">1</a></sup> This means that each uses 64 bits of memory for each value and that each is accurate to the nanosecond (or ns, for short).</p></div></div></section></body></html>