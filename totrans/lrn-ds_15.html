<html><head></head><body><section data-pdf-bookmark="Chapter 12. Case Study: How Accurate Are Air Quality Measurements?" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch-pa">&#13;
<h1><span class="label">Chapter 12. </span>Case Study: How Accurate Are <span class="keep-together">Air Quality Measurements?</span></h1>&#13;
&#13;
<p>California<a contenteditable="false" data-primary="air quality sensors study" data-type="indexterm" id="ix_aqs_case_stud_ch12"/> is prone to wildfires, so much so that its residents (like the authors of this book) sometimes say that California is “always on fire.” In 2020, 40 separate fires covered the state in smoke, forced thousands of people to evacuate, and caused more than $12 billion in damages (<a class="reference internal" data-type="xref" href="#fig-ca-fires">Figure 12-1</a>).</p>&#13;
&#13;
<figure><div class="figure" id="fig-ca-fires"><img alt="ca-fires" src="assets/leds_1201.png"/>&#13;
<h6><span class="label">Figure 12-1. </span>Satellite image from August 2020 showing smoke covering California (image from <a class="reference external" href="https://oreil.ly/CrDld">Wikipedia</a> licensed under CC BY-SA 3.0 IGO)</h6>&#13;
</div></figure>&#13;
&#13;
<p>In places like California, people use air quality measurements to learn what kinds of protective measures they need to take. Depending on conditions, people may wish to wear a mask, use air filters, or avoid going outside altogether.</p>&#13;
&#13;
<p>In the US, one important source of air quality information is the <a class="reference external" href="https://www.epa.gov/aqs">Air Quality System</a> (AQS), run by the US government. AQS places high-quality sensors at locations across the US and makes their data available to the public. These sensors are carefully calibrated to strict standards—in fact, the AQS sensors are generally seen as the gold standard for accuracy. However, they have a few downsides. The sensors are expensive: typically between $15,000 and $40,000 each. This means that there are fewer sensors, and they are farther apart. Someone living far away from a sensor might not be able to access AQS data for their personal use. Also, AQS sensors do not provide real-time data. Since the data undergo extensive calibration, they are only released hourly and have a time lag of one to two hours. In essence, the AQS sensors are accurate but not timely.</p>&#13;
&#13;
<p>In contrast, <a class="reference external" href="https://www2.purpleair.com">PurpleAir</a> sensors, which we introduced in <a class="reference internal" data-type="xref" href="ch03.html#ch-theory-datadesign">Chapter 3</a>, sell for about $250 and can be easily installed at home. With the lower price point, thousands of people across the US have purchased these sensors for personal use. The sensors can connect to a home WiFi network so that air quality can be easily monitored, and they can report data back to PurpleAir. In 2020, thousands of owners of PurpleAir sensors made their sensors’ measurements publicly available. Compared to the AQS sensors, PurpleAir sensors are timelier. They report measurements every two minutes rather than every hour. Since there are more deployed PurpleAir sensors, more people live close enough to a sensor to make use of the data. However, PurpleAir sensors are less accurate. To make the sensors affordable, PurpleAir uses a simpler method to count particles in the air. This means that PurpleAir measurements can report that air quality is worse than it really is (see <a class="reference external" href="https://oreil.ly/ZH5aj">Josh Hug’s blog post</a>). In essence, PurpleAir sensors tend to be timely but less accurate.</p>&#13;
&#13;
<p>In this chapter<a contenteditable="false" data-primary="Barkjohn, Karoline" data-type="indexterm" id="id1436"/><a contenteditable="false" data-primary="Clements, Andrea" data-type="indexterm" id="id1437"/><a contenteditable="false" data-primary="Gantt, Brett" data-type="indexterm" id="id1438"/>, we plan to use the AQS sensor measurements to improve the PurpleAir measurements. It’s a big task, and we follow the analysis first developed by <a class="reference external" href="https://oreil.ly/XPxZu">Karoline Barkjohn, Brett Gantt, and Andrea Clements</a> from the US Environmental Protection Agency. Barkjohn and her colleagues’ work was so successful that, as of this writing, the official US government maps, like the AirNow <a class="reference external" href="https://fire.airnow.gov">Fire and Smoke</a> map, include both AQS and PurpleAir sensors and apply Barkjohn’s correction to the PurpleAir data.</p>&#13;
&#13;
<p>Our work follows the data science lifecycle, beginning with considering the question and the scope of the available data. Much of our effort is spent cleaning and wrangling the data into shape for analysis, but we also carry out an exploratory data analysis and build a model for generalization. We begin by considering the question and the design and scope of the data.</p>&#13;
&#13;
<section data-pdf-bookmark="Question, Design, and Scope" data-type="sect1"><div class="sect1" id="ch-pa-scope">&#13;
<h1>Question, Design, and Scope</h1>&#13;
&#13;
<p>Ideally, measures<a contenteditable="false" data-primary="air quality sensors study" data-secondary="question, design, scope" data-type="indexterm" id="ix_aqs_qds"/><a contenteditable="false" data-primary="timeliness versus accuracy of data" data-type="indexterm" id="ix_time_vs_acc"/><a contenteditable="false" data-primary="accuracy" data-type="indexterm" id="ix_acc_ch12"/> of air quality should be both <em>accurate</em> and <em>timely</em>. Inaccurate or biased measurements can mean people do not take air quality as seriously as they should. Delayed alerts can expose people to harmful air. The context provided in the introduction about the popularity of inexpensive air quality sensors got us wondering about their quality and usefulness.</p>&#13;
&#13;
<p>Two different kinds of instruments measure a natural phenomenon—the amount of particulate matter in the air. The AQS sensor has the advantage of small measurement error and negligible bias (see <a class="reference internal" data-type="xref" href="ch02.html#ch-data-scope">Chapter 2</a>). On the other hand, the PurpleAir<a contenteditable="false" data-primary="PurpleAir sensor sites" data-secondary="and accuracy versus timeliness of data" data-secondary-sortas="accuracy versus timeliness of data" data-type="indexterm" id="id1439"/> instrument is less accurate; the measurements have greater variability and are also biased. Our initial question is: can we use the AQS measurements to make the PurpleAir measurements better?</p>&#13;
&#13;
<p>We are in the situation where we have a lot of data available to us. We have access to a small number of high-quality measurements from AQS, and we can get data from thousands of PurpleAir sensors. To narrow the focus of our question, we consider how we might use these two sources of data to improve PurpleAir measurements.</p>&#13;
&#13;
<p>The data from these two sources includes the locations of the sensors. So we can try to pair them up, finding a PurpleAir sensor close to each AQS sensor. If they’re close, then these sensors are essentially measuring the same air. We can treat the AQS sensors as the ground truth (because they are so accurate) and study the variation in the PurpleAir measurements given the true air quality.</p>&#13;
&#13;
<p>Even though there are relatively few pairs of collocated AQS and PurpleAir sensors, it seems reasonable to generalize any relationship we find to other PurpleAir sensors. If there’s a simple relationship between AQS and PurpleAir measurements, then we can use this relationship to adjust measurements from any PurpleAir sensor so that they are more accurate.</p>&#13;
&#13;
<p>We have narrowed down our question quite a bit: can we model the relationship between PurpleAir sensor readings and neighboring AQS sensor readings? If yes, then hopefully we can use the model to improve PurpleAir readings. Spoiler alert: indeed we can!</p>&#13;
&#13;
<p>This case study nicely integrates the concepts introduced in this part of the book. It gives us an opportunity to see how data scientists wrangle, explore, and visualize data in a real-world setting. In particular, we see how a large, less-accurate dataset can amplify the usefulness of a small, accurate dataset. Combining large and small datasets like this is particularly exciting to data scientists and applies broadly to other domains ranging from social science to medicine.</p>&#13;
&#13;
<p>In the next section<a contenteditable="false" data-primary="PM2.5 particles, AQS study" data-type="indexterm" id="id1440"/>, we begin our wrangling by finding the pairs of AQS and PurpleAir sensors that are near each other. We focus specifically on readings for PM2.5 particles, which are particles that are smaller than 2.5 micrometers in diameter. These particles are small enough to be inhaled into the lungs, pose the greatest risk to health, and are especially common in wood smoke<a contenteditable="false" data-primary="" data-startref="ix_aqs_qds" data-type="indexterm" id="id1441"/><a contenteditable="false" data-primary="" data-startref="ix_time_vs_acc" data-type="indexterm" id="id1442"/><a contenteditable="false" data-primary="" data-startref="ix_acc_ch12" data-type="indexterm" id="id1443"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Finding Collocated Sensors" data-type="sect1"><div class="sect1" id="sec-pa-collocated">&#13;
<h1>Finding Collocated Sensors</h1>&#13;
&#13;
<p>Our analysis<a contenteditable="false" data-primary="air quality sensors study" data-secondary="AQS sites" data-type="indexterm" id="ix_aqs_sites"/><a contenteditable="false" data-primary="air quality sensors study" data-secondary="collocated sensors, finding" data-type="indexterm" id="ix_aqs_coll_sensors"/> begins by finding collocated pairs of AQS and PurpleAir sensors—sensors that are placed essentially next to each other. This step is important because it lets us reduce the effects of other variables that might cause differences in sensor readings. Consider what would happen if we compared an AQS sensor placed in a park with a PurpleAir sensor placed along a busy freeway. The two sensors would have different readings, in part because the sensors are exposed to different environments. Ensuring that sensors are truly collocated lets us claim the differences in sensor readings are due to how the sensors are built and to small, localized air fluctuations, rather than other potential confounding variables.</p>&#13;
&#13;
<p>Barkjohn’s analysis conducted by the EPA group found pairs of AQS and PurpleAir sensors that are installed within 50 meters of each other. The group contacted each AQS site to see whether the PurpleAir sensor was also maintained there. This extra effort gave them confidence that their sensor pairs were truly collocated.</p>&#13;
&#13;
<p>In this section, we explore and clean location data from AQS and PurpleAir. Then we perform a join of sorts to construct a list of potentially collocated sensors. We won’t contact AQS sites ourselves; instead, we proceed in later sections with Barkjohn’s list of confirmed collocated sensors.</p>&#13;
&#13;
<p>We downloaded a list of AQS and PurpleAir sensors and saved the data in the files <em>data/list_of_aqs_sites.csv</em> and <em>data/list_of_purpleair_sensors.json</em>. Let’s begin by reading these files into <code>pandas DataFrames</code>. First, we check file sizes to see whether they are reasonable to load into memory:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="err">!</code></span><code class="n">ls</code><code> </code><code class="o">-</code><code class="n">lLh</code><code> </code><code class="n">data</code><code class="o">/</code><code class="n">list_of</code><code class="o">*</code><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
-rw-r--r--  1 sam  staff   4.8M Oct 27 16:54 data/list_of_aqs_sites.csv&#13;
-rw-r--r--  1 sam  staff   3.8M Oct 22 16:10 data/list_of_purpleair_sensors.json&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Both files are relatively small. Let’s start with the list of AQS sites.</p>&#13;
&#13;
<section data-pdf-bookmark="Wrangling the List of AQS Sites" data-type="sect2"><div class="sect2" id="wrangling-the-list-of-aqs-sites">&#13;
<h2>Wrangling the List of AQS Sites</h2>&#13;
&#13;
<p>We have filtered<a contenteditable="false" data-primary="comma-separated value (CSV) file format" data-type="indexterm" id="id1444"/><a contenteditable="false" data-primary="CSV (comma-separated value) file format" data-type="indexterm" id="id1445"/><a contenteditable="false" data-primary="air quality sensors study" data-secondary="list of" data-type="indexterm" id="ix_aqs_list"/> the <a class="reference external" href="https://oreil.ly/EkZcB">AQS map of sites</a> to show only the AQS sites that measure PM2.5, and then downloaded the list of sites as a CSV file using the map’s web app. Now we can load it into a <code>pandas DataFrame</code>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs_sites_full</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/list_of_aqs_sites.csv</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">aqs_sites_full</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
(1333, 28)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>There are 28 columns in the table. Let’s check the column names:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs_sites_full</code></span><span><code class="o">.</code></span><span><code class="n">columns</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
Index(['AQS_Site_ID', 'POC', 'State', 'City', 'CBSA', 'Local_Site_Name',&#13;
       'Address', 'Datum', 'Latitude', 'Longitude', 'LatLon_Accuracy_meters',&#13;
       'Elevation_meters_MSL', 'Monitor_Start_Date', 'Last_Sample_Date',&#13;
       'Active', 'Measurement_Scale', 'Measurement_Scale_Definition',&#13;
       'Sample_Duration', 'Sample_Collection_Frequency',&#13;
       'Sample_Collection_Method', 'Sample_Analysis_Method',&#13;
       'Method_Reference_ID', 'FRMFEM', 'Monitor_Type', 'Reporting_Agency',&#13;
       'Parameter_Name', 'Annual_URLs', 'Daily_URLs'],&#13;
      dtype='object')&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>To find out which columns are most useful for us, we reference the <a class="reference external" href="https://oreil.ly/GvMPI">data dictionary</a> that the AQS provides on its website. There we confirm that the data table contains information about the AQS sites. So we might expect the granularity corresponds to an AQS site, meaning each row represents a single site and the column labeled <code>AQS_Site_ID</code> is the primary key. We can confirm this with a count of records for each ID:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs_sites_full</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">AQS_Site_ID</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
06-071-0306    4&#13;
19-163-0015    4&#13;
39-061-0014    4&#13;
              ..&#13;
46-103-0020    1&#13;
19-177-0006    1&#13;
51-680-0015    1&#13;
Name: AQS_Site_ID, Length: 921, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>It looks like some sites appear multiple times in this dataframe. Unfortunately, this means that the granularity is finer than the individual site level. To figure out why sites are duplicated, let’s take a closer look at the rows for one duplicated site:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">dup_site</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">aqs_sites_full</code></span><span><code class="o">.</code></span><span><code class="n">query</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2">AQS_Site_ID == </code><code class="s2">'</code><code class="s2">19-163-0015</code><code class="s2">'</code><code class="s2">"</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We select a few columns to examine based on their names—those that sound like they might shed some light on the reason for duplicates:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">some_cols</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">POC</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Monitor_Start_Date</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>             </code><span><code class="s1">'</code><code class="s1">Last_Sample_Date</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Sample_Collection_Method</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="n">dup_site</code></span><span><code class="p">[</code></span><span><code class="n">some_cols</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>POC</th>&#13;
			<th>Monitor_Start_Date</th>&#13;
			<th>Last_Sample_Date</th>&#13;
			<th>Sample_Collection_Method</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>458</strong></td>&#13;
			<td>1</td>&#13;
			<td>1/27/1999</td>&#13;
			<td>8/31/2021</td>&#13;
			<td>R &amp; P Model 2025 PM-2.5 Sequential Air Sampler...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>459</strong></td>&#13;
			<td>2</td>&#13;
			<td>2/9/2013</td>&#13;
			<td>8/26/2021</td>&#13;
			<td>R &amp; P Model 2025 PM-2.5 Sequential Air Sampler...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>460</strong></td>&#13;
			<td>3</td>&#13;
			<td>1/1/2019</td>&#13;
			<td>9/30/2021</td>&#13;
			<td>Teledyne T640 at 5.0 LPM</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>461</strong></td>&#13;
			<td>4</td>&#13;
			<td>1/1/2019</td>&#13;
			<td>9/30/2021</td>&#13;
			<td>Teledyne T640 at 5.0 LPM</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p class="pagebreak-before less_space">The <code>POC</code> column looks to be useful for distinguishing between rows in the table. The data dictionary states this about the column:</p>&#13;
&#13;
<blockquote>&#13;
<div>&#13;
<p>This is the “Parameter Occurrence Code” used to distinguish different instruments that measure the same parameter at the same site.</p>&#13;
</div>&#13;
</blockquote>&#13;
&#13;
<p>So, the site <code>19-163-0015</code> has four instruments that all measure PM2.5. The granularity of the dataframe is at the level of a single instrument.</p>&#13;
&#13;
<p>Since our aim is to match AQS and PurpleAir sensors, we can adjust the granularity by selecting one instrument from each AQS site. To do this, we group rows according to site ID, then take the first row in each group:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">rollup_dup_sites</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="p">(</code></span><code>&#13;
</code><code>        </code><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">groupby</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">AQS_Site_ID</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>        </code><span><code class="o">.</code></span><span><code class="n">first</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>        </code><span><code class="o">.</code></span><span><code class="n">reset_index</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs_sites</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">aqs_sites_full</code></span><code>&#13;
</code><code>             </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">rollup_dup_sites</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">aqs_sites</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
(921, 28)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now the number of rows matches the number of unique IDs.</p>&#13;
&#13;
<p>To match AQS sites with PurpleAir sensors, we only need the site ID, latitude, and longitude. So we further adjust the structure and keep only those columns:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">cols_aqs</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">subset</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">df</code></span><span><code class="p">[</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">AQS_Site_ID</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Latitude</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Longitude</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">]</code></span><code>&#13;
</code><code>    </code><span><code class="n">subset</code></span><span><code class="o">.</code></span><span><code class="n">columns</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">site_id</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">lat</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">lon</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">subset</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs_sites</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">aqs_sites_full</code></span><code>&#13;
</code><code>             </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">rollup_dup_sites</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>             </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">cols_aqs</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now the <code>aqs_sites</code> dataframe is ready, and we move to the PurpleAir sites<a contenteditable="false" data-primary="" data-startref="ix_aqs_list" data-type="indexterm" id="id1446"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Wrangling the List of PurpleAir Sites" data-type="sect2"><div class="sect2" id="wrangling-the-list-of-purpleair-sites">&#13;
<h2>Wrangling the List of PurpleAir Sites</h2>&#13;
&#13;
<p>Unlike<a contenteditable="false" data-primary="air quality sensors study" data-secondary="PurpleAir sites" data-type="indexterm" id="ix_aqs_purp_air"/><a contenteditable="false" data-primary="JSON (JavaScript Object Notation)" data-type="indexterm" id="id1447"/><a contenteditable="false" data-primary="PurpleAir sensor sites" data-secondary="list of" data-type="indexterm" id="ix_purp_air_sens"/><a contenteditable="false" data-primary="data exchange" data-secondary="JSON" data-type="indexterm" id="id1448"/> the AQS sites, the file containing PurpleAir sensor data comes in a JSON format. We address this format in more detail in <a class="reference internal" data-type="xref" href="ch14.html#ch-web">Chapter 14</a>. For now, we use shell tools (see <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a>) to peek at the file contents:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="err">!</code></span><code class="n">head</code><code> </code><code class="n">data</code><code class="o">/</code><code class="n">list_of_purpleair_sensors</code><code class="o">.</code><code class="n">json</code><code> </code><span><code class="o">|</code></span><code> </code><code class="n">cut</code><code> </code><code class="o">-</code><code class="n">c</code><code> </code><span><code class="mi">1</code></span><code class="o">-</code><code class="mi">60</code><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
{"version":"7.0.30",&#13;
"fields":&#13;
["ID","pm","pm_cf_1","pm_atm","age","pm_0","pm_1","pm_2","pm&#13;
"data":[&#13;
[20,0.0,0.0,0.0,0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,97,0.0,0.0,0.0&#13;
[47,null,null,null,4951,null,null,null,null,null,null,null,9&#13;
[53,0.0,0.0,0.0,0,0.0,0.0,0.0,0.0,1.2,5.2,6.0,97,0.0,0.5,702&#13;
[74,0.0,0.0,0.0,0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,97,0.0,0.0,0.0&#13;
[77,9.8,9.8,9.8,1,9.8,10.7,11.0,11.2,13.8,15.1,15.5,97,9.7,9&#13;
[81,6.5,6.5,6.5,0,6.5,6.1,6.1,6.6,8.1,8.3,9.7,97,5.9,6.8,405&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>From the first few lines of the file, we can guess that the data are stored in the <code>"data"</code> key and the column labels in the <code>"fields"</code> key. We can use Python’s <code>json</code> library to read in the file as a Python <code>dict</code>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">import</code></span><code> </code><span><code class="nn">json</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="k">with</code></span><code> </code><span><code class="nb">open</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/list_of_purpleair_sensors.json</code><code class="s1">'</code></span><span><code class="p">)</code></span><code> </code><span><code class="k">as</code></span><code> </code><span><code class="n">f</code></span><span><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">pa_json</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">json</code></span><span><code class="o">.</code></span><span><code class="n">load</code></span><span><code class="p">(</code></span><span><code class="n">f</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="nb">list</code></span><span><code class="p">(</code></span><span><code class="n">pa_json</code></span><span><code class="o">.</code></span><span><code class="n">keys</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
['version', 'fields', 'data', 'count']&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can create a dataframe from the values in <code>data</code> and label the columns with the content of <code>fields</code>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pa_sites_full</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">DataFrame</code></span><span><code class="p">(</code></span><span><code class="n">pa_json</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">columns</code></span><span><code class="o">=</code></span><span><code class="n">pa_json</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">fields</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa_sites_full</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>ID</th>&#13;
			<th>pm</th>&#13;
			<th>pm_cf_1</th>&#13;
			<th>pm_atm</th>&#13;
			<th>...</th>&#13;
			<th>Voc</th>&#13;
			<th>Ozone1</th>&#13;
			<th>Adc</th>&#13;
			<th>CH</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>20</td>&#13;
			<td>0.0</td>&#13;
			<td>0.0</td>&#13;
			<td>0.0</td>&#13;
			<td>...</td>&#13;
			<td>NaN</td>&#13;
			<td>NaN</td>&#13;
			<td>0.01</td>&#13;
			<td>1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>47</td>&#13;
			<td>NaN</td>&#13;
			<td>NaN</td>&#13;
			<td>NaN</td>&#13;
			<td>...</td>&#13;
			<td>NaN</td>&#13;
			<td>0.72</td>&#13;
			<td>0.72</td>&#13;
			<td>0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>53</td>&#13;
			<td>0.0</td>&#13;
			<td>0.0</td>&#13;
			<td>0.0</td>&#13;
			<td>...</td>&#13;
			<td>NaN</td>&#13;
			<td>NaN</td>&#13;
			<td>0.00</td>&#13;
			<td>1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>74</td>&#13;
			<td>0.0</td>&#13;
			<td>0.0</td>&#13;
			<td>0.0</td>&#13;
			<td>...</td>&#13;
			<td>NaN</td>&#13;
			<td>NaN</td>&#13;
			<td>0.05</td>&#13;
			<td>1</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4</strong></td>&#13;
			<td>77</td>&#13;
			<td>9.8</td>&#13;
			<td>9.8</td>&#13;
			<td>9.8</td>&#13;
			<td>...</td>&#13;
			<td>NaN</td>&#13;
			<td>NaN</td>&#13;
			<td>0.01</td>&#13;
			<td>1</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
5 rows × 36 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Like the AQS data, there are many more columns in this dataframe than we need:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pa_sites_full</code></span><span><code class="o">.</code></span><span><code class="n">columns</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
Index(['ID', 'pm', 'pm_cf_1', 'pm_atm', 'age', 'pm_0', 'pm_1', 'pm_2', 'pm_3',&#13;
       'pm_4', 'pm_5', 'pm_6', 'conf', 'pm1', 'pm_10', 'p1', 'p2', 'p3', 'p4',&#13;
       'p5', 'p6', 'Humidity', 'Temperature', 'Pressure', 'Elevation', 'Type',&#13;
       'Label', 'Lat', 'Lon', 'Icon', 'isOwner', 'Flags', 'Voc', 'Ozone1',&#13;
       'Adc', 'CH'],&#13;
      dtype='object')&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>In this case, we can guess that the columns we’re most interested in are the sensor IDs (<code>ID</code>), sensor labels (<code>Label</code>), latitude (<code>Lat</code>), and longitude (<code>Lon</code>). But we did consult the data dictionary on the PurpleAir website to double-check.</p>&#13;
&#13;
<p>Now let’s check the <code>ID</code> column for duplicates, as we did for the AQS data:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pa_sites_full</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">ID</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">[</code><code class="p">:</code></span><span><code class="mi">3</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
85829     1&#13;
117575    1&#13;
118195    1&#13;
Name: ID, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Since the <code>value_counts()</code> method lists the counts in descending order, we can see that every ID was included only once. So we have verified the granularity is at the individual sensor level. Next, we keep only the columns needed to match sensor locations from the two sources:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">cols_pa</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">subset</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">df</code></span><span><code class="p">[</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">ID</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Label</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Lat</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Lon</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">]</code></span><code>&#13;
</code><code>    </code><span><code class="n">subset</code></span><span><code class="o">.</code></span><span><code class="n">columns</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">label</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">lat</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">lon</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">subset</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pa_sites</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa_sites_full</code></span><code>&#13;
</code><code>            </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">cols_pa</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa_sites</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
(23138, 4)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Notice there are tens of thousands more PurpleAir sensors than AQS sensors. Our next task is to find the PurpleAir sensor close to each AQS sensor.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Matching AQS and PurpleAir Sensors" data-type="sect2"><div class="sect2" id="matching-aqs-and-purpleair-sensors">&#13;
<h2>Matching AQS and PurpleAir Sensors</h2>&#13;
&#13;
<p>Our goal is to match sensors in the two dataframes by finding a PurpleAir sensor near each AQS instrument. We consider near to mean within 50 meters. This kind of matching is a bit more challenging than the joins we’ve seen thus far. For instance, the naive approach to use the <code>merge</code> method of <code>pandas</code> fails us:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs_sites</code></span><span><code class="o">.</code></span><span><code class="n">merge</code></span><span><code class="p">(</code></span><span><code class="n">pa_sites</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">left_on</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">lat</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">lon</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">right_on</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">lat</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">lon</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>site_id</th>&#13;
			<th>lat</th>&#13;
			<th>lon</th>&#13;
			<th>id</th>&#13;
			<th>label</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>06-111-1004</td>&#13;
			<td>34.45</td>&#13;
			<td>-119.23</td>&#13;
			<td>48393</td>&#13;
			<td>VCAPCD OJ</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We cannot simply match instruments with the exact same latitude and longitude; we need to find the PurpleAir sites that are close enough to the AQS instrument.</p>&#13;
&#13;
<p>To figure out how far apart two locations are, we use a basic approximation: <code>111,111</code> meters in the north-south direction roughly equals one degree of latitude, and <code>111,111 <span class="pre">*</span> <span class="pre">cos(latitude)</span></code> in the east-west direction corresponds to one degree of longitude.<sup><a data-type="noteref" href="ch12.html#id1449" id="id1449-marker">1</a></sup> So we can find the latitude and longitude ranges that correspond to 25 meters in each direction (to make a 50-meter-by-50-meter rectangle around each point):</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">magic_meters_per_lat</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">111_111</code></span><code>&#13;
</code><span><code class="n">offset_in_m</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">25</code></span><code>&#13;
</code><span><code class="n">offset_in_lat</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">offset_in_m</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="n">magic_meters_per_lat</code></span><code>&#13;
</code><span><code class="n">offset_in_lat</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
0.000225000225000225&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>To simplify even more, we use the median latitude for the AQS sites:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">median_latitude</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">aqs_sites</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">lat</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">median</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">magic_meters_per_lon</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">111_111</code></span><code> </code><span><code class="o">*</code></span><code> </code><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">cos</code></span><span><code class="p">(</code></span><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">radians</code></span><span><code class="p">(</code></span><span><code class="n">median_latitude</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">offset_in_lon</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">offset_in_m</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="n">magic_meters_per_lon</code></span><code>&#13;
</code><span><code class="n">offset_in_lon</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
0.000291515219937587&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now we can match coordinates to within the <code>offset_in_lat</code> and <code>offset_in_lon</code>. Doing this in SQL is much easier than in <code>pandas</code>, so we push the tables into a temporary SQLite database, then run a query to read the tables back into a dataframe:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">import</code></span><code> </code><span><code class="nn">sqlalchemy</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">db</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">sqlalchemy</code></span><span><code class="o">.</code></span><span><code class="n">create_engine</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">sqlite://</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">aqs_sites</code></span><span><code class="o">.</code></span><span><code class="n">to_sql</code></span><span><code class="p">(</code></span><span><code class="n">name</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">aqs</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">con</code></span><span><code class="o">=</code></span><span><code class="n">db</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">index</code></span><span><code class="o">=</code></span><span><code class="kc">False</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa_sites</code></span><span><code class="o">.</code></span><span><code class="n">to_sql</code></span><span><code class="p">(</code></span><span><code class="n">name</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pa</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">con</code></span><span><code class="o">=</code></span><span><code class="n">db</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">index</code></span><span><code class="o">=</code></span><span><code class="kc">False</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">query</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="sa">f</code></span><span><code class="s1">'''</code></span><code class="s1">&#13;
</code><span><code class="s1">SELECT</code></span><code class="s1">&#13;
</code><span><code class="s1">  aqs.site_id AS aqs_id,</code></span><code class="s1">&#13;
</code><span><code class="s1">  pa.id AS pa_id,</code></span><code class="s1">&#13;
</code><span><code class="s1">  pa.label AS pa_label,</code></span><code class="s1">&#13;
</code><span><code class="s1">  aqs.lat AS aqs_lat,</code></span><code class="s1">&#13;
</code><span><code class="s1">  aqs.lon AS aqs_lon,</code></span><code class="s1">&#13;
</code><span><code class="s1">  pa.lat AS pa_lat,</code></span><code class="s1">&#13;
</code><span><code class="s1">  pa.lon AS pa_lon</code></span><code class="s1">&#13;
</code><span><code class="s1">FROM aqs JOIN pa</code></span><code class="s1">&#13;
</code><span><code class="s1">  ON  pa.lat - </code></span><span><code class="si">{</code></span><span><code class="n">offset_in_lat</code></span><span><code class="si">}</code></span><span><code class="s1"> &lt;= aqs.lat</code></span><code class="s1">&#13;
</code><span><code class="s1">  AND                             aqs.lat &lt;= pa.lat + </code></span><span><code class="si">{</code></span><span><code class="n">offset_in_lat</code></span><span><code class="si">}</code></span><code class="s1">&#13;
</code><span><code class="s1">  AND pa.lon - </code></span><span><code class="si">{</code></span><span><code class="n">offset_in_lon</code></span><span><code class="si">}</code></span><span><code class="s1"> &lt;= aqs.lon</code></span><code class="s1">&#13;
</code><span><code class="s1">  AND                             aqs.lon &lt;= pa.lon + </code></span><span><code class="si">{</code></span><span><code class="n">offset_in_lon</code></span><span><code class="si">}</code></span><code class="s1">&#13;
</code><span><code class="s1">'''</code></span><code>&#13;
</code><span><code class="n">matched</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_sql</code></span><span><code class="p">(</code></span><span><code class="n">query</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">db</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">matched</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>aqs_id</th>&#13;
			<th>pa_id</th>&#13;
			<th>pa_label</th>&#13;
			<th>aqs_lat</th>&#13;
			<th>aqs_lon</th>&#13;
			<th>pa_lat</th>&#13;
			<th>pa_lon</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>06-019-0011</td>&#13;
			<td class="right">6568</td>&#13;
			<td>IMPROVE_FRES2</td>&#13;
			<td>36.79</td>&#13;
			<td>-119.77</td>&#13;
			<td>36.79</td>&#13;
			<td>-119.77</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>06-019-0011</td>&#13;
			<td class="right">13485</td>&#13;
			<td>AMTS_Fresno</td>&#13;
			<td>36.79</td>&#13;
			<td>-119.77</td>&#13;
			<td>36.79</td>&#13;
			<td>-119.77</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>06-019-0011</td>&#13;
			<td class="right">44427</td>&#13;
			<td>Fresno CARB CCAC</td>&#13;
			<td>36.79</td>&#13;
			<td>-119.77</td>&#13;
			<td>36.79</td>&#13;
			<td>-119.77</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>...</strong></td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>146</strong></td>&#13;
			<td>53-061-1007</td>&#13;
			<td class="right">3659</td>&#13;
			<td>Marysville 7th</td>&#13;
			<td>48.05</td>&#13;
			<td>-122.17</td>&#13;
			<td>48.05</td>&#13;
			<td>-122.17</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>147</strong></td>&#13;
			<td>53-063-0021</td>&#13;
			<td class="right">54603</td>&#13;
			<td>Augusta 1 SRCAA</td>&#13;
			<td>47.67</td>&#13;
			<td>-117.36</td>&#13;
			<td>47.67</td>&#13;
			<td>-117.36</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>148</strong></td>&#13;
			<td>56-021-0100</td>&#13;
			<td class="right">50045</td>&#13;
			<td>WDEQ-AQD Cheyenne NCore</td>&#13;
			<td>41.18</td>&#13;
			<td>-104.78</td>&#13;
			<td>41.18</td>&#13;
			<td>-104.78</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
149 rows × 7 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We’ve achieved our goal—we matched 149 AQS sites with PurpleAir sensors. Our wrangling of the locations is complete, and we turn to the task of wrangling and cleaning the sensor measurements. We start with the measurements taken from an AQS site<a contenteditable="false" data-primary="" data-startref="ix_purp_air_sens" data-type="indexterm" id="id1450"/><a contenteditable="false" data-primary="" data-startref="ix_aqs_coll_sensors" data-type="indexterm" id="id1451"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Wrangling and Cleaning AQS Sensor Data" data-type="sect1"><div class="sect1" id="ch-pa-cleaning-aqs">&#13;
<h1>Wrangling and Cleaning AQS Sensor Data</h1>&#13;
&#13;
<p>Now that we have located<a contenteditable="false" data-primary="air quality sensors study" data-secondary="wrangling sensor data" data-type="indexterm" id="ix_aqs_clean_data"/> sensors that are near each other, we are ready to wrangle and clean the files that contain the measurement data for these sites. We demonstrate the tasks involved with one AQS instrument and its matching PurpleAir sensor. We picked a pair located in Sacramento, California. The AQS sensor ID is <code>06-067-0010</code>, and the PurpleAir sensor name is <code>AMTS_TESTINGA</code>.</p>&#13;
&#13;
<p>The AQS provides a website and <a class="reference external" href="https://oreil.ly/tl_nc">API</a> to download sensor data. We downloaded the daily measurements from May 20, 2018, to December 29, 2019, into the <em>data/aqs_06-067-0010.csv</em> file. Let’s begin by loading this file into a dataframe:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs_full</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/aqs_06-067-0010.csv</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">aqs_full</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
(2268, 31)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>From the <a class="reference external" href="https://oreil.ly/e1PjI">data dictionary</a>, we find out that the column called <code>arithmetic_mean</code> corresponds to the actual PM2.5 measurements. Some AQS sensors take a measurement every hour. For our analysis, we downloaded the 24-hour averages (the arithmetic mean) of the hourly sensor measurements.</p>&#13;
&#13;
<p>Let’s carry out some quality<a contenteditable="false" data-primary="data scope" data-secondary="air quality example" data-type="indexterm" id="id1452"/> checks and clean the data where necessary. We focus on checks related to scope and quality of values:</p>&#13;
&#13;
<ol class="arabic simple">&#13;
	<li>&#13;
	<p>Check and correct the granularity of the data.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Remove unneeded columns.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Check values in the <code>date_local</code> column.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Check values in the <code>arithmetic_mean</code> column.</p>&#13;
	</li>&#13;
</ol>&#13;
&#13;
<p>For the sake of brevity, we’ve chosen a few important quality checks that specifically reinforce ideas we’ve covered in data wrangling, EDA, and visualization.</p>&#13;
&#13;
<section data-pdf-bookmark="Checking Granularity" data-type="sect2"><div class="sect2" id="checking-granularity">&#13;
<h2>Checking Granularity</h2>&#13;
&#13;
<p>We would like each row<a contenteditable="false" data-primary="data tables" data-secondary="granularity" data-type="indexterm" id="ix_data_table_gran2"/><a contenteditable="false" data-primary="granularity, data table" data-secondary="air quality sensors study" data-type="indexterm" id="ix_gran_aqs_stud"/> of our data to correspond to a single date with an average PM2.5 reading for that date. As we saw earlier, a simple way to check is to see whether there are repeat values in the <code>date_local</code> column:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs_full</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
date_local&#13;
2019-01-03    12&#13;
2018-12-31    12&#13;
2018-12-28    12&#13;
              ..&#13;
2018-11-28    12&#13;
2018-11-25    12&#13;
2018-11-22    12&#13;
Name: count, Length: 189, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Indeed, there are 12 rows for each date, so the granularity is <em>not</em> at the individual date level.</p>&#13;
&#13;
<p>From the data dictionary, we learn that there are multiple standards for computing the final measurements from the raw sensor data. The <code>pollutant_standard</code> column contains the name of each standard. The <code>event_type</code> column marks whether data measured during “exceptional events” are included in the measurement. Let’s check how different these average values are by calculating the range of 12 measurements:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="p">(</code></span><span><code class="n">aqs_full</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">groupby</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code> </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">arithmetic_mean</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">agg</code></span><span><code class="p">(</code></span><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">ptp</code></span><span><code class="p">)</code></span><code> </code><span><code class="c1"># np.ptp computes max() - min()</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
arithmetic_mean&#13;
0.0    189&#13;
Name: count, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>For all 189 dates, the max PM2.5–min PM2.5 is 0. This means that we can simply take the first PM2.5 measurement for each date:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">rollup_dates</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="p">(</code></span><code>&#13;
</code><code>        </code><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">groupby</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>        </code><span><code class="o">.</code></span><span><code class="n">first</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>        </code><span><code class="o">.</code></span><span><code class="n">reset_index</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">aqs_full</code></span><code>&#13;
</code><code>       </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">rollup_dates</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">aqs</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
(189, 31)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>This data-cleaning step gives us the desired granularity: each row represents a single date, with an average PM2.5 measurement for that date. Next, we further modify the structure of the dataframe and drop unneeded columns<a contenteditable="false" data-primary="" data-startref="ix_data_table_gran2" data-type="indexterm" id="id1453"/><a contenteditable="false" data-primary="" data-startref="ix_gran_aqs_stud" data-type="indexterm" id="id1454"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Removing Unneeded Columns" data-type="sect2"><div class="sect2" id="removing-unneeded-columns">&#13;
<h2>Removing Unneeded Columns</h2>&#13;
&#13;
<p>We plan to match the PM2.5 measurements in the AQS dataframe with the PurpleAir PM2.5 measurements for each date. To simplify the structure, we can drop all but the date and PM2.5 columns. We also rename the PM2.5 column so that it’s easier to understand:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">drop_cols</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">subset</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">df</code></span><span><code class="p">[</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">arithmetic_mean</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">]</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">subset</code></span><span><code class="o">.</code></span><span><code class="n">rename</code></span><span><code class="p">(</code></span><span><code class="n">columns</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">arithmetic_mean</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="s1">'</code><code class="s1">pm25</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">aqs_full</code></span><code>&#13;
</code><code>       </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">rollup_dates</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>       </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">drop_cols</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">aqs</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>date_local</th>&#13;
			<th>pm25</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>2018-05-20</td>&#13;
			<td class="right">6.5</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>2018-05-23</td>&#13;
			<td class="right">2.3</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>2018-05-29</td>&#13;
			<td class="right">11.8</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>2018-06-01</td>&#13;
			<td class="right">6.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4</strong></td>&#13;
			<td>2018-06-04</td>&#13;
			<td class="right">8.0</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now that we have the desired shape for our data table, we turn to checking the data values.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Checking the Validity of Dates" data-type="sect2"><div class="sect2" id="checking-the-validity-of-dates">&#13;
<h2>Checking the Validity of Dates</h2>&#13;
&#13;
<p>Let’s take a closer look at the dates. We have already seen that there are gaps when there are no PM2.5 readings, so we expect there are missing dates. Let’s parse the dates as timestamp objects to make it easier to figure out which dates are missing. As we did in <a class="reference internal" data-type="xref" href="ch09.html#ch-wrangling">Chapter 9</a>, we check the format:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">iloc</code></span><span><code class="p">[</code><code class="p">:</code></span><span><code class="mi">3</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
0    2018-05-20&#13;
1    2018-05-23&#13;
2    2018-05-29&#13;
Name: date_local, dtype: object&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The dates<a contenteditable="false" data-primary="strings" data-secondary="and converting dates to timestamps" data-secondary-sortas="converting dates to timestamps" data-type="indexterm" id="id1455"/><a contenteditable="false" data-primary="times and dates" data-secondary="converting date strings to timestamps" data-type="indexterm" id="id1456"/> are represented as YYYY-MM-DD, so we describe the format in the Python representation <code>'%Y-%m-%d'</code>. To parse the dates, we use the <code>pd.to_datetime()</code> function, and we reassign the <code>date_local</code> column as <code>pd.TimeStamp</code>s:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">parse_dates</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">date_format</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="si">%Y</code><code class="s1">-</code><code class="si">%m</code><code class="s1">-</code></span><span><code class="si">%d</code></span><span><code class="s1">'</code></span><code>&#13;
</code><code>    </code><span><code class="n">timestamps</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">to_datetime</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="nb">format</code></span><span><code class="o">=</code></span><span><code class="n">date_format</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">assign</code></span><span><code class="p">(</code></span><span><code class="n">date_local</code></span><span><code class="o">=</code></span><span><code class="n">timestamps</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">aqs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">aqs_full</code></span><code>&#13;
</code><code>       </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">rollup_dates</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>       </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">drop_cols</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>       </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">parse_dates</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The method runs without erroring, indicating that all the strings matched the format.</p>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Just because the dates can be parsed doesn’t mean that the dates are immediately ready to use for further analysis. For instance, the string <code>9999-01-31</code> can be parsed into a <code>pd.TimeStamp</code>, but the date isn’t valid.</p>&#13;
</div>&#13;
&#13;
<p>Now that the dates have been converted to timestamps, we can calculate how many dates are missing. We find the number of days between the earliest and latest dates—this corresponds to the maximum number of measurements we could have recorded:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">date_range</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">aqs</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">max</code></span><span><code class="p">(</code><code class="p">)</code></span><code> </code><span><code class="o">-</code></span><code> </code><span><code class="n">aqs</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">min</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">date_range</code></span><span><code class="o">.</code></span><span><code class="n">days</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
588&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Subtracting timestamps<a contenteditable="false" data-primary="Timedelta object" data-type="indexterm" id="id1457"/> gives <code>Timedelta</code> objects, which as we see have a few useful properties. There are many dates missing from the data. However, when we combine these data for this sensor with other sensors, we expect to have enough data to fit a model.</p>&#13;
&#13;
<p>Our final wrangling step is to check the quality of the PM2.5 measurements.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Checking the Quality of PM2.5 Measurements" data-type="sect2"><div class="sect2" id="checking-the-quality-of-pm2-5-measurements">&#13;
<h2>Checking the Quality of PM2.5 Measurements</h2>&#13;
&#13;
<p>Particulate<a contenteditable="false" data-primary="PM2.5 particles, AQS study" data-type="indexterm" id="id1458"/> matter is measured in micrograms per cubic meter of air (µg/m<sup>3</sup>). (There are 1 million micrograms in 1 gram, and 1 pound is equal to about 450 grams.) The <a class="reference external" href="https://oreil.ly/XqVqG">EPA has set a standard</a> of 35 µg/m<sup>3</sup> for a daily average of PM2.5 and 12 µg/m<sup>3</sup> for an annual average. We can use this information to make a few basic checks on the PM2.5 measurements. First, PM2.5 can’t go below 0. Second, we can look for abnormally high PM2.5 values and see whether they correspond to major events like a wildfire.</p>&#13;
&#13;
<p>One visual way to perform these checks is to plot the PM2.5 measurement against the date:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">scatter</code></span><span><code class="p">(</code></span><span><code class="n">aqs</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pm25</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>           </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">date_local</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">Date</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">pm25</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">AQS daily avg PM2.5</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">,</code></span><code>&#13;
</code><code>           </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">500</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal width-75"><div class="figure"><img src="assets/leds_12in01.png"/></div></figure>&#13;
&#13;
<p>We see that the PM2.5 measurements don’t go below 0 and are typically lower than the EPA level. We also found a large spike in PM2.5 around mid-November of 2018. This sensor is located in Sacramento, so we can check if there was a fire around that area.</p>&#13;
&#13;
<p>Indeed, November 8, 2018, marks the start of the Camp Fire, the “deadliest and most destructive wildfire in California history” (see the <a class="reference external" href="https://oreil.ly/tqxtH">Camp Fire page</a> managed by the US Census Bureau). The fire started just 80 miles north of Sacramento, so this AQS sensor captured the dramatic spike in PM2.5.</p>&#13;
&#13;
<p>We’ve cleaned and explored the data for one AQS sensor. In the next section, we do the same for its collocated PurpleAir sensor<a contenteditable="false" data-primary="" data-startref="ix_aqs_sites" data-type="indexterm" id="id1459"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Wrangling PurpleAir Sensor Data" data-type="sect1"><div class="sect1" id="ch-pa-cleaning-pa">&#13;
<h1>Wrangling PurpleAir Sensor Data</h1>&#13;
&#13;
<p>In the previous<a contenteditable="false" data-primary="PurpleAir sensor sites" data-secondary="wrangling sensor data" data-type="indexterm" id="ix_purp_sens_wr"/> section, we analyzed data from AQS site <code>06-067-0010</code>. The matching PurpleAir sensor is named <code>AMTS_TESTINGA</code>, and we’ve used the PurpleAir website to download the data for this sensor into the <em>data/purpleair_AMTS</em> folder:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="err">!</code></span><code class="n">ls</code><code> </code><code class="o">-</code><code class="n">alh</code><code> </code><code class="n">data</code><code class="o">/</code><code class="n">purpleair_AMTS</code><code class="o">/</code><code class="o">*</code><code> </code><span><code class="o">|</code></span><code> </code><code class="n">cut</code><code> </code><code class="o">-</code><code class="n">c</code><code> </code><span><code class="mi">1</code></span><code class="o">-</code><code class="mi">72</code><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
-rw-r--r--  1 nolan  staff    50M Jan 25 16:35 data/purpleair_AMTS/AMTS_&#13;
-rw-r--r--  1 nolan  staff    50M Jan 25 16:35 data/purpleair_AMTS/AMTS_&#13;
-rw-r--r--  1 nolan  staff    48M Jan 25 16:35 data/purpleair_AMTS/AMTS_&#13;
-rw-r--r--  1 nolan  staff    50M Jan 25 16:35 data/purpleair_AMTS/AMTS_&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>There are four CSV files. Their names are quite long, and the beginning of each is identical. The data dictionary for the PurpleAir data says that each sensor has two separate instruments, A and B, that each record data. Note that the PurpleAir site we used to collect these data and the accompanying data dictionary has been downgraded. The data are now available through a REST API. The <a class="reference external" href="https://oreil.ly/WSciR">site that documents the API</a> also contains information about the fields. (The topic of REST is covered in <a class="reference internal" data-type="xref" href="ch14.html#ch-web">Chapter 14</a>.) Let’s examine the later portions of the filenames:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="err">!</code></span><code class="n">ls</code><code> </code><code class="o">-</code><code class="n">alh</code><code> </code><code class="n">data</code><code class="o">/</code><code class="n">purpleair_AMTS</code><code class="o">/</code><code class="o">*</code><code> </code><span><code class="o">|</code></span><code> </code><code class="n">cut</code><code> </code><code class="o">-</code><code class="n">c</code><code> </code><span><code class="mi">73</code></span><code class="o">-</code><code class="mi">140</code><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
TESTING (outside) (38.568404 -121.493163) Primary Real Time 05_20_20&#13;
TESTING (outside) (38.568404 -121.493163) Secondary Real Time 05_20_&#13;
TESTING B (undefined) (38.568404 -121.493163) Primary Real Time 05_2&#13;
TESTING B (undefined) (38.568404 -121.493163) Secondary Real Time 05&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can see that the first two CSV files correspond to instrument A and the last two to B. Having two instruments is useful for data cleaning; if A and B disagree about a measurement, we might question the integrity of the measurement and decide to remove it.</p>&#13;
&#13;
<p>The data dictionary also mentions that each instrument records Primary and Secondary data. The Primary data contains the fields we’re interested in: PM2.5, temperature, and humidity. The Secondary data contains data for other particle sizes, like PM1.0 and PM10. So we work only with the Primary files.</p>&#13;
&#13;
<p>Our tasks are similar to those of the previous section, with the addition of addressing readings from two instruments.</p>&#13;
&#13;
<p>We begin by loading in the data. When CSV files have long names, we can assign the filenames into a Python variable to more easily load the files:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">from</code></span><code> </code><span><code class="nn">pathlib</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">Path</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">data_folder</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/purpleair_AMTS</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa_csvs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="nb">sorted</code></span><span><code class="p">(</code></span><span><code class="n">data_folder</code></span><span><code class="o">.</code></span><span><code class="n">glob</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">*.csv</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa_csvs</code></span><span><code class="p">[</code></span><span><code class="mi">0</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
PosixPath('data/purpleair_AMTS/AMTS_TESTING (outside) (38.568404 -121.493163) Primary Real Time 05_20_2018 12_29_2019.csv')&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pa_full</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="n">pa_csvs</code></span><span><code class="p">[</code></span><span><code class="mi">0</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa_full</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
(672755, 11)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Let’s look at the columns to see which ones we need:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pa_full</code></span><span><code class="o">.</code></span><span><code class="n">columns</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
Index(['created_at', 'entry_id', 'PM1.0_CF1_ug/m3', 'PM2.5_CF1_ug/m3',&#13;
       'PM10.0_CF1_ug/m3', 'UptimeMinutes', 'RSSI_dbm', 'Temperature_F',&#13;
       'Humidity_%', 'PM2.5_ATM_ug/m3', 'Unnamed: 10'],&#13;
      dtype='object')&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Although we’re interested in PM2.5, it appears there are two columns that contain PM2.5 data: <code>PM2.5_CF1_ug/m3</code> and <code>PM2.5_ATM_ug/m3</code>. We investigate the difference between these two columns to find that PurpleAir sensors use two different methods to convert a raw laser recording into a PM2.5 number. These two calculations correspond to the CF1 and ATM columns. Barkjohn found that using CF1 produced better results than ATM, so we keep that column, along with the date, temperature, and relative humidity:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">drop_and_rename_cols</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">df</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">df</code></span><span><code class="p">[</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">created_at</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">PM2.5_CF1_ug/m3</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Temperature_F</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Humidity_</code><code class="s1">%</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">]</code></span><code>&#13;
</code><code>    </code><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">columns</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">PM25cf1</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">TempF</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">RH</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">df</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">pa</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa_full</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">drop_and_rename_cols</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>timestamp</th>&#13;
			<th>PM25cf1</th>&#13;
			<th>TempF</th>&#13;
			<th>RH</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>2018-05-20 00:00:35 UTC</td>&#13;
			<td>1.23</td>&#13;
			<td>83.0</td>&#13;
			<td>32.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>2018-05-20 00:01:55 UTC</td>&#13;
			<td>1.94</td>&#13;
			<td>83.0</td>&#13;
			<td>32.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>2018-05-20 00:03:15 UTC</td>&#13;
			<td>1.80</td>&#13;
			<td>83.0</td>&#13;
			<td>32.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>2018-05-20 00:04:35 UTC</td>&#13;
			<td>1.64</td>&#13;
			<td>83.0</td>&#13;
			<td>32.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4</strong></td>&#13;
			<td>2018-05-20 00:05:55 UTC</td>&#13;
			<td>1.33</td>&#13;
			<td>83.0</td>&#13;
			<td>32.0</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Next we check granularity.</p>&#13;
&#13;
<section data-pdf-bookmark="Checking the Granularity" data-type="sect2"><div class="sect2" id="checking-the-granularity">&#13;
<h2>Checking the Granularity</h2>&#13;
&#13;
<p>In order for the granularity<a contenteditable="false" data-primary="data tables" data-secondary="granularity" data-type="indexterm" id="ix_data_table_gran3"/><a contenteditable="false" data-primary="granularity, data table" data-secondary="air quality sensors study" data-type="indexterm" id="ix_gran_purp_stud"/> of these measurements to match the AQS data, we want one average PM2.5 for each date (a 24-hour period). PurpleAir states that sensors take measurements every two minutes. Let’s double-check the granularity of the raw measurements before we aggregate them to 24-hour periods.</p>&#13;
&#13;
<p>To do this we convert<a contenteditable="false" data-primary="strings" data-secondary="and converting dates to timestamps" data-secondary-sortas="converting dates to timestamps" data-type="indexterm" id="id1460"/><a contenteditable="false" data-primary="times and dates" data-secondary="converting strings to timestamps" data-type="indexterm" id="id1461"/> the column containing the date information from strings to <code>pd.TimeStamp</code> objects. The format of the date is different than the AQS format, which we describe as <code>'%Y-%m-%d <span class="pre">%X</span> <span class="pre">%Z'</span></code>. As we soon see, <code>pandas</code> has special support for dataframes with an index of timestamps:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">parse_timestamps</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">date_format</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="si">%Y</code><code class="s1">-</code><code class="si">%m</code><code class="s1">-</code></span><span><code class="si">%d</code></span><span><code class="s1"> </code></span><span><code class="si">%X</code></span><span><code class="s1"> </code><code class="s1">%</code><code class="s1">Z</code><code class="s1">'</code></span><code>&#13;
</code><code>    </code><span><code class="n">times</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">to_datetime</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="nb">format</code></span><span><code class="o">=</code></span><span><code class="n">date_format</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">assign</code></span><span><code class="p">(</code></span><span><code class="n">timestamp</code></span><span><code class="o">=</code></span><span><code class="n">times</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>            </code><span><code class="o">.</code></span><span><code class="n">set_index</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">pa</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa_full</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">drop_and_rename_cols</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">parse_timestamps</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">2</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>PM25cf1</th>&#13;
			<th>TempF</th>&#13;
			<th>RH</th>&#13;
		</tr>&#13;
		<tr>&#13;
			<th>timestamp</th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>2018-05-20 00:00:35+00:00</strong></td>&#13;
			<td>1.23</td>&#13;
			<td>83.0</td>&#13;
			<td>32.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2018-05-20 00:01:55+00:00</strong></td>&#13;
			<td>1.94</td>&#13;
			<td>83.0</td>&#13;
			<td>32.0</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Timestamps<a contenteditable="false" data-primary="tz_convert() method" data-type="indexterm" id="id1462"/><a contenteditable="false" data-primary="time zones, handling" data-type="indexterm" id="id1463"/> are tricky—notice that the original timestamps were given in the UTC time zone. However, the AQS data were averaged according to the <em>local time in California</em>, which is either seven or eight hours behind UTC time, depending on whether daylight saving time is in effect. This means we need to change the time zone of the PurpleAir timestamps to match the local time zone. The <code>df.tz_convert()</code> method operates on the index of the dataframe, which is one reason why we set the index of <code>pa</code> to the timestamps:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">convert_tz</code></span><span><code class="p">(</code></span><span><code class="n">pa</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">tz_convert</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">US/Pacific</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">pa</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa_full</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">drop_and_rename_cols</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">parse_timestamps</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">convert_tz</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">2</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>PM25cf1</th>&#13;
			<th>TempF</th>&#13;
			<th>RH</th>&#13;
		</tr>&#13;
		<tr>&#13;
			<th>timestamp</th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>2018-05-19 17:00:35-07:00</strong></td>&#13;
			<td>1.23</td>&#13;
			<td>83.0</td>&#13;
			<td>32.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2018-05-19 17:01:55-07:00</strong></td>&#13;
			<td>1.94</td>&#13;
			<td>83.0</td>&#13;
			<td>32.0</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>If we compare the first two rows of this version of the dataframe to the previous one, we see that the time has changed to indicate the seven-hour difference from UTC.</p>&#13;
&#13;
<p>Visualizing timestamps can help us check the granularity of the data.</p>&#13;
&#13;
<section data-pdf-bookmark="Visualizing timestamps" data-type="sect3"><div class="sect3" id="visualizing-timestamps">&#13;
<h3>Visualizing timestamps</h3>&#13;
&#13;
<p>One way to visualize<a contenteditable="false" data-primary="times and dates" data-secondary="grouping time series data" data-type="indexterm" id="id1464"/><a contenteditable="false" data-primary="resample() method" data-type="indexterm" id="id1465"/><a contenteditable="false" data-primary="timestamps" data-type="indexterm" id="ix_time_stamp3"/> timestamps is to count how many appear in each 24-hour period, then plot those counts over time. To group time-series data in <code>pandas</code>, we can use the <code>df.resample()</code> method. This method works on dataframes that have an index of timestamps. It behaves like <code>df.groupby()</code>, except that we can specify how we want the timestamps to be grouped—we can group into dates, weeks, months, and many more options (the <code>D</code> argument tells <code>resample</code> to aggregate timestamps into individual dates):</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">per_day</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">resample</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">D</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>           </code><span><code class="o">.</code></span><span><code class="n">size</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>           </code><span><code class="o">.</code></span><span><code class="n">rename</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">records_per_day</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>           </code><span><code class="o">.</code></span><span><code class="n">to_frame</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">percs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="mi">10</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">25</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">50</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">75</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">100</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">percentile</code></span><span><code class="p">(</code></span><span><code class="n">per_day</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">records_per_day</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">percs</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">method</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">lower</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
array([ 293,  720, 1075, 1440, 2250])&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We see that the number of measurements in a day varies widely. A line plot of these counts gives us a better sense of these variations<a contenteditable="false" data-primary="variation" data-secondary="air quality data" data-type="indexterm" id="id1466"/>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">line</code></span><span><code class="p">(</code></span><span><code class="n">per_day</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="n">per_day</code></span><span><code class="o">.</code></span><span><code class="n">index</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">records_per_day</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><code>&#13;
</code><code>        </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">Date</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">records_per_day</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">Records per day</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">,</code></span><code>&#13;
</code><code>        </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">550</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">,</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_12in02.png"/></div></figure>&#13;
&#13;
<p>This is a fascinating plot. We see clear gaps in the data where there are no measurements. It appears that significant portions of data in July 2018 and September 2019 are missing. Even when the sensor appears to be working, the number of measurements per day is slightly different. For instance, the plot is “bumpy” between August and October 2018, where dates have a varying number of measurements. We need to decide what we want to do with missing data. But perhaps more urgently: there are strange “steps” in the plot. Some dates have around 1,000 readings, some around 2,000, some around 700, and some around 1,400. If a sensor takes measurements every two minutes, there should be a maximum of 720 measurements per day. For a perfect sensor, the plot would display a flat line at 720 measurements. This is clearly not the case. Let’s investigate<a contenteditable="false" data-primary="" data-startref="ix_time_stamp3" data-type="indexterm" id="id1467"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Checking the sampling rate" data-type="sect3"><div class="sect3" id="checking-the-sampling-rate">&#13;
<h3>Checking the sampling rate</h3>&#13;
&#13;
<p>Deeper<a contenteditable="false" data-primary="filtering data" data-secondary="timestamps" data-type="indexterm" id="id1468"/><a contenteditable="false" data-primary="samples and sampling" data-secondary="PurpleAir sampling rate check" data-type="indexterm" id="id1469"/> digging reveals that although PurpleAir sensors currently record data every 120 seconds, this was not always the case. Before May 30, 2019, sensors recorded data every 80 seconds, or 1,080 points a day. The change in sampling rate does explain the drop on May 30, 2019. Let’s next look at the time periods where there were many more points than expected. This could mean that some measurements were duplicated in the data. We can check this by looking at the measurements for one day, say, January 1, 2019. We pass a string into <code>.loc</code> to filter timestamps for that date:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="nb">len</code></span><span><code class="p">(</code></span><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">loc</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">2019-01-01</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
2154&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>There are almost double the 1,080 expected readings. Let’s check to see if readings are duplicated:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">loc</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">2019-01-01</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">index</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
2019-01-01 13:52:30-08:00    2&#13;
2019-01-01 12:02:21-08:00    2&#13;
2019-01-01 11:49:01-08:00    2&#13;
                            ..&#13;
2019-01-01 21:34:10-08:00    2&#13;
2019-01-01 11:03:41-08:00    2&#13;
2019-01-01 04:05:38-08:00    2&#13;
Name: timestamp, Length: 1077, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Each timestamp appears exactly twice, and we can verify that all duplicated dates contain the same PM2.5 reading. Since this is also true for both temperature and humidity, we drop the duplicate rows from the dataframe:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">drop_duplicate_rows</code></span><span><code class="p">(</code></span><span><code class="n">df</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="n">df</code></span><span><code class="p">[</code></span><span><code class="o">~</code></span><span><code class="n">df</code></span><span><code class="o">.</code></span><span><code class="n">index</code></span><span><code class="o">.</code></span><span><code class="n">duplicated</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">]</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">pa</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa_full</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">drop_and_rename_cols</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">parse_timestamps</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">convert_tz</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">drop_duplicate_rows</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
(502628, 3)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>To check, we remake the line plot of the number of records for a day, and this time we shade the regions where the counts are supposed to be contained:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">per_day</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">resample</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">D</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">size</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">rename</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">records_per_day</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">to_frame</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">fig</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">line</code></span><span><code class="p">(</code></span><span><code class="n">per_day</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="n">per_day</code></span><span><code class="o">.</code></span><span><code class="n">index</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">records_per_day</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>              </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">Date</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">records_per_day</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">Records per day</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">,</code></span><code> </code><code>&#13;
</code><code>              </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">550</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">add_annotation</code></span><span><code class="p">(</code></span><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">2019-07-24</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="mi">720</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>            </code><span><code class="n">text</code></span><span><code class="o">=</code></span><span><code class="s2">"</code><code class="s2">720</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">showarrow</code></span><span><code class="o">=</code></span><span><code class="kc">False</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">yshift</code></span><span><code class="o">=</code></span><span><code class="mi">10</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">add_annotation</code></span><span><code class="p">(</code></span><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">2019-07-24</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="mi">1080</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>            </code><span><code class="n">text</code></span><span><code class="o">=</code></span><span><code class="s2">"</code><code class="s2">1080</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">showarrow</code></span><span><code class="o">=</code></span><span><code class="kc">False</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">yshift</code></span><span><code class="o">=</code></span><span><code class="mi">10</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">add_hline</code></span><span><code class="p">(</code></span><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="mi">1080</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">line_width</code></span><span><code class="o">=</code></span><span><code class="mi">3</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">line_dash</code></span><span><code class="o">=</code></span><span><code class="s2">"</code><code class="s2">dot</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">opacity</code></span><span><code class="o">=</code></span><span><code class="mf">0.6</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">add_hline</code></span><span><code class="p">(</code></span><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="mi">720</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">line_width</code></span><span><code class="o">=</code></span><span><code class="mi">3</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">line_dash</code></span><span><code class="o">=</code></span><span><code class="s2">"</code><code class="s2">dot</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">opacity</code></span><span><code class="o">=</code></span><span><code class="mf">0.6</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">add_vline</code></span><span><code class="p">(</code></span><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s2">"</code><code class="s2">2019-05-30</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">line_width</code></span><span><code class="o">=</code></span><span><code class="mi">3</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">line_dash</code></span><span><code class="o">=</code></span><span><code class="s2">"</code><code class="s2">dash</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">opacity</code></span><span><code class="o">=</code></span><span><code class="mf">0.6</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">fig</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_12in03.png"/></div></figure>&#13;
&#13;
<p>After dropping duplicate dates, the plot of measurements per day looks much more consistent with the counts we expect. Careful readers will see two spikes above the maximum measurements around November of each year when daylight saving time is no longer in effect. When clocks are rolled back one hour, that day has 25 hours instead of the usual 24 hours. Timestamps are tricky!</p>&#13;
&#13;
<p>But there are still missing measurements, and we need to decide what to do about them<a contenteditable="false" data-primary="" data-startref="ix_data_table_gran3" data-type="indexterm" id="id1470"/><a contenteditable="false" data-primary="" data-startref="ix_gran_purp_stud" data-type="indexterm" id="id1471"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Handling Missing Values" data-type="sect2"><div class="sect2" id="handling-missing-values">&#13;
<h2>Handling Missing Values</h2>&#13;
&#13;
<p>The plan is to create 24-hour averages of the measurements<a contenteditable="false" data-primary="missing values and records" data-secondary="air quality sensors data" data-type="indexterm" id="ix_miss_val_aqs"/>, but we don’t want to use days when there are not enough measurements. We follow Barkjohn’s analysis and only keep a 24-hour average if there are at least 90% of the possible points for that day. Remember that before May 30, 2019, there are 1,080 possible points in a day, and after that there are 720 possible points. We calculate the minimum number of measurements needed to keep per day:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">needed_measurements_80s</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mf">0.9</code></span><code> </code><span><code class="o">*</code></span><code> </code><span><code class="mi">1080</code></span><code>&#13;
</code><span><code class="n">needed_measurements_120s</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mf">0.9</code></span><code> </code><span><code class="o">*</code></span><code> </code><span><code class="mi">720</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now we can determine which of the days have enough measurements to keep:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">cutoff_date</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">Timestamp</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">2019-05-30</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">tz</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">US/Pacific</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="k">def</code></span><code> </code><span><code class="nf">has_enough_readings</code></span><span><code class="p">(</code></span><span><code class="n">one_day</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="p">[</code></span><span><code class="n">n</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">one_day</code></span><code>&#13;
</code><code>    </code><span><code class="n">date</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">one_day</code></span><span><code class="o">.</code></span><span><code class="n">name</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">n</code></span><code> </code><span><code class="o">&gt;</code><code class="o">=</code></span><code> </code><span><code class="n">needed_measurements_80s</code></span><code>&#13;
</code><code>            </code><span><code class="k">if</code></span><code> </code><span><code class="n">date</code></span><code> </code><span><code class="o">&lt;</code><code class="o">=</code></span><code> </code><span><code class="n">cutoff_date</code></span><code>&#13;
</code><code>            </code><span><code class="k">else</code></span><code> </code><span><code class="n">n</code></span><code> </code><span><code class="o">&gt;</code><code class="o">=</code></span><code> </code><span><code class="n">needed_measurements_120s</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">should_keep</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">per_day</code></span><span><code class="o">.</code></span><span><code class="n">apply</code></span><span><code class="p">(</code></span><span><code class="n">has_enough_readings</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">axis</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">columns</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">should_keep</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
timestamp&#13;
2018-05-19 00:00:00-07:00    False&#13;
2018-05-20 00:00:00-07:00     True&#13;
2018-05-21 00:00:00-07:00     True&#13;
2018-05-22 00:00:00-07:00     True&#13;
2018-05-23 00:00:00-07:00     True&#13;
Freq: D, dtype: bool&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We’re ready to average together the readings for each day and then remove the days without enough readings:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">compute_daily_avgs</code></span><span><code class="p">(</code></span><span><code class="n">pa</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">should_keep</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">resample</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">D</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>                   </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">PM25cf1</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>                   </code><span><code class="o">.</code></span><span><code class="n">size</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>                   </code><span><code class="o">.</code></span><span><code class="n">to_frame</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>                   </code><span><code class="o">.</code></span><span><code class="n">apply</code></span><span><code class="p">(</code></span><span><code class="n">has_enough_readings</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">axis</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">columns</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">resample</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">D</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>            </code><span><code class="o">.</code></span><span><code class="n">mean</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>            </code><span><code class="o">.</code></span><span><code class="n">loc</code></span><span><code class="p">[</code></span><span><code class="n">should_keep</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">pa</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">pa_full</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">drop_and_rename_cols</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">parse_timestamps</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">convert_tz</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">drop_duplicate_rows</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>      </code><span><code class="o">.</code></span><span><code class="n">pipe</code></span><span><code class="p">(</code></span><span><code class="n">compute_daily_avgs</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa</code></span><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">2</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>PM25cf1</th>&#13;
			<th>TempF</th>&#13;
			<th>RH</th>&#13;
		</tr>&#13;
		<tr>&#13;
			<th>timestamp</th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>2018-05-20 00:00:00-07:00</strong></td>&#13;
			<td>2.48</td>&#13;
			<td>83.35</td>&#13;
			<td>28.72</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2018-05-21 00:00:00-07:00</strong></td>&#13;
			<td>3.00</td>&#13;
			<td>83.25</td>&#13;
			<td>29.91</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now we have the average daily PM2.5 readings for instrument A, and we need to repeat on instrument B the data wrangling we just performed on instrument A. Fortunately, we can reuse the same pipeline. For brevity, we don’t include that wrangling here. But we need to decide what to do if the PM2.5 averages differ. Barkjohn dropped rows if the PM2.5 values for A and B differed by more than 61%, or by more than 5 µg m⁻³. For this pair of sensors, that leads to dropping 12 of the 500+ rows.</p>&#13;
&#13;
<p>As you can see, it takes a lot of work to prepare and clean these data: we handled missing data, aggregated the readings for each instrument, averaged the readings together from the two instruments, and removed rows where they disagreed. This work has given us a set of PM2.5 readings that we are more confident in. We know that each PM2.5 value in the final dataframe is the daily average from two separate instruments that generated consistent and complete readings.</p>&#13;
&#13;
<p>To fully replicate Barkjohn’s analysis, we would need to repeat this process over all the PurpleAir sensors. Then we would repeat the AQS cleaning procedure on all the AQS sensors. Finally, we would merge the PurpleAir and AQS data together. This procedure produces daily average readings for each collocated sensor pair. For brevity, we omit this code. Instead, we proceed with the final steps of the analysis using the group’s dataset. We begin with an EDA with an eye toward modeling<a contenteditable="false" data-primary="" data-startref="ix_miss_val_aqs" data-type="indexterm" id="id1472"/><a contenteditable="false" data-primary="" data-startref="ix_purp_sens_wr" data-type="indexterm" id="id1473"/><a contenteditable="false" data-primary="" data-startref="ix_aqs_clean_data" data-type="indexterm" id="id1474"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Exploring PurpleAir and AQS Measurements" data-type="sect1"><div class="sect1" id="ch-pa-eda">&#13;
<h1>Exploring PurpleAir and AQS Measurements</h1>&#13;
&#13;
<p>Let’s explore the cleaned dataset<a contenteditable="false" data-primary="data scope" data-secondary="air quality example" data-type="indexterm" id="id1475"/><a contenteditable="false" data-primary="air quality sensors study" data-secondary="exploring measurements" data-type="indexterm" id="id1476"/><a contenteditable="false" data-primary="air quality sensors study" data-secondary="AQS sites" data-type="indexterm" id="ix_aqa_meas"/><a contenteditable="false" data-primary="PurpleAir sensor sites" data-secondary="exploring measurements" data-type="indexterm" id="ix_purp_air_sens_meas"/> of matched AQS and PurpleAir PM2.5 readings and look for insights that might help us in modeling. Our main interest is in the relationship between the two sources of air quality measurements. But we want to keep in mind the scope of the data, like how these data are situated in time and place. We learned from our data cleaning that we are working with daily averages of PM2.5 for a couple of years and that we have data from dozens of locations across the US.</p>&#13;
&#13;
<p>First we review the entire cleaned dataframe:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">full_df</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>date</th>&#13;
			<th>id</th>&#13;
			<th>region</th>&#13;
			<th>pm25aqs</th>&#13;
			<th>pm25pa</th>&#13;
			<th>temp</th>&#13;
			<th>rh</th>&#13;
			<th>dew</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>2019-05-17</td>&#13;
			<td>AK1</td>&#13;
			<td>Alaska</td>&#13;
			<td class="right">6.7</td>&#13;
			<td class="right">8.62</td>&#13;
			<td class="right">18.03</td>&#13;
			<td>38.56</td>&#13;
			<td class="right">3.63</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>2019-05-18</td>&#13;
			<td>AK1</td>&#13;
			<td>Alaska</td>&#13;
			<td class="right">3.8</td>&#13;
			<td class="right">3.49</td>&#13;
			<td class="right">16.12</td>&#13;
			<td>49.40</td>&#13;
			<td class="right">5.44</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>2019-05-21</td>&#13;
			<td>AK1</td>&#13;
			<td>Alaska</td>&#13;
			<td class="right">4.0</td>&#13;
			<td class="right">3.80</td>&#13;
			<td class="right">19.90</td>&#13;
			<td>29.97</td>&#13;
			<td class="right">1.73</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>...</strong></td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>12427</strong></td>&#13;
			<td>2019-02-20</td>&#13;
			<td>WI6</td>&#13;
			<td>North</td>&#13;
			<td class="right">15.6</td>&#13;
			<td class="right">25.30</td>&#13;
			<td class="right">1.71</td>&#13;
			<td>65.78</td>&#13;
			<td class="right">-4.08</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>12428</strong></td>&#13;
			<td>2019-03-04</td>&#13;
			<td>WI6</td>&#13;
			<td>North</td>&#13;
			<td class="right">14.0</td>&#13;
			<td class="right">8.21</td>&#13;
			<td class="right">-14.38</td>&#13;
			<td>48.21</td>&#13;
			<td class="right">-23.02</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>12429</strong></td>&#13;
			<td>2019-03-22</td>&#13;
			<td>WI6</td>&#13;
			<td>North</td>&#13;
			<td class="right">5.8</td>&#13;
			<td class="right">9.44</td>&#13;
			<td class="right">5.08</td>&#13;
			<td>52.20</td>&#13;
			<td class="right">-4.02</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
12246 rows × 8 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We include an explanation for each of the columns in our dataframe in the following table:</p>&#13;
&#13;
<table class="pagebreak-before less_space">&#13;
	<thead>&#13;
		<tr>&#13;
			<th class="head">Column</th>&#13;
			<th class="head">Description</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td>date</td>&#13;
			<td>&#13;
			<p>Date of the observation</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>id</td>&#13;
			<td>&#13;
			<p>A unique label for a site, formatted as the US state abbreviation with a number (we performed data cleaning for site ID <code>CA1</code>)</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>region</td>&#13;
			<td>&#13;
			<p>The name of the region, which corresponds to a group of sites (the <code>CA1</code> site is located in the <code>West</code> region)</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>pm25aqs</td>&#13;
			<td>&#13;
			<p>The PM2.5 measurement from the AQS sensor</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>pm25pa</td>&#13;
			<td>&#13;
			<p>The PM2.5 measurement from the PurpleAir sensor</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>temp</td>&#13;
			<td>&#13;
			<p>Temperature, in Celsius</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>rh</td>&#13;
			<td>&#13;
			<p>Relative humidity, ranging from 0% to 100%</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>dew</td>&#13;
			<td>&#13;
			<p>The dew point (a higher dew point means more moisture is in the air)</p>&#13;
			</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<p>Let’s start with making a few simple visualizations to gain insight. Since the scope involves measurements over time at particular locations, we can choose one location with many measurements and make a line plot of the weekly average air quality. To choose, let’s find the sites with many records:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">full_df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">[</code><code class="p">:</code></span><span><code class="mi">3</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
id&#13;
IA3    830&#13;
NC4    699&#13;
CA2    659&#13;
Name: count, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The location labeled <code>NC4</code> has nearly 700 observations. To smooth the line plot a bit, let’s plot weekly averages:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">nc4</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">full_df</code></span><span><code class="o">.</code></span><span><code class="n">loc</code></span><span><code class="p">[</code></span><span><code class="n">full_df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">==</code></span><span><code class="s1">'</code><code class="s1">NC4</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ts_nc4</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">nc4</code></span><span><code class="o">.</code></span><span><code class="n">set_index</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">resample</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">W</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code> </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">mean</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">reset_index</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">fig</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">line</code></span><span><code class="p">(</code></span><span><code class="n">ts_nc4</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>              </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">PM2.5 weekly avg</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">,</code></span><code>&#13;
</code><code>              </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">500</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">add_trace</code></span><span><code class="p">(</code></span><span><code class="n">go</code></span><span><code class="o">.</code></span><span><code class="n">Scatter</code></span><span><code class="p">(</code></span><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="n">ts_nc4</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="n">ts_nc4</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code>&#13;
</code><code>                         </code><span><code class="n">line</code></span><span><code class="o">=</code></span><span><code class="nb">dict</code></span><span><code class="p">(</code></span><span><code class="n">color</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">black</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">dash</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">dot</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">update_yaxes</code></span><span><code class="p">(</code></span><span><code class="nb">range</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="mi">0</code></span><span><code class="p">,</code></span><span><code class="mi">30</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">update_layout</code></span><span><code class="p">(</code></span><span><code class="n">showlegend</code></span><span><code class="o">=</code></span><span><code class="kc">False</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">show</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_12in04.png"/></div></figure>&#13;
&#13;
<p>We see that most PM2.5 values for the AQS sensor (solid line) range between 5.0 and 15.0 µg m⁻³. The PurpleAir sensor follows the up-and-down pattern of the AQS sensor, which is reassuring. But the measurements are consistently higher than AQS and, in some cases, quite a bit higher, which tells us that a correction might be helpful.</p>&#13;
&#13;
<p>Next, let’s consider the distributions of the PM2.5 readings for the two sensors:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">left</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">histogram</code></span><span><code class="p">(</code></span><span><code class="n">nc4</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">histnorm</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">percent</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">right</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">histogram</code></span><span><code class="p">(</code></span><span><code class="n">nc4</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">histnorm</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">percent</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">fig</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">left_right</code></span><span><code class="p">(</code></span><span><code class="n">left</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">right</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">600</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">update_xaxes</code></span><span><code class="p">(</code></span><span><code class="n">title</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">AQS readings</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">col</code></span><span><code class="o">=</code></span><span><code class="mi">1</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">row</code></span><span><code class="o">=</code></span><span><code class="mi">1</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">update_xaxes</code></span><span><code class="p">(</code></span><span><code class="n">title</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">PurpleAir readings</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">col</code></span><span><code class="o">=</code></span><span><code class="mi">2</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">row</code></span><span><code class="o">=</code></span><span><code class="mi">1</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">update_yaxes</code></span><span><code class="p">(</code></span><span><code class="n">title</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">percent</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">col</code></span><span><code class="o">=</code></span><span><code class="mi">1</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">row</code></span><span><code class="o">=</code></span><span><code class="mi">1</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">show</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_12in05.png"/></div></figure>&#13;
&#13;
<p>Both distributions are skewed right, which often happens when there’s a lower bound on values (in this case, 0). A better way to compare these two distributions is with a quantile–quantile plot (see <a class="reference internal" data-type="xref" href="ch10.html#ch-eda">Chapter 10</a>). With a q–q plot it can be easier to compare means, spreads, and tails:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">percs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">arange</code></span><span><code class="p">(</code></span><span><code class="mi">1</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">100</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">1</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">aqs_qs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">percentile</code></span><span><code class="p">(</code></span><span><code class="n">nc4</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">percs</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">interpolation</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">lower</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">pa_qs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">percentile</code></span><span><code class="p">(</code></span><span><code class="n">nc4</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">percs</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">interpolation</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">lower</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">perc_df</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">DataFrame</code></span><span><code class="p">(</code><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">percentile</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">percs</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">aqs_qs</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="n">aqs_qs</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">pa_qs</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="n">pa_qs</code></span><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">fig</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">scatter</code></span><span><code class="p">(</code></span><span><code class="n">perc_df</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">aqs_qs</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pa_qs</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>                 </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">aqs_qs</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="s1">'</code><code class="s1">AQS quantiles</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>                         </code><span><code class="s1">'</code><code class="s1">pa_qs</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="s1">'</code><code class="s1">PurpleAir quantiles</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">,</code></span><code>&#13;
</code><code>                 </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">350</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">add_trace</code></span><span><code class="p">(</code></span><span><code class="n">go</code></span><span><code class="o">.</code></span><span><code class="n">Scatter</code></span><span><code class="p">(</code></span><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="mi">2</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">13</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="mi">1</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">25</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><code>&#13;
</code><code>             </code><span><code class="n">mode</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">lines</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">line</code></span><span><code class="o">=</code></span><span><code class="nb">dict</code></span><span><code class="p">(</code></span><span><code class="n">dash</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">dash</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">4</code></span><span><code class="p">)</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">update_layout</code></span><span><code class="p">(</code></span><span><code class="n">showlegend</code></span><span><code class="o">=</code></span><span><code class="kc">False</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal width-60"><div class="figure"><img src="assets/leds_12in06.png"/></div></figure>&#13;
&#13;
<p>The quantile–quantile plot is roughly linear. We overlaid a dashed line with a slope of 2.2; it lines up the quantiles well, which indicates the spread of the PurpleAir measurements is about twice that of AQS.</p>&#13;
&#13;
<p>What we can’t see in the q–q plot or the side-by-side histograms is how the sensor readings vary together. Let’s look at this next. First, we take a look at the distribution of difference between the two readings:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">diffs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">nc4</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">-</code></span><code> </code><span><code class="n">nc4</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">fig</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">histogram</code></span><span><code class="p">(</code></span><span><code class="n">diffs</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">histnorm</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">percent</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><code>&#13;
</code><code>                   </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">350</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">update_xaxes</code></span><span><code class="p">(</code></span><span><code class="nb">range</code></span><span><code class="o">=</code></span><span><code class="p">[</code></span><span><code class="o">-</code></span><span><code class="mi">10</code></span><span><code class="p">,</code></span><span><code class="mi">30</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">title</code></span><span><code class="o">=</code></span><span><code class="s2">"</code><code class="s2">Difference: PA&amp;#8211;AQS reading</code><code class="s2">"</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">update_traces</code></span><span><code class="p">(</code></span><span><code class="n">xbins</code></span><span><code class="o">=</code></span><span><code class="nb">dict</code></span><span><code class="p">(</code></span><code>&#13;
</code><code>        </code><span><code class="n">start</code></span><span><code class="o">=</code><code class="o">-</code></span><span><code class="mf">10.0</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">end</code></span><span><code class="o">=</code></span><span><code class="mf">30.0</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">size</code></span><span><code class="o">=</code></span><span><code class="mi">2</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">update_layout</code></span><span><code class="p">(</code></span><span><code class="n">showlegend</code></span><span><code class="o">=</code></span><span><code class="kc">False</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">fig</code></span><span><code class="o">.</code></span><span><code class="n">show</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal width-60"><div class="figure"><img src="assets/leds_12in07.png"/></div></figure>&#13;
&#13;
<p>If the instruments are in perfect agreement, we will see a spike at 0. If the instruments are in agreement and there is a measurement error with no bias, we expect to see a distribution centered at 0. Instead, we see that 90% of the time, the PurpleAir measurement is larger than the AQS 24-hour average, and about 25% of the time it is more than 10 µg/m<sup>3</sup> higher, which is a lot given the AQS averages tend to be between 5 µg/m<sup>3</sup> and 10 µg/m<sup>3</sup>.</p>&#13;
&#13;
<p>A scatterplot can give us additional insight into the relationship between the measurements from these two instruments. Since we are interested in finding a general relationship, regardless of time and location, we include all of our average readings in the plot:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">scatter</code></span><span><code class="p">(</code></span><span><code class="n">full_df</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">350</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>           </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">AQS PM2.5</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">PurpleAir PM2.5</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal width-60"><div class="figure"><img src="assets/leds_12in08.png"/></div></figure>&#13;
&#13;
<p>While the relationship looks linear, all but a handful of readings are in the bottom-left corner of the plot. Let’s remake the scatterplot and zoom in on the bulk of the data to get a better look. We also add a smooth curve to the plot to help us see the relationship better:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">full_df</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">full_df</code></span><span><code class="o">.</code></span><span><code class="n">loc</code></span><span><code class="p">[</code><code class="p">(</code></span><span><code class="n">full_df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">&lt;</code></span><code> </code><span><code class="mi">50</code></span><span><code class="p">)</code><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">px</code></span><span><code class="o">.</code></span><span><code class="n">scatter</code></span><span><code class="p">(</code></span><span><code class="n">full_df</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">x</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">y</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><code>&#13;
</code><code>           </code><span><code class="n">trendline</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">lowess</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">trendline_color_override</code></span><span><code class="o">=</code></span><span><code class="s2">"</code><code class="s2">orange</code><code class="s2">"</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>           </code><span><code class="n">labels</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">AQS PM2.5</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="s1">'</code><code class="s1">PurpleAir PM2.5</code><code class="s1">'</code></span><span><code class="p">}</code><code class="p">,</code></span><code>&#13;
</code><code>           </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">350</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">height</code></span><span><code class="o">=</code></span><span><code class="mi">250</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal width-60"><div class="figure"><img src="assets/leds_12in09.png"/></div></figure>&#13;
&#13;
<p>The relationship looks roughly linear, but there is a slight bend in the curve for small values of AQS. When the air is very clean, the PurpleAir sensor doesn’t pick up as much particulate matter and so is more accurate. Also, we can see that the curve should go through the point (0, 0). Despite the slight bend in the relationship, the linear association (correlation) between these two measurements is high:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">corrcoef</code></span><span><code class="p">(</code></span><span><code class="n">full_df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">full_df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
array([[1.  , 0.88],&#13;
       [0.88, 1.  ]])&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Before starting this analysis, we expected that PurpleAir measurements would generally overestimate the PM2.5. And indeed, this is reflected in the scatterplot, but we also see that there appears to be a strong linear relationship between the measurements from these two instruments that will be helpful in calibrating the PurpleAir sensor<a contenteditable="false" data-primary="" data-startref="ix_aqa_meas" data-type="indexterm" id="id1477"/><a contenteditable="false" data-primary="" data-startref="ix_aqa_expl_meas" data-type="indexterm" id="id1478"/><a contenteditable="false" data-primary="" data-startref="ix_purp_air_sens_meas" data-type="indexterm" id="id1479"/>.</p>&#13;
</div></section>&#13;
&#13;
<section class="pagebreak-before" data-pdf-bookmark="Creating a Model to Correct PurpleAir Measurements" data-type="sect1"><div class="sect1" id="ch-pa-modeling">&#13;
<h1 class="less_space">Creating a Model to Correct PurpleAir Measurements</h1>&#13;
&#13;
<p>Now that we’ve explored<a contenteditable="false" data-primary="PurpleAir sensor sites" data-secondary="correcting measurements" data-type="indexterm" id="ix_purp_air_sens_corr"/> the relationship between PM2.5 readings from AQS and PurpleAir sensors, we’re ready for the final step of the analysis: creating a model that corrects PurpleAir measurements. Barkjohn’s original analysis fits many models to the data in order to find the most appropriate one. In this section, we fit a simple linear model using the techniques from <a class="reference internal" data-type="xref" href="ch04.html#ch-modeling">Chapter 4</a>. We also briefly describe the final model Barkjohn chose for real-world use. Since these models use methods that we introduce later in the book, we won’t explain the technical details very deeply here. Instead, we encourage you to revisit this section after reading <a class="reference internal" data-type="xref" href="ch15.html#ch-linear">Chapter 15</a>.</p>&#13;
&#13;
<p>First, let’s go over our modeling goals. We want to create a model that predicts PM2.5 as accurately as possible. To do this, we build a model that adjusts PurpleAir measurements based on AQS measurements. We treat the AQS measurements as the true PM2.5 values because they are taken from carefully calibrated instruments and are actively used by the US government for decision making. So we have reason to trust the AQS PM2.5 values as being precise and close to the truth.</p>&#13;
&#13;
<p>After we build the model that adjusts the PurpleAir measurements using AQS, we then flip the model around and use it to predict the true air quality in the future from PurpleAir measurements when we don’t have a nearby AQS instrument. This is a <em>calibration</em> scenario. Since the AQS measurements are close to the truth, we fit the more variable PurpleAir measurements to them; this is the calibration procedure. Then we use the calibration curve to correct future PurpleAir measurements. This two-step process is encapsulated in the upcoming simple linear model and its flipped form.</p>&#13;
&#13;
<p>First, we fit a line to predict a PurpleAir (PA) measurement from the ground truth, as recorded by an AQS instrument:</p>&#13;
&#13;
<div data-type="equation">&#13;
<div class="math notranslate nohighlight"><math display="block"> <mtext>PA</mtext> <mo>≈</mo> <mi>b</mi> <mo>+</mo> <mi>m</mi> <mtext>AQS</mtext> </math></div>&#13;
</div>&#13;
&#13;
<p>Next, we flip the line around to use a PA measurement to predict the air quality:</p>&#13;
&#13;
<div data-type="equation">&#13;
<div class="math notranslate nohighlight"><math display="block"> <mtext>True air quality</mtext> <mo>≈</mo> <mo>−</mo> <mi>b</mi> <mrow> <mo>/</mo> </mrow> <mi>m</mi> <mo>+</mo> <mn>1</mn> <mrow> <mo>/</mo> </mrow> <mi>m</mi> <mtext>PA</mtext> </math></div>&#13;
</div>&#13;
&#13;
<p>The scatterplot and histograms that we made during our exploratory data analysis suggest that the PurpleAir measurements are more variable, which supports the calibration approach. And we saw that the PurpleAir measurements are about twice as high as the AQS measurements, which suggests that <span class="math notranslate nohighlight"><math> <mi>m</mi> </math></span> may be close to 2 and <span class="math notranslate nohighlight"><math> <mn>1</mn> <mrow> <mo>/</mo> </mrow> <mi>m</mi> </math></span> close to <span class="math notranslate nohighlight"><math> <mn>1</mn> <mrow> <mo>/</mo> </mrow> <mn>2</mn> </math></span>.</p>&#13;
&#13;
<aside class="sidebar" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1480">&#13;
<h1 class="sidebar-title">Why Two Steps?</h1>&#13;
&#13;
<p>This calibration procedure might seem a bit roundabout. Why not fit a linear model that directly uses PurpleAir to predict AQS? That seems a lot easier, and we wouldn’t need to invert anything.</p>&#13;
&#13;
<p>Since AQS measurements are “true” (or close to it), they have no error. Intuitively, a linear model works conditionally on the value of the variable on the x-axis, and minimizes the error in the <span class="math notranslate nohighlight"><math> <mi>y</mi> </math></span> direction: <span class="math notranslate nohighlight"><math> <mi>y</mi> <mo>−</mo> <mo stretchy="false">(</mo> <mi>b</mi> <mo>+</mo> <mi>m</mi> <mi>x</mi> <mo stretchy="false">)</mo> </math></span>. So we place the accurate measurements on the x-axis to fit the line, called the <em>calibration curve</em>. Then, in the future, we invert the line to predict the truth from our instrument’s measurement. That’s why this process is also called <em>inverse regression</em>. Calibration is a reasonable thing to do only when the pairs of measurements are highly correlated.</p>&#13;
&#13;
<p>As a simpler example, let’s say we want to calibrate a scale. We could do this by placing known weights—say, 1 kg, 5 kg, and 10 kg—onto the scale and seeing what the scale reports. We typically repeat this a few times, each time getting slightly different measurements from the scale. If we discover that our scale is often 10% too high (<span class="math notranslate nohighlight"><math> <mi>y</mi> <mo>=</mo> <mn>1.1</mn> <mi>x</mi> </math></span>), then when we weigh something in the future, we adjust our scale’s reading downward by 90% (<span class="math notranslate nohighlight"><math> <mn>1</mn> <mrow> <mo>/</mo> </mrow> <mn>1.1</mn> <mo>=</mo> <mn>0.9</mn> </math></span>). Analogously, the AQS measurements are the known quantities, and our model checks what the PurpleAir sensor reports.</p>&#13;
</div></aside>&#13;
&#13;
<p>Now let’s fit the model. Following the notion from <a class="reference internal" data-type="xref" href="ch04.html#ch-modeling">Chapter 4</a>, we choose a loss function and minimize the average error. Recall that a <em>loss function</em> measures how far away our model is from the actual data. We use squared loss, which in this case is <span class="math notranslate nohighlight"><math> <mo stretchy="false">[</mo> <mi>P</mi> <mi>A</mi> <mo>−</mo> <mo stretchy="false">(</mo> <mi>b</mi> <mo>+</mo> <mi>m</mi> <mi>A</mi> <mi>Q</mi> <mi>S</mi> <mo stretchy="false">)</mo> <msup> <mo stretchy="false">]</mo> <mn>2</mn> </msup> </math></span>. And to fit the model to our data, we minimize the average squared loss over our data:</p>&#13;
&#13;
<div data-type="equation">&#13;
<div class="math notranslate nohighlight"><math display="block"> <mtable columnalign="right" displaystyle="true" rowspacing="3pt"> <mtr> <mtd> <mfrac> <mn>1</mn> <mi>n</mi> </mfrac> <munderover> <mo>∑</mo> <mrow> <mi>i</mi> <mo>=</mo> <mn>1</mn> </mrow> <mrow> <mi>n</mi> </mrow> </munderover> <mo stretchy="false">[</mo> <mi>P</mi> <msub> <mi>A</mi> <mi>i</mi> </msub> <mo>−</mo> <mo stretchy="false">(</mo> <mi>b</mi> <mo>+</mo> <mi>m</mi> <mi>A</mi> <mi>Q</mi> <msub> <mi>S</mi> <mi>i</mi> </msub> <msup> <mo stretchy="false">]</mo> <mn>2</mn> </msup> </mtd> </mtr> </mtable> </math></div>&#13;
</div>&#13;
&#13;
<p>We use the linear modeling functionality provided by <code>scikit-learn</code> to do this (again, don’t worry about these details for now):</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">from</code></span><code> </code><span><code class="nn">sklearn</code><code class="nn">.</code><code class="nn">linear_model</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">LinearRegression</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">AQS</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">PA</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">full_df</code></span><span><code class="p">[</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">full_df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>    </code><code>&#13;
</code><span><code class="n">model</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">LinearRegression</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">fit</code></span><span><code class="p">(</code></span><span><code class="n">AQS</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">PA</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">m</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">b</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">model</code></span><span><code class="o">.</code></span><span><code class="n">coef_</code></span><span><code class="p">[</code></span><span><code class="mi">0</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">model</code></span><span><code class="o">.</code></span><span><code class="n">intercept_</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>By inverting the line, we get the estimate:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="sa">f</code></span><span><code class="s2">"</code><code class="s2">True air quality estimate = </code></span><span><code class="si">{</code></span><span><code class="o">-</code></span><span><code class="n">b</code></span><span><code class="o">/</code></span><span><code class="n">m</code></span><span><code class="si">:</code></span><span><code class="s2">.2</code></span><span><code class="si">}</code></span><span><code class="s2"> + </code></span><span><code class="si">{</code></span><span><code class="mi">1</code></span><span><code class="o">/</code></span><span><code class="n">m</code></span><span><code class="si">:</code></span><span><code class="s2">.2</code></span><span><code class="si">}</code></span><span><code class="s2">PA</code><code class="s2">"</code></span><span><code class="p">)</code></span><code> </code><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
True air quality estimate = 1.4 + 0.53PA&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>This is close to what we expected. The adjustment to PurpleAir measurements is about <span class="math notranslate nohighlight"><math> <mn>1</mn> <mrow> <mo>/</mo> </mrow> <mn>2</mn> </math></span>.</p>&#13;
&#13;
<p>The model that Barkjohn settled on incorporated the relative humidity:</p>&#13;
&#13;
<div data-type="equation">&#13;
<div class="math notranslate nohighlight"><math display="block"> <mtable columnalign="right" displaystyle="true" rowspacing="3pt"> <mtr> <mtd> <mtext>PA</mtext> <mo>≈</mo> <mi>b</mi> <mo>+</mo> <msub> <mi>m</mi> <mn>1</mn> </msub> <mtext>AQS</mtext> <mo>+</mo> <msub> <mi>m</mi> <mn>2</mn> </msub> <mtext>RH</mtext> </mtd> </mtr> </mtable> </math></div>&#13;
</div>&#13;
&#13;
<p>This is an example of a multivariable linear regression model—it uses more than one variable to make predictions. We can fit it by minimizing the average squared error over the data:</p>&#13;
&#13;
<div data-type="equation">&#13;
<div class="math notranslate nohighlight"><math display="block"> <mtable columnalign="right" displaystyle="true" rowspacing="3pt"> <mtr> <mtd> <mfrac> <mn>1</mn> <mi>n</mi> </mfrac> <munderover> <mo>∑</mo> <mrow> <mi>i</mi> <mo>=</mo> <mn>1</mn> </mrow> <mrow> <mi>n</mi> </mrow> </munderover> <mo stretchy="false">[</mo> <mi>P</mi> <msub> <mi>A</mi> <mi>i</mi> </msub> <mo>−</mo> <mo stretchy="false">(</mo> <mi>b</mi> <mo>+</mo> <msub> <mi>m</mi> <mn>1</mn> </msub> <mi>A</mi> <mi>Q</mi> <msub> <mi>S</mi> <mi>i</mi> </msub> <mo>+</mo> <msub> <mi>m</mi> <mn>2</mn> </msub> <mi>R</mi> <msub> <mi>H</mi> <mi>i</mi> </msub> <msup> <mo stretchy="false">]</mo> <mn>2</mn> </msup> </mtd> </mtr> </mtable> </math></div>&#13;
</div>&#13;
&#13;
<p>Then we invert the calibration to find the prediction model using the following <span class="keep-together">equation</span>:</p>&#13;
&#13;
<div data-type="equation">&#13;
<div class="math notranslate nohighlight"><math display="block"> <mtable columnalign="right left" columnspacing="0em" displaystyle="true" rowspacing="3pt"> <mtr> <mtd> <mtext>True air quality</mtext> </mtd> <mtd> <mi/> <mo>≈</mo> <mo>−</mo> <mfrac> <mi>b</mi> <msub> <mi>m</mi> <mn>1</mn> </msub> </mfrac> <mo>+</mo> <mfrac> <mn>1</mn> <msub> <mi>m</mi> <mn>1</mn> </msub> </mfrac> <mtext>PA</mtext> <mo>−</mo> <mfrac> <msub> <mi>m</mi> <mn>2</mn> </msub> <msub> <mi>m</mi> <mn>1</mn> </msub> </mfrac> <mtext>RH</mtext> </mtd> </mtr> </mtable> </math></div>&#13;
</div>&#13;
&#13;
<p>We fit this model and check the coefficients:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">AQS_RH</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">PA</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">full_df</code></span><span><code class="p">[</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25aqs</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">rh</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">full_df</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">pm25pa</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="n">model_h</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">LinearRegression</code></span><span><code class="p">(</code><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">fit</code></span><span><code class="p">(</code></span><span><code class="n">AQS_RH</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">PA</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="p">[</code></span><span><code class="n">m1</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">m2</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">b</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">model_h</code></span><span><code class="o">.</code></span><span><code class="n">coef_</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">model_h</code></span><span><code class="o">.</code></span><span><code class="n">intercept_</code></span><code>&#13;
</code><code>    </code><code>&#13;
</code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="sa">f</code></span><span><code class="s2">"</code><code class="s2">True Air Quality Estimate = </code></span><span><code class="si">{</code></span><span><code class="o">-</code></span><span><code class="n">b</code></span><span><code class="o">/</code></span><span><code class="n">m</code></span><span><code class="si">:</code></span><span><code class="s2">1.2</code></span><span><code class="si">}</code></span><span><code class="s2"> + </code></span><span><code class="si">{</code></span><span><code class="mi">1</code></span><span><code class="o">/</code></span><span><code class="n">m1</code></span><span><code class="si">:</code></span><span><code class="s2">.2</code></span><span><code class="si">}</code></span><span><code class="s2">PA + </code></span><span><code class="si">{</code></span><span><code class="o">-</code></span><span><code class="n">m2</code></span><span><code class="o">/</code></span><span><code class="n">m1</code></span><span><code class="si">:</code></span><span><code class="s2">.2</code></span><span><code class="si">}</code></span><span><code class="s2">RH</code><code class="s2">"</code></span><span><code class="p">)</code></span><code> </code><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
True Air Quality Estimate = 5.7 + 0.53PA + -0.088RH&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>In Chapters <a class="reference internal" data-type="xref" data-xrefstyle="select:labelnumber" href="ch15.html#ch-linear">15</a> and <a class="reference internal" data-type="xref" data-xrefstyle="select:labelnumber" href="ch16.html#ch-risk">16</a>, we will learn how to compare these two models by examining things like the size of and patterns in prediction errors. For now, we note that the model that incorporates relative humidity performs the best<a contenteditable="false" data-primary="" data-startref="ix_purp_air_sens_corr" data-type="indexterm" id="id1481"/><a contenteditable="false" data-primary="" data-startref="ix_aqs_purp_air" data-type="indexterm" id="id1482"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="ch-pa-conclusion">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>In this chapter, we replicated Barkjohn’s analysis. We created a model that corrects PurpleAir measurements so that they closely match AQS measurements. The accuracy of this model enables the PurpleAir sensors to be included on official US government maps, like the AirNow Fire and Smoke map. Importantly, this model gives people timely <em>and</em> accurate measurements of air quality.</p>&#13;
&#13;
<p>We saw how crowdsourced, open data can be improved with data from precise, rigorously maintained, government-monitored equipment. In the process, we focused on cleaning and merging data from multiple sources, but we also fit models to adjust and improve air quality measurements.</p>&#13;
&#13;
<p>For this case study, we applied many concepts covered in this part of the book. As you saw, wrangling files and data tables into a form we can analyze is a large and important part of data science. We used file wrangling and the notions of granularity from <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a> to prepare two sources for merging. We got them into structures where we could match neighboring air quality sensors. This “grungy” part of data science was essential to widening the reach of data from rigorously maintained, precise government-monitored equipment by augmenting it with crowdsourced, open data.</p>&#13;
&#13;
<p>This preparation process involved intensive, careful examination, cleaning, and improvement of the data to ensure their compatibility across the two sources and their trustworthiness in our analysis. Concepts from <a class="reference internal" data-type="xref" href="ch09.html#ch-wrangling">Chapter 9</a> helped us work with time data effectively and find and correct numerous issues like missing data points and even duplicated data values<a contenteditable="false" data-primary="" data-startref="ix_aqs_case_stud_ch12" data-type="indexterm" id="id1483"/>.</p>&#13;
&#13;
<p>File and data wrangling, exploratory data analysis, and visualization are major parts of many analyses. While fitting models may seem to be the most exciting part of data science, getting to know and trust the data is crucial and often leads to important insights in the modeling phase. Topics related to modeling make up most of the rest of this book. However, before we begin, we cover two more topics related to data wrangling. In the next chapter, we show how to create analyzable data from text, and in the following chapter we examine other formats for source files that we mentioned in <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a>.</p>&#13;
&#13;
<p>Before you head to the next chapter, take stock of what you’ve learned so far. Pat yourself on the back—you’ve already come a long way! The principles and techniques we’ve covered here are useful for nearly every type of data analysis, and you can readily start applying them toward analyses of your own.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id1449"><sup><a href="ch12.html#id1449-marker">1</a></sup> This estimation works by assuming that the Earth is perfectly spherical. Then, one degree of latitude is the radius of the Earth in meters. Plugging in the average radius of the Earth gives 111,111 meters per degree of latitude. Longitude is the same, but the radius of each “ring” around the Earth decreases as we get closer to the poles, so we adjust by a factor of <math>&#13;
  <mrow>&#13;
    <mo form="prefix">cos</mo>&#13;
    <mo>(</mo>&#13;
    <mtext>lat</mtext>&#13;
    <mo>)</mo>&#13;
  </mrow>&#13;
</math>. It turns out that the Earth isn’t perfectly spherical, so these estimations can’t be used for precise calculations, like landing a rocket. But for our purposes, they do just fine.</p></div></div></section></body></html>