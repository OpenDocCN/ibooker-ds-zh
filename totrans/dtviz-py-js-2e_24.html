<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 18. Visualizing Individual Prizes" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_d3_nobels">
<h1><span class="label">Chapter 18. </span>Visualizing Individual Prizes</h1>
<p>In <a data-type="xref" href="ch17.xhtml#chapter_d3_intro">Chapter 17</a> you learned the basics of D3, how to select and change DOM elements, how to add new ones, and how to apply the data update pattern, which is the axis around which interactive D3 spins. <a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-type="indexterm" id="ix_D3visNP"/>In this chapter, I will expand on what you’ve learned so far and show you how to build a fairly novel visual element, showing all the individual Nobel Prizes by year (<a data-type="xref" href="#d3nobels_target">Figure 18-1</a>). This Nobel timeline will allow us to expand on the knowledge of the last chapter, demonstrating a number of new techniques including more advanced data manipulation.</p>
<figure><div class="figure" id="d3nobels_target">
<img alt="dpj2 1502" height="144" src="assets/dpj2_1502.png" width="974"/>
<h6><span class="label">Figure 18-1. </span>This chapter’s target chart, a timeline of Nobel Prizes</h6>
</div></figure>
<p>Let’s start by showing how we build the HTML framework for our timeline chart.</p>
<section data-pdf-bookmark="Building the Framework" data-type="sect1"><div class="sect1" id="idm45607743887728">
<h1>Building the Framework</h1>
<p>Our target chart’s construction is similar to that of our Nobel Prize bar chart, which we covered in detail in the last chapter.<a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-tertiary="building the framework" data-type="indexterm" id="idm45607743886304"/> We first use D3 to select our <code>&lt;div&gt;</code> container with ID <code>nobel-time</code>, then use the width and height of the container, along<a data-primary="SVG (Scalable Vector Graphics)" data-secondary="chart group for D3 visualization of individual Nobel Prizes" data-type="indexterm" id="idm45607743884128"/> with our specified margins, to create our <code>svg</code> chart group:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">nbviz</code> <code class="nx">from</code> <code class="s1">'./nbviz_core.mjs'</code>

<code class="kd">let</code> <code class="nx">chartHolder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-time'</code><code class="p">);</code>

<code class="kd">let</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code><code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code><code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code><code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code><code class="mi">40</code><code class="p">};</code>
<code class="kd">let</code> <code class="nx">boundingRect</code> <code class="o">=</code> <code class="nx">chartHolder</code><code class="p">.</code><code class="nx">node</code><code class="p">()</code>
  <code class="p">.</code><code class="nx">getBoundingClientRect</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">width</code> <code class="o">=</code> <code class="nx">boundingRect</code><code class="p">.</code><code class="nx">width</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code>
<code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
<code class="nx">height</code> <code class="o">=</code> <code class="nx">boundingRect</code><code class="p">.</code><code class="nx">height</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="kd">let</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">chartHolder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code>
        <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'g'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
                  <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code>
                  <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
    <code class="c1">// ...</code>
<code class="p">})</code></pre>
<p>With our <code>svg</code> chart group in place, let’s add the scales and axes.</p>
</div></section>
<section data-pdf-bookmark="Scales" data-type="sect1"><div class="sect1" id="idm45607743701584">
<h1>Scales</h1>
<p>To place the circular indicators, we use two ordinal scales (<a data-type="xref" href="#d3time_scales">Example 18-1</a>). The x-scale uses the <code>rangeRoundBands</code> method to specify a 10% padding between the circles.<a data-primary="ranges" data-secondary="D3 visualization of individual Nobel Prizes" data-type="indexterm" id="idm45607743735984"/><a data-primary="rangeRoundBands method (D3)" data-type="indexterm" id="idm45607743735040"/><a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-tertiary="scales" data-type="indexterm" id="idm45607743734400"/><a data-primary="scales (D3)" data-type="indexterm" id="idm45607743733216"/><a data-primary="ordinal scales" data-type="indexterm" id="idm45607743732544"/> Because we use the x-scale to set the circles’ diameters, the height of our y-scale’s range is manually adjusted to accommodate all the indicators, allowing a little padding between them. We use <code>rangeRoundPoints</code> to round to integer pixel coordinates.<a data-primary="rangeRoundPoints method (D3)" data-type="indexterm" id="idm45607743731360"/></p>
<div data-type="example" id="d3time_scales">
<h5><span class="label">Example 18-1. </span>The chart’s two ordinal band scales, for x and y axes</h5>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">xScale</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">scaleBand</code><code class="p">(</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="nx">width</code><code class="p">]</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">padding</code><code class="p">(</code><code class="mf">0.1</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO1-1" id="co_visualizing_individual_prizes_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="mi">1901</code><code class="p">,</code><code> </code><code class="mi">2015</code><code class="p">)</code><code class="p">)</code><code>

</code><code class="kd">let</code><code> </code><code class="nx">yScale</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">scaleBand</code><code class="p">(</code><code class="p">)</code><code>
  </code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="p">[</code><code class="nx">height</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code class="p">)</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="mi">15</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO1-2" id="co_visualizing_individual_prizes_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO1-1" id="callout_visualizing_individual_prizes_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We’re using a padding factor of 0.1, which is approximately 10% of an indicator’s diameter.</p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO1-2" id="callout_visualizing_individual_prizes_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The domain is [0, …​, 15] with 15 being the historical maximum number of prizes given in any one year.<a data-primary="domains" data-secondary="D3 visualization of individual Nobel Prizes" data-type="indexterm" id="idm45607743607008"/></p></dd>
</dl></div>
<p>Unlike our bar chart from the last chapter, both ranges and domains of this chart are fixed. The domain of the <code>xScale</code> is the years over which the Nobel Prize has run, and that of the <code>yScale</code> is from zero to the maximum number of prizes in any given year (14 in the year 2000). Neither of these will change in response to user interaction, so we define them outside the <code>update</code> method.</p>
</div></section>
<section data-pdf-bookmark="Axes" data-type="sect1"><div class="sect1" id="idm45607743603984">
<h1>Axes</h1>
<p>With a maximum of 14 prizes in any one year and with a circular indicator for each, it is easy to make a prize count by eye if necessary.<a data-primary="axes" data-secondary="D3 visualization of individual Nobel Prizes" data-type="indexterm" id="idm45607743562848"/><a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-tertiary="axes" data-type="indexterm" id="idm45607743561904"/> Given this, the emphasis on providing a relative indicator of prize distribution (e.g., showing the spurt in post-WWII US science prizes), and the long length of the chart, a y-axis is redundant for our chart.</p>
<p>For the x-axis, labeling the decades’ starts seems about right. It reduces visual clutter and is also the standard human way of charting historical trends. <a data-type="xref" href="#d3time_axis_code">Example 18-2</a> shows the construction of our x-axis, using D3’s handy <code>axis</code> object. We override the tick values using the <code>tickValues</code> method, filtering the domain range (1900–2015) to return only those dates ending with zero.<a data-primary="labels" data-secondary="axes labels in D3 chart" data-tertiary="x-axis tick labels in visualization of individual Nobel Prizes" data-type="indexterm" id="idm45607743558464"/></p>
<div data-type="example" id="d3time_axis_code">
<h5><span class="label">Example 18-2. </span>Making the x-axis, with tick labels per decade</h5>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">xAxis</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">tickValues</code><code class="p">(</code><code>
      </code><code class="nx">xScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code> </code><code class="nx">i</code><code class="p">)</code><code> </code><code class="p">{</code><code>
        </code><code class="k">return</code><code> </code><code class="o">!</code><code class="p">(</code><code class="nx">d</code><code> </code><code class="o">%</code><code> </code><code class="mi">10</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO2-1" id="co_visualizing_individual_prizes_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
      </code><code class="p">}</code><code class="p">)</code><code>
    </code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO2-1" id="callout_visualizing_individual_prizes_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We only want to tick every 10th year, so we create tick values by filtering the x-scale domain values and using their index to select only those that are divisible by 10. These give 0 for modulus (<code>%</code>) 10, to which we apply the not Boolean operator (<code>!</code>) to produce <code>true</code>, which passes the filter.</p></dd>
</dl>
<p>This returns <code>true</code> for years ending in 0, giving a tick label at the start of every decade.</p></div>
<p>As with the scales, we don’t anticipate the axes changing,<sup><a data-type="noteref" href="ch18.xhtml#idm45607743508496" id="idm45607743508496-marker">1</a></sup> so we can add them before receiving the dataset in the <code>updateTimeChart</code> <span class="keep-together">function</span>:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code><code> </code><code class="c1">// group to hold the axis
</code><code>    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code><code> </code><code class="s2">"x axis"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code><code> </code><code class="s2">"translate(0,"</code><code> </code><code class="o">+</code><code> </code><code class="nx">height</code><code> </code><code class="o">+</code><code> </code><code class="s2">")"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO3-1" id="co_visualizing_individual_prizes_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO3-2" id="co_visualizing_individual_prizes_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code><code> </code><code class="s2">"end"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code><code> </code><code class="s2">"-.8em"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code><code> </code><code class="s2">".15em"</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code><code> </code><code class="s2">"rotate(-65)"</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO3-1" id="callout_visualizing_individual_prizes_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Calls our D3 axis on the <code>svg</code> group, with the <code>axis</code> object taking care of building the axis elements.</p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO3-2" id="callout_visualizing_individual_prizes_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>As in <a data-type="xref" href="ch17.xhtml#sect_axes_labels">“Axes and Labels”</a>, we rotate the axis tick labels to place them diagonally.</p></dd>
</dl>
<p>With axes and scales taken care of, we need only add a little legend with our colored category labels before moving on to the cool, interactive elements of the chart.</p>
</div></section>
<section data-pdf-bookmark="Category Labels" data-type="sect1"><div class="sect1" id="idm45607743398816">
<h1>Category Labels</h1>
<p>The last of our <em>static</em> components is a legend, containing the<a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-tertiary="category labels" data-type="indexterm" id="idm45607743396672"/><a data-primary="labels" data-secondary="category legend for D3 visualization of individual Nobel Prizes" data-type="indexterm" id="idm45607743356064"/> category labels shown in <a data-type="xref" href="#d3nobels_legend">Figure 18-2</a>.</p>
<figure><div class="figure" id="d3nobels_legend">
<img alt="dpj2 1802" height="152" src="assets/dpj2_1802.png" width="317"/>
<h6><span class="label">Figure 18-2. </span>Categories legend</h6>
</div></figure>
<p>To create the legend, we first create a group, class <code>labels</code>, to hold the labels. We bind our <code>nbviz.CATEGORIES</code> data to a <code>label</code> selection on this <code>labels</code> group, enter the bound data, and attach a group for each category, displaced on the y-axis by index:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">catLabels</code><code> </code><code class="o">=</code><code> </code><code class="nx">chartHolder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'svg'</code><code class="p">)</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'g'</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'transform'</code><code class="p">,</code><code> </code><code class="s2">"translate(10, 10)"</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'class'</code><code class="p">,</code><code> </code><code class="s1">'labels'</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'label'</code><code class="p">)</code><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">CATEGORIES</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO4-1" id="co_visualizing_individual_prizes_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
        </code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s1">'g'</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'transform'</code><code class="p">,</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code> </code><code class="nx">i</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="k">return</code><code> </code><code class="s2">"translate(0,"</code><code> </code><code class="o">+</code><code> </code><code class="nx">i</code><code> </code><code class="o">*</code><code> </code><code class="mi">10</code><code> </code><code class="o">+</code><code> </code><code class="s2">")"</code><code class="p">;</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO4-2" id="co_visualizing_individual_prizes_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
        </code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO4-1" id="callout_visualizing_individual_prizes_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We join our array of categories (<code>["Chemistry", "Economics", …​]</code>) to the <code>label</code> group using the standard <code>data</code> followed by <code>join</code> methods.</p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO4-2" id="callout_visualizing_individual_prizes_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Creates a group for each category, spaced vertically 10 pixels apart.<a data-primary="data-joins (in D3)" data-secondary="joining array of categories to label group" data-type="indexterm" id="idm45607743271584"/></p></dd>
</dl>
<p>Now that we have our <code>catLabels</code> selection, let’s add a circular indicator (matching those seen in the timeline) and text label to each of its groups:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">catLabels</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'circle'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'fill'</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryFill</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO5-1" id="co_visualizing_individual_prizes_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'r'</code><code class="p">,</code><code> </code><code class="nx">xScale</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">(</code><code class="p">)</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO5-2" id="co_visualizing_individual_prizes_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>

</code><code class="nx">catLabels</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'text'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'dy'</code><code class="p">,</code><code> </code><code class="s1">'0.4em'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'x'</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO5-1" id="callout_visualizing_individual_prizes_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We use our shared <code>categoryFill</code> method to return a color based on the bound category.</p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO5-2" id="callout_visualizing_individual_prizes_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The x scales <code>bandwidth</code> method returns the distance between two category labels. We will use half of this to get the radius for our circular label markers.</p></dd>
</dl>
<p>The <code>categoryFill</code> function (<a data-type="xref" href="#d3time_colors">Example 18-3</a>) is defined in <em>nbviz_core.js</em> and is used by the app to provide colors for the categories. D3 provides a number of color schemes in the form of arrays of color hex codes, which can be used as our SVG fill colors. You can see a demo of the color schemes on <a href="https://oreil.ly/sblXu">Observable</a>. We are dealing with categories, so we’ll use the Category10 set.</p>
<div data-type="example" id="d3time_colors">
<h5><span class="label">Example 18-3. </span>Setting the category colors</h5>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// nbviz_core.js
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">CATEGORIES</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code>
    </code><code class="s2">"Physiology or Medicine"</code><code class="p">,</code><code> </code><code class="s2">"Peace"</code><code class="p">,</code><code> </code><code class="s2">"Physics"</code><code class="p">,</code><code>
    </code><code class="s2">"Literature"</code><code class="p">,</code><code> </code><code class="s2">"Chemistry"</code><code class="p">,</code><code> </code><code class="s2">"Economics"</code><code class="p">]</code><code class="p">;</code><code>

</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryFill</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">category</code><code class="p">)</code><code class="p">{</code><code>
    </code><code class="kd">var</code><code> </code><code class="nx">i</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">CATEGORIES</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">category</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="k">return</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">schemeCategory10</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="p">;</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO6-1" id="co_visualizing_individual_prizes_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO6-1" id="callout_visualizing_individual_prizes_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>D3’s <code>schemeCategory10</code> is an array of 10 color hex codes (<code>['#1f77b4', '#ff7f0e',...]</code>) that we can apply using the prize category index.</p></dd>
</dl></div>
<p>Now that we’ve covered all the static elements of our time chart, let’s look at how we knock it into usable form with D3’s <em>nest</em> library.</p>
</div></section>
<section data-pdf-bookmark="Nesting the Data" data-type="sect1"><div class="sect1" id="idm45607743398224">
<h1>Nesting the Data</h1>
<p>In order to create this timeline component, we need to reorganize our flat array of winners objects into a form that will allow us to bind it to the individual Nobel Prizes in our timeline.<a data-primary="nesting data in D3" data-type="indexterm" id="ix_nest"/><a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-tertiary="nesting the data" data-type="indexterm" id="ix_D3visNPnest"/> What we need, to make binding this data with D3 as smooth as possible, is an array of prize objects by year, with the year groups available as arrays. Let’s demonstrate the conversion process with our Nobel Prize dataset.</p>
<p>The following is the flat Nobel Prize dataset we begin with, ordered by year:</p>
<pre data-code-language="js" data-type="programlisting"><code class="p">[</code>
 <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Wilhelm Conrad R\\u00f6ntgen"</code><code class="p">,...},</code>
 <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Jacobus Henricus van \'t Hoff"</code><code class="p">,...},</code>
 <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Sully Prudhomme"</code><code class="p">,...},</code>
 <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Fr\\u00e9d\\u00e9ric Passy"</code><code class="p">,...},</code>
 <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Henry Dunant"</code><code class="p">,...},</code>
 <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Emil Adolf von Behring"</code><code class="p">,...},</code>
 <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1902</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Theodor Mommsen"</code><code class="p">,...},</code>
 <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1902</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Hermann Emil Fischer"</code><code class="p">,...},</code>
 <code class="p">...</code>
<code class="p">];</code></pre>
<p>We want to take this data and convert it to the following nested format, an array of objects with year keys and winners-by-year values:</p>
<pre data-code-language="js" data-type="programlisting"><code class="p">[</code>
 <code class="p">{</code><code class="s2">"key"</code><code class="o">:</code><code class="s2">"1901"</code><code class="p">,</code>
  <code class="s2">"values"</code><code class="o">:</code><code class="p">[</code>
   <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Wilhelm Conrad R\\u00f6ntgen"</code><code class="p">,...},</code>
   <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Jacobus Henricus van \'t Hoff"</code><code class="p">,...},</code>
   <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Sully Prudhomme"</code><code class="p">,...},</code>
   <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Fr\\u00e9d\\u00e9ric Passy"</code><code class="p">,...},</code>
   <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Henry Dunant"</code><code class="p">,...},</code>
   <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1901</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Emil Adolf von Behring"</code><code class="p">,...}</code>
  <code class="p">]</code>
 <code class="p">},</code>
 <code class="p">{</code><code class="s2">"key"</code><code class="o">:</code><code class="s2">"1902"</code><code class="p">,</code>
  <code class="s2">"values"</code><code class="o">:</code><code class="p">[</code>
   <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1902</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Theodor Mommsen"</code><code class="p">,...},</code>
   <code class="p">{</code><code class="s2">"year"</code><code class="o">:</code><code class="mi">1902</code><code class="p">,</code><code class="s2">"name"</code><code class="o">:</code><code class="s2">"Hermann Emil Fischer"</code><code class="p">,...},</code>
   <code class="p">...</code>
  <code class="p">]</code>
 <code class="p">},</code>
 <code class="p">...</code>
<code class="p">];</code></pre>
<p>We can iterate through this nested array and join the year groups in turn, each one represented by a column of indicators in our timeline.</p>
<p>We can make use of one D3 <code>group</code> utility method in order to group the Nobel prizes by year.<a data-primary="group method (D3)" data-type="indexterm" id="idm45607742798912"/> <code>group</code> takes an array of data and returns an object grouped by the property specified in a callback function, in our case the year of the prize. So we group our entries by year like this:</p>
<pre class="pagebreak-before" data-code-language="js" data-type="programlisting"><code> </code><code class="kd">let</code><code> </code><code class="nx">nestDataByYear</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">entries</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="kd">let</code><code> </code><code class="nx">yearGroups</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">entries</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">year</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO7-1" id="co_visualizing_individual_prizes_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
	</code><code class="c1">// ...
</code><code>  </code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO7-1" id="callout_visualizing_individual_prizes_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Here we use a modern JavaScript lambda shorthand function, equivalent to <code>function(d) { return d.year }</code>.</p></dd>
</dl>
<p>This grouping returns the array of entries of the form:</p>
<pre data-code-language="js" data-type="programlisting"><code class="p">[</code> <code class="c1">// yearGroups</code>
  <code class="p">{</code><code class="mi">1913</code><code class="o">:</code> <code class="p">[{</code><code class="nx">year</code><code class="o">:</code> <code class="mi">1913</code><code class="p">,</code> <code class="p">...},</code> <code class="p">{</code><code class="nx">year</code><code class="o">:</code> <code class="mi">1913</code><code class="p">,</code> <code class="p">...},</code> <code class="p">...]},</code>
  <code class="p">{</code><code class="mi">1921</code><code class="o">:</code> <code class="p">[{</code><code class="nx">year</code><code class="o">:</code> <code class="mi">1921</code><code class="p">,</code> <code class="p">...},</code> <code class="p">{</code><code class="nx">year</code><code class="o">:</code> <code class="mi">1921</code><code class="p">,</code> <code class="p">...},</code> <code class="p">...]},</code>
  <code class="p">...</code>
<code class="p">]</code></pre>
<p>Now in order to convert this map to the required array of key-values objects, we’ll make use of JavaScript’s <code>Array</code> object and its <code>from</code> method.<a data-primary="arrays" data-secondary="JavaScript" data-tertiary="Array object" data-type="indexterm" id="idm45607742689104"/><a data-primary="from method (JavaScript Array)" data-type="indexterm" id="idm45607742687888"/> We pass in our <code>yearGroups</code> map and a converter function that takes the individual groups in the form of a [key, values] array and converts them to a {key: key, values: values} object. We are again using the <a href="https://oreil.ly/rREpC">destructuring assignment syntax</a> to map our key and values:<a data-primary="destructuring capabilities in JavaScript" data-type="indexterm" id="idm45607742686016"/></p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code> <code class="nx">keyValues</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">yearGroups</code><code class="p">,</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code> <code class="nx">values</code><code class="p">]</code> <code class="o">=&gt;</code> <code class="p">{</code><code class="nx">key</code><code class="p">,</code> <code class="nx">values</code><code class="p">})</code></pre>
<p>We now have the required function to group our filtered winning prize entries by year in the key-values form required:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">nestDataByYear</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">entries</code><code class="p">)</code><code> </code><code class="p">{</code><code>
  </code><code class="kd">let</code><code> </code><code class="nx">yearGroups</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">entries</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">year</code><code class="p">)</code><code class="p">;</code><code>
  </code><code class="kd">let</code><code> </code><code class="nx">keyValues</code><code> </code><code class="o">=</code><code> </code><code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">yearGroups</code><code class="p">,</code><code> </code><code class="p">(</code><code class="p">[</code><code class="nx">key</code><code class="p">,</code><code> </code><code class="nx">values</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
    </code><code class="kd">let</code><code> </code><code class="nx">year</code><code> </code><code class="o">=</code><code> </code><code class="nx">key</code><code class="p">;</code><code>
    </code><code class="kd">let</code><code> </code><code class="nx">prizes</code><code> </code><code class="o">=</code><code> </code><code class="nx">values</code><code class="p">;</code><code>
    </code><code class="nx">prizes</code><code> </code><code class="o">=</code><code> </code><code class="nx">prizes</code><code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code>
      </code><code class="p">(</code><code class="nx">p1</code><code class="p">,</code><code> </code><code class="nx">p2</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">(</code><code class="nx">p1</code><code class="p">.</code><code class="nx">category</code><code> </code><code class="o">&gt;</code><code> </code><code class="nx">p2</code><code class="p">.</code><code class="nx">category</code><code> </code><code class="o">?</code><code> </code><code class="mi">1</code><code> </code><code class="o">:</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO8-1" id="co_visualizing_individual_prizes_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="k">return</code><code> </code><code class="p">{</code><code> </code><code class="nx">key</code><code class="o">:</code><code> </code><code class="nx">year</code><code class="p">,</code><code> </code><code class="nx">values</code><code class="o">:</code><code> </code><code class="nx">prizes</code><code> </code><code class="p">}</code><code class="p">;</code><code>
  </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
  </code><code class="k">return</code><code> </code><code class="nx">keyValues</code><code class="p">;</code><code>
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO8-1" id="callout_visualizing_individual_prizes_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We use the JavaScript array’s <a href="https://oreil.ly/VA1ot"><code>sort</code> method</a> to sort the prizes alphabetically by category. <a data-primary="sort method (JavaScript Array)" data-type="indexterm" id="idm45607742475472"/>This will make it easier to compare year with year. <code>sort</code> expects a positive or negative numerical value, which we produce using the Boolean alphanumeric string comparison.<a data-primary="nesting data in D3" data-startref="ix_nest" data-type="indexterm" id="idm45607742474272"/><a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-startref="ix_D3visNPnes" data-tertiary="nesting the data" data-type="indexterm" id="idm45607742473296"/></p></dd>
</dl>
</div></section>
<section class="pagebreak-before less_space" data-pdf-bookmark="Adding the Winners with a Nested Data-Join" data-type="sect1"><div class="sect1" id="idm45607743066352">
<h1>Adding the Winners with a Nested Data-Join</h1>
<p>In <a data-type="xref" href="ch17.xhtml#d3_putting_barchart_together">“Putting the Bar Chart Together”</a> of the last chapter, we saw how D3’s newish <code>join</code> method makes it easy to synchronize changes in data, in that case number of prizes by country, with the visualization of that data, in that case bars in a bar chart.<a data-primary="nesting data in D3" data-secondary="nested data-join" data-type="indexterm" id="ix_nestdajoin"/><a data-primary="data-joins (in D3)" data-secondary="adding winners to Nobel Prizes visualization with nested data-join" data-type="indexterm" id="ix_dajoinaddwin"/><a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-tertiary="adding winners with nested data-join" data-type="indexterm" id="ix_D3visNPadd"/> Our winners-by-year chart is essentially a bar chart where the individual bars are represented by prizes (circle markers). Now we’ll see how this can easily be accomplished by using two data-joins and the nested dataset produced in the last section.<a data-primary="join method (D3)" data-seealso="data-joins" data-type="indexterm" id="idm45607742424480"/></p>
<p>The nested data is first passed from <code>onDataChange</code> to our time chart’s <code>updateTimeChart</code> method. <a data-primary="onDataChange method (JavaScript)" data-type="indexterm" id="idm45607742422448"/>We then use our first data-join to create the year groups, positioning them using our ordinal x scale, which mapped years to pixel positions (see <a data-type="xref" href="#d3time_scales">Example 18-1</a>) and naming them by year:<a data-primary="ordinal scales" data-type="indexterm" id="idm45607742420816"/></p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">updateTimeChart</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code> </code><code class="p">{</code><code>

  </code><code class="kd">let</code><code> </code><code class="nx">years</code><code> </code><code class="o">=</code><code> </code><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'.year'</code><code class="p">)</code><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO9-1" id="co_visualizing_individual_prizes_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>

  </code><code class="nx">years</code><code>
    </code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s1">'g'</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO9-2" id="co_visualizing_individual_prizes_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'year'</code><code class="p">,</code><code> </code><code class="kc">true</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code><code> </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'transform'</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">year</code><code class="p">)</code><code> </code><code class="p">{</code><code>
      </code><code class="k">return</code><code> </code><code class="s1">'translate('</code><code> </code><code class="o">+</code><code> </code><code class="nx">xScale</code><code class="p">(</code><code class="o">+</code><code class="nx">year</code><code class="p">.</code><code class="nx">key</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="s1">',0)'</code><code>
    </code><code class="p">}</code><code class="p">)</code><code>
    </code><code class="c1">//...
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO9-1" id="callout_visualizing_individual_prizes_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We want to join the year data to its respective column by its year
key, not the default array index, which will change if there are
year gaps in our nested array, as there often will be for the user-selected datasets.</p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO9-2" id="callout_visualizing_individual_prizes_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Our first data-join uses the key-values array to produce the circle-bar groups by year.</p></dd>
</dl>
<p>Let’s use Chrome’s Elements tab to see the changes we’ve made from this first data-join. <a data-type="xref" href="#d3nobels_first_enter">Figure 18-3</a> shows our year groups nestled nicely in their parent chart group.</p>
<figure><div class="figure" id="d3nobels_first_enter">
<img alt="dpj2 1803" height="898" src="assets/dpj2_1803.png" width="1139"/>
<h6><span class="label">Figure 18-3. </span>The result of creating our year groups during the first data-join</h6>
</div></figure>
<p>Let’s check to make sure our nested data has been bound correctly to its respective year groups. In <a data-type="xref" href="#d3nobels_firstpass_data">Figure 18-4</a>, we select a group element by its year name and inspect it. As required, the correct data has been bound by year, showing an array of data objects for the six Nobel Prize winners of 1901.</p>
<p>Having joined our year group data to their respective groups, we can now join those values to the circular marker groups representing each year. The first thing we need to do is select all the year groups with the key-values data we just added and bind the values array (the prizes for that year) to some  <em>winner</em> placeholders, which will soon be joined to some  circle markers. This is achieved by the following D3 calls:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">winners</code><code> </code><code class="o">=</code><code> </code><code class="nx">svg</code><code>
      </code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'.year'</code><code class="p">)</code><code>
      </code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'circle'</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO10-1" id="co_visualizing_individual_prizes_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
      </code><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code>
        </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">,</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO10-2" id="co_visualizing_individual_prizes_CO10-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
        </code><code class="nx">d</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code>    </code><a class="co" href="#callout_visualizing_individual_prizes_CO10-3" id="co_visualizing_individual_prizes_CO10-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
      </code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO10-1" id="callout_visualizing_individual_prizes_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We’ll be creating a circle marker for each prize in the values array.</p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO10-2" id="callout_visualizing_individual_prizes_CO10-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>We’ll use the values array to create the circles with D3’s join.</p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO10-3" id="callout_visualizing_individual_prizes_CO10-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>We use an optional key to track the circles/winners by name—this will be useful for transition effects, as we’ll see later on.</p></dd>
</dl>
<figure><div class="figure" id="d3nobels_firstpass_data">
<img alt="dpj2 1804" height="695" src="assets/dpj2_1804.png" width="935"/>
<h6><span class="label">Figure 18-4. </span>Checking the results of our first data-join with Chrome’s console</h6>
</div></figure>
<p>Now that we’ve created our <em>circle</em> placeholders with winning entry data, it only remains to join these to a circle using D3’s <code>join</code> method. This will keep track of any changes to the data and make sure circles are created and destroyed in sync. The rest of the impressively succinct code required is as follows in <a data-type="xref" href="#d3nobels_second_data_join">Example 18-4</a>.</p>
<div data-type="example" id="d3nobels_second_data_join">
<h5><span class="label">Example 18-4. </span>A second data-join to produce the prizes’ circle indicators</h5>
<pre data-code-language="js" data-type="programlisting"><code class="nx">winners</code><code>
    </code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="p">(</code><code class="nx">enter</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
      </code><code class="k">return</code><code> </code><code class="nx">enter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'circle'</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO11-1" id="co_visualizing_individual_prizes_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
               </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cy'</code><code class="p">,</code><code> </code><code class="nx">height</code><code class="p">)</code><code>
    </code><code class="p">}</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'fill'</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
      </code><code class="k">return</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryFill</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">category</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO11-2" id="co_visualizing_individual_prizes_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="p">}</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code><code> </code><code class="nx">xScale</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO11-3" id="co_visualizing_individual_prizes_CO11-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'r'</code><code class="p">,</code><code> </code><code class="nx">xScale</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code> </code><code class="nx">i</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">yScale</code><code class="p">(</code><code class="nx">i</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO11-1" id="callout_visualizing_individual_prizes_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>A custom <code>enter</code> method is used to append any new circles needed and give them a default y position at the bottom (y is down for SVG) of the chart.<a data-primary="enter method (D3)" data-type="indexterm" id="idm45607742101344"/></p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO11-2" id="callout_visualizing_individual_prizes_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>A little helper method returns a color given the prize’s category.</p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO11-3" id="callout_visualizing_individual_prizes_CO11-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The year group already has the correct x position, so we only need to use the bandwidth of the bars to set the radius and center the circle in the middle of the bar. The y-scale is used to set the height of the bar by index <code>i</code> in the winners array.</p></dd>
</dl></div>
<p>The code in <a data-type="xref" href="#d3nobels_second_data_join">Example 18-4</a> does the job of building our prize time chart, creating new indicator circles if required and placing them, along with any existing ones, at their correct position, as designated by their array index (see <a data-type="xref" href="#timeline_second_pass">Figure 18-5</a>).</p>
<figure><div class="figure" id="timeline_second_pass">
<img alt="dpj2 1805" height="551" src="assets/dpj2_1805.png" width="1443"/>
<h6><span class="label">Figure 18-5. </span>The result of our successful second data-join</h6>
</div></figure>
<p>Although we have<a data-primary="transitions" data-secondary="D3" data-tertiary="improving transition in chart visualizing individual Nobel Prizes" data-type="indexterm" id="ix"/> produced a perfectly usable timeline, which will respond to user-driven changes in the data, the transition is a little stark and  unengaging.<sup><a data-type="noteref" href="ch18.xhtml#idm45607742041664" id="idm45607742041664-marker">2</a></sup> Let’s now see a great demonstration of D3’s power: how the addition of two lines of code can buy a rather cool visual effect as our timeline changes state.<a data-primary="nesting data in D3" data-secondary="nested data-join" data-startref="ix_nestdajoin" data-type="indexterm" id="idm45607742040144"/><a data-primary="data-joins (in D3)" data-secondary="adding winners to Nobel Prizes visualization with nested data-join" data-startref="ix_dajoinaddwin" data-type="indexterm" id="idm45607742038960"/><a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-startref="ix_D3visNPadd" data-tertiary="adding winners with nested data-join" data-type="indexterm" id="idm45607742037776"/></p>
</div></section>
<section data-pdf-bookmark="A Little Transitional Sparkle" data-type="sect1"><div class="sect1" id="idm45607742471120">
<h1>A Little Transitional Sparkle</h1>
<p>As things stand, when the user selects a new dataset,<sup><a data-type="noteref" href="ch18.xhtml#idm45607742034720" id="idm45607742034720-marker">3</a></sup> the update pattern in <a data-type="xref" href="#d3nobels_second_data_join">Example 18-4</a>  instantly sets the position of the relevant circles. What we now want to do is to animate this repositioning, smoothing it out over a couple of seconds.<a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-tertiary="improving transitions" data-type="indexterm" id="idm45607742033232"/></p>
<p>Any user-driven filtering will either leave some existing indicators (e.g., when we select only the Chemistry prizes from all categories), add some new ones (e.g., changing our category from Physics to Chemistry), or do both. An edge case is when the filtering leaves nothing (e.g., selecting female Economics winners). This means we need to decide what existing indicators should do and how to animate the positioning of new indicators.</p>
<p><a data-type="xref" href="#d3nobels_transition_less">Figure 18-6</a>  shows what we want to happen on selecting a subset of the existing data, in this case filtering all Nobel Prizes to include only those Physics winners. On the user’s selection of the Physics category, all indicators except the Physics ones are removed by the <code>exit</code> and <code>remove</code> methods. Meanwhile, the existing Physics indicators begin a two-second transition from their current position to an end position, dictated by their array index.</p>
<figure><div class="figure" id="d3nobels_transition_less">
<img alt="dpj2 1806" height="577" src="assets/dpj2_1806.png" width="738"/>
<h6><span class="label">Figure 18-6. </span>Transition on selecting a subset of the existing data</h6>
</div></figure>
<p>It may surprise you to discover that both these visual effects, moving existing bars smoothly into their new place and growing any new bars from the bottom of the chart, can be achieved by the addition of only two lines to our existing code. This is a big testimony to the power of D3’s data-joining concept and its mature design.</p>
<p>To achieve the required transitions, we add calls to <code>transition</code> and <code>duration</code> methods before setting the y position (<em>cy</em> attribute) of the circle marker. These smooth the repositioning of the circle, easing it in over two seconds (2000ms):</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">winners</code><code>
   </code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="p">(</code><code class="nx">enter</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
     </code><code class="k">return</code><code> </code><code class="nx">enter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'circle'</code><code class="p">)</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cy'</code><code class="p">,</code><code> </code><code class="nx">height</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO12-1" id="co_visualizing_individual_prizes_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
   </code><code class="p">}</code><code class="p">)</code><code>
   </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'fill'</code><code class="p">,</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>
     </code><code class="k">return</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryFill</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">category</code><code class="p">)</code><code>
   </code><code class="p">}</code><code class="p">)</code><code>
   </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code><code> </code><code class="nx">xScale</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">)</code><code>
   </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'r'</code><code class="p">,</code><code> </code><code class="nx">xScale</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">)</code><code>
   </code><code class="p">.</code><code class="nx">transition</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO12-2" id="co_visualizing_individual_prizes_CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
   </code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code><code>
   </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code><code> </code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code> </code><code class="nx">i</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">yScale</code><code class="p">(</code><code class="nx">i</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO12-1" id="callout_visualizing_individual_prizes_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Any new circles start at the bottom of the chart.</p></dd>
<dt><a class="co" href="#co_visualizing_individual_prizes_CO12-2" id="callout_visualizing_individual_prizes_CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>All circles are eased into their y position over a duration of 2000ms.</p></dd>
</dl>
<p>As you can see, D3 makes it really easy to add cool visual effects to
your data transitions. This is a testimony to its solid theoretical foundations.
We now have our complete timeline chart, which transitions
smoothly in response to data changes initiated by the user.</p>
<section data-pdf-bookmark="Updating the Bar Chart" data-type="sect2"><div class="sect2" id="idm45607741919008">
<h2>Updating the Bar Chart</h2>
<p>When the time chart module is imported, it appends a callback function to the callbacks array in the core module. <a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-tertiary="updating the bar chart" data-type="indexterm" id="idm45607741917552"/>When data is updated in response to user interaction, this callback function is called and the time chart updated with new country data, nested by year:<a data-primary="updates" data-secondary="updating D3 bar chart visualizing individual Nobel Prizes" data-type="indexterm" id="idm45607741916208"/></p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">callbacks</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_visualizing_individual_prizes_CO13-1" id="co_visualizing_individual_prizes_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code class="kd">let</code><code> </code><code class="nx">data</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">nestDataByYear</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">countryDim</code><code class="o">\</code><code>
              </code><code class="p">.</code><code class="nx">top</code><code class="p">(</code><code class="kc">Infinity</code><code class="p">)</code><code class="p">)</code><code>
  </code><code class="nx">updateTimeChart</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code>
</code><code class="p">}</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_visualizing_individual_prizes_CO13-1" id="callout_visualizing_individual_prizes_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>This anonymous function is called in the core module when data is updated.</p></dd>
</dl>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45607742035760">
<h1>Summary</h1>
<p>Following on from the bar chart in <a data-type="xref" href="ch17.xhtml#chapter_d3_intro">Chapter 17</a>, this chapter extended the update pattern, showing how to use a second data-join on nested data to create a novel chart. It’s important to emphasize that this ability to create novel visualizations is D3’s great strength: you are not tied to the particular functionality of a conventional charting library but can achieve unique transformations of your data. As our Nobel Prize bar chart showed, it’s easy to build conventional dynamic charts, but D3 allows for so much more.</p>
<p>We also saw how easy it is to liven up your visualizations with engaging transformations once a solid update pattern is in place.</p>
<p>In the next chapter, we will build the map component of our Nobel-viz using D3’s impressive topographic library.<a data-primary="D3 library" data-secondary="visualizing individual Nobel Prizes" data-startref="ix_D3visNP" data-type="indexterm" id="idm45607741827600"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45607743508496"><sup><a href="ch18.xhtml#idm45607743508496-marker">1</a></sup> D3 has some handy brushes that make selecting portions of the x- or y-axis easy. Combined with transitions, this can make for an engaging and intuitive way to increase the resolution of large datasets. See <a href="https://oreil.ly/2Q0j7">this <em>bl.ocks.org</em> page</a> for a good example.</p><p data-type="footnote" id="idm45607742041664"><sup><a href="ch18.xhtml#idm45607742041664-marker">2</a></sup> As discussed in <a data-type="xref" href="ch17.xhtml#sect_transitions">“Transitions”</a>, the visual transition from one dataset to another can be both informative and lend a sense of continuity to the visualization, making it more appealing.</p><p data-type="footnote" id="idm45607742034720"><sup><a href="ch18.xhtml#idm45607742034720-marker">3</a></sup> For example, filtering the prizes by category to show only the Physics winners.</p></div></div></section></div></body></html>