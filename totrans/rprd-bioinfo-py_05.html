<html><head></head><body><section data-pdf-bookmark="Chapter 4. Creating the Fibonacci Sequence: Writing, Testing, and Benchmarking Algorithms" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch04">&#13;
<h1><span class="label">Chapter 4. </span>Creating the Fibonacci Sequence: Writing, Testing, and Benchmarking Algorithms</h1>&#13;
&#13;
&#13;
<p>Writing an implementation of the Fibonacci sequence is another step in the hero’s journey to becoming a coder.<a data-primary="Fibonacci sequence" data-secondary="about" data-type="indexterm" id="idm45963636021816"/><a data-primary="Rosalind.info challenges" data-secondary="Fibonacci description" data-type="indexterm" id="idm45963636020872"/>&#13;
<a href="https://oreil.ly/7vkRw">The Rosalind Fibonacci description</a> notes that the genesis for the sequence was a mathematical simulation of breeding rabbits that relies on some important (and unrealistic) assumptions:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The first month starts with a pair of newborn rabbits.</p>&#13;
</li>&#13;
<li>&#13;
<p>Rabbits can reproduce after one month.</p>&#13;
</li>&#13;
<li>&#13;
<p>Every month, every rabbit of reproductive age mates with another rabbit of reproductive age.</p>&#13;
</li>&#13;
<li>&#13;
<p>Exactly one month after two rabbits mate, they produce a litter of the same size.</p>&#13;
</li>&#13;
<li>&#13;
<p>Rabbits are immortal and never stop mating.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The sequence always begins with the numbers 0 and 1.&#13;
The subsequent numbers can be generated <em>ad infinitum</em> by adding the two immediately previous values in the list, as shown in <a data-type="xref" href="#fig_4.1">Figure 4-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig_4.1">&#13;
<img alt="mpfb 0401" src="assets/mpfb_0401.png" width="250"/>&#13;
<h6><span class="label">Figure 4-1. </span>The first eight numbers of the Fibonacci sequence—after the initial 0 and 1, subsequent numbers are created by adding the two previous numbers</h6>&#13;
</div></figure>&#13;
&#13;
<p>If you search the internet for solutions, you’ll find dozens of different ways to generate the sequence.&#13;
I want to focus on three fairly different approaches.&#13;
The first solution uses an <em>imperative</em> approach where the algorithm strictly defines every step.<a data-primary="Fibonacci sequence" data-secondary="about imperative approach" data-type="indexterm" id="idm45963636008296"/>&#13;
The next solution uses a <em>generator</em> function, and the last will focus on a <em>recursive</em> solution.&#13;
Recursion, while interesting, slows drastically as I try to generate more of the sequence, but it turns out the performance problems can be solved using caching.</p>&#13;
&#13;
<p>You will learn:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>How to manually validate arguments and throw errors</p>&#13;
</li>&#13;
<li>&#13;
<p>How to use a list as a stack</p>&#13;
</li>&#13;
<li>&#13;
<p>How to write a generator function</p>&#13;
</li>&#13;
<li>&#13;
<p>How to write a recursive function</p>&#13;
</li>&#13;
<li>&#13;
<p>Why recursive functions can be slow and how to fix this with memoization</p>&#13;
</li>&#13;
<li>&#13;
<p>How to use function decorators</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting Started" data-type="sect1"><div class="sect1" id="idm45963635999480">&#13;
<h1>Getting Started</h1>&#13;
&#13;
<p>The code and tests for this chapter are found in the <em>04_fib</em> directory.&#13;
Start by copying the first solution to <code>fib.py</code>:<a data-primary="Fibonacci sequence" data-secondary="getting started" data-type="indexterm" id="idm45963635997224"/></p>&#13;
&#13;
<pre data-type="programlisting">$ cd 04_fib/&#13;
$ cp solution1_list.py fib.py</pre>&#13;
&#13;
<p>Ask for the usage to see how the parameters are defined.&#13;
You can use <code>n</code> and <code>k</code>, but I chose to use the names <code>generations</code> and <code>litter</code>:</p>&#13;
&#13;
<pre data-type="programlisting">$ ./fib.py -h&#13;
usage: fib.py [-h] generations litter&#13;
&#13;
Calculate Fibonacci&#13;
&#13;
positional arguments:&#13;
  generations  Number of generations&#13;
  litter       Size of litter per generation&#13;
&#13;
optional arguments:&#13;
  -h, --help   show this help message and exit</pre>&#13;
&#13;
<p>This will be the first program to accept arguments that are not strings.&#13;
The Rosalind challenge indicates that the program should accept two positive integer values:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>n</code> ≤ 40 representing the number of generations</p>&#13;
</li>&#13;
<li>&#13;
<p><code>k</code> ≤ 5 representing the litter size produced by mate pairs</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Try to pass noninteger values and notice how the program fails:</p>&#13;
&#13;
<pre data-type="programlisting">$ ./fib.py foo&#13;
usage: fib.py [-h] generations litter&#13;
fib.py: error: argument generations: invalid int value: 'foo'</pre>&#13;
&#13;
<p>You can’t tell, but in addition to printing the brief usage and a helpful error message, the program also generated a nonzero exit value.<a data-primary="status report printed at end of execution" data-secondary="exit status via bash" data-type="indexterm" id="idm45963635986904"/><a data-primary="exit status after execution" data-secondary="zero indicates success" data-type="indexterm" id="idm45963635985928"/><a data-primary="Fibonacci sequence" data-secondary="exit value after execution" data-type="indexterm" id="idm45963635984968"/>&#13;
On the Unix command line, an exit value of <code>0</code> indicates success.&#13;
I think of this as “zero errors.”&#13;
In the <code>bash</code> shell, I can inspect the <code>$?</code> variable to look at the exit status of the most recent process.<a data-primary="bash shell" data-secondary="exit status variable" data-type="indexterm" id="idm45963635982360"/><a data-primary="exit status after execution" data-secondary="bash shell to inspect variable" data-type="indexterm" id="idm45963635981416"/><a data-primary="exit status after execution" data-secondary="$? variable" data-type="indexterm" id="idm45963635980440"/><a data-primary="$? (exit status variable)" data-primary-sortas="# exit status variable" data-type="indexterm" id="idm45963635979480"/>&#13;
For instance, the command <code>echo Hello</code> should exit with a value of <code>0</code>, and indeed it does:</p>&#13;
&#13;
<pre data-type="programlisting">$ echo Hello&#13;
Hello&#13;
$ echo $?&#13;
0</pre>&#13;
&#13;
<p>Try the previously failing command again, and then inspect <code>$?</code>:</p>&#13;
&#13;
<pre data-type="programlisting">$ ./fib.py foo&#13;
usage: fib.py [-h] generations litter&#13;
fib.py: error: argument generations: invalid int value: 'foo'&#13;
$ echo $?&#13;
2</pre>&#13;
&#13;
<p>That the exit status is <code>2</code> is not as important as the fact that the value is not zero.&#13;
This is a well-behaved program because it rejects an invalid argument, prints a useful error message, and exits with a nonzero status.&#13;
If this program were part of a pipeline of data processing steps (such as a <em>Makefile</em>, discussed in <a data-type="xref" href="app01.html#app1_makefiles">Appendix A</a>), a nonzero exit value would cause the entire process to stop, which is a good thing.&#13;
Programs that silently accept invalid values and fail quietly or not at all can lead to unreproducible results.&#13;
It’s vitally important that programs properly validate arguments and fail very convincingly when they cannot proceed.</p>&#13;
&#13;
<p>The program is very strict even about the type of number it accepts.&#13;
The values must be integers.&#13;
It will also repel any floating-point values:</p>&#13;
&#13;
<pre data-type="programlisting">$ ./fib.py 5 3.2&#13;
usage: fib.py [-h] generations litter&#13;
fib.py: error: argument litter: invalid int value: '3.2'</pre>&#13;
<div data-type="note" epub:type="note">&#13;
<p>All command-line arguments to the program are technically received as strings. Even though <code>5</code> on the command line looks like the <em>number</em> 5, it’s the <em>character</em> “5”. I am relying on <code>argparse</code> in this situation to attempt to convert the value from a string to an integer. When that fails, <code>argparse</code> generates these useful error messages.</p>&#13;
</div>&#13;
&#13;
<p>Additionally, the program rejects values for the <code>generations</code> and <code>litter</code> parameters that are not in the allowed ranges.<a data-primary="errors" data-secondary="descriptive messages" data-type="indexterm" id="idm45963635965752"/><a data-primary="Fibonacci sequence" data-secondary="error messages descriptive" data-type="indexterm" id="idm45963635964808"/><a data-primary="Fibonacci sequence" data-secondary="parameter range checking" data-type="indexterm" id="idm45963635963848"/><a data-primary="parameters" data-secondary="range checking" data-type="indexterm" id="idm45963635962888"/>&#13;
Notice that the error message includes the name of the argument and the offending value to provide sufficient feedback to the user so you can fix it:</p>&#13;
&#13;
<pre data-type="programlisting">$ ./fib.py -3 2&#13;
usage: fib.py [-h] generations litter&#13;
fib.py: error: generations "-3" must be between 1 and 40 <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO1-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO1-1"><img alt="1" src="assets/1.png"/></a>&#13;
$ ./fib.py 5 10&#13;
usage: fib.py [-h] generations litter&#13;
fib.py: error: litter "10" must be between 1 and 5 <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO1-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO1-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO1-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The <code>generations</code> argument of <code>-3</code> is not in the stated range of values.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO1-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The <code>litter</code> argument of <code>10</code> is too high.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Look at the first part of the solution to see how to make this work:</p>&#13;
&#13;
<pre data-type="programlisting">import argparse&#13;
from typing import NamedTuple&#13;
&#13;
&#13;
class Args(NamedTuple):&#13;
    """ Command-line arguments """&#13;
    generations: int <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-1"><img alt="1" src="assets/1.png"/></a>&#13;
    litter: int <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-2"><img alt="2" src="assets/2.png"/></a>&#13;
&#13;
&#13;
def get_args() -&gt; Args:&#13;
    """ Get command-line arguments """&#13;
&#13;
    parser = argparse.ArgumentParser(&#13;
        description='Calculate Fibonacci',&#13;
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)&#13;
&#13;
    parser.add_argument('gen', <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-3"><img alt="3" src="assets/3.png"/></a>&#13;
                        metavar='generations',&#13;
                        type=int, <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-4"><img alt="4" src="assets/4.png"/></a>&#13;
                        help='Number of generations')&#13;
&#13;
    parser.add_argument('litter', <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-5" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-5"><img alt="5" src="assets/5.png"/></a>&#13;
                        metavar='litter',&#13;
                        type=int,&#13;
                        help='Size of litter per generation')&#13;
&#13;
    args = parser.parse_args() <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-6" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-6"><img alt="6" src="assets/6.png"/></a>&#13;
&#13;
    if not 1 &lt;= args.gen &lt;= 40: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-7" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-7"><img alt="7" src="assets/7.png"/></a>&#13;
        parser.error(f'generations "{args.gen}" must be between 1 and 40') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-8" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-8"><img alt="8" src="assets/8.png"/></a>&#13;
&#13;
    if not 1 &lt;= args.litter &lt;= 5: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-9" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-9"><img alt="9" src="assets/9.png"/></a>&#13;
        parser.error(f'litter "{args.litter}" must be between 1 and 5') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-10" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-10"><img alt="10" src="assets/10.png"/></a>&#13;
&#13;
    return Args(generations=args.gen, litter=args.litter) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-11" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-11"><img alt="11" src="assets/11.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The <code>generations</code> field must be an <code>int</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The <code>litter</code> field must also be an <code>int</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The <code>gen</code> positional parameter is defined first, so it will receive the first positional value.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The <code>type=int</code> indicates the required class of the value. Notice that <code>int</code> indicates the class itself, not the name of the class.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-5" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The <code>litter</code> positional parameter is defined second, so it will receive the second positional value.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-6" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Attempt to parse the arguments. Any failure will result in error messages and the program exiting with a nonzero value.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-7" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>The <code>args.gen</code> value is now an actual <code>int</code> value, so it’s possible to perform numeric comparisons on it. Check if it is in the acceptable range.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-8" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Use the <code>parser.error()</code> function to generate an error and exit the program.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-9" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Likewise check the value of the <code>args.litter</code> argument.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-10" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>Generate an error that includes information the user needs to fix the problem.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-11" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO2-11"><img alt="11" src="assets/11.png"/></a></dt>&#13;
<dd><p>If the program makes it to this point, then the arguments are valid integer values in the accepted range, so return the <code>Args</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>I could check that the <code>generations</code> and <code>litter</code> values are in the correct ranges in the <code>main()</code> function, but I prefer to do as much argument validation as possible inside the <code>get_args()</code> function so that I can use the <code>parser.error()</code> function to generate useful messages and exit the program with a nonzero value.</p>&#13;
&#13;
<p>Remove the <code>fib.py</code> program and start anew with <strong><code>new.py</code></strong> or your preferred method for creating a program:</p>&#13;
&#13;
<pre data-type="programlisting">$ new.py -fp 'Calculate Fibonacci' fib.py&#13;
Done, see new script "fib.py".</pre>&#13;
&#13;
<p>You can replace the <code>get_args()</code> definition  with the preceding code, then modify your <code>main()</code> function like so:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
    print(f'generations = {args.generations}')&#13;
    print(f'litter = {args.litter}')</pre>&#13;
&#13;
<p>Run your program with invalid inputs and verify that you see the kinds of error messages shown earlier.&#13;
Try your program with acceptable values and verify that you see this kind of output:</p>&#13;
&#13;
<pre data-type="programlisting">$ ./fib.py 1 2&#13;
generations = 1&#13;
litter = 2</pre>&#13;
&#13;
<p>Run <strong><code>pytest</code></strong> to see what your program passes and fails.&#13;
You should pass the first four tests and fail the fifth:</p>&#13;
&#13;
<pre data-type="programlisting">$ pytest -xv&#13;
========================== test session starts ==========================&#13;
...&#13;
tests/fib_test.py::test_exists PASSED                             [ 14%]&#13;
tests/fib_test.py::test_usage PASSED                              [ 28%]&#13;
tests/fib_test.py::test_bad_generations PASSED                    [ 42%]&#13;
tests/fib_test.py::test_bad_litter PASSED                         [ 57%]&#13;
tests/fib_test.py::test_1 FAILED                                  [ 71%] <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-1"><img alt="1" src="assets/1.png"/></a>&#13;
&#13;
=============================== FAILURES ================================&#13;
________________________________ test_1 _________________________________&#13;
&#13;
    def test_1():&#13;
        """runs on good input"""&#13;
&#13;
        rv, out = getstatusoutput(f'{RUN} 5 3') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-2"><img alt="2" src="assets/2.png"/></a>&#13;
        assert rv == 0&#13;
&gt;       assert out == '19' <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-3"><img alt="3" src="assets/3.png"/></a>&#13;
E       AssertionError: assert 'generations = 5\nlitter = 3' == '19' <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-4"><img alt="4" src="assets/4.png"/></a>&#13;
E         - 19    <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-5" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-5"><img alt="5" src="assets/5.png"/></a>&#13;
E         + generations = 5 <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-6" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-6"><img alt="6" src="assets/6.png"/></a>&#13;
E         + litter = 3&#13;
&#13;
tests/fib_test.py:60: AssertionError&#13;
======================== short test summary info ========================&#13;
FAILED tests/fib_test.py::test_1 - AssertionError: assert 'generations...&#13;
!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!&#13;
====================== 1 failed, 4 passed in 0.38s ======================</pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The first failing test. Testing halts here because of the <code>-x</code> flag.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The program is run with <code>5</code> for the number of generations and <code>3</code> for the litter size.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The output should be <code>19</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>This shows the two strings being compared are not equal.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-5" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The expected value was <code>19</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-6" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO3-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>This is the output that was received.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The output from <code>pytest</code> is trying very hard to point out exactly what went wrong.&#13;
It shows how the program was run and what was expected versus what was produced.&#13;
The program is supposed to print 19, which is the fifth number of the Fibonacci sequence when using a litter size of 3.&#13;
If you want to finish the program on your own, please jump right in.&#13;
You should use <strong><code>pytest</code></strong> to verify that you are passing all the tests.&#13;
Also, run <strong><code>make test</code></strong> to check your program using <code>pylint</code>, <code>flake8</code>, and <code>mypy</code>.&#13;
If you want some guidance, I’ll cover the first approach I described.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="An Imperative Approach" data-type="sect2"><div class="sect2" id="idm45963635841960">&#13;
<h2>An Imperative Approach</h2>&#13;
&#13;
<p><a data-type="xref" href="#fig_4.2">Figure 4-2</a> depicts the growth of the Fibonacci sequence.<a data-primary="Fibonacci sequence" data-secondary="about imperative approach" data-type="indexterm" id="idm45963635839960"/> The smaller rabbits indicate nonbreeding pairs that must mature into larger, breeding pairs.</p>&#13;
&#13;
<figure><div class="figure" id="fig_4.2">&#13;
<img alt="mpfb 0402" src="assets/mpfb_0402.png" width="250"/>&#13;
<h6><span class="label">Figure 4-2. </span>A visualization of the growth of the Fibonacci sequence as mating pairs of rabbits using a litter size of 1</h6>&#13;
</div></figure>&#13;
&#13;
<p>You can see that to generate any number after the first two, I need to know the two previous numbers.&#13;
I can use this formula to describe the value of any position <em>n</em> of the Fibonacci sequence (<em>F</em>):</p>&#13;
<div data-type="equation">&#13;
<math alttext="upper F Subscript n Baseline equals upper F Subscript n minus 1 Baseline plus upper F Subscript n minus 2" display="block">&#13;
  <mrow>&#13;
    <msub><mi>F</mi> <mi>n</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <msub><mi>F</mi> <mrow><mi>n</mi><mo>-</mo><mn>1</mn></mrow> </msub>&#13;
    <mo>+</mo>&#13;
    <msub><mi>F</mi> <mrow><mi>n</mi><mo>-</mo><mn>2</mn></mrow> </msub>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>What kind of a data structure in Python would allow me to keep a sequence of numbers in order and refer to them by their position?<a data-primary="Fibonacci sequence" data-secondary="list for" data-type="indexterm" id="idm45963635832792"/><a data-primary="lists" data-secondary="Fibonacci sequence" data-type="indexterm" id="idm45963635831848"/>&#13;
A list.&#13;
I’ll start off with <em>F</em><sub>1</sub> = 0 and <span class="keep-together"><em>F</em><sub>2</sub> = 1</span>:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; fib = [0, 1]</pre>&#13;
&#13;
<p>The <em>F</em><sub>3</sub> value is <em>F</em><sub>2</sub> + <em>F</em><sub>1</sub> = 1 + 0 = 1.&#13;
When generating the next number, I’ll always be referencing the <em>last two</em> elements of the sequence.&#13;
It will be easiest to use negative indexing to indicate a position from the <em>end</em> of the list.<a data-primary="lists" data-secondary="Fibonacci sequence" data-tertiary="negative indexing" data-type="indexterm" id="idm45963635824280"/><a data-primary="Fibonacci sequence" data-secondary="list negative indexing" data-type="indexterm" id="idm45963635823064"/>&#13;
The last value in a list is always at position <code>-1</code>:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; fib[-1]&#13;
1</pre>&#13;
&#13;
<p>The penultimate value is at <code>-2</code>:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; fib[-2]&#13;
0</pre>&#13;
&#13;
<p>I need to multiply this value by the litter size to calculate the number of offspring that generation created.&#13;
To start, I’ll consider a litter size of 1:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; litter = 1&#13;
&gt;&gt;&gt; fib[-2] * litter&#13;
0</pre>&#13;
&#13;
<p>I want to add these two numbers together and append the result to the list:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; fib.append((fib[-2] * litter) + fib[-1])&#13;
&gt;&gt;&gt; fib&#13;
[0, 1, 1]</pre>&#13;
&#13;
<p>If I do this again, I can see that the correct sequence is emerging:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; fib.append((fib[-2] * litter) + fib[-1])&#13;
&gt;&gt;&gt; fib&#13;
[0, 1, 1, 2]</pre>&#13;
&#13;
<p>I need to repeat this action <code>generations</code> times.&#13;
(Technically it will be <code>generations</code>-1 times because Python uses 0-based indexing.)&#13;
I can use Python’s <code>range()</code> function to generate a list of numbers from <code>0</code> up to but not including the end value.<a data-primary="range() function" data-secondary="iteration via" data-type="indexterm" id="idm45963635812888"/>&#13;
I’m calling this function solely for the side effect of iterating a particular number of times and so don’t need the values produced by the <code>range()</code> function.&#13;
It’s common to use the underscore (<code>_</code>) variable to indicate one’s intent to ignore a value:<a data-primary="_ (throwaway variable)" data-primary-sortas="# throwaway variable" data-type="indexterm" id="idm45963635810680"/><a data-primary="variables" data-secondary="_ (throwaway variable)" data-secondary-sortas="# throwaway variable" data-type="indexterm" id="idm45963635809736"/><a data-primary="throwaway variable (_)" data-type="indexterm" id="idm45963635808520"/></p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; fib = [0, 1]&#13;
&gt;&gt;&gt; litter = 1&#13;
&gt;&gt;&gt; generations = 5&#13;
&gt;&gt;&gt; for _ in range(generations - 1):&#13;
...     fib.append((fib[-2] * litter) + fib[-1])&#13;
...&#13;
&gt;&gt;&gt; fib&#13;
[0, 1, 1, 2, 3, 5]</pre>&#13;
&#13;
<p>This should be enough for you to create a solution that passes the tests.&#13;
In the next section, I’ll cover two other solutions that highlight some very interesting parts of Python.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solutions" data-type="sect1"><div class="sect1" id="idm45963635805880">&#13;
<h1>Solutions</h1>&#13;
&#13;
<p>All the following solutions share the same <code>get_args()</code> shown previously.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution 1: An Imperative Solution Using a List as a Stack" data-type="sect2"><div class="sect2" id="idm45963635803944">&#13;
<h2>Solution 1: An Imperative Solution Using a List as a Stack</h2>&#13;
&#13;
<p>Here is how I wrote my imperative solution.<a data-primary="Fibonacci sequence" data-secondary="solution 1 list as stack" data-type="indexterm" id="ch04-las"/>&#13;
I’m using a list as a kind of <em>stack</em> to keep track of past values.&#13;
I don’t need all the values, just the last two, but it’s pretty easy to keep growing the list and referring to the last two values:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
&#13;
    fib = [0, 1] <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-1"><img alt="1" src="assets/1.png"/></a>&#13;
    for _ in range(args.generations - 1): <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-2"><img alt="2" src="assets/2.png"/></a>&#13;
        fib.append((fib[-2] * args.litter) + fib[-1]) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-3"><img alt="3" src="assets/3.png"/></a>&#13;
&#13;
    print(fib[-1]) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-4"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Start with <code>0</code> and <code>1</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Use the <code>range()</code> function to create the right number of loops.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Append the next value to the sequence.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Print the last number of the sequence.</p></dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note">&#13;
<p>I used the <code>_</code> variable name in the <code>for</code> loop to indicate that I don’t intend to use the variable.<a data-primary="_ (throwaway variable)" data-primary-sortas="# throwaway variable" data-type="indexterm" id="idm45963635777192"/><a data-primary="variables" data-secondary="_ (throwaway variable)" data-secondary-sortas="# throwaway variable" data-type="indexterm" id="idm45963635776248"/><a data-primary="throwaway variable (_)" data-type="indexterm" id="idm45963635775032"/><a data-primary="for loops" data-secondary="_ (throwaway variable)" data-secondary-sortas="# throwaway variable" data-type="indexterm" id="idm45963635774360"/><a data-primary="linters to catch errors in code" data-secondary="variable never used" data-type="indexterm" id="idm45963635773144"/><a data-primary="errors" data-secondary="variable never used" data-type="indexterm" id="idm45963635772184"/> The underscore is a valid Python identifier, and it’s also a convention to use this to indicate a <em>throwaway</em> value. Linting tools, for instance, might see that I’ve assigned a variable some value but never used it, which would normally indicate a possible error. The underscore variable shows that I do not intend to use the value. In this case, I’m using the <code>range()</code> function purely for the side effect of creating the number of loops needed.</p>&#13;
</div>&#13;
&#13;
<p>This is considered an <em>imperative</em> solution because the code directly encodes every instruction of the algorithm.<a data-primary="Fibonacci sequence" data-secondary="about imperative approach" data-type="indexterm" id="idm45963635768680"/>&#13;
When you read the recursive solution, you will see that the algorithm can be written in a more declarative manner, which also has unintended consequences that I must handle.</p>&#13;
&#13;
<p>A slight variation on this would be to place this code inside a function I’ll call <code>fib()</code>.&#13;
Note that it’s possible in Python to declare a function inside another function, as here I’ll create <code>fib()</code> inside <code>main()</code>.&#13;
I do this so I can reference the <code>args.litter</code> parameter, creating a <em>closure</em> because the function is capturing the runtime value of the litter size:<a data-primary="Fibonacci sequence" data-secondary="closure created" data-type="indexterm" id="idm45963635764472"/><a data-primary="closure created" data-type="indexterm" id="idm45963635763528"/><a data-primary="functions" data-secondary="closure created" data-type="indexterm" id="idm45963635762856"/></p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
&#13;
    def fib(n: int) -&gt; int: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-1"><img alt="1" src="assets/1.png"/></a>&#13;
        nums = [0, 1] <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-2"><img alt="2" src="assets/2.png"/></a>&#13;
        for _ in range(n - 1): <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-3"><img alt="3" src="assets/3.png"/></a>&#13;
            nums.append((nums[-2] * args.litter) + nums[-1]) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-4"><img alt="4" src="assets/4.png"/></a>&#13;
        return nums[-1] <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-5" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-5"><img alt="5" src="assets/5.png"/></a>&#13;
&#13;
    print(fib(args.generations)) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-6" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-6"><img alt="6" src="assets/6.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Create a function called <code>fib()</code> that accepts an integer parameter <code>n</code> and returns an integer.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>This is the same code as before. Note this list is called <code>nums</code> so it doesn’t clash with the function name.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Use the <code>range()</code> function to iterate the generations. Use <code>_</code> to ignore the values.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The function references the <code>args.litter</code> parameter and so creates a closure.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-5" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Use <code>return</code> to send the final value back to the caller.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-6" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO5-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Call the <code>fib()</code> function with the <code>args.generations</code> parameter.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The scope of the <code>fib()</code> function in the preceding example is limited to the <code>main()</code> function.<a data-primary="scope of function" data-type="indexterm" id="idm45963635726920"/>&#13;
<em>Scope</em> refers to the part of the program where a particular function name or variable is visible or legal.</p>&#13;
&#13;
<p>I don’t have to use a closure.&#13;
Here is how I can express the same idea with a standard function:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
&#13;
    print(fib(args.generations, args.litter)) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO6-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO6-1"><img alt="1" src="assets/1.png"/></a>&#13;
&#13;
def fib(n: int, litter: int) -&gt; int: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO6-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO6-2"><img alt="2" src="assets/2.png"/></a>&#13;
    nums = [0, 1]&#13;
    for _ in range(n - 1):&#13;
        nums.append((nums[-2] * litter) + nums[-1])&#13;
&#13;
    return nums[-1]</pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO6-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The <code>fib()</code> function must be called with two arguments.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO6-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The function requires both the number of generations and the litter size. The function body is essentially the same.</p></dd>&#13;
</dl>&#13;
&#13;
<p>In the preceding code, you see that I must pass two arguments to <code>fib()</code>, whereas the closure required only one argument because the <code>litter</code> was captured.&#13;
Binding values and reducing the number of parameters is a valid reason for creating a closure.&#13;
Another reason to write a closure is to limit the scope of a function.&#13;
The closure definition of <code>fib()</code> is valid only inside the <code>main()</code> function, but the preceding version is visible throughout the program.&#13;
Hiding a function inside another function makes it harder to test.&#13;
In this case, the <code>fib()</code> function is almost the entire program, so the tests have already been written in <em>tests/fib_test.py</em>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution 2: Creating a Generator Function" data-type="sect2"><div class="sect2" id="idm45963635709544">&#13;
<h2>Solution 2: Creating a Generator Function</h2>&#13;
&#13;
<p>In the previous solution, I generated the Fibonacci sequence up to the value requested and then stopped; however, the sequence is infinite.<a data-primary="Fibonacci sequence" data-secondary="solution 2 generator function" data-type="indexterm" id="ch04-genf"/><a data-primary="functions" data-secondary="generator for Fibonacci sequence" data-type="indexterm" id="ch04-genf3"/><a data-primary="generator function for Fibonacci sequence" data-type="indexterm" id="ch04-genf2"/>&#13;
Could I create a function that could generate <em>all</em> the numbers of the sequence?&#13;
Technically, yes, but it would never finish, what with being infinite and all.</p>&#13;
&#13;
<p>Python has a way to suspend a function that generates a possibly infinite sequence.<a data-primary="functions" data-secondary="yield to suspend" data-type="indexterm" id="idm45963635703400"/><a data-primary="yield suspending functions" data-type="indexterm" id="idm45963635702456"/><a data-primary="generator function for Fibonacci sequence" data-secondary="yield suspending functions" data-type="indexterm" id="idm45963635701768"/><a data-primary="functions" data-secondary="generator for Fibonacci sequence" data-tertiary="yield suspending functions" data-type="indexterm" id="idm45963635700776"/>&#13;
I can use <code>yield</code> to return a value from a function, temporarily leaving the function later to resume at the same state when the next value is requested.<a data-startref="ch04-las" data-type="indexterm" id="idm45963635698792"/>&#13;
This kind of function is called a <em>generator</em>, and here is how I can use it to generate the sequence:</p>&#13;
&#13;
<pre data-type="programlisting">def fib(k: int) -&gt; Generator[int, None, None]: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-1"><img alt="1" src="assets/1.png"/></a>&#13;
    x, y = 0, 1 <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-2"><img alt="2" src="assets/2.png"/></a>&#13;
    yield x <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-3"><img alt="3" src="assets/3.png"/></a>&#13;
&#13;
    while True: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-4"><img alt="4" src="assets/4.png"/></a>&#13;
        yield y <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-5" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-5"><img alt="5" src="assets/5.png"/></a>&#13;
        x, y = y * k, x + y <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-6" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-6"><img alt="6" src="assets/6.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The type signature indicates the function takes the parameter <code>k</code> (litter size), which must be an <code>int</code>. It returns a special function of the type <code>Generator</code> which yields <code>int</code> values and has no send or return types.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>I only ever need to track the last two generations, which I initialize to <code>0</code> and <code>1</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Yield the <code>0</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Create an infinite loop.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-5" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Yield the last generation.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-6" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO7-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Set <code>x</code> (two generations back) to the current generation times the litter size. Set <code>y</code> (one generation back) to the sum of the two current generations.</p></dd>&#13;
</dl>&#13;
&#13;
<p>A generator acts like an iterator, producing values as requested by the code until it is exhausted.<a data-primary="generator function for Fibonacci sequence" data-secondary="generator as iterator" data-type="indexterm" id="idm45963635663288"/>&#13;
Since this generator will only generate yield values, the send and return types are <code>None</code>.<a data-primary="functions" data-secondary="yield to suspend" data-tertiary="yield value, not return value" data-type="indexterm" id="idm45963635661640"/><a data-primary="generator function for Fibonacci sequence" data-secondary="yield suspending functions" data-tertiary="yield value, not return value" data-type="indexterm" id="idm45963635660408"/><a data-primary="yield suspending functions" data-secondary="yield value, not return value" data-type="indexterm" id="idm45963635659128"/>&#13;
Otherwise, this code does exactly what the first version of the program did, only inside a fancy-pants generator function.&#13;
See <a data-type="xref" href="#fig_4.3">Figure 4-3</a> to consider how the function works for two different litter sizes.</p>&#13;
&#13;
<figure><div class="figure" id="fig_4.3">&#13;
<img alt="mpfb 0403" src="assets/mpfb_0403.png"/>&#13;
<h6><span class="label">Figure 4-3. </span>A depiction of how the <code>fib()</code> generator’s state changes over time (<code>n</code>=5) for two litter sizes (<code>k</code>=1 and <code>k</code>=3)</h6>&#13;
</div></figure>&#13;
&#13;
<p>The type signature for <code>Generator</code> looks a little complicated since it defines types for yield, send, and return.&#13;
I don’t need to dive into it further here, but I recommend you read the docs on <a href="https://oreil.ly/Oir3d">the <code>typing</code> module</a>.</p>&#13;
&#13;
<p>Here’s how to use this:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
    gen = fib(args.litter) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-1"><img alt="1" src="assets/1.png"/></a>&#13;
    seq = [next(gen) for _ in range(args.generations + 1)] <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-2"><img alt="2" src="assets/2.png"/></a>&#13;
    print(seq[-1]) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The <code>fib()</code> function takes the litter size as an argument and returns a generator.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Use the <code>next()</code> function to retrieve the next value from a generator. Use a list comprehension to do this the correct number of times to generate the sequence up to the requested value.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Print the last number in the sequence.</p></dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note">&#13;
<p>The <code>range()</code> is function different because the first version already had the <code>0</code> and <code>1</code> in place. Here I have to call the generator two extra times to produce those values.</p>&#13;
</div>&#13;
&#13;
<p>Although I prefer the list comprehension, I don’t need the entire list.&#13;
I only care about the final value, so I could have written it like so:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
    gen = fib(args.litter)&#13;
    answer = 0 <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-1"><img alt="1" src="assets/1.png"/></a>&#13;
    for _ in range(args.generations + 1): <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-2"><img alt="2" src="assets/2.png"/></a>&#13;
        answer = next(gen) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-3"><img alt="3" src="assets/3.png"/></a>&#13;
    print(answer) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-4"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Initialize the answer to <code>0</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Create the correct number of loops.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Get the value for the current generation.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Print the answer.</p></dd>&#13;
</dl>&#13;
&#13;
<p>As it happens, it’s quite common to call a function repeatedly to generate a list, so there is a function to do this for us.<a data-primary="generator function for Fibonacci sequence" data-secondary="generator as iterator" data-tertiary="itertools.islice()" data-type="indexterm" id="idm45963635609688"/><a data-primary="iterables" data-secondary="itertools.islice() generating a list" data-type="indexterm" id="idm45963635608440"/><a data-primary="iterators" data-secondary="itertools.islice() generating a list" data-type="indexterm" id="idm45963635607480"/><a data-primary="lists" data-secondary="itertools.islice() generating a list" data-type="indexterm" id="idm45963635606520"/><a data-primary="itertools.islice() generating a list" data-type="indexterm" id="idm45963635605560"/>&#13;
The <code>itertools.islice()</code> function will “Make an iterator that returns selected elements from the iterable.”&#13;
Here is how I can use it:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
    seq = list(islice(fib(args.litter), args.generations + 1)) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO10-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO10-1"><img alt="1" src="assets/1.png"/></a>&#13;
    print(seq[-1]) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO10-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO10-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO10-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The first argument to <code>islice()</code> is the function that will be called, and the second argument is the number of times to call it. The function is lazy, so I use <code>list()</code> to coerce the values.<a data-primary="functions" data-secondary="lazy functions" data-type="indexterm" id="idm45963635595288"/><a data-primary="lazy functions" data-secondary="islice()" data-type="indexterm" id="idm45963635594344"/></p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO10-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Print the last value.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Since I only use the <code>seq</code> variable one time, I could eschew that assignment.&#13;
If benchmarking proved the following to be the best-performing version, I might be willing to write a one-liner:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
    print(list(islice(fib(args.litter), args.generations + 1))[-1])</pre>&#13;
&#13;
<p>Clever code is fun but can become unreadable.<sup><a data-type="noteref" href="ch04.html#idm45963635588216" id="idm45963635588216-marker">1</a></sup> You have been warned.</p>&#13;
&#13;
<p>Generators are cool but more complex than generating a list.&#13;
They are the appropriate way to generate a very large or potentially infinite sequence of values because they are lazy, only computing the next value when your code requires it.<a data-startref="ch04-genf" data-type="indexterm" id="idm45963635586056"/><a data-startref="ch04-genf2" data-type="indexterm" id="idm45963635585384"/><a data-startref="ch04-genf3" data-type="indexterm" id="idm45963635584712"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution 3: Using Recursion and Memoization" data-type="sect2"><div class="sect2" id="idm45963635583720">&#13;
<h2>Solution 3: Using Recursion and Memoization</h2>&#13;
&#13;
<p>While there are many more fun ways to write an algorithm to produce an infinite series of numbers, I’ll show just one more using <em>recursion</em>, which is when a function calls itself:<a data-primary="Fibonacci sequence" data-secondary="solution 3 with recursion" data-type="indexterm" id="ch04-recur"/><a data-primary="recursion" data-secondary="Fibonacci sequence" data-type="indexterm" id="ch04-recur2"/></p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
&#13;
    def fib(n: int) -&gt; int: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-1"><img alt="1" src="assets/1.png"/></a>&#13;
        return 1 if n in (1, 2) \ <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-2"><img alt="2" src="assets/2.png"/></a>&#13;
            else fib(n - 2) * args.litter + fib(n - 1) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-3"><img alt="3" src="assets/3.png"/></a>&#13;
&#13;
    print(fib(args.generations)) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-4"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Define a function called <code>fib()</code> that takes the number of the generation wanted as an <code>int</code> and returns an <code>int</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>If the generation is <code>1</code> or <code>2</code>, return <code>1</code>. This is the all-important base case that does not make a recursive call.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>For all other cases, call the <code>fib()</code> function twice, once for two generations back and another for the previous generation. Factor in the litter size as before.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Print the results of the <code>fib()</code> function for the given generations.</p></dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note">&#13;
<p>Here’s another instance where I define a <code>fib()</code> function as a closure <em>inside</em> the <code>main()</code> function <a data-primary="Fibonacci sequence" data-secondary="closure created" data-type="indexterm" id="idm45963635553016"/><a data-primary="closure created" data-type="indexterm" id="idm45963635552072"/><a data-primary="functions" data-secondary="closure created" data-type="indexterm" id="idm45963635551400"/>so as to use the <code>args.litter</code> value inside the <code>fib()</code> function. This is to close around <code>args.litter</code>, effectively binding that value to the function. If I had defined the function outside the <code>main()</code> function, I would have had to pass the <code>args.litter</code> argument on the recursive calls.</p>&#13;
</div>&#13;
&#13;
<p>This is a really elegant solution that gets taught in pretty much every introductory computer science class.&#13;
It’s fun to study, but it turns out to be wicked slow because I end up calling the function so many times.&#13;
That is, <code>fib(5)</code> needs to call <code>fib(4)</code> and <code>fib(3)</code> to add those values.&#13;
In turn, <code>fib(4)</code> needs to call <code>fib(3)</code> and <code>fib(2)</code>, and so on.&#13;
<a data-type="xref" href="#fig_4.4">Figure 4-4</a> shows that <code>fib(5)</code> results in 14 function calls to produce 5 distinct values.&#13;
For instance, <code>fib(2)</code> is calculated three times, but we only need to calculate it once.</p>&#13;
&#13;
<figure><div class="figure" id="fig_4.4">&#13;
<img alt="mpfb 0404" src="assets/mpfb_0404.png"/>&#13;
<h6><span class="label">Figure 4-4. </span>The call stack for <code>fib(5)</code> results in many recursive calls to the function, with their number increasing approximately exponentially as the input value increases</h6>&#13;
</div></figure>&#13;
&#13;
<p>To illustrate the problem, I’ll take a sampling of how long this program takes to finish up to the maximum <code>n</code> of 40.&#13;
Again, I’ll use a <code>for</code> loop in <code>bash</code> to show you how I would commonly benchmark such a program on the command line:</p>&#13;
&#13;
<pre data-type="programlisting">$ for n in 10 20 30 40;&#13;
&gt; do echo "==&gt; $n &lt;==" &amp;&amp; time ./solution3_recursion.py $n 1&#13;
&gt; done&#13;
==&gt; 10 &lt;==&#13;
55&#13;
&#13;
real	0m0.045s&#13;
user	0m0.032s&#13;
sys	0m0.011s&#13;
==&gt; 20 &lt;==&#13;
6765&#13;
&#13;
real	0m0.041s&#13;
user	0m0.031s&#13;
sys	0m0.009s&#13;
==&gt; 30 &lt;==&#13;
832040&#13;
&#13;
real	0m0.292s&#13;
user	0m0.281s&#13;
sys	0m0.009s&#13;
==&gt; 40 &lt;==&#13;
102334155&#13;
&#13;
real	0m31.629s&#13;
user	0m31.505s&#13;
sys	0m0.043s</pre>&#13;
&#13;
<p>The jump from 0.29s for <code>n</code>=<code>30</code> to 31s for <code>n</code>=<code>40</code> is huge.&#13;
Imagine going to 50 and beyond.&#13;
I need to either find a way to speed this up or abandon all hope for recursion.&#13;
The solution is to cache previously calculated results.<a data-primary="Fibonacci sequence" data-secondary="memoization" data-type="indexterm" id="idm45963635534520"/><a data-primary="recursion" data-secondary="memoization" data-type="indexterm" id="idm45963635533576"/><a data-primary="memoization" data-type="indexterm" id="idm45963635532632"/><a data-primary="Callable for memoization" data-type="indexterm" id="idm45963635531960"/><a data-primary="caching previous results (memoization)" data-type="indexterm" id="idm45963635531272"/>&#13;
This is called <em>memoization</em>, and there are many ways to implement this.&#13;
The following is one method.&#13;
Note you will need to import <code>typing.Callable</code>:</p>&#13;
&#13;
<pre data-type="programlisting">def memoize(f: Callable) -&gt; Callable: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-1"><img alt="1" src="assets/1.png"/></a>&#13;
    """ Memoize a function """&#13;
&#13;
    cache = {} <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-2"><img alt="2" src="assets/2.png"/></a>&#13;
&#13;
    def memo(x): <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-3"><img alt="3" src="assets/3.png"/></a>&#13;
        if x not in cache: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-4"><img alt="4" src="assets/4.png"/></a>&#13;
            cache[x] = f(x) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-5" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-5"><img alt="5" src="assets/5.png"/></a>&#13;
        return cache[x] <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-6" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-6"><img alt="6" src="assets/6.png"/></a>&#13;
&#13;
    return memo <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-7" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-7"><img alt="7" src="assets/7.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Define a function that takes a function (something that is <em>callable</em>) and returns a function.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Use a dictionary to store cached values.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Define <code>memo()</code> as a closure around the cache. The function will take some parameter <code>x</code> when called.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>See if the argument value is in the cache.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-5" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>If not, call the function with the argument and set the cache for that argument value to the result.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-6" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Return the cached value for the argument.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-7" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO12-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Return the new function.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Note that the <code>memoize()</code> function returns a new function.&#13;
In Python, functions are considered <em>first-class objects</em>, meaning they can be used like other kinds of variables—you can pass them as arguments and overwrite their definitions.&#13;
The <code>memoize()</code> function is an example of a <em>higher-order function</em> (HOF) because it takes other functions as arguments.<a data-primary="higher-order functions (HOFs)" data-type="indexterm" id="idm45963635491272"/><a data-primary="arguments" data-secondary="HOFs taking other functions as" data-type="indexterm" id="idm45963635490584"/><a data-primary="functions" data-secondary="HOFs (higher-order functions)" data-type="indexterm" id="idm45963635489624"/><a data-primary="memoization" data-secondary="memoize() as HOF" data-type="indexterm" id="idm45963635488664"/>&#13;
I’ll be using other HOFs, like <code>filter()</code> and <code>map()</code>, throughout the book.</p>&#13;
&#13;
<p>To use the <code>memoize()</code> function, I will define <code>fib()</code> and then <em>redefine it</em> with the memoized version.&#13;
If you run this, you will see an almost instantaneous result no matter how high <code>n</code> goes:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
&#13;
    def fib(n: int) -&gt; int:&#13;
        return 1 if n in (1, 2) else fib(n - 2) * args.litter + fib(n - 1)&#13;
&#13;
    fib = memoize(fib) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO13-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO13-1"><img alt="1" src="assets/1.png"/></a>&#13;
&#13;
    print(fib(args.generations))</pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO13-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Overwrite the existing <code>fib()</code> definition with the memoized function.</p></dd>&#13;
</dl>&#13;
&#13;
<p>A preferred method to accomplish this uses a <em>decorator</em>, which is a function that modifies another function:<a data-primary="decorator functions" data-type="indexterm" id="idm45963635476584"/><a data-primary="functions" data-secondary="decorator functions" data-type="indexterm" id="idm45963635475912"/><a data-primary="recursion" data-secondary="memoization" data-tertiary="decorator functions" data-type="indexterm" id="idm45963635474968"/><a data-primary="memoization" data-secondary="decorator functions" data-type="indexterm" id="idm45963635473752"/></p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
&#13;
    @memoize <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO14-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO14-1"><img alt="1" src="assets/1.png"/></a>&#13;
    def fib(n: int) -&gt; int:&#13;
        return 1 if n in (1, 2) else fib(n - 2) * args.litter + fib(n - 1)&#13;
&#13;
    print(fib(args.generations))</pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO14-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Decorate the <code>fib()</code> function with the <code>memoize()</code> function.</p></dd>&#13;
</dl>&#13;
&#13;
<p>As fun as writing memoization functions is, it again turns out that this is such a common need that others have already solved it for us.&#13;
I can remove the <code>memoize()</code> function and instead import the <code>functools.lru_cache</code> (least-recently-used cache) function:<a data-primary="memoization" data-secondary="lru_cache() (least-recently-used cache)" data-type="indexterm" id="idm45963635464104"/><a data-primary="lru_cache() (least-recently-used cache)" data-type="indexterm" id="idm45963635463144"/><a data-primary="caching previous results (memoization)" data-secondary="lru_cache() (least-recently-used cache)" data-type="indexterm" id="idm45963635462456"/><a data-primary="recursion" data-secondary="memoization" data-tertiary="lru_cache() (least-recently-used cache)" data-type="indexterm" id="idm45963635461480"/></p>&#13;
&#13;
<pre data-type="programlisting">from functools import lru_cache</pre>&#13;
&#13;
<p>Decorate the <code>fib()</code> function with the <code>lru_cache()</code> function to get memoization with minimal distraction:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
&#13;
    @lru_cache() <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO15-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO15-1"><img alt="1" src="assets/1.png"/></a>&#13;
    def fib(n: int) -&gt; int:&#13;
        return 1 if n in (1, 2) else fib(n - 2) * args.litter + fib(n - 1)&#13;
&#13;
    print(fib(args.generations))</pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO15-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Memoize the <code>fib()</code> function via decoration with the <code>lru_cache()</code> function. Note that Python 3.6 requires the parentheses, but 3.8 and later versions do not.<a data-startref="ch04-recur" data-type="indexterm" id="idm45963635451016"/><a data-startref="ch04-recur2" data-type="indexterm" id="idm45963635450344"/></p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Benchmarking the Solutions" data-type="sect1"><div class="sect1" id="idm45963635449032">&#13;
<h1>Benchmarking the Solutions</h1>&#13;
&#13;
<p>Which is the fastest solution?<a data-primary="Fibonacci sequence" data-secondary="solutions benchmarked" data-type="indexterm" id="idm45963635447704"/><a data-primary="benchmarking the solutions" data-secondary="Fibonacci sequence" data-type="indexterm" id="idm45963635446760"/><a data-primary="bash shell" data-secondary="benchmarking the solutions" data-tertiary="Fibonacci sequence" data-type="indexterm" id="idm45963635445800"/>&#13;
I’ve shown you how to use a <code>for</code> loop in <code>bash</code> with the <code>time</code> command to compare the runtimes of commands:</p>&#13;
&#13;
<pre data-type="programlisting">$ for py in ./solution1_list.py ./solution2_generator_islice.py \&#13;
./solution3_recursion_lru_cache.py; do echo $py &amp;&amp; time $py 40 5; done&#13;
./solution1_list.py&#13;
148277527396903091&#13;
&#13;
real	0m0.070s&#13;
user	0m0.043s&#13;
sys	0m0.016s&#13;
./solution2_generator_islice.py&#13;
148277527396903091&#13;
&#13;
real	0m0.049s&#13;
user	0m0.033s&#13;
sys	0m0.013s&#13;
./solution3_recursion_lru_cache.py&#13;
148277527396903091&#13;
&#13;
real	0m0.041s&#13;
user	0m0.030s&#13;
sys	0m0.010s</pre>&#13;
&#13;
<p>It would appear that the recursive solution using LRU caching is the fastest, but again I have very little data—just one run per program.&#13;
Also, I have to eyeball this data and figure out which is the fastest.</p>&#13;
&#13;
<p>There’s a better way.&#13;
I have installed a tool called <a href="https://oreil.ly/shqOS"><code>hyperfine</code></a> to run each command many times and compare the results:<a data-primary="benchmarking the solutions" data-secondary="hyperfine tool for multiple runs" data-type="indexterm" id="idm45963635439896"/><a data-primary="hyperfine tool for benchmarking" data-type="indexterm" id="idm45963635438920"/><a data-primary="resources" data-secondary="hyperfine tool for benchmarking" data-type="indexterm" id="idm45963635438232"/></p>&#13;
&#13;
<pre data-type="programlisting">$ hyperfine -L prg ./solution1_list.py,./solution2_generator_islice.py,\&#13;
./solution3_recursion_lru_cache.py '{prg} 40 5' --prepare 'rm -rf __pycache__'&#13;
Benchmark #1: ./solution1_list.py 40 5&#13;
  Time (mean ± σ):      38.1 ms ±   1.1 ms    [User: 28.3 ms, System: 8.2 ms]&#13;
  Range (min … max):    36.6 ms …  42.8 ms    60 runs&#13;
&#13;
Benchmark #2: ./solution2_generator_islice.py 40 5&#13;
  Time (mean ± σ):      38.0 ms ±   0.6 ms    [User: 28.2 ms, System: 8.1 ms]&#13;
  Range (min … max):    36.7 ms …  39.2 ms    66 runs&#13;
&#13;
Benchmark #3: ./solution3_recursion_lru_cache.py 40 5&#13;
  Time (mean ± σ):      37.9 ms ±   0.6 ms    [User: 28.1 ms, System: 8.1 ms]&#13;
  Range (min … max):    36.6 ms …  39.4 ms    65 runs&#13;
&#13;
Summary&#13;
  './solution3_recursion_lru_cache.py 40 5' ran&#13;
    1.00 ± 0.02 times faster than './solution2_generator_islice.py 40 5'&#13;
    1.01 ± 0.03 times faster than './solution1_list.py 40 5'</pre>&#13;
&#13;
<p>It appears that <code>hyperfine</code> ran each command 60-66 times, averaged the results, and found that the <code>solution3_recursion_lru_cache.py</code> program is perhaps slightly faster.&#13;
Another benchmarking tool you might find useful is <a href="https://oreil.ly/FKnmd"><code>bench</code></a>, but you can search for other benchmarking tools on the internet that might suit your tastes more.<a data-primary="benchmarking the solutions" data-secondary="bench tool" data-type="indexterm" id="idm45963635433224"/><a data-primary="bench tool for benchmarking" data-type="indexterm" id="idm45963635432264"/>&#13;
Whatever tool you use, benchmarking along with testing is vital to challenging assumptions about your code.</p>&#13;
<div data-type="note" epub:type="note">&#13;
<p>I used the <code>--prepare</code> option to tell <code>hyperfine</code> to remove the <span class="keep-together"><em>pycache</em></span> directory before running the commands.<a data-primary="hyperfine tool for benchmarking" data-secondary="removing Python pycache directory" data-type="indexterm" id="idm45963635428552"/><a data-primary="benchmarking the solutions" data-secondary="hyperfine tool for multiple runs" data-tertiary="removing Python pycache directory" data-type="indexterm" id="idm45963635427576"/><a data-primary="Python" data-secondary="bytecode cache" data-type="indexterm" id="idm45963635426312"/><a data-primary="bytecode cache for Python" data-type="indexterm" id="idm45963635425368"/> This is a directory created by Python to cache <em>bytecode</em> of the program. If a program’s source code hasn’t changed since the last time it was run, then Python can skip compilation and use the bytecode version that exists in the <em>pycache</em> directory. I needed to remove this as <code>hyperfine</code> detected statistical outliers when running the commands, probably due to caching effects.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing the Good, the Bad, and the Ugly" data-type="sect1"><div class="sect1" id="idm45963635422408">&#13;
<h1>Testing the Good, the Bad, and the Ugly</h1>&#13;
&#13;
<p>For every challenge, I hope you spend part of your time reading through the tests.<a data-primary="Fibonacci sequence" data-secondary="testing" data-type="indexterm" id="idm45963635421032"/>&#13;
Learning how to design and write tests is as important as anything else I’m showing you.&#13;
As I mentioned before, my first tests check that the expected program exists and will produce usage statements on request.&#13;
After that, I usually give invalid inputs to ensure the program fails.&#13;
I would like to highlight the tests for bad <code>n</code> and <code>k</code> parameters.&#13;
They are essentially the same, so I’ll just show the first one as it demonstrates how to randomly select an invalid integer value—one that is possibly negative or too high:</p>&#13;
&#13;
<pre data-type="programlisting">def test_bad_n():&#13;
    """ Dies when n is bad """&#13;
&#13;
    n = random.choice(list(range(-10, 0)) + list(range(41, 50))) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-1"><img alt="1" src="assets/1.png"/></a>&#13;
    k = random.randint(1, 5) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-2"><img alt="2" src="assets/2.png"/></a>&#13;
    rv, out = getstatusoutput(f'{RUN} {n} {k}') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-3"><img alt="3" src="assets/3.png"/></a>&#13;
    assert rv != 0 <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-4"><img alt="4" src="assets/4.png"/></a>&#13;
    assert out.lower().startswith('usage:') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-5" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-5"><img alt="5" src="assets/5.png"/></a>&#13;
    assert re.search(f'n "{n}" must be between 1 and 40', out) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-6" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-6"><img alt="6" src="assets/6.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Join the two lists of invalid number ranges and randomly select one value.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Select a random integer in the range from <code>1</code> to <code>5</code> (both bounds inclusive).</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Run the program with the arguments and capture the output.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Make sure the program reported a failure (nonzero exit value).</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-5" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Check the output begins with a usage statement.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-6" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO16-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Look for an error message describing the problem with the <code>n</code> argument.</p></dd>&#13;
</dl>&#13;
&#13;
<p>I often like to use randomly selected invalid values when testing.&#13;
This partially comes from writing tests for students so that they won’t write programs that fail on a single bad input, but I also find it helps me to not accidentally code for a specific input value.&#13;
I haven’t yet covered the <code>random</code> module, but it gives you a way to make pseudorandom choices.&#13;
First, you need to import the module:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; import random</pre>&#13;
&#13;
<p>For instance, you can use <code>random.randint()</code> to select a single integer from a given range:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; random.randint(1, 5)&#13;
2&#13;
&gt;&gt;&gt; random.randint(1, 5)&#13;
5</pre>&#13;
&#13;
<p>Or use the <code>random.choice()</code> function to randomly select a single value from some sequence.&#13;
Here I wanted to construct a discontiguous range of negative numbers separated from a range of positive numbers:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; random.choice(list(range(-10, 0)) + list(range(41, 50)))&#13;
46&#13;
&gt;&gt;&gt; random.choice(list(range(-10, 0)) + list(range(41, 50)))&#13;
-1</pre>&#13;
&#13;
<p>The tests that follow all provide good inputs to the program. For example:</p>&#13;
&#13;
<pre data-type="programlisting">def test_2():&#13;
    """ Runs on good input """&#13;
&#13;
    rv, out = getstatusoutput(f'{RUN} 30 4') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-1"><img alt="1" src="assets/1.png"/></a>&#13;
    assert rv == 0 <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-2"><img alt="2" src="assets/2.png"/></a>&#13;
    assert out == '436390025825' <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>These are values I was given while attempting to solve the Rosalind challenge.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The program should not fail on this input.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO17-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>This is the correct answer per Rosalind.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Testing, like documentation, is a love letter to your future self.&#13;
As tedious as testing may seem, you’ll appreciate failing tests when you try to add a feature and end up accidentally breaking something that previously worked.&#13;
Assiduously writing and running tests can prevent you from deploying broken programs.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running the Test Suite on All the Solutions" data-type="sect1"><div class="sect1" id="idm45963635364696">&#13;
<h1>Running the Test Suite on All the Solutions</h1>&#13;
&#13;
<p>You’ve seen that in each chapter I write multiple solutions to explore various ways to solve the problems.<a data-primary="test-driven development (TDD)" data-secondary="automating testing every solution" data-type="indexterm" id="ch04-auto"/><a data-primary="Fibonacci sequence" data-secondary="testing automated" data-type="indexterm" id="ch04-auto2"/><a data-primary="Makefiles" data-secondary="shortcuts for commands" data-tertiary="testing every solution" data-type="indexterm" id="ch04-auto3"/>&#13;
I completely rely on my tests to ensure my programs are correct.&#13;
You might be curious to see how I’ve automated the process of testing every single solution.&#13;
Look at the <em>Makefile</em> and find the <code>all</code> target:</p>&#13;
&#13;
<pre data-type="programlisting">$ cat Makefile&#13;
.PHONY: test&#13;
&#13;
test:&#13;
	python3 -m pytest -xv --flake8 --pylint --mypy fib.py tests/fib_test.py&#13;
&#13;
all:&#13;
    ../bin/all_test.py fib.py</pre>&#13;
<div data-type="warning" epub:type="warning">&#13;
<p>The <code>all_test.py</code> program will overwrite the <code>fib.py</code> program with each of the solutions before running the test suite. This could overwrite your solution. Be sure you commit your version to Git or at least make a copy before you run <code>make all</code> or you could lose your work.</p>&#13;
</div>&#13;
&#13;
<p>The following is the <code>all_test.py</code> program that is run by the <code>all</code> target.&#13;
I’ll break it into two parts, starting with the first part up to <code>get_args()</code>.&#13;
Most of this should be familiar by now:</p>&#13;
&#13;
<pre data-type="programlisting">#!/usr/bin/env python3&#13;
""" Run the test suite on all solution*.py """&#13;
&#13;
import argparse&#13;
import os&#13;
import re&#13;
import shutil&#13;
import sys&#13;
from subprocess import getstatusoutput&#13;
from functools import partial&#13;
from typing import NamedTuple&#13;
&#13;
&#13;
class Args(NamedTuple):&#13;
    """ Command-line arguments """&#13;
    program: str <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-1"><img alt="1" src="assets/1.png"/></a>&#13;
    quiet: bool <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-2"><img alt="2" src="assets/2.png"/></a>&#13;
&#13;
&#13;
# --------------------------------------------------&#13;
def get_args() -&gt; Args:&#13;
    """ Get command-line arguments """&#13;
&#13;
    parser = argparse.ArgumentParser(&#13;
        description='Run the test suite on all solution*.py',&#13;
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)&#13;
&#13;
    parser.add_argument('program', metavar='prg', help='Program to test') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-3"><img alt="3" src="assets/3.png"/></a>&#13;
&#13;
    parser.add_argument('-q', '--quiet', action='store_true', help='Be quiet') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-4"><img alt="4" src="assets/4.png"/></a>&#13;
&#13;
    args = parser.parse_args()&#13;
&#13;
    return Args(args.program, args.quiet)</pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The name of the program to test, which in this case is <code>fib.py</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>A Boolean value of <code>True</code> or <code>False</code> to create more or less output.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The default type is <code>str</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO18-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The <code>action='store_true'</code> makes this a Boolean flag. If the flag is present the value will be <code>True</code>, and it will be <code>False</code> otherwise.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The <code>main()</code> function is where the testing happens:</p>&#13;
&#13;
<pre data-type="programlisting">def main() -&gt; None:&#13;
    args = get_args()&#13;
    cwd = os.getcwd() <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-1" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-1"><img alt="1" src="assets/1.png"/></a>&#13;
    solutions = list( <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-2" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-2"><img alt="2" src="assets/2.png"/></a>&#13;
        filter(partial(re.match, r'solution.*\.py'), os.listdir(cwd))) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-3" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-3"><img alt="3" src="assets/3.png"/></a>&#13;
&#13;
    for solution in sorted(solutions): <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-4" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-4"><img alt="4" src="assets/4.png"/></a>&#13;
        print(f'==&gt; {solution} &lt;==')&#13;
        shutil.copyfile(solution, os.path.join(cwd, args.program)) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-5" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-5"><img alt="5" src="assets/5.png"/></a>&#13;
        subprocess.run(['chmod', '+x', args.program], check=True) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-6" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-6"><img alt="6" src="assets/6.png"/></a>&#13;
        rv, out = getstatusoutput('make test') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-7" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-7"><img alt="7" src="assets/7.png"/></a>&#13;
        if rv != 0: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-8" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-8"><img alt="8" src="assets/8.png"/></a>&#13;
            sys.exit(out) <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-9" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-9"><img alt="9" src="assets/9.png"/></a>&#13;
&#13;
        if not args.quiet: <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-10" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-10"><img alt="10" src="assets/10.png"/></a>&#13;
            print(out)&#13;
&#13;
    print('Done.') <a class="co" href="#callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-11" id="co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-11"><img alt="11" src="assets/11.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-1" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Get the current working directory, which will be the <em>04_fib</em> directory if you are in that directory when running the command.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-2" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Find all the <code>solution*.py</code> files in the current directory.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-3" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Both <code>filter()</code> and <code>partial()</code> are HOFs; I’ll explain them next.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-4" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The filenames will be in random order, so iterate through the sorted files.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-5" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Copy the <code>solution*.py</code> file to the testing filename.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-6" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Make the program executable.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-7" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Run the <code>make test</code> command, and capture the return value and output.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-8" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>See if the return value is not <code>0</code>.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-9" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Exit this program while printing the output from the testing and returning a nonzero value.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-10" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>Unless the program is supposed to be quiet, print the testing output.</p></dd>&#13;
<dt><a class="co" href="#co_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-11" id="callout_creating_the_fibonacci_sequence__writing__testing__and_benchmarking_algorithms_CO19-11"><img alt="11" src="assets/11.png"/></a></dt>&#13;
<dd><p>Let the user know the program finishes normally.</p></dd>&#13;
</dl>&#13;
&#13;
<p>In the preceding code, I’m using <code>sys.exit()</code> to immediately halt the program, print an error message, and return a nonzero exit value.<a data-primary="exit status after execution" data-secondary="sys.exit() for errors" data-type="indexterm" id="idm45963635270024"/><a data-primary="sys.exit() for errors" data-type="indexterm" id="idm45963635269064"/><a data-primary="errors" data-secondary="sys.exit() for halting program" data-type="indexterm" id="idm45963635268392"/>&#13;
If you consult the documentation, you’ll find you can invoke <code>sys.exit()</code> with no arguments, an integer value, or a object like a string, which is what I’m using:</p>&#13;
&#13;
<pre data-type="programlisting">exit(status=None, /)&#13;
    Exit the interpreter by raising SystemExit(status).&#13;
&#13;
    If the status is omitted or None, it defaults to zero (i.e., success).&#13;
    If the status is an integer, it will be used as the system exit status.&#13;
    <strong>If it is another kind of object, it will be printed and the system&#13;
    exit status will be one (i.e., failure).</strong></pre>&#13;
&#13;
<p>The preceding program also uses the functions <code>filter()</code> or <code>partial()</code>, which I haven’t covered yet.&#13;
Both of these are HOFs.&#13;
I’ll explain how and why I’m using them.&#13;
To start, the <code>os.listdir()</code> function will return the entire contents of a directory, including files and directories:<a data-primary="listdir() for directory contents" data-type="indexterm" id="idm45963635263368"/><a data-primary="directory contents via listdir()" data-type="indexterm" id="idm45963635262680"/><a data-primary="os module" data-secondary="directory contents via listdir()" data-type="indexterm" id="idm45963635261992"/></p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; import os&#13;
&gt;&gt;&gt; files = os.listdir()</pre>&#13;
&#13;
<p>There’s a lot there, so I’ll import the <code>pprint()</code> function from the <code>pprint</code> module to <em>pretty-print</em> this:<a data-primary="pprint() function (pretty-print)" data-type="indexterm" id="idm45963635258472"/><a data-primary="output from program" data-secondary="pprint() function (pretty-print)" data-type="indexterm" id="idm45963635257784"/></p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; from pprint import pprint&#13;
&gt;&gt;&gt; pprint(files)&#13;
['solution3_recursion_memoize_decorator.py',&#13;
 'solution2_generator_for_loop.py',&#13;
 '.pytest_cache',&#13;
 'Makefile',&#13;
 'solution2_generator_islice.py',&#13;
 'tests',&#13;
 '__pycache__',&#13;
 'fib.py',&#13;
 'README.md',&#13;
 'solution3_recursion_memoize.py',&#13;
 'bench.html',&#13;
 'solution2_generator.py',&#13;
 '.mypy_cache',&#13;
 '.gitignore',&#13;
 'solution1_list.py',&#13;
 'solution3_recursion_lru_cache.py',&#13;
 'solution3_recursion.py']</pre>&#13;
&#13;
<p>I want to filter those to names that start with <em>solution</em> and end with <em>.py</em>.<a data-primary="filter() function" data-secondary="file name filtering" data-type="indexterm" id="idm45963635254312"/>&#13;
On the command line, I would match this pattern using a <em>file glob</em> like <code>solution*.py</code>, <a data-primary="Unix command line" data-secondary="file globs to match patterns" data-type="indexterm" id="idm45963635252264"/><a data-primary="command line (Unix)" data-secondary="file globs to match patterns" data-type="indexterm" id="idm45963635251304"/><a data-primary="file globs to match patterns" data-type="indexterm" id="idm45963635250344"/>where the <code>*</code> means <em>zero or more of any character</em> and the <code>.</code> is a literal dot.<a data-primary="* (zero or more characters)" data-primary-sortas="# zero" data-type="indexterm" id="idm45963635248136"/>&#13;
A regular expression version of this pattern is the slightly more complicated <code>solution.*\.py</code>, where <span class="keep-together"><code>.</code> (dot)</span> <a data-primary="regular expressions (regexes)" data-secondary="file glob–regex complications" data-type="indexterm" id="idm45963635245496"/><a data-primary=". (any character)" data-primary-sortas="# any character" data-type="indexterm" id="idm45963635244520"/>is a regex metacharacter representing <em>any character</em>, and <code>*</code> (star or asterisk) means <em>zero or more</em> (see <a data-type="xref" href="#fig_4.5">Figure 4-5</a>).&#13;
To indicate a literal dot, I need to escape it with a backslash (<code>\.</code>).&#13;
Note that it’s prudent to use the r-string (<em>raw</em> string) to enclose this pattern.<a data-primary="regular expressions (regexes)" data-secondary="r-string (raw string)" data-type="indexterm" id="idm45963635240216"/></p>&#13;
&#13;
<figure><div class="figure" id="fig_4.5">&#13;
<img alt="mpfb 0405" src="assets/mpfb_0405.png"/>&#13;
<h6><span class="label">Figure 4-5. </span>A regular expression to find files matching the file glob <code>solution*.py</code></h6>&#13;
</div></figure>&#13;
&#13;
<p>When the match is successful, a <code>re.Match</code> object is returned:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; import re&#13;
&gt;&gt;&gt; re.match(r'solution.*\.py', 'solution1.py')&#13;
&lt;re.Match object; span=(0, 12), match='solution1.py'&gt;</pre>&#13;
&#13;
<p>When a match fails, the <code>None</code> value is returned.&#13;
I have to use <code>type()</code> here because the <code>None</code> value is not displayed in the REPL:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; type(re.match(r'solution.*\.py', 'fib.py'))&#13;
&lt;class 'NoneType'&gt;</pre>&#13;
&#13;
<p>I want to apply this match to all the files returned by <code>os.listdir()</code>.&#13;
I can use <span class="keep-together"><code>filter()</code></span> and the <code>lambda</code> keyword to create an <em>anonymous</em> function.<a data-primary="lambda keyword" data-type="indexterm" id="idm45963635229848"/><a data-primary="functions" data-secondary="lambda keyword" data-type="indexterm" id="idm45963635229176"/><a data-primary="functions" data-secondary="anonymous functions" data-type="indexterm" id="idm45963635228232"/><a data-primary="anonymous functions" data-type="indexterm" id="idm45963635227288"/>&#13;
Each filename in <code>files</code> is passed as the <code>name</code> argument used in the match.&#13;
The <code>filter()</code> function will only return elements that return a truthy value from the given function, so those filenames that return <code>None</code> when they fail to match are excluded:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; pprint(list(filter(lambda name: re.match(r'solution.*\.py', name), files)))&#13;
['solution3_recursion_memoize_decorator.py',&#13;
 'solution2_generator_for_loop.py',&#13;
 'solution2_generator_islice.py',&#13;
 'solution3_recursion_memoize.py',&#13;
 'solution2_generator.py',&#13;
 'solution1_list.py',&#13;
 'solution3_recursion_lru_cache.py',&#13;
 'solution3_recursion.py']</pre>&#13;
&#13;
<p>You see that the <code>re.match()</code> function takes two arguments—a pattern and a string to match.&#13;
The <code>partial()</code> function allows me to <em>partially apply</em> the function, and the result is a new function.<a data-primary="partial() to partially apply functions" data-type="indexterm" id="idm45963635221624"/><a data-primary="functions" data-secondary="partial() to partially apply functions" data-type="indexterm" id="idm45963635220936"/>&#13;
For example, the <code>operator.add()</code> function expects two values and returns their sum:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; import operator&#13;
&gt;&gt;&gt; operator.add(1, 2)&#13;
3</pre>&#13;
&#13;
<p>I can create a function that adds <code>1</code> to any value, like so:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; from functools import partial&#13;
&gt;&gt;&gt; succ = partial(op.add, 1)</pre>&#13;
&#13;
<p>The <code>succ()</code> function requires one argument, and will return the successor:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; succ(3)&#13;
4&#13;
&gt;&gt;&gt; succ(succ(3))&#13;
5</pre>&#13;
&#13;
<p>Likewise, I can create a function <code>f()</code> that partially applies the <code>re.match()</code> function with its first argument, a regular expression pattern:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; f = partial(re.match, r'solution.*\.py')</pre>&#13;
&#13;
<p>The <code>f()</code> function is waiting for a string to apply the match:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; type(f('solution1.py'))&#13;
&lt;class 're.Match'&gt;&#13;
&gt;&gt;&gt; type(f('fib.py'))&#13;
&lt;class 'NoneType'&gt;</pre>&#13;
&#13;
<p>If you call it without an argument, you will get an exception:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; f()&#13;
Traceback (most recent call last):&#13;
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;&#13;
TypeError: match() missing 1 required positional argument: 'string'</pre>&#13;
&#13;
<p>I can replace the <code>lambda</code> with the partially applied function as the first argument to <code>filter()</code>:</p>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; pprint(list(filter(f, files)))&#13;
['solution3_recursion_memoize_decorator.py',&#13;
 'solution2_generator_for_loop.py',&#13;
 'solution2_generator_islice.py',&#13;
 'solution3_recursion_memoize.py',&#13;
 'solution2_generator.py',&#13;
 'solution1_list.py',&#13;
 'solution3_recursion_lru_cache.py',&#13;
 'solution3_recursion.py']</pre>&#13;
&#13;
<p>My programming style leans heavily on purely functional programming ideas.&#13;
I find this style to be like playing with LEGO bricks—small, well-defined, and tested functions can be composed into larger programs that work well.<a data-startref="ch04-auto" data-type="indexterm" id="idm45963635206936"/><a data-startref="ch04-auto2" data-type="indexterm" id="idm45963635206264"/><a data-startref="ch04-auto3" data-type="indexterm" id="idm45963635205592"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Going Further" data-type="sect1"><div class="sect1" id="idm45963635204600">&#13;
<h1>Going Further</h1>&#13;
&#13;
<p>There are many different styles of programming, such as procedural, functional, object-oriented, and so forth.&#13;
Even within an object-oriented language like Python, I can use very different approaches to writing code.&#13;
The first solution could be considered a <em>dynamic programming</em> approach because you try to solve the larger problem by first solving smaller problems.&#13;
If you find recursive functions interesting, the Tower of Hanoi problem is another classic exercise.&#13;
Purely functional languages like Haskell mostly avoid constructs like <code>for</code> loops and rely heavily on recursion and higher-order functions.<a data-primary="Haskell language" data-type="indexterm" id="idm45963635201880"/>&#13;
Both spoken and programming languages shape the way we think, and I encourage you to try solving this problem using other languages you know to see how you might write different solutions.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="idm45963635200552">&#13;
<h1>Review</h1>&#13;
&#13;
<p>Key points from this chapter:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Inside the <code>get_args()</code> function, you can perform manual validation of arguments and use the <code>parser.error()</code> function to manually generate <code>argparse</code> errors.</p>&#13;
</li>&#13;
<li>&#13;
<p>You can use a list as a stack by pushing and popping elements.</p>&#13;
</li>&#13;
<li>&#13;
<p>Using <code>yield</code> in a function turns it into a generator. When the function yields a value, the value is returned and the state of the function is preserved until the next value is requested. Generators can be used to create a potentially infinite stream of values.</p>&#13;
</li>&#13;
<li>&#13;
<p>A recursive function calls itself, and the recursion can cause serious performance issues. One solution is to use memoization to cache values and avoid recomputation.</p>&#13;
</li>&#13;
<li>&#13;
<p>Higher-order functions are functions that take other functions as arguments.</p>&#13;
</li>&#13;
<li>&#13;
<p>Python’s function decorators apply HOFs to other functions.</p>&#13;
</li>&#13;
<li>&#13;
<p>Benchmarking is an important technique for determining the best-performing algorithm. The <code>hyperfine</code> and <code>bench</code> tools allow you to compare  runtimes of commands over many iterations.</p>&#13;
</li>&#13;
<li>&#13;
<p>The <code>random</code> module offers many functions for the pseudorandom selection of values.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45963635588216"><sup><a href="ch04.html#idm45963635588216-marker">1</a></sup> As the legendary David St. Hubbins and Nigel Tufnel observed, “It’s such a fine line between stupid and clever.”<a data-primary="St. Hubbins, David" data-type="indexterm" id="idm45963635587560"/></p></div></div></section></body></html>