<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Appendix A. D3’s enter/exit Pattern" data-type="appendix" epub:type="appendix"><div class="appendix" id="appendix">
<h1><span class="label">Appendix A. </span>D3’s enter/exit Pattern</h1>
<p>As shown in <a data-type="xref" href="ch17.xhtml#d3bar_update">“Updating the DOM with Data”</a>, D3 now has a more user-friendly <code>join</code> method to replace the old implementation of data-joining using patterns based around the <code>enter</code>, <code>exit</code>, and <code>remove</code> methods. <a data-primary="D3 library" data-secondary="enter/exit pattern" data-type="indexterm" id="ix_D3entex"/>The <code>join</code> method is a great addition to D3, but there are thousands of examples online using the old data-joining patterns. In order to use/convert these it helps to know a little bit more about what’s going on under the hood when D3 joins data.</p>
<p>In order to demonstrate D3’s data joining, let’s look under the hood when D3 joins data. Let’s start with our bar-less chart, with SVG canvas and chart group in place:</p>
<pre data-code-language="html" data-type="programlisting">...
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-bar"</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">svg</code> <code class="na">width</code><code class="o">=</code><code class="s">"600"</code> <code class="na">height</code><code class="o">=</code><code class="s">"400"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">g</code> <code class="na">class</code><code class="o">=</code><code class="s">"chart"</code> <code class="na">transform</code><code class="o">=</code><code class="s">"translate(40, 20)"</code><code class="p">&gt;&lt;/</code><code class="nt">g</code><code class="p">&gt;</code>
      <code class="p">&lt;/</code><code class="nt">svg</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
...</pre>
<p>In order to join data with D3, we first need some data in the right form. Generally that will be an array of objects, like our bar chart’s <code>nobelData</code>:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">nobelData</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'United States'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">336</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'United Kingdom'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">98</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Germany'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">79</code><code class="p">},</code>
    <code class="p">...</code>
<code class="p">]</code></pre>
<p>A D3 data-join is made in two stages. First, we add the data to be joined using the <code>data</code> method then we perform the join using the <code>join</code> method.</p>
<p>To add our Nobel data to a group of bars, we do the following. First, we select a container for our bars, in this case our SVG group of class <code>chart</code>.</p>
<p>Then we define the container, in this case a CSS selector of class <code>bar</code>:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-bar .chart'</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">bars</code> <code class="o">=</code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'.bar'</code><code class="p">)</code>
              <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nobelData</code><code class="p">);</code></pre>
<p>We now come to a slightly counterintuitive aspect of D3’s <code>data</code> method. Our first <code>select</code> returned the <code>chart</code> group in our <code>nobel-bar</code> SVG canvas, but the second <code>selectAll</code> returned all elements with class <code>bars</code>, of which there are none. If there are no bars, what exactly are we binding the data to? The answer is that behind the scenes, D3 is keeping the books and that the <code>bars</code> object returned by <code>data</code> knows which DOM elements have been bound to the <code>nobelData</code> and, just as crucially, which haven’t.  We’ll now see how to make use of this fact using the fundamental <code>enter</code> method.</p>
<section data-pdf-bookmark="The enter Method" data-type="sect1"><div class="sect1" id="idm45607734488624">
<h1>The enter Method</h1>
<p>D3’s <a href="https://oreil.ly/veBF9"><code>enter</code> method</a> (and its sibling, <code>exit</code>) is both the basis for D3’s superb power and expressiveness and also the root of much confusion. <a data-primary="D3 library" data-secondary="enter/exit pattern" data-tertiary="enter method" data-type="indexterm" id="ix_D3entexent"/><a data-primary="enter method (D3)" data-type="indexterm" id="ix_enter"/>Although, as mentioned, the newish <code>join</code> method simplifies things, it’s worth coming to grips with <code>enter</code> if you really want your D3 skills to grow. Let’s introduce it now, with a very simple and slow demonstration.</p>
<p>We’ll start with a canonically simple little demonstration, adding a bar rectangle for each member of our Nobel Prize data. We’ll use the first six Nobel Prize–winning countries as our bound data:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">nobelData</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'United States'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">200</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'United Kingdom'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">80</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'France'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">47</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Switzerland'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">23</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Japan'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">21</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">key</code><code class="o">:</code><code class="s1">'Austria'</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code><code class="mi">12</code><code class="p">}</code>
<code class="p">];</code></pre>
<p>With our dataset in hand, let’s first use D3 to grab the chart group, saving it to an <code>svg</code> variable. We’ll use that to make a selection of all elements of class <code>bar</code> (none at the moment):</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-bar .chart'</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">bars</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'.bar'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nobelData</code><code class="p">);</code></pre>
<p>Now although the <code>bars</code> selection is empty, behind the scenes D3 has kept a record of the data we’ve just bound to it. At this point, we can use that fact and the <code>enter</code> method to create a few bars with our data. Calling <code>enter</code> on our <code>bars</code> selection returns a subselection of all the data (<code>nobelData</code>, in this case) that was not bound to a bar. Since there were no bars in the original selection (our chart being empty), all the data is unbound, so <code>enter</code> returns an enter election (essentially placeholder nodes for all the unbound data) of size six:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">bars</code> <code class="o">=</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">enter</code><code class="p">();</code> <code class="err">#</code> <code class="nx">returns</code> <code class="nx">six</code> <code class="nx">placeholder</code> <code class="nx">nodes</code></pre>
<p>We can use the placeholder nodes in <code>bars</code> to create some DOM elements—in our case, a few bars. We won’t bother with trying to put them the right way up (the y-axis being down from the top of the screen by convention), but we will use the data values and indices to set the position and height of the bars:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">bars</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'rect'</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s1">'bar'</code><code class="p">,</code><code> </code><code class="kc">true</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'width'</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'height'</code><code class="p">,</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code class="p">{</code><code class="k">return</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_d3__8217_s_enter_exit_pattern_CO1-1" id="co_d3__8217_s_enter_exit_pattern_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'x'</code><code class="p">,</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code> </code><code class="nx">i</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><code class="k">return</code><code> </code><code class="nx">i</code><code> </code><code class="o">*</code><code> </code><code class="mi">12</code><code class="p">;</code><code> </code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_d3__8217_s_enter_exit_pattern_CO1-1" id="callout_d3__8217_s_enter_exit_pattern_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>If you provide a callback function to D3’s setter methods (<code>attr</code>, <code>style</code>, etc.), then the first and second arguments provided are the value of the individual data object (e.g., <code>d == {key: 'United States', value: 200}</code>) and its index (<code>i</code>).</p></dd>
</dl>
<p>Using the callback functions to set height and the x position (allowing a padding of 2 px) of the bars and calling <code>append</code> on our six node<a data-primary="append method (D3)" data-type="indexterm" id="idm45607734221024"/> selection produces <a data-type="xref" href="#d3bar_enter_full">Figure A-1</a>.</p>
<figure><div class="figure" id="d3bar_enter_full">
<img alt="dpj2 aa01" height="292" src="assets/dpj2_aa01.png" width="427"/>
<h6><span class="label">Figure A-1. </span>Producing some bars with D3’s <code>enter</code> method</h6>
</div></figure>
<p>I’d encourage you generally to use Chrome’s (or equivalent) Elements tab to investigate the HTML your D3 is producing. Investigating our mini–bar chart with Elements shows <a data-type="xref" href="#d3bar_enter_elements">Figure A-2</a>.</p>
<figure><div class="figure" id="d3bar_enter_elements">
<img alt="dpj2 aa02" height="291" src="assets/dpj2_aa02.png" width="433"/>
<h6><span class="label">Figure A-2. </span>Using the Elements tab to see the HTML generated by <code>enter</code> and <code>append</code></h6>
</div></figure>
<p>So we’ve seen what happens when we call <code>enter</code> on an empty selection. But what happens when we already have a few bars, which we would have in an interactive chart with a user-driven, changing dataset?</p>
<p>Let’s add a couple of <code>bar</code> class rectangles to our starting HTML:</p>
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-bar"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">svg</code> <code class="na">width</code><code class="o">=</code><code class="s">"600"</code> <code class="na">height</code><code class="o">=</code><code class="s">"400"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">g</code> <code class="na">class</code><code class="o">=</code><code class="s">"chart"</code> <code class="na">transform</code><code class="o">=</code><code class="s">"translate(40, 20)"</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">rect</code> <code class="na">class</code><code class="o">=</code><code class="s">'bar'</code><code class="p">&gt;&lt;/</code><code class="nt">rect</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">rect</code> <code class="na">class</code><code class="o">=</code><code class="s">'bar'</code><code class="p">&gt;&lt;/</code><code class="nt">rect</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">g</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">svg</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code></pre>
<p>If we now perform the same data binding and entering as before, on calling <code>data</code> on our selection, the two placeholder rectangles bind to the first two members of our <code>nobelData</code> array (i.e., <code>[{key: 'United States', value: 200}, {key: 'United Kingdom', value:80}]</code>). This means that <code>enter</code>, which returns only unbound data placeholders, now returns only four placeholders, associated with the last four elements of the <code>nobelData</code> array:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-bar .chart'</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">bars</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s1">'.bar'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nobelData</code><code class="p">);</code>

<code class="nx">bars</code> <code class="o">=</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">enter</code><code class="p">();</code> <code class="err">#</code> <code class="k">return</code> <code class="nx">four</code> <code class="nx">placeholder</code> <code class="nx">nodes</code></pre>
<p>If we now call <code>append</code> on the entered <code>bars</code>, as before, we get the result shown in <a data-type="xref" href="#d3bar_enter_part">Figure A-3</a>, showing the last four bars (note that they preserve their index <code>i</code>, used to set their x positions) rendered.</p>
<figure><div class="figure" id="d3bar_enter_part">
<img alt="dpj2 aa03" height="128" src="assets/dpj2_aa03.png" width="418"/>
<h6><span class="label">Figure A-3. </span>Calling <code>enter</code> and <code>append</code> with existing bars</h6>
</div></figure>
<p><a data-type="xref" href="#d3bar_enter_elements_part">Figure A-4</a> shows the HTML generated for the last four bars. As we’ll see, the data from the first two elements is now bound to the two dummy nodes we added to the initial bar group.<a data-primary="append method (D3)" data-secondary="calling on existing bars" data-type="indexterm" id="idm45607734019952"/> We just haven’t used it yet to adjust those rectangles’ attributes. Updating old bars with new data is the one of the key elements  of the update pattern we’ll see shortly.</p>
<figure><div class="figure" id="d3bar_enter_elements_part">
<img alt="dpj2 aa04" height="283" src="assets/dpj2_aa04.png" width="498"/>
<h6><span class="label">Figure A-4. </span>Using the Elements tab to see the HTML generated by <code>enter</code> and <code>append</code> on a partial selection</h6>
</div></figure>
<p>To emphasize, coming to grips with <code>enter</code> and <code>exit</code> (and <code>remove</code>) is vital to healthy progress with D3. Play around a bit, inspect the HTML you’re producing, enter a bit of data, and generally get a bit messy, learning the ins and outs. <a data-primary="enter method (D3)" data-startref="ix_enter" data-type="indexterm" id="idm45607734014160"/><a data-primary="D3 library" data-secondary="enter/exit pattern" data-startref="ix_D3entexent" data-tertiary="enter method" data-type="indexterm" id="idm45607734013184"/><a data-primary="D3 library" data-secondary="enter/exit pattern" data-startref="ix_D3entex" data-type="indexterm" id="idm45607734011696"/>Let’s have a little look at accessing the bound data before moving on to the D3’s nexus, the update <span class="keep-together">pattern</span>.</p>
</div></section>
<section data-pdf-bookmark="Accessing the Bound Data" data-type="sect1"><div class="sect1" id="idm45607734467072">
<h1>Accessing the Bound Data</h1>
<p>A good way to see what’s happening to the DOM is to use your browser’s HTML inspector and console to track D3’s changes.<a data-primary="data binding in D3" data-secondary="accessing bound data" data-type="indexterm" id="idm45607734008592"/><a data-primary="D3 library" data-secondary="binding/joining data to DOM elements in D3" data-type="indexterm" id="idm45607734007264"/> In <a data-type="xref" href="#d3bar_enter_full">Figure A-1</a>, we use Chrome’s console to look at the <code>rect</code> element representing the first bar in <a data-type="xref" href="#d3bar_enter_part">Figure A-3</a>, before data has been bound and after the <code>nobelData</code> has been bound to the bars using the <code>data</code> method. As you can see, D3 has added a <code>__data__</code> object to the <code>rect</code> element with which to store its bound data—in this case, the first member of our <code>nobelData</code> list. The <code>__data__</code> object is used by D3’s internal bookkeeping and, fundamentally, the data in it is made available to functions supplied to update methods such as <code>attr</code>.</p>
<p>Let’s look at a little example of using the data in an element’s <code>__data__</code> object to set its <code>name</code> attribute.  The <code>name</code> attribute can be useful for making specific D3 selections. For example, if the user selects a particular country, we can now use D3 to get all its named components and adjust their style if needed.  We’ll use the bar with bound data in <a data-type="xref" href="#d3bar_console_db">Figure A-5</a> and set the name using the <code>key</code> property of its bound data:</p>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">bar</code><code> </code><code class="o">=</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s1">'#nobel-bar .bar'</code><code class="p">)</code><code class="p">;</code><code>

</code><code class="nx">bar</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code> </code><code class="nx">i</code><code class="p">)</code><code class="p">{</code><code> </code><a class="co" href="#callout_d3__8217_s_enter_exit_pattern_CO2-1" id="co_d3__8217_s_enter_exit_pattern_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>

    </code><code class="kd">let</code><code> </code><code class="nx">sane_key</code><code> </code><code class="o">=</code><code> </code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/ /g</code><code class="p">,</code><code> </code><code class="s1">'_'</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_d3__8217_s_enter_exit_pattern_CO2-2" id="co_d3__8217_s_enter_exit_pattern_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>

    </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'__data__ is: '</code><code> </code><code class="o">+</code><code> </code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code><code>
    </code><code class="o">+</code><code> </code><code class="s1">', index is '</code><code> </code><code class="o">+</code><code> </code><code class="nx">i</code><code class="p">)</code><code>

    </code><code class="k">return</code><code> </code><code class="s1">'bar__'</code><code> </code><code class="o">+</code><code> </code><code class="nx">sane_key</code><code class="p">;</code><code> </code><a class="co" href="#callout_d3__8217_s_enter_exit_pattern_CO2-3" id="co_d3__8217_s_enter_exit_pattern_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
    </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="c1">// console out:
</code><code class="c1">// __data__ is: {"key":"United States","value":336}, index is 0</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_d3__8217_s_enter_exit_pattern_CO2-1" id="callout_d3__8217_s_enter_exit_pattern_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>All D3 setter methods can take a function as their second argument. This function receives the data (<code>d</code>) bound to the selected element and its position in the data array (<code>i</code>).</p></dd>
<dt><a class="co" href="#co_d3__8217_s_enter_exit_pattern_CO2-2" id="callout_d3__8217_s_enter_exit_pattern_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>We use a regular expression (regex) to replace all spaces in the key with underscores (e.g., United States → United_States).</p></dd>
<dt><a class="co" href="#co_d3__8217_s_enter_exit_pattern_CO2-3" id="callout_d3__8217_s_enter_exit_pattern_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>This will set the bar’s <code>name</code> attribute to <code>'bar__United_States'</code>.</p></dd>
</dl>
<p>All the setter methods listed in <a data-type="xref" href="ch17.xhtml#d3bar_selects">Figure 17-3</a> (<code>attr</code>, <code>style</code>, <code>text</code>, etc.) can take a function as a second argument, which will receive data bound to the element and the element’s array index. The return of this function is used to set the value of the property. As we’ll see, interactive visualizations’ changes to the visualized dataset will be reflected when we bind the new data and then use these functional setters to adapt attributes, styles, and properties accordingly.</p>
<figure><div class="figure" id="d3bar_console_db">
<img alt="dpj2 aa05" height="744" src="assets/dpj2_aa05.png" width="1440"/>
<h6><span class="label">Figure A-5. </span>Using the Chrome console to show the addition of a <code>__data__</code> object after data binding using D3’s <code>data</code> method</h6>
</div></figure>
</div></section>
</div></section></div></body></html>