- en: 'Chapter 5\. Case Study: Why Is My Bus Always Late?'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Jake VanderPlas’s blog, [Pythonic Perambulations](http://jakevdp.github.io),
    offers a great example of what it’s like to be a modern data scientist. As data
    scientists, we see data in our work, daily routines, and personal lives, and we
    tend to be curious about what insights these data might bring to our understanding
    of the world. In this first case study, we borrow from one of the posts on Pythonic
    Perambulations, [“The Waiting Time Paradox, or, Why Is My Bus Always Late?”](https://oreil.ly/W8Ih5),
    to model waiting for a bus on a street corner in Seattle. We touch on each stage
    of the data lifecycle, but in this first case study, our focus is on the process
    of thinking about the question, data, and model, rather than on data structures
    and modeling techniques. A constant model and simulation study get us a long way
    toward understanding the issues.
  prefs: []
  type: TYPE_NORMAL
- en: VanderPlas’s post was inspired by his experience waiting for the bus. The wait
    always seemed longer than expected. This experience did not match the reasoning
    that if a bus comes every 10 minutes and you arrive at the stop at a random time,
    then, on average, the wait should be about 5 minutes. Armed with data provided
    by the Washington State Transportation Center, the author was able to investigate
    this phenomenon. We do the same.
  prefs: []
  type: TYPE_NORMAL
- en: We apply concepts introduced in earlier chapters, beginning with the general
    question, Why is my bus always late?, and refining this question to one that is
    closer to our goal and that we can investigate with data. We then consider the
    data scope, such as how these data were collected and potential sources of biases,
    and we prepare the data for analysis. Our understanding of the data scope helps
    us design a model for waiting at a bus stop, which we simulate to study this phenomenon.
  prefs: []
  type: TYPE_NORMAL
- en: Question and Scope
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Our original question comes from the experience of a regular bus rider wondering
    why their bus is always late. We are not looking for actual reasons for its lateness,
    like a traffic jam or maintenance delay. Instead, we want to study patterns in
    the actual arrival times of buses at a stop, compared to their scheduled times.
    This information will help us better understand what it’s like to wait for the
    bus.
  prefs: []
  type: TYPE_NORMAL
- en: Bus lines differ across the world and even across a city, so we narrow our investigation
    to one bus stop in the city of Seattle. The data we have are for the stops of
    Seattle’s Rapid Ride lines C, D, and E at 3rd Avenue and Pike Street. The Washington
    State Transportation Center has provided times for all of the actual and scheduled
    stop times of these three bus lines between March 26 and May 27, 2016.
  prefs: []
  type: TYPE_NORMAL
- en: Considering our narrowed scope to buses at one particular stop over a two-month
    period and our access to all of the administrative data collected in this window
    of time, the population, access frame, and sample are one and the same. Yet, we
    can imagine that our analysis might prove useful for other locations in and beyond
    Seattle and for other times of the year. If we are lucky, the ideas that we uncover,
    or the approach that we take, can be useful to others. For now, we keep a narrowed
    focus.
  prefs: []
  type: TYPE_NORMAL
- en: Let’s take a look at these data to better understand their structure.
  prefs: []
  type: TYPE_NORMAL
- en: Data Wrangling
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Before we start our analysis, we check the quality of the data, simplify the
    structure where possible, and derive new measurements that might help us in our
    analysis. We cover these types of operations in [Chapter 9](ch09.html#ch-wrangling),
    so don’t worry about the details of the code for now. Instead, focus on the differences
    between the data tables as we clean the data. We start by loading the data into
    Python.
  prefs: []
  type: TYPE_NORMAL
- en: 'The first few rows in the data table are shown here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: '|   | OPD_DATE | VEHICLE_ID | RTE | DIR | ... | STOP_ID | STOP_NAME | SCH_STOP_TM
    | ACT_STOP_TM |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **0** | 2016-03-26 | 6201 | 673 | S | ... | 431 | 3RD AVE & PIKE ST (431)
    | 01:11:57 | 01:13:19 |'
  prefs: []
  type: TYPE_TB
- en: '| **1** | 2016-03-26 | 6201 | 673 | S | ... | 431 | 3RD AVE & PIKE ST (431)
    | 23:19:57 | 23:16:13 |'
  prefs: []
  type: TYPE_TB
- en: '| **2** | 2016-03-26 | 6201 | 673 | S | ... | 431 | 3RD AVE & PIKE ST (431)
    | 21:19:57 | 21:18:46 |'
  prefs: []
  type: TYPE_TB
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: (The raw data are available as comma-separated values in a file, which we have
    loaded into this table; see [Chapter 8](ch08.html#ch-files) for details on this
    process.)
  prefs: []
  type: TYPE_NORMAL
- en: 'It looks like some of the columns in the table might be redundant, like the
    columns labeled `STOP_ID` and `STOP_NAME`. We can find the number of unique values
    and their counts to confirm this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'There are two `3RD AVE & PIKE ST` names for the stop. We wonder whether they
    are related to the direction of the bus, which we can check against the possible
    combinations of direction, stop ID, and stop name:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: Indeed, the northern direction corresponds to stop ID 578 and the southern direction
    corresponds to stop ID 431\. Since we are looking at only one stop in our analysis,
    we don’t really need anything more than the direction.
  prefs: []
  type: TYPE_NORMAL
- en: 'We can also check the number of unique route names:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'These routes are numbered and don’t match the names C, D, and E from the original
    description of the problem. This issue involves another aspect of data wrangling:
    we need to dig up information that connects the route letters and numbers. We
    can get this info from the Seattle transit site. Yet another part of wrangling
    is to translate data values into ones that are easier to understand, so we replace
    the route numbers with their letters:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: We can also create new columns in the table that help us in our investigations.
    For example, we can use the scheduled and actual arrival times to calculate how
    late a bus is. Doing this requires some work with date and time formats, which
    is covered in [Chapter 9](ch09.html#ch-wrangling).
  prefs: []
  type: TYPE_NORMAL
- en: 'Let’s examine the values of this new quantity to make sure that our calculations
    are correct:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'It’s a bit surprising that there are negative values for how late a bus is,
    but this just means the bus arrived earlier than scheduled. While the median lateness
    is only about half a minute, some of the buses are 2.5 hours late! Let’s take
    a look at the histogram of how many minutes late the buses are:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: '![](assets/leds_05in01.png)'
  prefs: []
  type: TYPE_IMG
- en: We saw a similarly shaped histogram in [Chapter 4](ch04.html#ch-modeling). The
    distribution of how late the buses are is highly skewed to the right, but many
    arrive close to on time.
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, we conclude our wrangling by creating a simplified version of the
    data table. Since we only need to keep track of the route, direction, scheduled
    and actual arrival time, and how late the bus is, we create a smaller table and
    give the columns names that are a bit easier to read:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: '|   | route | direction | scheduled | actual | minutes_late |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- | --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **0** | C | southbound | 2016-03-26 01:11:57 | 2016-03-26 01:13:19 | 1.37
    |'
  prefs: []
  type: TYPE_TB
- en: '| **1** | C | southbound | 2016-03-26 23:19:57 | 2016-03-26 23:16:13 | -3.73
    |'
  prefs: []
  type: TYPE_TB
- en: '| **2** | C | southbound | 2016-03-26 21:19:57 | 2016-03-26 21:18:46 | -1.18
    |'
  prefs: []
  type: TYPE_TB
- en: '| **3** | C | southbound | 2016-03-26 19:04:57 | 2016-03-26 19:01:49 | -3.13
    |'
  prefs: []
  type: TYPE_TB
- en: '| **4** | C | southbound | 2016-03-26 16:42:57 | 2016-03-26 16:42:39 | -0.30
    |'
  prefs: []
  type: TYPE_TB
- en: These table manipulations are covered in [Chapter 6](ch06.html#ch-pandas).
  prefs: []
  type: TYPE_NORMAL
- en: Before we begin to model bus lateness, we want to explore and learn more about
    these data. We do that next.
  prefs: []
  type: TYPE_NORMAL
- en: Exploring Bus Times
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We learned a lot about the data as we cleaned and simplified it, but before
    we begin to model wait time, we want to dig deeper to better understand the phenomenon
    of bus lateness. We narrowed our focus to the bus activity at one stop (3rd Avenue
    and Pike Street) over a two-month period. And we saw that the distribution of
    the lateness of a bus is skewed to the right, with some buses being very late
    indeed. In this exploratory phase, we might ask:'
  prefs: []
  type: TYPE_NORMAL
- en: Does the distribution of lateness look the same for all three bus lines?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Does it matter whether the bus is traveling north or south?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How does the time of day relate to how late the bus is?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Are the buses scheduled to arrive at regular intervals throughout the day?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Answering these questions helps us better determine how to model.
  prefs: []
  type: TYPE_NORMAL
- en: 'Recall from [Chapter 4](ch04.html#ch-modeling) that we found the median time
    a bus was late was 3/4 of a minute. But this doesn’t match the median we calculated
    for all bus routes and directions (1/2 a minute). Let’s check whether that could
    be due to the focus on northbound line C buses in that chapter. Let’s create histograms
    of lateness for each of the six combinations of bus line and direction to address
    this question and the first two questions on our list:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](assets/leds_05in02.png)'
  prefs: []
  type: TYPE_IMG
- en: The scale on the y-axis is proportion (or density). This scale makes it easier
    to compare the histograms since we are not misled by different counts in the groups.
    The range on the x-axis is the same across the six plots, making it easier to
    detect the different center and spread of the distributions. (These notions are
    described in [Chapter 11](ch11.html#ch-viz).)
  prefs: []
  type: TYPE_NORMAL
- en: The northbound and southbound distributions are different for each line. When
    we dig deeper into the context, we learn that line C originates in the north and
    the other two lines originate in the south. The histograms imply there is greater
    variability in arrival times in the second half of the bus routes, which makes
    sense to us since delays get compounded as the day progresses.
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, to explore lateness by time of day, we need to derive a new quantity:
    the hour of the day that the bus is scheduled to arrive. Given the variation in
    route and direction that we just saw in bus lateness, we again create separate
    plots for each route and direction:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](assets/leds_05in03.png)'
  prefs: []
  type: TYPE_IMG
- en: Indeed, there does appear to be a rush-hour effect, and it seems worse for the
    evening rush hour compared to the morning. The northbound C line looks to be the
    most impacted.
  prefs: []
  type: TYPE_NORMAL
- en: 'Lastly, to examine the scheduled frequency of the buses, we need to compute
    the intervals between scheduled bus times. We create a new column in our table
    that contains the time between the scheduled arrival times for the northbound
    C buses:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: '|   | route | direction | scheduled | actual | minutes_late | sched_inter |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- | --- | --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **19512** | C | northbound | 2016-03-26 00:00:25 | 2016-03-26 00:05:01 |
    4.60 | NaN |'
  prefs: []
  type: TYPE_TB
- en: '| **19471** | C | northbound | 2016-03-26 00:30:25 | 2016-03-26 00:30:19 |
    -0.10 | 30.0 |'
  prefs: []
  type: TYPE_TB
- en: '| **19487** | C | northbound | 2016-03-26 01:05:25 | 2016-03-26 01:10:15 |
    4.83 | 35.0 |'
  prefs: []
  type: TYPE_TB
- en: 'Let’s examine a histogram of the distribution of inter-arrival times of these
    buses:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: '![](assets/leds_05in04.png)'
  prefs: []
  type: TYPE_IMG
- en: We see that the buses are scheduled to arrive at different intervals throughout
    the day. In this two-month period, about 1,500 of the buses are scheduled to arrive
    12 minutes apart and about 1,400 are supposed to arrive 15 minutes after the previous
    bus.
  prefs: []
  type: TYPE_NORMAL
- en: We have learned a lot in our exploration of the data and are in a better position
    to fit a model. Most notably, if we want to get a clear picture of the experience
    of waiting for a bus, we need to take into account the scheduled interval between
    buses, as well as the bus line and direction.
  prefs: []
  type: TYPE_NORMAL
- en: Modeling Wait Times
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We are interested in modeling the experience of someone waiting at a bus stop.
    We could develop a complex model that involves the intervals between scheduled
    arrivals, the bus line, and direction. Instead, we take a simpler approach and
    narrow the focus to one line, one direction, and one scheduled interval. We examine
    the northbound C line stops that are scheduled to arrive 12 minutes apart:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: Both the complex and the narrow approaches are legitimate, but we do not yet
    have the tools to approach the complex model (see [Chapter 15](ch15.html#ch-linear)
    for more details on modeling).
  prefs: []
  type: TYPE_NORMAL
- en: 'So far, we have examined the distribution of the number of minutes the bus
    is late. We create another histogram of this delay for the subset of data that
    we are analyzing (northbound C line stops that are scheduled to arrive 12 minutes
    after the previous bus):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: '![](assets/leds_05in05.png)'
  prefs: []
  type: TYPE_IMG
- en: 'And let’s calculate the minimum, maximum, and median lateness:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: Interestingly, the northbound buses on the C line that are 12 minutes apart
    are more often early than not!
  prefs: []
  type: TYPE_NORMAL
- en: Now let’s revisit our question to confirm that we are on track for answering
    it. A summary of how late the buses are does not quite address the experience
    of the person waiting for the bus. When someone arrives at a bus stop, they need
    to wait for the next bus to arrive. [Figure 5-1](#busdiagram) shows an idealization
    of time passing as passengers and buses arrive at the bus stop. If people are
    arriving at the bus stop at random times, notice that they are more likely to
    arrive in a time interval where the bus is delayed because there’s a longer interval
    between buses. This arrival pattern is an example of size-biased sampling. So
    to answer the question of what people experience when waiting for a bus, we need
    to do more than summarize how late the bus is.
  prefs: []
  type: TYPE_NORMAL
- en: '![](assets/leds_0501.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 5-1\. Idealized timeline with buses arriving (rectangles), passengers
    arriving (circles), and time the rider waits for the next bus to arrive (curly
    brackets)
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'We can design a simulation that mimics waiting for a bus over the course of
    one day, using the ideas from [Chapter 3](ch03.html#ch-theory-datadesign). To
    do this, we set up a string of scheduled bus arrivals that are 12 minutes apart
    from 6 a.m. to midnight:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, for each scheduled arrival, we simulate its actual arrival time by adding
    a random number of minutes each bus is late. To do this, we choose the minutes
    late from the distribution of observed lateness of the actual buses. Notice how
    we have incorporated the real data in our simulation study by using the distribution
    of actual delays of the buses that are 12 minutes apart:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'We need to sort these arrival times because when a bus is super late, another
    may well come along before it:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'We also need to simulate the arrival of people at the bus stop at random times
    throughout the day. We can use another, different urn model for the passenger
    arrivals. For the passengers, we put a marble in the urn with a time on it. These
    run from time 0, which stands for 6 a.m., to the arrival of the last bus at midnight,
    which is 1,068 minutes past 6 a.m. To match the way the bus times are measured
    in our data, we make the times 1/100th of a minute apart:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: 'Now we can simulate the arrival of, say, five hundred people at the bus stop
    throughout the day. We draw five hundred times from this urn, replacing the marbles
    between draws:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: 'To find out how long each individual waits, we look for the soonest bus to
    arrive after their sampled time. The difference between these two times (the sampled
    time of the person and the soonest bus arrival after that) is how long the person
    waits:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: 'We can set up a complete simulation where we simulate, say, two hundred days
    of bus arrivals, and for each day, we simulate five hundred people arriving at
    the bus stop at random times throughout the day. In total, that’s 100,000 simulated
    wait times:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: 'Let’s make a histogram of these simulated wait times to examine the distribution:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: '![](assets/leds_05in06.png)'
  prefs: []
  type: TYPE_IMG
- en: 'As we expect, we find a skewed distribution. We can model this with a constant
    where we use absolute loss to select the best constant. We saw in [Chapter 4](ch04.html#ch-modeling)
    that absolute loss gives us the median wait time:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: 'The median of about six and a half minutes doesn’t seem too long. While our
    model captures the typical wait time, we also want to provide an estimate of the
    variability in the process. This topic is covered in [Chapter 17](ch17.html#ch-inf-pred-theory).
    We can compute the upper quartile of wait times to give us a sense of variability:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: The upper quartile is quite large. It’s undoubtedly memorable when you have
    to wait more than 10 minutes for a bus that is supposed to arrive every 12 minutes,
    and this happens one in four times you take the bus!
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In our first case study, we have traversed the full lifecycle of data modeling.
    It might strike you that such a simple question is not immediately answerable
    with the data collected. We needed to combine the data of scheduled and actual
    arrival times of buses with a simulation study of riders arriving at the bus stop
    at random times to uncover the riders’ waiting experience.
  prefs: []
  type: TYPE_NORMAL
- en: This simulation simplified many of the real patterns in bus riding. We focused
    on one bus line traveling in one direction with buses arriving at 12-minute intervals.
    Further, the exploration of the data revealed that the patterns in lateness correlated
    with the time of day, which we have not accounted for in our analysis. Nonetheless,
    our findings can still be useful. For example, they confirm that the typical wait
    time is longer than half the scheduled interval. And the distribution of wait
    times has a long right tail, meaning a rider’s experience may well be impacted
    by the variability in the process.
  prefs: []
  type: TYPE_NORMAL
- en: We also saw how deriving new quantities, such as how late a bus is and the time
    between buses, and exploring the data can be useful in modeling. Our histograms
    showed that the particular line and direction of the bus matter and they need
    to be accounted for. We also discovered that the schedules change throughout the
    day, with many buses arriving 10, 12, and 15 minutes after another, and some arriving
    more frequently or more separated. This observation further informed the modeling
    stage.
  prefs: []
  type: TYPE_NORMAL
- en: Finally, we used data tools, such as the `pandas` and `plotly` libraries, that
    will be covered in later chapters. Our focus here was not on how to manipulate
    tables or how to create a plot. Instead, we focused on the lifecycle, connecting
    questions to data to modeling to conclusions. In the next chapter, we turn to
    the practicalities of working with data tables.
  prefs: []
  type: TYPE_NORMAL
