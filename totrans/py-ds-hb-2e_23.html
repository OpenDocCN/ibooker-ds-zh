<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 20. Aggregation and Grouping" data-type="chapter" epub:type="chapter"><div class="chapter" id="section-0308-aggregation-and-grouping">
<h1><span class="label">Chapter 20. </span>Aggregation and Grouping</h1>
<p><a data-primary="aggregation (Pandas)" data-type="indexterm" id="ix_ch20-asciidoc0"/><a data-primary="Pandas" data-secondary="aggregation and grouping" data-type="indexterm" id="ix_ch20-asciidoc1"/>A fundamental piece of many data analysis tasks is efficient
summarization: computing aggregations like <code>sum</code>, <code>mean</code>, <code>median</code>,
<code>min</code>, and <code>max</code>, in which a single number summarizes aspects of a
potentially large dataset. In this chapter, we’ll explore
aggregations in Pandas, from simple operations akin to what
we’ve seen on NumPy arrays to more sophisticated operations
based on the concept of a <code>groupby</code>.</p>
<p>For convenience, we’ll use the same <code>display</code> magic function
that we used in the previous chapters:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">numpy</code> <code class="k">as</code> <code class="nn">np</code>
        <code class="kn">import</code> <code class="nn">pandas</code> <code class="k">as</code> <code class="nn">pd</code>

        <code class="k">class</code> <code class="nc">display</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
            <code class="sd">"""Display HTML representation of multiple objects"""</code>
            <code class="n">template</code> <code class="o">=</code> <code class="s2">"""&lt;div style="float: left; padding: 10px;"&gt;</code>
<code class="s2">            &lt;p style='font-family:"Courier New", Courier, monospace'&gt;</code><code class="si">{0}{1}</code><code class="s2"/>
<code class="s2">            """</code>
            <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="o">*</code><code class="n">args</code><code class="p">):</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">args</code> <code class="o">=</code> <code class="n">args</code>

            <code class="k">def</code> <code class="nf">_repr_html_</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
                <code class="k">return</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">template</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">a</code><code class="p">,</code> <code class="nb">eval</code><code class="p">(</code><code class="n">a</code><code class="p">)</code><code class="o">.</code><code class="n">_repr_html_</code><code class="p">())</code>
                                 <code class="k">for</code> <code class="n">a</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">args</code><code class="p">)</code>

            <code class="k">def</code> <code class="fm">__repr__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
                <code class="k">return</code> <code class="s1">'</code><code class="se">\n\n</code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">a</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code> <code class="nb">repr</code><code class="p">(</code><code class="nb">eval</code><code class="p">(</code><code class="n">a</code><code class="p">))</code>
                                   <code class="k">for</code> <code class="n">a</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">args</code><code class="p">)</code></pre>
<section class="pagebreak-before less_space" data-pdf-bookmark="Planets Data" data-type="sect1"><div class="sect1" id="ch_0308-aggregation-and-grouping_planets-data">
<h1>Planets Data</h1>
<p><a data-primary="aggregation (Pandas)" data-secondary="Planets dataset for" data-type="indexterm" id="idm45858775845024"/><a data-primary="Planets dataset" data-secondary="aggregation and grouping" data-type="indexterm" id="idm45858775843888"/>Here we will use the Planets dataset, available via the
<a href="http://seaborn.pydata.org">Seaborn package</a> (see
<a data-type="xref" href="ch36.xhtml#section-0414-visualization-with-seaborn">Chapter 36</a>). It gives information on planets that astronomers have
discovered around other stars (known as <em>extrasolar planets</em>, or
<em>exoplanets</em> for short). It can be downloaded with a simple Seaborn
command:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">seaborn</code> <code class="k">as</code> <code class="nn">sns</code>
        <code class="n">planets</code> <code class="o">=</code> <code class="n">sns</code><code class="o">.</code><code class="n">load_dataset</code><code class="p">(</code><code class="s1">'planets'</code><code class="p">)</code>
        <code class="n">planets</code><code class="o">.</code><code class="n">shape</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="p">(</code><code class="mi">1035</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code></pre>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="n">planets</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">3</code><code class="p">]:</code>             <code class="n">method</code>  <code class="n">number</code>  <code class="n">orbital_period</code>   <code class="n">mass</code>  <code class="n">distance</code>  <code class="n">year</code>
        <code class="mi">0</code>  <code class="n">Radial</code> <code class="n">Velocity</code>       <code class="mi">1</code>         <code class="mf">269.300</code>   <code class="mf">7.10</code>     <code class="mf">77.40</code>  <code class="mi">2006</code>
        <code class="mi">1</code>  <code class="n">Radial</code> <code class="n">Velocity</code>       <code class="mi">1</code>         <code class="mf">874.774</code>   <code class="mf">2.21</code>     <code class="mf">56.95</code>  <code class="mi">2008</code>
        <code class="mi">2</code>  <code class="n">Radial</code> <code class="n">Velocity</code>       <code class="mi">1</code>         <code class="mf">763.000</code>   <code class="mf">2.60</code>     <code class="mf">19.84</code>  <code class="mi">2011</code>
        <code class="mi">3</code>  <code class="n">Radial</code> <code class="n">Velocity</code>       <code class="mi">1</code>         <code class="mf">326.030</code>  <code class="mf">19.40</code>    <code class="mf">110.62</code>  <code class="mi">2007</code>
        <code class="mi">4</code>  <code class="n">Radial</code> <code class="n">Velocity</code>       <code class="mi">1</code>         <code class="mf">516.220</code>  <code class="mf">10.50</code>    <code class="mf">119.47</code>  <code class="mi">2009</code></pre>
<p>This has some details on the more than one thousand extrasolar planets discovered up to
2014.</p>
</div></section>
<section data-pdf-bookmark="Simple Aggregation in Pandas" data-type="sect1"><div class="sect1" id="ch_0308-aggregation-and-grouping_simple-aggregation-in-pandas">
<h1>Simple Aggregation in Pandas</h1>
<p><a data-primary="aggregation (Pandas)" data-secondary="simple aggregation" data-type="indexterm" id="ix_ch20-asciidoc2"/>In <a data-type="xref" href="ch07.xhtml#section-0204-computation-on-arrays-aggregates">Chapter 7</a>, we explored some of the data
aggregations available for NumPy arrays. As with a one-dimensional NumPy
array, for a Pandas <code>Series</code> the aggregates return a single value:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="n">rng</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">RandomState</code><code class="p">(</code><code class="mi">42</code><code class="p">)</code>
        <code class="n">ser</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">Series</code><code class="p">(</code><code class="n">rng</code><code class="o">.</code><code class="n">rand</code><code class="p">(</code><code class="mi">5</code><code class="p">))</code>
        <code class="n">ser</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="mi">0</code>    <code class="mf">0.374540</code>
        <code class="mi">1</code>    <code class="mf">0.950714</code>
        <code class="mi">2</code>    <code class="mf">0.731994</code>
        <code class="mi">3</code>    <code class="mf">0.598658</code>
        <code class="mi">4</code>    <code class="mf">0.156019</code>
        <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code></pre>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">5</code><code class="p">]:</code> <code class="n">ser</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">5</code><code class="p">]:</code> <code class="mf">2.811925491708157</code></pre>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">6</code><code class="p">]:</code> <code class="n">ser</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">6</code><code class="p">]:</code> <code class="mf">0.5623850983416314</code></pre>
<p class="pagebreak-before less_space">For a <code>DataFrame</code>, by default the aggregates return results within each
column:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">7</code><code class="p">]:</code> <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'A'</code><code class="p">:</code> <code class="n">rng</code><code class="o">.</code><code class="n">rand</code><code class="p">(</code><code class="mi">5</code><code class="p">),</code>
                           <code class="s1">'B'</code><code class="p">:</code> <code class="n">rng</code><code class="o">.</code><code class="n">rand</code><code class="p">(</code><code class="mi">5</code><code class="p">)})</code>
        <code class="n">df</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">7</code><code class="p">]:</code>           <code class="n">A</code>         <code class="n">B</code>
        <code class="mi">0</code>  <code class="mf">0.155995</code>  <code class="mf">0.020584</code>
        <code class="mi">1</code>  <code class="mf">0.058084</code>  <code class="mf">0.969910</code>
        <code class="mi">2</code>  <code class="mf">0.866176</code>  <code class="mf">0.832443</code>
        <code class="mi">3</code>  <code class="mf">0.601115</code>  <code class="mf">0.212339</code>
        <code class="mi">4</code>  <code class="mf">0.708073</code>  <code class="mf">0.181825</code></pre>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">8</code><code class="p">]:</code> <code class="n">df</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">8</code><code class="p">]:</code> <code class="n">A</code>    <code class="mf">0.477888</code>
        <code class="n">B</code>    <code class="mf">0.443420</code>
        <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code></pre>
<p>By specifying the <code>axis</code> argument, you can instead aggregate within each
row:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="n">df</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="s1">'columns'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="mi">0</code>    <code class="mf">0.088290</code>
        <code class="mi">1</code>    <code class="mf">0.513997</code>
        <code class="mi">2</code>    <code class="mf">0.849309</code>
        <code class="mi">3</code>    <code class="mf">0.406727</code>
        <code class="mi">4</code>    <code class="mf">0.444949</code>
        <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code></pre>
<p>Pandas <code>Series</code> and <code>DataFrame</code> objects include all of the common
aggregates mentioned in
<a data-type="xref" href="ch07.xhtml#section-0204-computation-on-arrays-aggregates">Chapter 7</a>; in addition, there is a convenience
method, <code>describe</code>, that computes several common aggregates for each
column and returns the result. Let’s use this on the Planets
data, for now dropping rows with missing values:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">10</code><code class="p">]:</code> <code class="n">planets</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code><code class="o">.</code><code class="n">describe</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">10</code><code class="p">]:</code>           <code class="n">number</code>  <code class="n">orbital_period</code>        <code class="n">mass</code>    <code class="n">distance</code>         <code class="n">year</code>
         <code class="n">count</code>  <code class="mf">498.00000</code>      <code class="mf">498.000000</code>  <code class="mf">498.000000</code>  <code class="mf">498.000000</code>   <code class="mf">498.000000</code>
         <code class="n">mean</code>     <code class="mf">1.73494</code>      <code class="mf">835.778671</code>    <code class="mf">2.509320</code>   <code class="mf">52.068213</code>  <code class="mf">2007.377510</code>
         <code class="n">std</code>      <code class="mf">1.17572</code>     <code class="mf">1469.128259</code>    <code class="mf">3.636274</code>   <code class="mf">46.596041</code>     <code class="mf">4.167284</code>
         <code class="nb">min</code>      <code class="mf">1.00000</code>        <code class="mf">1.328300</code>    <code class="mf">0.003600</code>    <code class="mf">1.350000</code>  <code class="mf">1989.000000</code>
         <code class="mi">25</code><code class="o">%</code>      <code class="mf">1.00000</code>       <code class="mf">38.272250</code>    <code class="mf">0.212500</code>   <code class="mf">24.497500</code>  <code class="mf">2005.000000</code>
         <code class="mi">50</code><code class="o">%</code>      <code class="mf">1.00000</code>      <code class="mf">357.000000</code>    <code class="mf">1.245000</code>   <code class="mf">39.940000</code>  <code class="mf">2009.000000</code>
         <code class="mi">75</code><code class="o">%</code>      <code class="mf">2.00000</code>      <code class="mf">999.600000</code>    <code class="mf">2.867500</code>   <code class="mf">59.332500</code>  <code class="mf">2011.000000</code>
         <code class="nb">max</code>      <code class="mf">6.00000</code>    <code class="mf">17337.500000</code>   <code class="mf">25.000000</code>  <code class="mf">354.000000</code>  <code class="mf">2014.000000</code></pre>
<p>This method helps us understand the overall properties of a dataset. For
example, we see in the <code>year</code> column that although exoplanets were
discovered as far back as 1989, half of all planets in the dataset were
not discovered until 2010 or after. This is largely thanks to the
<em>Kepler</em> mission, which aimed to find eclipsing planets around other
stars using a specially designed space telescope.</p>
<p><a data-type="xref" href="#table-20-1">Table 20-1</a> summarizes some other built-in Pandas aggregations.</p>
<table class="pagebreak-before less_space" id="table-20-1">
<caption><span class="label">Table 20-1. </span>Listing of Pandas aggregation methods</caption>
<thead>
<tr>
<th>Aggregation</th>
<th>Returns</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>count</code></p></td>
<td><p>Total number of items</p></td>
</tr>
<tr>
<td><p><code>first</code>, <code>last</code></p></td>
<td><p>First and last item</p></td>
</tr>
<tr>
<td><p><code>mean</code>, <code>median</code></p></td>
<td><p>Mean and median</p></td>
</tr>
<tr>
<td><p><code>min</code>, <code>max</code></p></td>
<td><p>Minimum and maximum</p></td>
</tr>
<tr>
<td><p><code>std</code>, <code>var</code></p></td>
<td><p>Standard deviation and variance</p></td>
</tr>
<tr>
<td><p><code>mad</code></p></td>
<td><p>Mean absolute deviation</p></td>
</tr>
<tr>
<td><p><code>prod</code></p></td>
<td><p>Product of all items</p></td>
</tr>
<tr>
<td><p><code>sum</code></p></td>
<td><p>Sum of all items</p></td>
</tr>
</tbody>
</table>
<p>These are all methods of <code>DataFrame</code> and <code>Series</code> objects.</p>
<p>To go deeper into the data, however, simple aggregates are often not
enough. The next level of data summarization is the <code>groupby</code> operation,
which allows you to quickly and efficiently compute aggregates on
subsets of data.</p>
</div></section>
<section data-pdf-bookmark="groupby: Split, Apply, Combine" data-type="sect1"><div class="sect1" id="ch_0308-aggregation-and-grouping_groupby-split-apply-combine">
<h1>groupby: Split, Apply, Combine</h1>
<p><a data-primary="aggregation (Pandas)" data-secondary="groupby() operation" data-type="indexterm" id="ix_ch20-asciidoc3"/><a data-primary="groupby() operation (Pandas)" data-type="indexterm" id="ix_ch20-asciidoc4"/>Simple aggregations can give you a flavor of your dataset, but often we
would prefer to aggregate conditionally on some label or index: this is
implemented in the so-called <code>groupby</code> operation. The name “group by”
comes from a command in the SQL database language, but it is perhaps
more illuminative to think of it in the terms first coined by <a data-primary="Wickham, Hadley" data-type="indexterm" id="idm45858775110992"/>Hadley
Wickham of Rstats fame: <em>split, apply, combine</em>.</p>
<section data-pdf-bookmark="Split, Apply, Combine" data-type="sect2"><div class="sect2" id="ch_0308-aggregation-and-grouping_split-apply-combine">
<h2>Split, Apply, Combine</h2>
<p><a data-primary="groupby() operation (Pandas)" data-secondary="split-apply-combine example" data-type="indexterm" id="ix_ch20-asciidoc5"/>A canonical example of this split-apply-combine operation, where the
“apply” is a summation aggregation, is illustrated <a data-type="xref" href="#fig_images_in_0308-split-apply-combine">Figure 20-1</a>.</p>
<p><a data-type="xref" href="#fig_images_in_0308-split-apply-combine">Figure 20-1</a> shows what the <code>groupby</code> operation accomplishes:</p>
<ul>
<li>
<p>The <em>split</em> step involves breaking up and grouping a <code>DataFrame</code>
depending on the value of the specified key.</p>
</li>
<li>
<p>The <em>apply</em> step involves computing some function, usually an
aggregate, transformation, or filtering, within the individual groups.</p>
</li>
<li>
<p>The <em>combine</em> step merges the results of these operations into an
output array.</p>
</li>
</ul>
<figure><div class="figure" id="fig_images_in_0308-split-apply-combine">
<img alt="03.08 split apply combine" height="469" src="assets/03.08-split-apply-combine.png" width="600"/>
<h6><span class="label">Figure 20-1. </span>A visual representation of a groupby operation<sup><a data-type="noteref" href="ch20.xhtml#idm45858775097184" id="idm45858775097184-marker">1</a></sup></h6>
</div></figure>
<p>While this could certainly be done manually using some combination of
the masking, aggregation, and merging commands covered earlier, an
important realization is that <em>the intermediate splits do not need to be
explicitly instantiated</em>. Rather, the <code>groupby</code> can (often) do this in a
single pass over the data, updating the sum, mean, count, min, or other
aggregate for each group along the way. The power of the <code>groupby</code> is
that it abstracts away these steps: the user need not think about <em>how</em>
the computation is done under the hood, but rather can think about the
<em>operation as a whole</em>.</p>
<p>As a concrete example, let’s take a look at using Pandas for
the computation shown in the following table. We’ll start
by creating the input <code>DataFrame</code>:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">11</code><code class="p">]:</code> <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'key'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'A'</code><code class="p">,</code> <code class="s1">'B'</code><code class="p">,</code> <code class="s1">'C'</code><code class="p">,</code> <code class="s1">'A'</code><code class="p">,</code> <code class="s1">'B'</code><code class="p">,</code> <code class="s1">'C'</code><code class="p">],</code>
                            <code class="s1">'data'</code><code class="p">:</code> <code class="nb">range</code><code class="p">(</code><code class="mi">6</code><code class="p">)},</code> <code class="n">columns</code><code class="o">=</code><code class="p">[</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'data'</code><code class="p">])</code>
         <code class="n">df</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">11</code><code class="p">]:</code>  <code class="n">key</code>  <code class="n">data</code>
         <code class="mi">0</code>   <code class="n">A</code>     <code class="mi">0</code>
         <code class="mi">1</code>   <code class="n">B</code>     <code class="mi">1</code>
         <code class="mi">2</code>   <code class="n">C</code>     <code class="mi">2</code>
         <code class="mi">3</code>   <code class="n">A</code>     <code class="mi">3</code>
         <code class="mi">4</code>   <code class="n">B</code>     <code class="mi">4</code>
         <code class="mi">5</code>   <code class="n">C</code>     <code class="mi">5</code></pre>
<p>The most basic split-apply-combine operation can be computed with the
<code>groupby</code> method of the <code>DataFrame</code>, passing the name of the desired key
column:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">12</code><code class="p">]:</code> <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'key'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">12</code><code class="p">]:</code> <code class="o">&lt;</code><code class="n">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">groupby</code><code class="o">.</code><code class="n">generic</code><code class="o">.</code><code class="n">DataFrameGroupBy</code> <code class="nb">object</code> <code class="n">at</code> <code class="mh">0x11d241e20</code><code class="o">&gt;</code></pre>
<p>Notice that what is returned is a <code>DataFrameGroupBy</code> object, not a set
of <code>DataFrame</code> objects. This object is where the magic is: you can think
of it as a special view of the <code>DataFrame</code>, which is poised to dig into
the groups but does no actual computation until the aggregation is
applied. This “lazy evaluation” approach means that common aggregates
can be implemented efficiently in a way that is almost transparent to
the user.</p>
<p>To produce a result, we can apply an aggregate to this
<code>DataFrameGroupBy</code> object, which will perform the appropriate
apply/combine steps to produce the desired result:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">13</code><code class="p">]:</code> <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'key'</code><code class="p">)</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">13</code><code class="p">]:</code>      <code class="n">data</code>
         <code class="n">key</code>
         <code class="n">A</code>       <code class="mi">3</code>
         <code class="n">B</code>       <code class="mi">5</code>
         <code class="n">C</code>       <code class="mi">7</code></pre>
<p>The <code>sum</code> method is just one possibility here; you can apply most Pandas
or NumPy aggregation functions, as well as most <code>DataFrame</code> operations,
as you will see in the following discussion.<a data-startref="ix_ch20-asciidoc5" data-type="indexterm" id="idm45858774901472"/></p>
</div></section>
<section data-pdf-bookmark="The GroupBy Object" data-type="sect2"><div class="sect2" id="ch_0308-aggregation-and-grouping_the-groupby-object">
<h2>The GroupBy Object</h2>
<p><a data-primary="GroupBy object" data-type="indexterm" id="ix_ch20-asciidoc6"/><a data-primary="groupby() operation (Pandas)" data-secondary="GroupBy object and" data-type="indexterm" id="ix_ch20-asciidoc7"/>The <code>GroupBy</code> object is a flexible abstraction: in many ways, it can be
treated as simply a collection of <code>DataFrame</code>s, though it is doing more
sophisticated things under the hood. Let’s see some examples
using the Planets data.</p>
<p>Perhaps the most important operations made available by a <code>GroupBy</code> are
<em>aggregate</em>, <em>filter</em>, <em>transform</em>, and <em>apply</em>. We’ll
discuss each of these more fully in the next section, but before that
let’s take a look at some of the other functionality that
can be used with the basic <code>GroupBy</code> operation.</p>
<section data-pdf-bookmark="Column indexing" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_column-indexing">
<h3>Column indexing</h3>
<p><a data-primary="column(s)" data-secondary="indexing" data-type="indexterm" id="idm45858774869248"/><a data-primary="GroupBy object" data-secondary="column indexing" data-type="indexterm" id="idm45858774868272"/>The <code>GroupBy</code> object supports column indexing in the same way as the
<code>DataFrame</code>, and returns a modified <code>GroupBy</code> object. For example:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">14</code><code class="p">]:</code> <code class="n">planets</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'method'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">14</code><code class="p">]:</code> <code class="o">&lt;</code><code class="n">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">groupby</code><code class="o">.</code><code class="n">generic</code><code class="o">.</code><code class="n">DataFrameGroupBy</code> <code class="nb">object</code> <code class="n">at</code> <code class="mh">0x11d1bc820</code><code class="o">&gt;</code></pre>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">15</code><code class="p">]:</code> <code class="n">planets</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'method'</code><code class="p">)[</code><code class="s1">'orbital_period'</code><code class="p">]</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">15</code><code class="p">]:</code> <code class="o">&lt;</code><code class="n">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">groupby</code><code class="o">.</code><code class="n">generic</code><code class="o">.</code><code class="n">SeriesGroupBy</code> <code class="nb">object</code> <code class="n">at</code> <code class="mh">0x11d1bcd60</code><code class="o">&gt;</code></pre>
<p>Here we’ve selected a particular <code>Series</code> group from the
original <code>DataFrame</code> group by reference to its column name. As with the
<code>GroupBy</code> object, no computation is done until we call some aggregate on
the object:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">16</code><code class="p">]:</code> <code class="n">planets</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'method'</code><code class="p">)[</code><code class="s1">'orbital_period'</code><code class="p">]</code><code class="o">.</code><code class="n">median</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">16</code><code class="p">]:</code> <code class="n">method</code>
         <code class="n">Astrometry</code>                         <code class="mf">631.180000</code>
         <code class="n">Eclipse</code> <code class="n">Timing</code> <code class="n">Variations</code>         <code class="mf">4343.500000</code>
         <code class="n">Imaging</code>                          <code class="mf">27500.000000</code>
         <code class="n">Microlensing</code>                      <code class="mf">3300.000000</code>
         <code class="n">Orbital</code> <code class="n">Brightness</code> <code class="n">Modulation</code>        <code class="mf">0.342887</code>
         <code class="n">Pulsar</code> <code class="n">Timing</code>                       <code class="mf">66.541900</code>
         <code class="n">Pulsation</code> <code class="n">Timing</code> <code class="n">Variations</code>       <code class="mf">1170.000000</code>
         <code class="n">Radial</code> <code class="n">Velocity</code>                    <code class="mf">360.200000</code>
         <code class="n">Transit</code>                              <code class="mf">5.714932</code>
         <code class="n">Transit</code> <code class="n">Timing</code> <code class="n">Variations</code>           <code class="mf">57.011000</code>
         <code class="n">Name</code><code class="p">:</code> <code class="n">orbital_period</code><code class="p">,</code> <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code></pre>
<p>This gives an idea of the general scale of orbital periods (in days)
that each method is sensitive to.</p>
</div></section>
<section data-pdf-bookmark="Iteration over groups" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_iteration-over-groups">
<h3>Iteration over groups</h3>
<p><a data-primary="GroupBy object" data-secondary="iteration over groups" data-type="indexterm" id="idm45858774656272"/>The <code>GroupBy</code> object supports direct iteration over the groups,
returning each group as a <code>Series</code> or <code>DataFrame</code>:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">17</code><code class="p">]:</code> <code class="k">for</code> <code class="p">(</code><code class="n">method</code><code class="p">,</code> <code class="n">group</code><code class="p">)</code> <code class="ow">in</code> <code class="n">planets</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'method'</code><code class="p">):</code>
             <code class="nb">print</code><code class="p">(</code><code class="s2">"</code><code class="si">{0:30s}</code><code class="s2"> shape=</code><code class="si">{1}</code><code class="s2">"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">method</code><code class="p">,</code> <code class="n">group</code><code class="o">.</code><code class="n">shape</code><code class="p">))</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">17</code><code class="p">]:</code> <code class="n">Astrometry</code>                     <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
         <code class="n">Eclipse</code> <code class="n">Timing</code> <code class="n">Variations</code>      <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">9</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
         <code class="n">Imaging</code>                        <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">38</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
         <code class="n">Microlensing</code>                   <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">23</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
         <code class="n">Orbital</code> <code class="n">Brightness</code> <code class="n">Modulation</code>  <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
         <code class="n">Pulsar</code> <code class="n">Timing</code>                  <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
         <code class="n">Pulsation</code> <code class="n">Timing</code> <code class="n">Variations</code>    <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
         <code class="n">Radial</code> <code class="n">Velocity</code>                <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">553</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
         <code class="n">Transit</code>                        <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">397</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
         <code class="n">Transit</code> <code class="n">Timing</code> <code class="n">Variations</code>      <code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code></pre>
<p>This can be useful for manual inspection of groups for the sake of
debugging, but it is often much faster to use the built-in <code>apply</code>
functionality, which we will discuss momentarily.</p>
</div></section>
<section data-pdf-bookmark="Dispatch methods" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_dispatch-methods">
<h3>Dispatch methods</h3>
<p><a data-primary="GroupBy object" data-secondary="dispatch methods" data-type="indexterm" id="idm45858774582592"/>Through some Python class magic, any method not explicitly implemented
by the <code>GroupBy</code> object will be passed through and called on the groups,
whether they are <code>DataFrame</code> or <code>Series</code> objects. <a data-primary="describe() method" data-type="indexterm" id="idm45858774491312"/>For example, using the
<code>describe</code> method is equivalent to calling <code>describe</code> on the <code>DataFrame</code>
representing each group:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">18</code><code class="p">]:</code> <code class="n">planets</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'method'</code><code class="p">)[</code><code class="s1">'year'</code><code class="p">]</code><code class="o">.</code><code class="n">describe</code><code class="p">()</code><code class="o">.</code><code class="n">unstack</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">18</code><code class="p">]:</code>        <code class="n">method</code>
         <code class="n">count</code>  <code class="n">Astrometry</code>                          <code class="mf">2.0</code>
                <code class="n">Eclipse</code> <code class="n">Timing</code> <code class="n">Variations</code>           <code class="mf">9.0</code>
                <code class="n">Imaging</code>                            <code class="mf">38.0</code>
                <code class="n">Microlensing</code>                       <code class="mf">23.0</code>
                <code class="n">Orbital</code> <code class="n">Brightness</code> <code class="n">Modulation</code>       <code class="mf">3.0</code>
                                                  <code class="o">...</code>
         <code class="nb">max</code>    <code class="n">Pulsar</code> <code class="n">Timing</code>                    <code class="mf">2011.0</code>
                <code class="n">Pulsation</code> <code class="n">Timing</code> <code class="n">Variations</code>      <code class="mf">2007.0</code>
                <code class="n">Radial</code> <code class="n">Velocity</code>                  <code class="mf">2014.0</code>
                <code class="n">Transit</code>                          <code class="mf">2014.0</code>
                <code class="n">Transit</code> <code class="n">Timing</code> <code class="n">Variations</code>        <code class="mf">2014.0</code>
         <code class="n">Length</code><code class="p">:</code> <code class="mi">80</code><code class="p">,</code> <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code></pre>
<p>Looking at this table helps us to better understand the data: for
example, the vast majority of planets until 2014 were discovered by the
Radial Velocity and Transit methods, though the latter method became
common more recently. The newest methods seem to be Transit Timing
Variation and Orbital Brightness Modulation, which were not used to
discover a new planet until 2011.</p>
<p>Notice that these dispatch methods are applied <em>to each individual
group</em>, and the results are then combined within <code>GroupBy</code> and returned.
Again, any valid <code>DataFrame</code>/<code>Series</code> method can be called in a similar
manner on the corresponding <code>GroupBy</code> object.<a data-startref="ix_ch20-asciidoc7" data-type="indexterm" id="idm45858774359584"/><a data-startref="ix_ch20-asciidoc6" data-type="indexterm" id="idm45858774358848"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Aggregate, Filter, Transform, Apply" data-type="sect2"><div class="sect2" id="ch_0308-aggregation-and-grouping_aggregate-filter-transform-apply">
<h2>Aggregate, Filter, Transform, Apply</h2>
<p>The preceding discussion focused on aggregation for the combine
operation, but there are more options available. In particular,
<code>GroupBy</code> objects have <code>aggregate</code>, <code>filter</code>, <code>transform</code>, and <code>apply</code>
methods that efficiently implement a variety of useful operations before
combining the grouped data.</p>
<p>For the purpose of the following subsections, we’ll use this
<code>DataFrame</code>:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">19</code><code class="p">]:</code> <code class="n">rng</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">RandomState</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
         <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'key'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'A'</code><code class="p">,</code> <code class="s1">'B'</code><code class="p">,</code> <code class="s1">'C'</code><code class="p">,</code> <code class="s1">'A'</code><code class="p">,</code> <code class="s1">'B'</code><code class="p">,</code> <code class="s1">'C'</code><code class="p">],</code>
                            <code class="s1">'data1'</code><code class="p">:</code> <code class="nb">range</code><code class="p">(</code><code class="mi">6</code><code class="p">),</code>
                            <code class="s1">'data2'</code><code class="p">:</code> <code class="n">rng</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">)},</code>
                            <code class="n">columns</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'data1'</code><code class="p">,</code> <code class="s1">'data2'</code><code class="p">])</code>
         <code class="n">df</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">19</code><code class="p">]:</code>   <code class="n">key</code>  <code class="n">data1</code>  <code class="n">data2</code>
         <code class="mi">0</code>   <code class="n">A</code>      <code class="mi">0</code>      <code class="mi">5</code>
         <code class="mi">1</code>   <code class="n">B</code>      <code class="mi">1</code>      <code class="mi">0</code>
         <code class="mi">2</code>   <code class="n">C</code>      <code class="mi">2</code>      <code class="mi">3</code>
         <code class="mi">3</code>   <code class="n">A</code>      <code class="mi">3</code>      <code class="mi">3</code>
         <code class="mi">4</code>   <code class="n">B</code>      <code class="mi">4</code>      <code class="mi">7</code>
         <code class="mi">5</code>   <code class="n">C</code>      <code class="mi">5</code>      <code class="mi">9</code></pre>
<section data-pdf-bookmark="Aggregation" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_aggregation">
<h3>Aggregation</h3>
<p><a data-primary="aggregate() method" data-type="indexterm" id="idm45858774204720"/><a data-primary="GroupBy object" data-secondary="aggregate() method" data-type="indexterm" id="idm45858774203888"/>You’re now familiar with <code>GroupBy</code> aggregations with <code>sum</code>,
<code>median</code>, and the like, but the <code>aggregate</code> method allows for even more
flexibility. It can take a string, a function, or a list thereof, and
compute all the aggregates at once. Here is a quick example combining
all of these:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">20</code><code class="p">]:</code> <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'key'</code><code class="p">)</code><code class="o">.</code><code class="n">aggregate</code><code class="p">([</code><code class="s1">'min'</code><code class="p">,</code> <code class="n">np</code><code class="o">.</code><code class="n">median</code><code class="p">,</code> <code class="nb">max</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">20</code><code class="p">]:</code>     <code class="n">data1</code>            <code class="n">data2</code>
               <code class="nb">min</code> <code class="n">median</code> <code class="nb">max</code>   <code class="nb">min</code> <code class="n">median</code> <code class="nb">max</code>
         <code class="n">key</code>
         <code class="n">A</code>       <code class="mi">0</code>    <code class="mf">1.5</code>   <code class="mi">3</code>     <code class="mi">3</code>    <code class="mf">4.0</code>   <code class="mi">5</code>
         <code class="n">B</code>       <code class="mi">1</code>    <code class="mf">2.5</code>   <code class="mi">4</code>     <code class="mi">0</code>    <code class="mf">3.5</code>   <code class="mi">7</code>
         <code class="n">C</code>       <code class="mi">2</code>    <code class="mf">3.5</code>   <code class="mi">5</code>     <code class="mi">3</code>    <code class="mf">6.0</code>   <code class="mi">9</code></pre>
<p>Another common pattern is to pass a dictionary mapping column names to
operations to be applied on that column:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">21</code><code class="p">]:</code> <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'key'</code><code class="p">)</code><code class="o">.</code><code class="n">aggregate</code><code class="p">({</code><code class="s1">'data1'</code><code class="p">:</code> <code class="s1">'min'</code><code class="p">,</code>
                                      <code class="s1">'data2'</code><code class="p">:</code> <code class="s1">'max'</code><code class="p">})</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">21</code><code class="p">]:</code>      <code class="n">data1</code>  <code class="n">data2</code>
         <code class="n">key</code>
         <code class="n">A</code>        <code class="mi">0</code>      <code class="mi">5</code>
         <code class="n">B</code>        <code class="mi">1</code>      <code class="mi">7</code>
         <code class="n">C</code>        <code class="mi">2</code>      <code class="mi">9</code></pre>
</div></section>
<section data-pdf-bookmark="Filtering" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_filtering">
<h3>Filtering</h3>
<p><a data-primary="filter() method" data-type="indexterm" id="idm45858774071056"/><a data-primary="GroupBy object" data-secondary="filter() method" data-type="indexterm" id="idm45858774070352"/>A filtering operation allows you to drop data based on the group
properties. For example, we might want to keep all groups in which the
standard deviation is larger than some critical value:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="k">def</code> <code class="nf">filter_func</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>
             <code class="k">return</code> <code class="n">x</code><code class="p">[</code><code class="s1">'data2'</code><code class="p">]</code><code class="o">.</code><code class="n">std</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">4</code>

         <code class="n">display</code><code class="p">(</code><code class="s1">'df'</code><code class="p">,</code> <code class="s2">"df.groupby('key').std()"</code><code class="p">,</code>
                 <code class="s2">"df.groupby('key').filter(filter_func)"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="n">df</code>                         <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'key'</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">()</code>
           <code class="n">key</code>  <code class="n">data1</code>  <code class="n">data2</code>           <code class="n">data1</code>     <code class="n">data2</code>
         <code class="mi">0</code>   <code class="n">A</code>      <code class="mi">0</code>      <code class="mi">5</code>        <code class="n">key</code>
         <code class="mi">1</code>   <code class="n">B</code>      <code class="mi">1</code>      <code class="mi">0</code>        <code class="n">A</code>    <code class="mf">2.12132</code>  <code class="mf">1.414214</code>
         <code class="mi">2</code>   <code class="n">C</code>      <code class="mi">2</code>      <code class="mi">3</code>        <code class="n">B</code>    <code class="mf">2.12132</code>  <code class="mf">4.949747</code>
         <code class="mi">3</code>   <code class="n">A</code>      <code class="mi">3</code>      <code class="mi">3</code>        <code class="n">C</code>    <code class="mf">2.12132</code>  <code class="mf">4.242641</code>
         <code class="mi">4</code>   <code class="n">B</code>      <code class="mi">4</code>      <code class="mi">7</code>
         <code class="mi">5</code>   <code class="n">C</code>      <code class="mi">5</code>      <code class="mi">9</code>

         <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'key'</code><code class="p">)</code><code class="o">.</code><code class="n">filter</code><code class="p">(</code><code class="n">filter_func</code><code class="p">)</code>
           <code class="n">key</code>  <code class="n">data1</code>  <code class="n">data2</code>
         <code class="mi">1</code>   <code class="n">B</code>      <code class="mi">1</code>      <code class="mi">0</code>
         <code class="mi">2</code>   <code class="n">C</code>      <code class="mi">2</code>      <code class="mi">3</code>
         <code class="mi">4</code>   <code class="n">B</code>      <code class="mi">4</code>      <code class="mi">7</code>
         <code class="mi">5</code>   <code class="n">C</code>      <code class="mi">5</code>      <code class="mi">9</code></pre>
<p>The filter function should return a Boolean value specifying whether the
group passes the filtering. Here, because group A does not have a
standard deviation greater than 4, it is dropped from the result.</p>
</div></section>
<section data-pdf-bookmark="Transformation" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_transformation">
<h3>Transformation</h3>
<p><a data-primary="GroupBy object" data-secondary="transform() method" data-type="indexterm" id="idm45858774064656"/><a data-primary="transform() method" data-type="indexterm" id="idm45858773868320"/>While aggregation must return a reduced version of the data,
transformation can return some transformed version of the full data to
recombine. For such a transformation, the output is the same shape as
the input. A common example is to center the data by subtracting the
group-wise mean:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">23</code><code class="p">]:</code> <code class="k">def</code> <code class="nf">center</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>
             <code class="k">return</code> <code class="n">x</code> <code class="o">-</code> <code class="n">x</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
         <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'key'</code><code class="p">)</code><code class="o">.</code><code class="n">transform</code><code class="p">(</code><code class="n">center</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">23</code><code class="p">]:</code>    <code class="n">data1</code>  <code class="n">data2</code>
         <code class="mi">0</code>   <code class="o">-</code><code class="mf">1.5</code>    <code class="mf">1.0</code>
         <code class="mi">1</code>   <code class="o">-</code><code class="mf">1.5</code>   <code class="o">-</code><code class="mf">3.5</code>
         <code class="mi">2</code>   <code class="o">-</code><code class="mf">1.5</code>   <code class="o">-</code><code class="mf">3.0</code>
         <code class="mi">3</code>    <code class="mf">1.5</code>   <code class="o">-</code><code class="mf">1.0</code>
         <code class="mi">4</code>    <code class="mf">1.5</code>    <code class="mf">3.5</code>
         <code class="mi">5</code>    <code class="mf">1.5</code>    <code class="mf">3.0</code></pre>
</div></section>
<section data-pdf-bookmark="The apply method" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_the-apply-method">
<h3>The apply method</h3>
<p><a data-primary="apply() method" data-type="indexterm" id="idm45858773815216"/><a data-primary="GroupBy object" data-secondary="apply() method" data-type="indexterm" id="idm45858773814352"/>The <code>apply</code> method lets you apply an arbitrary function to the group
results. The function should take a <code>DataFrame</code> and returns either a
Pandas object (e.g., <code>DataFrame</code>, <code>Series</code>) or a scalar; the behavior of
the combine step will be tailored to the type of output returned.</p>
<p>For example, here is an <code>apply</code> operation that normalizes the first
column by the sum of the second:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">24</code><code class="p">]:</code> <code class="k">def</code> <code class="nf">norm_by_data2</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>
             <code class="c1"># x is a DataFrame of group values</code>
             <code class="n">x</code><code class="p">[</code><code class="s1">'data1'</code><code class="p">]</code> <code class="o">/=</code> <code class="n">x</code><code class="p">[</code><code class="s1">'data2'</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code>
             <code class="k">return</code> <code class="n">x</code>

         <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'key'</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">norm_by_data2</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">24</code><code class="p">]:</code>   <code class="n">key</code>     <code class="n">data1</code>  <code class="n">data2</code>
         <code class="mi">0</code>   <code class="n">A</code>  <code class="mf">0.000000</code>      <code class="mi">5</code>
         <code class="mi">1</code>   <code class="n">B</code>  <code class="mf">0.142857</code>      <code class="mi">0</code>
         <code class="mi">2</code>   <code class="n">C</code>  <code class="mf">0.166667</code>      <code class="mi">3</code>
         <code class="mi">3</code>   <code class="n">A</code>  <code class="mf">0.375000</code>      <code class="mi">3</code>
         <code class="mi">4</code>   <code class="n">B</code>  <code class="mf">0.571429</code>      <code class="mi">7</code>
         <code class="mi">5</code>   <code class="n">C</code>  <code class="mf">0.416667</code>      <code class="mi">9</code></pre>
<p><code>apply</code> within a <code>GroupBy</code> is flexible: the only criterion is that the
function takes a <code>Data⁠Frame</code> and returns a Pandas object or scalar. What
you do in between is up to you!</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Specifying the Split Key" data-type="sect2"><div class="sect2" id="ch_0308-aggregation-and-grouping_specifying-the-split-key">
<h2>Specifying the Split Key</h2>
<p><a data-primary="groupby() operation (Pandas)" data-secondary="split key specification" data-type="indexterm" id="idm45858773684976"/>In the simple examples presented before, we split the <code>DataFrame</code> on a
single column name. This is just one of many options by which the groups
can be defined, and we’ll go through some other options for
group specification here.</p>
<section data-pdf-bookmark="A list, array, series, or index providing the grouping keys" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_a-list-array-series-or-index-providing-the-grouping-keys">
<h3>A list, array, series, or index providing the grouping keys</h3>
<p>The key can be any series or list with a length matching that of the
<code>DataFrame</code>. For example:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">25</code><code class="p">]:</code> <code class="n">L</code> <code class="o">=</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">0</code><code class="p">]</code>
         <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="n">L</code><code class="p">)</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">25</code><code class="p">]:</code>    <code class="n">data1</code>  <code class="n">data2</code>
         <code class="mi">0</code>      <code class="mi">7</code>     <code class="mi">17</code>
         <code class="mi">1</code>      <code class="mi">4</code>      <code class="mi">3</code>
         <code class="mi">2</code>      <code class="mi">4</code>      <code class="mi">7</code></pre>
<p>Of course, this means there’s another, more verbose way of
accomplishing the <code>df.groupby('key')</code> from
before:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">26</code><code class="p">]:</code> <code class="n">df</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="n">df</code><code class="p">[</code><code class="s1">'key'</code><code class="p">])</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">26</code><code class="p">]:</code>      <code class="n">data1</code>  <code class="n">data2</code>
         <code class="n">key</code>
         <code class="n">A</code>        <code class="mi">3</code>      <code class="mi">8</code>
         <code class="n">B</code>        <code class="mi">5</code>      <code class="mi">7</code>
         <code class="n">C</code>        <code class="mi">7</code>     <code class="mi">12</code></pre>
</div></section>
<section data-pdf-bookmark="A dictionary or series mapping index to group" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_a-dictionary-or-series-mapping-index-to-group">
<h3>A dictionary or series mapping index to group</h3>
<p>Another method is to provide a dictionary that maps index values to the
group keys:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">27</code><code class="p">]:</code> <code class="n">df2</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="s1">'key'</code><code class="p">)</code>
         <code class="n">mapping</code> <code class="o">=</code> <code class="p">{</code><code class="s1">'A'</code><code class="p">:</code> <code class="s1">'vowel'</code><code class="p">,</code> <code class="s1">'B'</code><code class="p">:</code> <code class="s1">'consonant'</code><code class="p">,</code> <code class="s1">'C'</code><code class="p">:</code> <code class="s1">'consonant'</code><code class="p">}</code>
         <code class="n">display</code><code class="p">(</code><code class="s1">'df2'</code><code class="p">,</code> <code class="s1">'df2.groupby(mapping).sum()'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">27</code><code class="p">]:</code> <code class="n">df2</code>                    <code class="n">df2</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="n">mapping</code><code class="p">)</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code>
             <code class="n">data1</code>  <code class="n">data2</code>                  <code class="n">data1</code>  <code class="n">data2</code>
         <code class="n">key</code>                    <code class="n">key</code>
         <code class="n">A</code>        <code class="mi">0</code>      <code class="mi">5</code>      <code class="n">consonant</code>     <code class="mi">12</code>     <code class="mi">19</code>
         <code class="n">B</code>        <code class="mi">1</code>      <code class="mi">0</code>      <code class="n">vowel</code>          <code class="mi">3</code>      <code class="mi">8</code>
         <code class="n">C</code>        <code class="mi">2</code>      <code class="mi">3</code>
         <code class="n">A</code>        <code class="mi">3</code>      <code class="mi">3</code>
         <code class="n">B</code>        <code class="mi">4</code>      <code class="mi">7</code>
         <code class="n">C</code>        <code class="mi">5</code>      <code class="mi">9</code></pre>
</div></section>
<section data-pdf-bookmark="Any Python function" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_any-python-function">
<h3>Any Python function</h3>
<p>Similar to mapping, you can pass any Python function that will input the
index value and output the group:</p>
<pre class="less_space pagebreak-before" data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">28</code><code class="p">]:</code> <code class="n">df2</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="nb">str</code><code class="o">.</code><code class="n">lower</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">28</code><code class="p">]:</code>      <code class="n">data1</code>  <code class="n">data2</code>
         <code class="n">key</code>
         <code class="n">a</code>      <code class="mf">1.5</code>    <code class="mf">4.0</code>
         <code class="n">b</code>      <code class="mf">2.5</code>    <code class="mf">3.5</code>
         <code class="n">c</code>      <code class="mf">3.5</code>    <code class="mf">6.0</code></pre>
</div></section>
<section data-pdf-bookmark="A list of valid keys" data-type="sect3"><div class="sect3" id="ch_0308-aggregation-and-grouping_a-list-of-valid-keys">
<h3>A list of valid keys</h3>
<p>Further, any of the preceding key choices can be combined to group on a
multi-index:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">29</code><code class="p">]:</code> <code class="n">df2</code><code class="o">.</code><code class="n">groupby</code><code class="p">([</code><code class="nb">str</code><code class="o">.</code><code class="n">lower</code><code class="p">,</code> <code class="n">mapping</code><code class="p">])</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">29</code><code class="p">]:</code>                <code class="n">data1</code>  <code class="n">data2</code>
         <code class="n">key</code> <code class="n">key</code>
         <code class="n">a</code>   <code class="n">vowel</code>        <code class="mf">1.5</code>    <code class="mf">4.0</code>
         <code class="n">b</code>   <code class="n">consonant</code>    <code class="mf">2.5</code>    <code class="mf">3.5</code>
         <code class="n">c</code>   <code class="n">consonant</code>    <code class="mf">3.5</code>    <code class="mf">6.0</code></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="Grouping Example" data-type="sect2"><div class="sect2" id="ch_0308-aggregation-and-grouping_grouping-example">
<h2>Grouping Example</h2>
<p><a data-primary="groupby() operation (Pandas)" data-secondary="grouping example" data-type="indexterm" id="idm45858773291984"/>As an example of this, in a few lines of Python code we can put all
these together and count discovered planets by method and by decade:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">30</code><code class="p">]:</code> <code class="n">decade</code> <code class="o">=</code> <code class="mi">10</code> <code class="o">*</code> <code class="p">(</code><code class="n">planets</code><code class="p">[</code><code class="s1">'year'</code><code class="p">]</code> <code class="o">//</code> <code class="mi">10</code><code class="p">)</code>
         <code class="n">decade</code> <code class="o">=</code> <code class="n">decade</code><code class="o">.</code><code class="n">astype</code><code class="p">(</code><code class="nb">str</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'s'</code>
         <code class="n">decade</code><code class="o">.</code><code class="n">name</code> <code class="o">=</code> <code class="s1">'decade'</code>
         <code class="n">planets</code><code class="o">.</code><code class="n">groupby</code><code class="p">([</code><code class="s1">'method'</code><code class="p">,</code> <code class="n">decade</code><code class="p">])[</code><code class="s1">'number'</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">unstack</code><code class="p">()</code><code class="o">.</code><code class="n">fillna</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">30</code><code class="p">]:</code> <code class="n">decade</code>                         <code class="mi">1980</code><code class="n">s</code>  <code class="mi">1990</code><code class="n">s</code>  <code class="mi">2000</code><code class="n">s</code>  <code class="mi">2010</code><code class="n">s</code>
         <code class="n">method</code>
         <code class="n">Astrometry</code>                       <code class="mf">0.0</code>    <code class="mf">0.0</code>    <code class="mf">0.0</code>    <code class="mf">2.0</code>
         <code class="n">Eclipse</code> <code class="n">Timing</code> <code class="n">Variations</code>        <code class="mf">0.0</code>    <code class="mf">0.0</code>    <code class="mf">5.0</code>   <code class="mf">10.0</code>
         <code class="n">Imaging</code>                          <code class="mf">0.0</code>    <code class="mf">0.0</code>   <code class="mf">29.0</code>   <code class="mf">21.0</code>
         <code class="n">Microlensing</code>                     <code class="mf">0.0</code>    <code class="mf">0.0</code>   <code class="mf">12.0</code>   <code class="mf">15.0</code>
         <code class="n">Orbital</code> <code class="n">Brightness</code> <code class="n">Modulation</code>    <code class="mf">0.0</code>    <code class="mf">0.0</code>    <code class="mf">0.0</code>    <code class="mf">5.0</code>
         <code class="n">Pulsar</code> <code class="n">Timing</code>                    <code class="mf">0.0</code>    <code class="mf">9.0</code>    <code class="mf">1.0</code>    <code class="mf">1.0</code>
         <code class="n">Pulsation</code> <code class="n">Timing</code> <code class="n">Variations</code>      <code class="mf">0.0</code>    <code class="mf">0.0</code>    <code class="mf">1.0</code>    <code class="mf">0.0</code>
         <code class="n">Radial</code> <code class="n">Velocity</code>                  <code class="mf">1.0</code>   <code class="mf">52.0</code>  <code class="mf">475.0</code>  <code class="mf">424.0</code>
         <code class="n">Transit</code>                          <code class="mf">0.0</code>    <code class="mf">0.0</code>   <code class="mf">64.0</code>  <code class="mf">712.0</code>
         <code class="n">Transit</code> <code class="n">Timing</code> <code class="n">Variations</code>        <code class="mf">0.0</code>    <code class="mf">0.0</code>    <code class="mf">0.0</code>    <code class="mf">9.0</code></pre>
<p>This shows the power of combining many of the operations
we’ve discussed up to this point when looking at realistic
datasets: we quickly gain a coarse understanding of when and how
extrasolar planets were detected in the years after the first discovery.</p>
<p>I would suggest digging into these few lines of code and evaluating the
individual steps to make sure you understand exactly what they are doing
to the result. It’s certainly a somewhat complicated
example, but understanding these pieces will give you the means to
similarly explore your own data<a data-startref="ix_ch20-asciidoc4" data-type="indexterm" id="idm45858773143120"/><a data-startref="ix_ch20-asciidoc3" data-type="indexterm" id="idm45858773142512"/><a data-startref="ix_ch20-asciidoc2" data-type="indexterm" id="idm45858773141872"/>.<a data-startref="ix_ch20-asciidoc1" data-type="indexterm" id="idm45858773068144"/><a data-startref="ix_ch20-asciidoc0" data-type="indexterm" id="idm45858773067440"/></p>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45858775097184"><sup><a href="ch20.xhtml#idm45858775097184-marker">1</a></sup> Code to produce this figure can be found in the <a href="https://oreil.ly/zHqzu">online appendix</a>.</p></div></div></section></div></body></html>