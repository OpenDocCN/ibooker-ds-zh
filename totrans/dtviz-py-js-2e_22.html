<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 16. Building a Visualization" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_building_viz">
<h1><span class="label">Chapter 16. </span>Building a Visualization</h1>
<p>In <a data-type="xref" href="ch15.xhtml#chapter_imagining">Chapter 15</a>, we used the results of our pandas exploration of the Nobel Prize dataset (see <a data-type="xref" href="ch11.xhtml#chapter_pandas_exploring">Chapter 11</a>) to imagine a visualization. <a data-type="xref" href="#d3build_target">Figure 16-1</a> shows the visualization we imagined, and in this chapter we’ll see how to go about building it, leveraging the power of JavaScript and D3.<a data-primary="building a visualization" data-type="indexterm" id="ix_bldvis"/></p>
<figure class="width-75"><div class="figure" id="d3build_target">
<img alt="dpj2 1601" height="845" src="assets/dpj2_1601.png" width="1001"/>
<h6><span class="label">Figure 16-1. </span>Our target, a Nobel Prize visualization</h6>
</div></figure>
<p class="pagebreak-before">I’ll show how the visual elements we conceived combine to transform our freshly cleaned and processed Nobel dataset into an interactive web visualization, deployable to billions of devices at the flick of a switch.  But before going into the details, let’s have a look at the core components of a modern web visualization.</p>
<section data-pdf-bookmark="Preliminaries" data-type="sect1"><div class="sect1" id="idm45607751326544">
<h1>Preliminaries</h1>
<p>Before beginning to build the Nobel visualization, let’s consider the core components that will be used and how we will organize our files.<a data-primary="building a visualization" data-secondary="preliminaries" data-tertiary="core components" data-type="indexterm" id="idm45607751324880"/><a data-primary="core components of web visualizations" data-type="indexterm" id="idm45607751323568"/></p>
<section data-pdf-bookmark="Core Components" data-type="sect2"><div class="sect2" id="idm45607751322752">
<h2>Core Components</h2>
<p>As we saw in <a data-type="xref" href="ch04.xhtml#webdev101_basic_page">“A Basic Page with Placeholders”</a>, building a modern web visualization requires four key components:</p>
<ul>
<li>
<p>An HTML skeleton upon which to hang our JavaScripted <span class="keep-together">creation</span></p>
</li>
<li>
<p>One or more CSS files to govern the look and feel of the dataviz</p>
</li>
<li>
<p>The JavaScript files themselves, including any third-party libraries you might need (D3 being our biggest dependency)</p>
</li>
<li>
<p>And last but not least,  the data to be transformed, ideally in the JSON or CSV (if wholly static data) format</p>
</li>
</ul>
<p>Before we start looking at our dataviz components, let’s get the file structure for our Nobel Prize visualization (Nobel-viz) project in place and establish how we’re going to feed data to our visualization.</p>
</div></section>
<section data-pdf-bookmark="Organizing Your Files" data-type="sect2"><div class="sect2" id="idm45607751314784">
<h2>Organizing Your Files</h2>
<p><a data-type="xref" href="#nviz_files">Example 16-1</a> shows the structure of our project directory.<a data-primary="building a visualization" data-secondary="preliminaries" data-tertiary="organizing your files" data-type="indexterm" id="idm45607751312688"/><a data-primary="projects" data-secondary="project directory for web visualization" data-type="indexterm" id="idm45607751311456"/><a data-primary="files, organizing for Nobel Prize visualization project" data-type="indexterm" id="idm45607751310496"/> By convention we have an <em>index.xhtml</em> file in the root directory with a <em>static</em> directory containing all the libraries and assets (images and data) used for our visualization.</p>
<div data-type="example" id="nviz_files">
<h5><span class="label">Example 16-1. </span>Our Nobel-viz project’s file structure</h5>
<pre data-code-language="bash" data-type="programlisting"><code>nobel_viz</code><code>
</code><code>├──</code><code> </code><code>index.xhtml</code><code>
</code><code>└──</code><code> </code><code>static</code><code>
    </code><code>├──</code><code> </code><code>css</code><code>
    </code><code>│</code><code>   </code><code>└──</code><code> </code><code>style.css</code><code>
    </code><code>├──</code><code> </code><code>data</code><code>          </code><a class="co" href="#callout_building_a_visualization_CO1-1" id="co_building_a_visualization_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code>│</code><code>   </code><code>├──</code><code> </code><code>nobel_winners_biopic.json</code><code>
    </code><code>│</code><code>   </code><code>├──</code><code> </code><code>winning_country_data.json</code><code>
    </code><code>│</code><code>   </code><code>├──</code><code> </code><code>world-110m.json</code><code>
    </code><code>│</code><code>   </code><code>└──</code><code> </code><code>world-country-names-nobel.csv</code><code>
    </code><code>├──</code><code> </code><code>images</code><code>
    </code><code>│</code><code>   </code><code>└──</code><code> </code><code>winners</code><code>  </code><a class="co" href="#callout_building_a_visualization_CO1-2" id="co_building_a_visualization_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code>│</code><code>       </code><code>└──</code><code> </code><code>full</code><code>
    </code><code>│</code><code>           </code><code>├──</code><code> </code><code>002b4f05aa3758e2d6acadde4ed80aa991ed6357.jpg</code><code>
    </code><code>│</code><code>           </code><code>├──</code><code> </code><code>00d7ed381db8b5d18edc84694b7f9ce14ee57c5b.jpg</code><code>
    </code><code>│</code><code>           </code><code>├──</code><code> </code><code>...</code><code>
    </code><code>└──</code><code> </code><code>js</code><code>                  </code><a class="co" href="#callout_building_a_visualization_CO1-3" id="co_building_a_visualization_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
        </code><code>├──</code><code> </code><code>nbviz_bar.mjs</code><code>
        </code><code>├──</code><code> </code><code>nbviz_core.mjs</code><code>
        </code><code>├──</code><code> </code><code>nbviz_details.mjs</code><code>
        </code><code>├──</code><code> </code><code>nbviz_main.mjs</code><code>
        </code><code>├──</code><code> </code><code>nbviz_map.mjs</code><code>
        </code><code>├──</code><code> </code><code>nbviz_menu.mjs</code><code>
        </code><code>└──</code><code> </code><code>nbviz_time.mjs</code><code>
    </code><code>└──</code><code> </code><code>libs</code><code>
        </code><code>├──</code><code> </code><code>crossfilter.min.js</code><code>
        </code><code>├──</code><code> </code><code>d3.min.js</code><code>
        </code><code>└──</code><code> </code><code>topojson.min.js</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO1-1" id="callout_building_a_visualization_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The static data files we’ll be using, including a TopoJSON world map (see <a data-type="xref" href="ch19.xhtml#chapter_d3_maps">Chapter 19</a>)  and the country data we grabbed from the web (see <a data-type="xref" href="ch05.xhtml#country_data">“Getting Country Data for the Nobel Dataviz”</a>).</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO1-2" id="callout_building_a_visualization_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The Nobel Prize winners’ photos we scraped using Scrapy in <a data-type="xref" href="ch06.xhtml#scraping_bio">“Scraping Text and Images with a Pipeline”</a>.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO1-3" id="callout_building_a_visualization_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The <em>js</em> subdirectory contains our Nobel-viz JavaScript module files (<em>.mjs</em>), separated into core elements and starting with <em>nbviz_</em>.</p></dd>
</dl></div>
</div></section>
<section data-pdf-bookmark="Serving the Data" data-type="sect2"><div class="sect2" id="idm45607751190368">
<h2>Serving the Data</h2>
<p>The full Nobel dataset with the mini-biographies that we scraped in <a data-type="xref" href="ch06.xhtml#chapter_heavy_scraping">Chapter 6</a> amounts to around three megabytes of data, considerably less when compressed for web transport.<a data-primary="building a visualization" data-secondary="preliminaries" data-tertiary="serving the data" data-type="indexterm" id="idm45607751188256"/><a data-primary="serving the data" data-type="indexterm" id="idm45607751187072"/> By the standards of modern web pages, that’s not a huge amount of data. In fact, average web page size is somewhere around 2MB to 3MB.<sup><a data-type="noteref" href="ch16.xhtml#idm45607751186112" id="idm45607751186112-marker">1</a></sup> Nevertheless it’s approaching a point where we might consider breaking it into smaller chunks that could be loaded on a need-to-use basis. We could also serve the data dynamically from a web server (see <a data-type="xref" href="ch13.xhtml#chapter_delivery_restful">Chapter 13</a>) with a database like SQLite. As it is, the small inconvenience of an initial wait time is compensated by speedy performance thereafter, as all the data is cached by the browser. It also makes things a lot simpler having just one initial fetching of data.</p>
<p>For our Nobel visualization we’ll serve all the data from a data directory (see <a data-type="xref" href="#nviz_files">Example 16-1</a>, #2), fetched as the app is initialized.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="The HTML Skeleton" data-type="sect1"><div class="sect1" id="html_skeleton">
<h1>The HTML Skeleton</h1>
<p>Although our Nobel visualization has a number of dynamic components, the HTML skeleton required is surprisingly simple.<a data-primary="HTML" data-secondary="skeleton for Nobel Prize web visualization" data-type="indexterm" id="ix_HTMLskel"/><a data-primary="building a visualization" data-secondary="HTML skeleton" data-type="indexterm" id="ix_bldvisHTML"/> This demonstrates a core theme of the book—that you need very little conventional web development to set the stage for programming data visualizations.<a data-primary="index.xhtml file for Nobel Prize single-page visualization" data-type="indexterm" id="ix_indxhtml"/></p>
<p>The <em>index.xhtml</em> file, which creates the visualization on loading, is shown in <a data-type="xref" href="#d3build_index">Example 16-2</a>. The three components are:</p>
<ol>
<li>
<p>A CSS stylesheet <em>style.css</em>, setting fonts, content-block positions, and the like, is imported.<a data-primary="CSS" data-secondary="stylesheet for Nobel Prize web visualization" data-type="indexterm" id="idm45607751172928"/><a data-primary="placeholders" data-secondary="HTML for visual elements in Nobel Prize visualization" data-type="indexterm" id="idm45607751171840"/></p>
</li>
<li>
<p>HTML placeholders for our visual elements with IDs of the form <code>nobel-[foo]</code>.</p>
</li>
<li>
<p>The JavaScript; first third-party libraries, then our original scripts.</p>
</li>
</ol>
<p>We’ll cover the individual<a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-type="indexterm" id="idm45607751167840"/> HTML sections in detail in the coming chapters, but I wanted you to see what is essentially the entire nonprogrammatic element of the Nobel Prize visualization. With this skeleton in place, you can then turn to the job of creative programming, something D3 encourages and excels at. As you get used to defining your content blocks in HTML, and fixing dimensions and positioning with CSS, you’ll find you spend more and more time doing what you love best: manipulating data with code.</p>
<div data-type="tip"><h6>Tip</h6>
<p>I find it helpful to treat the identified placeholders, such as the map holder <code>&lt;div id="nobel-map"&gt;&lt;/div&gt;</code>, as panels <em>owned</em> by their respective elements. We set the dimension and relative positioning of these frames in the main CSS or JS<sup><a data-type="noteref" href="ch16.xhtml#idm45607751164464" id="idm45607751164464-marker">2</a></sup> file and the elements, such as our dynamic map, adapt themselves to the size of their frame. This allows a nonprogramming designer to change the look and feel of the visualization through CSS styling.</p>
</div>
<div data-type="example" id="d3build_index">
<h5><span class="label">Example 16-2. </span>The index.xhtml access file to our single-page visualization</h5>
<pre data-code-language="html" data-type="programlisting"><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Visualizing the Nobel Prize<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
<code class="cm">&lt;!-- 1. IMPORT THE visualization'S CSS STYLING --&gt;</code>
<code class="p">&lt;</code><code class="nt">link</code> <code class="na">rel</code><code class="o">=</code><code class="s">"stylesheet"</code> <code class="na">href</code><code class="o">=</code><code class="s">"static/css/style.css"</code>
<code class="na">media</code><code class="o">=</code><code class="s">"screen"</code> <code class="p">/&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">'chart'</code><code class="p">&gt;</code>
    <code class="cm">&lt;!-- 2. A HEADER WITH TITLE AND SOME EXPLANATORY INFO --&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">'title'</code><code class="p">&gt;</code>Visualizing the Nobel Prize<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"info"</code><code class="p">&gt;</code>
      This is a companion piece to the book <code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code><code class="s">'http://'</code><code class="p">&gt;</code>
      Data visualization with Python and JavaScript<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>, in which
      its construction is detailed. The data used was scraped
      Wikipedia using the <code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code>
      <code class="s">'https://en.wikipedia.org/wiki</code>
<code class="s">      /List_of_Nobel_laureates_by_country'</code><code class="p">&gt;</code>
      list of winners by country<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code> as a starting point. The
      accompanying GitHub repo is <code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code>
      <code class="s">'http://github.com/Kyrand/dataviz-with-python-and-js-ed-2'</code><code class="p">&gt;</code>
      here<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>.
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="cm">&lt;!-- 3. THE PLACEHOLDERS FOR OUR VISUAL COMPONENTS  --&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nbviz"</code><code class="p">&gt;</code>
      <code class="cm">&lt;!-- BEGIN MENU BAR --&gt;</code>
      <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-menu"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"cat-select"</code><code class="p">&gt;</code>
          Category
          <code class="p">&lt;</code><code class="nt">select</code><code class="p">&gt;&lt;/</code><code class="nt">select</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"gender-select"</code><code class="p">&gt;</code>
          Gender
          <code class="p">&lt;</code><code class="nt">select</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">option</code> <code class="na">value</code><code class="o">=</code><code class="s">"All"</code><code class="p">&gt;</code>All<code class="p">&lt;/</code><code class="nt">option</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">option</code> <code class="na">value</code><code class="o">=</code><code class="s">"female"</code><code class="p">&gt;</code>Female<code class="p">&lt;/</code><code class="nt">option</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">option</code> <code class="na">value</code><code class="o">=</code><code class="s">"male"</code><code class="p">&gt;</code>Male<code class="p">&lt;/</code><code class="nt">option</code><code class="p">&gt;</code>
          <code class="p">&lt;/</code><code class="nt">select</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"country-select"</code><code class="p">&gt;</code>
          Country
          <code class="p">&lt;</code><code class="nt">select</code><code class="p">&gt;&lt;/</code><code class="nt">select</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">'metric-radio'</code><code class="p">&gt;</code>
          Number of Winners:<code class="ni">&amp;nbsp;</code>
          <code class="p">&lt;</code><code class="nt">form</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">label</code><code class="p">&gt;</code>absolute
              <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"radio"</code> <code class="na">name</code><code class="o">=</code><code class="s">"mode"</code> <code class="na">value</code><code class="o">=</code><code class="s">"0"</code> <code class="na">checked</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">label</code><code class="p">&gt;</code>per-capita
              <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"radio"</code> <code class="na">name</code><code class="o">=</code><code class="s">"mode"</code> <code class="na">value</code><code class="o">=</code><code class="s">"1"</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
          <code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
      <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
      <code class="cm">&lt;!-- END MENU BAR  --&gt;</code>
      <code class="cm">&lt;!-- BEGIN NOBEL-VIZ COMPONENTS --&gt;</code>
      <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">'chart-holder'</code> <code class="na">class</code><code class="o">=</code><code class="s">'_dev'</code><code class="p">&gt;</code>
        <code class="cm">&lt;!-- TIME LINE OF PRIZES --&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-time"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="cm">&lt;!-- MAP AND TOOLTIP --&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-map"</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"map-tooltip"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">h2</code><code class="p">&gt;&lt;/</code><code class="nt">h2</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
          <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="cm">&lt;!-- LIST OF WINNERS --&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-list"</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">h2</code><code class="p">&gt;</code>Selected winners<code class="p">&lt;/</code><code class="nt">h2</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">table</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">thead</code><code class="p">&gt;</code>
              <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">th</code> <code class="na">id</code><code class="o">=</code><code class="s">'year'</code><code class="p">&gt;</code>Year<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">th</code> <code class="na">id</code><code class="o">=</code><code class="s">'category'</code><code class="p">&gt;</code>Category<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">th</code> <code class="na">id</code><code class="o">=</code><code class="s">'name'</code><code class="p">&gt;</code>Name<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
              <code class="p">&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">thead</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">tbody</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">tbody</code><code class="p">&gt;</code>
          <code class="p">&lt;/</code><code class="nt">table</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="cm">&lt;!-- BIOGRAPHY BOX --&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-winner"</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"picbox"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">'winner-title'</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">'infobox'</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'property'</code><code class="p">&gt;</code>
              <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'label'</code><code class="p">&gt;</code>Category<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
              <code class="p">&lt;</code><code class="nt">span</code> <code class="na">name</code><code class="o">=</code><code class="s">'category'</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'property'</code><code class="p">&gt;</code>
              <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'label'</code><code class="p">&gt;</code>Year<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
              <code class="p">&lt;</code><code class="nt">span</code> <code class="na">name</code><code class="o">=</code><code class="s">'year'</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'property'</code><code class="p">&gt;</code>
              <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'label'</code><code class="p">&gt;</code>Country<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
              <code class="p">&lt;</code><code class="nt">span</code> <code class="na">name</code><code class="o">=</code><code class="s">'country'</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
          <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">'biobox'</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">'readmore'</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code><code class="s">'#'</code><code class="p">&gt;</code>Read more at Wikipedia<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>
          <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="cm">&lt;!-- NOBEL BAR CHART --&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"nobel-bar"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
      <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
      <code class="cm">&lt;!-- END NOBEL-VIZ COMPONENTS --&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="cm">&lt;!-- 4. THE JAVASCRIPT FILES --&gt;</code>
  <code class="cm">&lt;!-- THIRD-PARTY JAVASCRIPT LIBRARIES, MAINLY D3  --&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"libs/d3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
  <code class="cm">&lt;!-- ... --&gt;</code>
  <code class="cm">&lt;!-- THE MAIN JAVASCRIPT MODULE FOR OUR NOBEL ELEMENTS --&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"static/js/nbviz_main.mjs"</code> <code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code></pre></div>
<p>The HTML skeleton (<a data-type="xref" href="#d3build_index">Example 16-2</a>) defines the hierarchical structure of our Nobel-viz components, but their visual sizing and positioning are set in the <em>style.css</em> file. In the next section, we’ll see how this is done and look at the general styling of our visualization.<a data-primary="building a visualization" data-secondary="HTML skeleton" data-startref="ix_bldvisHTML" data-type="indexterm" id="idm45607750587392"/><a data-primary="HTML" data-secondary="skeleton for Nobel Prize web visualization" data-startref="ix_HTMLskel" data-type="indexterm" id="idm45607750586144"/><a data-primary="index.xhtml file for Nobel Prize single-page visualization" data-startref="ix_indxhtml" data-type="indexterm" id="idm45607750584960"/></p>
</div></section>
<section data-pdf-bookmark="CSS Styling" data-type="sect1"><div class="sect1" id="idm45607750583920">
<h1>CSS Styling</h1>
<p>We’ll deal with the styling of the individual chart components of our chart (<a data-type="xref" href="#d3build_target">Figure 16-1</a>) in their respective chapters.<a data-primary="CSS" data-secondary="styling for Nobel Prize web visualization" data-type="indexterm" id="ix_CSSstyl"/> This section will cover the remaining nonspecific CSS, most importantly the sizing and positioning of our elements’ content blocks (<em>panels</em>).</p>
<p>The size of a visualization can be a tricky choice. <a data-primary="devices, sizing visualizations for" data-type="indexterm" id="idm45607750578912"/>There are many more device formats out there these days, with smartphones, tablets, mobile devices, etc. having a variety of different resolutions, such as “retina,”<sup><a data-type="noteref" href="ch16.xhtml#idm45607750526128" id="idm45607750526128-marker">3</a></sup> and full HD (1,920×1,080). So pixel sizes are much more varied than they used to be, and pixel density becomes a more meaningful metric.<a data-primary="pixels, sizes and densities on different devices" data-type="indexterm" id="idm45607750525472"/> Most devices perform pixel scaling to compensate for this, which is why you can still read the text on a smartphone even though it has as many pixels as a large desktop monitor. Also, most handheld devices have pinch-and-zoom and pan, allowing the user to easily focus on regions of a larger dataviz. For our Nobel dataviz we’ll choose a compromise resolution of 1,280×800 pixels, which should look OK on most desktop monitors and be usable in landscape mode on a mobile device, including our 50-pixel-high top-most user controls.</p>
<p>First, we set some general styles we want applied to the whole document using the <code>body</code> selector; a sans-serif font, an off-white background, and some link detailing are specified. We also set the width of the visualization and its margins:</p>
<pre data-code-language="css" data-type="programlisting"><code class="nt">body</code><code> </code><code class="p">{</code><code>
    </code><code class="k">font-family</code><code class="o">:</code><code> </code><code class="s2">"Helvetica Neue"</code><code class="o">,</code><code> </code><code class="n">Helvetica</code><code class="o">,</code><code> </code><code class="n">Arial</code><code class="o">,</code><code> </code><code class="nb">sans-serif</code><code class="p">;</code><code>
    </code><code class="k">background</code><code class="o">:</code><code> </code><code class="m">#fefefe</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO2-1" id="co_building_a_visualization_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="k">width</code><code class="o">:</code><code> </code><code class="m">1000px</code><code class="p">;</code><code>
    </code><code class="k">margin</code><code class="o">:</code><code> </code><code class="m">0</code><code> </code><code class="nb">auto</code><code class="p">;</code><code> </code><code class="c">/* top and bottom 0, left and right auto */</code><code>
</code><code class="p">}</code><code>

</code><code class="nt">a</code><code class="nd">:link</code><code> </code><code class="p">{</code><code>
    </code><code class="k">color</code><code class="o">:</code><code> </code><code class="nb">royalblue</code><code class="p">;</code><code>
    </code><code class="k">text-decoration</code><code class="o">:</code><code> </code><code class="nb">none</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO2-2" id="co_building_a_visualization_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="p">}</code><code>

</code><code class="nt">a</code><code class="nd">:hover</code><code> </code><code class="p">{</code><code>
    </code><code class="k">text-decoration</code><code class="o">:</code><code> </code><code class="nb">underline</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO2-1" id="callout_building_a_visualization_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>This color is just off full-white (<code>#ffffff</code>) and should help to make the page slightly less bright and easier on the eyes.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO2-2" id="callout_building_a_visualization_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The default underlined hyperlinks look a bit fussy in my opinion, so we remove decoration.</p></dd>
</dl>
<p>There are three main div content blocks to our Nobel-viz, which we position absolutely within the <code>#chart</code> div (their relative parent). These are the main title (<code>#title</code>) , some information on the visualization (<code>#info</code>), and the main container (<code>#nbviz</code>). The title and info are placed by eye and the main container is placed 90 pixels from the page top to allow them room, and given a width of 100% to make it expand to the available space. The following CSS achieves this:</p>
<pre data-code-language="css" data-type="programlisting"><code class="nf">#nbviz</code> <code class="p">{</code>
    <code class="k">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>
    <code class="k">top</code><code class="o">:</code> <code class="m">90px</code><code class="p">;</code>
    <code class="k">width</code><code class="o">:</code> <code class="m">100%</code><code class="p">;</code>
<code class="p">}</code>

<code class="nf">#title</code> <code class="p">{</code>
    <code class="k">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>
    <code class="k">font-size</code><code class="o">:</code> <code class="m">30px</code><code class="p">;</code>
    <code class="k">font-weight</code><code class="o">:</code> <code class="m">100</code><code class="p">;</code>
    <code class="k">top</code><code class="o">:</code> <code class="m">20px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nf">#info</code> <code class="p">{</code>
    <code class="k">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>
    <code class="k">font-size</code><code class="o">:</code> <code class="m">11px</code><code class="p">;</code>
    <code class="k">top</code><code class="o">:</code> <code class="m">18px</code><code class="p">;</code>
    <code class="k">width</code><code class="o">:</code> <code class="m">300px</code><code class="p">;</code>
    <code class="k">right</code><code class="o">:</code> <code class="m">0px</code><code class="p">;</code>
    <code class="k">line-height</code><code class="o">:</code> <code class="m">1</code><code class="o">.</code><code class="m">2</code><code class="p">;</code>
<code class="p">}</code></pre>
<p>The <code>chart-holder</code> is given a height of 750 px, a width of 100% its parent, and a <code>position</code> property of <code>relative</code>, meaning the absolute positioning of its child panels will be relative to its top-left corner. The bottom of our charts is padded by 20 pixels:</p>
<pre class="pagebreak-before" data-code-language="css" data-type="programlisting"><code class="nf">#chart-holder</code><code> </code><code class="p">{</code><code>
    </code><code class="k">width</code><code class="o">:</code><code> </code><code class="m">100%</code><code class="p">;</code><code>
    </code><code class="k">height</code><code class="o">:</code><code> </code><code class="m">750px</code><code class="p">;</code><code>
    </code><code class="k">position</code><code class="o">:</code><code> </code><code class="nb">relative</code><code class="p">;</code><code>
    </code><code class="k">padding</code><code class="o">:</code><code> </code><code class="m">0</code><code> </code><code class="m">0</code><code> </code><code class="m">20px</code><code> </code><code class="m">0</code><code class="p">;</code><code> </code><code class="c">/* top right bottom left */</code><code>
</code><code class="p">}</code><code>

</code><code class="nf">#chart-holder</code><code> </code><code class="nt">svg</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_building_a_visualization_CO3-1" id="co_building_a_visualization_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="k">width</code><code class="o">:</code><code> </code><code class="m">100%</code><code class="p">;</code><code>
    </code><code class="k">height</code><code class="o">:</code><code> </code><code class="m">100%</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO3-1" id="callout_building_a_visualization_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We want the SVG contexts for our components to expand to fit their containers.</p></dd>
</dl>
<p>Allowing for the Nobel-viz’s height constraint of 750 pixels, the width/height ratio of two for our equirectangular map,<sup><a data-type="noteref" href="ch16.xhtml#idm45607750213296" id="idm45607750213296-marker">4</a></sup> and the need to fit over 100 years’ worth of Nobel Prize circular indicators into our time chart, playing with the dimensions suggests <a data-type="xref" href="#d3build_dimensions">Figure 16-2</a> as a good compromise for the size of our visual elements.</p>
<figure><div class="figure" id="d3build_dimensions">
<img alt="dpj2 1602" height="1038" src="assets/dpj2_1602.png" width="1357"/>
<h6><span class="label">Figure 16-2. </span>The Nobel-viz’s dimensions</h6>
</div></figure>
<p>This CSS positions and sizes the components as shown in <a data-type="xref" href="#d3build_dimensions">Figure 16-2</a>:</p>
<pre data-code-language="css" data-type="programlisting"><code class="nf">#nobel-map</code><code class="o">,</code><code> </code><code class="nf">#nobel-winner</code><code class="o">,</code><code> </code><code class="nf">#nobel-bar</code><code class="o">,</code><code> </code><code class="nf">#nobel-time</code><code class="o">,</code><code> </code><code class="nf">#nobel-list</code><code class="p">{</code><code>
    </code><code class="k">position</code><code class="o">:</code><code class="nb">absolute</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO4-1" id="co_building_a_visualization_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="p">}</code><code>

</code><code class="nf">#nobel-time</code><code> </code><code class="p">{</code><code>
    </code><code class="k">top</code><code class="o">:</code><code> </code><code class="m">0</code><code class="p">;</code><code>
    </code><code class="k">height</code><code class="o">:</code><code> </code><code class="m">150px</code><code class="p">;</code><code>
    </code><code class="k">width</code><code class="o">:</code><code> </code><code class="m">100%</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO4-2" id="co_building_a_visualization_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="p">}</code><code>

</code><code class="nf">#nobel-map</code><code> </code><code class="p">{</code><code>
    </code><code class="k">background</code><code class="o">:</code><code> </code><code class="nb">azure</code><code class="p">;</code><code>
    </code><code class="k">top</code><code class="o">:</code><code> </code><code class="m">160px</code><code class="p">;</code><code>
    </code><code class="k">width</code><code class="o">:</code><code> </code><code class="m">700px</code><code class="p">;</code><code>
    </code><code class="k">height</code><code class="o">:</code><code> </code><code class="m">350px</code><code class="p">;</code><code>
</code><code class="p">}</code><code>

</code><code class="nf">#nobel-winner</code><code> </code><code class="p">{</code><code>
    </code><code class="k">top</code><code class="o">:</code><code> </code><code class="m">510px</code><code class="p">;</code><code>
    </code><code class="k">left</code><code class="o">:</code><code> </code><code class="m">700px</code><code class="p">;</code><code>
    </code><code class="k">height</code><code class="o">:</code><code> </code><code class="m">240px</code><code class="p">;</code><code>
    </code><code class="k">width</code><code class="o">:</code><code> </code><code class="m">300px</code><code class="p">;</code><code>
</code><code class="p">}</code><code>

</code><code class="nf">#nobel-bar</code><code> </code><code class="p">{</code><code>
    </code><code class="k">top</code><code class="o">:</code><code> </code><code class="m">510px</code><code class="p">;</code><code>
    </code><code class="k">height</code><code class="o">:</code><code> </code><code class="m">240px</code><code class="p">;</code><code>
    </code><code class="k">width</code><code class="o">:</code><code> </code><code class="m">700px</code><code class="p">;</code><code>
</code><code class="p">}</code><code>

</code><code class="nf">#nobel-list</code><code> </code><code class="p">{</code><code>
    </code><code class="k">top</code><code class="o">:</code><code> </code><code class="m">160px</code><code class="p">;</code><code>
    </code><code class="k">height</code><code class="o">:</code><code> </code><code class="m">340px</code><code class="p">;</code><code>
    </code><code class="k">width</code><code class="o">:</code><code> </code><code class="m">290px</code><code class="p">;</code><code>
    </code><code class="k">left</code><code class="o">:</code><code> </code><code class="m">700px</code><code class="p">;</code><code>
    </code><code class="k">padding-left</code><code class="o">:</code><code> </code><code class="m">10px</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO4-3" id="co_building_a_visualization_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO4-1" id="callout_building_a_visualization_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We want absolute, manually adjusted positioning, relative to the <code>chart-holder</code> parent container.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO4-2" id="callout_building_a_visualization_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The timeline runs the full width of the visualization.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO4-3" id="callout_building_a_visualization_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>You can use padding to let the components “breathe.”</p></dd>
</dl>
<p class="pagebreak-before">The other CSS styles are specific to the individual components and will be covered in their respective chapters. With the preceding CSS, we have an HTML skeleton on which to flesh out our visualization with JavaScript.<a data-primary="CSS" data-secondary="styling for Nobel Prize web visualization" data-startref="ix_CSSstyl" data-type="indexterm" id="idm45607750042000"/></p>
</div></section>
<section data-pdf-bookmark="The JavaScript Engine" data-type="sect1"><div class="sect1" id="idm45607750583328">
<h1>The JavaScript Engine</h1>
<p>With a visualization of any size, it’s <a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-type="indexterm" id="ix_JSNPvis"/>good to start imposing some modularity early on. Many of the D3 examples on the web<sup><a data-type="noteref" href="ch16.xhtml#idm45607749985552" id="idm45607749985552-marker">5</a></sup> are one-page solutions, combining HTML, CSS, JS, and even data on one page. Though this is great for teaching by example, as the codebase increases, things will degenerate fast, making changes a slog and increasing the chance of namespace collisions and the like.</p>
<section data-pdf-bookmark="Importing the Scripts" data-type="sect2"><div class="sect2" id="idm45607749984176">
<h2>Importing the Scripts</h2>
<p>We include the <a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-tertiary="importing the scripts" data-type="indexterm" id="idm45607749982576"/><a data-primary="building a visualization" data-secondary="JavaScript" data-tertiary="importing the scripts" data-type="indexterm" id="idm45607749981248"/>JavaScript files for our visualization using <code>&lt;script&gt;</code> tags placed at the bottom of the <code>&lt;body&gt;</code> tag in our entry <em>index.xhtml</em> file, as shown in <a data-type="xref" href="#d3build_index">Example 16-2</a>:</p>
<pre data-code-language="html" data-type="programlisting"><code class="cp">&lt;!DOCTYPE html&gt;</code><code>
</code><code class="p">&lt;</code><code class="nt">meta</code><code> </code><code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code><code>
...
</code><code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code><code>
...
  </code><code class="cm">&lt;!-- THIRD-PARTY JAVASCRIPT LIBRARIES, MAINLY D3 BASED  --&gt;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO5-1" id="co_building_a_visualization_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code class="p">&lt;</code><code class="nt">script</code><code> </code><code class="na">src</code><code class="o">=</code><code class="s">"static/libs/d3.min.js"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">script</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">script</code><code> </code><code class="na">src</code><code class="o">=</code><code class="s">"static/libs/topojson.min.js"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">script</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">script</code><code> </code><code class="na">src</code><code class="o">=</code><code class="s">"static/libs/crossfilter.min.js"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">script</code><code class="p">&gt;</code><code>
  </code><code class="cm">&lt;!-- THE JAVASCRIPT FOR OUR NOBEL ELEMENTS --&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">script</code><code> </code><code class="na">src</code><code class="o">=</code><code class="s">"static/js/nbviz_main.mjs"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">script</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO5-2" id="co_building_a_visualization_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">body</code><code class="p">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO5-1" id="callout_building_a_visualization_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We use local copies of the third-party libraries.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO5-2" id="callout_building_a_visualization_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The main entry point for our Nobel app, where it requests its first datasets and sets the display ball rolling. This module imports all the others used by the visualization.</p></dd>
</dl>
<aside class="pagebreak-before less_space" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45607749917040">
<h5>Content Delivery Networks</h5>
<p>One thing you’ll see a lot of if you look at the script tags in (typically) <em>index.xhtml</em> pages is the use of Content Delivery Networks (CDNs) to provide cacheable libraries efficiently using a central store.<a data-primary="content delivery networks (CDNs)" data-type="indexterm" id="idm45607749914816"/><a data-primary="CDNs (content delivery networks)" data-type="indexterm" id="idm45607749914048"/> So you might use Cloudflare’s CDN to import D3:app-name:</p>
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://cdnjs.cloudflare.com/ajax/libs/d3/7.3.1/d3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre>
<p>CDNs are a very efficient way to import libraries and if you’re using a lot of them and they are relatively heavyweight, it can provide tangible benefits. But certainly for development purposes it’s good to use a local copy of the library, and this is what we do, with the three libraries used in the visualization being retrieved from a <em>libs</em> subdirectory of <em>static</em>.</p>
</div></aside>
</div></section>
<section data-pdf-bookmark="Modular JS with Imports" data-type="sect2"><div class="sect2" id="idm45607749870144">
<h2>Modular JS with Imports</h2>
<p>In the first edition of this book, a common but rather<a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-tertiary="modular JavaScript with imports" data-type="indexterm" id="idm45607749868608"/><a data-primary="building a visualization" data-secondary="JavaScript" data-tertiary="modular JavaScript with imports" data-type="indexterm" id="idm45607749867152"/> hacky pattern was used to establish an <code>nbviz</code> namespace within which to place functions, variables, constants, etc. used by the various components of the Nobel dataviz. Here’s an example, as you may well run into similar patterns in the wild:</p>
<pre data-code-language="js" data-type="programlisting"><code class="cm">/* js/nbviz_core.js
/* global $, _, crossfilter, d3  */</code><code> </code><a class="co" href="#callout_building_a_visualization_CO6-1" id="co_building_a_visualization_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">)</code><code> </code><code class="p">{</code><code>
     </code><code class="c1">//... MODULES PRIVATE VARS ETC..
</code><code>     </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">foo</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="p">)</code><code class="p">{</code><code> </code><code class="c1">//... </code><a class="co" href="#callout_building_a_visualization_CO6-2" id="co_building_a_visualization_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="c1">
</code><code>     </code><code class="p">}</code><code class="p">;</code><code>
</code><code class="p">}</code><code class="p">(</code><code class="nb">window</code><code class="p">.</code><code class="nx">nbviz</code><code> </code><code class="o">=</code><code> </code><code class="nb">window</code><code class="p">.</code><code class="nx">nbviz</code><code> </code><code class="o">||</code><code> </code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO6-3" id="co_building_a_visualization_CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO6-1" id="callout_building_a_visualization_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Defining variables as global will prevent them triggering <a href="https://www.jslint.com">JSLint errors</a>.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO6-2" id="callout_building_a_visualization_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Exposes this function to other scripts as part of shared <code>nbviz</code> namespace.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO6-3" id="callout_building_a_visualization_CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Uses the <code>nbviz</code> object if available, and creates it otherwise.</p></dd>
</dl>
<p>Each JS script was encapsulated with this pattern and all required scripts were included with a <code>&lt;script&gt;</code> tag in the main <em>index.xhtml</em> entry point. With the arrival of cross-browser support for JS modules, we have a much cleaner, modern way of including our JavaScript with modular imports familiar to any Pythonista (see <a data-type="xref" href="ch02.xhtml#sect_js_modules">“JavaScript Modules”</a>).</p>
<p>We now have only to include our main JS module in <em>index.xhtml</em>, and that will import all the other modules required:</p>
<pre class="pagebreak-before" data-code-language="js" data-type="programlisting"><code class="c1">// static/js/nbviz_main.mjs
</code><code class="kr">import</code><code> </code><code class="nx">nbviz</code><code> </code><code class="nx">from</code><code> </code><code class="s1">'./nbviz_core.mjs'</code><code>
</code><code class="kr">import</code><code> </code><code class="p">{</code><code> </code><code class="nx">initMenu</code><code> </code><code class="p">}</code><code> </code><code class="nx">from</code><code> </code><code class="s1">'./nbviz_menu.mjs'</code><code>
</code><code class="kr">import</code><code> </code><code class="p">{</code><code> </code><code class="nx">initMap</code><code> </code><code class="p">}</code><code> </code><code class="nx">from</code><code> </code><code class="s1">'./nbviz_map.mjs'</code><code>
</code><code class="kr">import</code><code> </code><code class="s1">'./nbviz_bar.mjs'</code><code> </code><a class="co" href="#callout_building_a_visualization_CO7-1" id="co_building_a_visualization_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="kr">import</code><code> </code><code class="s1">'./nbviz_details.mjs'</code><code>
</code><code class="kr">import</code><code> </code><code class="s1">'./nbviz_time.mjs'</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO7-1" id="callout_building_a_visualization_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>These are imported to initialize their update callbacks. We’ll see how that works later in the chapter.</p></dd>
</dl>
<p>In the coming chapters, the JavaScript/D3 used to produce the visualization’s elements will be explained in detail. First, we’ll deal with the flow of data through the Nobel-viz, from the (data) server to the client browser and within the client, driven by user interaction.</p>
</div></section>
<section data-pdf-bookmark="Basic Data Flow" data-type="sect2"><div class="sect2" id="d3build_sect_components">
<h2>Basic Data Flow</h2>
<p>There are many ways to deal with data in a project of any complexity. For interactive apps, and particularly data visualizations, I find the most robust pattern is to have a central data object to cache current data.<a data-primary="building a visualization" data-secondary="JavaScript" data-tertiary="basic data flow" data-type="indexterm" id="idm45607749715136"/><a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-tertiary="basic data flow" data-type="indexterm" id="idm45607749713920"/> In addition to the cached data, we also have some active reflections or subsets of this dataset, stored in the main data object. For example, in our Nobel-viz a user can select a number of subsets of the data (e.g., only those winners in the Physics category).</p>
<p>If a different data reflection is triggered by the user, such as by choosing the per capita prize metric, a flag<sup><a data-type="noteref" href="ch16.xhtml#idm45607749683584" id="idm45607749683584-marker">6</a></sup> is set (in this case, <code>valuePerCapita</code> is set to <code>0</code> or <code>1</code>). We then update all the visual components, and those that depend on <code>valuePerCapita</code> adapt accordingly. The size of the map indicators changes and the bar chart <span class="keep-together">reorganizes</span>.</p>
<p>The key idea is to make sure the visual elements are synchronized to any user-driven data changes. A reliable way to do this is to have a single update method (here called <code>onDataChange</code>) that is called whenever a user does something to change the data. This method alerts all the active visual elements to the changed data and they respond accordingly.</p>
<p>Let’s now see how the app’s code fits together, starting with the shared core utilities.</p>
</div></section>
<section data-pdf-bookmark="The Core Code" data-type="sect2"><div class="sect2" id="idm45607749678992">
<h2>The Core Code</h2>
<p>The first JavaScript file loaded is <em>nbviz_core.js</em>. <a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-tertiary="core code" data-type="indexterm" id="ix_JSNPviscore"/><a data-primary="building a visualization" data-secondary="JavaScript" data-tertiary="core code" data-type="indexterm" id="ix_bldvisJScore"/>This script contains any code we might want to share among the other scripts. For example, we have a <code>categoryFill</code> method that returns a specific color for each category. This is used by both the timeline component and as a border in the biography box. This core code includes functions we might want to isolate for testing, or simply to make other modules less cluttered.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Often in programming we use string constants as dictionary keys and comparatives, and in generated labels.<a data-primary="constants" data-type="indexterm" id="idm45607749671744"/> It’s easy to slip into the bad habit of typing these strings when required, but a much better way is to define a constant variable instead. For example, rather than <code>'if option === "All Categories"'</code>, we use <code>'if option === nbviz.ALL_CATS'</code>. In the former option, mistyping <code>'All Categories'</code> will not flag an error, an accident waiting to happen. Having a <code>const</code> also means only one edit is needed to change all occurrences of the string. <a data-primary="const keyword (JavaScript)" data-type="indexterm" id="idm45607749669264"/>JavaScript has a newish <code>const</code> keyword that makes enforcing constancy a bit easier, though it only prevents variables from being reassigned. See the <a href="https://oreil.ly/AlEbm">Mozilla documentation</a> for some examples and a breakdown of <code>const</code> limitations.</p>
</div>
<p><a data-type="xref" href="#build_core">Example 16-3</a> shows the code shared between the other modules. Anything intended to be used by other modules is attached to the shared <code>nbviz</code> namespace.</p>
<div data-type="example" id="build_core">
<h5><span class="label">Example 16-3. </span>Shared codebase in nbviz_core.js</h5>
<pre data-code-language="js" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">nbviz</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code>
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">ALL_CATS</code><code> </code><code class="o">=</code><code> </code><code class="s1">'All Categories'</code><code>
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">TRANS_DURATION</code><code> </code><code class="o">=</code><code> </code><code class="mi">2000</code><code> </code><code class="c1">// time in ms for our visual transitions
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">MAX_CENTROID_RADIUS</code><code> </code><code class="o">=</code><code> </code><code class="mi">30</code><code>
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">MIN_CENTROID_RADIUS</code><code> </code><code class="o">=</code><code> </code><code class="mi">2</code><code>
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">COLORS</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code> </code><code class="nx">palegold</code><code class="o">:</code><code> </code><code class="s1">'#E6BE8A'</code><code> </code><code class="p">}</code><code> </code><code class="c1">// any named colors used
</code><code>
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">data</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code> </code><code class="c1">// our main data store
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">valuePerCapita</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code> </code><code class="c1">// metric flag
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">activeCountry</code><code> </code><code class="o">=</code><code> </code><code class="kc">null</code><code>
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">activeCategory</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">ALL_CATS</code><code>

</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">CATEGORIES</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code>
    </code><code class="s2">"Chemistry"</code><code class="p">,</code><code> </code><code class="s2">"Economics"</code><code class="p">,</code><code> </code><code class="s2">"Literature"</code><code class="p">,</code><code> </code><code class="s2">"Peace"</code><code class="p">,</code><code>
    </code><code class="s2">"Physics"</code><code class="p">,</code><code> </code><code class="s2">"Physiology or Medicine"</code><code>
</code><code class="p">]</code><code class="p">;</code><code>
</code><code class="c1">// takes a category like Physics and returns a color
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryFill</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">category</code><code class="p">)</code><code class="p">{</code><code>
    </code><code class="kd">var</code><code> </code><code class="nx">i</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">CATEGORIES</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">category</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="k">return</code><code> </code><code class="nx">d3</code><code class="p">.</code><code class="nx">schemeCategory10</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO8-1" id="co_building_a_visualization_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="p">}</code><code class="p">;</code><code>

</code><code class="kd">let</code><code> </code><code class="nx">nestDataByYear</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">entries</code><code class="p">)</code><code> </code><code class="p">{</code><code>          </code><a class="co" href="#callout_building_a_visualization_CO8-2" id="co_building_a_visualization_CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="c1">//...
</code><code class="p">}</code><code class="p">;</code><code>

</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">makeFilterAndDimensions</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">winnersData</code><code class="p">)</code><code class="p">{</code><code>
</code><code class="c1">//...
</code><code class="p">}</code><code class="p">;</code><code>

</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">filterByCountries</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">countryNames</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code class="c1">//...
</code><code class="p">}</code><code class="p">;</code><code>

</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">filterByCategory</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">cat</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code class="c1">//...
</code><code class="p">}</code><code class="p">;</code><code>

</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">getCountryData</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code class="c1">// ...
</code><code class="p">}</code><code class="p">;</code><code>

</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">callbacks</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">onDataChange</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_building_a_visualization_CO8-3" id="co_building_a_visualization_CO8-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
  </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">callbacks</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="p">(</code><code class="nx">cb</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">cb</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="p">}</code><code>

</code><code class="kr">export</code><code> </code><code class="k">default</code><code> </code><code class="nx">nbviz</code><code> </code><a class="co" href="#callout_building_a_visualization_CO8-4" id="co_building_a_visualization_CO8-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO8-1" id="callout_building_a_visualization_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We use one of D3’s built-in color schemes to provide our prize category colors. <code>schemeCategory10</code> is an array of 10 color hex codes (<code>['#1f77b4', '#ff7f0e',...]</code>), which we access using the category indices.<a data-primary="D3 library" data-secondary="built-in color schemes" data-type="indexterm" id="idm45607749653840"/></p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO8-2" id="callout_building_a_visualization_CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>This and the following empty methods will be explained in detail in the following chapters in a use context.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO8-3" id="callout_building_a_visualization_CO8-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>This function is called when the dataset changes (after initialization of the app, this is user-driven) to update the Nobel-viz elements. Update callbacks set by the component modules and stored in the <code>callbacks</code> array are called in turn, triggering any necessary visual changes. See <a data-type="xref" href="#d3build_sect_components">“Basic Data Flow”</a> for details.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO8-4" id="callout_building_a_visualization_CO8-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>The <code>nbviz</code> object, with utility functions, constants, and variables, is the default export for this module, imported by other modules, thus <code>import nbviz from ​./⁠nbviz_core</code>.</p></dd>
</dl></div>
<p>With the core code at hand, let’s see how our app is initialized by fetching static resources using D3’s utility methods.</p>
</div></section>
<section data-pdf-bookmark="Initializing the Nobel Prize Visualization" data-type="sect2"><div class="sect2" id="idm45607749521888">
<h2>Initializing the Nobel Prize Visualization</h2>
<p>In order to start the app, we need <a data-primary="building a visualization" data-secondary="JavaScript" data-startref="ix_bldvisJScore" data-tertiary="core code" data-type="indexterm" id="idm45607749520320"/><a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-startref="ix_JSNPviscore" data-tertiary="core code" data-type="indexterm" id="idm45607749518832"/>some data. <a data-primary="building a visualization" data-secondary="JavaScript" data-tertiary="initializing the visualization" data-type="indexterm" id="idm45607749516928"/><a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-tertiary="initializing the visualization" data-type="indexterm" id="idm45607749515648"/><a data-primary="D3 library" data-secondary="utility methods, using to load data and convert to JavaScript" data-type="indexterm" id="idm45607749514128"/>We use D3’s <code>json</code> and <code>csv</code> helper functions to load the data and convert it to JavaScript objects and arrays. The <code>Promise.all</code><sup><a data-type="noteref" href="ch16.xhtml#idm45607749511824" id="idm45607749511824-marker">7</a></sup> method is used to fire off these data fetches simultaneously, wait for all four to be resolved, and then deliver the data to a specified handler function, in this case <code>ready</code>:</p>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// static/js/nbviz_main.mjs
</code><code class="c1">//...
</code><code>  </code><code class="nb">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="p">[</code><code> </code><a class="co" href="#callout_building_a_visualization_CO9-1" id="co_building_a_visualization_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s1">'static/data/world-110m.json'</code><code class="p">)</code><code class="p">,</code><code>
    </code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s1">'static/data/world-country-names-nobel.csv'</code><code class="p">)</code><code class="p">,</code><code>
    </code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s1">'static/data/winning_country_data.json'</code><code class="p">)</code><code class="p">,</code><code>
    </code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s1">'static/data/nobel_winners_biopic.json'</code><code class="p">)</code><code class="p">,</code><code>
  </code><code class="p">]</code><code class="p">)</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">ready</code><code class="p">)</code><code>

  </code><code class="kd">function</code><code> </code><code class="nx">ready</code><code class="p">(</code><code class="p">[</code><code class="nx">worldMap</code><code class="p">,</code><code> </code><code class="nx">countryNames</code><code class="p">,</code><code> </code><code class="nx">countryData</code><code class="p">,</code><code> </code><code class="nx">winnersData</code><code class="p">]</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_building_a_visualization_CO9-2" id="co_building_a_visualization_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code class="c1">// STORE OUR COUNTRY-DATA DATASET
</code><code>    </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">countryData</code><code> </code><code class="o">=</code><code> </code><code class="nx">countryData</code><code>
    </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">winnersData</code><code> </code><code class="o">=</code><code> </code><code class="nx">winnersData</code><code>
    </code><code class="c1">//...
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO9-1" id="callout_building_a_visualization_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Fire off simultaneous requests for the four data files. The static files consist of a world map (110m resolution) and some country data we’ll be using in the visualization.<a data-primary="destructuring capabilities in JavaScript" data-type="indexterm" id="idm45607749551952"/></p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO9-2" id="callout_building_a_visualization_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The array returned to <code>ready</code> uses <a href="https://oreil.ly/RZzXm">JavaScript destructuring</a> to assign the sequential data to its respective variables.</p></dd>
</dl>
<p>If our data requests are successful, the  <code>ready</code> function receives the requested data and we’re ready to start sending data to the visual <span class="keep-together">elements</span>.</p>
</div></section>
<section data-pdf-bookmark="Ready to Go" data-type="sect2"><div class="sect2" id="sect_ready">
<h2>Ready to Go</h2>
<p>After the deferred requests for data made by the <code>Promise.all</code> method are resolved, it calls the specified <code>ready</code> function, passing the datasets as arguments in the order in which they were added.<a data-primary="Promise.all method (JavaScript)" data-type="indexterm" id="idm45607749203792"/><a data-primary="ready function (JavaScript)" data-type="indexterm" id="idm45607749203184"/><a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-tertiary="ready to go" data-type="indexterm" id="idm45607749202576"/><a data-primary="building a visualization" data-secondary="JavaScript" data-tertiary="visualization app ready to go" data-type="indexterm" id="idm45607749201248"/></p>
<p>The <code>ready</code> function is shown in <a data-type="xref" href="#build_ready">Example 16-4</a>. If the data has downloaded without error, we use the winners’ data to create the active filter (courtesy of the Crossfilter library) we will use to allow the user to select subsets of the Nobel winners based on category, gender, and country. We then call some initializer methods, and finally use the <code>onDataChange</code> method to trigger a drawing of the visual elements of dataviz, updating bar chart, map, timeline, and so on. The schematic in <a data-type="xref" href="#d3build_work_flow">Figure 16-3</a> shows the way in which data changes propagate.</p>
<div data-type="example" id="build_ready">
<h5><span class="label">Example 16-4. </span>The <code>ready</code> function is called when the initial data requests have resolved</h5>
<pre data-code-language="js" data-type="programlisting"><code class="c1">//...
</code><code>  </code><code class="kd">function</code><code> </code><code class="nx">ready</code><code class="p">(</code><code class="p">[</code><code class="nx">worldMap</code><code class="p">,</code><code> </code><code class="nx">countryNames</code><code class="p">,</code><code> </code><code class="nx">countryData</code><code class="p">,</code><code> </code><code class="nx">winnersData</code><code class="p">]</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="c1">// STORE OUR COUNTRY-DATA DATASET
</code><code>    </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">countryData</code><code> </code><code class="o">=</code><code> </code><code class="nx">countryData</code><code>
    </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">winnersData</code><code> </code><code class="o">=</code><code> </code><code class="nx">winnersData</code><code>
    </code><code class="c1">// MAKE OUR FILTER AND ITS DIMENSIONS
</code><code>    </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">makeFilterAndDimensions</code><code class="p">(</code><code class="nx">winnersData</code><code class="p">)</code><code> </code><a class="co" href="#callout_building_a_visualization_CO10-1" id="co_building_a_visualization_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code class="c1">// INITIALIZE MENU AND MAP
</code><code>    </code><code class="nx">initMenu</code><code class="p">(</code><code class="p">)</code><code>
    </code><code class="nx">initMap</code><code class="p">(</code><code class="nx">worldMap</code><code class="p">,</code><code> </code><code class="nx">countryNames</code><code class="p">)</code><code>
    </code><code class="c1">// TRIGGER UPDATE WITH FULL WINNERS' DATASET
</code><code>    </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">onDataChange</code><code class="p">(</code><code class="p">)</code><code>
  </code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO10-1" id="callout_building_a_visualization_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>This method uses the freshly loaded Nobel Prize dataset to create the filter we will use to allow the user to select subsets of the data to visualize. See <a data-type="xref" href="#crossfilter">“Filtering Data with Crossfilter”</a> for details.</p></dd>
</dl></div>
<p>We’ll see how the <code>makeFilterAndDimensions</code> method (<a data-type="xref" href="#build_ready">Example 16-4</a>, <img alt="1" height="12" src="assets/1.png" width="12"/>) works when we cover the Crossfilter library in <a data-type="xref" href="#crossfilter">“Filtering Data with Crossfilter”</a>. For now, we’ll assume we have a means of getting the data currently selected by the user via some menu selectors (e.g., selecting all female winners).</p>
<figure><div class="figure" id="d3build_work_flow">
<img alt="dpj2 1603" height="897" src="assets/dpj2_1603.png" width="1116"/>
<h6><span class="label">Figure 16-3. </span>The app’s main data flow</h6>
</div></figure>
</div></section>
<section data-pdf-bookmark="Data-Driven Updates" data-type="sect2"><div class="sect2" id="d3build_sect_components_2">
<h2>Data-Driven Updates</h2>
<p>After the menu and<a data-primary="updates" data-secondary="data-driven updates to Nobel Prize web visualization" data-type="indexterm" id="ix_updvis"/><a data-primary="data-driven updates to a web visualization" data-type="indexterm" id="ix_dataupd"/><a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-tertiary="data-driven updates" data-type="indexterm" id="ix_JsNPvisdaupd"/> map have been initialized in the <code>ready</code> function (we’ll see how that works in their respective chapters: <a data-type="xref" href="ch19.xhtml#chapter_d3_maps">Chapter 19</a> for the map and <a data-type="xref" href="ch21.xhtml#chapter_d3_ui">Chapter 21</a> for the menu), we trigger an update of the visual elements with the <code>onDataChange</code> method defined in <em>nbviz_core.js</em>. <code>onDataChange</code> (see <a data-type="xref" href="#src_ondatachange">Example 16-5</a>) is a shared function that is called whenever the set of displayed data changes in <a data-primary="onDataChange method (JavaScript)" data-type="indexterm" id="idm45607749083344"/>response to user interaction, or when the user chooses a different country prize metric (e.g., measuring per capita rather than absolute <span class="keep-together">numbers</span>).</p>
<div data-type="example" id="src_ondatachange">
<h5><span class="label">Example 16-5. </span>Function called to update the visual elements when selected data is changed</h5>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// nbviz_core.js
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">callbacks</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code> </code><a class="co" href="#callout_building_a_visualization_CO11-1" id="co_building_a_visualization_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>

</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">onDataChange</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>
  </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">callbacks</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="p">(</code><code class="nx">cb</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">cb</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_building_a_visualization_CO11-2" id="co_building_a_visualization_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO11-1" id="callout_building_a_visualization_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Each component module that needs updating appends its callback to this array.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO11-2" id="callout_building_a_visualization_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>On data change the component callbacks are called in turn, triggering any visual changes necessary to reflect the new data.</p></dd>
</dl></div>
<p>When the modules are first imported, they add their callbacks to the <code>callbacks</code> array in the core module. Here’s the bar chart, for example:</p>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// nbviz_bar.mjs
</code><code class="kr">import</code><code> </code><code class="nx">nbviz</code><code> </code><code class="nx">from</code><code> </code><code class="s1">'./nbviz_core.mjs'</code><code>
</code><code class="c1">// ...
</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">callbacks</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
  </code><code class="kd">let</code><code> </code><code class="nx">data</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">getCountryData</code><code class="p">(</code><code class="p">)</code><code>
  </code><code class="nx">updateBarChart</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code> </code><a class="co" href="#callout_building_a_visualization_CO12-1" id="co_building_a_visualization_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="p">}</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO12-1" id="callout_building_a_visualization_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>When the main core update function calls this callback function, the country data is used by the local update function to change the bar chart.</p></dd>
</dl>
<p>The main dataset, consumed by the timeline, map, and bar chart, is produced by the <code>getCountryData</code> method, which groups the prize winners by country and adds some national information, namely population size and international alphacode. <a data-type="xref" href="#build_getCountryData">Example 16-6</a> breaks this method down.</p>
<div data-type="example" id="build_getCountryData">
<h5><span class="label">Example 16-6. </span>Creating the main country dataset</h5>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">getCountryData</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="kd">var</code><code> </code><code class="nx">countryGroups</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">countryDim</code><code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO13-1" id="co_building_a_visualization_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>

    </code><code class="c1">// make main data-ball
</code><code>    </code><code class="kd">var</code><code> </code><code class="nx">data</code><code> </code><code class="o">=</code><code> </code><code class="nx">countryGroups</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">c</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_building_a_visualization_CO13-2" id="co_building_a_visualization_CO13-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
        </code><code class="kd">var</code><code> </code><code class="nx">cData</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">countryData</code><code class="p">[</code><code class="nx">c</code><code class="p">.</code><code class="nx">key</code><code class="p">]</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO13-3" id="co_building_a_visualization_CO13-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
        </code><code class="kd">var</code><code> </code><code class="nx">value</code><code> </code><code class="o">=</code><code> </code><code class="nx">c</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code><code>
        </code><code class="c1">// if per capita value then divide by pop. size
</code><code>        </code><code class="k">if</code><code class="p">(</code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">valuePerCapita</code><code class="p">)</code><code class="p">{</code><code>
            </code><code class="nx">value</code><code> </code><code class="o">=</code><code> </code><code class="nx">value</code><code> </code><code class="o">/</code><code> </code><code class="nx">cData</code><code class="p">.</code><code class="nx">population</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO13-4" id="co_building_a_visualization_CO13-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
        </code><code class="p">}</code><code>
        </code><code class="k">return</code><code> </code><code class="p">{</code><code>
            </code><code class="nx">key</code><code class="o">:</code><code> </code><code class="nx">c</code><code class="p">.</code><code class="nx">key</code><code class="p">,</code><code> </code><code class="c1">// e.g., Japan
</code><code>            </code><code class="nx">value</code><code class="o">:</code><code> </code><code class="nx">value</code><code class="p">,</code><code> </code><code class="c1">// e.g., 19 (prizes)
</code><code>            </code><code class="nx">code</code><code class="o">:</code><code> </code><code class="nx">cData</code><code class="p">.</code><code class="nx">alpha3Code</code><code class="p">,</code><code> </code><code class="c1">// e.g., JPN
</code><code>        </code><code class="p">}</code><code class="p">;</code><code>
    </code><code class="p">}</code><code class="p">)</code><code>
        </code><code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code><code> </code><code class="nx">b</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_building_a_visualization_CO13-5" id="co_building_a_visualization_CO13-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code>
            </code><code class="k">return</code><code> </code><code class="nx">b</code><code class="p">.</code><code class="nx">value</code><code> </code><code class="o">-</code><code> </code><code class="nx">a</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code><code> </code><code class="c1">// descending
</code><code>        </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>

    </code><code class="k">return</code><code> </code><code class="nx">data</code><code class="p">;</code><code>
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO13-1" id="callout_building_a_visualization_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p><code>countryDim</code> is one of our Crossfilter dimensions (see <a data-type="xref" href="#crossfilter">“Filtering Data with Crossfilter”</a>), here providing group key, value counts (e.g., <code>{key:Argentina, value:5}</code>).</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO13-2" id="callout_building_a_visualization_CO13-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>We use the array’s <code>map</code> method to create a new array with added components from our country dataset.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO13-3" id="callout_building_a_visualization_CO13-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Fetches country data using our group key (e.g., Australia).</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO13-4" id="callout_building_a_visualization_CO13-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>If the <code>valuePerCapita</code> radio-switch is on then we divide the number of prizes by the size of the country’s population, giving a <em>fairer</em>, relative prize tally.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO13-5" id="callout_building_a_visualization_CO13-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Uses <code>Array</code>’s <code>sort</code> method to make the array descending by value.</p></dd>
</dl></div>
<p>The update methods of our Nobel-viz elements all make use of data filtered by the Crossfilter library. Let’s see how that’s done now.</p>
</div></section>
<section data-pdf-bookmark="Filtering Data with Crossfilter" data-type="sect2"><div class="sect2" id="crossfilter">
<h2>Filtering Data with Crossfilter</h2>
<p>Developed by D3’s creators, Mike Bostock and Jason Davies, Crossfilter<sup><a data-type="noteref" href="ch16.xhtml#idm45607748719440" id="idm45607748719440-marker">8</a></sup> is a highly optimized library for exploring large, multivariate datasets using JavaScript. <a data-primary="updates" data-secondary="data-driven updates to Nobel Prize web visualization" data-startref="ix_updvis" data-type="indexterm" id="idm45607748717952"/><a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-startref="ix_JsNPvisdaupd" data-tertiary="data-driven updates" data-type="indexterm" id="idm45607748716704"/><a data-primary="data-driven updates to a web visualization" data-startref="ix_dataupd" data-type="indexterm" id="idm45607748714976"/>It’s very fast and can easily handle datasets far larger than our Nobel Prize dataset. <a data-primary="building a visualization" data-secondary="JavaScript" data-tertiary="filtering data with Crossfilter" data-type="indexterm" id="ix_bldvisJSfltr"/><a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-tertiary="filtering data with Crossfilter" data-type="indexterm" id="ix_JSNPvisfltr"/><a data-primary="Crossfilter" data-type="indexterm" id="ix_Crssfil"/><a data-primary="filtering data" data-secondary="using Crossfilter" data-type="indexterm" id="ix_fltrCrss"/>We’ll be using it  to filter our dataset of winners by the dimensions of category, gender, and <span class="keep-together">country</span>.</p>
<p>The choice of Crossfilter is slightly ambitious, but I wanted to show it in action as I’ve found it to be so useful personally. It’s also the basis of <a href="https://dc-js.github.io/dc.js"><em>dc.js</em></a>, the very popular D3 charting library, which testifies to its usefulness. Although Crossfilter can be a little difficult to grasp, especially when we start intersecting dimensional filters, most use cases follow a basic pattern that is quickly absorbed. If you ever find yourself trying to cut and slice large datasets, Crossfilter’s optimizations will prove a boon.</p>
<section data-pdf-bookmark="Creating the filter" data-type="sect3"><div class="sect3" id="idm45607748706160">
<h3>Creating the filter</h3>
<p>On initializing the Nobel-viz, the <code>makeFilterAndDimensions</code> method defined in <em>nbviz_core.js</em> is called from the <code>ready</code> method in <em>nbviz_main.js</em> (see <a data-type="xref" href="#sect_ready">“Ready to Go”</a>). <code>makeFilterAndDimensions</code> uses the freshly loaded Nobel Prize dataset to create a Crossfilter filter and some dimensions (e.g., prize category) based on it.</p>
<p>We first create our filter using the dataset of Nobel Prize winners fetched on initialization. Let’s remind ourselves what that looks like:</p>
<pre data-code-language="js" data-type="programlisting"><code class="p">[{</code>
  <code class="nx">name</code><code class="o">:</code><code class="s2">"C\u00e9sar Milstein"</code><code class="p">,</code>
  <code class="nx">category</code><code class="o">:</code><code class="s2">"Physiology or Medicine"</code><code class="p">,</code>
  <code class="nx">gender</code><code class="o">:</code><code class="s2">"male"</code><code class="p">,</code>
  <code class="nx">country</code><code class="o">:</code><code class="s2">"Argentina"</code><code class="p">,</code>
  <code class="nx">year</code><code class="o">:</code> <code class="mi">1984</code>
 <code class="p">},</code>
 <code class="p">{</code>
  <code class="nx">name</code><code class="o">:</code><code class="s2">"Auguste Beernaert"</code><code class="p">,</code>
  <code class="nx">category</code><code class="o">:</code><code class="s2">"Peace"</code><code class="p">,</code>
  <code class="nx">gender</code><code class="o">:</code><code class="s2">"male"</code><code class="p">,</code>
  <code class="nx">country</code><code class="o">:</code><code class="s2">"Belgium"</code><code class="p">,</code>
  <code class="nx">year</code><code class="o">:</code> <code class="mi">1909</code>
 <code class="p">},</code>
 <code class="p">...</code>
<code class="p">}];</code></pre>
<p class="pagebreak-before">To create our filter, call the <code>crossfilter</code> function with the array of winner objects:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">makeFilterAndDimensions</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">winnersData</code><code class="p">){</code>
    <code class="c1">// ADD OUR FILTER AND CREATE CATEGORY DIMENSIONS</code>
    <code class="nx">nbviz</code><code class="p">.</code><code class="nx">filter</code> <code class="o">=</code> <code class="nx">crossfilter</code><code class="p">(</code><code class="nx">winnersData</code><code class="p">);</code>
    <code class="c1">//...</code>
<code class="p">};</code></pre>
<p>Crossfilter works by allowing you to create dimensional filters on your data. You do so by applying a function to the objects. At its simplest, this creates a dimension based on a single category—for example, by gender. Here we create the gender dimension we’ll use to filter Nobel Prizes:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">makeFilterAndDimensions</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">winnersData</code><code class="p">){</code>
<code class="c1">//...</code>
    <code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code> <code class="o">=</code> <code class="nx">nbviz</code><code class="p">.</code><code class="nx">filter</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">o</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">o</code><code class="p">.</code><code class="nx">gender</code><code class="p">;</code>
    <code class="p">});</code>
<code class="c1">//...</code>
<code class="p">}</code></pre>
<p>This dimension now has an efficient ordering of our dataset by the gender field. We can use it like this, to return all objects with gender female:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="s1">'female'</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO14-1" id="co_building_a_visualization_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="kd">var</code><code> </code><code class="nx">femaleWinners</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code><code class="p">.</code><code class="nx">top</code><code class="p">(</code><code class="kc">Infinity</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO14-2" id="co_building_a_visualization_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="nx">femaleWinners</code><code class="p">.</code><code class="nx">length</code><code> </code><code class="c1">// 47</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO14-1" id="callout_building_a_visualization_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p><code>filter</code> takes a single value or, where appropriate, a range (e.g., [5, 21]—all values between 5 and 21). It can also take a Boolean function of the values.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO14-2" id="callout_building_a_visualization_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Once the filter is applied, <code>top</code> returns the specified number of ordered objects. Specifying <code>Infinity</code><sup><a data-type="noteref" href="ch16.xhtml#idm45607748487088" id="idm45607748487088-marker">9</a></sup> returns all the filtered data objects.</p></dd>
</dl>
<p>Crossfilter really comes into its own when we start applying multiple dimensional filters, allowing us to slice and dice the data into any subsets we require, all achieved with impressive speed.<sup><a data-type="noteref" href="ch16.xhtml#idm45607748484816" id="idm45607748484816-marker">10</a></sup></p>
<p>Let’s clear the gender dimension and add a new one, filtering by prize-winning category. To reset a dimension,<sup><a data-type="noteref" href="ch16.xhtml#idm45607748454160" id="idm45607748454160-marker">11</a></sup> apply the <code>filter</code> method without arguments:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code><code class="p">.</code><code class="nx">filter</code><code class="p">();</code>
<code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code><code class="p">.</code><code class="nx">top</code><code class="p">(</code><code class="kc">Infinity</code><code class="p">)</code> <code class="c1">//  the full Array[858] of objects</code></pre>
<p class="pagebreak-before">We’ll now create a new prize category dimension:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryDim</code> <code class="o">=</code> <code class="nx">nbviz</code><code class="p">.</code><code class="nx">filter</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">o</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">o</code><code class="p">.</code><code class="nx">category</code><code class="p">;</code>
<code class="p">});</code></pre>
<p>We can now filter the gender and category dimensions in sequence, allowing us to find, for example, all female Physics prize winners:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="s1">'female'</code><code class="p">);</code>
<code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryDim</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="s1">'Physics'</code><code class="p">);</code>
<code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code><code class="p">.</code><code class="nx">top</code><code class="p">(</code><code class="kc">Infinity</code><code class="p">);</code>
<code class="c1">// Out:</code>
<code class="c1">// [</code>
<code class="c1">//  {name:"Marie Sklodowska-Curie", category:"Physics",...</code>
<code class="c1">//  {name:"Maria Goeppert-Mayer", category:"Physics",...</code>
<code class="c1">// ]</code></pre>
<p>Note that we can turn the filters on and off selectively. So, for example, we can remove the Physics category filter, meaning the gender dimension now contains all the female Nobel Prize winners:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryDim</code><code class="p">.</code><code class="nx">filter</code><code class="p">();</code>
<code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code><code class="p">.</code><code class="nx">top</code><code class="p">(</code><code class="kc">Infinity</code><code class="p">);</code> <code class="c1">// Array[47] of objects</code></pre>
<p>In our Nobel-viz, these filter operations will be driven by the user making selections from the topmost menu bar.</p>
<p>As well as returning the filtered subsets, Crossfilter can perform grouping operations on the data. We use this to get the national prize aggregates for the bar chart and map indicators:</p>
<pre data-code-language="js" data-type="programlisting"><code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><code class="c1">// reset gender dimension
</code><code class="kd">var</code><code> </code><code class="nx">countryGroup</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">countryDim</code><code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO15-1" id="co_building_a_visualization_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="nx">countryGroup</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_building_a_visualization_CO15-2" id="co_building_a_visualization_CO15-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>

</code><code class="c1">// Out:
</code><code class="c1">// [
</code><code class="c1">//  {key:"Argentina", value:5}, </code><a class="co" href="#callout_building_a_visualization_CO15-3" id="co_building_a_visualization_CO15-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="c1">
</code><code class="c1">//  {key:"Australia", value:9},
</code><code class="c1">//  {key:"Austria", value:14},
</code><code class="c1">// ...]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO15-1" id="callout_building_a_visualization_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Group takes an optional function as an argument, but the default is generally what you want.</p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO15-2" id="callout_building_a_visualization_CO15-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Returns all groups by key and value. Do not modify the returned array.<sup><a data-type="noteref" href="ch16.xhtml#idm45607748238000" id="idm45607748238000-marker">12</a></sup></p></dd>
<dt><a class="co" href="#co_building_a_visualization_CO15-3" id="callout_building_a_visualization_CO15-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p><code>value</code> is the total number of Nobel Prize winners for Argentina.</p></dd>
</dl>
<p>To create our Crossfilter filter and dimensions, we use the <code>makeFilterAndDimensions</code> method, defined in <em>nbviz_core.js</em>. <a data-type="xref" href="#makeFilterAndDims">Example 16-7</a> shows the whole method. Note that the order in which the filters are created isn’t important—their intersection will still be the same.</p>
<div data-type="example" id="makeFilterAndDims">
<h5><span class="label">Example 16-7. </span>Making our Crossfilter filter and dimensions</h5>
<pre data-code-language="js" data-type="programlisting"><code>    </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">makeFilterAndDimensions</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">winnersData</code><code class="p">)</code><code class="p">{</code><code>
        </code><code class="c1">// ADD OUR FILTER AND CREATE CATEGORY DIMENSIONS
</code><code>        </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">filter</code><code> </code><code class="o">=</code><code> </code><code class="nx">crossfilter</code><code class="p">(</code><code class="nx">winnersData</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">countryDim</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">filter</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">o</code><code class="p">)</code><code class="p">{</code><code> </code><a class="co" href="#callout_building_a_visualization_CO16-1" id="co_building_a_visualization_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
            </code><code class="k">return</code><code> </code><code class="nx">o</code><code class="p">.</code><code class="nx">country</code><code class="p">;</code><code>
        </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>

        </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">categoryDim</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">filter</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">o</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="k">return</code><code> </code><code class="nx">o</code><code class="p">.</code><code class="nx">category</code><code class="p">;</code><code>
        </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>

        </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">genderDim</code><code> </code><code class="o">=</code><code> </code><code class="nx">nbviz</code><code class="p">.</code><code class="nx">filter</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">o</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="k">return</code><code> </code><code class="nx">o</code><code class="p">.</code><code class="nx">gender</code><code class="p">;</code><code>
        </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="p">}</code><code class="p">;</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_building_a_visualization_CO16-1" id="callout_building_a_visualization_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We’re using the full JavaScript functions for teaching clarity, but these days the shortened form would likely be used: <code>o =&gt; o.country</code>.<a data-primary="building a visualization" data-secondary="JavaScript" data-startref="ix_bldvisJSfltr" data-tertiary="filtering data with Crossfilter" data-type="indexterm" id="idm45607748103296"/><a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-startref="ix_JSNPvisfltr" data-tertiary="filtering data with Crossfilter" data-type="indexterm" id="idm45607748101808"/><a data-primary="Crossfilter" data-startref="ix_Crssfil" data-type="indexterm" id="idm45607748100064"/><a data-primary="filtering data" data-secondary="using Crossfilter" data-startref="ix_fltrCrss" data-type="indexterm" id="idm45607748099120"/></p></dd>
</dl>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="Running the Nobel Prize Visualization App" data-type="sect1"><div class="sect1" id="idm45607750040192">
<h1>Running the Nobel Prize Visualization App</h1>
<p>To run the Nobel visualization we need a web server that can access the root <em>index.xhtml</em> file. <a data-primary="JavaScript" data-secondary="for Nobel Prize web visualization" data-secondary-sortas="Nobel" data-startref="ix_JSNPvis" data-type="indexterm" id="idm45607748096368"/>For development purposes we can make use of Python’s built-in <code>http</code> module to kick off the required server.<a data-primary="building a visualization" data-secondary="running the Nobel Prize visualization app" data-type="indexterm" id="idm45607748050224"/><a data-primary="running visualization app" data-type="indexterm" id="idm45607748049376"/> In the root directory containing our index file, run:</p>
<pre data-type="programlisting">$ python -m http.server 8080
Serving HTTP on 0.0.0.0 port 8080 ...</pre>
<p>Now open up a browser window and go to <em>http:localhost:8080</em> and you should see <a data-type="xref" href="#d3build_nobelviz">Figure 16-4</a>.</p>
<figure><div class="figure" id="d3build_nobelviz">
<img alt="dpj2 1604" height="845" src="assets/dpj2_1604.png" width="1001"/>
<h6><span class="label">Figure 16-4. </span>The finished Nobel-viz app</h6>
</div></figure>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45607748044064">
<h1>Summary</h1>
<p>In this chapter, we sketched out how to implement the visualization we imagined in <a data-type="xref" href="ch15.xhtml#chapter_imagining">Chapter 15</a>. The backbone was assembled from HTML, CSS, and JavaScript building blocks, and the data feed to the app and data flow within it described. In the following chapters, we’ll see how the individual components of our Nobel-viz use the data sent to them to create our interactive visualization. We’ll start with a big chapter, which will introduce the fundamentals of D3 while showing how to build the bar chart component of our app. This should set you up for the subsequent D3-focused chapters.<a data-primary="building a visualization" data-startref="ix_bldvis" data-type="indexterm" id="idm45607748041904"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45607751186112"><sup><a href="ch16.xhtml#idm45607751186112-marker">1</a></sup> See these <a href="https://oreil.ly/ngdOJ">SpeedCurve</a> and <a href="https://oreil.ly/qIvox">Web Almanac</a> posts for some analysis of average web page size.</p><p data-type="footnote" id="idm45607751164464"><sup><a href="ch16.xhtml#idm45607751164464-marker">2</a></sup> I would advise saving JavaScripted styling for special occasions, doing as much as possible with vanilla CSS.</p><p data-type="footnote" id="idm45607750526128"><sup><a href="ch16.xhtml#idm45607750526128-marker">3</a></sup> Currently around 2,560×1,600 pixels.</p><p data-type="footnote" id="idm45607750213296"><sup><a href="ch16.xhtml#idm45607750213296-marker">4</a></sup> See <a data-type="xref" href="ch19.xhtml#sect_projections">“Projections”</a> for a comparison of the different geometric projections. Given the constraint of showing all Nobel Prize–winning countries, the equirectangular projection proved most effective.</p><p data-type="footnote" id="idm45607749985552"><sup><a href="ch16.xhtml#idm45607749985552-marker">5</a></sup> See the collection at <a href="https://oreil.ly/khvac">D3’s GitHub</a>.</p><p data-type="footnote" id="idm45607749683584"><sup><a href="ch16.xhtml#idm45607749683584-marker">6</a></sup> In our app, I’m keeping things as simple as possible; as the number of UI options increases, it’s sensible to store flags, ranges, etc. in a dedicated object.</p><p data-type="footnote" id="idm45607749511824"><sup><a href="ch16.xhtml#idm45607749511824-marker">7</a></sup> You can read more about <code>Promise.all</code> in the <a href="https://oreil.ly/67Odo">Mozilla documentation</a>.</p><p data-type="footnote" id="idm45607748719440"><sup><a href="ch16.xhtml#idm45607748719440-marker">8</a></sup> See this <a href="https://square.github.io/crossfilter">Square page</a> for an impressive example.</p><p data-type="footnote" id="idm45607748487088"><sup><a href="ch16.xhtml#idm45607748487088-marker">9</a></sup> JavaScript’s <a href="https://oreil.ly/Ll5xV"><code>Infinity</code></a> is a numeric value representing infinity.</p><p data-type="footnote" id="idm45607748484816"><sup><a href="ch16.xhtml#idm45607748484816-marker">10</a></sup> Crossfilter was designed to update millions of records in real time, in response to user input.</p><p data-type="footnote" id="idm45607748454160"><sup><a href="ch16.xhtml#idm45607748454160-marker">11</a></sup> This will clear all the filters on this dimension.</p><p data-type="footnote" id="idm45607748238000"><sup><a href="ch16.xhtml#idm45607748238000-marker">12</a></sup> See the <a href="https://oreil.ly/saEpG">Crossfilter GitHub page</a>.</p></div></div></section></div></body></html>