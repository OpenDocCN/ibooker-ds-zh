<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 21. Pivot Tables" data-type="chapter" epub:type="chapter"><div class="chapter" id="section-0309-pivot-tables">
<h1><span class="label">Chapter 21. </span>Pivot Tables</h1>
<p><a data-primary="Pandas" data-secondary="pivot tables" data-type="indexterm" id="ix_ch21-asciidoc0"/><a data-primary="pivot tables" data-type="indexterm" id="ix_ch21-asciidoc1"/>We <a data-primary="groupby() operation (Pandas)" data-secondary="pivot tables versus" data-type="indexterm" id="idm45858773062544"/><a data-primary="pivot tables" data-secondary="groupby() operation versus" data-type="indexterm" id="idm45858773061600"/>have seen how the <code>groupby</code> abstraction lets us explore relationships
within a dataset. A <em>pivot table</em> is a similar operation that is
commonly seen in spreadsheets and other programs that operate on tabular
data. The pivot table takes simple column-wise data as input, and groups
the entries into a two-dimensional table that provides a
multidimensional summarization of the data. <a data-primary="GroupBy aggregation" data-type="indexterm" id="idm45858773059728"/>The difference between pivot
tables and <code>groupby</code> can sometimes cause confusion; it helps me to think
of pivot tables as essentially a <em>multidimensional</em> version of <code>groupby</code>
aggregation. That is, you split-apply-combine, but both the split and
the combine happen across not a one-dimensional index, but across a
two-dimensional grid.</p>
<section data-pdf-bookmark="Motivating Pivot Tables" data-type="sect1"><div class="sect1" id="ch_0309-pivot-tables_motivating-pivot-tables">
<h1>Motivating Pivot Tables</h1>
<p><a data-primary="pivot tables" data-secondary="Titanic passengers example" data-type="indexterm" id="idm45858773055776"/>For the examples in this section, we’ll use the database of
passengers on the <em>Titanic</em>, available through the Seaborn library (see
<a data-type="xref" href="ch36.xhtml#section-0414-visualization-with-seaborn">Chapter 36</a>):</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">numpy</code> <code class="k">as</code> <code class="nn">np</code>
        <code class="kn">import</code> <code class="nn">pandas</code> <code class="k">as</code> <code class="nn">pd</code>
        <code class="kn">import</code> <code class="nn">seaborn</code> <code class="k">as</code> <code class="nn">sns</code>
        <code class="n">titanic</code> <code class="o">=</code> <code class="n">sns</code><code class="o">.</code><code class="n">load_dataset</code><code class="p">(</code><code class="s1">'titanic'</code><code class="p">)</code></pre>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">titanic</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">2</code><code class="p">]:</code>    <code class="n">survived</code>  <code class="n">pclass</code>     <code class="n">sex</code>   <code class="n">age</code>  <code class="n">sibsp</code>  <code class="n">parch</code>     <code class="n">fare</code> <code class="n">embarked</code>  <code class="k">class</code>  \
        <code class="err">0         0       3    </code><code class="nc">male</code>  <code class="mf">22.0</code>      <code class="mi">1</code>      <code class="mi">0</code>   <code class="mf">7.2500</code>        <code class="n">S</code>  <code class="n">Third</code>
        <code class="mi">1</code>         <code class="mi">1</code>       <code class="mi">1</code>  <code class="n">female</code>  <code class="mf">38.0</code>      <code class="mi">1</code>      <code class="mi">0</code>  <code class="mf">71.2833</code>        <code class="n">C</code>  <code class="n">First</code>
        <code class="mi">2</code>         <code class="mi">1</code>       <code class="mi">3</code>  <code class="n">female</code>  <code class="mf">26.0</code>      <code class="mi">0</code>      <code class="mi">0</code>   <code class="mf">7.9250</code>        <code class="n">S</code>  <code class="n">Third</code>
        <code class="mi">3</code>         <code class="mi">1</code>       <code class="mi">1</code>  <code class="n">female</code>  <code class="mf">35.0</code>      <code class="mi">1</code>      <code class="mi">0</code>  <code class="mf">53.1000</code>        <code class="n">S</code>  <code class="n">First</code>
        <code class="mi">4</code>         <code class="mi">0</code>       <code class="mi">3</code>    <code class="n">male</code>  <code class="mf">35.0</code>      <code class="mi">0</code>      <code class="mi">0</code>   <code class="mf">8.0500</code>        <code class="n">S</code>  <code class="n">Third</code></pre>
<pre class="pagebreak-before less_space" data-code-language="ipython" data-type="programlisting">             <code class="n">who</code>  <code class="n">adult_male</code> <code class="n">deck</code>  <code class="n">embark_town</code> <code class="n">alive</code>  <code class="n">alone</code>
        <code class="mi">0</code>    <code class="n">man</code>        <code class="kc">True</code>  <code class="n">NaN</code>  <code class="n">Southampton</code>    <code class="n">no</code>  <code class="kc">False</code>
        <code class="mi">1</code>  <code class="n">woman</code>       <code class="kc">False</code>    <code class="n">C</code>    <code class="n">Cherbourg</code>   <code class="n">yes</code>  <code class="kc">False</code>
        <code class="mi">2</code>  <code class="n">woman</code>       <code class="kc">False</code>  <code class="n">NaN</code>  <code class="n">Southampton</code>   <code class="n">yes</code>   <code class="kc">True</code>
        <code class="mi">3</code>  <code class="n">woman</code>       <code class="kc">False</code>    <code class="n">C</code>  <code class="n">Southampton</code>   <code class="n">yes</code>  <code class="kc">False</code>
        <code class="mi">4</code>    <code class="n">man</code>        <code class="kc">True</code>  <code class="n">NaN</code>  <code class="n">Southampton</code>    <code class="n">no</code>   <code class="kc">True</code></pre>
<p>As the output shows, this contains a number of data points on each
passenger on that ill-fated voyage, including sex, age, class, fare
paid, and much more.</p>
</div></section>
<section data-pdf-bookmark="Pivot Tables by Hand" data-type="sect1"><div class="sect1" id="ch_0309-pivot-tables_pivot-tables-by-hand">
<h1>Pivot Tables by Hand</h1>
<p>To start learning more about this data, we might begin by grouping
according to sex, survival status, or some combination thereof. If
you read the previous chapter, you might be tempted to apply a <code>groupby</code>
operation—for example, let’s look at survival rate by
sex:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="n">titanic</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s1">'sex'</code><code class="p">)[[</code><code class="s1">'survived'</code><code class="p">]]</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">3</code><code class="p">]:</code>         <code class="n">survived</code>
        <code class="n">sex</code>
        <code class="n">female</code>  <code class="mf">0.742038</code>
        <code class="n">male</code>    <code class="mf">0.188908</code></pre>
<p>This gives us some initial insight: overall, three of every four females
on board survived, while only one in five males survived!</p>
<p>This is useful, but we might like to go one step deeper and look at
survival rates by both sex and, say, class. Using the vocabulary of
<code>groupby</code>, we might proceed using a process like this: we first <em>group
by</em> class and sex, then <em>select</em> survival, <em>apply</em> a mean aggregate,
<em>combine</em> the resulting groups, and finally <em>unstack</em> the hierarchical
index to reveal the hidden multidimensionality. In code:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="n">titanic</code><code class="o">.</code><code class="n">groupby</code><code class="p">([</code><code class="s1">'sex'</code><code class="p">,</code> <code class="s1">'class'</code><code class="p">])[</code><code class="s1">'survived'</code><code class="p">]</code><code class="o">.</code><code class="n">aggregate</code><code class="p">(</code><code class="s1">'mean'</code><code class="p">)</code><code class="o">.</code><code class="n">unstack</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="k">class</code>      <code class="nc">First</code>    <code class="n">Second</code>     <code class="n">Third</code>
        <code class="n">sex</code>
        <code class="n">female</code>  <code class="mf">0.968085</code>  <code class="mf">0.921053</code>  <code class="mf">0.500000</code>
        <code class="n">male</code>    <code class="mf">0.368852</code>  <code class="mf">0.157407</code>  <code class="mf">0.135447</code></pre>
<p>This gives us a better idea of how both sex and class affected
survival, but the code is starting to look a bit garbled. While each
step of this pipeline makes sense in light of the tools
we’ve previously discussed, the long string of code is not
particularly easy to read or use. This two-dimensional <code>groupby</code> is
common enough that Pandas includes a convenience routine, <code>pivot_table</code>,
which succinctly handles this type of multidi⁠mensional aggregation.</p>
</div></section>
<section class="pagebreak-before less_space" data-pdf-bookmark="Pivot Table Syntax" data-type="sect1"><div class="sect1" id="ch_0309-pivot-tables_pivot-table-syntax">
<h1>Pivot Table Syntax</h1>
<p><a data-primary="pivot tables" data-secondary="syntax" data-type="indexterm" id="ix_ch21-asciidoc2"/>Here is the equivalent to the preceding operation using the
<code>DataFrame.pivot_table</code> method:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">5</code><code class="p">]:</code> <code class="n">titanic</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code><code class="s1">'survived'</code><code class="p">,</code> <code class="n">index</code><code class="o">=</code><code class="s1">'sex'</code><code class="p">,</code> <code class="n">columns</code><code class="o">=</code><code class="s1">'class'</code><code class="p">,</code> <code class="n">aggfunc</code><code class="o">=</code><code class="s1">'mean'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">5</code><code class="p">]:</code> <code class="k">class</code>      <code class="nc">First</code>    <code class="n">Second</code>     <code class="n">Third</code>
        <code class="n">sex</code>
        <code class="n">female</code>  <code class="mf">0.968085</code>  <code class="mf">0.921053</code>  <code class="mf">0.500000</code>
        <code class="n">male</code>    <code class="mf">0.368852</code>  <code class="mf">0.157407</code>  <code class="mf">0.135447</code></pre>
<p>This is eminently more readable than the manual <code>groupby</code> approach, and
produces the same result. As you might expect of an early 20th-century
transatlantic cruise, the survival gradient favors both higher
classes and people recorded as females in the data. First-class females survived with near certainty (hi, Rose!),
while only one in eight or so third-class males survived (sorry, Jack!).</p>
<section data-pdf-bookmark="Multilevel Pivot Tables" data-type="sect2"><div class="sect2" id="ch_0309-pivot-tables_multilevel-pivot-tables">
<h2>Multilevel Pivot Tables</h2>
<p><a data-primary="pivot tables" data-secondary="multi-level" data-type="indexterm" id="idm45858772602896"/>Just as in a <code>groupby</code>, the grouping in pivot tables can be specified
with multiple levels and via a number of options. For example, we might
be interested in looking at age as a third dimension. We’ll
bin the age using the <code>pd.cut</code> function:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">6</code><code class="p">]:</code> <code class="n">age</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">cut</code><code class="p">(</code><code class="n">titanic</code><code class="p">[</code><code class="s1">'age'</code><code class="p">],</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">80</code><code class="p">])</code>
        <code class="n">titanic</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code><code class="s1">'survived'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'sex'</code><code class="p">,</code> <code class="n">age</code><code class="p">],</code> <code class="s1">'class'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">6</code><code class="p">]:</code> <code class="k">class</code>               <code class="nc">First</code>    <code class="n">Second</code>     <code class="n">Third</code>
        <code class="n">sex</code>    <code class="n">age</code>
        <code class="n">female</code> <code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">18</code><code class="p">]</code>   <code class="mf">0.909091</code>  <code class="mf">1.000000</code>  <code class="mf">0.511628</code>
               <code class="p">(</code><code class="mi">18</code><code class="p">,</code> <code class="mi">80</code><code class="p">]</code>  <code class="mf">0.972973</code>  <code class="mf">0.900000</code>  <code class="mf">0.423729</code>
        <code class="n">male</code>   <code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">18</code><code class="p">]</code>   <code class="mf">0.800000</code>  <code class="mf">0.600000</code>  <code class="mf">0.215686</code>
               <code class="p">(</code><code class="mi">18</code><code class="p">,</code> <code class="mi">80</code><code class="p">]</code>  <code class="mf">0.375000</code>  <code class="mf">0.071429</code>  <code class="mf">0.133663</code></pre>
<p>We can apply the same strategy when working with the columns as well;
let’s add info on the fare paid, using <code>pd.qcut</code> to
automatically compute quantiles:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">7</code><code class="p">]:</code> <code class="n">fare</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">qcut</code><code class="p">(</code><code class="n">titanic</code><code class="p">[</code><code class="s1">'fare'</code><code class="p">],</code> <code class="mi">2</code><code class="p">)</code>
        <code class="n">titanic</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code><code class="s1">'survived'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'sex'</code><code class="p">,</code> <code class="n">age</code><code class="p">],</code> <code class="p">[</code><code class="n">fare</code><code class="p">,</code> <code class="s1">'class'</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">7</code><code class="p">]:</code> <code class="n">fare</code>            <code class="p">(</code><code class="o">-</code><code class="mf">0.001</code><code class="p">,</code> <code class="mf">14.454</code><code class="p">]</code>                     <code class="p">(</code><code class="mf">14.454</code><code class="p">,</code> <code class="mf">512.329</code><code class="p">]</code>  \
        <code class="k">class</code>                      <code class="nc">First</code>    <code class="n">Second</code>     <code class="n">Third</code>             <code class="n">First</code>
        <code class="n">sex</code>    <code class="n">age</code>
        <code class="n">female</code> <code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">18</code><code class="p">]</code>               <code class="n">NaN</code>  <code class="mf">1.000000</code>  <code class="mf">0.714286</code>          <code class="mf">0.909091</code>
               <code class="p">(</code><code class="mi">18</code><code class="p">,</code> <code class="mi">80</code><code class="p">]</code>              <code class="n">NaN</code>  <code class="mf">0.880000</code>  <code class="mf">0.444444</code>          <code class="mf">0.972973</code>
        <code class="n">male</code>   <code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">18</code><code class="p">]</code>               <code class="n">NaN</code>  <code class="mf">0.000000</code>  <code class="mf">0.260870</code>          <code class="mf">0.800000</code>
               <code class="p">(</code><code class="mi">18</code><code class="p">,</code> <code class="mi">80</code><code class="p">]</code>              <code class="mf">0.0</code>  <code class="mf">0.098039</code>  <code class="mf">0.125000</code>          <code class="mf">0.391304</code>

        <code class="n">fare</code>
        <code class="k">class</code>              <code class="nc">Second</code>     <code class="n">Third</code>
        <code class="n">sex</code>    <code class="n">age</code>
        <code class="n">female</code> <code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">18</code><code class="p">]</code>   <code class="mf">1.000000</code>  <code class="mf">0.318182</code>
               <code class="p">(</code><code class="mi">18</code><code class="p">,</code> <code class="mi">80</code><code class="p">]</code>  <code class="mf">0.914286</code>  <code class="mf">0.391304</code>
        <code class="n">male</code>   <code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">18</code><code class="p">]</code>   <code class="mf">0.818182</code>  <code class="mf">0.178571</code>
               <code class="p">(</code><code class="mi">18</code><code class="p">,</code> <code class="mi">80</code><code class="p">]</code>  <code class="mf">0.030303</code>  <code class="mf">0.192308</code></pre>
<p>The result is a four-dimensional aggregation with hierarchical indices
(see <a data-type="xref" href="ch17.xhtml#section-0305-hierarchical-indexing">Chapter 17</a>),
shown in a grid demonstrating the relationship between the values.</p>
</div></section>
<section data-pdf-bookmark="Additional Pivot Table Options" data-type="sect2"><div class="sect2" id="ch_0309-pivot-tables_additional-pivot-table-options">
<h2>Additional Pivot Table Options</h2>
<p>The full call signature of the <code>DataFrame.pivot_table</code> method is as
follows:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># call signature as of Pandas 1.3.5</code>
<code class="n">DataFrame</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">values</code><code class="o">=</code><code class="kc">None</code><code class="p">,</code> <code class="n">index</code><code class="o">=</code><code class="kc">None</code><code class="p">,</code> <code class="n">columns</code><code class="o">=</code><code class="kc">None</code><code class="p">,</code>
                      <code class="n">aggfunc</code><code class="o">=</code><code class="s1">'mean'</code><code class="p">,</code> <code class="n">fill_value</code><code class="o">=</code><code class="kc">None</code><code class="p">,</code> <code class="n">margins</code><code class="o">=</code><code class="kc">False</code><code class="p">,</code>
                      <code class="n">dropna</code><code class="o">=</code><code class="kc">True</code><code class="p">,</code> <code class="n">margins_name</code><code class="o">=</code><code class="s1">'All'</code><code class="p">,</code> <code class="n">observed</code><code class="o">=</code><code class="kc">False</code><code class="p">,</code>
                      <code class="n">sort</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre>
<p>We’ve already seen examples of the first three arguments;
here we’ll look at some of the remaining ones.
Two of the options, <code>fill_value</code> and <code>dropna</code>, have to do with missing
data and are fairly straightforward; I will not show examples of them
here.</p>
<p>The <code>aggfunc</code> keyword controls what type of aggregation is applied,
which is a mean by default. As with <code>groupby</code>, the aggregation
specification can be a string representing one of several common choices
(<code>'sum'</code>, <code>'mean'</code>,
<code>'count'</code>, <code>'min'</code>,
<code>'max'</code>, etc.) or a function that implements an
aggregation (e.g., <code>np.sum()</code>, <code>min()</code>, <code>sum()</code>, etc.). Additionally, it
can be specified as a dictionary mapping a column to any of the desired
options:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">8</code><code class="p">]:</code> <code class="n">titanic</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code><code class="n">index</code><code class="o">=</code><code class="s1">'sex'</code><code class="p">,</code> <code class="n">columns</code><code class="o">=</code><code class="s1">'class'</code><code class="p">,</code>
                            <code class="n">aggfunc</code><code class="o">=</code><code class="p">{</code><code class="s1">'survived'</code><code class="p">:</code><code class="nb">sum</code><code class="p">,</code> <code class="s1">'fare'</code><code class="p">:</code><code class="s1">'mean'</code><code class="p">})</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">8</code><code class="p">]:</code>               <code class="n">fare</code>                       <code class="n">survived</code>
        <code class="k">class</code>        <code class="nc">First</code>     <code class="n">Second</code>      <code class="n">Third</code>    <code class="n">First</code> <code class="n">Second</code> <code class="n">Third</code>
        <code class="n">sex</code>
        <code class="n">female</code>  <code class="mf">106.125798</code>  <code class="mf">21.970121</code>  <code class="mf">16.118810</code>       <code class="mi">91</code>     <code class="mi">70</code>    <code class="mi">72</code>
        <code class="n">male</code>     <code class="mf">67.226127</code>  <code class="mf">19.741782</code>  <code class="mf">12.661633</code>       <code class="mi">45</code>     <code class="mi">17</code>    <code class="mi">47</code></pre>
<p>Notice also here that we’ve omitted the <code>values</code> keyword;
when specifying a mapping for <code>aggfunc</code>, this is determined
automatically.</p>
<p>At times it’s useful to compute totals along each grouping.
This can be done via the <code>margins</code> keyword:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="n">titanic</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code><code class="s1">'survived'</code><code class="p">,</code> <code class="n">index</code><code class="o">=</code><code class="s1">'sex'</code><code class="p">,</code> <code class="n">columns</code><code class="o">=</code><code class="s1">'class'</code><code class="p">,</code> <code class="n">margins</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="k">class</code>      <code class="nc">First</code>    <code class="n">Second</code>     <code class="n">Third</code>       <code class="n">All</code>
        <code class="n">sex</code>
        <code class="n">female</code>  <code class="mf">0.968085</code>  <code class="mf">0.921053</code>  <code class="mf">0.500000</code>  <code class="mf">0.742038</code>
        <code class="n">male</code>    <code class="mf">0.368852</code>  <code class="mf">0.157407</code>  <code class="mf">0.135447</code>  <code class="mf">0.188908</code>
        <code class="n">All</code>     <code class="mf">0.629630</code>  <code class="mf">0.472826</code>  <code class="mf">0.242363</code>  <code class="mf">0.383838</code></pre>
<p>Here, this automatically gives us information about the class-agnostic
survival rate by sex, the sex-agnostic survival rate by class, and
the overall survival rate of 38%. The margin label can be specified with
the <code>margins_name</code> keyword; it defaults to <code>"All"</code>.<a data-startref="ix_ch21-asciidoc2" data-type="indexterm" id="idm45858772049744"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Example: Birthrate Data" data-type="sect1"><div class="sect1" id="ch_0309-pivot-tables_example-birthrate-data">
<h1>Example: Birthrate Data</h1>
<p><a data-primary="pivot tables" data-secondary="US birthrate data example" data-type="indexterm" id="ix_ch21-asciidoc3"/>As another example, let’s take a look at the freely
available <a href="https://oreil.ly/2NWnk">data on births in the US</a>, provided by the Centers
for Disease Control (CDC). (This dataset has been analyzed rather extensively by Andrew Gelman and
his group; see, for example, the
<a href="https://oreil.ly/5EqEp">blog
post on signal processing using Gaussian processes</a>):<sup><a data-type="noteref" href="ch21.xhtml#idm45858772021024" id="idm45858772021024-marker">1</a></sup></p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">10</code><code class="p">]:</code> <code class="c1"># shell command to download the data:</code>
         <code class="c1"># !cd data &amp;&amp; curl -O \</code>
         <code class="c1"># https://raw.githubusercontent.com/jakevdp/data-CDCbirths/master/births.csv</code></pre>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">11</code><code class="p">]:</code> <code class="n">births</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'data/births.csv'</code><code class="p">)</code></pre>
<p>Taking a look at the data, we see that it’s relatively
simple—it contains the number of births grouped by date and gender:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">12</code><code class="p">]:</code> <code class="n">births</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">12</code><code class="p">]:</code>    <code class="n">year</code>  <code class="n">month</code>  <code class="n">day</code> <code class="n">gender</code>  <code class="n">births</code>
         <code class="mi">0</code>  <code class="mi">1969</code>      <code class="mi">1</code>  <code class="mf">1.0</code>      <code class="n">F</code>    <code class="mi">4046</code>
         <code class="mi">1</code>  <code class="mi">1969</code>      <code class="mi">1</code>  <code class="mf">1.0</code>      <code class="n">M</code>    <code class="mi">4440</code>
         <code class="mi">2</code>  <code class="mi">1969</code>      <code class="mi">1</code>  <code class="mf">2.0</code>      <code class="n">F</code>    <code class="mi">4454</code>
         <code class="mi">3</code>  <code class="mi">1969</code>      <code class="mi">1</code>  <code class="mf">2.0</code>      <code class="n">M</code>    <code class="mi">4548</code>
         <code class="mi">4</code>  <code class="mi">1969</code>      <code class="mi">1</code>  <code class="mf">3.0</code>      <code class="n">F</code>    <code class="mi">4548</code></pre>
<p>We can start to understand this data a bit more by using a pivot table.
Let’s add a <code>decade</code> column, and take a look at male and
female births as a function of decade:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">13</code><code class="p">]:</code> <code class="n">births</code><code class="p">[</code><code class="s1">'decade'</code><code class="p">]</code> <code class="o">=</code> <code class="mi">10</code> <code class="o">*</code> <code class="p">(</code><code class="n">births</code><code class="p">[</code><code class="s1">'year'</code><code class="p">]</code> <code class="o">//</code> <code class="mi">10</code><code class="p">)</code>
         <code class="n">births</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code><code class="s1">'births'</code><code class="p">,</code> <code class="n">index</code><code class="o">=</code><code class="s1">'decade'</code><code class="p">,</code> <code class="n">columns</code><code class="o">=</code><code class="s1">'gender'</code><code class="p">,</code>
                            <code class="n">aggfunc</code><code class="o">=</code><code class="s1">'sum'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">13</code><code class="p">]:</code> <code class="n">gender</code>         <code class="n">F</code>         <code class="n">M</code>
         <code class="n">decade</code>
         <code class="mi">1960</code>     <code class="mi">1753634</code>   <code class="mi">1846572</code>
         <code class="mi">1970</code>    <code class="mi">16263075</code>  <code class="mi">17121550</code>
         <code class="mi">1980</code>    <code class="mi">18310351</code>  <code class="mi">19243452</code>
         <code class="mi">1990</code>    <code class="mi">19479454</code>  <code class="mi">20420553</code>
         <code class="mi">2000</code>    <code class="mi">18229309</code>  <code class="mi">19106428</code></pre>
<p>We see that male births outnumber female births in every decade. To see
this trend a bit more clearly, we can use the built-in plotting tools in
Pandas to visualize the total number of births by year, as shown in <a data-type="xref" href="#fig_0309-pivot-tables_files_in_output_33_0">Figure 21-1</a> (see
<a data-type="xref" href="part04.xhtml#section-0400-introduction-to-matplotlib">Part IV</a>
for a discussion of plotting with Matplotlib):</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">14</code><code class="p">]:</code> <code class="o">%</code><code class="k">matplotlib</code> inline
         <code class="kn">import</code> <code class="nn">matplotlib.pyplot</code> <code class="k">as</code> <code class="nn">plt</code>
         <code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'seaborn-whitegrid'</code><code class="p">)</code>
         <code class="n">births</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code>
             <code class="s1">'births'</code><code class="p">,</code> <code class="n">index</code><code class="o">=</code><code class="s1">'year'</code><code class="p">,</code> <code class="n">columns</code><code class="o">=</code><code class="s1">'gender'</code><code class="p">,</code> <code class="n">aggfunc</code><code class="o">=</code><code class="s1">'sum'</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">()</code>
         <code class="n">plt</code><code class="o">.</code><code class="n">ylabel</code><code class="p">(</code><code class="s1">'total births per year'</code><code class="p">);</code></pre>
<figure><div class="figure" id="fig_0309-pivot-tables_files_in_output_33_0">
<img alt="output 33 0" height="392" src="assets/output_33_0.png" width="600"/>
<h6><span class="label">Figure 21-1. </span>Total number of US births by year and gender<sup><a data-type="noteref" href="ch21.xhtml#idm45858771699920" id="idm45858771699920-marker">2</a></sup></h6>
</div></figure>
<p>With a simple pivot table and the <code>plot</code> method, we can immediately see
the annual trend in births by gender. By eye, it appears that over the
past 50 years male births have outnumbered female births by around 5%.</p>
<p>Though this doesn’t necessarily relate to the pivot table,
there are a few more interesting features we can pull out of this
dataset using the Pandas tools covered up to this point. We must start
by cleaning the data a bit, removing outliers caused by mistyped dates
(e.g., June 31st) or missing values (e.g., June 99th). One easy way to
remove these all at once is to cut outliers; we’ll do this
via a robust sigma-clipping operation:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">15</code><code class="p">]:</code> <code class="n">quartiles</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">births</code><code class="p">[</code><code class="s1">'births'</code><code class="p">],</code> <code class="p">[</code><code class="mi">25</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">75</code><code class="p">])</code>
         <code class="n">mu</code> <code class="o">=</code> <code class="n">quartiles</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>
         <code class="n">sig</code> <code class="o">=</code> <code class="mf">0.74</code> <code class="o">*</code> <code class="p">(</code><code class="n">quartiles</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code> <code class="o">-</code> <code class="n">quartiles</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code></pre>
<p>This final line is a robust estimate of the sample standard deviation,
where the 0.74 comes from the interquartile range of a Gaussian
distribution (you can learn more about sigma-clipping operations in a
book I coauthored with Željko Ivezić, Andrew J. Connolly, and Alexander
Gray <em>Statistics, Data Mining, and Machine Learning in Astronomy</em> (Princeton University
Press)).</p>
<p>With this, we can use the <code>query</code> method (discussed further in
<a data-type="xref" href="ch24.xhtml#section-0312-performance-eval-and-query">Chapter 24</a>) to filter out rows with births outside these
values:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">16</code><code class="p">]:</code> <code class="n">births</code> <code class="o">=</code> <code class="n">births</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s1">'(births &gt; @mu - 5 * @sig) &amp;</code>
                                <code class="p">(</code><code class="n">births</code> <code class="o">&lt;</code> <code class="nd">@mu</code> <code class="o">+</code> <code class="mi">5</code> <code class="o">*</code> <code class="nd">@sig</code><code class="p">)</code><code class="s1">')</code></pre>
<p>Next we set the <code>day</code> column to integers; previously it had been a
string column because some columns in the dataset contained the value
<code>'null'</code>:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">17</code><code class="p">]:</code> <code class="c1"># set 'day' column to integer; it originally was a string due to nulls</code>
         <code class="n">births</code><code class="p">[</code><code class="s1">'day'</code><code class="p">]</code> <code class="o">=</code> <code class="n">births</code><code class="p">[</code><code class="s1">'day'</code><code class="p">]</code><code class="o">.</code><code class="n">astype</code><code class="p">(</code><code class="nb">int</code><code class="p">)</code></pre>
<p>Finally, we can combine the day, month, and year to create a date index
(see <a data-type="xref" href="ch23.xhtml#section-0311-working-with-time-series">Chapter 23</a>). This allows us to quickly compute the weekday corresponding to
each row:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">18</code><code class="p">]:</code> <code class="c1"># create a datetime index from the year, month, day</code>
         <code class="n">births</code><code class="o">.</code><code class="n">index</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">to_datetime</code><code class="p">(</code><code class="mi">10000</code> <code class="o">*</code> <code class="n">births</code><code class="o">.</code><code class="n">year</code> <code class="o">+</code>
                                       <code class="mi">100</code> <code class="o">*</code> <code class="n">births</code><code class="o">.</code><code class="n">month</code> <code class="o">+</code>
                                       <code class="n">births</code><code class="o">.</code><code class="n">day</code><code class="p">,</code> <code class="nb">format</code><code class="o">=</code><code class="s1">'%Y%m</code><code class="si">%d</code><code class="s1">'</code><code class="p">)</code>

         <code class="n">births</code><code class="p">[</code><code class="s1">'dayofweek'</code><code class="p">]</code> <code class="o">=</code> <code class="n">births</code><code class="o">.</code><code class="n">index</code><code class="o">.</code><code class="n">dayofweek</code></pre>
<p>Using this, we can plot births by weekday for several decades (see <a data-type="xref" href="#fig_0309-pivot-tables_files_in_output_44_0">Figure 21-2</a>).</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">19</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">matplotlib.pyplot</code> <code class="k">as</code> <code class="nn">plt</code>
         <code class="kn">import</code> <code class="nn">matplotlib</code> <code class="k">as</code> <code class="nn">mpl</code>

         <code class="n">births</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code><code class="s1">'births'</code><code class="p">,</code> <code class="n">index</code><code class="o">=</code><code class="s1">'dayofweek'</code><code class="p">,</code>
                             <code class="n">columns</code><code class="o">=</code><code class="s1">'decade'</code><code class="p">,</code> <code class="n">aggfunc</code><code class="o">=</code><code class="s1">'mean'</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">()</code>
         <code class="n">plt</code><code class="o">.</code><code class="n">gca</code><code class="p">()</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="n">xticks</code><code class="o">=</code><code class="nb">range</code><code class="p">(</code><code class="mi">7</code><code class="p">),</code>
                       <code class="n">xticklabels</code><code class="o">=</code><code class="p">[</code><code class="s1">'Mon'</code><code class="p">,</code> <code class="s1">'Tues'</code><code class="p">,</code> <code class="s1">'Wed'</code><code class="p">,</code> <code class="s1">'Thurs'</code><code class="p">,</code>
                                    <code class="s1">'Fri'</code><code class="p">,</code> <code class="s1">'Sat'</code><code class="p">,</code> <code class="s1">'Sun'</code><code class="p">])</code>
         <code class="n">plt</code><code class="o">.</code><code class="n">ylabel</code><code class="p">(</code><code class="s1">'mean births by day'</code><code class="p">);</code></pre>
<p>Apparently births are slightly less common on weekends than on weekdays!
Note that the 1990s and 2000s are missing because starting in 1989, the
CDC data contains only the month of birth.</p>
<p>Another interesting view is to plot the mean number of births by the day
of the year. Let’s first group the data by month and day
separately:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">20</code><code class="p">]:</code> <code class="n">births_by_date</code> <code class="o">=</code> <code class="n">births</code><code class="o">.</code><code class="n">pivot_table</code><code class="p">(</code><code class="s1">'births'</code><code class="p">,</code>
                                             <code class="p">[</code><code class="n">births</code><code class="o">.</code><code class="n">index</code><code class="o">.</code><code class="n">month</code><code class="p">,</code> <code class="n">births</code><code class="o">.</code><code class="n">index</code><code class="o">.</code><code class="n">day</code><code class="p">])</code>
         <code class="n">births_by_date</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">20</code><code class="p">]:</code>        <code class="n">births</code>
         <code class="mi">1</code> <code class="mi">1</code>  <code class="mf">4009.225</code>
           <code class="mi">2</code>  <code class="mf">4247.400</code>
           <code class="mi">3</code>  <code class="mf">4500.900</code>
           <code class="mi">4</code>  <code class="mf">4571.350</code>
           <code class="mi">5</code>  <code class="mf">4603.625</code></pre>
<figure><div class="figure" id="fig_0309-pivot-tables_files_in_output_44_0">
<img alt="output 44 0" height="234" src="assets/output_44_0.png" width="600"/>
<h6><span class="label">Figure 21-2. </span>Average daily births by day of week and decade<sup><a data-type="noteref" href="ch21.xhtml#idm45858771266320" id="idm45858771266320-marker">3</a></sup></h6>
</div></figure>
<p>The result is a multi-index over months and days. To make this
visualizable, let’s turn these months and days into dates by
associating them with a dummy year variable (making sure to choose a
leap year so February 29th is correctly handled!):</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">21</code><code class="p">]:</code> <code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>
         <code class="n">births_by_date</code><code class="o">.</code><code class="n">index</code> <code class="o">=</code> <code class="p">[</code><code class="n">datetime</code><code class="p">(</code><code class="mi">2012</code><code class="p">,</code> <code class="n">month</code><code class="p">,</code> <code class="n">day</code><code class="p">)</code>
                                 <code class="k">for</code> <code class="p">(</code><code class="n">month</code><code class="p">,</code> <code class="n">day</code><code class="p">)</code> <code class="ow">in</code> <code class="n">births_by_date</code><code class="o">.</code><code class="n">index</code><code class="p">]</code>
         <code class="n">births_by_date</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">21</code><code class="p">]:</code>               <code class="n">births</code>
         <code class="mi">2012</code><code class="o">-</code><code class="mi">01</code><code class="o">-</code><code class="mi">01</code>  <code class="mf">4009.225</code>
         <code class="mi">2012</code><code class="o">-</code><code class="mi">01</code><code class="o">-</code><code class="mi">02</code>  <code class="mf">4247.400</code>
         <code class="mi">2012</code><code class="o">-</code><code class="mi">01</code><code class="o">-</code><code class="mi">03</code>  <code class="mf">4500.900</code>
         <code class="mi">2012</code><code class="o">-</code><code class="mi">01</code><code class="o">-</code><code class="mi">04</code>  <code class="mf">4571.350</code>
         <code class="mi">2012</code><code class="o">-</code><code class="mi">01</code><code class="o">-</code><code class="mi">05</code>  <code class="mf">4603.625</code></pre>
<p>Focusing on the month and day only, we now have a time series reflecting
the average number of births by date of the year. From this, we can use
the <code>plot</code> method to plot the data. It reveals some interesting trends,
as you can see in <a data-type="xref" href="#fig_0309-pivot-tables_files_in_output_50_0">Figure 21-3</a>.</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="c1"># Plot the results</code>
         <code class="n">fig</code><code class="p">,</code> <code class="n">ax</code> <code class="o">=</code> <code class="n">plt</code><code class="o">.</code><code class="n">subplots</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">12</code><code class="p">,</code> <code class="mi">4</code><code class="p">))</code>
         <code class="n">births_by_date</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">ax</code><code class="o">=</code><code class="n">ax</code><code class="p">);</code></pre>
<figure><div class="figure" id="fig_0309-pivot-tables_files_in_output_50_0">
<img alt="output 50 0" height="415" src="assets/output_50_0.png" width="600"/>
<h6><span class="label">Figure 21-3. </span>Average daily births by date<sup><a data-type="noteref" href="ch21.xhtml#idm45858771123312" id="idm45858771123312-marker">4</a></sup></h6>
</div></figure>
<p>In particular, the striking feature of this graph is the dip in
birthrate on US holidays (e.g., Independence Day, Labor Day,
Thanksgiving, Christmas, New Year’s Day), although this
likely reflects trends in scheduled/induced births rather than some deep
psychosomatic effect on natural births. For more discussion of this
trend, see the analysis and links in
<a href="https://oreil.ly/ugVHI">Andrew
Gelman’s blog post</a> on the subject. We’ll return
to this figure in
<a data-type="xref" href="ch32.xhtml#section-0409-text-and-annotation">Chapter 32</a>,
where we will use Matplotlib’s tools to annotate this plot.</p>
<p>Looking at this short example, you can see that many of the Python and
Pandas tools we’ve seen to this point can be combined and
used to gain insight from a variety of datasets.<a data-startref="ix_ch21-asciidoc3" data-type="indexterm" id="idm45858771119712"/> We will see some more
sophisticated applications of these data manipulations in future
chapters!<a data-startref="ix_ch21-asciidoc1" data-type="indexterm" id="idm45858771118768"/><a data-startref="ix_ch21-asciidoc0" data-type="indexterm" id="idm45858771118096"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45858772021024"><sup><a href="ch21.xhtml#idm45858772021024-marker">1</a></sup> The CDC dataset used in this section uses the sex assigned at birth, which it calls “gender,” and limits the data to male and female. While gender is a spectrum independent of biology, I will be using the same terminology while discussing this dataset for consistency and clarity.</p><p data-type="footnote" id="idm45858771699920"><sup><a href="ch21.xhtml#idm45858771699920-marker">2</a></sup> A full-color version of this figure can be found on <a href="https://oreil.ly/PDSH_GitHub">GitHub</a>.</p><p data-type="footnote" id="idm45858771266320"><sup><a href="ch21.xhtml#idm45858771266320-marker">3</a></sup> A full-color version of this figure can be found on <a href="https://oreil.ly/PDSH_GitHub">GitHub</a>.</p><p data-type="footnote" id="idm45858771123312"><sup><a href="ch21.xhtml#idm45858771123312-marker">4</a></sup> A full-size version of this figure can be found on <a href="https://oreil.ly/PDSH_GitHub">GitHub</a>.</p></div></div></section></div></body></html>