<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 3. Reading and Writing Data with Python" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_read_write">
<h1><span class="label">Chapter 3. </span>Reading and Writing Data <span class="keep-together">with Python</span></h1>
<p>One of the fundamental skills of any data <a data-primary="Python" data-secondary="reading and writing data" data-type="indexterm" id="ix_Pyrwr"/>visualizer is the ability to move data around. Whether your data is in an SQL database, a comma-separated value (CSV) file, or in some more esoteric form, you should be comfortable reading the data, converting it, and writing it into a more convenient form if need be. One of Python’s great strengths is how easy it makes manipulating data in this way. The focus of this chapter is to bring you up to speed with this essential aspect of our dataviz toolchain.</p>
<p>This chapter is part tutorial, part reference, and sections of it will be referred to in later chapters. If you know the fundamentals of reading and writing Python data, you can cherry-pick parts of the chapter as a refresher.</p>
<section data-pdf-bookmark="Easy Does It" data-type="sect1"><div class="sect1" id="idm45607798980288">
<h1>Easy Does It</h1>
<p>I remember when I started programming back in the day (using low-level languages like C) how awkward data manipulation was. Reading from and writing to files was an annoying mixture of boilerplate code, hand-rolled improvisations, and the like. Reading from databases was equally difficult, and as for serializing data, the memories are still painful. Discovering Python was a breath of fresh air. It wasn’t a speed demon, but opening a file was pretty much as simple as it could be:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">file</code> <code class="o">=</code> <code class="nb">open</code><code class="p">(</code><code class="s1">'data.txt'</code><code class="p">)</code></pre>
<p>Back then, Python made reading from and writing to files refreshingly easy, and its sophisticated string processing made parsing the data in those files just as easy. It even had an amazing module called Pickle that could serialize pretty much any Python object.</p>
<p>In the years since, Python has added robust, mature modules to its standard library that make dealing with CSV and JSON files, the standard for web dataviz work, just as easy. There are also some great libraries for interacting with SQL databases such as SQLAlchemy, my thoroughly recommended go-to. The newer NoSQL databases are also well served. MongoDB is the most popular of these newer document-based databases, and Python’s PyMongo library, which is demonstrated later in the chapter, makes interacting with it a relative breeze.</p>
</div></section>
<section data-pdf-bookmark="Passing Data Around" data-type="sect1"><div class="sect1" id="idm45607798972064">
<h1>Passing Data Around</h1>
<p>A good way to demonstrate how to use the key data-storage libraries is to pass a single data packet among them, reading and writing it as we go. <a data-primary="Python" data-secondary="reading and writing data" data-tertiary="passing data around key data storage libraries" data-type="indexterm" id="idm45607798967264"/>This will give us an opportunity to see in action the key data formats and databases employed by data visualizers.</p>
<p>The data we’ll be passing around is probably the most commonly used in web visualizations, a list of dictionary-like objects (see <a data-type="xref" href="#data_dummydata">Example 3-1</a>). This dataset is transferred to the browser in <a href="https://oreil.ly/JgjAp">JSON form</a>, which is, as we’ll see, easily converted from a Python <span class="keep-together">dictionary</span>.</p>
<div data-type="example" id="data_dummydata">
<h5><span class="label">Example 3-1. </span>Our target list of data objects</h5>
<pre data-code-language="python" data-type="programlisting"><code class="n">nobel_winners</code> <code class="o">=</code> <code class="p">[</code>
 <code class="p">{</code><code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Albert Einstein'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Swiss'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1921</code><code class="p">},</code>
 <code class="p">{</code><code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Paul Dirac'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'British'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1933</code><code class="p">},</code>
 <code class="p">{</code><code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Chemistry'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Marie Curie'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Polish'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'female'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1911</code><code class="p">}</code>
<code class="p">]</code></pre></div>
<p>We’ll start by creating a CSV file from the Python list shown in <a data-type="xref" href="#data_dummydata">Example 3-1</a> as a demonstration of reading (opening) and writing system files.</p>
<p>The following sections assume you’re in a working (root) directory with a <em>data</em> subdirectory at hand. You can run the code from a Python interpreter or file.</p>
</div></section>
<section data-pdf-bookmark="Working with System Files" data-type="sect1"><div class="sect1" id="idm45607798865712">
<h1>Working with System Files</h1>
<p>In this section, we’ll create a CSV file from a Python list of dictionaries (<a data-type="xref" href="#data_dummydata">Example 3-1</a>). Typically, you would<a data-primary="Python" data-secondary="reading and writing data" data-tertiary="working with system files" data-type="indexterm" id="idm45607798862992"/> do this using the <code>csv</code> module, which we’ll demonstrate after this section,  so this is just a way of demonstrating basic Python file <span class="keep-together">manipulation</span>.<a data-primary="dictionaries (dicts)" data-secondary="creating CSV file from dict in Python" data-type="indexterm" id="idm45607798860448"/><a data-primary="CSV files" data-secondary="creating from dictionary in Python" data-type="indexterm" id="idm45607798827632"/></p>
<p>First, let’s open a new file, using <code>w</code> as a second argument to indicate we’ll be writing data to it.</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">f</code> <code class="o">=</code> <code class="nb">open</code><code class="p">(</code><code class="s1">'data/nobel_winners.csv'</code><code class="p">,</code> <code class="s1">'w'</code><code class="p">)</code></pre>
<p>Now we’ll create our CSV file from the <code>nobel_winners</code> dictionary (<a data-type="xref" href="#data_dummydata">Example 3-1</a>):</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="n">nobel_winners</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">keys</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="nb">sorted</code><code class="p">(</code><code class="n">cols</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-2" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>
</code><code class="k">with</code><code> </code><code class="nb">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">data/nobel_winners.csv</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">w</code><code class="s1">'</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">f</code><code class="p">:</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-3" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
</code><code>    </code><code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="s1">'</code><code class="s1">,</code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">cols</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-4" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">o</code><code> </code><code class="ow">in</code><code> </code><code class="n">nobel_winners</code><code class="p">:</code><code>
</code><code>        </code><code class="n">row</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="nb">str</code><code class="p">(</code><code class="n">o</code><code class="p">[</code><code class="n">col</code><code class="p">]</code><code class="p">)</code><code> </code><code class="k">for</code><code> </code><code class="n">col</code><code> </code><code class="ow">in</code><code> </code><code class="n">cols</code><code class="p">]</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-5" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code>
</code><code>        </code><code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="s1">'</code><code class="s1">,</code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">row</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Gets our data columns from the keys of the first object (i.e., <code>['category', 'name', ... ]</code>).</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-2" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Sorts the columns in alphabetical order.</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-3" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Uses Python’s <code>with</code> statement to guarantee the file is closed on leaving the block or if any exceptions occur.<a data-primary="with statement (Python)" data-type="indexterm" id="idm45607798690480"/></p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-4" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p><code>join</code> creates a concatenated string from a list of strings (<code>cols</code> here), joined by the initial string (i.e., “category,name,..”).<a data-primary="join method (Python)" data-type="indexterm" id="idm45607798635888"/><a data-primary="strings" data-secondary="concatenating with join in Python" data-type="indexterm" id="idm45607798635280"/></p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-5" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO1-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Creates a list using the column keys to the objects in <code>nobel_winners</code>.</p></dd>
</dl>
<p>Now that we’ve created our CSV file, let’s use Python to read it and make sure everything is correct:</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="s1">'data/nobel_winners.csv'</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>
    <code class="k">for</code> <code class="n">line</code> <code class="ow">in</code> <code class="n">f</code><code class="o">.</code><code class="n">readlines</code><code class="p">():</code>
        <code class="nb">print</code><code class="p">(</code><code class="n">line</code><code class="p">)</code>

<code class="n">Out</code><code class="p">:</code>
<code class="n">category</code><code class="p">,</code><code class="n">name</code><code class="p">,</code><code class="n">nationality</code><code class="p">,</code><code class="n">gender</code><code class="p">,</code><code class="n">year</code>
<code class="n">Physics</code><code class="p">,</code><code class="n">Albert</code> <code class="n">Einstein</code><code class="p">,</code><code class="n">Swiss</code><code class="p">,</code><code class="n">male</code><code class="p">,</code><code class="mi">1921</code>
<code class="n">Physics</code><code class="p">,</code><code class="n">Paul</code> <code class="n">Dirac</code><code class="p">,</code><code class="n">British</code><code class="p">,</code><code class="n">male</code><code class="p">,</code><code class="mi">1933</code>
<code class="n">Chemistry</code><code class="p">,</code><code class="n">Marie</code> <code class="n">Curie</code><code class="p">,</code><code class="n">Polish</code><code class="p">,</code><code class="n">female</code><code class="p">,</code><code class="mi">1911</code></pre>
<p>As the previous output shows, our CSV file is well formed. Let’s use Python’s built-in <code>csv</code> module to first read it and then create a CSV file the right way.</p>
</div></section>
<section data-pdf-bookmark="CSV, TSV, and Row-Column Data Formats" data-type="sect1"><div class="sect1" id="idm45607798865120">
<h1>CSV, TSV, and Row-Column Data Formats</h1>
<p>Comma-separated values (CSV) or their tab-separated cousins (TSV) are probably the most ubiquitous file-based data formats and, as a data visualizer, these will often be the forms you’ll receive to work your magic with.<a data-primary="Python" data-secondary="reading and writing data" data-tertiary="CSV, TSV, and row-column data formats" data-type="indexterm" id="ix_PyrwrCTrcfmt"/><a data-primary="TSV (tab-separated values) files" data-type="indexterm" id="idm45607798535648"/><a data-primary="tab-separated values (TSV) files" data-type="indexterm" id="idm45607798535008"/> Being able to read and write CSV files and their various quirky variants, such as pipe- or semicolon-separated or those using <em>`</em> in place of the standard double quotes, is a fundamental skill; Python’s <code>csv</code> module is capable of doing pretty much all your heavy lifting here. Let’s put it through its paces reading and writing our <code>nobel_winners</code> data:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">nobel_winners</code> <code class="o">=</code> <code class="p">[</code>
 <code class="p">{</code><code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Albert Einstein'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Swiss'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1921</code><code class="p">},</code>
  <code class="o">...</code>
<code class="p">]</code></pre>
<p>Writing our <code>nobel_winners</code> data (see <a data-type="xref" href="#data_dummydata">Example 3-1</a>) to a CSV file is a pretty simple affair. <code>csv</code> has a dedicated <code>DictWriter</code> class that will turn our dictionaries into CSV rows.<a data-primary="DictWriter class (Python)" data-type="indexterm" id="idm45607798478848"/> The only piece of explicit bookkeeping we have to do is write a header to our CSV file, using the keys of our dictionaries as fields (i.e., “category, name, nationality, gender”):</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code><code> </code><code class="nn">csv</code><code>
</code><code>
</code><code class="k">with</code><code> </code><code class="nb">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">data/nobel_winners.csv</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">w</code><code class="s1">'</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">f</code><code class="p">:</code><code>
</code><code>    </code><code class="n">fieldnames</code><code> </code><code class="o">=</code><code> </code><code class="n">nobel_winners</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">keys</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>    </code><code class="n">fieldnames</code><code> </code><code class="o">=</code><code> </code><code class="nb">sorted</code><code class="p">(</code><code class="n">fieldnames</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-2" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>    </code><code class="n">writer</code><code> </code><code class="o">=</code><code> </code><code class="n">csv</code><code class="o">.</code><code class="n">DictWriter</code><code class="p">(</code><code class="n">f</code><code class="p">,</code><code> </code><code class="n">fieldnames</code><code class="o">=</code><code class="n">fieldnames</code><code class="p">)</code><code>
</code><code>    </code><code class="n">writer</code><code class="o">.</code><code class="n">writeheader</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-3" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">w</code><code> </code><code class="ow">in</code><code> </code><code class="n">nobel_winners</code><code class="p">:</code><code>
</code><code>        </code><code class="n">writer</code><code class="o">.</code><code class="n">writerow</code><code class="p">(</code><code class="n">w</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>You need to explicitly tell the writer which <code>fieldnames</code> to use (in this case, the <code>'category'</code>, <code>'name'</code>, etc., keys).</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-2" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>We’ll sort the CSV header fields alphabetically for readability.</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-3" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Writes the CSV-file header (“category, name,…​”).</p></dd>
</dl>
<p>You’ll probably be reading CSV files more often than writing them.<sup><a data-type="noteref" href="ch03.xhtml#idm45607798394048" id="idm45607798394048-marker">1</a></sup> Let’s read back the <em>nobel_winners.csv</em> file we just wrote.<a data-primary="CSV files" data-secondary="reading in Python" data-type="indexterm" id="ix_CSVread"/></p>
<p>If you just want to use <code>csv</code> as a superior and eminently adaptable file line reader, a couple of lines will produce a handy iterator, which can deliver your CSV rows as lists of strings:</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">with</code><code> </code><code class="nb">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">data/nobel_winners.csv</code><code class="s1">'</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">f</code><code class="p">:</code><code>
</code><code>    </code><code class="n">reader</code><code> </code><code class="o">=</code><code> </code><code class="n">csv</code><code class="o">.</code><code class="n">reader</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">row</code><code> </code><code class="ow">in</code><code> </code><code class="n">reader</code><code class="p">:</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO3-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">row</code><code class="p">)</code><code>
</code><code>
</code><code class="n">Out</code><code class="p">:</code><code>
</code><code class="p">[</code><code class="s1">'</code><code class="s1">category</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">nationality</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">gender</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">year</code><code class="s1">'</code><code class="p">]</code><code>
</code><code class="p">[</code><code class="s1">'</code><code class="s1">Physics</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Albert Einstein</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Swiss</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">male</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">1921</code><code class="s1">'</code><code class="p">]</code><code>
</code><code class="p">[</code><code class="s1">'</code><code class="s1">Physics</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Paul Dirac</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">British</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">male</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">1933</code><code class="s1">'</code><code class="p">]</code><code>
</code><code class="p">[</code><code class="s1">'</code><code class="s1">Chemistry</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Marie Curie</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Polish</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">female</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">1911</code><code class="s1">'</code><code class="p">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO3-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Iterates over the <code>reader</code> object, consuming the lines in the file.</p></dd>
</dl>
<p>Note that the numbers are read in string form. If you want to manipulate them numerically, you’ll need to convert any numeric columns to their respective type, which is integer years in this case.</p>
<p>A more convenient way to consume CSV data is to convert the rows into Python dictionaries. <a data-primary="dictionaries (dicts)" data-secondary="converting CSV rows to dictionaries" data-type="indexterm" id="idm45607798230592"/><a data-primary="DictReader class (Python)" data-type="indexterm" id="idm45607798229648"/>This <em>record</em> form is also the one we are using as our conversion target (a <code>list</code> of <code>dict</code>s). <code>csv</code> has a handy <code>DictReader</code> for just this purpose:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code><code> </code><code class="nn">csv</code><code>
</code><code>
</code><code class="k">with</code><code> </code><code class="nb">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">data/nobel_winners.csv</code><code class="s1">'</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">f</code><code class="p">:</code><code>
</code><code>    </code><code class="n">reader</code><code> </code><code class="o">=</code><code> </code><code class="n">csv</code><code class="o">.</code><code class="n">DictReader</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code>
</code><code>    </code><code class="n">nobel_winners</code><code> </code><code class="o">=</code><code> </code><code class="nb">list</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO4-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>
</code><code class="n">nobel_winners</code><code>
</code><code>
</code><code class="n">Out</code><code class="p">:</code><code>
</code><code class="p">[</code><code class="n">OrderedDict</code><code class="p">(</code><code class="p">[</code><code class="p">(</code><code class="s1">'</code><code class="s1">category</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Physics</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>              </code><code class="p">(</code><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Albert Einstein</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>              </code><code class="p">(</code><code class="s1">'</code><code class="s1">nationality</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Swiss</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>              </code><code class="p">(</code><code class="s1">'</code><code class="s1">gender</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">male</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>              </code><code class="p">(</code><code class="s1">'</code><code class="s1">year</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">1921</code><code class="s1">'</code><code class="p">)</code><code class="p">]</code><code class="p">)</code><code class="p">,</code><code>
</code><code> </code><code class="n">OrderedDict</code><code class="p">(</code><code class="p">[</code><code class="p">(</code><code class="s1">'</code><code class="s1">category</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Physics</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>              </code><code class="p">(</code><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Paul Dirac</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>              </code><code class="p">(</code><code class="s1">'</code><code class="s1">nationality</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">British</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>              </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code> </code><code class="p">]</code><code class="p">)</code><code class="p">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO4-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Inserts all of the <code>reader</code> items into a list.</p></dd>
</dl>
<p>As the output shows, we just need to cast the <code>dict</code>s year attributes to integers to make <code>nobel_winners</code> conform to the chapter’s target data (<a data-type="xref" href="#data_dummydata">Example 3-1</a>), thus:</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">for</code> <code class="n">w</code> <code class="ow">in</code> <code class="n">nobel_winners</code><code class="p">:</code>
    <code class="n">w</code><code class="p">[</code><code class="s1">'year'</code><code class="p">]</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">w</code><code class="p">[</code><code class="s1">'year'</code><code class="p">])</code></pre>
<p>For more flexibility we can <a data-primary="datetime object (Python)" data-secondary="creating from CSV file year column" data-type="indexterm" id="idm45607797973120"/>easily create a Python <code>datetime</code> from the year column:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>

<code class="n">dt</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">strptime</code><code class="p">(</code><code class="s1">'1947'</code><code class="p">,</code> <code class="s1">'</code><code class="si">%Y</code><code class="s1">'</code><code class="p">)</code>
<code class="n">dt</code>
<code class="c1"># datetime.datetime(1947, 1, 1, 0, 0)</code></pre>
<p>The <code>csv</code> readers don’t infer datatypes from your file, and instead interpret everything as a string. pandas, Python’s preeminent data-hacking library, will try to guess the correct type of the data columns, usually successfully. We’ll see this in action in the later dedicated pandas chapters.<a data-primary="csv parameters for parsing CSV files" data-type="indexterm" id="idm45607797928192"/></p>
<p><code>csv</code> has a few useful arguments to help parse members of the CSV family:</p>
<dl>
<dt><code>dialect</code></dt>
<dd>
<p>By default, <code>'excel'</code>; specifies a set of dialect-specific parameters. <code>excel-tab</code> is a sometimes-used alternative.</p>
</dd>
<dt><code>delimiter</code></dt>
<dd>
<p>Files are usually comma-separated, but they could use <code>|</code>, <code>:</code> or  <span class="keep-together"><code>' '</code></span> instead.</p>
</dd>
<dt><code>quotechar</code></dt>
<dd>
<p>By default, double quotes are used, but you occasionally find <code>|</code> or <code>`</code> instead.</p>
</dd>
</dl>
<p>You can find the full set of <code>csv</code> parameters in the <a href="https://oreil.ly/9zZvt">online Python docs</a>.</p>
<p>Now that we’ve successfully written and read our target data using the <code>csv</code> module, let’s pass on our CSV-derived <code>nobel_winners</code> <code>dict</code> to the <code>json</code> module.<a data-primary="CSV files" data-secondary="reading in Python" data-startref="ix_CSVread" data-type="indexterm" id="idm45607797896384"/><a data-primary="Python" data-secondary="reading and writing data" data-startref="ix_PyrwrCTrcfmt" data-tertiary="CSV, TSV, and row-column data formats" data-type="indexterm" id="idm45607797895104"/></p>
</div></section>
<section data-pdf-bookmark="JSON" data-type="sect1"><div class="sect1" id="read_write_json">
<h1>JSON</h1>
<p>In this section, we’ll write and read our <code>nobel_winners</code> data using Python’s <code>json</code> module. <a data-primary="Python" data-secondary="reading and writing data" data-tertiary="JSON" data-type="indexterm" id="ix_PyrwrJSON"/><a data-primary="JSON" data-secondary="writing and reading using Python json module" data-type="indexterm" id="ix_JSONwrrPy"/>Let’s remind ourselves of the data we’re using:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">nobel_winners</code> <code class="o">=</code> <code class="p">[</code>
 <code class="p">{</code><code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Albert Einstein'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Swiss'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1921</code><code class="p">},</code>
  <code class="o">...</code>
<code class="p">]</code></pre>
<p>For data primitives such as strings, integers, and floats, Python dictionaries are easily saved (or <em>dumped</em>, in the JSON vernacular) into JSON files, using the <code>json</code> module. The <code>dump</code> method takes a Python container and a file pointer, saving the former to the latter:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">json</code>

<code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="s1">'data/nobel_winners.json'</code><code class="p">,</code> <code class="s1">'w'</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>
     <code class="n">json</code><code class="o">.</code><code class="n">dump</code><code class="p">(</code><code class="n">nobel_winners</code><code class="p">,</code> <code class="n">f</code><code class="p">)</code>

<code class="nb">open</code><code class="p">(</code><code class="s1">'data/nobel_winners.json'</code><code class="p">)</code><code class="o">.</code><code class="n">read</code><code class="p">()</code></pre>
<pre data-type="programlisting">Out: '[{"category": "Physics", "name": "Albert Einstein",
"gender": "male", "year": 1921,
"nationality": "Swiss"}, {"category": "Physics",
"nationality": "British", "year": 1933, "name": "Paul Dirac",
"gender": "male"}, {"category": "Chemistry", "nationality":
"Polish", "year": 1911, "name": "Marie Curie", "gender":
"female"}]'</pre>
<p>Reading (or loading) a JSON file is just as easy. We just pass the opened JSON file to the <code>json</code> module’s <code>load</code> method:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code><code> </code><code class="nn">json</code><code>
</code><code>
</code><code class="k">with</code><code> </code><code class="nb">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">data/nobel_winners.json</code><code class="s1">'</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">f</code><code class="p">:</code><code>
</code><code>    </code><code class="n">nobel_winners</code><code> </code><code class="o">=</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code>
</code><code>
</code><code class="n">nobel_winners</code><code>
</code><code class="n">Out</code><code class="p">:</code><code>
</code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">category</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">Physics</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>  </code><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">Albert Einstein</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>  </code><code class="s1">'</code><code class="s1">nationality</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">Swiss</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>  </code><code class="s1">'</code><code class="s1">gender</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">male</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>  </code><code class="s1">'</code><code class="s1">year</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mi">1921</code><code class="p">}</code><code class="p">,</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO5-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code> </code><code class="p">}</code><code class="p">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO5-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Note that, unlike in our CSV file conversion, the integer type of the year column is preserved.</p></dd>
</dl>
<p><code>json</code> has the methods <code>loads</code> and <code>dumps</code>, which are counterparts to the file access methods, loading JSON strings to Python containers and dumping Python containers to JSON strings.</p>
<section data-pdf-bookmark="Dealing with Dates and Times" data-type="sect2"><div class="sect2" id="idm45607797699568">
<h2>Dealing with Dates and Times</h2>
<p>Trying to dump a <code>datetime</code> object to <code>json</code> produces<a data-primary="dates and times" data-secondary="dealing with when reading/writing JSON data in Python" data-type="indexterm" id="idm45607797696976"/><a data-primary="JSON" data-secondary="writing and reading using Python json module" data-tertiary="dealing with dates and times" data-type="indexterm" id="idm45607797696000"/> a <code>TypeError</code>:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>

<code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">())</code>
<code class="n">Out</code><code class="p">:</code>
<code class="o">...</code>
<code class="ne">TypeError</code><code class="p">:</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="p">(</code><code class="mi">2021</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">52</code><code class="p">,</code> <code class="mi">586792</code><code class="p">)</code>
<code class="ow">is</code> <code class="ow">not</code> <code class="n">JSON</code> <code class="n">serializable</code></pre>
<p>When serializing simple datatypes such as strings or numbers, the default <code>json</code> encoders and decoders are fine. But for more specialized data such as dates, you will need to do your own encoding and decoding. This isn’t as hard as it sounds and quickly becomes routine. Let’s first look at  encoding your Python <a href="https://oreil.ly/aHI4h"><code>datetime</code>s</a> into sensible JSON strings.</p>
<p>The easiest way to encode Python data containing <code>datetime</code>s is to create a custom encoder like the one shown in <a data-type="xref" href="#data_json_time">Example 3-2</a>, which is provided to the <code>json.dumps</code> method as a <code>cls</code> argument. <a data-primary="json.dumps method" data-type="indexterm" id="idm45607797625744"/>This encoder is applied to each object in your data in turn and converts dates or datetimes to their ISO-format string (see <a data-type="xref" href="#sect_datetimes">“Dealing with Dates, Times, and Complex Data”</a>).</p>
<div data-type="example" id="data_json_time">
<h5><span class="label">Example 3-2. </span>Encoding a Python <code>datetime</code> to JSON</h5>
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code><code> </code><code class="nn">datetime</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">json</code><code>
</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">JSONDateTimeEncoder</code><code class="p">(</code><code class="n">json</code><code class="o">.</code><code class="n">JSONEncoder</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">default</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">obj</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="nb">isinstance</code><code class="p">(</code><code class="n">obj</code><code class="p">,</code><code> </code><code class="p">(</code><code class="n">datetime</code><code class="o">.</code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-2" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">obj</code><code class="o">.</code><code class="n">isoformat</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="k">else</code><code class="p">:</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">JSONEncoder</code><code class="o">.</code><code class="n">default</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">obj</code><code class="p">)</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">dumps</code><code class="p">(</code><code class="n">obj</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">obj</code><code class="p">,</code><code> </code><code class="bp">cls</code><code class="o">=</code><code class="n">JSONDateTimeEncoder</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-3" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Subclasses  a <code>JSONEncoder</code> in order to create a customized date-handling one.</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-2" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Tests for a <code>datetime</code> object and if true, returns the <code>isoformat</code> of any dates or datetimes (e.g., 2021-11-16T16:41:14.650802).</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-3" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Uses the <code>cls</code> argument to set a custom date encoder.</p></dd>
</dl></div>
<p>Let’s see how our new <code>dumps</code> method copes with some <code>datetime</code> data:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">now_str</code> <code class="o">=</code> <code class="n">dumps</code><code class="p">({</code><code class="s1">'time'</code><code class="p">:</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">()})</code>
<code class="n">now_str</code>
<code class="n">Out</code><code class="p">:</code>
<code class="s1">'{"time": "2021-11-16T16:41:14.650802"}'</code></pre>
<p>The <code>time</code> field is correctly converted into an ISO-format string, ready to be decoded into a JavaScript <code>Date</code> object (see <a data-type="xref" href="#sect_datetimes">“Dealing with Dates, Times, and Complex Data”</a> for a demonstration).</p>
<p>While you could write a generic decoder to cope with date strings in arbitrary JSON files,<sup><a data-type="noteref" href="ch03.xhtml#idm45607797415616" id="idm45607797415616-marker">2</a></sup> it’s probably not advisable. Date strings come in so many weird and wonderful varieties that this is a job best done by hand on what is pretty much always a known dataset.<a data-primary="datetime object (Python)" data-secondary="converting JSON time string into datetime object" data-type="indexterm" id="idm45607797414368"/></p>
<p>The venerable <code>strptime</code> method, part<a data-primary="strptime method (Python)" data-type="indexterm" id="idm45607797412656"/> of the <code>datetime.datetime</code> package, is good for the job of turning a time string in a known format into a Python <code>datetime</code> instance:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">from</code><code> </code><code class="nn">datetime</code><code> </code><code class="kn">import</code><code> </code><code class="n">datetime</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">time_str</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">2021/01/01 12:32:11</code><code class="s1">'</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">dt</code><code> </code><code class="o">=</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">strptime</code><code class="p">(</code><code class="n">time_str</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="si">%Y</code><code class="s1">/</code><code class="si">%m</code><code class="s1">/</code><code class="si">%d</code><code class="s1"> </code><code class="si">%H</code><code class="s1">:</code><code class="si">%M</code><code class="s1">:</code><code class="si">%S</code><code class="s1">'</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO7-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">dt</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="p">(</code><code class="mi">2021</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">12</code><code class="p">,</code><code> </code><code class="mi">32</code><code class="p">,</code><code> </code><code class="mi">11</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO7-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p><code>strptime</code> tries to match the time string to a format string using various directives such as <code>%Y</code> (year with century) and <code>%H</code> (hour as a zero-padded decimal number). If successful, it creates a Python <code>datetime</code> instance. See <a href="https://oreil.ly/Fi40k">the Python docs</a> for a full list of the directives available.</p></dd>
</dl>
<p>If <code>strptime</code> is fed a time string that does not match its format, it throws a handy <code>ValueError</code>:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">dt</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">strptime</code><code class="p">(</code><code class="s1">'1/2/2021 12:32:11'</code><code class="p">,</code> <code class="s1">'</code><code class="si">%Y</code><code class="s1">/</code><code class="si">%m</code><code class="s1">/</code><code class="si">%d</code><code class="s1"> </code><code class="si">%H</code><code class="s1">:</code><code class="si">%M</code><code class="s1">:</code><code class="si">%S</code><code class="s1">'</code><code class="p">)</code>
<code class="o">-----------------------------------------------------------</code>
<code class="ne">ValueError</code>                <code class="n">Traceback</code> <code class="p">(</code><code class="n">most</code> <code class="n">recent</code> <code class="n">call</code> <code class="n">last</code><code class="p">)</code>
<code class="o">&lt;</code><code class="n">ipython</code><code class="o">-</code><code class="nb">input</code><code class="o">-</code><code class="mi">111</code><code class="o">-</code><code class="n">af657749a9fe</code><code class="o">&gt;</code> <code class="ow">in</code> <code class="o">&lt;</code><code class="n">module</code><code class="o">&gt;</code><code class="p">()</code>
<code class="o">----&gt;</code> <code class="mi">1</code> <code class="n">dt</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">strptime</code><code class="p">(</code><code class="s1">'1/2/2021 12:32:11'</code><code class="p">,</code>\
    <code class="s1">'</code><code class="si">%Y</code><code class="s1">/</code><code class="si">%m</code><code class="s1">/</code><code class="si">%d</code><code class="s1"> </code><code class="si">%H</code><code class="s1">:</code><code class="si">%M</code><code class="s1">:</code><code class="si">%S</code><code class="s1">'</code><code class="p">)</code>
<code class="o">...</code>
<code class="ne">ValueError</code><code class="p">:</code> <code class="n">time</code> <code class="n">data</code> <code class="s1">'1/2/2021 12:32:11'</code> <code class="n">does</code> <code class="ow">not</code> <code class="n">match</code>
            <code class="nb">format</code> <code class="s1">'</code><code class="si">%Y</code><code class="s1">/</code><code class="si">%m</code><code class="s1">/</code><code class="si">%d</code><code class="s1"> </code><code class="si">%H</code><code class="s1">:</code><code class="si">%M</code><code class="s1">:</code><code class="si">%S</code><code class="s1">'</code></pre>
<p>So to convert date fields of a known format into <code>datetime</code>s for a <code>data</code> list of dictionaries, you could do something like this:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">data</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code><code class="s1">'id'</code><code class="p">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s1">'date'</code><code class="p">:</code> <code class="s1">'2020/02/23 12:59:05'</code><code class="p">},</code>
    <code class="p">{</code><code class="s1">'id'</code><code class="p">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'date'</code><code class="p">:</code> <code class="s1">'2021/11/02 02:32:00'</code><code class="p">},</code>
    <code class="p">{</code><code class="s1">'id'</code><code class="p">:</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'date'</code><code class="p">:</code> <code class="s1">'2021/23/12 09:22:30'</code><code class="p">},</code>
<code class="p">]</code>

<code class="k">for</code> <code class="n">d</code> <code class="ow">in</code> <code class="n">data</code><code class="p">:</code>
     <code class="k">try</code><code class="p">:</code>
         <code class="n">d</code><code class="p">[</code><code class="s1">'date'</code><code class="p">]</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">strptime</code><code class="p">(</code><code class="n">d</code><code class="p">[</code><code class="s1">'date'</code><code class="p">],</code>\
           <code class="s1">'</code><code class="si">%Y</code><code class="s1">/</code><code class="si">%m</code><code class="s1">/</code><code class="si">%d</code><code class="s1"> </code><code class="si">%H</code><code class="s1">:</code><code class="si">%M</code><code class="s1">:</code><code class="si">%S</code><code class="s1">'</code><code class="p">)</code>
     <code class="k">except</code> <code class="ne">ValueError</code><code class="p">:</code>
         <code class="nb">print</code><code class="p">(</code><code class="s1">'Oops! - invalid date for '</code> <code class="o">+</code> <code class="nb">repr</code><code class="p">(</code><code class="n">d</code><code class="p">))</code>
<code class="c1"># Out:</code>
<code class="c1"># Oops! - invalid date for {'id': 2, 'date': '2021/23/12 09:22:30'}</code></pre>
<p>Now that we’ve dealt with the two most popular data file formats, let’s shift to the big guns and see how to read our data from and write our data to SQL and NoSQL databases.<a data-primary="Python" data-secondary="reading and writing data" data-startref="ix_PyrwrJSON" data-tertiary="JSON" data-type="indexterm" id="idm45607797132912"/><a data-primary="JSON" data-secondary="writing and reading using Python json module" data-startref="ix_JSONwrrPy" data-type="indexterm" id="idm45607797043200"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="SQL" data-type="sect1"><div class="sect1" id="read_write_sql">
<h1>SQL</h1>
<p>For interacting with an SQL database, SQLAlchemy is the most popular and, in my opinion, best Python library.<a data-primary="SQL" data-secondary="reading and writing with Python" data-type="indexterm" id="ix_SQLPy"/><a data-primary="Python" data-secondary="reading and writing data" data-tertiary="SQL" data-type="indexterm" id="ix_PyrwrSQL"/><a data-primary="SQLAlchemy" data-type="indexterm" id="ix_SQLAlc"/> It allows you to use raw SQL instructions if speed and efficiency is an issue, but also provides a powerful object-relational mapping (ORM) that allows you to operate on SQL tables using a high-level, Pythonic API, treating them essentially as Python classes.</p>
<p>Reading and writing data using SQL while allowing the user to treat that data as a Python container is a complicated process, and though SQLAlchemy is considerably more user-friendly than a low-level SQL engine, it is still a fairly complex library. I’ll cover the basics here, using our data as a target, but encourage you to spend a little time reading some of the rather excellent documentation on <a href="https://oreil.ly/mCHr8">SQLAlchemy</a>. Let’s remind ourselves of the <code>nobel_winners</code> dataset we’re aiming to write and read:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">nobel_winners</code> <code class="o">=</code> <code class="p">[</code>
 <code class="p">{</code><code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Albert Einstein'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Swiss'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1921</code><code class="p">},</code>
  <code class="o">...</code>
<code class="p">]</code></pre>
<p>Let’s first write our target data to an SQLite file using SQLAlchemy, starting by creating the database engine.</p>
<section data-pdf-bookmark="Creating the Database Engine" data-type="sect2"><div class="sect2" id="sql_engine">
<h2>Creating the Database Engine</h2>
<p>The first thing you need to do when starting an SQLAlchemy session is to create a database engine. <a data-primary="SQLAlchemy" data-secondary="creating a database engine" data-type="indexterm" id="idm45607796978672"/>This engine will establish a connection with the database in question and perform any conversions needed to the generic SQL instructions generated by SQLAlchemy and the data being returned.</p>
<p>There are engines for pretty much every popular database, as well as a <em>memory</em> option, which holds the database in RAM, allowing fast access for testing.<sup><a data-type="noteref" href="ch03.xhtml#idm45607796976800" id="idm45607796976800-marker">3</a></sup>  The great thing about these engines is that they are interchangeable, which means you could develop your code using the convenient file-based SQLite database and then switch during production to something a little more industrial, such as PostgreSQL, by changing a single config string. Check <a href="https://oreil.ly/QmIj6">SQLAlchemy</a> for the full list of engines available.</p>
<p>The form for specifying a database URL is:</p>
<pre data-code-language="bash" data-type="programlisting">dialect+driver://username:password@host:port/database</pre>
<p>So, to connect to a <code>'nobel_winners'</code> MySQL database running on localhost requires something like the following. Note that <code>create_engine</code> does not actually make any SQL requests at this point, but merely sets up the framework for doing so:<sup><a data-type="noteref" href="ch03.xhtml#idm45607796966400" id="idm45607796966400-marker">4</a></sup></p>
<pre data-code-language="python" data-type="programlisting"><code class="n">engine</code> <code class="o">=</code> <code class="n">create_engine</code><code class="p">(</code>
           <code class="s1">'mysql://kyran:mypsswd@localhost/nobel_winners'</code><code class="p">)</code></pre>
<p>We’ll <a data-primary="SQLite" data-secondary="file-based database" data-type="indexterm" id="idm45607796925680"/>use a file-based SQLite database, setting the <code>echo</code> argument to <code>True</code>, which will output any SQL instructions generated by SQLAlchemy. Note the use of three backslashes after the colon:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">sqlalchemy</code> <code class="kn">import</code> <code class="n">create_engine</code>

<code class="n">engine</code> <code class="o">=</code> <code class="n">create_engine</code><code class="p">(</code>
            <code class="s1">'sqlite:///data/nobel_winners.db'</code><code class="p">,</code> <code class="n">echo</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre>
<p>SQLAlchemy offers various ways to engage with databases, but I recommend using the more recent declarative style unless there are good reasons to go with something more low-level and fine-grained. In essence, with declarative mapping, you subclass your Python SQL-table classes from a base, and SQLAlchemy introspects their structure and relationships. See <a href="https://oreil.ly/q3IZf">SQLAlchemy</a> for more details.</p>
</div></section>
<section data-pdf-bookmark="Defining the Database Tables" data-type="sect2"><div class="sect2" id="sql_schema">
<h2>Defining the Database Tables</h2>
<p>We first create a <code>Base</code> class using <code>declarative_base</code>. This base will be used to create table classes, from which SQLAlchemy will create the database’s table schemas.<a data-primary="schemas" data-secondary="database" data-tertiary="creating with SQLAlchemy" data-type="indexterm" id="idm45607796874288"/><a data-primary="SQLAlchemy" data-secondary="defining database tables" data-type="indexterm" id="idm45607796870992"/><a data-primary="tables (database), defining with SQLAlchemy" data-type="indexterm" id="idm45607796870080"/> You can use these table classes to interact with the database in a fairly Pythonic fashion:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">sqlalchemy.ext.declarative</code> <code class="kn">import</code> <code class="n">declarative_base</code>

<code class="n">Base</code> <code class="o">=</code> <code class="n">declarative_base</code><code class="p">()</code></pre>
<p>Note that most SQL libraries require you to formally define table schemas. This is in contrast to such schema-less NoSQL variants as MongoDB. We’ll take a look at the Dataset library later in this chapter, which enables schemaless SQL.</p>
<p>Using this <code>Base</code>, we define our various tables—in our case, a single <code>Winner</code> table. <a data-type="xref" href="#data_sql_base">Example 3-3</a> shows how to subclass <code>Base</code> and use SQLAlchemy’s datatypes to define a table schema. Note the <code>__tablename__</code> member, which will be used to name the SQL table and as a keyword to retrieve it, and the optional custom <code>__repr__</code> method, which will be used when printing a table row.</p>
<div data-type="example" id="data_sql_base">
<h5><span class="label">Example 3-3. </span>Defining an SQL database table</h5>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">sqlalchemy</code> <code class="kn">import</code> <code class="n">Column</code><code class="p">,</code> <code class="n">Integer</code><code class="p">,</code> <code class="n">String</code><code class="p">,</code> <code class="n">Enum</code>
<code class="o">//</code> <code class="o">...</code>

<code class="k">class</code> <code class="nc">Winner</code><code class="p">(</code><code class="n">Base</code><code class="p">):</code>
    <code class="n">__tablename__</code> <code class="o">=</code> <code class="s1">'winners'</code>
    <code class="nb">id</code> <code class="o">=</code> <code class="n">Column</code><code class="p">(</code><code class="n">Integer</code><code class="p">,</code> <code class="n">primary_key</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
    <code class="n">category</code> <code class="o">=</code> <code class="n">Column</code><code class="p">(</code><code class="n">String</code><code class="p">)</code>
    <code class="n">name</code> <code class="o">=</code> <code class="n">Column</code><code class="p">(</code><code class="n">String</code><code class="p">)</code>
    <code class="n">nationality</code> <code class="o">=</code> <code class="n">Column</code><code class="p">(</code><code class="n">String</code><code class="p">)</code>
    <code class="n">year</code> <code class="o">=</code> <code class="n">Column</code><code class="p">(</code><code class="n">Integer</code><code class="p">)</code>
    <code class="n">gender</code> <code class="o">=</code> <code class="n">Column</code><code class="p">(</code><code class="n">Enum</code><code class="p">(</code><code class="s1">'male'</code><code class="p">,</code> <code class="s1">'female'</code><code class="p">))</code>
    <code class="k">def</code> <code class="fm">__repr__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="s2">"&lt;Winner(name='</code><code class="si">%s</code><code class="s2">', category='</code><code class="si">%s</code><code class="s2">', year='</code><code class="si">%s</code><code class="s2">')&gt;"</code>\
<code class="o">%</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">category</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">year</code><code class="p">)</code></pre></div>
<p>Having declared our <code>Base</code> subclass in <a data-type="xref" href="#data_sql_base">Example 3-3</a>, we supply its <code>metadata</code> <code>create_all</code> method with our database engine to create our database.<sup><a data-type="noteref" href="ch03.xhtml#idm45607796702064" id="idm45607796702064-marker">5</a></sup> Because we set the <code>echo</code> argument to <code>True</code> when creating the engine, we can see the SQL instructions generated by SQLAlchemy from the command line:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">Base</code><code class="o">.</code><code class="n">metadata</code><code class="o">.</code><code class="n">create_all</code><code class="p">(</code><code class="n">engine</code><code class="p">)</code>

<code class="mi">2021</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">16</code> <code class="mi">17</code><code class="p">:</code><code class="mi">58</code><code class="p">:</code><code class="mi">34</code><code class="p">,</code><code class="mi">700</code> <code class="n">INFO</code> <code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">Engine</code> <code class="n">BEGIN</code> <code class="p">(</code><code class="n">implicit</code><code class="p">)</code>
<code class="o">...</code>
<code class="n">CREATE</code> <code class="n">TABLE</code> <code class="n">winners</code> <code class="p">(</code>
	<code class="nb">id</code> <code class="n">INTEGER</code> <code class="n">NOT</code> <code class="n">NULL</code><code class="p">,</code>
	<code class="n">category</code> <code class="n">VARCHAR</code><code class="p">,</code>
	<code class="n">name</code> <code class="n">VARCHAR</code><code class="p">,</code>
	<code class="n">nationality</code> <code class="n">VARCHAR</code><code class="p">,</code>
	<code class="n">year</code> <code class="n">INTEGER</code><code class="p">,</code>
	<code class="n">gender</code> <code class="n">VARCHAR</code><code class="p">(</code><code class="mi">6</code><code class="p">),</code>
	<code class="n">PRIMARY</code> <code class="n">KEY</code> <code class="p">(</code><code class="nb">id</code><code class="p">)</code>
<code class="p">)</code><code class="o">...</code>
<code class="mi">2021</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">16</code> <code class="mi">17</code><code class="p">:</code><code class="mi">58</code><code class="p">:</code><code class="mi">34</code><code class="p">,</code><code class="mi">742</code> <code class="n">INFO</code> <code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">Engine</code> <code class="n">COMMIT</code></pre>
<p>With our new <code>winners</code> table declared, we can start adding winner instances to it.</p>
</div></section>
<section data-pdf-bookmark="Adding Instances with a Session" data-type="sect2"><div class="sect2" id="idm45607796876784">
<h2>Adding Instances with a Session</h2>
<p>Now that we have created our database, we need a <a data-primary="SQLAlchemy" data-secondary="adding instances with a session" data-type="indexterm" id="idm45607796547184"/><a data-primary="sessions (database)" data-type="indexterm" id="idm45607796546336"/>session to interact with:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">sqlalchemy.orm</code> <code class="kn">import</code> <code class="n">sessionmaker</code>

<code class="n">Session</code> <code class="o">=</code> <code class="n">sessionmaker</code><code class="p">(</code><code class="n">bind</code><code class="o">=</code><code class="n">engine</code><code class="p">)</code>
<code class="n">session</code> <code class="o">=</code> <code class="n">Session</code><code class="p">()</code></pre>
<p>We can now use our <code>Winner</code> class to create instances and table rows and add them to the session:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">albert</code><code> </code><code class="o">=</code><code> </code><code class="n">Winner</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="n">nobel_winners</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO8-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="n">session</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">albert</code><code class="p">)</code><code>
</code><code class="n">session</code><code class="o">.</code><code class="n">new</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO8-2" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="n">Out</code><code class="p">:</code><code>
</code><code class="n">IdentitySet</code><code class="p">(</code><code class="p">[</code><code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'</code><code class="s1">Albert Einstein</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">category</code><code class="o">=</code><code class="s1">'</code><code class="s1">Physics</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>             </code><code class="n">year</code><code class="o">=</code><code class="s1">'</code><code class="s1">1921</code><code class="s1">'</code><code class="p">)</code><code class="o">&gt;</code><code class="p">]</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO8-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Python’s handy ** operator unpacks our first <code>nobel_winners</code> member into key-value pairs: <code>(name='Albert Einstein', category='Physics'...)</code>.</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO8-2" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p><code>new</code> is the set of any items that have been added to this session.</p></dd>
</dl>
<p>Note that all database insertions and deletions take place in Python. It’s only when we use the <code>commit</code> method that the database is altered.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Use as few commits as possible, allowing SQLAlchemy to work its magic behind the scenes. <a data-primary="commits (database)" data-type="indexterm" id="idm45607796449184"/>When you commit, your various database manipulations should be summarized by SQLAlchemy and communicated in an efficient fashion. Commits involve establishing a database handshake and negotiating transactions, which is often a slow process and one you want to limit as much as possible, leveraging SQLAlchemy’s bookkeeping abilities to full advantage.</p>
</div>
<p>As the <code>new</code> method shows, we have added a <code>Winner</code> to the session. We can remove the object using <code>expunge</code>, leaving an empty <code>IdentitySet</code>:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">session</code><code class="o">.</code><code class="n">expunge</code><code class="p">(</code><code class="n">albert</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO9-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="n">session</code><code class="o">.</code><code class="n">new</code><code>
</code><code class="n">Out</code><code class="p">:</code><code>
</code><code class="n">IdentitySet</code><code class="p">(</code><code class="p">[</code><code class="p">]</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO9-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Removes the instance from the session (there is an <code>expunge_all</code> method that removes all new objects added to the session).</p></dd>
</dl>
<p>At this point, no database insertions or deletions have taken place. Let’s add all the members of our <code>nobel_winners</code> list to the session and commit them to the database:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">winner_rows</code> <code class="o">=</code> <code class="p">[</code><code class="n">Winner</code><code class="p">(</code><code class="o">**</code><code class="n">w</code><code class="p">)</code> <code class="k">for</code> <code class="n">w</code> <code class="ow">in</code> <code class="n">nobel_winners</code><code class="p">]</code>
<code class="n">session</code><code class="o">.</code><code class="n">add_all</code><code class="p">(</code><code class="n">winner_rows</code><code class="p">)</code>
<code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code>
<code class="n">Out</code><code class="p">:</code>
<code class="n">INFO</code><code class="p">:</code><code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">base</code><code class="o">.</code><code class="n">Engine</code><code class="p">:</code><code class="n">BEGIN</code> <code class="p">(</code><code class="n">implicit</code><code class="p">)</code>
<code class="o">...</code>
<code class="n">INFO</code><code class="p">:</code><code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">base</code><code class="o">.</code><code class="n">Engine</code><code class="p">:</code><code class="n">INSERT</code> <code class="n">INTO</code> <code class="n">winners</code> <code class="p">(</code><code class="n">name</code><code class="p">,</code>
<code class="n">category</code><code class="p">,</code> <code class="n">year</code><code class="p">,</code> <code class="n">nationality</code><code class="p">,</code> <code class="n">gender</code><code class="p">)</code> <code class="n">VALUES</code> <code class="p">(</code><code class="err">?</code><code class="p">,</code> <code class="err">?</code><code class="p">,</code> <code class="err">?</code><code class="p">,</code> <code class="err">?</code><code class="p">,</code> <code class="err">?</code><code class="p">)</code>
<code class="n">INFO</code><code class="p">:</code><code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">base</code><code class="o">.</code><code class="n">Engine</code><code class="p">:(</code><code class="s1">'Albert Einstein'</code><code class="p">,</code>
<code class="s1">'Physics'</code><code class="p">,</code> <code class="mi">1921</code><code class="p">,</code> <code class="s1">'Swiss'</code><code class="p">,</code> <code class="s1">'male'</code><code class="p">)</code>
<code class="o">...</code>
<code class="n">INFO</code><code class="p">:</code><code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">base</code><code class="o">.</code><code class="n">Engine</code><code class="p">:</code><code class="n">COMMIT</code></pre>
<p>Now that we’ve committed our <code>nobel_winners</code> data to the database, let’s see what we can do with it and how to re-create the target list in <a data-type="xref" href="#data_dummydata">Example 3-1</a>.</p>
</div></section>
<section data-pdf-bookmark="Querying the Database" data-type="sect2"><div class="sect2" id="idm45607796548160">
<h2>Querying the Database</h2>
<p>To access data, you use the <code>session</code>’s <code>query</code> method, the result of which can be filtered, grouped, and intersected, allowing the full range of standard SQL data retrieval.<a data-primary="SQLAlchemy" data-secondary="querying the database" data-type="indexterm" id="idm45607796204320"/><a data-primary="querying databases" data-secondary="querying SQLite file-based database using SQLAlchemy" data-type="indexterm" id="idm45607796203344"/> You can check out available querying methods in the <a href="https://oreil.ly/2rEB4">SQLAlchemy docs</a>. For now, I’ll quickly run through some of the most common queries on our Nobel <span class="keep-together">dataset</span>.</p>
<p>Let’s first count the number of rows in our winners table:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">)</code><code class="o">.</code><code class="n">count</code><code class="p">()</code>
<code class="n">Out</code><code class="p">:</code>
<code class="mi">3</code></pre>
<p>Next, let’s retrieve all Swiss winners:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">)</code><code class="o">.</code><code class="n">filter_by</code><code class="p">(</code><code class="n">nationality</code><code class="o">=</code><code class="s1">'</code><code class="s1">Swiss</code><code class="s1">'</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO10-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="nb">list</code><code class="p">(</code><code class="n">result</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">:</code><code>
</code><code class="p">[</code><code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'</code><code class="s1">Albert Einstein</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">category</code><code class="o">=</code><code class="s1">'</code><code class="s1">Physics</code><code class="s1">'</code><code class="p">,</code><code>\
</code><code>  </code><code class="n">year</code><code class="o">=</code><code class="s1">'</code><code class="s1">1921</code><code class="s1">'</code><code class="p">)</code><code class="o">&gt;</code><code class="p">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO10-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p><code>filter_by</code> uses keyword expressions; its SQL expressions counterpart is <span class="keep-together"><code>filter</code></span>—for example, <code>filter(Winner.nationality == <em>Swiss</em>)</code>. Note the Boolean equivalence <code>==</code> used in <code>filter</code>.</p></dd>
</dl>
<p class="pagebreak-before">Now let’s get all non-Swiss physics winners:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">result</code> <code class="o">=</code> <code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">)</code><code class="o">.</code><code class="n">filter</code><code class="p">(</code>\
             <code class="n">Winner</code><code class="o">.</code><code class="n">category</code> <code class="o">==</code> <code class="s1">'Physics'</code><code class="p">,</code> \
             <code class="n">Winner</code><code class="o">.</code><code class="n">nationality</code> <code class="o">!=</code> <code class="s1">'Swiss'</code><code class="p">)</code>
<code class="nb">list</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[</code><code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Paul Dirac'</code><code class="p">,</code> <code class="n">category</code><code class="o">=</code><code class="s1">'Physics'</code><code class="p">,</code> <code class="n">year</code><code class="o">=</code><code class="s1">'1933'</code><code class="p">)</code><code class="o">&gt;</code><code class="p">]</code></pre>
<p>Here’s how to get a row based on ID number:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">)</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>
<code class="n">Out</code><code class="p">:</code>
<code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Marie Curie'</code><code class="p">,</code> <code class="n">category</code><code class="o">=</code><code class="s1">'Chemistry'</code><code class="p">,</code> <code class="n">year</code><code class="o">=</code><code class="s1">'1911'</code><code class="p">)</code><code class="o">&gt;</code></pre>
<p>Now let’s retrieve winners ordered by year:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">res</code> <code class="o">=</code> <code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">)</code><code class="o">.</code><code class="n">order_by</code><code class="p">(</code><code class="s1">'year'</code><code class="p">)</code>
<code class="nb">list</code><code class="p">(</code><code class="n">res</code><code class="p">)</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[</code><code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Marie Curie'</code><code class="p">,</code> <code class="n">category</code><code class="o">=</code><code class="s1">'Chemistry'</code><code class="p">,</code>\
<code class="n">year</code><code class="o">=</code><code class="s1">'1911'</code><code class="p">)</code><code class="o">&gt;</code><code class="p">,</code>
 <code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Albert Einstein'</code><code class="p">,</code> <code class="n">category</code><code class="o">=</code><code class="s1">'Physics'</code><code class="p">,</code>\
<code class="n">year</code><code class="o">=</code><code class="s1">'1921'</code><code class="p">)</code><code class="o">&gt;</code><code class="p">,</code>
 <code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Paul Dirac'</code><code class="p">,</code> <code class="n">category</code><code class="o">=</code><code class="s1">'Physics'</code><code class="p">,</code> <code class="n">year</code><code class="o">=</code><code class="s1">'1933'</code><code class="p">)</code><code class="o">&gt;</code><code class="p">]</code></pre>
<p>To reconstruct our target list requires a little effort when converting the <code>Winner</code> objects returned by our session query into Python <code>dict</code>s. Let’s write a little function to create a <code>dict</code> from an SQLAlchemy class. We’ll use a little table introspection to get the column labels (see <a data-type="xref" href="#data_to_dict">Example 3-4</a>).</p>
<div data-type="example" id="data_to_dict">
<h5><span class="label">Example 3-4. </span>Converts an SQLAlchemy instance to a <code>dict</code></h5>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code><code> </code><code class="nf">inst_to_dict</code><code class="p">(</code><code class="n">inst</code><code class="p">,</code><code> </code><code class="n">delete_id</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">dat</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">column</code><code> </code><code class="ow">in</code><code> </code><code class="n">inst</code><code class="o">.</code><code class="n">__table__</code><code class="o">.</code><code class="n">columns</code><code class="p">:</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO11-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="n">dat</code><code class="p">[</code><code class="n">column</code><code class="o">.</code><code class="n">name</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nb">getattr</code><code class="p">(</code><code class="n">inst</code><code class="p">,</code><code> </code><code class="n">column</code><code class="o">.</code><code class="n">name</code><code class="p">)</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="n">delete_id</code><code class="p">:</code><code>
</code><code>        </code><code class="n">dat</code><code class="o">.</code><code class="n">pop</code><code class="p">(</code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO11-2" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">dat</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO11-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Accesses the instance’s table class to get a list of column objects.</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO11-2" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>If <code>delete_id</code> is true, remove the SQL primary ID field.</p></dd>
</dl></div>
<p>We can use <a data-type="xref" href="#data_to_dict">Example 3-4</a> to reconstruct our <code>nobel_winners</code> target list:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">winner_rows</code> <code class="o">=</code> <code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">)</code>
<code class="n">nobel_winners</code> <code class="o">=</code> <code class="p">[</code><code class="n">inst_to_dict</code><code class="p">(</code><code class="n">w</code><code class="p">)</code> <code class="k">for</code> <code class="n">w</code> <code class="ow">in</code> <code class="n">winner_rows</code><code class="p">]</code>
<code class="n">nobel_winners</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[{</code><code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Albert Einstein'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Swiss'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1921</code><code class="p">},</code>
  <code class="o">...</code>
<code class="p">]</code></pre>
<p>You can update database rows easily by changing the property of their reflected objects:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">marie</code><code> </code><code class="o">=</code><code> </code><code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">)</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO12-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="n">marie</code><code class="o">.</code><code class="n">nationality</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">French</code><code class="s1">'</code><code>
</code><code class="n">session</code><code class="o">.</code><code class="n">dirty</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO12-2" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="n">Out</code><code class="p">:</code><code>
</code><code class="n">IdentitySet</code><code class="p">(</code><code class="p">[</code><code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'</code><code class="s1">Marie Curie</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">category</code><code class="o">=</code><code class="s1">'</code><code class="s1">Chemistry</code><code class="s1">'</code><code class="p">,</code><code>
</code><code class="n">year</code><code class="o">=</code><code class="s1">'</code><code class="s1">1911</code><code class="s1">'</code><code class="p">)</code><code class="o">&gt;</code><code class="p">]</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO12-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Fetches Marie Curie, nationality Polish.</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO12-2" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p><code>dirty</code> shows any changed instances not yet committed to the database.</p></dd>
</dl>
<p>Let’s commit <code>Marie</code>’s changes and check that her nationality has changed from Polish to French:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code>
<code class="n">Out</code><code class="p">:</code>
<code class="n">INFO</code><code class="p">:</code><code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">base</code><code class="o">.</code><code class="n">Engine</code><code class="p">:</code><code class="n">UPDATE</code> <code class="n">winners</code> <code class="n">SET</code>
<code class="n">nationality</code><code class="o">=</code><code class="err">?</code> <code class="n">WHERE</code> <code class="n">winners</code><code class="o">.</code><code class="n">id</code> <code class="o">=</code> <code class="err">?</code>
<code class="n">INFO</code><code class="p">:</code><code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">base</code><code class="o">.</code><code class="n">Engine</code><code class="p">:(</code><code class="s1">'French'</code><code class="p">,</code> <code class="mi">3</code><code class="p">)</code>
<code class="o">...</code>

<code class="n">session</code><code class="o">.</code><code class="n">dirty</code>
<code class="n">Out</code><code class="p">:</code>
<code class="n">IdentitySet</code><code class="p">([])</code>

<code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">)</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code><code class="o">.</code><code class="n">nationality</code>
<code class="n">Out</code><code class="p">:</code>
<code class="s1">'French'</code></pre>
<p>In addition to updating database rows, you can delete the results of a query:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">)</code><code class="o">.</code><code class="n">filter_by</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Albert Einstein'</code><code class="p">)</code><code class="o">.</code><code class="n">delete</code><code class="p">()</code>
<code class="n">Out</code><code class="p">:</code>
<code class="n">INFO</code><code class="p">:</code><code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">base</code><code class="o">.</code><code class="n">Engine</code><code class="p">:</code><code class="n">DELETE</code> <code class="n">FROM</code> <code class="n">winners</code> <code class="n">WHERE</code>
<code class="n">winners</code><code class="o">.</code><code class="n">name</code> <code class="o">=</code> <code class="err">?</code>
<code class="n">INFO</code><code class="p">:</code><code class="n">sqlalchemy</code><code class="o">.</code><code class="n">engine</code><code class="o">.</code><code class="n">base</code><code class="o">.</code><code class="n">Engine</code><code class="p">:(</code><code class="s1">'Albert Einstein'</code><code class="p">,)</code>
<code class="mi">1</code>

<code class="nb">list</code><code class="p">(</code><code class="n">session</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">Winner</code><code class="p">))</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[</code><code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Paul Dirac'</code><code class="p">,</code> <code class="n">category</code><code class="o">=</code><code class="s1">'Physics'</code><code class="p">,</code> <code class="n">year</code><code class="o">=</code><code class="s1">'1933'</code><code class="p">)</code><code class="o">&gt;</code><code class="p">,</code>
 <code class="o">&lt;</code><code class="n">Winner</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Marie Curie'</code><code class="p">,</code> <code class="n">category</code><code class="o">=</code><code class="s1">'Chemistry'</code><code class="p">,</code>\
 <code class="n">year</code><code class="o">=</code><code class="s1">'1911'</code><code class="p">)</code><code class="o">&gt;</code><code class="p">]</code></pre>
<p>You can also drop the whole table if required, using the declarative class’s <code>__table__</code> attribute:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">Winner</code><code class="o">.</code><code class="n">__table__</code><code class="o">.</code><code class="n">drop</code><code class="p">(</code><code class="n">engine</code><code class="p">)</code></pre>
<p>In this section, we’ve dealt with a single winners table, without any foreign keys or relationship to any other tables, akin to a CSV or JSON file. SQLAlchemy adds the same level of convenience in dealing with many-to-one, one-to-many, and other database table relationships as it does to basic querying using implicit joins, by supplying the <code>query</code> method with more than one table class or explicitly using the query’s <code>join</code> method. Check out the examples <a href="https://oreil.ly/6KFCf">in the SQLAlchemy docs</a> for more details.<a data-primary="SQLAlchemy" data-startref="ix_SQLAlc" data-type="indexterm" id="idm45607795366336"/></p>
</div></section>
<section data-pdf-bookmark="Easier SQL with Dataset" data-type="sect2"><div class="sect2" id="dataset">
<h2>Easier SQL with Dataset</h2>
<p>One library I’ve found myself using a fair deal recently is <a href="https://oreil.ly/aGqTL">Dataset</a>, a module designed to make working with SQL databases <a data-primary="Dataset module (Python), easier SQL with" data-type="indexterm" id="idm45607795315872"/><a data-primary="SQL" data-secondary="working with databases using Dataset" data-type="indexterm" id="idm45607795315200"/>a little easier and more Pythonic than existing powerhouses like SQLAlchemy.<sup><a data-type="noteref" href="ch03.xhtml#idm45607795314160" id="idm45607795314160-marker">6</a></sup> Dataset tries to provide the same degree of convenience you get when working with schema-less NoSQL databases such as MongoDB by removing a lot of the formal boilerplate, such as schema definitions, which are demanded by the more conventional libraries. <a data-primary="schemas" data-secondary="database" data-tertiary="schema-less NoSQL databases" data-type="indexterm" id="idm45607795312672"/>Dataset is built on top of SQLAlchemy, which means it works with pretty much all major databases and can exploit the power, robustness, and maturity of that best-of-breed library. Let’s see how it deals with reading and writing our target dataset (from <a data-type="xref" href="#data_dummydata">Example 3-1</a>).</p>
<p>Let’s use the SQLite <em>nobel_winners.db</em> database we’ve just created to put Dataset through its paces. First, we connect to our SQL database, using the same URL/file format as SQLAlchemy:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">dataset</code>

<code class="n">db</code> <code class="o">=</code> <code class="n">dataset</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'sqlite:///data/nobel_winners.db'</code><code class="p">)</code></pre>
<p>To get our list of winners, we grab a table from our <code>db</code> database, using its name as a key, and then use the <code>find</code> method without arguments to return all winners:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">wtable</code> <code class="o">=</code> <code class="n">db</code><code class="p">[</code><code class="s1">'winners'</code><code class="p">]</code>
<code class="n">winners</code> <code class="o">=</code> <code class="n">wtable</code><code class="o">.</code><code class="n">find</code><code class="p">()</code>
<code class="n">winners</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="n">winners</code><code class="p">)</code>
<code class="n">winners</code>
<code class="c1">#Out:</code>
<code class="c1">#[OrderedDict([(u'id', 1), ('name', 'Albert Einstein'),</code>
<code class="c1"># ('category', 'Physics'), ('year', 1921), ('nationality',</code>
<code class="c1"># 'Swiss'), ('gender', 'male')]), OrderedDict([('id', 2),</code>
<code class="c1"># ('name', 'Paul Dirac'), ('category', 'Physics'),</code>
<code class="c1"># ('year', 1933), ('nationality', 'British'), ('gender',</code>
<code class="c1"># 'male')]), OrderedDict([('id', 3), ('name', 'Marie</code>
<code class="c1"># Curie'), ('category', 'Chemistry'), ('year', 1911),</code>
<code class="c1"># ('nationality', 'Polish'), ('gender', 'female')])]</code></pre>
<p>Note that the instances returned by Dataset’s <code>find</code> method are <code>OrderedDict</code>s. <a data-primary="OrderedDict type (Python)" data-type="indexterm" id="idm45607795273904"/>These useful containers are an extension of Python’s <code>dict</code> class and behave just like dictionaries except that they remember the order in which items were inserted, meaning you can guarantee the result of iteration, pop the last item inserted, and more. This is a very handy additional functionality.</p>
<div data-type="tip"><h6>Tip</h6>
<p>One of the most useful Python “batteries” for data manipulators is <code>collections</code>, which is where Dataset’s <code>OrderedDict</code>s come from. The <code>defaultdict</code> and <code>Counter</code> classes are particularly useful. Check out what’s available in the <a href="https://oreil.ly/Vh4EF">Python docs</a>.</p>
</div>
<p>Let’s re-create our winners table with Dataset, first dropping the existing one:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">wtable</code> <code class="o">=</code> <code class="n">db</code><code class="p">[</code><code class="s1">'winners'</code><code class="p">]</code>
<code class="n">wtable</code><code class="o">.</code><code class="n">drop</code><code class="p">()</code>

<code class="n">wtable</code> <code class="o">=</code> <code class="n">db</code><code class="p">[</code><code class="s1">'winners'</code><code class="p">]</code>
<code class="n">wtable</code><code class="o">.</code><code class="n">find</code><code class="p">()</code>
<code class="c1">#Out:</code>
<code class="c1">#[]</code></pre>
<p>To re-create our dropped winners table, we don’t need to define a schema as with SQLAlchemy (see <a data-type="xref" href="#sql_schema">“Defining the Database Tables”</a>). Dataset will infer that from the data we add, doing all the SQL creation implicitly. This is the kind of convenience one is used to when working with collection-based NoSQL databases. Let’s use our <code>nobel_winners</code> dataset (<a data-type="xref" href="#data_dummydata">Example 3-1</a>) to insert some winner dictionaries. <a data-primary="transactions (database)" data-type="indexterm" id="idm45607795165392"/><a data-primary="with statement (Python)" data-type="indexterm" id="idm45607795164720"/>We use a database transaction and the <code>with</code> statement to efficiently insert our objects and then commit them:<sup><a data-type="noteref" href="ch03.xhtml#idm45607795163536" id="idm45607795163536-marker">7</a></sup></p>
<pre data-code-language="python" data-type="programlisting"><code class="k">with</code><code> </code><code class="n">db</code><code> </code><code class="k">as</code><code> </code><code class="n">tx</code><code class="p">:</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO13-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>     </code><code class="n">tx</code><code class="p">[</code><code class="s1">'</code><code class="s1">winners</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">insert_many</code><code class="p">(</code><code class="n">nobel_winners</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO13-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Use the <code>with</code> statement to guarantee the transaction <code>tx</code> is committed to the database.</p></dd>
</dl>
<p>Let’s check that everything has gone well:</p>
<pre data-code-language="python" data-type="programlisting"><code class="nb">list</code><code class="p">(</code><code class="n">db</code><code class="p">[</code><code class="s1">'winners'</code><code class="p">]</code><code class="o">.</code><code class="n">find</code><code class="p">())</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[</code><code class="n">OrderedDict</code><code class="p">([(</code><code class="s1">'id'</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code> <code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'Albert Einstein'</code><code class="p">),</code>
<code class="p">(</code><code class="s1">'category'</code><code class="p">,</code> <code class="s1">'Physics'</code><code class="p">),</code> <code class="p">(</code><code class="s1">'year'</code><code class="p">,</code> <code class="mi">1921</code><code class="p">),</code> <code class="p">(</code><code class="s1">'nationality'</code><code class="p">,</code>
<code class="s1">'Swiss'</code><code class="p">),</code> <code class="p">(</code><code class="s1">'gender'</code><code class="p">,</code> <code class="s1">'male'</code><code class="p">)]),</code>
<code class="o">...</code>
<code class="p">]</code></pre>
<p>The winners have been correctly inserted and their order of insertion preserved by the <code>OrderedDict</code>.</p>
<p>Dataset is great for basic SQL-based work, particularly retrieving data you might wish to process or visualize. For more advanced manipulation, it allows you to drop down into SQLAlchemy’s core API using the <code>query</code> method.</p>
<p>Now that we’ve covered the basics of working with SQL databases, let’s see how Python makes working with the most popular NoSQL database just as painless.<a data-primary="SQL" data-secondary="reading and writing with Python" data-startref="ix_SQLPy" data-type="indexterm" id="idm45607795041392"/><a data-primary="Python" data-secondary="reading and writing data" data-startref="ix_PyrwrSQL" data-tertiary="SQL" data-type="indexterm" id="idm45607795040176"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="MongoDB" data-type="sect1"><div class="sect1" id="data_mongodb">
<h1>MongoDB</h1>
<p>Document-centric datastores like MongoDB offer a lot of convenience to data wranglers.<a data-primary="Python" data-secondary="reading and writing data" data-tertiary="MongoDB" data-type="indexterm" id="ix_PyrwrMDB"/><a data-primary="MongoDB" data-secondary="working with in Python" data-type="indexterm" id="ix_MDBPy"/> As with all tools, there are good and bad use cases for NoSQL databases. If you have data that has already been refined and processed and don’t anticipate needing SQL’s powerful query language based on optimized table joins, MongoDB will probably prove easier to work with initially.  MongoDB is a particularly good fit for web dataviz because it uses binary JSON (BSON) as its data format. <a data-primary="BSON (binary JSON)" data-type="indexterm" id="idm45607795007104"/><a data-primary="binary JSON" data-see="BSON" data-type="indexterm" id="idm45607795006496"/>An extension of JSON, BSON can deal with binary data and <code>datetime</code> objects, and plays very nicely with JavaScript.</p>
<p>Let’s remind ourselves of the target dataset we’re aiming to write and read:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">nobel_winners</code> <code class="o">=</code> <code class="p">[</code>
 <code class="p">{</code><code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Albert Einstein'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Swiss'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1921</code><code class="p">},</code>
  <code class="o">...</code>
<code class="p">]</code></pre>
<p>Creating a MongoDB collection with Python is the work of a few lines:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code><code> </code><code class="nn">pymongo</code><code> </code><code class="kn">import</code><code> </code><code class="n">MongoClient</code><code>
</code><code>
</code><code class="n">client</code><code> </code><code class="o">=</code><code> </code><code class="n">MongoClient</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="n">db</code><code> </code><code class="o">=</code><code> </code><code class="n">client</code><code class="o">.</code><code class="n">nobel_prize</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-2" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="n">coll</code><code> </code><code class="o">=</code><code> </code><code class="n">db</code><code class="o">.</code><code class="n">winners</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-3" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Creates a Mongo client, using the default host and ports.</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-2" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Creates or accesses the <code>nobel_prize</code> database.</p></dd>
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-3" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO14-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>If a winners collection exists, this will retrieve it; otherwise (as in our case), it creates it.</p></dd>
</dl>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45607794914240">
<h5>Using Constants for MongoDB Access</h5>
<p>Accessing and <a data-primary="MongoDB" data-secondary="working with in Python" data-tertiary="using constants to access MongoDB" data-type="indexterm" id="idm45607794882288"/>creating a MongoDB database with Python involves the same operation, using dot notation and square-bracket key access:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">db</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">nobel_prize</code>
<code class="n">db</code> <code class="o">=</code> <code class="n">client</code><code class="p">[</code><code class="s1">'nobel_prize'</code><code class="p">]</code></pre>
<p>This is all very convenient, but it means a single spelling mistake, such as <code>noble_prize</code>, could both create an unwanted database and cause future operations to fail to update the correct one. For this reason, I advise using constant strings to access your MongoDB databases and collections:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">DB_NOBEL_PRIZE</code> <code class="o">=</code> <code class="s1">'nobel_prize'</code>
<code class="n">COLL_WINNERS</code> <code class="o">=</code> <code class="s1">'winners'</code>

<code class="n">db</code> <code class="o">=</code> <code class="n">client</code><code class="p">[</code><code class="n">DB_NOBEL_PRIZE</code><code class="p">]</code>
<code class="n">coll</code> <code class="o">=</code> <code class="n">db</code><code class="p">[</code><code class="n">COLL_WINNERS</code><code class="p">]</code></pre>
</div></aside>
<p>MongoDB databases run on localhost port 27017 by default but could be anywhere on the web. They also take an optional username and password. <a data-type="xref" href="#data_get_mongo">Example 3-5</a> shows how to  create a simple utility function to access our database, with standard defaults.<a data-primary="MongoDB" data-secondary="working with in Python" data-tertiary="creating utility function to access database" data-type="indexterm" id="idm45607794825968"/></p>
<div data-type="example" id="data_get_mongo">
<h5><span class="label">Example 3-5. </span>Accessing a MongoDB database</h5>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code><code> </code><code class="nn">pymongo</code><code> </code><code class="kn">import</code><code> </code><code class="n">MongoClient</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">get_mongo_database</code><code class="p">(</code><code class="n">db_name</code><code class="p">,</code><code> </code><code class="n">host</code><code class="o">=</code><code class="s1">'</code><code class="s1">localhost</code><code class="s1">'</code><code class="p">,</code><code>\
</code><code>                       </code><code class="n">port</code><code class="o">=</code><code class="mi">27017</code><code class="p">,</code><code> </code><code class="n">username</code><code class="o">=</code><code class="kc">None</code><code class="p">,</code><code> </code><code class="n">password</code><code class="o">=</code><code class="kc">None</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="sd">""" Get named database from MongoDB with/out authentication """</code><code>
</code><code>    </code><code class="c1"># make Mongo connection with/out authentication</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="n">username</code><code> </code><code class="ow">and</code><code> </code><code class="n">password</code><code class="p">:</code><code>
</code><code>        </code><code class="n">mongo_uri</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">mongodb://</code><code class="si">%s</code><code class="s1">:</code><code class="si">%s</code><code class="s1">@</code><code class="si">%s</code><code class="s1">/</code><code class="si">%s</code><code class="s1">'</code><code class="o">%</code><code>\</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO15-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="p">(</code><code class="n">username</code><code class="p">,</code><code> </code><code class="n">password</code><code class="p">,</code><code> </code><code class="n">host</code><code class="p">,</code><code> </code><code class="n">db_name</code><code class="p">)</code><code>
</code><code>        </code><code class="n">conn</code><code> </code><code class="o">=</code><code> </code><code class="n">MongoClient</code><code class="p">(</code><code class="n">mongo_uri</code><code class="p">)</code><code>
</code><code>    </code><code class="k">else</code><code class="p">:</code><code>
</code><code>        </code><code class="n">conn</code><code> </code><code class="o">=</code><code> </code><code class="n">MongoClient</code><code class="p">(</code><code class="n">host</code><code class="p">,</code><code> </code><code class="n">port</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">conn</code><code class="p">[</code><code class="n">db_name</code><code class="p">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO15-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We specify the database name in the MongoDB URI (Uniform Resource Identifier) as the user may not have general privileges for the database.</p></dd>
</dl></div>
<p>We can now create a Nobel Prize database and add our target dataset (<a data-type="xref" href="#data_dummydata">Example 3-1</a>). Let’s first get a winners<a data-primary="MongoDB" data-secondary="working with in Python" data-tertiary="creating database and inserting target dataset" data-type="indexterm" id="idm45607794707536"/> collection, using the string constants for access:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">db</code> <code class="o">=</code> <code class="n">get_mongo_database</code><code class="p">(</code><code class="n">DB_NOBEL_PRIZE</code><code class="p">)</code>
<code class="n">coll</code> <code class="o">=</code> <code class="n">db</code><code class="p">[</code><code class="n">COLL_WINNERS</code><code class="p">]</code></pre>
<p>Inserting our Nobel Prize dataset is then as easy as can be:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">coll</code><code class="o">.</code><code class="n">insert_many</code><code class="p">(</code><code class="n">nobel_winners</code><code class="p">)</code>
<code class="n">coll</code><code class="o">.</code><code class="n">find</code><code class="p">()</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[{</code><code class="s1">'_id'</code><code class="p">:</code> <code class="n">ObjectId</code><code class="p">(</code><code class="s1">'61940b7dc454e79ffb14cd25'</code><code class="p">),</code>
  <code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Albert Einstein'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Swiss'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1921</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">},</code>
 <code class="p">{</code><code class="s1">'_id'</code><code class="p">:</code> <code class="n">ObjectId</code><code class="p">(</code><code class="s1">'61940b7dc454e79ffb14cd26'</code><code class="p">),</code> <code class="o">...</code> <code class="p">}</code>
 <code class="o">...</code><code class="p">]</code></pre>
<p>The resulting array of <code>ObjectId</code>s can be used for <a data-primary="ObjectIds (MongoDB)" data-type="indexterm" id="idm45607794584048"/>future retrieval, but MongoDB has already left its stamp on our <code>nobel_winners</code> list, adding a hidden <code>id</code> property.<sup><a data-type="noteref" href="ch03.xhtml#idm45607794582448" id="idm45607794582448-marker">8</a></sup></p>
<div data-type="tip"><h6>Tip</h6>
<p>MongoDB’s <code>ObjectId</code>s have quite a bit of hidden functionality, being a lot more than a simple random identifier. You can, for example, get the generation time of the <code>ObjectId</code>, which gives you access to a handy timestamp:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">bson</code>
<code class="n">oid</code> <code class="o">=</code> <code class="n">bson</code><code class="o">.</code><code class="n">ObjectId</code><code class="p">()</code>
<code class="n">oid</code><code class="o">.</code><code class="n">generation_time</code>
<code class="n">Out</code><code class="p">:</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="p">(</code><code class="mi">2015</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">43</code><code class="p">,</code> <code class="mf">23.</code><code class="o">..</code></pre>
<p>Find the full details in the <a href="https://oreil.ly/NBwsk">MongoDB BSON documentation</a>.</p>
</div>
<p>Now that we’ve got some items in our winners collection, MongoDB makes finding them very easy, with its <code>find</code> method taking <a data-primary="find method (MongoDB)" data-type="indexterm" id="idm45607794487776"/>a dictionary query:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">res</code> <code class="o">=</code> <code class="n">coll</code><code class="o">.</code><code class="n">find</code><code class="p">({</code><code class="s1">'category'</code><code class="p">:</code><code class="s1">'Chemistry'</code><code class="p">})</code>
<code class="nb">list</code><code class="p">(</code><code class="n">res</code><code class="p">)</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[{</code><code class="s1">'_id'</code><code class="p">:</code> <code class="n">ObjectId</code><code class="p">(</code><code class="s1">'55f8326f26a7112e547879d6'</code><code class="p">),</code>
  <code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Chemistry'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Marie Curie'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Polish'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'female'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1911</code><code class="p">}]</code></pre>
<p>There are a number of special dollar-prefixed operators that allow for sophisticated querying.<a data-primary="MongoDB" data-secondary="working with in Python" data-tertiary="querying the database" data-type="indexterm" id="idm45607794455744"/><a data-primary="querying databases" data-secondary="MongoDB, querying in Python" data-type="indexterm" id="idm45607794436624"/><a data-primary="dollar sign ($) prefixing operators in MongoDB" data-type="indexterm" id="idm45607794435712"/> Let’s find all the winners after 1930 using the <code>$gt</code> (greater-than) operator:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">res</code> <code class="o">=</code> <code class="n">coll</code><code class="o">.</code><code class="n">find</code><code class="p">({</code><code class="s1">'year'</code><code class="p">:</code> <code class="p">{</code><code class="s1">'$gt'</code><code class="p">:</code> <code class="mi">1930</code><code class="p">}})</code>
<code class="nb">list</code><code class="p">(</code><code class="n">res</code><code class="p">)</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[{</code><code class="s1">'_id'</code><code class="p">:</code> <code class="n">ObjectId</code><code class="p">(</code><code class="s1">'55f8326f26a7112e547879d5'</code><code class="p">),</code>
  <code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Paul Dirac'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'British'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1933</code><code class="p">}]</code></pre>
<p>You can also use a Boolean expression, for instance, to find <a data-primary="Boolean expressions" data-secondary="using in Python to query MongoDB" data-type="indexterm" id="idm45607794399424"/>all winners after 1930 or all female winners:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">res</code> <code class="o">=</code> <code class="n">coll</code><code class="o">.</code><code class="n">find</code><code class="p">({</code><code class="s1">'$or'</code><code class="p">:[{</code><code class="s1">'year'</code><code class="p">:</code> <code class="p">{</code><code class="s1">'$gt'</code><code class="p">:</code> <code class="mi">1930</code><code class="p">}},</code>\
<code class="p">{</code><code class="s1">'gender'</code><code class="p">:</code><code class="s1">'female'</code><code class="p">}]})</code>
<code class="nb">list</code><code class="p">(</code><code class="n">res</code><code class="p">)</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[{</code><code class="s1">'_id'</code><code class="p">:</code> <code class="n">ObjectId</code><code class="p">(</code><code class="s1">'55f8326f26a7112e547879d5'</code><code class="p">),</code>
  <code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Paul Dirac'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'British'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1933</code><code class="p">},</code>
 <code class="p">{</code><code class="s1">'_id'</code><code class="p">:</code> <code class="n">ObjectId</code><code class="p">(</code><code class="s1">'55f8326f26a7112e547879d6'</code><code class="p">),</code>
  <code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Chemistry'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Marie Curie'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Polish'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'female'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1911</code><code class="p">}]</code></pre>
<p>You can find the full list of available query expressions in the <a href="https://oreil.ly/1D2Sr">MongoDB <span class="keep-together">documentation</span></a>.</p>
<p>As a final test, let’s turn our new winners collection back into a Python list of dictionaries.<a data-primary="dictionaries (dicts)" data-secondary="converting MongoDB collection into Python list of dictionaries" data-type="indexterm" id="idm45607794273360"/> We’ll create a utility function for the task:</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code><code> </code><code class="nf">mongo_coll_to_dicts</code><code class="p">(</code><code class="n">dbname</code><code class="o">=</code><code class="s1">'</code><code class="s1">test</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">collname</code><code class="o">=</code><code class="s1">'</code><code class="s1">test</code><code class="s1">'</code><code class="p">,</code><code>\
</code><code>                        </code><code class="n">query</code><code class="o">=</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">del_id</code><code class="o">=</code><code class="kc">True</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kw</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO16-1" id="co_reading_and_writing_data__span_class__keep_together__with_python__span__CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>
</code><code>    </code><code class="n">db</code><code> </code><code class="o">=</code><code> </code><code class="n">get_mongo_database</code><code class="p">(</code><code class="n">dbname</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kw</code><code class="p">)</code><code>
</code><code>    </code><code class="n">res</code><code> </code><code class="o">=</code><code> </code><code class="nb">list</code><code class="p">(</code><code class="n">db</code><code class="p">[</code><code class="n">collname</code><code class="p">]</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="n">query</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="n">del_id</code><code class="p">:</code><code>
</code><code>        </code><code class="k">for</code><code> </code><code class="n">r</code><code> </code><code class="ow">in</code><code> </code><code class="n">res</code><code class="p">:</code><code>
</code><code>            </code><code class="n">r</code><code class="o">.</code><code class="n">pop</code><code class="p">(</code><code class="s1">'</code><code class="s1">_id</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">res</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_reading_and_writing_data__span_class__keep_together__with_python__span__CO16-1" id="callout_reading_and_writing_data__span_class__keep_together__with_python__span__CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>An empty <code>query dict {}</code> will find all documents in the collection. <code>del_id</code> is a flag to remove MongoDB’s <code>ObjectId</code>s from the items by default.</p></dd>
</dl>
<p>We can now create our target dataset:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">mongo_coll_to_dicts</code><code class="p">(</code><code class="n">DB_NOBEL_PRIZE</code><code class="p">,</code> <code class="n">COLL_WINNERS</code><code class="p">)</code>
<code class="n">Out</code><code class="p">:</code>
<code class="p">[{</code><code class="s1">'category'</code><code class="p">:</code> <code class="s1">'Physics'</code><code class="p">,</code>
  <code class="s1">'name'</code><code class="p">:</code> <code class="s1">'Albert Einstein'</code><code class="p">,</code>
  <code class="s1">'nationality'</code><code class="p">:</code> <code class="s1">'Swiss'</code><code class="p">,</code>
  <code class="s1">'gender'</code><code class="p">:</code> <code class="s1">'male'</code><code class="p">,</code>
  <code class="s1">'year'</code><code class="p">:</code> <code class="mi">1921</code><code class="p">},</code>
  <code class="o">...</code>
<code class="p">]</code></pre>
<p>MongoDB’s schema-less databases are great for fast prototyping in solo work or small teams.<a data-primary="schemas" data-secondary="database" data-tertiary="MongoDB and" data-type="indexterm" id="idm45607794059888"/> There will probably come a point, particularly with large codebases, when a formal schema becomes a useful reference and sanity check; when you are choosing a data model, the ease with which document forms can be adapted is a bonus. Being able to pass Python dictionaries as queries to PyMongo and having access to client-side generated <code>ObjectId</code>s are a couple of other conveniences.</p>
<p>We’ve now passed the <code>nobel_winners</code> data in <a data-type="xref" href="#data_dummydata">Example 3-1</a> through all our required file formats and databases.<a data-primary="MongoDB" data-secondary="working with in Python" data-tertiary="dealing with dates and times" data-type="indexterm" id="idm45607794020240"/><a data-primary="dates and times" data-secondary="dealing with when working with MongoDB in Python" data-type="indexterm" id="idm45607794019056"/> Let’s consider the special case of dealing with dates and times before summing up.</p>
</div></section>
<section data-pdf-bookmark="Dealing with Dates, Times, and Complex Data" data-type="sect1"><div class="sect1" id="sect_datetimes">
<h1>Dealing with Dates, Times, and Complex Data</h1>
<p>The ability to deal comfortably with dates and times is fundamental to dataviz work but can be quite tricky.<a data-primary="MongoDB" data-secondary="working with in Python" data-startref="ix_MDBPy" data-type="indexterm" id="idm45607794015744"/><a data-primary="Python" data-secondary="reading and writing data" data-startref="ix_PyrwrMDB" data-tertiary="MongoDB" data-type="indexterm" id="idm45607794014656"/><a data-primary="Python" data-secondary="reading and writing data" data-tertiary="dealing with dates, times, and complex data" data-type="indexterm" id="ix_Pyrwrdttm"/><a data-primary="dates and times" data-secondary="dealing with in Python and JavaScript" data-type="indexterm" id="ix_dttmPyJS"/> There are many ways to represent a date or datetime as a string, each one requiring a separate encoding or decoding. For this reason it’s good to settle on one format in your own work and encourage others to do the same.<a data-primary="Coordinated Universal Time (UTC)" data-type="indexterm" id="idm45607794010592"/><a data-primary="UTC (Coordinated Universal Time)" data-type="indexterm" id="idm45607794009952"/><a data-primary="ISO (International Standard Organization) 8601 time format" data-type="indexterm" id="idm45607794009312"/><a data-primary="time" data-secondary="formats for" data-seealso="dates and times" data-type="indexterm" id="idm45607794008672"/>  I recommend using the <a href="https://oreil.ly/HePpN">International Standard Organization (ISO) 8601 time format</a> as your string representation for dates and times, and using the <a href="https://oreil.ly/neP2I">Coordinated Universal Time (UTC) form</a>.<sup><a data-type="noteref" href="ch03.xhtml#idm45607794006016" id="idm45607794006016-marker">9</a></sup> Here are a few examples of ISO 8601 date and datetime strings:</p>
<table>
<tbody>
<tr>
<td><p>2021-09-23</p></td>
<td><p>A date  (Python/C format code <code>'%Y-%m-%d'</code>)</p></td>
</tr>
<tr>
<td><p>2021-09-23T16:32:35Z</p></td>
<td><p>A UTC (<em>Z</em> after time) date and time (<code>'T%H:%M:%S'</code>)</p></td>
</tr>
<tr>
<td><p>2021-09-23T16:32+02:00</p></td>
<td><p>A positive two-hour (+02:00) offset from UTC (e.g., Central European Time)</p></td>
</tr>
</tbody>
</table>
<p>Note the importance of being<a data-primary="time zones" data-type="indexterm" id="idm45607793998032"/> prepared to deal with different time zones. These are not always on lines of longitude (see <a href="https://oreil.ly/NZyE4">Wikipedia’s Time Zone entry</a>), and often the best way to derive an accurate time is by using UTC time plus a geographic location.</p>
<p>ISO 8601 is the standard used by JavaScript and is easy to work with in Python. As web data visualizers, our key concern is in creating a string representation that can be passed between Python and JavaScript using JSON and encoded and decoded easily at both ends.<a data-primary="JavaScript" data-secondary="string representation of Python datetime passed to" data-type="indexterm" id="idm45607793995968"/></p>
<p>Let’s take a date and time in the shape of a Python <code>datetime</code>, convert it into a string, and then see how that string can be consumed by JavaScript.<a data-primary="datetime object (Python)" data-secondary="conversion to string and consumption by JavaScript" data-type="indexterm" id="idm45607793994320"/><a data-primary="strings" data-secondary="converting Python datetimes to" data-type="indexterm" id="idm45607793993232"/></p>
<p>First, we produce our Python <code>datetime</code>:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>

<code class="n">d</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">()</code>
<code class="n">d</code><code class="o">.</code><code class="n">isoformat</code><code class="p">()</code>
<code class="n">Out</code><code class="p">:</code>
<code class="s1">'2021-11-16T22:55:48.738105'</code></pre>
<p>This string can then be saved to JSON or CSV, read by JavaScript, and used to create a <code>Date</code> object:</p>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// JavaScript</code>
<code class="nx">d</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="s1">'2021-11-16T22:55:48.738105'</code><code class="p">)</code>
<code class="o">&gt;</code> <code class="nx">Tue</code> <code class="nx">Nov</code> <code class="mi">16</code> <code class="mi">2021</code> <code class="mi">22</code><code class="o">:</code><code class="mi">55</code><code class="o">:</code><code class="mi">48</code> <code class="nx">GMT</code><code class="o">+</code><code class="mi">0000</code> <code class="p">(</code><code class="nx">Greenwich</code> <code class="nx">Mean</code> <code class="nx">Time</code><code class="p">)</code></pre>
<p>We can return the datetime to ISO 8601 <a data-primary="ISO (International Standard Organization) 8601 time format" data-secondary="converting JavaScript Date to" data-type="indexterm" id="idm45607793917872"/>string form with the <code>toISOString</code> method:</p>
<pre data-code-language="js" data-type="programlisting"><code class="c1">// JavaScript</code>
<code class="nx">d</code><code class="p">.</code><code class="nx">toISOString</code><code class="p">()</code>
<code class="o">&gt;</code> <code class="s1">'2021-11-16T22:55:48.738Z'</code></pre>
<p>Finally, we can read the string back into Python.</p>
<p>If you know that you’re <a data-primary="dateutil module (Python)" data-type="indexterm" id="idm45607793911392"/>dealing with an ISO-format time string, Python’s <code>dateutil</code> module should do the job.<sup><a data-type="noteref" href="ch03.xhtml#idm45607793910272" id="idm45607793910272-marker">10</a></sup> But you’ll probably want to sanity check the result:</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">dateutil</code> <code class="kn">import</code> <code class="n">parser</code>

<code class="n">d</code> <code class="o">=</code> <code class="n">parser</code><code class="o">.</code><code class="n">parse</code><code class="p">(</code><code class="s1">'2021-11-16T22:55:48.738Z'</code><code class="p">)</code>
<code class="n">d</code>
<code class="n">Out</code><code class="p">:</code>
<code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="p">(</code><code class="mi">2021</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">55</code><code class="p">,</code> <code class="mi">48</code><code class="p">,</code> <code class="mi">738000</code><code class="p">,</code>\
<code class="n">tzinfo</code><code class="o">=</code><code class="n">tzutc</code><code class="p">())</code></pre>
<p>Note that we’ve lost some resolution in the trip from Python to JavaScript and back again, the latter dealing in milliseconds, not microseconds. This is unlikely to be an issue in any dataviz work but is good to bear in mind just in case some strange temporal errors occur.<a data-primary="dates and times" data-secondary="dealing with in Python and JavaScript" data-startref=" ix_dttmPyJS" data-type="indexterm" id="idm45607793852608"/><a data-primary="Python" data-secondary="reading and writing with data" data-startref="ix_Pyrwrdttm" data-tertiary="dealing with dates, times, and complex data" data-type="indexterm" id="idm45607793825312"/></p>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45607794017760">
<h1>Summary</h1>
<p>This chapter aimed to make you comfortable using Python to move data around the various file formats and databases that a data visualizer might expect to bump into. Using databases effectively and efficiently is a skill that takes a while to learn, but you should now be comfortable with basic reading and writing for the large majority of dataviz use cases.</p>
<p>Now that we have the vital lubrication for our dataviz toolchain, let’s get up to scratch on the basic web development skills you’ll need for the chapters ahead.<a data-primary="Python" data-secondary="reading and writing data" data-startref="ix_Pyrwr" data-type="indexterm" id="idm45607793822240"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45607798394048"><sup><a href="ch03.xhtml#idm45607798394048-marker">1</a></sup> I recommend using JSON over CSV as your preferred data format.</p><p data-type="footnote" id="idm45607797415616"><sup><a href="ch03.xhtml#idm45607797415616-marker">2</a></sup> The Python module <code>dateutil</code> has a parser that will parse most dates and times sensibly, and might be a good basis for this.</p><p data-type="footnote" id="idm45607796976800"><sup><a href="ch03.xhtml#idm45607796976800-marker">3</a></sup> On a cautionary note, it is probably a bad idea to use different database configurations for testing and production.</p><p data-type="footnote" id="idm45607796966400"><sup><a href="ch03.xhtml#idm45607796966400-marker">4</a></sup> See details on <a href="https://oreil.ly/winYu">SQLAlchemy</a> of this <em>lazy initialization</em>.</p><p data-type="footnote" id="idm45607796702064"><sup><a href="ch03.xhtml#idm45607796702064-marker">5</a></sup> This assumes the database doesn’t already exist. If it does, <code>Base</code> will be used to create new insertions and to interpret retrievals.</p><p data-type="footnote" id="idm45607795314160"><sup><a href="ch03.xhtml#idm45607795314160-marker">6</a></sup> Dataset’s official motto is “Databases for lazy people.” It is not part of the standard Anaconda package, so you’ll want to install it using <code>pip</code> from the command line: <code>$ pip install dataset</code>.</p><p data-type="footnote" id="idm45607795163536"><sup><a href="ch03.xhtml#idm45607795163536-marker">7</a></sup> See <a href="https://oreil.ly/vqvbv">this documentation</a> for further details of how to use transactions to group updates.</p><p data-type="footnote" id="idm45607794582448"><sup><a href="ch03.xhtml#idm45607794582448-marker">8</a></sup> One of the cool things about MongoDB is that the <code>ObjectId</code>s are generated on the client side, removing the need to quiz the database for them.</p><p data-type="footnote" id="idm45607794006016"><sup><a href="ch03.xhtml#idm45607794006016-marker">9</a></sup> To get the actual local time from UTC, you can store a time zone offset or, better still, derive it from a geocoordinate; this is because time zones do not follow lines of longitude very exactly.</p><p data-type="footnote" id="idm45607793910272"><sup><a href="ch03.xhtml#idm45607793910272-marker">10</a></sup> To install, just run <code>pip install python-dateutil</code>. <code>dateutil</code> is a pretty powerful extension of Python’s <code>datetime</code>; check it out on <a href="https://oreil.ly/y6YWS">Read the Docs</a>.</p></div></div></section></div></body></html>