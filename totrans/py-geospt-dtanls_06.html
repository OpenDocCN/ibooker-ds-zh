<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 6. The ArcGIS Python API" data-type="chapter" epub:type="chapter"><div class="chapter" id="the_arcgis_python_api">
<h1><span class="label">Chapter 6. </span>The ArcGIS Python API</h1>
<p>The suite of client software and GIS developed by Esri, the global leader in GIS, is known as ArcGIS.<a contenteditable="false" data-primary="ArcGIS Python API" data-type="indexterm" id="ix_ArcGPy"/><a contenteditable="false" data-primary="Esri, ArcGIS" data-type="indexterm" id="idm45433740848304"/> It’s an API and Python package in one that allows users to query for information hosted in ArcGIS Online or ArcGIS Enterprise. It’s not open source, but Esri’s leadership in the industry has produced quite a lot of free content and tutorials that you can access and explore. I will share a few learning resources, accessible tools, and information that you can access with the ArcGIS Python API. You’ll need to use a Jupyter Notebook and ArcGIS Online to follow along.<a contenteditable="false" data-primary="Jupyter Notebooks" data-secondary="using with ArcGIS Online" data-type="indexterm" id="idm45433740850832"/></p>
<section data-pdf-bookmark="Setup" data-type="sect1"><div class="sect1" id="setup-id00008">
<h1>Setup</h1>
<p>There is a desktop application <a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="setup" data-type="indexterm" id="ix_ArcGPyset"/>called ArcGIS Pro as well as a browser-based platform called ArcGIS Online; in this chapter, you’ll be working with ArcGIS Online with the ArcGIS Python API.<a contenteditable="false" data-primary="ArcGIS Online" data-type="indexterm" id="idm45433740835984"/><a contenteditable="false" data-primary="ArcGIS Pro" data-type="indexterm" id="idm45433740859088"/></p>
<section data-pdf-bookmark="Modules Available in the ArcGIS Python API" data-type="sect2"><div class="sect2" id="modules_available_in_the_arcgis_python">
<h2>Modules Available in the ArcGIS Python API</h2>
<p>To <a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="setup" data-tertiary="modules available with" data-type="indexterm" id="idm45433740831728"/>extend the standard Python library, the ArcGIS Python API allows access to additional modules, available by dot notation. You can explore them in the <a href="https://oreil.ly/FaGv3">documentation</a>, and I will provide more information as we use them in our coding. These modules include:</p>
<dl>
<dt><code>Arcgis.gis</code></dt>
<dd>Connects you to ArcGIS Online</dd>
<dt><code>Arcgis.features</code></dt>
<dd>Offers functions for working with groups of geographic elements</dd>
<dt><code>Arcgis.geometry</code></dt>
<dd>Allows input and output of different geometries (points or polygons, for <span class="keep-together">example</span>)</dd>
<dt><code>Arcgis.geocoding</code></dt>
<dd>Assigns location coordinates for map visualization</dd>
<dt><code>Arcgis.geoenrichment</code></dt>
<dd>Adds attributes to an area</dd>
</dl>
<p>I use open source or low-cost options when teaching geospatial skills to make this knowledge accessible to as many people as possible. Since most Esri users are professional or enterprise subscribers, few understand the cost burden for personal use. Whatever you choose, please read the documentation carefully before using it to avoid unintended costs.</p>
<p>The ArcGIS API is distributed as the package arcgis. In the following example, you’ll install it via Conda, the suggested protocol, as you’ve done in several chapters in this book so far.</p>
</div></section>
<section data-pdf-bookmark="Installing ArcGIS Pro" data-type="sect2"><div class="sect2" id="installing_arcgis_pro">
<h2>Installing ArcGIS Pro</h2>
<p>Although ArcGIS Pro is only for Windows, the API lets non-Windows<a contenteditable="false" data-primary="ArcGIS Pro" data-secondary="installing" data-type="indexterm" id="idm45433740854704"/> users access ArcGIS features without having to open up a Windows environment. I am going to assume that if you already have a full ArcGIS Pro license, you can follow the documentation to install <a href="https://oreil.ly/sXsRt">Python Package Manager or Python Command Prompt</a>. To use the Pro license and work within your desktop environment with the API, you need to install ArcGIS on the same computer where you are running the commands.</p>
<div data-type="tip"><h6>Tip</h6>
<p>If, like me, you have an ArcGIS Pro account but prefer to work in MacOS, you can use ArcGIS Pro offline.<a contenteditable="false" data-primary="MacOS, working with ArcGIS Pro offline" data-type="indexterm" id="idm45433740816880"/> To do so, sign into your ArcGIS Pro account and, under Settings &gt;&gt; Licenses, check the box allowing you to work offline.</p>
</div>
<p>There are options to access publicly available resources even without a license, so let’s explore those.</p>
</div></section>
<section data-pdf-bookmark="Setting Up Your Environment" data-type="sect2"><div class="sect2" id="setting_up_your_environment">
<h2>Setting Up Your Environment</h2>
<p>Next, open your terminal. I suggest creating an environment <a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="setup" data-tertiary="setting up your environment" data-type="indexterm" id="idm45433740812528"/>for downloading ArcGIS. (As you may recall, environments allow you to install compatible versions of packages.) Here, I am calling my environment <code>esriENV</code>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Although it is possible to update individual packages within an environment, if I generate persistent errors when working in an environment, I delete the whole thing and re-create it from scratch. Here is a new Python geospatial package with commonly used packages that you may want to consider adding to any created space:</p>
<pre data-type="programlisting">
mamba install -c conda-forge geospatial</pre>
<p>You may be curious about the Mamba install listed here. Since the writing of this book, <a href="https://oreil.ly/1zzLj">mambaforge</a> has emerged as a Conda-forge community project.<a contenteditable="false" data-primary="Mamba, mambaforge as Conda-forge community project" data-type="indexterm" id="idm45433740810080"/> Operationally, Mamba promises speed and compatibility with Conda packages. As you experiment, you’ll reach your own preferred workflow. I have installed Mamba into my base environment and use it with my own projects, but the text has been written with the longer-term reliability of Conda environments.</p>
</div>
<p>Let’s review <a contenteditable="false" data-primary="Conda environment, creating" data-type="indexterm" id="idm45433741285872"/>how to create your environment and install the packages required for this Notebook. Enter the following code in the terminal, but instead of <code><em>myenv</em></code>, insert the name of <em>your</em> environment:</p>
<pre data-type="programlisting">
conda create --name myenv</pre>
<p>To create an environment and include a specific version of Python to address package dependencies, enter the following code:</p>
<pre data-type="programlisting">
#conda create --name <span>myenv</span> python=x.x
conda create --name esriENV python=3.9</pre>
<p>Now you must activate your new environment. We have only one channel or place to host installed packages at the moment, conda-forge, so we want all the dependencies that we need for installed packages to come from the conda-forge channel unless they exist only on default channels.<a contenteditable="false" data-primary="conda-forge channel" data-type="indexterm" id="idm45433741249824"/></p>
<p>Alternatively, you may want to have the newest versions of packages on any channel in your list. If this is the case, use <code>conda config --set channel_priority strict</code>:</p>
<pre data-type="programlisting">
conda activate esriENV
#conda config --set channel_priority strict</pre>
</div></section>
<section data-pdf-bookmark="Installing Packages" data-type="sect2"><div class="sect2" id="installing_packages">
<h2>Installing Packages</h2>
<p>You are ready to install<a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="setup" data-tertiary="installing packages" data-type="indexterm" id="idm45433740798640"/> your packages:</p>
<pre data-type="programlisting">
conda install -c esri arcgis</pre>
<p>Next, you will need to <a contenteditable="false" data-primary="Jupyter Notebooks" data-secondary="installing Notebook for ArcGIS Python API" data-type="indexterm" id="idm45433740795984"/>install the Jupyter Notebook; the<a contenteditable="false" data-primary="kernel" data-secondary="IPython kernel, installing" data-type="indexterm" id="idm45433740794192"/> IPython kernel, to execute the Python backend in Jupyter within a Conda environment; and Jupyter Notebook extensions to simplify coding tasks with tools like autocompletion:</p>
<pre data-type="programlisting">
conda install -c conda-forge notebook
conda install -c conda-forge nb_conda_kernels
conda install -c conda-forge jupyter_contrib_nbextensions
 conda install -c conda-forge bokeh</pre>
<p>In your terminal, activate the ArcGIS environment using the name you gave it:</p>
<pre data-type="programlisting">
Conda activate esriENV</pre>
<p>Once the packages are downloaded, you can once again open a Jupyter Notebook from your terminal so that you can document your work and evaluate the output step-by-step:</p>
<pre data-type="programlisting">
jupyter notebook</pre>
<p>The Notebook will be installed along with the API and will open in a new<a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="setup" data-startref="ix_ArcGPyset" data-type="indexterm" id="idm45433740791248"/> window.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Connecting to the ArcGIS Python API" data-type="sect1"><div class="sect1" id="connecting_to_the_arcgis_python_api">
<h1>Connecting to the ArcGIS Python API</h1>
<p>Now that you’ve finished installing, it’s time to log in. <a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="connecting to" data-type="indexterm" id="ix_ArcGPyconn"/>First I’ll show you how to log in anonymously; the section after that explains how to log in with a developer or individual account.</p>
<section data-pdf-bookmark="Connecting to ArcGIS Online as an Anonymous User" data-type="sect2"><div class="sect2" id="connecting_to_arcgis_online_as_an_anony">
<h2>Connecting to ArcGIS Online as an Anonymous User</h2>
<p>There are many ways to gain access to parts of ArcGIS for minimal or no charge; even without an ArcGIS account, you can use the resources, create maps, and share them, but with limited functionality. <a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="connecting to" data-tertiary="as anonymous user" data-type="indexterm" id="idm45433740781008"/>You can explore the options in Jupyter Notebook by running the code or exploring <a href="https://oreil.ly/kqmmF">the documentation</a>. Another benefit of a public account is that it allows anonymous access.<a contenteditable="false" data-primary="Jupyter Notebooks" data-secondary="importing ArcGIS Python API into" data-type="indexterm" id="idm45433740776992"/></p>
<p>You’ll start by importing the Python API into your Jupyter Notebook. In this example, you’ll be using a public account, so only free resources will be shown. No problem—there is a lot here for you to explore.<a contenteditable="false" data-primary="GIS" data-secondary="importing from gis module into Jupyter Notebook" data-type="indexterm" id="idm45433740775904"/> To import GIS from the <code>gis</code> module, run:</p>
<pre data-type="programlisting">
<strong>from</strong> arcgis.gis <strong>import</strong> GIS

gis = GIS()</pre>
</div></section>
<section data-pdf-bookmark="Connecting to an ArcGIS User Account with Credentials" data-type="sect2"><div class="sect2" id="connecting_to_an_arcgis_user_account_wi">
<h2>Connecting to an ArcGIS User Account with Credentials</h2>
<p>If you have a user account, you can log in one of two ways: using the built-in login or using an API key. <a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="connecting to" data-tertiary="ArcGIS user account with credentials" data-type="indexterm" id="idm45433740769712"/>The advantage of logging in is that you can save any maps you create to your account.</p>
<p>Either way, you’ll first need to import GIS using your terminal:</p>
<pre data-type="programlisting">
<strong>from</strong> arcgis.gis <strong>import</strong> GIS</pre>
<p>To use the built-in login, run:</p>
<pre data-type="programlisting">
   gis = GIS(username=<span>"someuser"</span>, password=<span>"secret1234"</span>)</pre>
<p>To log in with an API key, use the following code (I’ve shortened the token):</p>
<pre data-type="programlisting">
<span>gis = GIS(api_key=</span>"Request YOUR KEY AND INSERT IT HERE"<span>,
              referer=</span>"https"<span>)</span></pre>
<p>When you connect with credentials and run the cell, the output will be your organization’s ArcGIS Online username. <a contenteditable="false" data-primary="ArcGIS Online" data-secondary="username for your organization" data-type="indexterm" id="idm45433740760960"/>The username of my account is “datalchemy”; you will need to replace this with your own account credentials if you create an account:</p>
<pre data-type="programlisting">
gis = GIS(username=<span>"datalchemy"</span>, password=<span>"xxx"</span>)
gis</pre>
<p>You can also log in with your password protected if you have an account and a login URL (listed in your organization’s settings), again substituting your own credentials:</p>
<pre data-type="programlisting">
<strong>import</strong> arcgis
<strong>import</strong> getpass
username = input (<span>"Username:"</span>)
password = getpass.getpass (<span>"Password:"</span>)

gis = arcgis.gis.GIS(<span>"https://datalchemy.maps.arcgis.com"</span>, username, password)</pre>
<p>Once you run the cell, a box will prompt you to enter your username and password.</p>
<p>Now you’re ready to explore some layers of imagery.<a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="connecting to" data-startref="ix_ArcGPyconn" data-type="indexterm" id="idm45433740754576"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Exploring Imagery Layers: Urban Heat Island Maps" data-type="sect1"><div class="sect1" id="exploring_imagery_layers_urban_heat_isl">
<h1>Exploring Imagery Layers: Urban Heat Island Maps</h1>
<p>Before <a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring imagery layers, urban heat island maps" data-type="indexterm" id="ix_ArcGPyimglay"/>we begin, a word<a contenteditable="false" data-primary="urban heat islands" data-secondary="maps of" data-type="indexterm" id="ix_urbnhtisl"/> about naming <a contenteditable="false" data-primary="imagery layers, exploring in urban heat island maps" data-type="indexterm" id="ix_imglayr"/>conventions. <a data-type="xref" href="#map_of_chicago">Figure 6-1</a> is a map of Chicago that I’ve named <em>map1</em>.</p>
<p>The designation is arbitrary: you may name your maps according to your preferences, but the point is to avoid confusion when writing code that involves multiple maps. It is common to designate a map variable with an integer following it, or simply <code>m</code>. Select a method and be consistent. It should be distinct from the <code>map()</code> function. You can generate <em>map1</em> by running the following code in your Jupyter Notebook:</p>
<pre data-type="programlisting">
map1 =gis.map(<span>"Chicago,Illinois"</span>)
map1</pre>
<p>This centers your map on Chicago, Illinois. You can set the area your map covers, called its <em>extent</em>, by zooming in on a specific location or by drawing a polygon.</p>
<figure><div class="figure" id="map_of_chicago"><img alt="Map of Chicago" height="391" src="assets/pgda_0601.png" width="698"/>
<h6><span class="label">Figure 6-1. </span>Map of Chicago</h6>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>To access ArcGIS Online’s help <a contenteditable="false" data-primary="ArcGIS Online" data-secondary="help function" data-type="indexterm" id="idm45433740735360"/>function, type:</p>
<pre data-type="programlisting">
gis?</pre>
<p>If you type a dot and hit Tab, a dropdown menu will display additional properties that you can click for more information:</p>
<pre data-type="programlisting">
gis = GIS.</pre>
</div>
<p>Now you can try layering some attributes onto your map. <em>Imagery layers</em> display data from image services. These resources allow you to apply rules to how images are displayed. You can search for them by identifying the item type as <code>Imagery Layer</code>.</p>
<p>You can use search terms in <code>gis.content.search()</code> to describe the features you would like to include in your map.<a contenteditable="false" data-primary="gis.content.search function" data-type="indexterm" id="idm45433740728224"/> Creating a variable assigned to <span class="keep-together"><code>gis.content.search()</code></span> allows you to find available feature layers or other <code>item_type</code> data. Using the following code snippet, you can explore available Landsat 9 satellite views for your imagery layer. Different imagery layers have different properties. Here, I’ve restricted the search to the two options shown in <a data-type="xref" href="#searching_with_gisdotcontentdotsearchle">Figure 6-2</a>, which are the publicly available feature layers with the indicated terms:</p>
<pre data-type="programlisting">
<strong>from</strong> IPython.display <strong>import</strong> display

items = gis.content.search("Landsat 9 Views", item_type="Imagery Layer", 
max_items=2)
<strong>for</strong> item <strong>in</strong> items:
    display(item)</pre>
<figure><div class="figure" id="searching_with_gisdotcontentdotsearchle"><img alt="Searching with gis.content.search() for Landsat 9 views" height="711" src="assets/pgda_0602.png" width="1944"/>
<h6><span class="label">Figure 6-2. </span>Searching with <code>gis.content.search()</code> for Landsat 9 views</h6>
</div></figure>
<p><code>Item_type</code> in the code block <a contenteditable="false" data-primary="Item_type in gis.content.search function" data-type="indexterm" id="idm45433740720784"/>includes web scenes, feature layers, geospatial data, basemaps, and interactive 3D environments with terrain. You can see more about items and item types in the <a href="https://oreil.ly/MRi96">documentation</a>.</p>
<p><em>Web scenes</em> let you visualize and analyze geospatial content containing all configuration settings, such as a basemap, styling, and extent. <a contenteditable="false" data-primary="web scenes" data-type="indexterm" id="idm45433740717792"/>To explore these, you can substitute <code>web scene</code> for <code>item_type</code>.</p>
<p>We’ll use web scenes to explore heat islands in Chicago.<a contenteditable="false" data-primary="heat islands" data-seealso="urban heat islands" data-type="indexterm" id="idm45433740713632"/> According to the <a href="https://oreil.ly/3RWFQ">US Environmental Protection Agency</a> (EPA), <em>heat islands</em> are:</p>
<blockquote>
<p>urbanized areas that experience higher temperatures than outlying areas. Structures such as buildings, roads, and other infrastructure absorb and re-emit the sun’s heat more than natural landscapes such as forests and water bodies. Urban areas, where these structures are highly concentrated and greenery is limited, become “islands” of higher temperatures relative to outlying areas.</p>
</blockquote>
<p>Urban heat island severity measures how city infrastructure absorbs and re-emits this heat.</p>
<p>To locate the image server URL and begin exploring heat islands on your map, click the title (“Urban Heat Islands”) in your search results or pull up a list by calling <code>img_svc_url</code> in the next cell:</p>
<pre data-type="programlisting">
img_svc_url = 'https://server6.tplgis.org/arcgis6/rest/services/
heat_severity_2019/ImageServer'</pre>
<p>This outputs:</p>
<pre data-type="programlisting">
[&lt;Item title:"Urban Heat Island Severity for U.S. cities - 2019" type:
Imagery Layer owner:TPL_GIS_Support&gt;,
 &lt;Item title:"Multispectral Landsat" type:Imagery Layer owner:esri&gt;]</pre>
<p class="pagebreak-before less_space">You can try raster functions with this code, too. More about those in the next section, but for now, try this:</p>
<pre data-type="programlisting">
<strong>from</strong> arcgis.raster <strong>import</strong> ImageryLayer
landsat_urbanheat = ImageryLayer(img_svc_url)
landsat_urbanheat.properties.name</pre>
<p>This outputs:</p>
<pre data-type="programlisting">
‘Heat_severity_2019’</pre>
<p>You have accessed the Urban Heat Island Severity imagery layer. Now add it to your map of Chicago:</p>
<pre data-type="programlisting">
map = gis.map(<span>'Chicago'</span>, zoomlevel=<span>13</span>)
map

map.add_layer(landsat_urbanheat)</pre>
<p>The <code>landsat_urbanheat</code> layer is now added to your map, which should look similar to <a data-type="xref" href="#the_map_layer_added_to_the_map_extent">Figure 6-3</a>.</p>
<figure><div class="figure" id="the_map_layer_added_to_the_map_extent"><img alt="The map layer added to the map extent" height="800" src="assets/pgda_0603.png" width="1350"/>
<h6><span class="label">Figure 6-3. </span>The map layer added to the map extent</h6>
</div></figure>
<p>Now you’ll add the imagery layer from the URL for the Multispectral Landsat layer and assign it to the variable <code>landsat_ms</code>:</p>
<pre data-type="programlisting">
img_svc_url ='<em>https://landsat2.arcgis.com/arcgis/rest/services/Landsat/MS/
	ImageServe</em>'
<span>from arcgis.raster import ImageryLayer
landsat_ms = ImageryLayer(img_svc_url)
landsat_ms.properties.name</span></pre>
<p>The last line of code simply confirms the name of the layer.</p>
<p>This should generate the following output:</p>
<pre data-type="programlisting">
'Landsat/MS'</pre>
<p>A description of the image layer is also available with a line of code:</p>
<pre data-type="programlisting">
landsat_ms.properties[<span>'description'</span>]</pre>
<p>The output is detailed:</p>
<pre data-type="programlisting">
Multispectral Landsat image service covering the landmass of the World. This 
service includes scenes from Landsat 8 and Global Land Survey (GLS) data from 
epochs 1990, 2000, 2005 and 2010 at 30 meter resolution as well as GLS 1975 
at 60 meter resolution. GLS datasets are created by the United States 
Geological Survey (USGS) and the National Aeronautics and Space Administration 
(NASA) using Landsat images. This service can be used for mapping and change 
detection of urban growth, change of natural resources and comparing Landsat 
8 imagery with GLS data.  Using on-the-fly processing, the raw DN values are 
transformed to scaled (0 - 10000) apparent reflectance values and then 
different service based renderings for band combinations and indices are applied. 
The band names are in line with Landsat 8 bands; GLS data band names are mapped 
along the same lines.</pre>
<p>To explore additional raster function objects, visit the <a href="https://oreil.ly/MMRDP">Common Data Types Documentation</a>. I also recommend keeping the <a href="https://oreil.ly/DDDfa">ArcGIS Python API reference guide</a> handy as you learn about raster functions and imagery layers.</p>
</div></section>
<section data-pdf-bookmark="Raster Functions" data-type="sect1"><div class="sect1" id="raster_functions">
<h1>Raster Functions</h1>
<p>Raster functions process pixels from an image to one or more rasters without the need to download or create intermediate files for analysis. <a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring Landsat multispectral imagery" data-tertiary="raster functions" data-type="indexterm" id="ix_ArcGPyimglayrstfnct"/><a contenteditable="false" data-primary="raster functions" data-type="indexterm" id="ix_rastfnct"/>Access to raster functions is limited without additional credentials, but you still have the opportunity to explore Landsat multispectral imagery. </p>
<p>This time, we’ll explore a map of Los Angeles, working our way through a few highlights:</p>
<pre data-type="programlisting">
<strong>from</strong> arcgis.gis <strong>import</strong> GIS
<strong>from</strong> arcgis.geocoding <strong>import</strong> geocode
<strong>from</strong> arcgis.raster.functions <strong>import</strong> *
<strong>from</strong> arcgis <strong>import</strong> geometry
<strong>import</strong> ipywidgets <strong>as</strong> widgets
    
<strong>import</strong> pandas <strong>as</strong> pd</pre>
<p>You’ll run another search in <code>gis.content.search()</code>. This time, you’re looking for images outside of your organization (if you have created one) by indicating <span class="keep-together"><code>outside_org=True</code></span>. This is the setting when you are accessing publicly available datasets:</p>
<pre data-type="programlisting">
<span>landsat_item = gis.content.search(</span>"Landsat Multispectral tags:'Landsat on AWS',
'landsat 9', 'Multispectral', 'Multitemporal', 'imagery', 'temporal', 'MS'"<span>,</span> 
'Imagery Layer'<span>, outside_org=<strong>True</strong>)[</span>0<span>]
landsat = landsat_item.layers[</span>0<span>]
df = <strong>None</strong></span></pre>
<p>Your search results should include Multispectral Landsat, shown in <a data-type="xref" href="#search_results_showing_a_multispectral">Figure 6-4</a>. To view the <code>landsat_item</code>, call it in a cell:</p>
<pre data-type="programlisting">
landsat_item</pre>
<figure><div class="figure" id="search_results_showing_a_multispectral"><img alt="Search results showing a Multispectral Landsat imagery layer by Esri" height="159" src="assets/pgda_0604.png" width="943"/>
<h6><span class="label">Figure 6-4. </span>Search results showing a Multispectral Landsat imagery layer by Esri</h6>
</div></figure>
<p>For additional information, click on it or run the following code:</p>
<pre data-type="programlisting">
<strong>from</strong> IPython.display <strong>import</strong> HTML
HTML(landsat_item.description)</pre>
<p>This map features <em>multispectral bands of light</em>, which are detected with instruments more sensitive than the human eye.<a contenteditable="false" data-primary="spectral bands" data-secondary="multispectral bands of light" data-type="indexterm" id="idm45433740655904"/><a contenteditable="false" data-primary="multispectral bands of light" data-type="indexterm" id="idm45433740654560"/> As you learned in <a data-type="xref" href="ch01.xhtml#introduction_to_geospatial_analytics">Chapter 1</a>, multispectral bands capture image data within specific wavelength ranges across the electromagnetic spectrum to highlight different land-cover features. You can examine the name of each band, its minimum and maximum wavelengths, and other properties:</p>
<pre data-type="programlisting">
pd.DataFrame(landsat.key_properties()[<span>'BandProperties'</span>])</pre>
<p>The bands indicate details related to land mass, vegetation, and other types of land cover. <a data-type="xref" href="#multispectral_and_thermal_infrared_sens">Table 6-1</a> is an excerpt of the output, placed into a table for readability.<a contenteditable="false" data-primary="Thermal Infrared Sensor (TIRS) bands" data-type="indexterm" id="idm45433740648464"/></p>
<table class="border" id="multispectral_and_thermal_infrared_sens">
<caption><span class="label">Table 6-1. </span>Multispectral and Thermal Infrared Sensor Bands</caption>
<thead>
<tr>
<th>Bands</th>
<th>Wavelength<br/>
			(micrometers)</th>
<th>Resolution<br/>
			(meters)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Band 1—Coastal aerosol</td>
<td>0.43–0.45</td>
<td>30</td>
</tr>
<tr>
<td>Band 2—Blue</td>
<td>0.45–0.51</td>
<td>30</td>
</tr>
<tr>
<td>Band 3—Green</td>
<td>0.53–0.59</td>
<td>30</td>
</tr>
<tr>
<td>Band 4—Red</td>
<td>0.64–0.67</td>
<td>30</td>
</tr>
<tr>
<td>Band 5—Near Infrared (NIR)</td>
<td>0.85–0.88</td>
<td>30</td>
</tr>
<tr>
<td>Band 6—Short-Wave Infrared (SWIR) 1</td>
<td>1.57–1.65</td>
<td>30</td>
</tr>
<tr>
<td>Band 7—Short-Wave Infrared (SWIR) 2</td>
<td>2.11–2.29</td>
<td>30</td>
</tr>
<tr>
<td>Band 8—Panchromatic</td>
<td>0.50–0.68</td>
<td>15</td>
</tr>
<tr>
<td>Band 9—Cirrus</td>
<td>1.36–1.38</td>
<td>30</td>
</tr>
<tr>
<td>Band 10—Thermal Infrared (TIRS) 1</td>
<td>10.6–11.19</td>
<td>100</td>
</tr>
<tr>
<td>Band 11—Thermal Infrared (TIRS) 2</td>
<td>11.50–12.51</td>
<td>100</td>
</tr>
</tbody>
</table>
<p>Create the<a contenteditable="false" data-primary="Jupyter Notebooks" data-secondary="creating map using Landsat multispectral band data" data-type="indexterm" id="idm45433740623952"/> map using your Jupyter Notebook:</p>
<pre data-type="programlisting">
landsat = landsat_item.layers[<span>0</span>]
landsat

m = gis.map(<span>'los angeles'</span>)
m</pre>
<p>Now add the feature layer:</p>
<pre data-type="programlisting">
m.add_layer(landsat)</pre>
<p>You can now view your map (<a data-type="xref" href="#a_los_angeles_map_created_using_multisp">Figure 6-5</a>). You can also begin using raster functions.</p>
<figure><div class="figure" id="a_los_angeles_map_created_using_multisp"><img alt="A Los Angeles map created using Multispectral Landsat data" height="338" src="assets/pgda_0605.png" width="791"/>
<h6><span class="label">Figure 6-5. </span>A Los Angeles map created using Multispectral Landsat data</h6>
</div></figure>
<p>Here, you’ll use a raster function to highlight color visualizations in your map. For example, <code>color infrared</code> shows bright red bands to indicate healthy vegetation, while <code>natural color</code> shows topography as we typically see it: green vegetation, blue water, brown soil.</p>
<p class="pagebreak-before less_space">Many of the options<a contenteditable="false" data-primary="dynamic range adjustment (DRA)" data-type="indexterm" id="idm45433740615696"/> are available with a <em>dynamic range adjustment (DRA)</em> to enhance details and improve visibility when being matched to the range of your computer or other device.<a contenteditable="false" data-primary="raster functions" data-secondary="generating list for map using Landsat multispectral data" data-type="indexterm" id="idm45433740610496"/> You can use the following code to generate a list of available raster functions, as shown in the output that follows:</p>
<pre data-type="programlisting">
<strong>for</strong> rasterfunc <strong>in</strong> landsat.properties.rasterFunctionInfos:
    print(rasterfunc.name)</pre>
<p>This outputs a list:</p>
<pre data-type="programlisting">
Agriculture with DRA
Bathymetric with DRA
Color Infrared with DRA
Geology with DRA
Natural Color with DRA
Short-wave Infrared with DRA
Agriculture
Bathymetric
Color Infrared
Geology
Natural Color
Short-wave Infrared
NDVI Colorized
Normalized Difference Moisture Index Colorized
NDVI Raw
NBR Raw
None</pre>
<p>Getting familiar with a few of these functions should pave the way for you to take a deeper look at other options in your independent explorations.</p>
<p>Let’s try viewing <code>color_infrared</code>. You’ll use the <code>apply</code> function:</p>
<pre data-type="programlisting">
From arcgis.raster.functions <strong>import</strong> apply
Color_infrared = apply (landsat, <span>'Color Infrared with DRA'</span>)</pre>
<p>To visualize the map, call the <code>map</code> function:</p>
<pre data-type="programlisting">
m = gis.map(<span>'los angeles'</span>)
m.add_layer(color_infrared)
m</pre>
<p>Healthy vegetation is now shown in bright red (<a data-type="xref" href="#los_angeles_viewed_with_color_infrared">Figure 6-6</a>).</p>
<figure><div class="figure" id="los_angeles_viewed_with_color_infrared"><img alt="Los Angeles viewed with color_infrared" height="387" src="assets/pgda_0606.png" width="882"/>
<h6><span class="label">Figure 6-6. </span>Los Angeles viewed with <code>color_infrared</code></h6>
</div></figure>
<p>The best raster<a contenteditable="false" data-primary="raster functions" data-secondary="best for viewing vegetation, NDVI function" data-type="indexterm" id="idm45433740597376"/> function for viewing vegetation is often the<a contenteditable="false" data-primary="NDVI (Normalized Difference Vegetation Index)" data-type="indexterm" id="idm45433740594944"/><a contenteditable="false" data-primary="Normalized Difference Vegetation Index" data-see="NDVI" data-type="indexterm" id="idm45433740593968"/><a contenteditable="false" data-primary="NDVI_colorized function" data-type="indexterm" id="idm45433740592592"/> Normalized Difference Vegetation Index (NDVI). <a data-type="xref" href="#los_angeles_ndvi">Figure 6-7</a> demonstrates the <code>NDVI_colorized</code> function, showing vegetation in green:</p>
<pre data-type="programlisting">
ndvi_colorized = apply(landsat, <span>'NDVI Colorized'</span>)
ndvi_colorized</pre>
<figure><div class="figure" id="los_angeles_ndvi"><img alt="Los Angeles NDVI" height="319" src="assets/pgda_0607.png" width="622"/>
<h6><span class="label">Figure 6-7. </span>Los Angeles NDVI</h6>
</div></figure>
<p>You have learned how to search for images and feature layers and how to apply raster functions to a specific location to highlight specific features. Next, we will explore attributes and take a look at the <code>arcgis.geometry</code> module.<a contenteditable="false" data-primary="imagery layers, exploring in urban heat island maps" data-startref="ix_imglayr" data-type="indexterm" id="idm45433740586944"/><a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring Landsat multispectral imagery" data-startref="ix_ArcGPyimglayrstfnct" data-tertiary="raster functions" data-type="indexterm" id="idm45433740584896"/><a contenteditable="false" data-primary="raster functions" data-startref="ix_rastfnct" data-type="indexterm" id="idm45433740583008"/><a contenteditable="false" data-primary="Landsat" data-secondary="exploring Landsat multispectral imagery" data-startref="ix_Lndsatmltispecimg" data-type="indexterm" id="idm45433740581632"/><a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring imagery layers, urban heat island maps" data-startref="ix_ArcGPyimglay" data-type="indexterm" id="idm45433740580016"/></p>
</div></section>
<section data-pdf-bookmark="Exploring Image Attributes" data-type="sect1"><div class="sect1" id="exploring_image_attributes">
<h1>Exploring Image Attributes</h1>
<p>In this section, you’ll explore the geometry of your Los Angeles map using the ArcGIS raster module <a href="https://oreil.ly/ffCTy"><code>get_samples</code></a>. <a contenteditable="false" data-primary="image attributes, exploring with ArcGIS Python API" data-type="indexterm" id="ix_imgattr"/><a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring image attributes" data-type="indexterm" id="ix_ArcGPyimgattr"/><a contenteditable="false" data-primary="get_samples function" data-type="indexterm" id="idm45433740572240"/>This module lets you view sample point locations, spatial resolutions, and pixel values for a selected geometry. It’s an example of the <a href="https://oreil.ly/SWZTB">ArcGIS REST API</a>, which provides information about the architecture of web applications. In contrast to the general ArcGIS API documentation, which is focused primarily on access points, the <a href="https://oreil.ly/QdcRC">ArcGIS REST API documentation</a> provides the full scope of geospatial functions.<a contenteditable="false" data-primary="functions" data-secondary="geospatial, ArcGIS REST API documentation for" data-type="indexterm" id="idm45433740709488"/> It also <a href="https://oreil.ly/AXaKp">describes the arguments</a> that the <code>get_samples</code> operation can call:</p>
<pre data-type="programlisting">
get_samples(geometry, geometry_type=None, sample_distance=None, sample_count=None, 
mosaic_rule=None, pixel_size=None, return_first_value_only=None, 
interpolation=None, out_fields=None, slice_id=None)</pre>
<p>Here you indicate the geometry and sample count of your map and return information about its image attributes, based on the extent you define―in this case, Los Angeles:</p>
<pre data-type="programlisting">
<strong>import</strong> arcgis
g = arcgis.geometry.Geometry(area[<span>'extent'</span>])</pre>
<p>Why geometry? When you create 3D models, data points like altitude and sun azimuth are useful for calculating hillshade. <a contenteditable="false" data-primary="hillshade function" data-type="indexterm" id="idm45433740619216"/>When working with the <code>hillshade</code> function, you are basically taking a 2D surface and rendering it as realistic 3D terrain.</p>
<p>Next, indicate the geometry and sample count:</p>
<pre data-type="programlisting">
samples = landsat.get_samples(g, sample_count=<span>50</span>,
                                 out_fields=<span>'AcquisitionDate,OBJECTID,GroupName,
                                 Category,SunAzimuth,SunElevation,CloudCover'</span>)</pre>
<p>You can indicate an item to view in the samples list you have generated, or view all of them:</p>
<pre data-type="programlisting">
samples[<span>10</span>]</pre>
<p>The output includes the location, an object ID, calculations of cloud cover, and pixel values, among other things:</p>
<pre data-type="programlisting">
{'location': {'x': -13150297.20625444,
  'y': 4059732.8562727477,
  'spatialReference': {'wkid': 102100, 'latestWkid': 3857}},
 'locationId': 10,
 'value': '1158 991 843 769 2850 1675 1030 44 21824 22410 22691',
 'rasterId': 3508198,
 'resolution': 30,
 'attributes': {'AcquisitionDate': 1647023302000,
  'OBJECTID': 3508198,
  'GroupName': 'LC09_L1TP_041036_20220311_20220311_02_T1_MTL',
  'Category': 1,
  'SunAzimuth': 144.81874084,
  'SunElevation': 45.83943939,
  'CloudCover': 0.0024},
 'values': [1158.0,
  991.0,
  843.0,
  769.0,
  2850.0,
  1675.0,
  1030.0,
  44.0,
  21824.0,
  22410.0,
  22691.0]}</pre>
<p>In Python, we use the <code>datetime</code> object for <em>time-series data</em>, or data collected at different time points.<a contenteditable="false" data-primary="time-series data" data-secondary="using datetime object in Python for" data-type="indexterm" id="idm45433740553200"/><a contenteditable="false" data-primary="datetime object (Python)" data-type="indexterm" id="idm45433740552336"/> Again, you are sampling the <code>datetime</code> class in Python and can render the acquisition date by running the following code. (I’ll provide additional details later in the chapter, but this is how we use the feature on samples data.)</p>
<p>Because Python <a contenteditable="false" data-primary="zero-based indexing, Python data access based on" data-type="indexterm" id="idm45433740550832"/>accesses data based on zero-based indexing, using <code>[0]</code> requests the first index listed, or the first value in the sample:</p>
<pre data-type="programlisting">
<strong>import</strong> datetime
value = samples[<span>0</span>][<span>'attributes'</span>][<span>'AcquisitionDate'</span>]
datetime.datetime.fromtimestamp(value /<span>1000</span>).strftime(<span>"Acquisition Date: %d %b, 
	%Y"</span>)</pre>
<p>This outputs:</p>
<pre data-type="programlisting">
'Acquisition Date: 11 Mar, 2022'</pre>
<p>By sampling values at this specific location, Los Angeles, you can estimate a spectral profile<a contenteditable="false" data-primary="spectral profile for points on a map" data-type="indexterm" id="idm45433740542016"/> for specific points on your map.</p>
<pre data-type="programlisting">
m = gis.map(<span>'los angeles'</span>)
m

m.add_layer(landsat)</pre>
<p>If you <a contenteditable="false" data-primary="pixels" data-type="indexterm" id="idm45433740540576"/>select a specific pixel, the spectral profile will plot all of the bands reflected at that location, as shown in <a data-type="xref" href="#map_to_click_to_generate_the_spectral_p">Figure 6-8</a>.</p>
<p>The next code lets you select a point on the canvas in your Jupyter Notebook to identify the spectral profile. Note that if you run this example from the ArcGIS Python API guide and request Landsat 9, it will generate an error because additional bands were added.</p>
<figure><div class="figure" id="map_to_click_to_generate_the_spectral_p"><img alt="Map to click to generate the spectral profile in #a_spectral_profile_visualized_with_boke" height="400" src="assets/pgda_0608.png" width="971"/>
<h6><span class="label">Figure 6-8. </span>Map to click to generate the spectral profile in <a data-type="xref" href="#a_spectral_profile_visualized_with_boke">Figure 6-9</a></h6>
</div></figure>
<p>The <code>get_samples()</code> method will gather the pixel values contained in the sample data. <a contenteditable="false" data-primary="pixels" data-secondary="pixel values as digital numbers" data-type="indexterm" id="idm45433740532480"/><a contenteditable="false" data-primary="digital numbers" data-type="indexterm" id="idm45433740531168"/>The pixel values are <em>digital numbers.</em> To calculate them correctly, you’ll need to convert them, first to floating-point numbers and then to integers. Digital numbers record the electromagnetic intensity of the pixel.</p>
<p>You installed the <a href="https://oreil.ly/QLQGJ">Bokeh package</a> into your Conda environment to allow interactive plots and charting.<a contenteditable="false" data-primary="Bokeh package" data-type="indexterm" id="idm45433740533152"/> The Landset specification was based on Landsat 8 data and only included eight bands. This results in a Bokeh error. To fix this, run it with the new bands included:</p>
<pre data-type="programlisting">
<strong>from</strong> bokeh.models <strong>import</strong> Range1d
<strong>from</strong> bokeh.plotting <strong>import</strong> figure, show, output_notebook
<strong>from</strong> IPython.display <strong>import</strong> clear_output
output_notebook()

<strong>def <span>get_samples</span></strong>(mw, g):
    clear_output()
    m.draw(g)
    samples = landsat.get_samples(g, pixel_size=<span>30</span>)
    values = samples[<span>0</span>][<span>'value'</span>]
    vals = [float(int(s)/<span>100000</span>) <strong>for</strong> s <strong>in</strong> values.split(<span>' '</span>)]
    
    x = [<span>'1'</span>,<span>'2'</span>, <span>'3'</span>, <span>'4'</span>, <span>'5'</span>, <span>'6'</span>, <span>'7'</span>, <span>'8'</span>,<span>'9'</span>,<span>'10'</span>,<span>'11'</span>]
    y = vals
    p = figure(title=<span>"Spectral Profile"</span>, x_axis_label=<span>'Spectral Bands'</span>, 
	y_axis_label=<span>'Data Values'</span>, width=<span>600</span>, height=<span>300</span>)
    p.line(x, y, legend_label=<span>"Selected Point"</span>, line_color=<span>"red"</span>, line_width=<span>2</span>)
    p.circle(x, y, line_color=<span>"red"</span>, fill_color=<span>"white"</span>, size=<span>8</span>)
    p.y_range=Range1d(<span>0</span>, <span>1.0</span>)

    show(p)
    
print(<span>'Click anywhere on the map to plot the spectral profile for that location.'</span>)
m.on_click(get_samples)</pre>
<p>You should get a message that Bokeh 2.4.2 (or your version number) has successfully loaded. Now return to the map and select your point. Click to generate the map shown in <a data-type="xref" href="#map_to_click_to_generate_the_spectral_p">Figure 6-8</a> (yours will have different values, depending on the point you select).</p>
<p>The map you generated (<a data-type="xref" href="#map_to_click_to_generate_the_spectral_p">Figure 6-8</a>) is now interactive. Click anywhere on your new map to plot the spectral profile for that location.<a contenteditable="false" data-primary="spectral profile for points on a map" data-secondary="visualized with Bokeh" data-type="indexterm" id="idm45433740512528"/> Now you can select different points and see what values you generate. <a data-type="xref" href="#a_spectral_profile_visualized_with_boke">Figure 6-9</a> shows the spectral profile of Band 9, used for detecting cirrus clouds, at the location I selected.</p>
<figure><div class="figure" id="a_spectral_profile_visualized_with_boke"><img alt="A spectral profile visualized with Bokeh" height="586" src="assets/pgda_0609.png" width="1195"/>
<h6><span class="label">Figure 6-9. </span>A spectral profile visualized with Bokeh</h6>
</div></figure>
<p>Depending on the unique location you select when clicking on the Landsat 9 imagery layer, your spectral profile will be different. Refer to <a data-type="xref" href="#multispectral_and_thermal_infrared_sens">Table 6-1</a> to identify the bands included. These represent a few applications of the <code>get_samples</code> method in the ArcGIS Python API.</p>
<section data-pdf-bookmark="Improving Images" data-type="sect2"><div class="sect2" id="improving_images">
<h2>Improving Images</h2>
<p>Raster functions allow you to do things like extract specific bands to examine land use, vegetation, or fire; continuous data such as temperature; scanned images; and satellite images, among other things.<a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring image attributes" data-tertiary="improving images" data-type="indexterm" id="idm45433740499520"/><a contenteditable="false" data-primary="image attributes, exploring with ArcGIS Python API" data-secondary="improving images" data-type="indexterm" id="idm45433740585808"/><a contenteditable="false" data-primary="raster functions" data-secondary="stretch" data-type="indexterm" id="idm45433740496064"/> A <em>stretch function</em> allows you to adjust the brightness and contrast on your map.<a contenteditable="false" data-primary="stretch function" data-type="indexterm" id="idm45433740493184"/> The following code selects bands 3, 2, and 1 (red, green, and blue) from the visible spectrum and imports the <code>stretch</code> <span class="keep-together"><code>raster.function</code></span>:</p>
<pre data-type="programlisting">
<strong>from</strong> arcgis.raster.functions <strong>import</strong> stretch, extract_band
naturalcolor = stretch(extract_band(landsat, [<span>3</span>,<span>2</span>,<span>1</span>]), 
                    stretch_type=<span>'percentclip'</span>, min_percent=<span>0.1</span>, max_percent=<span>0.1</span>, 
					gamma=[<span>1</span>, <span>1</span>, <span>1</span>], dra=<strong>True</strong>)

naturalcolor</pre>
<p>The percent clip <a contenteditable="false" data-primary="percent clip" data-type="indexterm" id="idm45433740490688"/>minimum (<code>percentclip</code>) that this code sets will exclude the lowest 10% of values from the stretch to apply to the raster. This is useful if most of the pixels are within a specific range. <a contenteditable="false" data-primary="stretch_type parameter" data-type="indexterm" id="idm45433740483616"/>Setting the <code>stretch_type</code> trims away the outliers to redistribute the histogram of values, resulting in the image in <a data-type="xref" href="#natural_color_bands_depicting_what_the">Figure 6-10</a>.</p>
<figure><div class="figure" id="natural_color_bands_depicting_what_the"><img alt="Natural color bands depicting what the eye would see without enhancement" height="330" src="assets/pgda_0610.png" width="974"/>
<h6><span class="label">Figure 6-10. </span>Natural color bands depicting what the eye would see without enhancement</h6>
</div></figure>
<p>The image in <a data-type="xref" href="#natural_color_bands_depicting_what_the">Figure 6-10</a> is what the eye would see without any enhancement. Depending on the features you are looking for, there may be other bands to explore. We will look at other bands in the following section.</p>
</div></section>
<section data-pdf-bookmark="Comparing a Location over Multiple Points in Time" data-type="sect2"><div class="sect2" id="comparing_a_location_over_multiple_poin">
<h2>Comparing a Location over Multiple Points in Time</h2>
<p>The ArcGIS API allows you to compare <a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring image attributes" data-tertiary="comparing a location over points in time" data-type="indexterm" id="ix_ArcGPyimgattrcmploc"/>images of the<a contenteditable="false" data-primary="location, comparing over multiple points in time" data-type="indexterm" id="ix_locmp"/> same location over different points in time using a map widget called a <em>time slider</em>, which enables you to animate a map using configurable properties like start and end times and intervals in between. <a contenteditable="false" data-primary="time slider widget" data-type="indexterm" id="idm45433740468288"/>For this example, I’ve selected a city and a satellite basemap.</p>
<p>The map.zoom <a contenteditable="false" data-primary="zoom levels" data-type="indexterm" id="idm45433740468800"/>widget accepts <a contenteditable="false" data-primary="map.zoom widget" data-type="indexterm" id="idm45433740466256"/>values between 0 and 23. Level 9 gives a panned-out global view; level 10 is somewhere between a large metropolitan area and a city; and level 20 is the level of individual buildings. I have never zoomed to 23, but doing so would result in the most detailed possible view. There are limitations to how much you can zoom, though, depending on the scale of the visualization parameters (conversion rates are available in the <a href="https://oreil.ly/mbtnA">documentation</a>). You can change the zoom level and process the data, but the resolution will stay the same. For example, all Landsat imagery has a resolution of 15 meters. <a contenteditable="false" data-primary="Landsat" data-secondary="imagery resolution" data-type="indexterm" id="idm45433741188944"/>This means that the satellite image captures details on the ground that are 15 meters or larger. (For comparison, the Hollywood sign in Los Angeles and a standard semitruck trailer are both about 15 meters long.)</p>
<p class="pagebreak-before less_space">Try zooming to level 10:</p>
<pre data-type="programlisting">
map = gis.map(<span>"los angeles"</span>)
map.basemap = <span>"satellite"</span>
map.zoom = <span>10</span>
map</pre>
<p>The name of the <code>item title</code> is printed as output for reference:</p>
<pre data-type="programlisting">
<span><span>landsat_item = gis.content.search(</span>"Landsat Multispectral tags:'Landsat on AWS',
'landsat 9', 'Multispectral', 'Multitemporal', 'imagery', 'temporal', 'MS'"<span>,</span> 
'Imagery Layer'<span>, outside_org=<strong>True</strong>)[</span>0<span>]
print(landsat_item)</span></span>
&lt;Item title:"Multispectral Landsat" type:Imagery Layer owner:esri&gt;</pre>
<p>You have searched for a Landsat item, and the recovered item is confirmed by its title in the output. Different sublayers will have different details provided.</p>
<p>Add the layer to the map:</p>
<pre data-type="programlisting">
map.add_layer(landsat_item)</pre>
<p>Request confirmation that the <code>map.time_slider</code> is available:</p>
<pre data-type="programlisting">
map.time_slider</pre>
<p>It should return the output <code>True</code>.</p>
<p>You can adjust the dates to a specific interval. The following code measures 10-day intervals between the selected start and end times:</p>
<pre data-type="programlisting">
<strong>from</strong> datetime <strong>import</strong> datetime
map.time_slider = <strong>True</strong>
map.set_time_extent(start_time=datetime(<span>2021</span>, <span>12</span>, <span>12</span>), end_time=datetime(<span>2022</span>, <span>4</span>, 
<span>12</span>), interval=<span>10</span>, unit=<span>'days'</span>)</pre>
<p>This code outputs the map in <a data-type="xref" href="#time_slider_widget">Figure 6-11</a>, which includes the time-slider widget.</p>
<figure><div class="figure" id="time_slider_widget"><img alt="Time-slider widget" height="330" src="assets/pgda_0611.png" width="821"/>
<h6><span class="label">Figure 6-11. </span>Time-slider widget</h6>
</div></figure>
<p>Select the <code>map.draw(polygon)</code> option in the code cells, and then draw a polygon with your cursor. If you have a specific location of interest, enter its coordinates:</p>
<pre data-type="programlisting">
<strong>from</strong> arcgis.geometry <strong>import</strong> Point

pt = Point({<span>"x"</span> : <span>34.092809</span>, <span>"y"</span> : <span>-118.328661</span>, 
            <span>"spatialReference"</span> : {<span>"wkid"</span> : <span>3309</span>}})</pre>
<p>A <em>spatial reference</em> or <em>well-known ID (WKID)</em> defines tolerance and resolution for the location <a contenteditable="false" data-primary="spatial reference" data-type="indexterm" id="idm45433740433248"/>you <a contenteditable="false" data-primary="well-known ID (WKID)" data-type="indexterm" id="idm45433740443184"/>have selected (see the <a href="https://oreil.ly/AecRp">Spatial Reference List</a>).</p>
<p>Options for <code>map.draw</code> include selecting a point (<code>pt</code>), <code>polyline</code>, or <code>polygon</code>:</p>
<pre data-type="programlisting">
map.draw(pt)
map.draw(<span>'polyline'</span>)
map.draw(<span>'polygon'</span>)</pre>
<p>When you select the polygon and run the code cell, simply return to the map and you will be able to trace a polygon. The time-slider widget allows comparison across a time series for an area of interest. When working with layers, you will often want to filter what appears on your canvas.<a contenteditable="false" data-primary="location, comparing over multiple points in time" data-startref="ix_locmp" data-type="indexterm" id="idm45433740426592"/><a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring image attributes" data-startref="ix_ArcGPyimgattrcmploc" data-tertiary="comparing a location over points in time" data-type="indexterm" id="idm45433740802160"/></p>
</div></section>
<section data-pdf-bookmark="Filtering Layers" data-type="sect2"><div class="sect2" id="filtering_layers">
<h2>Filtering Layers</h2>
<p>You may want to filter your layers: for instance, perhaps you only want to see Landsat layers from a <a href="https://oreil.ly/iMcfn">specific collection</a> with less than 10% cloud cover. <a contenteditable="false" data-primary="filtering data" data-secondary="filtering layers in time series comparison for a location" data-type="indexterm" id="idm45433740419728"/><a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring image attributes" data-tertiary="filtering layers" data-type="indexterm" id="idm45433740417568"/><a contenteditable="false" data-primary="layers" data-secondary="filtering in time series comparison for a location" data-type="indexterm" id="idm45433740416176"/>For this, it’s helpful to get familiar with Landsat’s <a href="https://oreil.ly/9fR5U">data dictionaries</a> for complete information about data elements, attributes, and names within a database or system.</p>
<p>In the following code snippet, <code>WRS_Row</code> provides information about the orbital path of the satellite that took the image:</p>
<pre data-type="programlisting">
selected = landsat.filter_by(where=<span>"(Category = 1) AND (CloudCover &lt;=0.10) AND 
	(WRS_Row = 36)"</span>, 
                   geometry=arcgis.geometry.filters.intersects(area[<span>'extent'</span>]))</pre>
<p>The value <code>36</code> indicates the northern hemisphere. (You can find these details in the Landsat data dictionary, the collection background, or elsewhere in Landsat’s information.)</p>
<p>Information you can access is shown in the HTML item description you generated earlier. <a contenteditable="false" data-primary="dataframes" data-type="indexterm" id="idm45433740407984"/>Now you can view the table you just created in a dataframe (<code>df</code>):</p>
<pre data-type="programlisting">
fs = selected.query(out_fields=<span>"AcquisitionDate, GroupName, Best, CloudCover, 
	WRS_Row, Month, Name"</span>, 
              return_geometry=<strong>True</strong>,
              return_distinct_values=<strong>False</strong>,
              order_by_fields=<span>"AcquisitionDate"</span>)</pre>
<p class="pagebreak-before less_space">Because you are comparing dates, you’ll want to see the oldest acquisition date as well as the most recent. To view your output clearly, run it in the code cell. The important takeaway is to see the column headings and where to find identifying information (<a data-type="xref" href="#acquisition_date_output">Figure 6-12</a>). You can view<a contenteditable="false" data-primary="dataframes" data-secondary="df.head function" data-type="indexterm" id="idm45433740536192"/> the first five rows by calling <code>df.head()</code> as follows:</p>
<pre data-type="programlisting">
df = fs.sdf
df.head()</pre>
<figure><div class="figure" id="acquisition_date_output"><img alt="Acquisition date output" height="230" src="assets/pgda_0612.png" width="973"/>
<h6><span class="label">Figure 6-12. </span>Acquisition date output</h6>
</div></figure>
<p>Now run <code>df.tail()</code> and select a recent acquisition date. <a contenteditable="false" data-primary="dataframes" data-secondary="df.tail function" data-type="indexterm" id="idm45433740397376"/>You can run the code in your Jupyter Notebook:</p>
<pre data-type="programlisting">
df = fs.sdf
df.tail()</pre>
<p>The following<a contenteditable="false" data-primary="dataframes" data-secondary="df.shape function" data-type="indexterm" id="idm45433740394656"/> command gives the shape of the data:</p>
<pre data-type="programlisting">
df.shape</pre>
<p>The output informs us that the data has 9 columns and 193 rows: <code>(193,9)</code>.</p>
<p>If you only want the acquisition date, you can run this data, or any of the<a contenteditable="false" data-primary="dataframes" data-secondary="getting acquisition date" data-type="indexterm" id="idm45433740389968"/> other columns, from the dataframe:</p>
<pre data-type="programlisting">
df[<span>'Time'</span>] = pd.to_datetime(df[<span>'AcquisitionDate'</span>], unit=<span>'ms'</span>)
df[<span>'Time'</span>].head(<span>10</span>)</pre>
<p>This outputs:</p>
<pre data-type="programlisting">
0   1977-05-30
1   1979-06-08
2   1989-06-28
3   1990-05-07
4   2000-04-24
5   2000-05-01
6   2005-05-15
7   2005-05-24
8   2009-04-16
9   2009-05-11
Name: Time, dtype: datetime64[ns]</pre>
<p>Bands have specific wavelengths that are used in statistical calculations. You want to avoid overlapping pixels in an imagery layer because this can distort the calculations. <a contenteditable="false" data-primary="pixels" data-secondary="avoiding overlapping in image layer using last raster dataset output" data-type="indexterm" id="idm45433740511040"/>You can use the default method, where the pixel value is calculated from the last dataset (<a data-type="xref" href="#overlapping_pixels_using_the_lastleft_p">Figure 6-13</a>):</p>
<pre data-type="programlisting">
m3 = gis.map(<span>'los angeles'</span>, <span>7</span>)
display(m3)
m3.add_layer(selected.last())</pre>
<figure><div class="figure" id="overlapping_pixels_using_the_lastleft_p"><img alt="Overlapping pixels using the last() method" height="311" src="assets/pgda_0613.png" width="452"/>
<h6><span class="label">Figure 6-13. </span>Overlapping pixels using the <code>last()</code> method</h6>
</div></figure>
<p>Alternatively, you <a contenteditable="false" data-primary="pixels" data-secondary="calculating pixel value from first raster dataset output" data-type="indexterm" id="idm45433740377568"/>can request the <code>first()</code> method and calculate pixel value from the first raster dataset (output shown in <a data-type="xref" href="#overlapping_pixels_using_the_firstleft">Figure 6-14</a>):</p>
<pre data-type="programlisting">
m3 = gis.map(<span>'los angeles'</span>, <span>7</span>)
display(m3)
m3.add_layer(selected.first())</pre>
<figure><div class="figure" id="overlapping_pixels_using_the_firstleft"><img alt="Overlapping pixels using the first() method" height="316" src="assets/pgda_0614.png" width="503"/>
<h6><span class="label">Figure 6-14. </span>Overlapping pixels using the <code>first()</code> method</h6>
</div></figure>
<p>Querying the data by <code>OBJECTID</code>, aided by the <code>df(head)</code> and <code>df(tail)</code> data, you can compare images captured at different times:</p>
<pre data-type="programlisting">
old = landsat.filter_by(<span>'OBJECTID=3106827'</span>)

new = landsat.filter_by(<span>'OBJECTID=3558253'</span>)

<strong>from</strong> arcgis.raster.functions <strong>import</strong> *</pre>
<p>The <a href="https://oreil.ly/AsmeR"><code>stretch</code> function</a> improves<a contenteditable="false" data-primary="functions" data-secondary="ArcGIS, showing differences in images over time" data-type="indexterm" id="idm45433740364784"/> visibility by spreading the pixel values. <a contenteditable="false" data-primary="pixels" data-secondary="stretch function spreading pixel values" data-type="indexterm" id="idm45433740362432"/><a contenteditable="false" data-primary="stretch function" data-type="indexterm" id="idm45433740360928"/>There are different types of stretch, but here you are simply removing any extreme values by calculating the standard deviation (<code>stddev</code>):</p>
<pre data-type="programlisting">
diff = stretch(composite_band([ndvi(old, <span>'5 4'</span>),
                               ndvi(new, <span>'5 4'</span>),
                               ndvi(old, <span>'5 4'</span>)]), 
                               stretch_type=<span>'stddev'</span>,  num_stddev=<span>2.5</span>, min=<span>0</span>, 
                               max=<span>255</span>, dra=<strong>True</strong>, astype=<span>'u8'</span>)
diff</pre>
<p>This will output <a data-type="xref" href="#arcgis_functions_showing_difference_in">Figure 6-15</a>. The green swaths indicate increases in vegetation density, while magenta shows a decrease within the timeframe selected by <code>OBJECTID</code>.</p>
<figure><div class="figure" id="arcgis_functions_showing_difference_in"><img alt="ArcGIS functions showing difference in images over time" height="805" src="assets/pgda_0615.png" width="1024"/>
<h6><span class="label">Figure 6-15. </span>ArcGIS functions showing difference in images over time</h6>
</div></figure>
<p>Perhaps there is a certain threshold you want to capture.<a contenteditable="false" data-primary="NDVI (Normalized Difference Vegetation Index)" data-type="indexterm" id="idm45433740349024"/> Try measuring only areas where the threshold change is above 10%. <a contenteditable="false" data-primary="threshold for changes in images over time" data-type="indexterm" id="idm45433740347584"/><a contenteditable="false" data-primary="masked threshold for changes in vegetation index (NDVI)" data-type="indexterm" id="idm45433740346512"/>Use the following code:</p>
<pre data-type="programlisting">
threshold_val = <span>0.1</span>
masked = colormap(remap(ndvi_diff, 
                        input_ranges=[threshold_val, <span>1</span>], 
                        output_values=[<span>1</span>], 
                        no_data_ranges=[<span>-1</span>, threshold_val], astype=<span>'u8'</span>), 
                  colormap=[[<span>1</span>, <span>124</span>, <span>252</span>, <span>0</span>]], astype=<span>'u8'</span>)

Image(masked.export_image(bbox=area[<span>'extent'</span>], size=[<span>1200</span>,<span>450</span>], f=<span>'image'</span>))</pre>
<p>The output (<a data-type="xref" href="#masked_threshold_value_for_changes_in_v">Figure 6-16</a>) renders those areas in green.</p>
<figure><div class="figure" id="masked_threshold_value_for_changes_in_v"><img alt="Masked threshold value for changes in vegetation index (NDVI)" height="727" src="assets/pgda_0616.png" width="988"/>
<h6><span class="label">Figure 6-16. </span>Masked threshold value for changes in vegetation index (NDVI)</h6>
</div></figure>
<p>Let’s render our map once again:</p>
<pre data-type="programlisting">
m = gis.map(<span>'los angeles'</span>)
m</pre>
<p>The final image is displayed in <a data-type="xref" href="#the_combined_image_at_the_requested_thr">Figure 6-17</a>. You can now see the masked threshold by adding the layers to the map:</p>
<pre data-type="programlisting">
m.add_layer(diff)
m.add_layer(masked)</pre>
<figure><div class="figure" id="the_combined_image_at_the_requested_thr"><img alt="The combined image at the requested threshold displaying the masked threshold" height="244" src="assets/pgda_0617.png" width="413"/>
<h6><span class="label">Figure 6-17. </span>The combined image at the requested threshold displaying the masked threshold</h6>
</div></figure>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="summary-id00019">
<h1>Summary</h1>
<p>Now that you’ve customized and explored a few publicly available resources from ArcGIS API for Python, you should have some familiarity with raster functions and image layers.<a contenteditable="false" data-primary="image attributes, exploring with ArcGIS Python API" data-startref="ix_imgattr" data-type="indexterm" id="idm45433742763936"/><a contenteditable="false" data-primary="ArcGIS Python API" data-secondary="exploring image attributes" data-startref="ix_ArcGPyimgattr" data-type="indexterm" id="idm45433742766176"/><a contenteditable="false" data-primary="ArcGIS Python API" data-startref="ix_ArcGPy" data-type="indexterm" id="idm45433742771696"/> To continue learning, try working with these functions and layers independently and see what other queries you can access.</p>
</div></section>
</div></section></div></body></html>