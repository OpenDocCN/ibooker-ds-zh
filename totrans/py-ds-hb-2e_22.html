<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 19. Combining Datasets: merge and join" data-type="chapter" epub:type="chapter"><div class="chapter" id="section-0307-merge-and-join">
<h1><span class="label">Chapter 19. </span>Combining Datasets: merge and join</h1>
<p><a data-primary="datasets" data-secondary="merging/joining" data-type="indexterm" id="ix_ch19-asciidoc0"/><a data-primary="joins" data-secondary="datasets" data-type="indexterm" id="ix_ch19-asciidoc1"/><a data-primary="merging" data-seealso="joins" data-type="indexterm" id="ix_ch19-asciidoc2"/><a data-primary="Pandas" data-secondary="merging/joining datasets" data-type="indexterm" id="ix_ch19-asciidoc3"/><a data-primary="pd.merge() function" data-type="indexterm" id="ix_ch19-asciidoc4"/>One important feature offered by Pandas is its high-performance,
in-memory join and merge operations, which you may be familiar with if
you have ever worked with databases. The main interface for this is the
<code>pd.merge</code> function, and we’ll see a few examples of how this
can work in practice.</p>
<p>For convenience, we will again define the <code>display</code> function from the
previous chapter after the usual imports:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">pandas</code> <code class="k">as</code> <code class="nn">pd</code>
        <code class="kn">import</code> <code class="nn">numpy</code> <code class="k">as</code> <code class="nn">np</code>

        <code class="k">class</code> <code class="nc">display</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
            <code class="sd">"""Display HTML representation of multiple objects"""</code>
            <code class="n">template</code> <code class="o">=</code> <code class="s2">"""&lt;div style="float: left; padding: 10px;"&gt;</code>
<code class="s2">            &lt;p style='font-family:"Courier New", Courier, monospace'&gt;</code><code class="si">{0}{1}</code><code class="s2"/>
<code class="s2">            """</code>
            <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="o">*</code><code class="n">args</code><code class="p">):</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">args</code> <code class="o">=</code> <code class="n">args</code>

            <code class="k">def</code> <code class="nf">_repr_html_</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
                <code class="k">return</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">template</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">a</code><code class="p">,</code> <code class="nb">eval</code><code class="p">(</code><code class="n">a</code><code class="p">)</code><code class="o">.</code><code class="n">_repr_html_</code><code class="p">())</code>
                                 <code class="k">for</code> <code class="n">a</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">args</code><code class="p">)</code>

            <code class="k">def</code> <code class="fm">__repr__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
                <code class="k">return</code> <code class="s1">'</code><code class="se">\n\n</code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">a</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code> <code class="nb">repr</code><code class="p">(</code><code class="nb">eval</code><code class="p">(</code><code class="n">a</code><code class="p">))</code>
                                   <code class="k">for</code> <code class="n">a</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">args</code><code class="p">)</code></pre>
<section data-pdf-bookmark="Relational Algebra" data-type="sect1"><div class="sect1" id="ch_0307-merge-and-join_relational-algebra">
<h1>Relational Algebra</h1>
<p><a data-primary="merging" data-secondary="relational algebra and" data-type="indexterm" id="idm45858779506960"/><a data-primary="pd.merge() function" data-secondary="relational algebra and" data-type="indexterm" id="idm45858779505984"/><a data-primary="relational algebra" data-type="indexterm" id="idm45858779505040"/>The behavior implemented in <code>pd.merge</code> is a subset of what is known as
<em>relational algebra</em>, which is a formal set of rules for manipulating
relational data that forms the conceptual foundation of operations
available in most databases. The strength of the relational algebra
approach is that it proposes several fundamental operations, which
become the building blocks of more complicated operations on any
dataset. With this lexicon of fundamental operations implemented
efficiently in a database or other program, a wide range of fairly
complicated composite operations can be performed.</p>
<p>Pandas implements several of these fundamental building blocks in the
<code>pd.merge</code> function and the related <code>join</code> method of <code>Series</code> and
<code>DataFrame</code> objects. As you will see, these let you efficiently link
data from different sources.</p>
</div></section>
<section data-pdf-bookmark="Categories of Joins" data-type="sect1"><div class="sect1" id="ch_0307-merge-and-join_categories-of-joins">
<h1>Categories of Joins</h1>
<p><a data-primary="joins" data-secondary="categories of" data-type="indexterm" id="ix_ch19-asciidoc5"/><a data-primary="pd.merge() function" data-secondary="categories of joins" data-type="indexterm" id="ix_ch19-asciidoc6"/>The <code>pd.merge</code> function implements a number of types of joins:
<em>one-to-one</em>, <em>many-to-one</em>, and <em>many-to-many</em>. All three types of
joins are accessed via an identical call to the <code>pd.merge</code> interface;
the type of join performed depends on the form of the input data.
We’ll start with some simple examples of the three types of
merges, and discuss detailed options a bit later.</p>
<section data-pdf-bookmark="One-to-One Joins" data-type="sect2"><div class="sect2" id="ch_0307-merge-and-join_one-to-one-joins">
<h2>One-to-One Joins</h2>
<p><a data-primary="joins" data-secondary="one-to-one" data-type="indexterm" id="idm45858779399776"/><a data-primary="one-to-one joins" data-type="indexterm" id="idm45858779398800"/>Perhaps the simplest type of merge is the one-to-one join, which is in
many ways similar to the column-wise concatenation you saw in
<a data-type="xref" href="ch18.xhtml#section-0306-concat-and-append">Chapter 18</a>.
As a concrete example, consider the following two <code>DataFrame</code> objects,
which contain information on several employees in a company:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">df1</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'employee'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Bob'</code><code class="p">,</code> <code class="s1">'Jake'</code><code class="p">,</code> <code class="s1">'Lisa'</code><code class="p">,</code> <code class="s1">'Sue'</code><code class="p">],</code>
                            <code class="s1">'group'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Accounting'</code><code class="p">,</code> <code class="s1">'Engineering'</code><code class="p">,</code>
                                      <code class="s1">'Engineering'</code><code class="p">,</code> <code class="s1">'HR'</code><code class="p">]})</code>
        <code class="n">df2</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'employee'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Lisa'</code><code class="p">,</code> <code class="s1">'Bob'</code><code class="p">,</code> <code class="s1">'Jake'</code><code class="p">,</code> <code class="s1">'Sue'</code><code class="p">],</code>
                            <code class="s1">'hire_date'</code><code class="p">:</code> <code class="p">[</code><code class="mi">2004</code><code class="p">,</code> <code class="mi">2008</code><code class="p">,</code> <code class="mi">2012</code><code class="p">,</code> <code class="mi">2014</code><code class="p">]})</code>
        <code class="n">display</code><code class="p">(</code><code class="s1">'df1'</code><code class="p">,</code> <code class="s1">'df2'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">df1</code>                         <code class="n">df2</code>
          <code class="n">employee</code>        <code class="n">group</code>       <code class="n">employee</code>  <code class="n">hire_date</code>
        <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>     <code class="mi">0</code>     <code class="n">Lisa</code>       <code class="mi">2004</code>
        <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>     <code class="mi">1</code>      <code class="n">Bob</code>       <code class="mi">2008</code>
        <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>     <code class="mi">2</code>     <code class="n">Jake</code>       <code class="mi">2012</code>
        <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>     <code class="mi">3</code>      <code class="n">Sue</code>       <code class="mi">2014</code></pre>
<p>To combine this information into a single <code>DataFrame</code>, we can use the
<code>pd.merge</code>
<span class="keep-together">function</span>:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="n">df3</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df1</code><code class="p">,</code> <code class="n">df2</code><code class="p">)</code>
        <code class="n">df3</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">3</code><code class="p">]:</code>   <code class="n">employee</code>        <code class="n">group</code>  <code class="n">hire_date</code>
        <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>       <code class="mi">2008</code>
        <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>       <code class="mi">2012</code>
        <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>       <code class="mi">2004</code>
        <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>       <code class="mi">2014</code></pre>
<p>The <code>pd.merge</code> function recognizes that each <code>DataFrame</code> has an
<code>employee</code> column, and automatically joins using this column as a key.
The result of the merge is a new <code>DataFrame</code> that combines the
information from the two inputs. Notice that the order of entries in
each column is not necessarily maintained: in this case, the order of
the <code>employee</code> column differs between <code>df1</code> and <code>df2</code>, and the
<code>pd.merge</code> function correctly accounts for this. Additionally, keep in
mind that the merge in general discards the index, except in the special
case of merges by index (see the <code>left_index</code> and <code>right_index</code>
keywords, discussed momentarily).</p>
</div></section>
<section data-pdf-bookmark="Many-to-One Joins" data-type="sect2"><div class="sect2" id="ch_0307-merge-and-join_many-to-one-joins">
<h2>Many-to-One Joins</h2>
<p><a data-primary="joins" data-secondary="many-to-one" data-type="indexterm" id="idm45858779165408"/><a data-primary="many-to-one joins" data-type="indexterm" id="idm45858779164432"/>Many-to-one joins are joins in which one of the two key columns contains
duplicate entries. For the many-to-one case, the resulting <code>DataFrame</code>
will preserve those duplicate entries as appropriate. Consider the
following example of a many-to-one join:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="n">df4</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'group'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Accounting'</code><code class="p">,</code> <code class="s1">'Engineering'</code><code class="p">,</code> <code class="s1">'HR'</code><code class="p">],</code>
                            <code class="s1">'supervisor'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Carly'</code><code class="p">,</code> <code class="s1">'Guido'</code><code class="p">,</code> <code class="s1">'Steve'</code><code class="p">]})</code>
        <code class="n">display</code><code class="p">(</code><code class="s1">'df3'</code><code class="p">,</code> <code class="s1">'df4'</code><code class="p">,</code> <code class="s1">'pd.merge(df3, df4)'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="n">df3</code>                                   <code class="n">df4</code>
          <code class="n">employee</code>        <code class="n">group</code>  <code class="n">hire_date</code>              <code class="n">group</code> <code class="n">supervisor</code>
        <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>       <code class="mi">2008</code>      <code class="mi">0</code>   <code class="n">Accounting</code>      <code class="n">Carly</code>
        <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>       <code class="mi">2012</code>      <code class="mi">1</code>  <code class="n">Engineering</code>      <code class="n">Guido</code>
        <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>       <code class="mi">2004</code>      <code class="mi">2</code>           <code class="n">HR</code>      <code class="n">Steve</code>
        <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>       <code class="mi">2014</code>

        <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df3</code><code class="p">,</code> <code class="n">df4</code><code class="p">)</code>
          <code class="n">employee</code>        <code class="n">group</code>  <code class="n">hire_date</code> <code class="n">supervisor</code>
        <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>       <code class="mi">2008</code>      <code class="n">Carly</code>
        <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>       <code class="mi">2012</code>      <code class="n">Guido</code>
        <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>       <code class="mi">2004</code>      <code class="n">Guido</code>
        <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>       <code class="mi">2014</code>      <code class="n">Steve</code></pre>
<p>The resulting <code>DataFrame</code> has an additional column with the
“supervisor” information, where the information is repeated in one or
more locations as required by the inputs.</p>
</div></section>
<section data-pdf-bookmark="Many-to-Many Joins" data-type="sect2"><div class="sect2" id="ch_0307-merge-and-join_many-to-many-joins">
<h2>Many-to-Many Joins</h2>
<p>Many-to-many joins may be a bit confusing conceptually, but are
nevertheless well defined. If the key column in both the left and right
arrays contains duplicates, then the result is a many-to-many merge.
This will be perhaps most clear with a concrete example. Consider the
following, where we have a <code>DataFrame</code> showing one or more skills
associated with a particular group.</p>
<p>By performing a many-to-many join,
we can recover the skills associated with any individual person:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">5</code><code class="p">]:</code> <code class="n">df5</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'group'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Accounting'</code><code class="p">,</code> <code class="s1">'Accounting'</code><code class="p">,</code>
                                      <code class="s1">'Engineering'</code><code class="p">,</code> <code class="s1">'Engineering'</code><code class="p">,</code> <code class="s1">'HR'</code><code class="p">,</code> <code class="s1">'HR'</code><code class="p">],</code>
                            <code class="s1">'skills'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'math'</code><code class="p">,</code> <code class="s1">'spreadsheets'</code><code class="p">,</code> <code class="s1">'software'</code><code class="p">,</code> <code class="s1">'math'</code><code class="p">,</code>
                                       <code class="s1">'spreadsheets'</code><code class="p">,</code> <code class="s1">'organization'</code><code class="p">]})</code>
        <code class="n">display</code><code class="p">(</code><code class="s1">'df1'</code><code class="p">,</code> <code class="s1">'df5'</code><code class="p">,</code> <code class="s2">"pd.merge(df1, df5)"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">5</code><code class="p">]:</code> <code class="n">df1</code>                       <code class="n">df5</code>
        <code class="n">employee</code>        <code class="n">group</code>              <code class="n">group</code>        <code class="n">skills</code>
      <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>     <code class="mi">0</code>   <code class="n">Accounting</code>          <code class="n">math</code>
      <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>     <code class="mi">1</code>   <code class="n">Accounting</code>  <code class="n">spreadsheets</code>
      <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>     <code class="mi">2</code>  <code class="n">Engineering</code>      <code class="n">software</code>
      <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>     <code class="mi">3</code>  <code class="n">Engineering</code>          <code class="n">math</code>
                                  <code class="mi">4</code>           <code class="n">HR</code>  <code class="n">spreadsheets</code>
                                  <code class="mi">5</code>           <code class="n">HR</code>  <code class="n">organization</code>

      <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df1</code><code class="p">,</code> <code class="n">df5</code><code class="p">)</code>
        <code class="n">employee</code>        <code class="n">group</code>        <code class="n">skills</code>
      <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>          <code class="n">math</code>
      <code class="mi">1</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>  <code class="n">spreadsheets</code>
      <code class="mi">2</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>      <code class="n">software</code>
      <code class="mi">3</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>          <code class="n">math</code>
      <code class="mi">4</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>      <code class="n">software</code>
      <code class="mi">5</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>          <code class="n">math</code>
      <code class="mi">6</code>      <code class="n">Sue</code>           <code class="n">HR</code>  <code class="n">spreadsheets</code>
      <code class="mi">7</code>      <code class="n">Sue</code>           <code class="n">HR</code>  <code class="n">organization</code></pre>
<p>These three types of joins can be used with other Pandas tools to
implement a wide array of functionality. But in practice, datasets are
rarely as clean as the one we’re working with here. In the
following section we’ll consider some of the options
provided by <code>pd.merge</code> that enable you to tune how the join operations
work.<a data-startref="ix_ch19-asciidoc6" data-type="indexterm" id="idm45858778888480"/><a data-startref="ix_ch19-asciidoc5" data-type="indexterm" id="idm45858778887872"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Specification of the Merge Key" data-type="sect1"><div class="sect1" id="ch_0307-merge-and-join_specification-of-the-merge-key">
<h1>Specification of the Merge Key</h1>
<p><a data-primary="merge key" data-secondary="specification of" data-type="indexterm" id="ix_ch19-asciidoc7"/><a data-primary="merging" data-secondary="key specification" data-type="indexterm" id="ix_ch19-asciidoc8"/><a data-primary="pd.merge() function" data-secondary="keywords" data-type="indexterm" id="ix_ch19-asciidoc9"/><a data-primary="pd.merge() function" data-secondary="merge key specification" data-type="indexterm" id="ix_ch19-asciidoc10"/>We’ve already seen the default behavior of <code>pd.merge</code>: it
looks for one or more matching column names between the two inputs, and
uses this as the key. However, often the column names will not match so
nicely, and <code>pd.merge</code> provides a variety of options for handling this.</p>
<section data-pdf-bookmark="The on Keyword" data-type="sect2"><div class="sect2" id="ch_0307-merge-and-join_the-on-keyword">
<h2>The on Keyword</h2>
<p><a data-primary="merge key" data-secondary="on keyword" data-type="indexterm" id="idm45858778819040"/><a data-primary="on keyword" data-type="indexterm" id="idm45858778818064"/>Most simply, you can explicitly specify the name of the key column using
the <code>on</code> keyword, which takes a column name or a list of column names:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">6</code><code class="p">]:</code> <code class="n">display</code><code class="p">(</code><code class="s1">'df1'</code><code class="p">,</code> <code class="s1">'df2'</code><code class="p">,</code> <code class="s2">"pd.merge(df1, df2, on='employee')"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">6</code><code class="p">]:</code> <code class="n">df1</code>                         <code class="n">df2</code>
          <code class="n">employee</code>        <code class="n">group</code>       <code class="n">employee</code>  <code class="n">hire_date</code>
        <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>     <code class="mi">0</code>     <code class="n">Lisa</code>       <code class="mi">2004</code>
        <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>     <code class="mi">1</code>      <code class="n">Bob</code>       <code class="mi">2008</code>
        <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>     <code class="mi">2</code>     <code class="n">Jake</code>       <code class="mi">2012</code>
        <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>     <code class="mi">3</code>      <code class="n">Sue</code>       <code class="mi">2014</code>

        <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df1</code><code class="p">,</code> <code class="n">df2</code><code class="p">,</code> <code class="n">on</code><code class="o">=</code><code class="s1">'employee'</code><code class="p">)</code>
          <code class="n">employee</code>        <code class="n">group</code>  <code class="n">hire_date</code>
        <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>       <code class="mi">2008</code>
        <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>       <code class="mi">2012</code>
        <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>       <code class="mi">2004</code>
        <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>       <code class="mi">2014</code></pre>
<p>This option works only if both the left and right <code>DataFrame</code>s have the
specified 
<span class="keep-together">column</span> name.</p>
</div></section>
<section data-pdf-bookmark="The left_on and right_on Keywords" data-type="sect2"><div class="sect2" id="ch_0307-merge-and-join_the-left_on-and-right_on-keywords">
<h2>The left_on and right_on Keywords</h2>
<p><a data-primary="left_index keyword" data-type="indexterm" id="ix_ch19-asciidoc11"/><a data-primary="pd.merge() function" data-secondary="left_index/right_index keywords" data-type="indexterm" id="ix_ch19-asciidoc12"/><a data-primary="right_index keyword" data-type="indexterm" id="ix_ch19-asciidoc13"/>At times you may wish to merge two datasets with different column names;
for example, we may have a dataset in which the employee name is labeled
as “name” rather than “employee”. In this case, we can use the
<code>left_on</code> and <code>right_on</code> keywords to specify the two column names:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">7</code><code class="p">]:</code> <code class="n">df3</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'name'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Bob'</code><code class="p">,</code> <code class="s1">'Jake'</code><code class="p">,</code> <code class="s1">'Lisa'</code><code class="p">,</code> <code class="s1">'Sue'</code><code class="p">],</code>
                            <code class="s1">'salary'</code><code class="p">:</code> <code class="p">[</code><code class="mi">70000</code><code class="p">,</code> <code class="mi">80000</code><code class="p">,</code> <code class="mi">120000</code><code class="p">,</code> <code class="mi">90000</code><code class="p">]})</code>
        <code class="n">display</code><code class="p">(</code><code class="s1">'df1'</code><code class="p">,</code> <code class="s1">'df3'</code><code class="p">,</code> <code class="s1">'pd.merge(df1, df3, left_on="employee",</code>
                 <code class="n">right_on</code><code class="o">=</code><code class="s2">"name"</code><code class="p">)</code><code class="s1">')</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">7</code><code class="p">]:</code> <code class="n">df1</code>                         <code class="n">df3</code>
          <code class="n">employee</code>        <code class="n">group</code>        <code class="n">name</code>  <code class="n">salary</code>
        <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>     <code class="mi">0</code>   <code class="n">Bob</code>   <code class="mi">70000</code>
        <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>     <code class="mi">1</code>  <code class="n">Jake</code>   <code class="mi">80000</code>
        <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>     <code class="mi">2</code>  <code class="n">Lisa</code>  <code class="mi">120000</code>
        <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>     <code class="mi">3</code>   <code class="n">Sue</code>   <code class="mi">90000</code>

        <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df1</code><code class="p">,</code> <code class="n">df3</code><code class="p">,</code> <code class="n">left_on</code><code class="o">=</code><code class="s2">"employee"</code><code class="p">,</code> <code class="n">right_on</code><code class="o">=</code><code class="s2">"name"</code><code class="p">)</code>
          <code class="n">employee</code>        <code class="n">group</code>  <code class="n">name</code>  <code class="n">salary</code>
        <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>   <code class="n">Bob</code>   <code class="mi">70000</code>
        <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>  <code class="n">Jake</code>   <code class="mi">80000</code>
        <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>  <code class="n">Lisa</code>  <code class="mi">120000</code>
        <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>   <code class="n">Sue</code>   <code class="mi">90000</code></pre>
<p>The result has a redundant column that we can drop if desired—for
example, by using the <code>DataFrame.drop()</code> method:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">8</code><code class="p">]:</code> <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df1</code><code class="p">,</code> <code class="n">df3</code><code class="p">,</code> <code class="n">left_on</code><code class="o">=</code><code class="s2">"employee"</code><code class="p">,</code> <code class="n">right_on</code><code class="o">=</code><code class="s2">"name"</code><code class="p">)</code><code class="o">.</code><code class="n">drop</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">8</code><code class="p">]:</code>   <code class="n">employee</code>        <code class="n">group</code>  <code class="n">salary</code>
        <code class="mi">0</code>      <code class="n">Bob</code>   <code class="n">Accounting</code>   <code class="mi">70000</code>
        <code class="mi">1</code>     <code class="n">Jake</code>  <code class="n">Engineering</code>   <code class="mi">80000</code>
        <code class="mi">2</code>     <code class="n">Lisa</code>  <code class="n">Engineering</code>  <code class="mi">120000</code>
        <code class="mi">3</code>      <code class="n">Sue</code>           <code class="n">HR</code>   <code class="mi">90000</code></pre>
</div></section>
<section data-pdf-bookmark="The left_index and right_index Keywords" data-type="sect2"><div class="sect2" id="ch_0307-merge-and-join_the-left_index-and-right_index-keywords">
<h2>The left_index and right_index Keywords</h2>
<p>Sometimes, rather than merging on a column, you would instead like to
merge on an index. For example, your data might look like this:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="n">df1a</code> <code class="o">=</code> <code class="n">df1</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="s1">'employee'</code><code class="p">)</code>
        <code class="n">df2a</code> <code class="o">=</code> <code class="n">df2</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="s1">'employee'</code><code class="p">)</code>
        <code class="n">display</code><code class="p">(</code><code class="s1">'df1a'</code><code class="p">,</code> <code class="s1">'df2a'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="n">df1a</code>                      <code class="n">df2a</code>
                        <code class="n">group</code>               <code class="n">hire_date</code>
        <code class="n">employee</code>                  <code class="n">employee</code>
        <code class="n">Bob</code>        <code class="n">Accounting</code>     <code class="n">Lisa</code>           <code class="mi">2004</code>
        <code class="n">Jake</code>      <code class="n">Engineering</code>     <code class="n">Bob</code>            <code class="mi">2008</code>
        <code class="n">Lisa</code>      <code class="n">Engineering</code>     <code class="n">Jake</code>           <code class="mi">2012</code>
        <code class="n">Sue</code>                <code class="n">HR</code>     <code class="n">Sue</code>            <code class="mi">2014</code></pre>
<p>You can use the index as the key for merging by specifying the
<code>left_index</code> and/or <code>right_index</code> flags in <code>pd.merge()</code>:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">10</code><code class="p">]:</code> <code class="n">display</code><code class="p">(</code><code class="s1">'df1a'</code><code class="p">,</code> <code class="s1">'df2a'</code><code class="p">,</code>
                 <code class="s2">"pd.merge(df1a, df2a, left_index=True, right_index=True)"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">10</code><code class="p">]:</code> <code class="n">df1a</code>                       <code class="n">df2a</code>
                         <code class="n">group</code>                <code class="n">hire_date</code>
         <code class="n">employee</code>                   <code class="n">employee</code>
         <code class="n">Bob</code>        <code class="n">Accounting</code>      <code class="n">Lisa</code>           <code class="mi">2004</code>
         <code class="n">Jake</code>      <code class="n">Engineering</code>      <code class="n">Bob</code>            <code class="mi">2008</code>
         <code class="n">Lisa</code>      <code class="n">Engineering</code>      <code class="n">Jake</code>           <code class="mi">2012</code>
         <code class="n">Sue</code>                <code class="n">HR</code>      <code class="n">Sue</code>            <code class="mi">2014</code>

         <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df1a</code><code class="p">,</code> <code class="n">df2a</code><code class="p">,</code> <code class="n">left_index</code><code class="o">=</code><code class="kc">True</code><code class="p">,</code> <code class="n">right_index</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
                         <code class="n">group</code>  <code class="n">hire_date</code>
         <code class="n">employee</code>
         <code class="n">Bob</code>        <code class="n">Accounting</code>       <code class="mi">2008</code>
         <code class="n">Jake</code>      <code class="n">Engineering</code>       <code class="mi">2012</code>
         <code class="n">Lisa</code>      <code class="n">Engineering</code>       <code class="mi">2004</code>
         <code class="n">Sue</code>                <code class="n">HR</code>       <code class="mi">2014</code></pre>
<p>For convenience, Pandas includes the <code>DataFrame.join()</code> method, which
performs an index-based merge without extra keywords:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">11</code><code class="p">]:</code> <code class="n">df1a</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">df2a</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">11</code><code class="p">]:</code>                 <code class="n">group</code>  <code class="n">hire_date</code>
         <code class="n">employee</code>
         <code class="n">Bob</code>        <code class="n">Accounting</code>       <code class="mi">2008</code>
         <code class="n">Jake</code>      <code class="n">Engineering</code>       <code class="mi">2012</code>
         <code class="n">Lisa</code>      <code class="n">Engineering</code>       <code class="mi">2004</code>
         <code class="n">Sue</code>                <code class="n">HR</code>       <code class="mi">2014</code></pre>
<p>If you’d like to mix indices and columns, you can combine
<code>left_index</code> with <code>right_on</code> or <code>left_on</code> with <code>right_index</code> to get the
desired behavior:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">12</code><code class="p">]:</code> <code class="n">display</code><code class="p">(</code><code class="s1">'df1a'</code><code class="p">,</code> <code class="s1">'df3'</code><code class="p">,</code> <code class="s2">"pd.merge(df1a, df3, left_index=True,</code>
                  <code class="n">right_on</code><code class="o">=</code><code class="s1">'name'</code><code class="p">)</code><code class="s2">")</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">12</code><code class="p">]:</code> <code class="n">df1a</code>                       <code class="n">df3</code>
                         <code class="n">group</code>      <code class="n">name</code>  <code class="n">salary</code>
         <code class="n">employee</code>                   <code class="mi">0</code>   <code class="n">Bob</code>   <code class="mi">70000</code>
         <code class="n">Bob</code>        <code class="n">Accounting</code>      <code class="mi">1</code>  <code class="n">Jake</code>   <code class="mi">80000</code>
         <code class="n">Jake</code>      <code class="n">Engineering</code>      <code class="mi">2</code>  <code class="n">Lisa</code>  <code class="mi">120000</code>
         <code class="n">Lisa</code>      <code class="n">Engineering</code>      <code class="mi">3</code>   <code class="n">Sue</code>   <code class="mi">90000</code>
         <code class="n">Sue</code>                <code class="n">HR</code>

         <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df1a</code><code class="p">,</code> <code class="n">df3</code><code class="p">,</code> <code class="n">left_index</code><code class="o">=</code><code class="kc">True</code><code class="p">,</code> <code class="n">right_on</code><code class="o">=</code><code class="s1">'name'</code><code class="p">)</code>
                  <code class="n">group</code>  <code class="n">name</code>  <code class="n">salary</code>
         <code class="mi">0</code>   <code class="n">Accounting</code>   <code class="n">Bob</code>   <code class="mi">70000</code>
         <code class="mi">1</code>  <code class="n">Engineering</code>  <code class="n">Jake</code>   <code class="mi">80000</code>
         <code class="mi">2</code>  <code class="n">Engineering</code>  <code class="n">Lisa</code>  <code class="mi">120000</code>
         <code class="mi">3</code>           <code class="n">HR</code>   <code class="n">Sue</code>   <code class="mi">90000</code></pre>
<p>All of these options also work with multiple indices and/or multiple
columns; the interface for this behavior is very intuitive. For more
information on this, see the
<a href="https://oreil.ly/ffyAp">“Merge, Join,
and Concatenate” section</a> of the Pandas 
<span class="keep-together">documentation</span><a data-startref="ix_ch19-asciidoc13" data-type="indexterm" id="idm45858777990032"/><a data-startref="ix_ch19-asciidoc12" data-type="indexterm" id="idm45858777989424"/><a data-startref="ix_ch19-asciidoc11" data-type="indexterm" id="idm45858777988784"/>.<a data-startref="ix_ch19-asciidoc10" data-type="indexterm" id="idm45858777987984"/><a data-startref="ix_ch19-asciidoc9" data-type="indexterm" id="idm45858777987280"/><a data-startref="ix_ch19-asciidoc8" data-type="indexterm" id="idm45858777986608"/><a data-startref="ix_ch19-asciidoc7" data-type="indexterm" id="idm45858777985936"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Specifying Set Arithmetic for Joins" data-type="sect1"><div class="sect1" id="ch_0307-merge-and-join_specifying-set-arithmetic-for-joins">
<h1>Specifying Set Arithmetic for Joins</h1>
<p><a data-primary="joins" data-secondary="set arithmetic for" data-type="indexterm" id="idm45858777983584"/><a data-primary="pd.merge() function" data-secondary="specifying set arithmetic for joins" data-type="indexterm" id="idm45858777982608"/>In all the preceding examples we have glossed over one important
consideration in performing a join: the type of set arithmetic used in
the join. This comes up when a value appears in one key column but not
the other. Consider this example:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">13</code><code class="p">]:</code> <code class="n">df6</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'name'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Peter'</code><code class="p">,</code> <code class="s1">'Paul'</code><code class="p">,</code> <code class="s1">'Mary'</code><code class="p">],</code>
                             <code class="s1">'food'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'fish'</code><code class="p">,</code> <code class="s1">'beans'</code><code class="p">,</code> <code class="s1">'bread'</code><code class="p">]},</code>
                            <code class="n">columns</code><code class="o">=</code><code class="p">[</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'food'</code><code class="p">])</code>
         <code class="n">df7</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'name'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Mary'</code><code class="p">,</code> <code class="s1">'Joseph'</code><code class="p">],</code>
                             <code class="s1">'drink'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'wine'</code><code class="p">,</code> <code class="s1">'beer'</code><code class="p">]},</code>
                            <code class="n">columns</code><code class="o">=</code><code class="p">[</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'drink'</code><code class="p">])</code>
         <code class="n">display</code><code class="p">(</code><code class="s1">'df6'</code><code class="p">,</code> <code class="s1">'df7'</code><code class="p">,</code> <code class="s1">'pd.merge(df6, df7)'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">13</code><code class="p">]:</code> <code class="n">df6</code>                  <code class="n">df7</code>
             <code class="n">name</code>   <code class="n">food</code>           <code class="n">name</code> <code class="n">drink</code>
         <code class="mi">0</code>  <code class="n">Peter</code>   <code class="n">fish</code>      <code class="mi">0</code>    <code class="n">Mary</code>  <code class="n">wine</code>
         <code class="mi">1</code>   <code class="n">Paul</code>  <code class="n">beans</code>      <code class="mi">1</code>  <code class="n">Joseph</code>  <code class="n">beer</code>
         <code class="mi">2</code>   <code class="n">Mary</code>  <code class="n">bread</code>

         <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df6</code><code class="p">,</code> <code class="n">df7</code><code class="p">)</code>
            <code class="n">name</code>   <code class="n">food</code> <code class="n">drink</code>
         <code class="mi">0</code>  <code class="n">Mary</code>  <code class="n">bread</code>  <code class="n">wine</code></pre>
<p>Here we have merged two datasets that have only a single “name” entry
in common: Mary. <a data-primary="inner join" data-type="indexterm" id="idm45858777849136"/>By default, the result contains the <em>intersection</em> of
the two sets of inputs; this is what is known as an <em>inner join</em>. We can
specify this explicitly using the <code>how</code> keyword, which defaults to
<code>"inner"</code>:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">14</code><code class="p">]:</code> <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df6</code><code class="p">,</code> <code class="n">df7</code><code class="p">,</code> <code class="n">how</code><code class="o">=</code><code class="s1">'inner'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">14</code><code class="p">]:</code>    <code class="n">name</code>   <code class="n">food</code> <code class="n">drink</code>
         <code class="mi">0</code>  <code class="n">Mary</code>  <code class="n">bread</code>  <code class="n">wine</code></pre>
<p>Other options for the <code>how</code> keyword are
<code>'outer'</code>, <code>'left'</code>, and
<code>'right'</code>. <a data-primary="outer join" data-type="indexterm" id="idm45858777787776"/>An <em>outer join</em> returns a join over
the union of the input columns and fills in missing values with NAs:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">15</code><code class="p">]:</code> <code class="n">display</code><code class="p">(</code><code class="s1">'df6'</code><code class="p">,</code> <code class="s1">'df7'</code><code class="p">,</code> <code class="s2">"pd.merge(df6, df7, how='outer')"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">15</code><code class="p">]:</code> <code class="n">df6</code>                  <code class="n">df7</code>
             <code class="n">name</code>   <code class="n">food</code>           <code class="n">name</code> <code class="n">drink</code>
         <code class="mi">0</code>  <code class="n">Peter</code>   <code class="n">fish</code>      <code class="mi">0</code>    <code class="n">Mary</code>  <code class="n">wine</code>
         <code class="mi">1</code>   <code class="n">Paul</code>  <code class="n">beans</code>      <code class="mi">1</code>  <code class="n">Joseph</code>  <code class="n">beer</code>
         <code class="mi">2</code>   <code class="n">Mary</code>  <code class="n">bread</code>

         <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df6</code><code class="p">,</code> <code class="n">df7</code><code class="p">,</code> <code class="n">how</code><code class="o">=</code><code class="s1">'outer'</code><code class="p">)</code>
              <code class="n">name</code>   <code class="n">food</code> <code class="n">drink</code>
         <code class="mi">0</code>   <code class="n">Peter</code>   <code class="n">fish</code>   <code class="n">NaN</code>
         <code class="mi">1</code>    <code class="n">Paul</code>  <code class="n">beans</code>   <code class="n">NaN</code>
         <code class="mi">2</code>    <code class="n">Mary</code>  <code class="n">bread</code>  <code class="n">wine</code>
         <code class="mi">3</code>  <code class="n">Joseph</code>    <code class="n">NaN</code>  <code class="n">beer</code></pre>
<p><a data-primary="left join" data-type="indexterm" id="idm45858777723104"/><a data-primary="right join" data-type="indexterm" id="idm45858777722496"/>The <em>left join</em> and <em>right join</em> return joins over the left entries and
right entries, respectively. For example:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">16</code><code class="p">]:</code> <code class="n">display</code><code class="p">(</code><code class="s1">'df6'</code><code class="p">,</code> <code class="s1">'df7'</code><code class="p">,</code> <code class="s2">"pd.merge(df6, df7, how='left')"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">16</code><code class="p">]:</code> <code class="n">df6</code>                  <code class="n">df7</code>
             <code class="n">name</code>   <code class="n">food</code>           <code class="n">name</code> <code class="n">drink</code>
         <code class="mi">0</code>  <code class="n">Peter</code>   <code class="n">fish</code>      <code class="mi">0</code>    <code class="n">Mary</code>  <code class="n">wine</code>
         <code class="mi">1</code>   <code class="n">Paul</code>  <code class="n">beans</code>      <code class="mi">1</code>  <code class="n">Joseph</code>  <code class="n">beer</code>
         <code class="mi">2</code>   <code class="n">Mary</code>  <code class="n">bread</code>

         <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df6</code><code class="p">,</code> <code class="n">df7</code><code class="p">,</code> <code class="n">how</code><code class="o">=</code><code class="s1">'left'</code><code class="p">)</code>
             <code class="n">name</code>   <code class="n">food</code> <code class="n">drink</code>
         <code class="mi">0</code>  <code class="n">Peter</code>   <code class="n">fish</code>   <code class="n">NaN</code>
         <code class="mi">1</code>   <code class="n">Paul</code>  <code class="n">beans</code>   <code class="n">NaN</code>
         <code class="mi">2</code>   <code class="n">Mary</code>  <code class="n">bread</code>  <code class="n">wine</code></pre>
<p>The output rows now correspond to the entries in the left input. Using
<code>how='right'</code> works in a similar manner.</p>
<p>All of these options can be applied straightforwardly to any of the
preceding join types.</p>
</div></section>
<section data-pdf-bookmark="Overlapping Column Names: The suffixes Keyword" data-type="sect1"><div class="sect1" id="ch_0307-merge-and-join_overlapping-column-names-the-suffixes-keyword">
<h1>Overlapping Column Names: The suffixes Keyword</h1>
<p><a data-primary="column(s)" data-secondary="suffixes keyword and overlapping names" data-type="indexterm" id="idm45858777536560"/><a data-primary="suffixes keyword" data-type="indexterm" id="idm45858777535616"/>Last, you may end up in a case where your two input <code>DataFrame</code>s have
conflicting column names. Consider this example:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">17</code><code class="p">]:</code> <code class="n">df8</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'name'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Bob'</code><code class="p">,</code> <code class="s1">'Jake'</code><code class="p">,</code> <code class="s1">'Lisa'</code><code class="p">,</code> <code class="s1">'Sue'</code><code class="p">],</code>
                             <code class="s1">'rank'</code><code class="p">:</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">]})</code>
         <code class="n">df9</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'name'</code><code class="p">:</code> <code class="p">[</code><code class="s1">'Bob'</code><code class="p">,</code> <code class="s1">'Jake'</code><code class="p">,</code> <code class="s1">'Lisa'</code><code class="p">,</code> <code class="s1">'Sue'</code><code class="p">],</code>
                             <code class="s1">'rank'</code><code class="p">:</code> <code class="p">[</code><code class="mi">3</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">2</code><code class="p">]})</code>
         <code class="n">display</code><code class="p">(</code><code class="s1">'df8'</code><code class="p">,</code> <code class="s1">'df9'</code><code class="p">,</code> <code class="s1">'pd.merge(df8, df9, on="name")'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">17</code><code class="p">]:</code> <code class="n">df8</code>                <code class="n">df9</code>
            <code class="n">name</code>  <code class="n">rank</code>         <code class="n">name</code>  <code class="n">rank</code>
         <code class="mi">0</code>   <code class="n">Bob</code>     <code class="mi">1</code>      <code class="mi">0</code>   <code class="n">Bob</code>     <code class="mi">3</code>
         <code class="mi">1</code>  <code class="n">Jake</code>     <code class="mi">2</code>      <code class="mi">1</code>  <code class="n">Jake</code>     <code class="mi">1</code>
         <code class="mi">2</code>  <code class="n">Lisa</code>     <code class="mi">3</code>      <code class="mi">2</code>  <code class="n">Lisa</code>     <code class="mi">4</code>
         <code class="mi">3</code>   <code class="n">Sue</code>     <code class="mi">4</code>      <code class="mi">3</code>   <code class="n">Sue</code>     <code class="mi">2</code>

         <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df8</code><code class="p">,</code> <code class="n">df9</code><code class="p">,</code> <code class="n">on</code><code class="o">=</code><code class="s2">"name"</code><code class="p">)</code>
            <code class="n">name</code>  <code class="n">rank_x</code>  <code class="n">rank_y</code>
         <code class="mi">0</code>   <code class="n">Bob</code>       <code class="mi">1</code>       <code class="mi">3</code>
         <code class="mi">1</code>  <code class="n">Jake</code>       <code class="mi">2</code>       <code class="mi">1</code>
         <code class="mi">2</code>  <code class="n">Lisa</code>       <code class="mi">3</code>       <code class="mi">4</code>
         <code class="mi">3</code>   <code class="n">Sue</code>       <code class="mi">4</code>       <code class="mi">2</code></pre>
<p>Because the output would have two conflicting column names, the <code>merge</code>
function automatically appends the suffixes <code>_x</code> and <code>_y</code> to make the
output columns unique. If these defaults are inappropriate, it is
possible to specify a custom suffix using the <code>suffixes</code> keyword:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">18</code><code class="p">]:</code> <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">df8</code><code class="p">,</code> <code class="n">df9</code><code class="p">,</code> <code class="n">on</code><code class="o">=</code><code class="s2">"name"</code><code class="p">,</code> <code class="n">suffixes</code><code class="o">=</code><code class="p">[</code><code class="s2">"_L"</code><code class="p">,</code> <code class="s2">"_R"</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">18</code><code class="p">]:</code>    <code class="n">name</code>  <code class="n">rank_L</code>  <code class="n">rank_R</code>
         <code class="mi">0</code>   <code class="n">Bob</code>       <code class="mi">1</code>       <code class="mi">3</code>
         <code class="mi">1</code>  <code class="n">Jake</code>       <code class="mi">2</code>       <code class="mi">1</code>
         <code class="mi">2</code>  <code class="n">Lisa</code>       <code class="mi">3</code>       <code class="mi">4</code>
         <code class="mi">3</code>   <code class="n">Sue</code>       <code class="mi">4</code>       <code class="mi">2</code></pre>
<p>These suffixes work in any of the possible join patterns, and also work
if there are multiple overlapping columns.</p>
<p>In <a data-type="xref" href="ch20.xhtml#section-0308-aggregation-and-grouping">Chapter 20</a>, we’ll dive a bit deeper into relational algebra. For further discussion, see
<a href="https://oreil.ly/l8zZ1">“Merge, Join,
Concatenate and Compare”</a> in the Pandas documentation.</p>
</div></section>
<section data-pdf-bookmark="Example: US States Data" data-type="sect1"><div class="sect1" id="ch_0307-merge-and-join_example-us-states-data">
<h1>Example: US States Data</h1>
<p><a data-primary="merging" data-secondary="US state population data example" data-type="indexterm" id="ix_ch19-asciidoc14"/><a data-primary="population data, US, merge and join operations with" data-type="indexterm" id="ix_ch19-asciidoc15"/>Merge and join operations come up most often when combining data from
different sources. Here we will consider an example of some <a href="https://oreil.ly/aq6Xb">data about
US states and their populations</a>:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">19</code><code class="p">]:</code> <code class="c1"># Following are commands to download the data</code>
         <code class="c1"># repo = "https://raw.githubusercontent.com/jakevdp/data-USstates/master"</code>
         <code class="c1"># !cd data &amp;&amp; curl -O {repo}/state-population.csv</code>
         <code class="c1"># !cd data &amp;&amp; curl -O {repo}/state-areas.csv</code>
         <code class="c1"># !cd data &amp;&amp; curl -O {repo}/state-abbrevs.csv</code></pre>
<p>Let’s take a look at the three datasets, using the Pandas
<code>read_csv</code> function:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">20</code><code class="p">]:</code> <code class="n">pop</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'data/state-population.csv'</code><code class="p">)</code>
         <code class="n">areas</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'data/state-areas.csv'</code><code class="p">)</code>
         <code class="n">abbrevs</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'data/state-abbrevs.csv'</code><code class="p">)</code>

         <code class="n">display</code><code class="p">(</code><code class="s1">'pop.head()'</code><code class="p">,</code> <code class="s1">'areas.head()'</code><code class="p">,</code> <code class="s1">'abbrevs.head()'</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">20</code><code class="p">]:</code> <code class="n">pop</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
           <code class="n">state</code><code class="o">/</code><code class="n">region</code>     <code class="n">ages</code>  <code class="n">year</code>  <code class="n">population</code>
         <code class="mi">0</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2012</code>   <code class="mf">1117489.0</code>
         <code class="mi">1</code>           <code class="n">AL</code>    <code class="n">total</code>  <code class="mi">2012</code>   <code class="mf">4817528.0</code>
         <code class="mi">2</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2010</code>   <code class="mf">1130966.0</code>
         <code class="mi">3</code>           <code class="n">AL</code>    <code class="n">total</code>  <code class="mi">2010</code>   <code class="mf">4785570.0</code>
         <code class="mi">4</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2011</code>   <code class="mf">1125763.0</code>

         <code class="n">areas</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
                 <code class="n">state</code>  <code class="n">area</code> <code class="p">(</code><code class="n">sq</code><code class="o">.</code> <code class="n">mi</code><code class="p">)</code>
         <code class="mi">0</code>     <code class="n">Alabama</code>          <code class="mi">52423</code>
         <code class="mi">1</code>      <code class="n">Alaska</code>         <code class="mi">656425</code>
         <code class="mi">2</code>     <code class="n">Arizona</code>         <code class="mi">114006</code>
         <code class="mi">3</code>    <code class="n">Arkansas</code>          <code class="mi">53182</code>
         <code class="mi">4</code>  <code class="n">California</code>         <code class="mi">163707</code>

         <code class="n">abbrevs</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
                 <code class="n">state</code> <code class="n">abbreviation</code>
         <code class="mi">0</code>     <code class="n">Alabama</code>           <code class="n">AL</code>
         <code class="mi">1</code>      <code class="n">Alaska</code>           <code class="n">AK</code>
         <code class="mi">2</code>     <code class="n">Arizona</code>           <code class="n">AZ</code>
         <code class="mi">3</code>    <code class="n">Arkansas</code>           <code class="n">AR</code>
         <code class="mi">4</code>  <code class="n">California</code>           <code class="n">CA</code></pre>
<p>Given this information, say we want to compute a relatively
straightforward result: rank US states and territories by their 2010
population density. We clearly have the data here to find this result,
but we’ll have to combine the datasets to do so.</p>
<p>We’ll start with a many-to-one merge that will give us the
full state names within the population <code>DataFrame</code>. We want to merge
based on the <code>state/region</code> column of <code>pop</code> and the <code>abbreviation</code>
column of <code>abbrevs</code>. We’ll use
<code>how='outer'</code> to make sure no data is thrown
away due to mismatched labels:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">21</code><code class="p">]:</code> <code class="n">merged</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">pop</code><code class="p">,</code> <code class="n">abbrevs</code><code class="p">,</code> <code class="n">how</code><code class="o">=</code><code class="s1">'outer'</code><code class="p">,</code>
                           <code class="n">left_on</code><code class="o">=</code><code class="s1">'state/region'</code><code class="p">,</code> <code class="n">right_on</code><code class="o">=</code><code class="s1">'abbreviation'</code><code class="p">)</code>
         <code class="n">merged</code> <code class="o">=</code> <code class="n">merged</code><code class="o">.</code><code class="n">drop</code><code class="p">(</code><code class="s1">'abbreviation'</code><code class="p">,</code> <code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code> <code class="c1"># drop duplicate info</code>
         <code class="n">merged</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">21</code><code class="p">]:</code>   <code class="n">state</code><code class="o">/</code><code class="n">region</code>     <code class="n">ages</code>  <code class="n">year</code>  <code class="n">population</code>    <code class="n">state</code>
         <code class="mi">0</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2012</code>   <code class="mf">1117489.0</code>  <code class="n">Alabama</code>
         <code class="mi">1</code>           <code class="n">AL</code>    <code class="n">total</code>  <code class="mi">2012</code>   <code class="mf">4817528.0</code>  <code class="n">Alabama</code>
         <code class="mi">2</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2010</code>   <code class="mf">1130966.0</code>  <code class="n">Alabama</code>
         <code class="mi">3</code>           <code class="n">AL</code>    <code class="n">total</code>  <code class="mi">2010</code>   <code class="mf">4785570.0</code>  <code class="n">Alabama</code>
         <code class="mi">4</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2011</code>   <code class="mf">1125763.0</code>  <code class="n">Alabama</code></pre>
<p>Let’s double-check whether there were any mismatches here,
which we can do by looking for rows with nulls:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="n">merged</code><code class="o">.</code><code class="n">isnull</code><code class="p">()</code><code class="o">.</code><code class="n">any</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="n">state</code><code class="o">/</code><code class="n">region</code>    <code class="kc">False</code>
         <code class="n">ages</code>            <code class="kc">False</code>
         <code class="n">year</code>            <code class="kc">False</code>
         <code class="n">population</code>       <code class="kc">True</code>
         <code class="n">state</code>            <code class="kc">True</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="nb">bool</code></pre>
<p>Some of the <code>population</code> values are null; let’s figure out
which these are!</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">23</code><code class="p">]:</code> <code class="n">merged</code><code class="p">[</code><code class="n">merged</code><code class="p">[</code><code class="s1">'population'</code><code class="p">]</code><code class="o">.</code><code class="n">isnull</code><code class="p">()]</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">23</code><code class="p">]:</code>      <code class="n">state</code><code class="o">/</code><code class="n">region</code>     <code class="n">ages</code>  <code class="n">year</code>  <code class="n">population</code> <code class="n">state</code>
         <code class="mi">2448</code>           <code class="n">PR</code>  <code class="n">under18</code>  <code class="mi">1990</code>         <code class="n">NaN</code>   <code class="n">NaN</code>
         <code class="mi">2449</code>           <code class="n">PR</code>    <code class="n">total</code>  <code class="mi">1990</code>         <code class="n">NaN</code>   <code class="n">NaN</code>
         <code class="mi">2450</code>           <code class="n">PR</code>    <code class="n">total</code>  <code class="mi">1991</code>         <code class="n">NaN</code>   <code class="n">NaN</code>
         <code class="mi">2451</code>           <code class="n">PR</code>  <code class="n">under18</code>  <code class="mi">1991</code>         <code class="n">NaN</code>   <code class="n">NaN</code>
         <code class="mi">2452</code>           <code class="n">PR</code>    <code class="n">total</code>  <code class="mi">1993</code>         <code class="n">NaN</code>   <code class="n">NaN</code></pre>
<p>It appears that all the null population values are from Puerto Rico
prior to the year 2000; this is likely due to this data not being
available in the original source.</p>
<p>More importantly, we see that some of the new <code>state</code> entries are also
null, which means that there was no corresponding entry in the <code>abbrevs</code>
key! Let’s figure out which regions lack this match:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">24</code><code class="p">]:</code> <code class="n">merged</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">merged</code><code class="p">[</code><code class="s1">'state'</code><code class="p">]</code><code class="o">.</code><code class="n">isnull</code><code class="p">(),</code> <code class="s1">'state/region'</code><code class="p">]</code><code class="o">.</code><code class="n">unique</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">24</code><code class="p">]:</code> <code class="n">array</code><code class="p">([</code><code class="s1">'PR'</code><code class="p">,</code> <code class="s1">'USA'</code><code class="p">],</code> <code class="n">dtype</code><code class="o">=</code><code class="nb">object</code><code class="p">)</code></pre>
<p>We can quickly infer the issue: our population data includes entries for
Puerto Rico (PR) and the United States as a whole (USA), while these
entries do not appear in the state abbreviation key. We can fix these
quickly by filling in appropriate entries:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">25</code><code class="p">]:</code> <code class="n">merged</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">merged</code><code class="p">[</code><code class="s1">'state/region'</code><code class="p">]</code> <code class="o">==</code> <code class="s1">'PR'</code><code class="p">,</code> <code class="s1">'state'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'Puerto Rico'</code>
         <code class="n">merged</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">merged</code><code class="p">[</code><code class="s1">'state/region'</code><code class="p">]</code> <code class="o">==</code> <code class="s1">'USA'</code><code class="p">,</code> <code class="s1">'state'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'United States'</code>
         <code class="n">merged</code><code class="o">.</code><code class="n">isnull</code><code class="p">()</code><code class="o">.</code><code class="n">any</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">25</code><code class="p">]:</code> <code class="n">state</code><code class="o">/</code><code class="n">region</code>    <code class="kc">False</code>
         <code class="n">ages</code>            <code class="kc">False</code>
         <code class="n">year</code>            <code class="kc">False</code>
         <code class="n">population</code>       <code class="kc">True</code>
         <code class="n">state</code>           <code class="kc">False</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="nb">bool</code></pre>
<p>No more nulls in the <code>state</code> column: we’re all set!</p>
<p>Now we can merge the result with the area data using a similar
procedure. Examining our results, we will want to join on the <code>state</code>
column in both:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">26</code><code class="p">]:</code> <code class="n">final</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">merge</code><code class="p">(</code><code class="n">merged</code><code class="p">,</code> <code class="n">areas</code><code class="p">,</code> <code class="n">on</code><code class="o">=</code><code class="s1">'state'</code><code class="p">,</code> <code class="n">how</code><code class="o">=</code><code class="s1">'left'</code><code class="p">)</code>
         <code class="n">final</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">26</code><code class="p">]:</code>   <code class="n">state</code><code class="o">/</code><code class="n">region</code>     <code class="n">ages</code>  <code class="n">year</code>  <code class="n">population</code>    <code class="n">state</code>  <code class="n">area</code> <code class="p">(</code><code class="n">sq</code><code class="o">.</code> <code class="n">mi</code><code class="p">)</code>
         <code class="mi">0</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2012</code>   <code class="mf">1117489.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code>
         <code class="mi">1</code>           <code class="n">AL</code>    <code class="n">total</code>  <code class="mi">2012</code>   <code class="mf">4817528.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code>
         <code class="mi">2</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2010</code>   <code class="mf">1130966.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code>
         <code class="mi">3</code>           <code class="n">AL</code>    <code class="n">total</code>  <code class="mi">2010</code>   <code class="mf">4785570.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code>
         <code class="mi">4</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2011</code>   <code class="mf">1125763.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code></pre>
<p>Again, let’s check for nulls to see if there were any
mismatches:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">27</code><code class="p">]:</code> <code class="n">final</code><code class="o">.</code><code class="n">isnull</code><code class="p">()</code><code class="o">.</code><code class="n">any</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">27</code><code class="p">]:</code> <code class="n">state</code><code class="o">/</code><code class="n">region</code>     <code class="kc">False</code>
         <code class="n">ages</code>             <code class="kc">False</code>
         <code class="n">year</code>             <code class="kc">False</code>
         <code class="n">population</code>        <code class="kc">True</code>
         <code class="n">state</code>            <code class="kc">False</code>
         <code class="n">area</code> <code class="p">(</code><code class="n">sq</code><code class="o">.</code> <code class="n">mi</code><code class="p">)</code>     <code class="kc">True</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="nb">bool</code></pre>
<p>There are nulls in the <code>area</code> column; we can take a look to see which
regions were ignored here:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">28</code><code class="p">]:</code> <code class="n">final</code><code class="p">[</code><code class="s1">'state'</code><code class="p">][</code><code class="n">final</code><code class="p">[</code><code class="s1">'area (sq. mi)'</code><code class="p">]</code><code class="o">.</code><code class="n">isnull</code><code class="p">()]</code><code class="o">.</code><code class="n">unique</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">28</code><code class="p">]:</code> <code class="n">array</code><code class="p">([</code><code class="s1">'United States'</code><code class="p">],</code> <code class="n">dtype</code><code class="o">=</code><code class="nb">object</code><code class="p">)</code></pre>
<p>We see that our <code>areas</code> <code>DataFrame</code> does not contain the area of the
United States as a whole. We could insert the appropriate value (using
the sum of all state areas, for instance), but in this case
we’ll just drop the null values because the population
density of the entire United States is not relevant to our current
discussion:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">29</code><code class="p">]:</code> <code class="n">final</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
         <code class="n">final</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">29</code><code class="p">]:</code>   <code class="n">state</code><code class="o">/</code><code class="n">region</code>     <code class="n">ages</code>  <code class="n">year</code>  <code class="n">population</code>    <code class="n">state</code>  <code class="n">area</code> <code class="p">(</code><code class="n">sq</code><code class="o">.</code> <code class="n">mi</code><code class="p">)</code>
         <code class="mi">0</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2012</code>   <code class="mf">1117489.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code>
         <code class="mi">1</code>           <code class="n">AL</code>    <code class="n">total</code>  <code class="mi">2012</code>   <code class="mf">4817528.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code>
         <code class="mi">2</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2010</code>   <code class="mf">1130966.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code>
         <code class="mi">3</code>           <code class="n">AL</code>    <code class="n">total</code>  <code class="mi">2010</code>   <code class="mf">4785570.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code>
         <code class="mi">4</code>           <code class="n">AL</code>  <code class="n">under18</code>  <code class="mi">2011</code>   <code class="mf">1125763.0</code>  <code class="n">Alabama</code>        <code class="mf">52423.0</code></pre>
<p>Now we have all the data we need. To answer the question of interest,
let’s first select the portion of the data corresponding
with the year 2010, and the total population. We’ll use the
<code>query</code> function to do this quickly (this requires the NumExpr package
to be installed; see
<a data-type="xref" href="ch24.xhtml#section-0312-performance-eval-and-query">Chapter 24</a>):</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">30</code><code class="p">]:</code> <code class="n">data2010</code> <code class="o">=</code> <code class="n">final</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"year == 2010 &amp; ages == 'total'"</code><code class="p">)</code>
         <code class="n">data2010</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">30</code><code class="p">]:</code>     <code class="n">state</code><code class="o">/</code><code class="n">region</code>   <code class="n">ages</code>  <code class="n">year</code>  <code class="n">population</code>       <code class="n">state</code>  <code class="n">area</code> <code class="p">(</code><code class="n">sq</code><code class="o">.</code> <code class="n">mi</code><code class="p">)</code>
         <code class="mi">3</code>             <code class="n">AL</code>  <code class="n">total</code>  <code class="mi">2010</code>   <code class="mf">4785570.0</code>     <code class="n">Alabama</code>        <code class="mf">52423.0</code>
         <code class="mi">91</code>            <code class="n">AK</code>  <code class="n">total</code>  <code class="mi">2010</code>    <code class="mf">713868.0</code>      <code class="n">Alaska</code>       <code class="mf">656425.0</code>
         <code class="mi">101</code>           <code class="n">AZ</code>  <code class="n">total</code>  <code class="mi">2010</code>   <code class="mf">6408790.0</code>     <code class="n">Arizona</code>       <code class="mf">114006.0</code>
         <code class="mi">189</code>           <code class="n">AR</code>  <code class="n">total</code>  <code class="mi">2010</code>   <code class="mf">2922280.0</code>    <code class="n">Arkansas</code>        <code class="mf">53182.0</code>
         <code class="mi">197</code>           <code class="n">CA</code>  <code class="n">total</code>  <code class="mi">2010</code>  <code class="mf">37333601.0</code>  <code class="n">California</code>       <code class="mf">163707.0</code></pre>
<p>Now let’s compute the population density and display it in
order. We’ll start by re-indexing our data on the state, and
then compute the result:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">31</code><code class="p">]:</code> <code class="n">data2010</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="s1">'state'</code><code class="p">,</code> <code class="n">inplace</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
         <code class="n">density</code> <code class="o">=</code> <code class="n">data2010</code><code class="p">[</code><code class="s1">'population'</code><code class="p">]</code> <code class="o">/</code> <code class="n">data2010</code><code class="p">[</code><code class="s1">'area (sq. mi)'</code><code class="p">]</code></pre>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">32</code><code class="p">]:</code> <code class="n">density</code><code class="o">.</code><code class="n">sort_values</code><code class="p">(</code><code class="n">ascending</code><code class="o">=</code><code class="kc">False</code><code class="p">,</code> <code class="n">inplace</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
         <code class="n">density</code><code class="o">.</code><code class="n">head</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">32</code><code class="p">]:</code> <code class="n">state</code>
         <code class="n">District</code> <code class="n">of</code> <code class="n">Columbia</code>    <code class="mf">8898.897059</code>
         <code class="n">Puerto</code> <code class="n">Rico</code>             <code class="mf">1058.665149</code>
         <code class="n">New</code> <code class="n">Jersey</code>              <code class="mf">1009.253268</code>
         <code class="n">Rhode</code> <code class="n">Island</code>             <code class="mf">681.339159</code>
         <code class="n">Connecticut</code>              <code class="mf">645.600649</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code></pre>
<p class="pagebreak-before less_space">The result is a ranking of US states, plus Washington, DC, and Puerto
Rico, in order of their 2010 population density, in residents per square
mile. We can see that by far the densest region in this dataset is
Washington, DC (i.e., the District of Columbia); among states, the
densest is New Jersey.</p>
<p>We can also check the end of the list:</p>
<pre data-code-language="ipython" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">33</code><code class="p">]:</code> <code class="n">density</code><code class="o">.</code><code class="n">tail</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">33</code><code class="p">]:</code> <code class="n">state</code>
         <code class="n">South</code> <code class="n">Dakota</code>    <code class="mf">10.583512</code>
         <code class="n">North</code> <code class="n">Dakota</code>     <code class="mf">9.537565</code>
         <code class="n">Montana</code>          <code class="mf">6.736171</code>
         <code class="n">Wyoming</code>          <code class="mf">5.768079</code>
         <code class="n">Alaska</code>           <code class="mf">1.087509</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code></pre>
<p>We see that the least dense state, by far, is Alaska, averaging slightly
over one resident per square mile.</p>
<p>This type of data merging is a common task when trying to answer
questions using real-world data sources. I hope that this example has
given you an idea of some of the ways you can combine the tools
we’ve covered in order to gain insight from your data<a data-startref="ix_ch19-asciidoc15" data-type="indexterm" id="idm45858775921648"/><a data-startref="ix_ch19-asciidoc14" data-type="indexterm" id="idm45858775921040"/>!<a data-startref="ix_ch19-asciidoc4" data-type="indexterm" id="idm45858775920272"/><a data-startref="ix_ch19-asciidoc3" data-type="indexterm" id="idm45858775919568"/><a data-startref="ix_ch19-asciidoc2" data-type="indexterm" id="idm45858775918896"/><a data-startref="ix_ch19-asciidoc1" data-type="indexterm" id="idm45858775918224"/><a data-startref="ix_ch19-asciidoc0" data-type="indexterm" id="idm45858775917552"/></p>
</div></section>
</div></section></div></body></html>