<html><head></head><body><section data-pdf-bookmark="Chapter 14. Data Exchange" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch-web">&#13;
<h1><span class="label">Chapter 14. </span>Data Exchange</h1>&#13;
&#13;
<p>Data can be stored and exchanged in many different formats. Thus far, we’ve focused on plain-text delimited and fixed-width formats (<a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a>). In this chapter, we expand our horizons a bit and introduce a few other popular formats. While CSV, TSV, and FWF files are useful for organizing data into a dataframe, other file formats can save space or represent more complex data structures. <em>Binary</em> files (<em>binary</em> is a term for formats that aren’t plaintext) can be more economical than plain-text data sources. For example, in this chapter we introduce NetCDF, a popular binary format for exchanging large amounts of scientific data. Other plain-text formats like JSON and XML can organize data in ways that are more general and useful for complex data structures. Even HTML web pages, a close cousin to XML, often contain useful information that we can scrape and wrangle into shape for analysis.</p>&#13;
&#13;
<p>In this chapter, we introduce these popular formats, describe a mental model for their organization, and provide examples. In addition to introducing these formats, we cover programmatic ways to acquire data online. Before the internet, data scientists had to physically move disk drives to share data with one another. Now we can freely retrieve datasets from computers across the world. We introduce HTTP, the primary communication protocol for the web, and REST, an architecture to transfer data. By learning a bit about these web technologies, we can take better advantage of the web as a data source.</p>&#13;
&#13;
<p>Throughout this book, we have set an example of reproducible code for wrangling, exploring, and modeling with data. In this chapter, we address how to acquire data that are available online in a reproducible fashion.</p>&#13;
&#13;
<p>We begin with a description of NetCDF, followed by JSON. Then, after an overview of web protocols for data exchange, we wrap up the chapter with an introduction to XML, HTML, and XPath, a tool for extracting content from these types of files.</p>&#13;
&#13;
&#13;
<section data-pdf-bookmark="NetCDF Data" data-type="sect1"><div class="sect1" id="netcdf-data">&#13;
<h1>NetCDF Data</h1>&#13;
&#13;
<p>The <a class="reference external" href="https://oreil.ly/_qZGj">Network Common Data Form (NetCDF)</a> is a convenient<a contenteditable="false" data-primary="NetCDF data" data-type="indexterm" id="ix_netcdf_ch14"/><a contenteditable="false" data-primary="data exchange" data-secondary="NetCDF data" data-type="indexterm" id="ix_de_netcdf"/> and efficient format for storing array-oriented scientific data. A mental model for this format represents a variable by a multidimensional grid of values. The diagram in <a class="reference internal" data-type="xref" href="#netcdf-diagram">Figure 14-1</a> shows the concept. A variable such as rainfall is recorded daily at places around the globe. We can imagine these rainfall values arranged in a cube with longitude running along one side of the cube, latitude along another, and date in the third dimension. Each cell in the cube holds the rainfall recorded for one day at a particular location. A NetCDF file also contains information, which we call <em>metadata</em>, about the dimensions of the cube. The same information would be organized quite differently in a dataframe, where we would need three features for latitude, longitude, and date for each rainfall measurement. This would mean repeating lots of data. With a NetCDF file, we don’t need to repeat the latitude and longitude values for each day, nor the dates for each location.</p>&#13;
&#13;
<figure><div class="figure" id="netcdf-diagram"><img src="assets/leds_1401.png"/>&#13;
<h6><span class="label">Figure 14-1. </span>This diagram represents a model for NetCDF data. The data are organized into a three-dimensional array that contains recordings of rainfall at locations in time (latitude, longitude, and time). The “X” marks one rainfall measurement for a specific location on a particular date.</h6>&#13;
</div></figure>&#13;
&#13;
<p>NetCDF has several other advantages, in addition to being more compact:</p>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Scalable</dt>&#13;
	<dd>&#13;
	<p>It provides efficient access to subsets of the data.</p>&#13;
	</dd>&#13;
	<dt>Appendable</dt>&#13;
	<dd>&#13;
	<p>You can easily add new data without redefining the structure.</p>&#13;
	</dd>&#13;
	<dt>Sharable</dt>&#13;
	<dd>&#13;
	<p>It’s a common format that’s independent of the coding language and operating system.</p>&#13;
	</dd>&#13;
	<dt>Self-describing</dt>&#13;
	<dd>&#13;
	<p>The source file contains both a description of the data’s organization and the data itself.</p>&#13;
	</dd>&#13;
	<dt>Community</dt>&#13;
	<dd>&#13;
	<p>The tools are made available by a community of users.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The NetCDF format<a contenteditable="false" data-primary="binary data" data-type="indexterm" id="id1541"/> is an example of <em>binary</em> data—data that can’t directly be read into a text editor like <code>vim</code> or Visual Studio Code, unlike text formats like CSV. There are a multitude of other binary data formats, including SQLite databases (from <a class="reference internal" data-type="xref" href="ch07.html#ch-sql">Chapter 7</a>), Feather, and Apache Arrow. Binary data formats provide flexibility in how datasets are stored, but they also typically need special tools to open and read them in.</p>&#13;
</div>&#13;
&#13;
<p>NetCDF variables are not limited to three dimensions. For example, elevation could be added to our earth science application so that we have recordings of, say, temperature, in time, latitude, longitude, and elevation. And dimensions need not correspond to physical dimensions. Climate scientists often run several models and store the model number in a dimension along with the model output. While NetCDF was originally developed for atmospheric scientists at the University Corporation for Atmospheric Research (UCAR), the format has gained popularity and is now used at thousands of educational, research, and government sites around the world. And the applications have expanded to other areas, such as astronomy and physics with the <a class="reference external" href="https://oreil.ly/kg9kV">Smithsonian/NASA Astrophysics Data System (ADS)</a> and medical imaging with <a class="reference external" href="https://oreil.ly/6t3gJ">Medical Image NetCDF (MINC)</a>.</p>&#13;
&#13;
<p>NetCDF files have three basic components: dimensions, variables, and various sorts of metadata. The <em>variable</em> contains what we think of as the data, such as the rainfall recordings. Each variable has a name, storage type, and shape, meaning the number of dimensions. The <em>dimensions</em> component gives each dimension’s name and number of grid points. Additional information is provided by the <em>coordinates</em>—in particular, the points at which the measurements are made, such as for longitude, where these might be <span class="math notranslate nohighlight"><math> <mn>0.0</mn> <mo>,</mo> <mn>0.25</mn> <mo>,</mo> <mn>0.50</mn> <mo>,</mo> <mo>…</mo> <mo>,</mo> <mn>359.75</mn> </math></span>. Other metadata include <em>attributes</em>. Attributes for a variable can hold ancillary information about the variables, and other attributes contain global information about the file, such as who published the dataset, their contact information, and permissions for using the data. This global information is critical to ensure reproducible results.</p>&#13;
&#13;
<p>The following example examines the components of a particular NetCDF file and demonstrates how to extract portions of data from variables.</p>&#13;
&#13;
<p>The <a class="reference external" href="https://oreil.ly/NAhRW">Climate Data Store</a> provides a collection of datasets from various climate sectors and services. We visited their site and requested <span class="keep-together">measurements</span> of temperature and total precipitation for a two-week period in December 2022. Let’s walk through a brief examination of these data to get a sense of the organization of the components in the file, how to extract subsets, and how to make <span class="keep-together">visualizations</span>.</p>&#13;
&#13;
<p>The data are in the NetCDF file <em>CDS_ERA5_22-12.nc</em>. Let’s first figure out how large the file is:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">from</code></span><code> </code><span><code class="nn">pathlib</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">Path</code></span><code>&#13;
</code><span><code class="kn">import</code></span><code> </code><span><code class="nn">os</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">file_path</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code><code class="p">)</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">CDS_ERA5_22-12.nc</code><code class="s1">'</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">kib</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">1024</code></span><code>&#13;
</code><span><code class="n">size</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">os</code></span><span><code class="o">.</code></span><span><code class="n">path</code></span><span><code class="o">.</code></span><span><code class="n">getsize</code></span><span><code class="p">(</code></span><span><code class="n">file_path</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">round</code></span><span><code class="p">(</code></span><span><code class="n">size</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="n">kib</code></span><span><code class="o">*</code><code class="o">*</code></span><span><code class="mi">3</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
2.0&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Despite having only three variables (total precipitation, rain rate, temperature) for two weeks, the file is two GiB in size! These climate sources often tend to be quite large.</p>&#13;
&#13;
<p>The <code>xarray</code> package<a contenteditable="false" data-primary="xarray package" data-type="indexterm" id="id1542"/> is useful for working with array-like data and, in particular, NetCDF. We use its functionality to explore the components of our climate file. First we open the file:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">import</code></span><code> </code><span><code class="nn">xarray</code></span><code> </code><span><code class="k">as</code></span><code> </code><span><code class="nn">xr</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">ds</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">xr</code></span><span><code class="o">.</code></span><span><code class="n">open_dataset</code></span><span><code class="p">(</code></span><span><code class="n">file_path</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now let’s check the dimensions component of the file:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">dims</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
Frozen(SortedKeysDict({'longitude': 1440, 'latitude': 721, 'time': 408}))&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>As in <a class="reference internal" data-type="xref" href="#netcdf-diagram">Figure 14-1</a>, our file has three dimensions: longitude, latitude, and time. The size of each dimension tells us that there are over 400,000 cells of data values (1440 × 721 × 408). If these data were in a dataframe, then it would have 400,000 rows with latitude, longitude, and time columns in great repetition! Instead, we only need their values once, and the coordinates component gives them to us:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">coords</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
Coordinates:&#13;
  * longitude  (longitude) float32 0.0 0.25 0.5 0.75 ... 359.0 359.2 359.5 359.8&#13;
  * latitude   (latitude) float32 90.0 89.75 89.5 89.25 ... -89.5 -89.75 -90.0&#13;
  * time       (time) datetime64[ns] 2022-12-15 ... 2022-12-31T23:00:00&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Each variable in our file is three-dimensional. Actually, a variable doesn’t have to have all three dimensions, but in our example they do:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">data_vars</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
Data variables:&#13;
    t2m      (time, latitude, longitude) float32 ...&#13;
    lsrr     (time, latitude, longitude) float32 ...&#13;
    tp       (time, latitude, longitude) float32 ...&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Metadata for a variable provides the units and a longer description, while metadata for the source gives us information such as when we retrieved the data:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">tp</code></span><span><code class="o">.</code></span><span><code class="n">attrs</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
{'units': 'm', 'long_name': 'Total precipitation'}&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">attrs</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
{'Conventions': 'CF-1.6',&#13;
 'history': '2023-01-19 19:54:37 GMT by grib_to_netcdf-2.25.1: /opt/ecmwf/mars-client/bin/grib_to_netcdf.bin -S param -o /cache/data6/adaptor.mars.internal-1674158060.3800251-17201-13-c46a8ac2-f1b6-4b57-a14e-801c001f7b2b.nc /cache/tmp/c46a8ac2-f1b6-4b57-a14e-801c001f7b2b-adaptor.mars.internal-1674158033.856014-17201-20-tmp.grib'}&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>By keeping all of these pieces of information in the source file itself, we don’t risk losing it or having the description get out of sync with the data.</p>&#13;
&#13;
<p>Like with <code>pandas</code>, <code>xarray</code> provides many different ways to select portions of the data to work with. We show two examples. First we focus on one specific location and examine the total precipitation in time with a line plot:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">plt</code></span><span><code class="o">.</code></span><span><code class="n">figure</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="p">(</code></span><span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">sel</code></span><span><code class="p">(</code></span><span><code class="n">latitude</code></span><span><code class="o">=</code></span><span><code class="mf">37.75</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">longitude</code></span><span><code class="o">=</code></span><span><code class="mf">237.5</code></span><span><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">tp</code></span><code> </code><span><code class="o">*</code></span><code> </code><span><code class="mi">100</code></span><span><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">plot</code></span><span><code class="p">(</code></span><span><code class="n">figsize</code></span><span><code class="o">=</code></span><span><code class="p">(</code></span><span><code class="mi">8</code></span><span><code class="p">,</code></span><span><code class="mi">3</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">plt</code></span><span><code class="o">.</code></span><span><code class="n">xlabel</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">plt</code></span><span><code class="o">.</code></span><span><code class="n">ylabel</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">Total precipitation (cm)</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">plt</code></span><span><code class="o">.</code></span><span><code class="n">show</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">;</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
&lt;Figure size 288x216 with 0 Axes&gt;&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_14in01.png"/>&#13;
&#13;
</div></figure>&#13;
&#13;
<p>Next we choose one date, December 31, 2022, at 1 p.m., and narrow down the latitude and longitude to the continental US to make a map of temperature:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">import</code></span><code> </code><span><code class="nn">datetime</code></span><code>&#13;
</code><span><code class="n">one_day</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">datetime</code></span><span><code class="o">.</code></span><span><code class="n">datetime</code></span><span><code class="p">(</code></span><span><code class="mi">2022</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">12</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">31</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">13</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">0</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">0</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">min_lon</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">min_lat</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">max_lon</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">max_lat</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">232</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">21</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">300</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">50</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">mask_lon</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">longitude</code></span><code> </code><span><code class="o">&gt;</code></span><code> </code><span><code class="n">min_lon</code></span><span><code class="p">)</code></span><code> </code><span><code class="o">&amp;</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">longitude</code></span><code> </code><span><code class="o">&lt;</code></span><code> </code><span><code class="n">max_lon</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">mask_lat</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">latitude</code></span><code> </code><span><code class="o">&gt;</code></span><code> </code><span><code class="n">min_lat</code></span><span><code class="p">)</code></span><code> </code><span><code class="o">&amp;</code></span><code> </code><span><code class="p">(</code></span><span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">latitude</code></span><code> </code><span><code class="o">&lt;</code></span><code> </code><span><code class="n">max_lat</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">ds_oneday_us</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">sel</code></span><span><code class="p">(</code></span><span><code class="n">time</code></span><span><code class="o">=</code></span><span><code class="n">one_day</code></span><span><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">t2m</code></span><span><code class="o">.</code></span><span><code class="n">where</code></span><span><code class="p">(</code></span><span><code class="n">mask_lon</code></span><code> </code><span><code class="o">&amp;</code></span><code> </code><span><code class="n">mask_lat</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">drop</code></span><span><code class="o">=</code></span><span><code class="kc">True</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Like <code>loc</code> for dataframes, <code>sel</code> returns<a contenteditable="false" data-primary="DataArray" data-type="indexterm" id="id1543"/> a new <code>DataArray</code> whose data is determined by the index labels along the specified dimension, which for this example is the date. And like <code>np.where</code>, <code>xr.where</code> returns elements depending on the logical condition provided. We use <code>drop=True</code> to reduce the size of the dataset.</p>&#13;
&#13;
<p>Let’s make a choropleth map of temperature, where color represents the temperature:</p>&#13;
&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ds_oneday_us</code></span><span><code class="o">.</code></span><span><code class="n">plot</code></span><span><code class="p">(</code></span><span><code class="n">figsize</code></span><span><code class="o">=</code></span><span><code class="p">(</code></span><span><code class="mi">8</code></span><span><code class="p">,</code></span><span><code class="mi">4</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<figure><div class="figure"><img src="assets/leds_14in02.png"/>&#13;
&#13;
</div></figure>&#13;
&#13;
<p>We can make out the shape of the US, the warm Caribbean, and the colder mountain ranges from this map.</p>&#13;
&#13;
<p>We wrap up by closing the file:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ds</code></span><span><code class="o">.</code></span><span><code class="n">close</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>This brief introduction to NetCDF is meant to touch on the basic concepts. Our main goal is to show that other kinds of data formats exist and can have advantages over plain-text read into a dataframe. For interested readers, NetCDF has a rich ecosystem of packages and functionality. For example, in addition to the <code>xarray</code> module, NetCDF files can be read with other Python modules like <a class="reference external" href="https://oreil.ly/UlX_k"><code>netCDF4</code></a> and <a class="reference external" href="https://oreil.ly/fKeQh"><code>gdal</code></a>. The NetCDF community has also provided command-line tools for interacting with NetCDF data. And to make visualizations and maps, options include <code>matplotlib</code>, <a class="reference external" href="https://oreil.ly/ozNrI"><code>iris</code></a>, which is built on top of <code>netCDF4</code>, and <a class="reference external" href="https://oreil.ly/9N7y7"><code>cartopy</code></a>.</p>&#13;
&#13;
<p>Next we consider the JSON format, which offers more flexibility to represent hierarchical data than the CSV and FWF formats<a contenteditable="false" data-primary="" data-startref="ix_de_netcdf" data-type="indexterm" id="id1544"/><a contenteditable="false" data-primary="" data-startref="ix_netcdf_ch14" data-type="indexterm" id="id1545"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="JSON Data" data-type="sect1"><div class="sect1" id="json-data">&#13;
<h1>JSON Data</h1>&#13;
&#13;
<p>JavaScript<a contenteditable="false" data-primary="JSON (JavaScript Object Notation)" data-type="indexterm" id="ix_json_ch14"/><a contenteditable="false" data-primary="data exchange" data-secondary="JSON" data-type="indexterm" id="ix_de_json"/> Object Notation (JSON) is a popular format for exchanging data on the web. This plain-text format has a simple and flexible syntax that aligns well with Python dictionaries, and it is easy for machines to parse and people to read.</p>&#13;
&#13;
<p>Briefly, JSON has two main structures, the object and the array:</p>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Object</dt>&#13;
	<dd>&#13;
	<p>Like a Python <code>dict</code>, a JSON object is an unordered collection of name-value pairs. These pairs are contained in curly braces; each is formatted as <code>"name":value</code>, and separated by commas.</p>&#13;
	</dd>&#13;
	<dt>Array</dt>&#13;
	<dd>&#13;
	<p>Like a Python <code>list</code>, a JSON array is an ordered collection of values contained in square brackets, where the values are unnamed and separated by commas.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<p>The values in an object and array can be of different types and can be nested. That is, an array can contain objects and vice versa. The primitive types are limited to string in double quotes, number in text representation, logical as true or false, and null.</p>&#13;
&#13;
<p>The following short JSON file demonstrates all of these syntactical features:</p>&#13;
&#13;
<div class="highlight-json notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>{</span><span>"lender_id"</span><span>:</span><span>"matt"</span><span>,</span><span> </span>&#13;
<span> </span><span>"loan_count"</span><span>:</span><span>23</span><span>,</span>&#13;
<span> </span><span>"status"</span><span>:[</span><span>2</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>3</span><span>],</span><span> </span>&#13;
<span> </span><span>"sponsored"</span><span>:</span><span> </span><span>false</span><span>,</span><span> </span>&#13;
<span> </span><span>"sponsor_name"</span><span>:</span><span> </span><span>null</span><span>,</span>&#13;
<span> </span><span>"lender_dem"</span><span>:{</span><span>"sex"</span><span>:</span><span>"m"</span><span>,</span><span>"age"</span><span>:</span><span>77</span><span> </span><span>}</span><span> </span>&#13;
<span>}</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Here we have an object that contains six name-value pairs. The values are heterogeneous; four are primitive values: string, number, logical, and null. The <code>status</code> value consists of an array of three (ordered) numbers, and <code>lender_dem</code> is an object with demographic information.</p>&#13;
&#13;
<p>The built-in <code>json</code> package can be used to work with JSON files in Python. For example, we can load this small file into a Python dictionary:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">import</code></span><code> </code><span><code class="nn">json</code></span><code>&#13;
</code><span><code class="kn">from</code></span><code> </code><span><code class="nn">pathlib</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">Path</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">file_path</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code><code class="p">)</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">js_ex</code><code class="s1">'</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">ex.json</code><code class="s1">'</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ex_dict</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">json</code></span><span><code class="o">.</code></span><span><code class="n">load</code></span><span><code class="p">(</code></span><span><code class="nb">open</code></span><span><code class="p">(</code></span><span><code class="n">file_path</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">ex_dict</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
{'lender_id': 'matt',&#13;
 'loan_count': 23,&#13;
 'status': [2, 1, 3],&#13;
 'sponsored': False,&#13;
 'sponsor_name': None,&#13;
 'lender_dem': {'sex': 'm', 'age': 77}}&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The dictionary<a contenteditable="false" data-primary="normalization" data-secondary="json_normalize() method" data-type="indexterm" id="id1546"/> matches the format of the Kiva file. This format doesn’t naturally translate to a dataframe. The <code>json_normalize</code> method can organize this semistructured JSON data into a flat table:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ex_df</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">json_normalize</code></span><span><code class="p">(</code></span><span><code class="n">ex_dict</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">ex_df</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>lender_id</th>&#13;
			<th>loan_count</th>&#13;
			<th>status</th>&#13;
			<th>sponsored</th>&#13;
			<th>sponsor_name</th>&#13;
			<th>lender_dem.sex</th>&#13;
			<th>lender_dem.age</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>matt</td>&#13;
			<td>23</td>&#13;
			<td>[2, 1, 3]</td>&#13;
			<td>False</td>&#13;
			<td>None</td>&#13;
			<td>m</td>&#13;
			<td>77</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Notice how the third element in this one-row dataframe is a list, whereas the nested object was converted into two columns.</p>&#13;
&#13;
<p>There’s a tremendous amount of flexibility in how data can be structured in JSON, which means that if we want to create a dataframe from JSON content, we need to understand how the data are organized in the JSON file. We provide three structures that translate easily into a dataframe in the next example.</p>&#13;
&#13;
<p>The list of PurpleAir sites used in the case study in <a class="reference internal" data-type="xref" href="ch12.html#ch-pa">Chapter 12</a> was JSON-formatted. In that chapter, we didn’t call attention to the format and simply read the file contents into a dictionary with the <code>json</code> library’s <code>load</code> method and then into a dataframe. Here, we have simplified that file while maintaining the general structure so that it’s easier to examine.</p>&#13;
&#13;
<p>We begin with an examination of the original file, and then reorganize it into two other JSON structures that might also be used to represent a dataframe. With these examples we aim to show the flexibility of JSON. The diagrams in <a class="reference internal" data-type="xref" href="#json-diagram">Figure 14-2</a> give representations of the three possibilities.</p>&#13;
&#13;
<figure><div class="figure" id="json-diagram"><img src="assets/leds_1402.png"/>&#13;
<h6><span class="label">Figure 14-2. </span>Three different approaches for a JSON-formatted file to store a dataframe.</h6>&#13;
</div></figure>&#13;
&#13;
<p>The leftmost dataframe in the diagram shows an organization by rows. Each row is an object of named values where the name corresponds to the column name of the dataframe. Rows would then be collected in an array. This structure coincides with that of the original file. In the following code, we display the file contents:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>{</span><span>"Header"</span><span>:</span> <span>[</span>&#13;
    <span>{</span><span>"status"</span><span>:</span> <span>"Success"</span><span>,</span>&#13;
     <span>"request_time"</span><span>:</span> <span>"2022-12-29T01:48:30-05:00"</span><span>,</span>&#13;
     <span>"url"</span><span>:</span> <span>"https://aqs.epa.gov/data/api/dailyData/..."</span><span>,</span>&#13;
     <span>"rows"</span><span>:</span> <span>4</span>&#13;
    <span>}</span>&#13;
  <span>],</span>&#13;
  <span>"Data"</span><span>:</span> <span>[</span>&#13;
    <span>{</span><span>"site"</span><span>:</span> <span>"0014"</span><span>,</span> <span>"date"</span><span>:</span> <span>"02-27"</span><span>,</span> <span>"aqi"</span><span>:</span> <span>30</span><span>},</span>&#13;
    <span>{</span><span>"site"</span><span>:</span> <span>"0014"</span><span>,</span> <span>"date"</span><span>:</span> <span>"02-24"</span><span>,</span> <span>"aqi"</span><span>:</span> <span>17</span><span>},</span>&#13;
    <span>{</span><span>"site"</span><span>:</span> <span>"0014"</span><span>,</span> <span>"date"</span><span>:</span> <span>"02-21"</span><span>,</span> <span>"aqi"</span><span>:</span> <span>60</span><span>},</span>&#13;
    <span>{</span><span>"site"</span><span>:</span> <span>"0014"</span><span>,</span> <span>"date"</span><span>:</span> <span>"01-15"</span><span>,</span> <span>"aqi"</span><span>:</span> <span>null</span><span>}</span>&#13;
  <span>]</span>&#13;
<span>}</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We see that the file consists of one object with two elements, named <code>Header</code> and <code>Data</code>. The <code>Data</code> element is an array with an element for each row in the dataframe, and as described earlier each element is an object. Let’s load the file into a dictionary and check its contents (see <a class="reference internal" data-type="xref" href="ch08.html#ch-files">Chapter 8</a> for more on finding a pathname to a file and printing its contents):</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">from</code></span><code> </code><span><code class="nn">pathlib</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">Path</code></span><code>&#13;
</code><span><code class="kn">import</code></span><code> </code><span><code class="nn">os</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">epa_file_path</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/js_ex/epa_row.json</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">data_row</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">json</code></span><span><code class="o">.</code></span><span><code class="n">loads</code></span><span><code class="p">(</code></span><span><code class="n">epa_file_path</code></span><span><code class="o">.</code></span><span><code class="n">read_text</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">data_row</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
{'Header': [{'status': 'Success',&#13;
   'request_time': '2022-12-29T01:48:30-05:00',&#13;
   'url': 'https://aqs.epa.gov/data/api/dailyData/...',&#13;
   'rows': 4}],&#13;
 'Data': [{'site': '0014', 'date': '02-27', 'aqi': 30},&#13;
  {'site': '0014', 'date': '02-24', 'aqi': 17},&#13;
  {'site': '0014', 'date': '02-21', 'aqi': 60},&#13;
  {'site': '0014', 'date': '01-15', 'aqi': None}]}&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can quickly convert the array of objects into a dataframe with the following call:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">DataFrame</code></span><span><code class="p">(</code></span><span><code class="n">data_row</code></span><span><code class="p">[</code></span><span><code class="s2">"</code><code class="s2">Data</code><code class="s2">"</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>site</th>&#13;
			<th>date</th>&#13;
			<th>aqi</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>0014</td>&#13;
			<td>02-27</td>&#13;
			<td>30.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>0014</td>&#13;
			<td>02-24</td>&#13;
			<td>17.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>0014</td>&#13;
			<td>02-21</td>&#13;
			<td>60.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>0014</td>&#13;
			<td>01-15</td>&#13;
			<td>NaN</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The middle diagram in <a class="reference internal" data-type="xref" href="#json-diagram">Figure 14-2</a> takes a column approach to organizing the data. Here the columns are provided as arrays and collected into an object with names that match the column names. The following file demonstrates the concept:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">epa_col_path</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/js_ex/epa_col.json</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="n">epa_col_path</code></span><span><code class="o">.</code></span><span><code class="n">read_text</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
{"site":[ "0014", "0014", "0014", "0014"],&#13;
"date":["02-27", "02-24", "02-21", "01-15"],&#13;
"aqi":[30,17,60,null]}&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Since <code>pd.read_json()</code> expects this format<a contenteditable="false" data-primary="read_json() method" data-type="indexterm" id="id1547"/>, we can read the file into a dataframe directly without needing to first load it into a dictionary:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_json</code></span><span><code class="p">(</code></span><span><code class="n">epa_col_path</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>site</th>&#13;
			<th>date</th>&#13;
			<th>aqi</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>14</td>&#13;
			<td>02-27</td>&#13;
			<td>30.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>14</td>&#13;
			<td>02-24</td>&#13;
			<td>17.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>14</td>&#13;
			<td>02-21</td>&#13;
			<td>60.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>14</td>&#13;
			<td>01-15</td>&#13;
			<td>NaN</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Lastly, we organize the data into a structure that resembles a matrix (the diagram on the right in the figure) and separately provide the column names for the features. The data matrix is organized as an array of arrays:</p>&#13;
&#13;
<div class="cell tag_hide-input docutils container">&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
{'vars': ['site', 'date', 'aqi'],&#13;
 'data': [['0014', '02-27', 30],&#13;
  ['0014', '02-24', 17],&#13;
  ['0014', '02-21', 60],&#13;
  ['0014', '01-15', None]]}&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can provide <code>vars</code> and <code>data</code> to create the dataframe:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">DataFrame</code></span><span><code class="p">(</code></span><span><code class="n">data_mat</code></span><span><code class="p">[</code></span><span><code class="s2">"</code><code class="s2">data</code><code class="s2">"</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">columns</code></span><span><code class="o">=</code></span><span><code class="n">data_mat</code></span><span><code class="p">[</code></span><span><code class="s2">"</code><code class="s2">vars</code><code class="s2">"</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>site</th>&#13;
			<th>date</th>&#13;
			<th>aqi</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>0014</td>&#13;
			<td>02-27</td>&#13;
			<td>30.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>0014</td>&#13;
			<td>02-24</td>&#13;
			<td>17.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>0014</td>&#13;
			<td>02-21</td>&#13;
			<td>60.0</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>0014</td>&#13;
			<td>01-15</td>&#13;
			<td>NaN</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We’ve included these examples to show the versatility of JSON. The main takeaway is that JSON files can arrange data in different ways, so we typically need to examine the file before we can read the data into a dataframe successfully. JSON files are very common for data stored on the web: the examples in this section were files downloaded from the PurpleAir and Kiva websites. Although we downloaded the data manually in this section, we often want to download many datafiles at a time, or we want a reliable and reproducible record of the download. In the next section, we introduce HTTP, a protocol that will let us write programs to download data from the web automatically<a contenteditable="false" data-primary="" data-startref="ix_de_json" data-type="indexterm" id="id1548"/><a contenteditable="false" data-primary="" data-startref="ix_json_ch14" data-type="indexterm" id="id1549"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="HTTP" data-type="sect1"><div class="sect1" id="http">&#13;
<h1>HTTP</h1>&#13;
&#13;
<p>HTTP (HyperText Transfer Protocol) is an all-purpose<a contenteditable="false" data-primary="" data-startref="ix_http_ch14" data-type="indexterm" id="id1550"/><a contenteditable="false" data-primary="data exchange" data-secondary="HTTP" data-type="indexterm" id="ix_de_http"/> infrastructure to access resources on the web. There are a tremendous number of datasets available to us on the internet, and with HTTP we can acquire these datasets.</p>&#13;
&#13;
<p>The internet allows computers to communicate with each other, and HTTP places a structure on the communication. HTTP is a simple <em>request-response</em> protocol, where a client submits a <em>request</em> to a server in a specially formatted text message, and the server sends a specially formatted text <em>response</em> back. The client might be a web browser or our Python session.</p>&#13;
&#13;
<p>An HTTP request has two parts: a header and an optional body. The header must follow a specific syntax. An example request to obtain the Wikipedia page shown in <a class="reference internal" data-type="xref" href="#fig-wiki-1500">Figure 14-3</a> looks like the following:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>GET</span> <span>/</span><span>wiki</span><span>/</span><span>1500</span><span>_metres_world_record_progression</span> <span>HTTP</span><span>/</span><span>1.1</span>&#13;
<span>Host</span><span>:</span> <span>en</span><span>.</span><span>wikipedia</span><span>.</span><span>org</span>&#13;
<span>User</span><span>-</span><span>Agent</span><span>:</span> <span>curl</span><span>/</span><span>7.65.2</span>&#13;
<span>Accept</span><span>:</span> <span>*/*</span> &#13;
<span>{</span><span>blank_line</span><span>}</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The first line contains three pieces of information: it starts with the method of the request, which is <code>GET</code>; this is followed by the URL of the web page we want; and last is the protocol and version. Each of the three lines that follow give auxiliary information for the server. This information has the format <code>name: <span class="pre">value</span></code>. Finally, a blank line marks the end of the header. Note that we’ve marked the blank line with <code>{blank_line}</code> in the preceding snippet; in the actual message, this is a blank line.</p>&#13;
&#13;
<figure><div class="figure" id="fig-wiki-1500"><img src="assets/leds_1403.png"/>&#13;
<h6><span class="label">Figure 14-3. </span>Screenshot of the Wikipedia page with data on the world record for the 1,500-meter race</h6>&#13;
</div></figure>&#13;
&#13;
<p>The client’s computer sends this message over the internet to the Wikipedia server. The server processes the request and sends a response, which also consists of a header and body. The header for the response looks like this:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>&lt;</span> <span>HTTP</span><span>/</span><span>1.1</span> <span>200</span> <span>OK</span>&#13;
<span>&lt;</span> <span>date</span><span>:</span> <span>Fri</span><span>,</span> <span>24</span> <span>Feb</span> <span>2023</span> <span>00</span><span>:</span><span>11</span><span>:</span><span>49</span> <span>GMT</span>&#13;
<span>&lt;</span> <span>server</span><span>:</span> <span>mw1369</span><span>.</span><span>eqiad</span><span>.</span><span>wmnet</span>&#13;
<span>&lt;</span> <span>x</span><span>-</span><span>content</span><span>-</span><span>type</span><span>-</span><span>options</span><span>:</span> <span>nosniff</span>&#13;
<span>&lt;</span> <span>content</span><span>-</span><span>language</span><span>:</span> <span>en</span>&#13;
<span>&lt;</span> <span>vary</span><span>:</span> <span>Accept</span><span>-</span><span>Encoding</span><span>,</span><span>Cookie</span><span>,</span><span>Authorization</span>&#13;
<span>&lt;</span> <span>last</span><span>-</span><span>modified</span><span>:</span> <span>Tue</span><span>,</span> <span>21</span> <span>Feb</span> <span>2023</span> <span>15</span><span>:</span><span>00</span><span>:</span><span>46</span> <span>GMT</span>&#13;
<span>&lt;</span> <span>content</span><span>-</span><span>type</span><span>:</span> <span>text</span><span>/</span><span>html</span><span>;</span> <span>charset</span><span>=</span><span>UTF</span><span>-</span><span>8</span>&#13;
<span>...</span>&#13;
<span>&lt;</span> <span>content</span><span>-</span><span>length</span><span>:</span> <span>153912</span>&#13;
<span>{</span><span>blank_line</span><span>}</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The first line states that the request completed successfully; the status code is 200. The next lines give additional information for the client. We shortened this header quite a bit to focus on just a few pieces of information that tell us the content of the body is HTML and uses UTF-8 encoding, and the content is 153,912 characters long. Finally, the blank line at the end of the header tells the client that the server has finished sending header information, and the response body follows.</p>&#13;
&#13;
<p>HTTP is used in almost every application that interacts with the internet. For example, if you visit this same Wikipedia page in your web browser, the browser makes the same basic HTTP request as the one just shown. When it receives the response, it displays the body in your browser’s window, which looks like the screenshot in <a class="reference internal" data-type="xref" href="#fig-wiki-1500">Figure 14-3</a>.</p>&#13;
&#13;
<p>In practice<a contenteditable="false" data-primary="requests library" data-type="indexterm" id="id1551"/>, we do not write out full HTTP requests ourselves. Instead, we use tools like the <code>requests</code> Python library to construct requests for us. The following code constructs the HTTP request for the page in <a class="reference internal" data-type="xref" href="#fig-wiki-1500">Figure 14-3</a> for us. We simply pass the URL to <code>requests.get</code>. The “get” in the name indicates the <code>GET</code> method is being used:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">import</code></span><code> </code><span><code class="nn">requests</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">url_1500</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="s1">https://en.wikipedia.org/wiki/1500_metres_world_record_progression</code><code class="s1">'</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">resp_1500</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">requests</code></span><span><code class="o">.</code></span><span><code class="n">get</code></span><span><code class="p">(</code></span><span><code class="n">url_1500</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can check our request’s status to make sure the server completed it successfully:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">resp_1500</code></span><span><code class="o">.</code></span><span><code class="n">status_code</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
200&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can thoroughly examine the request and response through the object’s attributes. As an example, let’s take a look at the key-value pairs in the header in our request:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">for</code></span><code> </code><span><code class="n">key</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">resp_1500</code></span><span><code class="o">.</code></span><span><code class="n">request</code></span><span><code class="o">.</code></span><span><code class="n">headers</code></span><span><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="sa">f</code></span><span><code class="s1">'</code></span><span><code class="si">{</code></span><span><code class="n">key</code></span><span><code class="si">}</code></span><span><code class="s1">: </code></span><span><code class="si">{</code></span><span><code class="n">resp_1500</code></span><span><code class="o">.</code></span><span><code class="n">request</code></span><span><code class="o">.</code></span><span><code class="n">headers</code></span><span><code class="p">[</code></span><span><code class="n">key</code></span><span><code class="p">]</code></span><span><code class="si">}</code></span><span><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
User-Agent: python-requests/2.25.1&#13;
Accept-Encoding: gzip, deflate&#13;
Accept: */*&#13;
Connection: keep-alive&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Although we did not specify any header information in our function call, <code>request.get</code> provided some basic information for us. If we need to send special header information, we can specify them in our call.</p>&#13;
&#13;
<p>Now let’s examine the header of the response we received from the server:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="nb">len</code></span><span><code class="p">(</code></span><span><code class="n">resp_1500</code></span><span><code class="o">.</code></span><span><code class="n">headers</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
20&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>As we saw earlier, there’s a lot of header information in the response. We just display the <code>date</code>, <code>content-type</code>, and <code>content-length</code>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">keys</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">content-type</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">content-length</code><code class="s1">'</code></span><code> </code><span><code class="p">]</code></span><code>&#13;
</code><span><code class="k">for</code></span><code> </code><span><code class="n">key</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">keys</code></span><span><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="sa">f</code></span><span><code class="s1">'</code></span><span><code class="si">{</code></span><span><code class="n">key</code></span><span><code class="si">}</code></span><span><code class="s1">: </code></span><span><code class="si">{</code></span><span><code class="n">resp_1500</code></span><span><code class="o">.</code></span><span><code class="n">headers</code></span><span><code class="p">[</code></span><span><code class="n">key</code></span><span><code class="p">]</code></span><span><code class="si">}</code></span><span><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
date: Fri, 10 Mar 2023 01:54:13 GMT&#13;
content-type: text/html; charset=UTF-8&#13;
content-length: 23064&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Finally, we display the first several hundred characters of the response body (the entire content is too long to display nicely here):</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">resp_1500</code></span><span><code class="o">.</code></span><span><code class="n">text</code></span><span><code class="p">[</code><code class="p">:</code></span><span><code class="mi">600</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
'&lt;!DOCTYPE html&gt;\n&lt;html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-enabled vector-feature-sticky-header-disabled vector-feature-page-tools-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-enabled vector-feature-main-menu-pinned-disabled vector-feature-limited-width-enabled vector-feature-limited-width-content-enabled" lang="en" dir="ltr"&gt;\n&lt;head&gt;\n&lt;meta charset="UTF-8"/&gt;\n&lt;title&gt;1500 metres world record progression - Wikipedia&lt;/title&gt;\n&lt;script&gt;document.documentE'&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We confirm that the response is an HTML document and that it contains the title <code>1500 <span class="pre">metres</span> <span class="pre">world</span> <span class="pre">record</span> <span class="pre">progression</span> <span class="pre">-</span> <span class="pre">Wikipedia</span></code>. We have successfully retrieved the web page shown in <a class="reference internal" data-type="xref" href="#fig-wiki-1500">Figure 14-3</a>.</p>&#13;
&#13;
<p>Our HTTP request has been successful, and the server has returned a status code of <code>200</code>. There are hundreds of other HTTP status codes. Thankfully, they are grouped into categories to make them easier to remember (see <a class="reference internal" data-type="xref" href="#response-codes">Table 14-1</a>).</p>&#13;
&#13;
<table id="response-codes">&#13;
	<caption><span class="label">Table 14-1. </span><span>Response status codes</span></caption>&#13;
	<thead>&#13;
		<tr>&#13;
			<th class="head">Code</th>&#13;
			<th class="head">Type</th>&#13;
			<th class="head">Description</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td>100s</td>&#13;
			<td>&#13;
			<p>Informational</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>More input is expected from the client or server (100 Continue, 102 Processing, etc.).</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>200s</td>&#13;
			<td>&#13;
			<p>Success</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>The client’s request was successful (200 OK, 202 Accepted, etc.).</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>300s</td>&#13;
			<td>&#13;
			<p>The redirection</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>Requested URL is located elsewhere and may need further action from the user (300 Multiple Choices, 301 Moved Permanently, etc.).</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>400s</td>&#13;
			<td>&#13;
			<p>Client error</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>A client-side error occurred (400 Bad Request, 403 Forbidden, 404 Not Found, etc.).</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>500s</td>&#13;
			<td>&#13;
			<p>Server error</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>A server-side error occurred or the server is incapable of performing the request (500 Internal Server Error, 503 Service Unavailable, etc.).</p>&#13;
			</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<p>One common error code that might look familiar is 404, which tells us we have requested a resource that doesn’t exist. We send such a request here:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">url</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s2">"</code><code class="s2">https://www.youtube.com/404errorwow</code><code class="s2">"</code></span><code>&#13;
</code><span><code class="n">bad_loc</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">requests</code></span><span><code class="o">.</code></span><span><code class="n">get</code></span><span><code class="p">(</code></span><span><code class="n">url</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">bad_loc</code></span><span><code class="o">.</code></span><span><code class="n">status_code</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
404&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The request we made to retrieve the web page was a <code>GET</code> HTTP request. There are four main HTTP request types: <code>GET</code>, <code>POST</code>, <code>PUT</code>, and <code>DELETE</code>. The two most commonly used methods are <code>GET</code> and <code>POST</code>. We just used <code>GET</code> to retrieve the web page:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">resp_1500</code></span><span><code class="o">.</code></span><span><code class="n">request</code></span><span><code class="o">.</code></span><span><code class="n">method</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
'GET'&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The <code>POST</code> request is used to send specific information from the client to the server. In the next section, we use <code>POST</code> to retrieve data from Spotify<a contenteditable="false" data-primary="" data-startref="ix_de_http" data-type="indexterm" id="id1552"/><a contenteditable="false" data-primary="" data-startref="ix_http_ch14" data-type="indexterm" id="id1553"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="REST" data-type="sect1"><div class="sect1" id="rest">&#13;
<h1>REST</h1>&#13;
&#13;
<p>Web services<a contenteditable="false" data-primary="REST (REpresentational State Transfer)" data-type="indexterm" id="ix_rest_ch14"/><a contenteditable="false" data-primary="data exchange" data-secondary="REST" data-type="indexterm" id="ix_de_rest"/> are increasingly implementing the REST (REpresentational State Transfer) architecture for developers to access their data. These include social media platforms like Twitter and Instagram, music apps like Spotify, real estate apps like Zillow, scientific sources of data such as the Climate Data Store, government data at the World Bank, and many, many more. The basic idea behind REST is that every URL identifies a resource (data).</p>&#13;
&#13;
<p>REST is <em>stateless</em>, meaning that the server does not remember the client from one request to the next. This aspect of REST has a few advantages: the server and the client can understand any message received without seeing previous messages, code can be changed on either the client or server side without impacting the operation of the service, and access is scalable, fast, modular, and independent.</p>&#13;
&#13;
<p>In this section, we work through an example to retrieve data from Spotify.</p>&#13;
&#13;
<p>Our example follows <a class="reference external" href="https://oreil.ly/zI-5z">Steven Morse’s blog post</a>, where we use both <code>POST</code> and <code>GET</code> methods in a series of requests to retrieve data on songs by <a class="reference external" href="https://www.theclash.com">The Clash</a>.</p>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>In practice, we wouldn’t write <code>GET</code> and <code>POST</code> requests ourselves for Spotify. Instead<a contenteditable="false" data-primary="spotipy library" data-type="indexterm" id="id1554"/>, we’d use the <a class="reference external" href="https://oreil.ly/fPQX0"><code>spotipy</code></a> library, which has functions to interact with the <a class="reference external" href="https://oreil.ly/NH4ZO">Spotify web API</a>. That said, data scientists can often find themselves in the position of wanting to access data available via REST that doesn’t have a Python library available, so this section shows how to get data from a RESTful website like <span class="keep-together">Spotify</span>.</p>&#13;
</div>&#13;
&#13;
<p>Typically, a REST application provides documentation with examples on how to request its data. Spotify has extensive documentation geared to developers who want to build an app, but we can also access the service just to explore data. To do that, we need to register as a developer and get a client ID and secret. We then use these to identify us to Spotify in our HTTP requests.</p>&#13;
&#13;
<p>After we register, we can begin to request data. This process has two steps: authenticate and request resources.</p>&#13;
&#13;
<p>To authenticate, we issue a POST request, where we give the web service our client ID and secret. We provide these in the header of the request. In return, we receive a token from the server that authorizes us to make requests.</p>&#13;
&#13;
<p>We begin the process and authenticate:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">AUTH_URL</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="s1">https://accounts.spotify.com/api/token</code><code class="s1">'</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">import</code></span><code> </code><span><code class="nn">requests</code></span><code>&#13;
</code><span><code class="n">auth_response</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">requests</code></span><span><code class="o">.</code></span><span><code class="n">post</code></span><span><code class="p">(</code></span><span><code class="n">AUTH_URL</code></span><span><code class="p">,</code></span><code> </code><span><code class="p">{</code></span><code>&#13;
</code><code>    </code><span><code class="s1">'</code><code class="s1">grant_type</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="s1">'</code><code class="s1">client_credentials</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>    </code><span><code class="s1">'</code><code class="s1">client_id</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">CLIENT_ID</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>    </code><span><code class="s1">'</code><code class="s1">client_secret</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">CLIENT_SECRET</code></span><span><code class="p">,</code></span><code>&#13;
</code><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We provided our ID and secret in key-value pairs in the header of our POST request. We can check the status of our request to see if it was successful:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">auth_response</code></span><span><code class="o">.</code></span><span><code class="n">status_code</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
200&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now let’s check the type of content in the body of the response:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">auth_response</code></span><span><code class="o">.</code></span><span><code class="n">headers</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">content-type</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
'application/json'&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The body of the response contains the token that we need in the next step to get the data. Since this information is JSON-formatted, we can check the keys and retrieve the token:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">auth_response_data</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">auth_response</code></span><span><code class="o">.</code></span><span><code class="n">json</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">auth_response_data</code></span><span><code class="o">.</code></span><span><code class="n">keys</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
dict_keys(['access_token', 'token_type', 'expires_in'])&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">access_token</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">auth_response_data</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">access_token</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="n">token_type</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">auth_response_data</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">token_type</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Notice that we hid our ID and secret so that others reading this book can’t imitate us. This request won’t be successful without a valid ID and secret. For example, here we make up an ID and secret and try to authenticate:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">bad_ID</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="s1">0123456789</code><code class="s1">'</code></span><code>&#13;
</code><span><code class="n">bad_SECRET</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="s1">a1b2c3d4e5</code><code class="s1">'</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">auth_bad</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">requests</code></span><span><code class="o">.</code></span><span><code class="n">post</code></span><span><code class="p">(</code></span><span><code class="n">AUTH_URL</code></span><span><code class="p">,</code></span><code> </code><span><code class="p">{</code></span><code>&#13;
</code><code>    </code><span><code class="s1">'</code><code class="s1">grant_type</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="s1">'</code><code class="s1">client_credentials</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>    </code><span><code class="s1">'</code><code class="s1">client_id</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">bad_ID</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">client_secret</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">bad_SECRET</code></span><span><code class="p">,</code></span><code>&#13;
</code><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We check the status of this “bad” request:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">auth_bad</code></span><span><code class="o">.</code></span><span><code class="n">status_code</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
400&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>According to <a class="reference internal" data-type="xref" href="#response-codes">Table 14-1</a>, a code of 400 means that we issued a bad request. For one more example, Spotify shuts us down if we take too much time making requests. We ran into this issue a couple of times when writing this section and received the following code, telling us our token had expired:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>res_clash</span><span>.</span><span>status_code</span>&#13;
&#13;
<span>401</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now for the second step, let’s get some data.</p>&#13;
&#13;
<p>Requests for resources can be made via <code>GET</code> for Spotify. Other services may require POSTs. Requests must include the token we received from the web service when we authenticated, which we can use over and over. We pass the access token in the header of our <code>GET</code> request. We construct the name-value pairs as a dictionary:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">headers</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">{</code></span><span><code class="s2">"</code><code class="s2">Authorization</code><code class="s2">"</code></span><span><code class="p">:</code></span><code> </code><span><code class="sa">f</code></span><span><code class="s2">"</code></span><span><code class="si">{</code></span><span><code class="n">token_type</code></span><span><code class="si">}</code></span><span><code class="s2"> </code></span><span><code class="si">{</code></span><span><code class="n">access_token</code></span><span><code class="si">}</code></span><span><code class="s2">"</code></span><span><code class="p">}</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The developer API tells us that an artist’s albums are available at URLs that look like <em>https://api.spotify.com/v1/artists/3RGLhK1IP9jnYFH4BRFJBS/albums</em>, where the code between <em>artists/</em> and <em>/albums</em> is an artist’s ID. This particular code is for The Clash. Information about the tracks on an album is available at a URL that looks like <em>https://api.spotify.com/v1/albums/49kzgMsxHU5CTeb2XmFHjo/tracks</em>, where the identifier here is for the album.</p>&#13;
&#13;
<p>If we know the ID for an artist, we can retrieve the IDs for its albums, and in turn, we can get data about the tracks on the albums. Our first step was to get the ID for The Clash from Spotify’s site:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">artist_id</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="s1">3RGLhK1IP9jnYFH4BRFJBS</code><code class="s1">'</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Our first data request retrieves the group’s albums. We construct the URL using <code>artist_id</code> and pass our access token in the header:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">BASE_URL</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s2">"</code><code class="s2">https://api.spotify.com/v1/</code><code class="s2">"</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">res_clash</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">requests</code></span><span><code class="o">.</code></span><span><code class="n">get</code></span><span><code class="p">(</code></span><code>&#13;
</code><code>    </code><span><code class="n">BASE_URL</code></span><code> </code><span><code class="o">+</code></span><code> </code><span><code class="s2">"</code><code class="s2">artists/</code><code class="s2">"</code></span><code> </code><span><code class="o">+</code></span><code> </code><span><code class="n">artist_id</code></span><code> </code><span><code class="o">+</code></span><code> </code><span><code class="s2">"</code><code class="s2">/albums</code><code class="s2">"</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>    </code><span><code class="n">headers</code></span><span><code class="o">=</code></span><span><code class="n">headers</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>    </code><span><code class="n">params</code></span><span><code class="o">=</code></span><span><code class="p">{</code></span><span><code class="s2">"</code><code class="s2">include_groups</code><code class="s2">"</code></span><span><code class="p">:</code></span><code> </code><span><code class="s2">"</code><code class="s2">album</code><code class="s2">"</code></span><span><code class="p">}</code><code class="p">,</code></span><code>&#13;
</code><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">res_clash</code></span><span><code class="o">.</code></span><span><code class="n">status_code</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
200&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Our request was successful. Now let’s check the <code>content-type</code> of the response body:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">res_clash</code></span><span><code class="o">.</code></span><span><code class="n">headers</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">content-type</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
'application/json; charset=utf-8'&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The resource returned is JSON, so we can load it into a Python dictionary:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">clash_albums</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">res_clash</code></span><span><code class="o">.</code></span><span><code class="n">json</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p class="pagebreak-before less_space">After poking around a bit, we can find that album information is in the <code>items</code> element. The keys for the first album are:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">clash_albums</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">items</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">[</code></span><span><code class="mi">0</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">keys</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
dict_keys(['album_group', 'album_type', 'artists', 'available_markets', 'external_urls', 'href', 'id', 'images', 'name', 'release_date', 'release_date_precision', 'total_tracks', 'type', 'uri'])&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Let’s print the album IDs, names, and release dates for a few albums:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">for</code></span><code> </code><span><code class="n">album</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">clash_albums</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">items</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">[</code><code class="p">:</code></span><span><code class="mi">4</code></span><span><code class="p">]</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">ID: </code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">album</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1"> </code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">album</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">----</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">album</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">release_date</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
ID:  7nL9UERtRQCB5eWEQCINsh   Combat Rock + The People's Hall ---- 2022-05-20&#13;
ID:  3un5bLdxz0zKhiZXlmnxWE   Live At Shea Stadium ---- 2008-08-26&#13;
ID:  4dMWTj1OkiCKFN5yBMP1vS   Live at Shea Stadium (Remastered) ---- 2008&#13;
ID:  1Au9637RH9pXjBv5uS3JpQ   From Here To Eternity Live ---- 1999-10-04&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We see that some albums are remastered and others are live performances. Next, we cycle through the albums, pick up their IDs, and for each album we request information about the tracks:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">tracks</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code><code class="p">]</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="k">for</code></span><code> </code><span><code class="n">album</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">clash_albums</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">items</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">:</code></span><code> </code><code>&#13;
</code><code>    </code><span><code class="n">tracks_url</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="sa">f</code></span><span><code class="s2">"</code></span><span><code class="si">{</code></span><span><code class="n">BASE_URL</code></span><span><code class="si">}</code></span><span><code class="s2">albums/</code></span><span><code class="si">{</code></span><span><code class="n">album</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="si">}</code></span><span><code class="s2">/tracks</code><code class="s2">"</code></span><code>&#13;
</code><code>    </code><span><code class="n">res_tracks</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">requests</code></span><span><code class="o">.</code></span><span><code class="n">get</code></span><span><code class="p">(</code></span><span><code class="n">tracks_url</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">headers</code></span><span><code class="o">=</code></span><span><code class="n">headers</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="n">album_tracks</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">res_tracks</code></span><span><code class="o">.</code></span><span><code class="n">json</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">items</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>    </code><code>&#13;
</code><code>    </code><span><code class="k">for</code></span><code> </code><span><code class="n">track</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">album_tracks</code></span><span><code class="p">:</code></span><code>&#13;
</code><code>        </code><span><code class="n">features_url</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="sa">f</code></span><span><code class="s2">"</code></span><span><code class="si">{</code></span><span><code class="n">BASE_URL</code></span><span><code class="si">}</code></span><span><code class="s2">audio-features/</code></span><span><code class="si">{</code></span><span><code class="n">track</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="si">}</code></span><span><code class="s2">"</code></span><code>&#13;
</code><code>        </code><span><code class="n">res_feat</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">requests</code></span><span><code class="o">.</code></span><span><code class="n">get</code></span><span><code class="p">(</code></span><span><code class="n">features_url</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">headers</code></span><span><code class="o">=</code></span><span><code class="n">headers</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>        </code><span><code class="n">features</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">res_feat</code></span><span><code class="o">.</code></span><span><code class="n">json</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code>        </code><code>&#13;
</code><code>        </code><span><code class="n">features</code></span><span><code class="o">.</code></span><span><code class="n">update</code></span><span><code class="p">(</code><code class="p">{</code></span><code>&#13;
</code><code>            </code><span><code class="s1">'</code><code class="s1">track_name</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">track</code></span><span><code class="o">.</code></span><span><code class="n">get</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">,</code></span><code>&#13;
</code><code>            </code><span><code class="s1">'</code><code class="s1">album_name</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">album</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code>&#13;
</code><code>            </code><span><code class="s1">'</code><code class="s1">release_date</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">album</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">release_date</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code>&#13;
</code><code>            </code><span><code class="s1">'</code><code class="s1">album_id</code><code class="s1">'</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">album</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>        </code><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code><code>        </code><code>&#13;
</code><code>        </code><span><code class="n">tracks</code></span><span><code class="o">.</code></span><span><code class="n">append</code></span><span><code class="p">(</code></span><span><code class="n">features</code></span><span><code class="p">)</code></span><code> </code><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Over a dozen features are available to explore on the tracks. Let’s close the example with a plot of danceability and loudness of The Clash songs:</p>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_14in03.png"/>&#13;
&#13;
</div></figure>&#13;
&#13;
<p>This section covered REST APIs, which provide standardized approaches for programs to download data. The example shown here downloaded JSON data. At other times, the data from a REST request may be in an XML format. And sometimes a REST API isn’t available for the data we want, and we must extract the data from web pages themselves in HTML, a format similar to XML. We describe how to work with these formats next<a contenteditable="false" data-primary="" data-startref="ix_de_rest" data-type="indexterm" id="id1555"/><a contenteditable="false" data-primary="" data-startref="ix_rest_ch14" data-type="indexterm" id="id1556"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="XML, HTML, and XPath" data-type="sect1"><div class="sect1" id="xml-html-and-xpath">&#13;
<h1>XML, HTML, and XPath</h1>&#13;
&#13;
<p>The eXtensible Markup Language (XML ) can represent<a contenteditable="false" data-primary="eXtensible Markup Language (XML)" data-type="indexterm" id="ix_extens_markup_xml"/><a contenteditable="false" data-primary="XML (eXtensible Markup Language)" data-type="indexterm" id="ix_xml_ch14"/><a contenteditable="false" data-primary="data exchange" data-secondary="XML" data-type="indexterm" id="ix_de_xml"/> all types of information, such as data sent to and from web services, including web pages, spreadsheets, visual displays like SVG, social network structures, word processing documents like Microsoft’s docx, databases, and much more. For a data scientist, knowing a little about XML can come in handy.</p>&#13;
&#13;
<p>Despite its name, XML is not a language. Rather, it is a very general structure we can use to define formats to represent and organize data. XML provides a basic structure and syntax for these “dialects” or vocabularies. If you read or compose<a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-type="indexterm" id="id1557"/><a contenteditable="false" data-primary="data exchange" data-secondary="HTML" data-type="indexterm" id="id1558"/> HTML, you will recognize the format of XML.</p>&#13;
&#13;
<p>The basic unit in XML is the <em>element</em>, which is also referred to as a <em>node</em>. An element has a name and may have attributes, child elements, and text.</p> &#13;
&#13;
<p>The following annotated snippet of an XML plant catalog provides an example of these pieces (this content is adapted from <a class="reference external" href="https://oreil.ly/qPa6s">W3Schools</a>):</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
&lt;catalog&gt;                                The topmost node, aka root node.&#13;
    &lt;plant&gt;                              The first child of the root node.&#13;
        &lt;common&gt;Bloodroot&lt;/common&gt;       common is the first child of plant.&#13;
        &lt;botanical&gt;Sanguinaria canadensis&lt;/botanical&gt;&#13;
        &lt;zone&gt;4&lt;/zone&gt;                   This zone node has text content: 4.&#13;
        &lt;light&gt;Mostly Shady&lt;/light&gt;&#13;
        &lt;price curr="USD"&gt;$2.44&lt;/price&gt;  This node has an attribute.&#13;
        &lt;availability date="0399"/&gt;      Empty nodes can be collapsed.&#13;
    &lt;/plant&gt;                             Nodes must be closed. &#13;
    &lt;plant&gt;                              The two plant nodes are siblings.&#13;
        &lt;common&gt;Columbine&lt;/common&gt;&#13;
        &lt;botanical&gt;Aquilegia canadensis&lt;/botanical&gt;&#13;
        &lt;zone&gt;3&lt;/zone&gt;&#13;
        &lt;light&gt;Mostly Shady&lt;/light&gt;&#13;
        &lt;price curr="CAD"&gt;$9.37&lt;/price&gt;&#13;
        &lt;availability date="0199"/&gt;&#13;
    &lt;/plant&gt;&#13;
&lt;/catalog&gt;&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We added the indentation to this snippet of XML to make it easier to see the structure. It is not needed in the actual file.</p>&#13;
&#13;
<p>XML documents are plain-text files with the following syntax rules:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Each element begins with a start tag, like <code>&lt;plant&gt;</code>, and closes with an end tag of the same name, like <code>&lt;/plant&gt;</code>.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>XML elements can contain other XML elements.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>XML elements can be plain-text, like “Columbine” in <code>&lt;common&gt;Columbine&lt;/common&gt;</code>.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>XML elements can have optional attributes. The element <code>&lt;price curr=“CAD”&gt;</code> has an attribute <code>curr</code> with value <code>"CAD"</code>.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>In the special case when a node has no children, the end tag can be folded into the start tag. An example is <code>&lt;availability date="0199"/&gt;</code>.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>We call an XML document well formed when it follows certain rules. The most important of these are:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>One root node contains all of the other elements in the document.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Elements nest properly; an open node closes around all of its children and no more.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Tag names are case-sensitive.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Attribute values have a <code>name=“value”</code> format with single or double quotes.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>There are additional rules for a document to be well formed. These relate to whitespace, special characters, naming conventions, and repeated attributes.</p>&#13;
&#13;
<p>The hierarchical nature of well-formed XML means it can be represented as a tree. <a class="reference internal" data-type="xref" href="#fig-xml-tree">Figure 14-4</a> shows a tree representation of the plant catalog XML.</p>&#13;
&#13;
<figure><div class="figure" id="fig-xml-tree"><img src="assets/leds_1404.png"/>&#13;
<h6><span class="label">Figure 14-4. </span>Hierarchy of an XML document; the lighter gray boxes represent text elements and, by design, these cannot have child nodes</h6>&#13;
</div></figure>&#13;
&#13;
<p>Like with JSON, an XML document is plaintext. We can read it with a plain-text viewer, and it’s easy for machines to read and create XML content. The extensible nature of XML allows content to be easily merged into higher-level container documents and easily exchanged with other applications. XML also supports binary data and arbitrary character sets<a contenteditable="false" data-primary="" data-startref="ix_extens_markup_xml" data-type="indexterm" id="id1559"/><a contenteditable="false" data-primary="" data-startref="ix_xml_ch14" data-type="indexterm" id="id1560"/><a contenteditable="false" data-primary="" data-startref="ix_de_xml" data-type="indexterm" id="id1561"/>.</p>&#13;
&#13;
<p>As mentioned already, HTML<a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-type="indexterm" id="id1562"/><a contenteditable="false" data-primary="data exchange" data-secondary="HTML" data-type="indexterm" id="id1563"/> looks a lot like XML. That’s no accident, and indeed, XHTML is a subset of HTML that follows the rules of well-formed XML. Let’s return to our earlier example of the Wikipedia page that we retrieved from the internet and show how to used XML tools to create a dataframe from the contents of one of its tables.</p>&#13;
&#13;
<section data-pdf-bookmark="Example: Scraping Race Times from Wikipedia" data-type="sect2"><div class="sect2" id="example-scraping-race-times-from-wikipedia">&#13;
<h2>Example: Scraping Race Times from Wikipedia</h2>&#13;
&#13;
<p>Earlier<a contenteditable="false" data-primary="race times, scraping from Wikipedia, example" data-type="indexterm" id="ix_race_wiki"/><a contenteditable="false" data-primary="data exchange" data-secondary="race times, scraping from Wikipedia" data-type="indexterm" id="ix_de_race"/> in this chapter, we used an HTTP request to retrieve the HTML page from Wikipedia shown in <a class="reference internal" data-type="xref" href="#fig-wiki-1500">Figure 14-3</a>. The contents of this page are in HTML, which is essentially an XML vocabulary. We can use the hierarchical structure of the page and XML tools to access data in one of the tables and wrangle it into a dataframe. In particular, we are interested in the second table in the page, a portion of which appears in the screenshot in <a class="reference internal" data-type="xref" href="#fig-html-table">Figure 14-5</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig-html-table"><img src="assets/leds_1405.png"/>&#13;
<h6><span class="label">Figure 14-5. </span>Screenshot of the second table in a web page that contains the data we want to extract</h6>&#13;
</div></figure>&#13;
&#13;
<p>Before we work on this table, we provide a quick summary of the format for a basic HTML table. Here is the HTML for a table with a header and two rows of three <span class="keep-together">columns</span>:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>&lt;</span><span>table</span><span>&gt;</span>&#13;
 <span>&lt;</span><span>tbody</span><span>&gt;</span>&#13;
  <span>&lt;</span><span>tr</span><span>&gt;</span>&#13;
   <span>&lt;</span><span>th</span><span>&gt;</span><span>A</span><span>&lt;/</span><span>th</span><span>&gt;&lt;</span><span>th</span><span>&gt;</span><span>B</span><span>&lt;/</span><span>th</span><span>&gt;&lt;</span><span>th</span><span>&gt;</span><span>C</span><span>&lt;/</span><span>th</span><span>&gt;</span> &#13;
  <span>&lt;/</span><span>tr</span><span>&gt;</span>&#13;
  <span>&lt;</span><span>tr</span><span>&gt;</span>&#13;
   <span>&lt;</span><span>td</span><span>&gt;</span><span>1</span><span>&lt;/</span><span>td</span><span>&gt;&lt;</span><span>td</span><span>&gt;</span><span>2</span><span>&lt;/</span><span>td</span><span>&gt;&lt;</span><span>td</span><span>&gt;</span><span>3</span><span>&lt;/</span><span>td</span><span>&gt;</span>&#13;
  <span>&lt;/</span><span>tr</span><span>&gt;</span>&#13;
  <span>&lt;</span><span>tr</span><span>&gt;</span>&#13;
   <span>&lt;</span><span>td</span><span>&gt;</span><span>5</span><span>&lt;/</span><span>td</span><span>&gt;&lt;</span><span>td</span><span>&gt;</span><span>6</span><span>&lt;/</span><span>td</span><span>&gt;&lt;</span><span>td</span><span>&gt;</span><span>7</span><span>&lt;/</span><span>td</span><span>&gt;</span>&#13;
  <span>&lt;/</span><span>tr</span><span>&gt;</span>&#13;
 <span>&lt;/</span><span>tbody</span><span>&gt;</span>&#13;
<span>&lt;/</span><span>table</span><span>&gt;</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Notice how the table is laid out in rows with <code>&lt;tr&gt;</code> elements, <span>and</span> <span>each</span> <span>cell</span> <span>in</span> <span>a</span> <span>row</span> <span>is</span> <span>a</span> <code>&lt;td&gt;</code> element that contains the text to be displayed in the table.</p>&#13;
&#13;
<p>Our first task is to create a tree structure from the content of the web page. To do this, we use the <code>lxml</code> library, which provides access to the C-library <code>libxml2</code> for handling XML content. Recall that <code>resp_1500</code> contains the response from our request, and the page is in the body of the response. We can parse the web page into a hierarchical structure with <code>fromstring</code> in the <code>lxml.html</code> module:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">from</code></span><code> </code><span><code class="nn">lxml</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">html</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">tree_1500</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">html</code></span><span><code class="o">.</code></span><span><code class="n">fromstring</code></span><span><code class="p">(</code></span><span><code class="n">resp_1500</code></span><span><code class="o">.</code></span><span><code class="n">content</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="nb">type</code></span><span><code class="p">(</code></span><span><code class="n">tree_1500</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
lxml.html.HtmlElement&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Now we can work with the document using its tree structure. We can find all the tables in the HTML document with the following search:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">tables</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">tree_1500</code></span><span><code class="o">.</code></span><span><code class="n">xpath</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">//table</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="nb">type</code></span><span><code class="p">(</code></span><span><code class="n">tables</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
list&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="nb">len</code></span><span><code class="p">(</code></span><span><code class="n">tables</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
7&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>This search uses the XPath <code>//table</code> expression, which we soon describe, to search for all table nodes anywhere in the document.</p>&#13;
&#13;
<p>We found six tables in the document. If we examine the web page, including looking at its HTML source via the browser, we can figure out that the second table in the document contains the IAF-era times. This is the table we want. The screenshot in <a class="reference internal" data-type="xref" href="#fig-html-table">Figure 14-5</a> shows that the first column contains the race times, the third holds names, and the fourth has the dates of the races. We can extract each of these pieces of information in turn. We do this with the following XPath expressions:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">times</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">tree_1500</code></span><span><code class="o">.</code></span><span><code class="n">xpath</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">//table[3]/tbody/tr/td[1]/b/text()</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">names</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">tree_1500</code></span><span><code class="o">.</code></span><span><code class="n">xpath</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">//table[3]/tbody/tr/td[3]/a/text()</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">dates</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">tree_1500</code></span><span><code class="o">.</code></span><span><code class="n">xpath</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">//table[3]/tbody/tr/td[4]/text()</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="nb">type</code></span><span><code class="p">(</code></span><span><code class="n">times</code></span><span><code class="p">[</code></span><span><code class="mi">0</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
lxml.etree._ElementUnicodeResult&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>These return values behave like a list, but each value is an element of the tree. We can convert them to strings:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">date_str</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="nb">str</code></span><span><code class="p">(</code></span><span><code class="n">s</code></span><span><code class="p">)</code></span><code> </code><span><code class="k">for</code></span><code> </code><span><code class="n">s</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">dates</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="n">name_str</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="nb">str</code></span><span><code class="p">(</code></span><span><code class="n">s</code></span><span><code class="p">)</code></span><code> </code><span><code class="k">for</code></span><code> </code><span><code class="n">s</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">names</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>For the times, we want to transform them into seconds. The function <code>get_sec</code> does this conversion. And we want to extract the race year from the date string:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">get_sec</code></span><span><code class="p">(</code></span><span><code class="n">time</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="sd">"""convert time into seconds."""</code></span><code>&#13;
</code><code>    </code><span><code class="n">time</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="nb">str</code></span><span><code class="p">(</code></span><span><code class="n">time</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="n">time</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">time</code></span><span><code class="o">.</code></span><span><code class="n">replace</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2">+</code><code class="s2">"</code></span><span><code class="p">,</code></span><span><code class="s2">"</code><code class="s2">"</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="n">m</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">s</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">time</code></span><span><code class="o">.</code></span><span><code class="n">split</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">:</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="k">return</code></span><code> </code><span><code class="nb">float</code></span><span><code class="p">(</code></span><span><code class="n">m</code></span><span><code class="p">)</code></span><code> </code><span><code class="o">*</code></span><code> </code><span><code class="mi">60</code></span><code> </code><span><code class="o">+</code></span><code> </code><span><code class="nb">float</code></span><span><code class="p">(</code></span><span><code class="n">s</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">time_sec</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="n">get_sec</code></span><span><code class="p">(</code></span><span><code class="n">rt</code></span><span><code class="p">)</code></span><code> </code><span><code class="k">for</code></span><code> </code><span><code class="n">rt</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">times</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="n">race_year</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">to_datetime</code></span><span><code class="p">(</code></span><span><code class="n">date_str</code></span><span><code class="p">,</code></span><code> </code><span><code class="nb">format</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="si">%Y</code><code class="s1">-</code><code class="si">%m</code><code class="s1">-</code></span><span><code class="si">%d</code></span><span><code class="se">\n</code></span><span><code class="s1">'</code></span><span><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">year</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can create a dataframe and make a plot to show the progress in race times over the years:</p>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_14in04.png"/>&#13;
&#13;
</div></figure>&#13;
&#13;
<p>As you may have noticed, extracting data from an HTML page relies on careful examination of the source to find where in the document the numbers that we’re after are. We relied heavily on the XPath tool to do the extraction. Its elegant language is quite powerful. We introduce it next<a contenteditable="false" data-primary="" data-startref="ix_de_race" data-type="indexterm" id="id1564"/><a contenteditable="false" data-primary="" data-startref="ix_race_wiki" data-type="indexterm" id="id1565"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="XPath" data-type="sect2"><div class="sect2" id="xpath">&#13;
<h2>XPath</h2>&#13;
&#13;
<p>When<a contenteditable="false" data-primary="filtering data" data-secondary="with XPath" data-secondary-sortas="XPath" data-type="indexterm" id="ix_filter_data_xpath"/><a contenteditable="false" data-primary="data exchange" data-secondary="XPath expressions" data-type="indexterm" id="ix_de_xpath"/><a contenteditable="false" data-primary="XPath expressions" data-type="indexterm" id="ix_xpath_ch14"/> we work with XML documents, we typically want to extract data from them and bring it into a dataframe. XPath can help here. XPath can recursively traverse an XML tree to find elements. For example, we used the expression <code>//table</code> in the previous example to locate all table nodes in our web page.</p>&#13;
&#13;
<p>XPath expressions operate on the hierarchy of well-formed XML. They are succinct and similar in format to the way files are located in a hierarchy of directories in a computer filesystem. But they’re much more powerful. XPath is also similar to regular expressions in that we specify patterns to match content. Like with regular expressions, it takes experience to compose correct XPath expressions.</p>&#13;
&#13;
<p>An XPath expression<a contenteditable="false" data-primary="node set" data-type="indexterm" id="id1566"/> forms logical steps to identify and filter nodes in a tree. The result is a <em>node set</em> where each node occurs at most once. The node set also has an order that matches the order in which the nodes occur in the source; this can be quite handy.</p>&#13;
&#13;
<p>Each XPath expression is made up of one or more <em>location steps</em>, separated by a “/”. Each location step has three parts—the <em>axis</em>, <em>node test</em>, and optional <em>predicate</em>:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>The axis specifies the direction to look in, such as down, up, or across the tree. We exclusively use shortcuts for the axis. The default is to look down one step at children in the tree. <code>//</code> says to look down the tree as far as possible, and <code>..</code> indicates one step up to the parent.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>The node test identifies the name or the type of node to look for. This is typically just a tag name or <code>text()</code> for text elements.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>A predicate acts like a filter to further restrict the node set. This is given in square brackets, like <code>[2]</code>, which keeps the second node in the node set, and <code>[ <span class="pre">@date</span> <span class="pre">]</span></code>, which keeps all nodes with a date attribute.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>We can tack together location steps to create powerful search instructions. <a class="reference internal" data-type="xref" href="#xpath-examples">Table 14-2</a> provides some examples that cover the most common expressions. Refer back to the tree in <a class="reference internal" data-type="xref" href="#fig-xml-tree">Figure 14-4</a> to follow along.</p>&#13;
&#13;
<table id="xpath-examples">&#13;
	<caption><span class="label">Table 14-2. </span><span>XPath examples</span></caption>&#13;
	<thead>&#13;
		<tr>&#13;
			<th class="head">Expression</th>&#13;
			<th class="head">Result</th>&#13;
			<th class="head">Description</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td>‘//common’</td>&#13;
			<td>&#13;
			<p>Two nodes</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>Look down the tree for any common nodes.</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>‘/catalog/plant/common’</td>&#13;
			<td>&#13;
			<p>Two nodes</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>Travel the specific path from the root node <em>catalog</em> to all plant nodes to all common nodes within the plant nodes.</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>‘//common/text()’</td>&#13;
			<td>&#13;
			<p>Bloodroot, Columbine</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>Locate the text content of all common nodes.</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>‘//plant[2]/price/text()’</td>&#13;
			<td>&#13;
			<p>$9.37</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>Locate plant nodes anywhere in the tree, then filter to take only the second. From this plant node, travel to its price child and locate its text.</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>‘//@date’</td>&#13;
			<td>&#13;
			<p>0399, 0199</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>Locate the attribute value of any attribute named “date” in the tree.</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>‘//price[@curr=“CAD”]/text()’</td>&#13;
			<td>&#13;
			<p>$9.37</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>The text content of any price node that has a currency attribute value of “CAD.”</p>&#13;
			</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<p>You can try out the XPath expressions in the table with the catalog file. We load the file into Python using the <code>etree</code> module. The <code>parse</code> method reads the file into an element tree:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">from</code></span><code> </code><span><code class="nn">lxml</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">etree</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">catalog</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">etree</code></span><span><code class="o">.</code></span><span><code class="n">parse</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/catalog.xml</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The <code>lxml</code> library gives us access to XPath. Let’s try it out.</p>&#13;
&#13;
<p>This simple XPath expression locates all text content of any <code>&lt;light&gt;</code> node in the tree:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">catalog</code></span><span><code class="o">.</code></span><span><code class="n">xpath</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">//light/text()</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
['Mostly Shady', 'Mostly Shady']&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Notice that two elements are returned. Although the text content is identical, we have two <code>&lt;light&gt;</code> nodes in our tree and so are given the text content of each. The following expression is a bit more challenging:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">catalog</code></span><span><code class="o">.</code></span><span><code class="n">xpath</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">//price[@curr=</code><code class="s1">"</code><code class="s1">CAD</code><code class="s1">"</code><code class="s1">]/../common/text()</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
['Columbine']&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The expression locates all <code>&lt;price&gt;</code> nodes in the tree, then filters them according to whether their <code>curr</code> attribute is <code>CAD</code>. Then, for the remaining nodes (there’s only one in this case), travel up one step in the tree to the parent node and then back down to any child “common” nodes and on to their text content<a contenteditable="false" data-primary="" data-startref="ix_xpath_ch14" data-type="indexterm" id="id1567"/><a contenteditable="false" data-primary="" data-startref="ix_de_xpath" data-type="indexterm" id="id1568"/><a contenteditable="false" data-primary="" data-startref="ix_filter_data_xpath" data-type="indexterm" id="id1569"/>. Quite the trip!</p>&#13;
&#13;
<p>Next, we provide an example that uses an HTTP request to retrieve XML-formatted data, and XPath to wrangle the content into a dataframe.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Example: Accessing Exchange Rates from the ECB" data-type="sect2"><div class="sect2" id="example-accessing-exchange-rates-from-the-ecb">&#13;
<h2>Example: Accessing Exchange Rates from the ECB</h2>&#13;
&#13;
<p>The European Central Bank (ECB) makes exchange<a contenteditable="false" data-primary="exchange rates, accessing from ECB, example" data-type="indexterm" id="ix_ex_rate_example"/><a contenteditable="false" data-primary="data exchange" data-secondary="exchange rate example" data-type="indexterm" id="ix_de_ex_rate"/> rates available online in XML format. Let’s begin by getting the most recent exchange rates from the ECB with an HTTP request:</p>&#13;
&#13;
<div class="cell tag_student docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">url_base</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="s1">https://www.ecb.europa.eu/stats/eurofxref/</code><code class="s1">'</code></span><code>&#13;
</code><span><code class="n">url2</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="s1">eurofxref-hist-90d.xml?d574942462c9e687c3235ce020466aae</code><code class="s1">'</code></span><code>&#13;
</code><span><code class="n">resECB</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">requests</code></span><span><code class="o">.</code></span><span><code class="n">get</code></span><span><code class="p">(</code></span><span><code class="n">url_base</code></span><span><code class="o">+</code></span><span><code class="n">url2</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">resECB</code></span><span><code class="o">.</code></span><span><code class="n">status_code</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
200&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Again, we can use the <code>lxml</code> library to parse the text document we received from the ECB, but this time the contents are in a string returned from the ECB, not in a file:</p>&#13;
&#13;
<div class="cell tag_solution docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">ecb_tree</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">etree</code></span><span><code class="o">.</code></span><span><code class="n">fromstring</code></span><span><code class="p">(</code></span><span><code class="n">resECB</code></span><span><code class="o">.</code></span><span><code class="n">content</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>In order to extract the data we want, we need to know how it is organized. Here is a snippet of the content:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>&lt;</span><span>gesmes</span><span>:</span><span>Envelope</span> <span>xmlns</span><span>:</span><span>gesmes</span><span>=</span><span>"http://www.gesmes.org/xml/2002-08-01"</span>&#13;
        <span>xmlns</span><span>=</span><span>"http://www.ecb.int/vocabulary/2002-08-01/eurofxref"</span><span>&gt;</span>&#13;
<span>&lt;</span><span>gesmes</span><span>:</span><span>subject</span><span>&gt;</span><span>Reference</span> <span>rates</span><span>&lt;/</span><span>gesmes</span><span>:</span><span>subject</span><span>&gt;</span>&#13;
<span>&lt;</span><span>gesmes</span><span>:</span><span>Sender</span><span>&gt;</span>&#13;
<span>&lt;</span><span>gesmes</span><span>:</span><span>name</span><span>&gt;</span><span>European</span> <span>Central</span> <span>Bank</span><span>&lt;/</span><span>gesmes</span><span>:</span><span>name</span><span>&gt;</span>&#13;
<span>&lt;/</span><span>gesmes</span><span>:</span><span>Sender</span><span>&gt;</span>&#13;
<span>&lt;</span><span>Cube</span><span>&gt;</span>&#13;
<span>&lt;</span><span>Cube</span> <span>time</span><span>=</span><span>"2023-02-24"</span><span>&gt;</span>&#13;
<span>&lt;</span><span>Cube</span> <span>currency</span><span>=</span><span>"USD"</span> <span>rate</span><span>=</span><span>"1.057"</span><span>/&gt;</span>&#13;
<span>&lt;</span><span>Cube</span> <span>currency</span><span>=</span><span>"JPY"</span> <span>rate</span><span>=</span><span>"143.55"</span><span>/&gt;</span>&#13;
<span>&lt;</span><span>Cube</span> <span>currency</span><span>=</span><span>"BGN"</span> <span>rate</span><span>=</span><span>"1.9558"</span><span>/&gt;</span>&#13;
<span>&lt;/</span><span>Cube</span><span>&gt;</span>&#13;
<span>&lt;</span><span>Cube</span> <span>time</span><span>=</span><span>"2023-02-23"</span><span>&gt;</span>&#13;
<span>&lt;</span><span>Cube</span> <span>currency</span><span>=</span><span>"USD"</span> <span>rate</span><span>=</span><span>"1.0616"</span><span>/&gt;</span>&#13;
<span>&lt;</span><span>Cube</span> <span>currency</span><span>=</span><span>"JPY"</span> <span>rate</span><span>=</span><span>"143.32"</span><span>/&gt;</span>&#13;
<span>&lt;</span><span>Cube</span> <span>currency</span><span>=</span><span>"BGN"</span> <span>rate</span><span>=</span><span>"1.9558"</span><span>/&gt;</span>&#13;
<span>&lt;/</span><span>Cube</span><span>&gt;</span>&#13;
<span>&lt;/</span><span>Cube</span><span>&gt;</span>&#13;
<span>&lt;/</span><span>gesmes</span><span>:</span><span>Envelope</span><span>&gt;</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>This document<a contenteditable="false" data-primary="times and dates" data-secondary="gesmes vocabulary in time-series exchange" data-type="indexterm" id="id1570"/> appears quite different in structure from the plant catalog. The snippet shows three levels of tags, all with the same name, and none have text content. <span class="keep-together">All of</span> the relevant information is contained in attribute values. Other new features are the <code>xmlns</code> in the root <code>&lt;Envelope&gt;</code> node, and the odd tag names, like <code>gesmes:​Enve⁠lope</code>. These have to do with namespaces.</p>&#13;
&#13;
<p>XML allows content creators to use their own vocabularies, called <em>namespaces</em>. The namespace gives the rules for a vocabulary, such as allowable tag names and attribute names, and restrictions on how nodes can be nested. And XML documents can merge vocabularies from different applications. To keep it all straight, information about the namespace(s) is provided in the document.</p>&#13;
&#13;
<p>The root node in the ECB file is <code>&lt;Envelope&gt;</code>. The additional “gesmes:” in the tag name indicates that the tags belong to the gesmes vocabulary, which is an international standard for the exchange of time-series information. Another namespace is also in <code>&lt;Envelope&gt;</code>. It is the default namespace for the file because it doesn’t have a prefix, like “<code>gesmes:</code>”. Whenever a namespace is not provided in a tag name, the default is assumed.</p>&#13;
&#13;
<p>The upshot of this is that we need to take into account these namespaces when we search for nodes. Let’s see how this works when we extract the dates. From the snippet, we see that the dates reside in “time” attributes. These <code>&lt;Cube&gt;</code>s are children of the top <code>&lt;Cube&gt;</code>. We can give a very specific XPath expression to step from the root to its <code>&lt;Cube&gt;</code> child node and on to the next level of <code>&lt;Cube&gt;</code> nodes:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">namespaceURI</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="s1">http://www.ecb.int/vocabulary/2002-08-01/eurofxref</code><code class="s1">'</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">date</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">ecb_tree</code></span><span><code class="o">.</code></span><span><code class="n">xpath</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">./x:Cube/x:Cube/@time</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">namespaces</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">x</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="n">namespaceURI</code></span><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code><span><code class="n">date</code></span><span><code class="p">[</code><code class="p">:</code></span><span><code class="mi">5</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
['2023-07-18', '2023-07-17', '2023-07-14', '2023-07-13', '2023-07-12']&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The <code>.</code> in the expression is a shortcut to signify “from here,” and since we’re at the top of the tree, it’s equivalent to “from the root.” We specified the namespace in our expression as “<code>x:</code>”. Even though the<code> &lt;Cube&gt;</code> nodes are using the default namespace, we must specify it in our XPath expression. Fortunately, we can simply pass in the namespace as a parameter with our own label (“x” in this case) to keep our tag names short.</p>&#13;
&#13;
<p>Like with the HTML table, we can convert the date values into strings and from strings into timestamps:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">date_str</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="nb">str</code></span><span><code class="p">(</code></span><span><code class="n">s</code></span><span><code class="p">)</code></span><code> </code><span><code class="k">for</code></span><code> </code><span><code class="n">s</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">date</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="n">timestamps</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">to_datetime</code></span><span><code class="p">(</code></span><span><code class="n">date_str</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">xrates</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">DataFrame</code></span><span><code class="p">(</code><code class="p">{</code></span><span><code class="s2">"</code><code class="s2">date</code><code class="s2">"</code></span><span><code class="p">:</code></span><span><code class="n">timestamps</code></span><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>As for the exchange rates, they also appear in <code>&lt;Cube&gt;</code> nodes, but these have a “rate” attribute. For example, we can access all exchange rates for the British pound with the following XPath expression (we’re ignoring the namespace for the moment):</p>&#13;
&#13;
<p><code>//Cube[@currency <span class="pre">=</span> <span class="pre">"GBP"]/@rate</span></code></p>&#13;
&#13;
<p>This expression says look for all <code>&lt;Cube&gt;</code> nodes anywhere in the document, filter them according to whether the node has a currency attribute value of “GBP,” and return their rate attribute values.</p>&#13;
&#13;
<p>Since we want to extract exchange rates for multiple currencies, we generalize this XPath expression. We also want to convert the exchange rates to a numeric storage type, and make them relative to the first day’s rate so that the different currencies are on the same scale, which makes them more amenable for plots:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">currs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">GBP</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">USD</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">CAD</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="k">for</code></span><code> </code><span><code class="n">ctry</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">currs</code></span><span><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">expr</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code><code class="s1">.//x:Cube[@currency = </code><code class="s1">"</code><code class="s1">'</code></span><code> </code><span><code class="o">+</code></span><code> </code><span><code class="n">ctry</code></span><code> </code><span><code class="o">+</code></span><code> </code><span><code class="s1">'</code><code class="s1">"</code><code class="s1">]/@rate</code><code class="s1">'</code></span><code>&#13;
</code><code>    </code><span><code class="n">rates</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">ecb_tree</code></span><span><code class="o">.</code></span><span><code class="n">xpath</code></span><span><code class="p">(</code></span><span><code class="n">expr</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">namespaces</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">{</code></span><span><code class="s1">'</code><code class="s1">x</code><code class="s1">'</code></span><span><code class="p">:</code></span><span><code class="n">namespaceURI</code></span><span><code class="p">}</code><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="n">rates_num</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="nb">float</code></span><span><code class="p">(</code></span><span><code class="n">rate</code></span><span><code class="p">)</code></span><code> </code><span><code class="k">for</code></span><code> </code><span><code class="n">rate</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">rates</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>    </code><span><code class="n">first</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">rates_num</code></span><span><code class="p">[</code></span><span><code class="nb">len</code></span><span><code class="p">(</code></span><span><code class="n">rates_num</code></span><span><code class="p">)</code></span><span><code class="o">-</code></span><span><code class="mi">1</code></span><span><code class="p">]</code></span><code>&#13;
</code><code>    </code><span><code class="n">xrates</code></span><span><code class="p">[</code></span><span><code class="n">ctry</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="n">rate</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="n">first</code></span><code> </code><span><code class="k">for</code></span><code> </code><span><code class="n">rate</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">rates_num</code></span><span><code class="p">]</code></span><code>  </code><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We wrap up this example with line plots of the exchange rates:</p>&#13;
&#13;
<figure class="informal"><div class="figure"><img src="assets/leds_14in05.png"/>&#13;
&#13;
</div></figure>&#13;
&#13;
<p>Combining knowledge of JSON, HTTP, REST, and HTML gives us access to a vast variety of data available on the web. For example, in this section we wrote code to scrape data from a Wikipedia page. One key advantage of this approach is that we can likely rerun this code in a few months to automatically update the data and the plots. One key drawback is that our approach is tightly coupled to the structure of the web page—if someone updates the Wikipedia page and the table is no longer the second table on the page, our code will also need some edits in order to work. That said, having the skills needed to scrape data from the web opens the door to a wide range of data and enables all kinds of useful analyses<a contenteditable="false" data-primary="" data-startref="ix_de_ex_rate" data-type="indexterm" id="id1571"/><a contenteditable="false" data-primary="" data-startref="ix_ex_rate_example" data-type="indexterm" id="id1572"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="sec-web-summary">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>The internet abounds with data that are stored and exchanged in many different formats. In this chapter, our aim was to give you a taste of the variety of formats available and a basic understanding of how to acquire data from online sources and services. We also addressed the important goal of acquiring data in a reproducible fashion. Rather than copying and pasting from a web page or completing a form by hand, we demonstrated how to write code to acquire data. This code gives you a record of your workflow and of the data provenance.</p>&#13;
&#13;
<p>With each format introduced, we described a model for its structure. A basic understanding of a dataset’s organization helps you uncover issues with quality, mistakes in reading a source file, and how best to wrangle and analyze the data. In the longer run, as you continue to develop your data science skills, you will be exposed to other forms of data exchange, and we expect this approach of considering the organizational model and getting your hands dirty with some simple cases will serve you well.</p>&#13;
&#13;
<p>We only touched the surface of web services. There are many other useful topics, like keeping connections to a server alive as you issue multiple requests or retrieve data in batches, using cookies, and making multiple connections. But understanding the basics presented here can get you a long way. For example, if you use a library to retrieve data from an API but run into an error, you can start looking at the HTTP requests to debug your code. And you will know what’s possible when a new web service comes online.</p>&#13;
&#13;
<p>Web etiquette is a topic that we must mention. If you plan to scrape data from a website, it’s a good idea to check that you have permission to do so. When we sign up to be a client for a web app, we typically check a box indicating our agreement to the terms of service.</p>&#13;
&#13;
<p>If you use a web service or scrape web pages, be careful not to overburden the site with your requests. If a site offers a version of the data in a format like CSV, JSON, or XML, it’s better to download and use these than to scrape from a web page. Likewise, if there is a Python library that provides structured access to a web app, use it rather than writing your own code. When you make requests, start small to test your code, and consider saving the results so that you don’t have to repeat requests unnecessarily.</p>&#13;
&#13;
<p>The aim of this chapter wasn’t to make you an expert in these specific data formats. Instead, we wanted to give you the confidence needed to learn more about a data format, to evaluate the pros and cons of different formats, and to participate in projects that might use formats that you haven’t seen before.</p>&#13;
&#13;
<p>Now that you have experience working with different data formats, we return to the topic of modeling that we introduced in <a class="reference internal" data-type="xref" href="ch04.html#ch-modeling">Chapter 4</a>, picking it back up in earnest.</p>&#13;
</div></section>&#13;
</div></section></body></html>