<html><head></head><body><section data-pdf-bookmark="Chapter 8. Wrangling Files" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch-files">&#13;
<h1><span class="label">Chapter 8. </span>Wrangling Files</h1>&#13;
&#13;
<p>Before<a contenteditable="false" data-primary="files, wrangling" data-type="indexterm" id="ix_files_wr_ch8"/> you can work with data in Python, it helps to understand the files that store the source of the data. You want answers to a couple of basic questions:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>How much data do you have?</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>How is the source file formatted?</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>Answers to these questions can be very helpful. For example, if your file is too large or is not formatted the way you expect, you might not be able to properly load it into a dataframe.</p>&#13;
&#13;
<p>Although many types of structures can represent data, in this book we primarily work with data tables, such as Pandas DataFrames and SQL relations. (But do note that <a class="reference internal" data-type="xref" href="ch13.html#ch-text">Chapter 13</a> examines less-structured text data, and <a class="reference internal" data-type="xref" href="ch14.html#ch-web">Chapter 14</a> introduces hierarchical formats and binary files.) We focus on data tables for several reasons. Research on how to store and manipulate data tables has resulted in stable and efficient tools for working with tables. Plus, data in a tabular format<a contenteditable="false" data-primary="data tables" data-secondary="and matrices" data-secondary-sortas="matrices" data-type="indexterm" id="id1010"/><a contenteditable="false" data-primary="matrices" data-secondary="and data tables" data-secondary-sortas="data tables" data-type="indexterm" id="id1011"/> are close cousins of matrices, the mathematical objects of the immensely rich field of linear algebra. And of course, data tables are quite common.</p>&#13;
&#13;
<p>In this chapter, we introduce typical file formats and encodings for plain text, describe measures of file size, and use Python tools to examine source files. Later in the chapter, we introduce an alternative approach for working with files: the shell interpreter. Shell commands give us a programmatic way to get information about a file outside the Python environment, and the shell can be very useful with big data. Finally, we check the data table’s shape (the number of rows and columns) and granularity (what a row represents). These simple checks are the starting point for cleaning and analyzing our data.</p>&#13;
&#13;
<p>We first provide brief descriptions of the datasets that we use as examples throughout this chapter.</p>&#13;
&#13;
<section data-pdf-bookmark="Data Source Examples" data-type="sect1"><div class="sect1" id="ch-files-datasets">&#13;
<h1>Data Source Examples</h1>&#13;
&#13;
<p>We have selected<a contenteditable="false" data-primary="files, wrangling" data-secondary="data source examples" data-type="indexterm" id="ix_file_data_source_ch8"/> two examples to demonstrate file wrangling concepts: a government survey about drug abuse, and administrative data from the San Francisco Department of Public Health about restaurant inspections. Before we start wrangling, we give an overview of the data scope for these examples (see <a class="reference internal" data-type="xref" href="ch02.html#ch-data-scope">Chapter 2</a>).</p>&#13;
&#13;
<section data-pdf-bookmark="Drug Abuse Warning Network (DAWN) Survey" data-type="sect2"><div class="sect2" id="drug-abuse-warning-network-dawn-survey">&#13;
<h2>Drug Abuse Warning Network (DAWN) Survey</h2>&#13;
&#13;
<p>DAWN is a national<a contenteditable="false" data-primary="DAWN (Drug Abuse Warning Network) survey" data-type="indexterm" id="id1012"/><a contenteditable="false" data-primary="data scope" data-secondary="DAWN survey" data-type="indexterm" id="id1013"/> health-care survey that monitors trends in drug abuse. The survey aims to estimate the impact of drug abuse on the country’s health-care system and improve how emergency departments monitor substance abuse crises. DAWN was administered annually from 1998 through 2011 by the <a class="reference external" href="https://www.samhsa.gov">Substance Abuse and Mental Health Services Administration (SAMHSA)</a>. In 2018, due in part to the opioid epidemic, the DAWN survey was restarted. In this example, we look at the 2011 data, which have been made available through the <a class="reference external" href="https://oreil.ly/Y2SKG">SAMHSA Data Archive</a>.</p>&#13;
&#13;
<p>The target population consists of all drug-related emergency room visits in the US. These visits are accessed through a frame of emergency rooms in hospitals (and their records). Hospitals are selected for the survey through probability sampling (see <a class="reference internal" data-type="xref" href="ch03.html#ch-theory-datadesign">Chapter 3</a>), and all drug-related visits to the sampled hospital’s emergency room are included in the survey. All types of drug-related visits are included, such as drug misuse, abuse, accidental ingestion, suicide attempts, malicious poisonings, and adverse reactions. For each visit, the record may contain up to 16 different drugs, including illegal drugs, prescription drugs, and over-the-counter medications.</p>&#13;
&#13;
<p>The source file for this dataset is an example of fixed-width formatting that requires external documentation, like a codebook, to decipher. Also, it is a reasonably large file and so motivates the topic of how to find a file’s size. And the granularity is unusual because an ER visit, not a person, is the subject of investigation.</p>&#13;
&#13;
<p>The San Francisco restaurant files have other characteristics that make them a good example for this chapter.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="San Francisco Restaurant Food Safety" data-type="sect2"><div class="sect2" id="san-francisco-restaurant-food-safety">&#13;
<h2>San Francisco Restaurant Food Safety</h2>&#13;
&#13;
<p>The <a class="reference external" href="https://oreil.ly/kG1PN">San Francisco Department of Public Health</a> routinely makes<a contenteditable="false" data-primary="restaurant food safety dataset" data-secondary="timestamp transformation" data-type="indexterm" id="ix_rest_food_dataset"/><a contenteditable="false" data-primary="timestamps" data-type="indexterm" id="ix_time_stamp"/><a contenteditable="false" data-primary="data scope" data-secondary="restaurant food safety study" data-type="indexterm" id="id1014"/> unannounced visits to restaurants and inspects them for food safety. The inspector calculates a score based on the violations found and provides descriptions of the violations. The target population here is all restaurants in San Francisco. These restaurants are accessed through a frame of restaurant inspections that were <span class="keep-together">conducted</span> between 2013 and 2016. Some restaurants have multiple inspections in a year, and not all of the 7,000+ restaurants are inspected annually.</p>&#13;
&#13;
<p>Food safety scores are available through the city’s <a class="reference external" href="https://oreil.ly/kwh-F">Open Data initiative</a>, called <a class="reference external" href="https://datasf.org">DataSF</a>. DataSF is one example a city government making their data publicly available; the DataSF mission is to “empower the use of data in decision making and service delivery” with the goal of improving the quality of life and work for residents, employers, employees, and <span class="keep-together">visitors</span>.</p>&#13;
&#13;
<p>San Francisco requires restaurants to publicly display their scores (see <a class="reference internal" data-type="xref" href="#scorecard">Figure 8-1</a> for an example placard).<sup><a data-type="noteref" href="ch08.html#id1015" id="id1015-marker">1</a></sup> These data offer an example of multiple files with different structures, fields, and granularity. One dataset contains summary results of inspections, another provides details about the violations found, and a third contains general information about the restaurants. The violations include both serious problems related to the transmission of foodborne illnesses and minor issues such as not properly displaying the inspection placard.</p>&#13;
&#13;
<figure><div class="figure" id="scorecard"><img src="assets/leds_0801.png"/>&#13;
<h6><span class="label">Figure 8-1. </span>A food safety scorecard displayed in a restaurant; scores range between 0 and 100</h6>&#13;
</div></figure>&#13;
&#13;
<p>Both the DAWN survey data and the San Francisco restaurant inspection data are available online as plain-text files. However, their formats are quite different, and in the next section, we demonstrate how to figure out a file format so that we can read the data into a dataframe<a contenteditable="false" data-primary="" data-startref="ix_time_stamp" data-type="indexterm" id="id1016"/><a contenteditable="false" data-primary="" data-startref="ix_file_data_source_ch8" data-type="indexterm" id="id1017"/><a contenteditable="false" data-primary="" data-startref="ix_rest_food_dataset" data-type="indexterm" id="id1018"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="File Formats" data-type="sect1"><div class="sect1" id="ch-files-formats">&#13;
<h1>File Formats</h1>&#13;
&#13;
<p>A <em>file format</em> describes how data<a contenteditable="false" data-primary="files, wrangling" data-secondary="file formats" data-type="indexterm" id="ix_file_format"/> are stored on a computer’s disk or other storage device. Understanding the file format helps us figure out how to read the data into Python in order to work with it as a data table. In this section, we introduce several popular formats used to store data tables. These are all plain-text formats, meaning they are easy for us to read with a text editor like VS Code, Sublime, Vim, or Emacs.</p>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The file format<a contenteditable="false" data-primary="file formats" data-type="indexterm" id="id1019"/><a contenteditable="false" data-primary="dataframe structure" data-secondary="versus file formats" data-secondary-sortas="file formats" data-type="indexterm" id="id1020"/> and the <em>structure</em> of the data are two different things. We consider the data structure to be a mental representation of the data that tells us what kinds of operations we can do. For example, a table structure corresponds to data values arranged in rows and columns. But the same table can be stored in many different types of file formats.</p>&#13;
</div>&#13;
&#13;
<p>The first format we describe is the delimited file format.</p>&#13;
&#13;
<section data-pdf-bookmark="Delimited Format" data-type="sect2"><div class="sect2" id="delimited-format">&#13;
<h2>Delimited Format</h2>&#13;
&#13;
<p>Delimited<a contenteditable="false" data-primary="tab-separated value (TSV) file format" data-type="indexterm" id="id1021"/><a contenteditable="false" data-primary="TSV (tab-separated value) file format" data-type="indexterm" id="id1022"/><a contenteditable="false" data-primary="whitespace-separated file format" data-type="indexterm" id="id1023"/><a contenteditable="false" data-primary="delimited file formats" data-type="indexterm" id="ix_delimit_form"/><a contenteditable="false" data-primary="colon-separated file format" data-type="indexterm" id="id1024"/><a contenteditable="false" data-primary="comma-separated value (CSV) file format" data-type="indexterm" id="id1025"/><a contenteditable="false" data-primary="CSV (comma-separated value) file format" data-type="indexterm" id="id1026"/> formats use a specific character to separate data values. Usually, these separators are either a comma (comma-separated values, or CSV for short), a tab (tab-separated values, or TSV), whitespace, or a colon. These formats are natural for storing data that have a table structure. Each line in the file represents a record, which is delimited by newline (<code>\n</code> or <code>\r\n</code>) characters. And within a line, the record’s information is delimited by the comma character (<code>,</code>) for CSV or the tab character (<code>\t</code>) for TSV, and so on. The first line of these files often contains the names of the table’s <span class="keep-together">columns</span>/features.</p>&#13;
&#13;
<p>The San Francisco restaurant<a contenteditable="false" data-primary="pathlib library" data-type="indexterm" id="id1027"/><a contenteditable="false" data-primary="Path object for files and folders" data-type="indexterm" id="id1028"/> scores are stored in CSV-formatted files. Let’s display the first few lines of the <em>inspections.csv</em> file. In Python, the built-in <code>pathlib</code> library has a useful <code>Path</code> object to specify paths to files and folders that work across platforms. This file is within the <em>data</em> folder, so we use <code>Path()</code> to create the full pathname:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">from</code></span><code> </code><span><code class="nn">pathlib</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">Path</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="c1"># Create a Path pointing to our datafile</code></span><code>&#13;
</code><span><code class="n">insp_path</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code><code class="p">)</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">inspections.csv</code><code class="s1">'</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Paths are tricky when working across different operating<a contenteditable="false" data-primary="operating systems, path variations in" data-type="indexterm" id="id1029"/> systems (OSs). For instance, a typical path in Windows might look like <em>C:\files\data.csv</em>, while a path in Unix or macOS might look like <em>~/files/data.csv</em>. Because of this, code that works on one OS can fail to run on other OSs.</p>&#13;
&#13;
<p>The <code>pathlib</code> Python library was created to avoid OS-specific path issues. By using it, the code shown here is more <em>portable</em>—it works across Windows, macOS, and Unix.</p>&#13;
</div>&#13;
&#13;
<p>The <code>Path</code> object<a contenteditable="false" data-primary="read_text() method" data-type="indexterm" id="id1030"/> in the following code has many useful methods, such as <code>read_text()</code>, which reads in the entire contents of the file as a string:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">text</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">insp_path</code></span><span><code class="o">.</code></span><span><code class="n">read_text</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><span><code class="c1"># Print first five lines</code></span><code>&#13;
</code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="s1">'</code></span><span><code class="se">\n</code></span><span><code class="s1">'</code></span><span><code class="o">.</code></span><span><code class="n">join</code></span><span><code class="p">(</code></span><span><code class="n">text</code></span><span><code class="o">.</code></span><span><code class="n">split</code></span><span><code class="p">(</code></span><span><code class="s1">'</code></span><span><code class="se">\n</code></span><span><code class="s1">'</code></span><span><code class="p">)</code><code class="p">[</code><code class="p">:</code></span><span><code class="mi">5</code></span><span><code class="p">]</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
"business_id","score","date","type"&#13;
19,"94","20160513","routine"&#13;
19,"94","20171211","routine"&#13;
24,"98","20171101","routine"&#13;
24,"98","20161005","routine"&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Notice that the field names appear in the first line of the file; these names are comma separated and in quotes. We see four fields: the business identifier, the restaurant’s score, the date of the inspection, and the type of inspection. Each line in the file corresponds to one inspection, and the ID, score, date, and type values are separated by commas. In addition to identifying the file format, we also want to identify the format of the features. We see two things of note: the scores and dates both appear as strings. We will want to convert the scores to numbers so that we can calculate summary statistics and create visualizations. And we will convert the date into a date-time format so that we can make time-series plots. We show how to carry out these transformations in <a class="reference internal" data-type="xref" href="ch09.html#ch-wrangling">Chapter 9</a>.</p>&#13;
&#13;
<p>Displaying the first few lines of a file is something we’ll do often, so we create a function as a shortcut:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="k">def</code></span><code> </code><span><code class="nf">head</code></span><span><code class="p">(</code></span><span><code class="n">filepath</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">n</code></span><span><code class="o">=</code></span><span><code class="mi">5</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">width</code></span><span><code class="o">=</code><code class="o">-</code></span><span><code class="mi">1</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="sd">'''Prints the width characters of first n lines of filepath'''</code></span><code>&#13;
</code><code>    </code><span><code class="k">with</code></span><code> </code><span><code class="n">filepath</code></span><span><code class="o">.</code></span><span><code class="n">open</code></span><span><code class="p">(</code><code class="p">)</code></span><code> </code><span><code class="k">as</code></span><code> </code><span><code class="n">f</code></span><span><code class="p">:</code></span><code>&#13;
</code><code>        </code><span><code class="k">for</code></span><code> </code><span><code class="n">_</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="nb">range</code></span><span><code class="p">(</code></span><span><code class="n">n</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>            </code><span><code class="p">(</code></span><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="n">f</code></span><span><code class="o">.</code></span><span><code class="n">readline</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">,</code></span><code> </code><span><code class="n">end</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">'</code></span><span><code class="p">)</code></span><code> </code><span><code class="k">if</code></span><code> </code><span><code class="n">width</code></span><code> </code><span><code class="o">&lt;</code></span><code> </code><span><code class="mi">0</code></span><code>  </code><code>&#13;
</code><code>             </code><span><code class="k">else</code></span><code> </code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="n">f</code></span><span><code class="o">.</code></span><span><code class="n">readline</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">[</code><code class="p">:</code></span><span><code class="n">width</code></span><span><code class="p">]</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>People often confuse<a contenteditable="false" data-primary="spreadsheets" data-secondary="file format issue" data-type="indexterm" id="id1031"/><a contenteditable="false" data-primary="comma-separated value (CSV) file format" data-type="indexterm" id="id1032"/><a contenteditable="false" data-primary="CSV (comma-separated value) file format" data-type="indexterm" id="id1033"/><a contenteditable="false" data-primary="Excel, file format issue" data-type="indexterm" id="id1034"/> CSV and TSV files with spreadsheets. This is in part because most spreadsheet software (like Microsoft Excel) will automatically display a CSV file as a table in a workbook. Behind the scenes, Excel looks at the file format and encoding just like we’ve done in this section. However, Excel files have a different format than CSV and TSV files, and we need to use different <code>pandas</code> functions to read these formats into Python.</p>&#13;
</div>&#13;
&#13;
<p>All three of the restaurant source files are CSV formatted. In contrast, the DAWN source file has a fixed-width format. We describe this kind of formatting next<a contenteditable="false" data-primary="" data-startref="ix_delimit_form" data-type="indexterm" id="id1035"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Fixed-Width Format" data-type="sect2"><div class="sect2" id="fixed-width-format">&#13;
<h2>Fixed-Width Format</h2>&#13;
&#13;
<p>The fixed-width format<a contenteditable="false" data-primary="fixed-width file format (FWF)" data-type="indexterm" id="id1036"/><a contenteditable="false" data-primary="FWF (fixed-width file format)" data-type="indexterm" id="id1037"/> (FWF) does not use delimiters to separate data values. Instead, the values for a specific field appear in the exact same position in each line. The DAWN source file has this format. Each line in the file is very long. For display purposes, we only show the first few characters from the first five lines in the file:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">dawn_path</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code><code class="p">)</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="s1">'</code><code class="s1">DAWN-Data.txt</code><code class="s1">'</code></span><code>&#13;
</code><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="n">dawn_path</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">width</code></span><span><code class="o">=</code></span><span><code class="mi">65</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
     1 2251082    .9426354082   3 4 1 2201141 2 865 105 1102005 1&#13;
     2 2291292   5.9920106887   911 1 3201134 12077  81  82 283-8&#13;
     3 7 7 251   4.7231718669   611 2 2201143 12313   1  12  -7-8&#13;
     410 8 292   4.0801470012   6 2 1 3201122 1 234 358  99 215 2&#13;
     5 122 942   5.1777093467  10 6 1 3201134 3 865 105 1102005 1&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Notice how the values appear to align from one row to the next. For example, there is a decimal point in the same position (the 19th character) in each line. Notice also that some of the values seem to be squished together, and we need to know the exact position of each piece of information in a line in order to make sense of it. SAMHSA provides a 2,000-page <a class="reference external" href="https://oreil.ly/a4OFo">codebook</a> with all of this information, including some basic checks, so that we can confirm that we have correctly read the file. For instance, the codebook tells us that the age field appears in positions 34–35 and is coded in intervals from 1 to 11. The first two records shown in the preceding code have age categories of 4 and 11; the codebook tells us that a 4 stands for the age bracket “6 to 11” and 11 is for “65+.”</p>&#13;
&#13;
<p>Other plain-text formats that are popular include hierarchical formats and loosely formatted text (in contrast to formats that directly support table structures). These are covered in greater detail in other chapters, but for completeness, we briefly describe them here.</p>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>A widely adopted convention is to use the filename<a contenteditable="false" data-primary="readline() method" data-type="indexterm" id="id1038"/><a contenteditable="false" data-primary="filename extensions" data-type="indexterm" id="id1039"/> extension, such as <em>.csv</em>, <em>.tsv</em>, and <em>.txt</em>, to indicate the format of the contents of the file. Filenames that end with <em>.csv</em> are expected to contain comma-separated values, and those ending with <em>.tsv</em> are expected to contain tab-separated values; <em>.txt</em> generally denotes plain text without a designated format. However, these extension names are only suggestions. Even if a file has a <em>.csv</em> extension, the actual contents might not be formatted properly! It’s a good practice to inspect the contents of the file before loading it into a dataframe. If the file is not too large, you can open and examine it with a plain-text editor. Otherwise, you can view a couple of lines using <code>.readline()</code> or shell command.</p>&#13;
</div>&#13;
&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Hierarchical Formats" data-type="sect2"><div class="sect2" id="hierarchical-formats">&#13;
<h2>Hierarchical Formats</h2>&#13;
&#13;
<p>Hierarchical<a contenteditable="false" data-primary="hierarchical file formats" data-type="indexterm" id="id1040"/><a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-type="indexterm" id="id1041"/><a contenteditable="false" data-primary="eXtensible Markup Language (XML)" data-type="indexterm" id="id1042"/><a contenteditable="false" data-primary="XML (eXtensible Markup Language)" data-type="indexterm" id="id1043"/><a contenteditable="false" data-primary="JSON (JavaScript Object Notation)" data-type="indexterm" id="id1044"/><a contenteditable="false" data-primary="key-value format in file" data-type="indexterm" id="id1045"/><a contenteditable="false" data-primary="data exchange" data-secondary="JSON" data-type="indexterm" id="id1046"/> formats store data in a nested form. For instance, JavaScript Object Notation (JSON), which is commonly used for communication by web servers, includes key-value pairs and arrays that can be nested, similar to a Python dictionary. XML and HTML are other common formats for storing documents on the internet. Like JSON, these files have a hierarchical, key-value format. We cover both formats (JSON and XML) in more detail in <a class="reference internal" data-type="xref" href="ch14.html#ch-web">Chapter 14</a>.</p>&#13;
&#13;
<p>Next, we briefly describe other plain-text files that don’t fall into any of the previous categories but still have some structure to them that enables us to read and extract information.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Loosely Formatted Text" data-type="sect2"><div class="sect2" id="loosely-formatted-text">&#13;
<h2>Loosely Formatted Text</h2>&#13;
&#13;
<p>Web<a contenteditable="false" data-primary="loosely formatted text" data-type="indexterm" id="id1047"/><a contenteditable="false" data-primary="text" data-secondary="loosely formatted" data-type="indexterm" id="id1048"/> logs, instrument readings, and program logs typically provide data in plain text. For example, here is one line of a web log (we’ve split it across multiple lines for readability). It contains information such as the date, time, and type of request made to a website:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>169.237.46.168</span> <span>-</span> <span>-</span>&#13;
<span>[</span><span>26</span><span>/</span><span>Jan</span><span>/</span><span>2004</span><span>:</span><span>10</span><span>:</span><span>47</span><span>:</span><span>58</span> <span>-</span><span>0800</span><span>]</span><span>"GET /stat141/Winter04 HTTP/1.1"</span> <span>301</span> <span>328</span>&#13;
<span>"http://anson.ucdavis.edu/courses"</span>&#13;
<span>"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; .NET CLR 1.1.4322)"</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>There are organizational patterns present, but not in a simple delimited format. This is what we mean by “loosely formatted.” We see that the date and time appear between square brackets, and the type of request (<code>GET</code> in this case) follows the date-time information and appears in quotes. In <a class="reference internal" data-type="xref" href="ch13.html#ch-text">Chapter 13</a>, we use these observations about the web log’s format and string manipulation tools to extract values of interest into a data table.</p>&#13;
&#13;
<p>As another example, here is a single record taken from a wireless device log. The device reports the timestamp, the identifier, its location, and the signal strengths that it picks up from other devices. This information uses a combination of formats: key-value pairs, semicolon-delimited values, and comma-delimited values:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>t</span><span>=</span><span>1139644637174</span><span>;</span><span>id</span><span>=</span><span>00</span><span>:</span><span>02</span><span>:</span><span>2</span><span>D</span><span>:</span><span>21</span><span>:</span><span>0</span><span>F</span><span>:</span><span>33</span><span>;</span><span>pos</span><span>=</span><span>2.0</span><span>,</span><span>0.0</span><span>,</span><span>0.0</span><span>;</span><span>degree</span><span>=</span><span>45.5</span><span>;</span>&#13;
<span>00</span><span>:</span><span>14</span><span>:</span><span>bf</span><span>:</span><span>b1</span><span>:</span><span>97</span><span>:</span><span>8</span><span>a</span><span>=-</span><span>33</span><span>,</span><span>2437000000</span><span>,</span><span>3</span><span>;</span><span>00</span><span>:</span><span>14</span><span>:</span><span>bf</span><span>:</span><span>b1</span><span>:</span><span>97</span><span>:</span><span>8</span><span>a</span><span>=-</span><span>38</span><span>,</span><span>2437000000</span><span>,</span><span>3</span><span>;</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Like with the web logs, we can use string manipulation and the patterns in the records to extract features into a table.</p>&#13;
&#13;
<p>We have primarily introduced formats for plain-text data that are widely used for storing and exchanging tables. The CSV format is the most common, but others, such as tab-separated and fixed-width formats, are also prevalent. And there are many types of file formats that store data!</p>&#13;
&#13;
<p>So far, we have<a contenteditable="false" data-primary="plain text" data-type="indexterm" id="id1049"/> used the term <em>plain text</em> to broadly cover formats that can be viewed with a text editor. However, a plain-text file may have different encodings, and if we don’t specify the encoding correctly, the values in the dataframe might contain gibberish. We give an overview of file encoding next<a contenteditable="false" data-primary="" data-startref="ix_file_format" data-type="indexterm" id="id1050"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="File Encoding" data-type="sect1"><div class="sect1" id="file-encoding">&#13;
<h1>File Encoding</h1>&#13;
&#13;
<p>Computers<a contenteditable="false" data-primary="files, wrangling" data-secondary="file encoding" data-type="indexterm" id="ix_file_wr_enc"/><a contenteditable="false" data-primary="encoding, file/character" data-type="indexterm" id="ix_encode_char"/><a contenteditable="false" data-primary="character encoding" data-type="indexterm" id="ix_char_encode"/> store data as sequences of <em>bits</em>: 0s and 1s. <em>Character encodings</em>, like ASCII, tell the computer how to translate between bits and text. For example, in ASCII, the bits <code>100 001</code> stand for the letter A and <code>100 010</code> for B. The most basic kind of plain text supports only standard ASCII characters, which includes the uppercase and lowercase English letters, numbers, punctuation symbols, and spaces.</p>&#13;
&#13;
<p>ASCII<a contenteditable="false" data-primary="Latin-1 (ISO-8859-1)" data-type="indexterm" id="id1051"/><a contenteditable="false" data-primary="UTF-8" data-type="indexterm" id="id1052"/><a contenteditable="false" data-primary="ASCII character encoding" data-type="indexterm" id="id1053"/> encoding does not include a lot of special characters or characters from other languages. Other, more modern character encodings have many more characters that can be represented. Common encodings for documents and web pages are Latin-1 (ISO-8859-1) and UTF-8. UTF-8 has over a million characters and is backward compatible with ASCII, meaning that it uses the same representation for English letters, numbers, and punctuation as ASCII.</p>&#13;
&#13;
<p>When we have a text file, we usually need to figure out its encoding. If we choose the wrong encoding to read in a file, Python either reads incorrect values or throws an error. The best way to find the encoding is by checking the data’s documentation, which often explicitly says what the encoding is.</p>&#13;
&#13;
<p>When we don’t know the encoding<a contenteditable="false" data-primary="chardet package" data-type="indexterm" id="id1054"/><a contenteditable="false" data-primary="detect() method" data-type="indexterm" id="id1055"/>, we have to make a guess. The <code>chardet</code> package has a function called <code>detect()</code> that infers a file’s encoding. Since these guesses are imperfect, the function also returns a confidence level between 0 and 1. We use this function to look at the files from our examples:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">import</code></span><code> </code><span><code class="nn">chardet</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">line</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code></span><span><code class="si">{:&lt;25}</code></span><span><code class="s1"> </code></span><span><code class="si">{:&lt;10}</code></span><span><code class="s1"> </code></span><span><code class="si">{}</code></span><span><code class="s1">'</code></span><span><code class="o">.</code></span><span><code class="n">format</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="c1"># for each file, print its name, encoding &amp; confidence in the encoding</code></span><code>&#13;
</code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="n">line</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">File Name</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Encoding</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Confidence</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="k">for</code></span><code> </code><span><code class="n">filepath</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code></span><span><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">glob</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">*</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">result</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">chardet</code></span><span><code class="o">.</code></span><span><code class="n">detect</code></span><span><code class="p">(</code></span><span><code class="n">filepath</code></span><span><code class="o">.</code></span><span><code class="n">read_bytes</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="n">line</code></span><span><code class="p">(</code></span><span><code class="nb">str</code></span><span><code class="p">(</code></span><span><code class="n">filepath</code></span><span><code class="p">)</code><code class="p">,</code></span><code> </code><span><code class="n">result</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">encoding</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">,</code></span><code> </code><span><code class="n">result</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">confidence</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
File Name                 Encoding   Confidence&#13;
data/inspections.csv      ascii      1.0&#13;
data/co2_mm_mlo.txt       ascii      1.0&#13;
data/violations.csv       ascii      1.0&#13;
data/DAWN-Data.txt        ascii      1.0&#13;
data/legend.csv           ascii      1.0&#13;
data/businesses.csv       ISO-8859-1 0.73&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The detection function is quite certain that all but one of the files are ASCII encoded. The exception is <em>businesses.csv</em>, which appears to have an ISO-8859-1 encoding. We run into trouble if we ignore this encoding and try to read the businesses file into <span class="keep-together"><code>pandas</code></span> without specifying the special encoding:</p>&#13;
&#13;
<div class="highlight-python notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="c1"># naively reads file without considering encoding</code></span><code>&#13;
</code><span><code class="o">&gt;&gt;</code><code class="o">&gt;</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/businesses.csv</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="p">[</code></span><span><code class="o">.</code><code class="o">.</code><code class="o">.</code></span><span><code class="n">stack</code></span><code> </code><span><code class="n">trace</code></span><code> </code><span><code class="n">omitted</code></span><span><code class="o">.</code><code class="o">.</code><code class="o">.</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="ne">UnicodeDecodeError</code></span><span><code class="p">:</code></span><code> </code><span><code class="s1">'</code><code class="s1">utf-8</code><code class="s1">'</code></span><code> </code><span><code class="n">codec</code></span><code> </code><span><code class="n">can</code></span><span><code class="s1">'</code><code class="s1">t decode byte 0xd1 in</code></span><code class="w">&#13;
</code><span><code class="n">position</code></span><code> </code><span><code class="mi">8</code></span><span><code class="p">:</code></span><code> </code><span><code class="n">invalid</code></span><code> </code><span><code class="n">continuation</code></span><code> </code><span><code class="n">byte</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>To successfully read the data, we must specify the ISO-8859-1 encoding:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">bus</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/businesses.csv</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">encoding</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">ISO-8859-1</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell tag_remove-input docutils container">&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>name</th>&#13;
			<th>address</th>&#13;
			<th>postal_code</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>NRGIZE LIFESTYLE CAFE</td>&#13;
			<td>1200 VAN NESS AVE, 3RD FLOOR</td>&#13;
			<td>94109</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>24</td>&#13;
			<td>OMNI S.F. HOTEL - 2ND FLOOR PANTRY</td>&#13;
			<td>500 CALIFORNIA ST, 2ND FLOOR</td>&#13;
			<td>94104</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>31</td>&#13;
			<td>NORMAN’S ICE CREAM AND FREEZES</td>&#13;
			<td>2801 LEAVENWORTH ST</td>&#13;
			<td>94133</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>45</td>&#13;
			<td>CHARLIE’S DELI CAFE</td>&#13;
			<td>3202 FOLSOM ST</td>&#13;
			<td>94110</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>File encoding can be a bit mysterious to figure out, and unless there is metadata that explicitly gives us the encoding, guesswork comes into play. When an encoding is not 100% confirmed, it’s a good idea to seek additional documentation.</p>&#13;
&#13;
<p>Another potentially important aspect of a source file is its size. If a file is huge, then we might not be able to read it into a dataframe. In the next section, we discuss how to figure out a source file’s size<a contenteditable="false" data-primary="" data-startref="ix_file_wr_enc" data-type="indexterm" id="id1056"/><a contenteditable="false" data-primary="" data-startref="ix_char_encode" data-type="indexterm" id="id1057"/><a contenteditable="false" data-primary="" data-startref="ix_encode_char" data-type="indexterm" id="id1058"/>.</p>&#13;
</div></section>&#13;
&#13;
<section class="pagebreak-before" data-pdf-bookmark="File Size" data-type="sect1"><div class="sect1" id="ch-files-size">&#13;
<h1 class="less_space">File Size</h1>&#13;
&#13;
<p>Computers<a contenteditable="false" data-primary="size of file" data-type="indexterm" id="ix_size_file"/><a contenteditable="false" data-primary="files, wrangling" data-secondary="size of files" data-type="indexterm" id="ix_file_wr_size"/> have finite resources. You have likely encountered these limits firsthand if your computer has slowed down from having too many applications open at once. We want to make sure that we do not exceed the computer’s limits while working with data, and we might choose to examine a file differently depending on its size. If we know that our dataset is relatively small, then a text editor or a spreadsheet can be convenient for looking at the data. On the other hand, for large datasets, a more programmatic exploration or even distributed computing tools may be needed.</p>&#13;
&#13;
<p>In many situations, we analyze datasets<a contenteditable="false" data-primary="disk storage versus RAM" data-type="indexterm" id="id1059"/><a contenteditable="false" data-primary="memory versus disk storage" data-type="indexterm" id="id1060"/><a contenteditable="false" data-primary="random access memory (RAM)" data-type="indexterm" id="id1061"/> downloaded from the internet. These files reside on the computer’s <em>disk storage</em>. In order to use Python to explore and manipulate the data, we need to read the data into the computer’s <em>memory</em>, also known as random access memory (RAM). All Python code requires the use of RAM, no matter how short the code is. A computer’s RAM is typically much smaller than its disk storage. For example, one computer model released in 2018 had 32 times more disk storage than RAM. Unfortunately, this means that datafiles can often be much bigger than what is feasible to read into memory.</p>&#13;
&#13;
<p>Both disk storage and RAM capacity are measured in terms of <em>bytes</em> (eight 0s and 1s). Roughly speaking, each character in a text file adds one byte to a file’s size. To <span class="keep-together">succinctly</span> describe the sizes of larger files, we use the prefixes described in <a class="reference internal" data-type="xref" href="#byte-prefixes">Table 8-1</a>; for example, a file that contains 52,428,800 characters will take up <span class="math notranslate nohighlight"><math> <mn>5</mn> <mo>,</mo> <mn>242</mn> <mo>,</mo> <mn>8800</mn> <mrow> <mo>/</mo> </mrow> <mn>1</mn> <mo>,</mo> <msup> <mn>024</mn> <mn>2</mn> </msup> <mo>=</mo> <mn>50</mn> <mtext> </mtext> <mrow> <mtext>mebibytes</mtext> </mrow> </math></span>, or 50 MiB on disk.</p>&#13;
&#13;
<table id="byte-prefixes">&#13;
	<caption><span class="label">Table 8-1. </span><span>Prefixes for common file sizes</span></caption>&#13;
	<thead>&#13;
		<tr>&#13;
			<th class="head">Multiple</th>&#13;
			<th class="head">Notation</th>&#13;
			<th class="head">Number of bytes</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td>Kibibyte</td>&#13;
			<td>&#13;
			<p>KiB</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>1,024</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>Mebibyte</td>&#13;
			<td>&#13;
			<p>MiB</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>1,024²</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>Gibibyte</td>&#13;
			<td>&#13;
			<p>GiB</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>1,024³</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>Tebibyte</td>&#13;
			<td>&#13;
			<p>TiB</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>1,024⁴</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td>Pebibyte</td>&#13;
			<td>&#13;
			<p>PiB</p>&#13;
			</td>&#13;
			<td>&#13;
			<p>1,024⁵</p>&#13;
			</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Why use multiples of 1,024 instead of simple multiples of 1,000 for these prefixes? This is a historical result of the fact that most computers use a binary number scheme where powers of 2 are simpler to represent (<span class="math notranslate nohighlight"><math> <mn>1</mn> <mo>,</mo> <mn>024</mn> <mo>=</mo> <msup> <mn>2</mn> <mrow> <mn>10</mn> </mrow> </msup> </math></span>). You also see the typical SI prefixes used to describe size—kilobytes, megabytes, and gigabytes, for example. Unfortunately, these prefixes are used inconsistently. Sometimes a kilobyte refers to 1,000 bytes; other times, a kilobyte refers to 1,024 bytes. To avoid confusion, we stick to kibi-, mebi-, and gibibytes, which clearly represent multiples of 1,024.</p>&#13;
</div>&#13;
&#13;
<p>It is not uncommon<a contenteditable="false" data-primary="os library" data-type="indexterm" id="id1062"/> to have a datafile happily stored on a computer that will overflow the computer’s memory if we attempt to manipulate it with a program. So we often begin our data work by making sure the files are of manageable size. To do this, we use the built-in <code>os</code> library:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="kn">from</code></span><code> </code><span><code class="nn">pathlib</code></span><code> </code><span><code class="kn">import</code></span><code> </code><span><code class="n">Path</code></span><code>&#13;
</code><span><code class="kn">import</code></span><code> </code><span><code class="nn">os</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">kib</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">1024</code></span><code>&#13;
</code><span><code class="n">line</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="s1">'</code></span><span><code class="si">{:&lt;25}</code></span><span><code class="s1"> </code></span><span><code class="si">{}</code></span><span><code class="s1">'</code></span><span><code class="o">.</code></span><span><code class="n">format</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="n">line</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">File</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">Size (KiB)</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="k">for</code></span><code> </code><span><code class="n">filepath</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code></span><span><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">glob</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">*</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">size</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">os</code></span><span><code class="o">.</code></span><span><code class="n">path</code></span><span><code class="o">.</code></span><span><code class="n">getsize</code></span><span><code class="p">(</code></span><span><code class="n">filepath</code></span><span><code class="p">)</code></span><code>&#13;
</code><code>    </code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="n">line</code></span><span><code class="p">(</code></span><span><code class="nb">str</code></span><span><code class="p">(</code></span><span><code class="n">filepath</code></span><span><code class="p">)</code><code class="p">,</code></span><code> </code><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">round</code></span><span><code class="p">(</code></span><span><code class="n">size</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="n">kib</code></span><span><code class="p">)</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
File                      Size (KiB)&#13;
data/inspections.csv      455.0&#13;
data/co2_mm_mlo.txt       50.0&#13;
data/violations.csv       3639.0&#13;
data/DAWN-Data.txt        273531.0&#13;
data/legend.csv           0.0&#13;
data/businesses.csv       645.0&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We see that the <em>businesses.csv</em> file takes up 645 KiB on disk, making it well within the memory capacities of most systems. Although the <em>violations.csv</em> file takes up 3.6 MiB of disk storage, most machines can easily read it into a <code>pandas</code> <code>DataFrame</code> too. But <em>DAWN-Data.txt</em>, which contains the DAWN survey data, is much larger.</p>&#13;
&#13;
<p>The DAWN file takes up roughly 270 MiB of disk storage, and while some computers can work with this file in memory, it can slow down other systems. To make this data more manageable in Python, we can, for example, load in a subset of the columns rather than all of them.</p>&#13;
&#13;
<p>Sometimes we are interested in the total size of a folder instead of the size of individual files. For example, we have three restaurant files, and we might like to see whether we can combine all the data into a single dataframe. In the following code, we calculate the size of the <em>data</em> folder, including all files in it:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">mib</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">1024</code></span><span><code class="o">*</code><code class="o">*</code></span><span><code class="mi">2</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="n">total</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="mi">0</code></span><code>&#13;
</code><span><code class="k">for</code></span><code> </code><span><code class="n">filepath</code></span><code> </code><span><code class="ow">in</code></span><code> </code><span><code class="n">Path</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code></span><span><code class="p">)</code></span><span><code class="o">.</code></span><span><code class="n">glob</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">*</code><code class="s1">'</code></span><span><code class="p">)</code><code class="p">:</code></span><code>&#13;
</code><code>    </code><span><code class="n">total</code></span><code> </code><span><code class="o">+</code><code class="o">=</code></span><code> </code><span><code class="n">os</code></span><span><code class="o">.</code></span><span><code class="n">path</code></span><span><code class="o">.</code></span><span><code class="n">getsize</code></span><span><code class="p">(</code></span><span><code class="n">filepath</code></span><span><code class="p">)</code></span><code> </code><span><code class="o">/</code></span><code> </code><span><code class="n">mib</code></span><code>&#13;
</code><code>&#13;
</code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="sa">f</code></span><span><code class="s1">'</code><code class="s1">The data/ folder contains </code></span><span><code class="si">{</code></span><span><code class="n">total</code></span><span><code class="si">:</code></span><span><code class="s1">.2f</code></span><span><code class="si">}</code></span><span><code class="s1"> MiB</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
The data/ folder contains 271.80 MiB&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>As a rule of thumb<a contenteditable="false" data-primary="pandas library" data-secondary="memory limits for importing into" data-type="indexterm" id="id1063"/>, reading in a file using <code>pandas</code> usually requires at least five times the available memory as the file size. For example, reading in a 1 GiB file typically requires at least 5 GiB of available memory. Memory is shared by all programs running on a computer, including the operating system, web browsers, and Jupyter notebook itself. A computer with 4 GiB total RAM might have only 1 GiB available RAM with many applications running. With 1 GiB available RAM, it is unlikely that <code>pandas</code> will be able to read in a 1 GiB file.</p>&#13;
</div>&#13;
&#13;
<p>There are several strategies for working with data that are far larger than what is feasible to load into memory. We describe a few of them next.</p>&#13;
&#13;
<p>The popular<a contenteditable="false" data-primary="big data considerations" data-secondary="accessing large data files" data-type="indexterm" id="id1064"/> term <em>big data</em> generally refers to the scenario where the data are large enough that even top-of-the-line computers can’t read the data directly into memory. This is a common scenario in scientific domains like astronomy, where telescopes capture images of space that can be petabytes (<span class="math notranslate nohighlight"><math> <msup> <mn>2</mn> <mrow> <mn>50</mn> </mrow> </msup> </math></span>) in size. While not quite as big, social media giants, health-care providers, and other companies can also struggle with large amounts of data.</p>&#13;
&#13;
<p>Figuring out how to draw insights from these datasets is an important research problem that motivates the fields of database engineering and distributed computing. While we won’t cover these fields in this book, we provide a brief overview of basic approaches:</p>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Subset the data.</dt>&#13;
	<dd>&#13;
	<p>One simple<a contenteditable="false" data-primary="subsetting, dataframes" data-secondary="as approach to working with big data" data-secondary-sortas="approach to working with big data" data-type="indexterm" id="id1065"/><a contenteditable="false" data-primary="dataframes" data-secondary="subsetting" data-type="indexterm" id="id1066"/> approach is to work with portions of data. Rather than loading in the entire source file, we can either select a specific part of it (e.g., one day’s worth of data) or randomly sample the dataset. Because of its simplicity, we use this approach quite often in this book. The natural downside is that we lose many of the benefits of analyzing a large dataset, like being able to study rare events.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Use a database system.</dt>&#13;
	<dd>&#13;
	<p>As discussed in <a class="reference internal" data-type="xref" href="ch07.html#ch-sql">Chapter 7</a>, relational<a contenteditable="false" data-primary="relational database management systems (RDBMs)" data-type="indexterm" id="id1067"/> database management systems (RDBMSs) are specifically designed to store large datasets. SQLite is a useful system for working with datasets that are too large to fit in memory but small enough to fit on disk for a single machine. For datasets that are too large to fit on a single machine, more scalable database systems like MySQL and PostgreSQL can be used. These systems can manipulate data that are too big to fit into memory by using SQL queries. Because of their advantages, RDBMSs are commonly used for data storage in research and industry settings. One downside is that they often require a separate server for the data that needs its own configuration. Another downside is that SQL is less flexible in what it can compute than Python, which becomes especially relevant for modeling. A useful hybrid approach is to use SQL to subset, aggregate, or sample the data into batches that are small enough to read into Python. Then we can use Python for more sophisticated analyses.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<dl class="simple myst">&#13;
	<dt>Use a distributed computing system.</dt>&#13;
	<dd>&#13;
	<p>Another<a contenteditable="false" data-primary="distributed computing system, to work with big data" data-type="indexterm" id="id1068"/> approach to handling complex computations on large datasets is to use a distributed computing system like MapReduce, Spark, or Ray. These systems work best on tasks that can be split into many smaller parts where they divide datasets into smaller pieces and run programs on all of the smaller datasets at once. These systems have great flexibility and can be used in a variety of scenarios. Their main downside is that they can require a lot of work to install and configure properly because they are typically installed across many computers that need to coordinate with one another.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<p>It can be convenient to use Python to determine a file format, encoding, and size. Another powerful tool for working with files is the shell; the shell is widely used and has a more succinct syntax than Python. In the next section, we introduce a few command-line tools available in the shell for carrying out the same tasks of finding out information about a file before reading it into a dataframe<a contenteditable="false" data-primary="" data-startref="ix_file_wr_size" data-type="indexterm" id="id1069"/><a contenteditable="false" data-primary="" data-startref="ix_size_file" data-type="indexterm" id="id1070"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="The Shell and Command-Line Tools" data-type="sect1"><div class="sect1" id="ch-files-command-line">&#13;
<h1>The Shell and Command-Line Tools</h1>&#13;
&#13;
<p>Nearly all computers<a contenteditable="false" data-primary="shell commands" data-type="indexterm" id="ix_shell_com"/> provide access to a <em>shell interpreter</em>, such as <code>sh</code> or <code>bash</code> or <code>zsh</code>. These interpreters typically perform operations on the files on a computer with their own language, syntax, and built-in commands.</p>&#13;
&#13;
<p>We use the term <em>command-line interface (CLI) tools</em> to refer to the commands<a contenteditable="false" data-primary="bash shell" data-type="indexterm" id="id1071"/><a contenteditable="false" data-primary="CLI (command-line interface) tools" data-type="indexterm" id="id1072"/><a contenteditable="false" data-primary="command-line interface (CLI) tools" data-type="indexterm" id="id1073"/> available in a shell interpreter. Although we only cover a few CLI tools here, there are many useful CLI tools that enable all sorts of operations on files. For instance, the following command in the <code>bash</code> shell produces a list of all the files in the <em>figures/</em> folder for this chapter along with their file sizes:</p>&#13;
&#13;
<div class="highlight-bash notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
$ ls -l -h figures/&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
	<p>The dollar sign is the shell prompt, showing the user where to type. It’s not part of the command itself.</p>&#13;
</div>&#13;
&#13;
<p>The basic syntax for a shell command is:</p>&#13;
&#13;
<div class="highlight-bash notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
 <span>command</span> -options arg1 arg2&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>CLI tools<a contenteditable="false" data-primary="files, wrangling" data-secondary="shell and command-line tools" data-type="indexterm" id="ix_files_wr_cli"/><a contenteditable="false" data-primary="ls command-line tool" data-type="indexterm" id="id1074"/><a contenteditable="false" data-primary="man tool" data-type="indexterm" id="id1075"/><a contenteditable="false" data-primary="flag options, CLI tools" data-type="indexterm" id="id1076"/><a contenteditable="false" data-primary="arguments, CLI tools" data-type="indexterm" id="id1077"/> often take one or more <em>arguments</em>, similar to how Python functions take arguments. In the shell, we wrap arguments with spaces, not with parentheses or commas. The arguments appear at the end of the command line, and they are usually the name of a file or some text. In the <code>ls</code> example, the argument to <code>ls</code> is <code>figures/</code>. Additionally, CLI tools support <em>flags</em> that provide additional options. These flags are specified immediately following the command name using a dash as a delimiter. In the <code>ls</code> example, we provided the flags <code>-l</code> (to provide extra information about each file) and <code>-h</code> (to provide file sizes in a more human-readable format). Many commands have default arguments and options, and the <code>man</code> tool prints a list of acceptable options, examples, and defaults for any command. For example, <code>man <span class="pre">ls</span></code> describes the 30 or so flags available for <code>ls</code>.</p>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>All CLI tools<a contenteditable="false" data-primary="sh shell interpreter" data-type="indexterm" id="id1078"/> we cover in this book are specific to the <code>sh</code> shell interpreter, the default interpreter for Jupyter installations on macOS and Linux systems at the time of this writing. Windows systems have a different interpreter, and the commands shown in the book may not run on Windows, although Windows gives access to an <code>sh</code> interpreter through its Linux Subsystem.</p>&#13;
&#13;
<p>The commands in this section can be run in a terminal application, or through a terminal opened by Jupyter.</p>&#13;
</div>&#13;
&#13;
<p>We begin with an exploration of the filesystem containing the content for this chapter, using the <code>ls</code> tool:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
$ ls&#13;
&#13;
data                            wrangling_granularity.ipynb&#13;
figures                         wrangling_intro.ipynb                      &#13;
wrangling_command_line.ipynb    wrangling_structure.ipynb&#13;
wrangling_datasets.ipynb        wrangling_summary.ipynb&#13;
wrangling_formats.ipynb       &#13;
&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>To dive deeper and list the files in the <em>data/</em> directory, we provide the directory name as an argument to <code>ls</code>:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
$ ls -l -L -h data/&#13;
&#13;
total 556664&#13;
-rw-r--r--  1 nolan  staff   267M Dec 10 14:03 DAWN-Data.txt&#13;
-rw-r--r--  1 nolan  staff   645K Dec 10 14:01 businesses.csv&#13;
-rw-r--r--  1 nolan  staff    50K Jan 22 13:09 co2_mm_mlo.txt&#13;
-rw-r--r--  1 nolan  staff   455K Dec 10 14:01 inspections.csv&#13;
-rw-r--r--  1 nolan  staff   120B Dec 10 14:01 legend.csv&#13;
-rw-r--r--  1 nolan  staff   3.6M Dec 10 14:01 violations.csv&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We added<a contenteditable="false" data-primary="-l flag, CLI option" data-primary-sortas="l flag, CLI option" data-type="indexterm" id="id1079"/> the <code>-l</code> flag to the command to get more information about each file. The file size appears in the fifth column of the listing, and it’s more readable as specified by the <code>-h</code> flag. When we have multiple simple option flags like <code>-l</code>, <code>-h</code>, and <code>-L</code>, we can combine them together as a shorthand:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
<span>ls</span> <span>-</span><span>lLh</span> <span>data</span><span>/</span>&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>When working<a contenteditable="false" data-primary="-L flag, CLI option" data-primary-sortas="L flag, CLI option" data-type="indexterm" id="id1080"/><a contenteditable="false" data-primary="symlinks" data-type="indexterm" id="id1081"/> with datasets in this book, our code will often use an additional <code>-L</code> flag for <code>ls</code> and other CLI tools, such as <code>du</code>. We do this because we set up the datasets in the book using shortcuts (called <em>symlinks</em>). Usually, your code won’t need the <code>-L</code> flag unless you’re working with symlinks too.</p>&#13;
</div>&#13;
&#13;
<p>Other CLI tools<a contenteditable="false" data-primary="wc (word count) tool" data-type="indexterm" id="id1082"/><a contenteditable="false" data-primary="du (disk usage) tool" data-type="indexterm" id="id1083"/> for checking file size are <code>wc</code> and <code>du</code>. The command <code>wc</code> (short for <em>word count</em>) provides helpful information about a file’s size in terms of the number of lines, words, and characters in the file:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
$ wc data/DAWN-Data.txt&#13;
&#13;
  229211 22695570 280095842 data/DAWN-Data.txt&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can see from the output that <em>DAWN-Data.txt</em> has 229,211 lines and 280,095,842 characters. (The middle value is the file’s word count, which is useful for files that contain sentences and paragraphs but not very useful for files containing data, such as FWF-formatted values.)</p>&#13;
&#13;
<p>The <code>ls</code> tool does not calculate<a contenteditable="false" data-primary="folder sizes, finding" data-type="indexterm" id="id1084"/> the cumulative size of the contents of a folder. To properly calculate the total size of a folder, including the files in the folder, we use <code>du</code> (short for <em>disk usage</em>). By default<a contenteditable="false" data-primary="blocks, sizing folders" data-type="indexterm" id="id1085"/>, the <code>du</code> tool shows the size in units called <em>blocks</em>:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
$ du -L data/&#13;
&#13;
556664	data/&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We commonly<a contenteditable="false" data-primary="-h flag, CLI option" data-primary-sortas="h flag, CLI option" data-type="indexterm" id="id1086"/><a contenteditable="false" data-primary="-s flag, CLI option" data-primary-sortas="s flag, CLI option" data-type="indexterm" id="id1087"/> add the <code>-s</code> flag to <code>du</code> to show the file sizes for both files and folders and the <code>-h</code> flag to display quantities in the standard KiB, MiB, or GiB format. The asterisk in <code>data/*</code> in the following code tells <code>du</code> to show the size of every item in the_data_ folder:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
$ du -Lsh data/*&#13;
&#13;
267M	data/DAWN-Data.txt&#13;
648K	data/businesses.csv&#13;
 52K	data/co2_mm_mlo.txt&#13;
456K	data/inspections.csv&#13;
4.0K	data/legend.csv&#13;
3.6M	data/violations.csv&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>To check the formatting<a contenteditable="false" data-primary="file formats" data-type="indexterm" id="id1088"/> of a file, we can examine the first few lines with the <code>head</code> command or the last few lines with <code>tail</code>. These CLIs are very useful for peeking at a file’s contents to determine whether it’s formatted as CSV, TSV, and so on. As an example, let’s look at the <em>inspections.csv</em> file:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
$ head -4 data/inspections.csv&#13;
&#13;
"business_id","score","date","type"&#13;
19,"94","20160513","routine"&#13;
19,"94","20171211","routine"&#13;
24,"98","20171101","routine"&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>By default, <code>head</code> displays<a contenteditable="false" data-primary="-n option, head command" data-primary-sortas="n option, head command" data-type="indexterm" id="id1089"/><a contenteditable="false" data-primary="head command" data-type="indexterm" id="id1090"/> the first 10 lines of a file. If we want to show, say, four lines, then we add the option <code>-n <span class="pre">4</span></code> to our command (or just <code>-4</code> for short).</p>&#13;
&#13;
<p>We can print<a contenteditable="false" data-primary="cat command" data-type="indexterm" id="id1091"/> the entire contents of the file using the <code>cat</code> command. However, you should take care when using this command, as printing a large file can cause a crash. The <em>legend.csv</em> file is small, and we can use <code>cat</code> to concatenate and print its contents:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
$ cat data/legend.csv&#13;
&#13;
"Minimum_Score","Maximum_Score","Description"&#13;
0,70,"Poor"&#13;
71,85,"Needs Improvement"&#13;
86,90,"Adequate"&#13;
91,100,"Good"&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>In many cases<a contenteditable="false" data-primary="tail command" data-type="indexterm" id="id1092"/>, using <code>head</code> or <code>tail</code> alone gives us a good enough sense of the file structure to proceed with loading it into a dataframe.</p>&#13;
&#13;
<p>Finally, the <code>file</code> command can help us determine a file’s encoding:</p>&#13;
&#13;
<div class="highlight-default notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
$ file -I data/*&#13;
&#13;
data/DAWN-Data.txt:   text/plain; charset=us-ascii&#13;
data/businesses.csv:  application/csv; charset=iso-8859-1&#13;
data/co2_mm_mlo.txt:  text/plain; charset=us-ascii&#13;
data/inspections.csv: application/csv; charset=us-ascii&#13;
data/legend.csv:      application/csv; charset=us-ascii&#13;
data/violations.csv:  application/csv; charset=us-ascii&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We see (again) that all of the files are ASCII, except for <em>businesses.csv</em>, which has an ISO-8859-1 encoding.</p>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Commonly, we open a terminal program to start a shell interpreter. However, Jupyter notebooks provide a convenience: if a line of code in a Python code cell is prefixed with the <code>!</code> character, the line will go directly to the system’s shell interpreter. For example, running <code>!ls</code> in a Python cell lists the files in the current directory.</p>&#13;
</div>&#13;
&#13;
<p>Shell commands give us a programmatic way to work with files, rather than a point-and-click “manual” approach. They are useful for the following:</p>&#13;
&#13;
<dl class="simple myst pagebreak-before less_space">&#13;
	<dt>Documentation</dt>&#13;
	<dd>&#13;
	<p>If you need to record what you did.</p>&#13;
	</dd>&#13;
	<dt>Error reduction</dt>&#13;
	<dd>&#13;
	<p>If you want to reduce typographical errors and other simple but potentially harmful mistakes.</p>&#13;
	</dd>&#13;
	<dt>Reproducibility</dt>&#13;
	<dd>&#13;
	<p>If you need to repeat the same process in the future or you plan to share your process with others. This gives you a record of your actions.</p>&#13;
	</dd>&#13;
	<dt>Volume</dt>&#13;
	<dd>&#13;
	<p>If you have many repetitive operations to perform, the size of the file you are working with is large, or you need to perform things quickly. CLI tools can help in all these cases.</p>&#13;
	</dd>&#13;
</dl>&#13;
&#13;
<p>After the data have been loaded into a dataframe, our next task is to figure out the table’s shape and granularity. We start by finding the number of rows and columns in the table (its shape). Then we need to understand what a row represents before we begin to check the quality of the data. We cover these topics in the next section<a contenteditable="false" data-primary="" data-startref="ix_files_wr_cli" data-type="indexterm" id="id1093"/><a contenteditable="false" data-startref="ix_shell_com" data-type="indexterm" id="id1094"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Table Shape and Granularity" data-type="sect1"><div class="sect1" id="ch-files-granularity">&#13;
<h1>Table Shape and Granularity</h1>&#13;
&#13;
<p>As described earlier<a contenteditable="false" data-primary="granularity, data table" data-secondary="finding" data-type="indexterm" id="ix_gran_data_table"/><a contenteditable="false" data-primary="shape of data table" data-secondary="finding" data-type="indexterm" id="ix_shape_data_table"/><a contenteditable="false" data-primary="files, wrangling" data-secondary="table shape and granularity" data-type="indexterm" id="ix_files_wr_shape"/><a contenteditable="false" data-primary="data tables" data-secondary="granularity" data-type="indexterm" id="ix_data_table_gran"/>, we refer to a dataset’s <em>structure</em> as a mental representation of the data, and in particular, we represent data that have a <em>table</em> structure by arranging values in rows and columns. We use the term <em>granularity</em> to describe what each row in the table represents, and the term <em>shape</em> quantifies the table’s rows and columns.</p>&#13;
&#13;
<p>Now that we have determined<a contenteditable="false" data-primary="restaurant food safety dataset" data-secondary="wrangling files" data-type="indexterm" id="ix_rest_food_dataset2"/> the format of the restaurant-related files, we load them into dataframes and examine their shapes:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">bus</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/businesses.csv</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">encoding</code></span><span><code class="o">=</code></span><span><code class="s1">'</code><code class="s1">ISO-8859-1</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">insp</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2">data/inspections.csv</code><code class="s2">"</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="n">viol</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_csv</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2">data/violations.csv</code><code class="s2">"</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2"> Businesses:</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">bus</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><span><code class="p">,</code></span><code> </code><span><code class="s2">"</code></span><span><code class="se">\t</code></span><span><code class="s2"> Inspections:</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">insp</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><span><code class="p">,</code></span><code> </code><code>&#13;
</code><code>     </code><span><code class="s2">"</code></span><span><code class="se">\t</code></span><span><code class="s2"> Violations:</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">viol</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
 Businesses: (6406, 9) 	 Inspections: (14222, 4) 	 Violations: (39042, 3)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We find that the table with the restaurant information (the business table) has 6,406 rows and 9 columns. Now let’s figure out the granularity of this table. To start, we can look at the first two rows:</p>&#13;
&#13;
<div class="cell tag_remove-input docutils container">&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>name</th>&#13;
			<th>address</th>&#13;
			<th>city</th>&#13;
			<th>...</th>&#13;
			<th>postal_code</th>&#13;
			<th>latitude</th>&#13;
			<th>longitude</th>&#13;
			<th>phone_number</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>NRGIZE LIFESTYLE CAFE</td>&#13;
			<td>1200 VAN NESS AVE, 3RD FLOOR</td>&#13;
			<td>San Francisco</td>&#13;
			<td>...</td>&#13;
			<td>94109</td>&#13;
			<td>37.79</td>&#13;
			<td>-122.42</td>&#13;
			<td>+14157763262</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>24</td>&#13;
			<td>OMNI S.F. HOTEL - 2ND FLOOR PANTRY</td>&#13;
			<td>500 CALIFORNIA ST, 2ND FLOOR</td>&#13;
			<td>San Francisco</td>&#13;
			<td>...</td>&#13;
			<td>94104</td>&#13;
			<td>37.79</td>&#13;
			<td>-122.40</td>&#13;
			<td>+14156779494</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
2 rows × 9 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>These two rows give us the impression that each record represents a particular restaurant. But, we can’t tell from just two records whether or not this is the case. The field named <code>business_id</code> implies that it is the unique identifier for the restaurant. We can confirm this by checking whether the number of records in the dataframe matches the number of unique values in the field <code>business_id</code>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2">Number of records:</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="nb">len</code></span><span><code class="p">(</code></span><span><code class="n">bus</code></span><span><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="s2">"</code><code class="s2">Number of unique business ids:</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="nb">len</code></span><span><code class="p">(</code></span><span><code class="n">bus</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">business_id</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">unique</code></span><span><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
Number of records: 6406&#13;
Number of unique business ids: 6406&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The number<a contenteditable="false" data-primary="primary key" data-type="indexterm" id="id1095"/> of unique <code>business_id</code>s matches the number of rows in the table, so it seems safe to assume that each row represents a restaurant. Since <code>business_id</code> uniquely identifies each record in the dataframe, we treat <code>business_id</code> as the <em>primary key</em> for the table. We can use primary keys to join tables (see <a class="reference internal" data-type="xref" href="ch06.html#ch-pandas">Chapter 6</a>). Sometimes a primary key consists of two (or more) features. This is the case for the other two restaurant files. Let’s continue the examination of the inspections and violations dataframes and find their granularity.</p>&#13;
&#13;
<section data-pdf-bookmark="Granularity of Restaurant Inspections and Violations" data-type="sect2"><div class="sect2" id="granularity-of-restaurant-inspections-and-violations">&#13;
<h2>Granularity of Restaurant Inspections and Violations</h2>&#13;
&#13;
<p>We just saw<a contenteditable="false" data-primary="restaurant food safety dataset" data-secondary="inspections and violations" data-type="indexterm" id="id1096"/> that there are many more rows in the inspection table than the business table. Let’s take a closer look at the first few inspections:</p>&#13;
&#13;
<div class="cell tag_remove-input docutils container">&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>score</th>&#13;
			<th>date</th>&#13;
			<th>type</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>94</td>&#13;
			<td>20160513</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>19</td>&#13;
			<td>94</td>&#13;
			<td>20171211</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>24</td>&#13;
			<td>98</td>&#13;
			<td>20171101</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>24</td>&#13;
			<td>98</td>&#13;
			<td>20161005</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="p">(</code></span><span><code class="n">insp</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">groupby</code></span><span><code class="p">(</code><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">business_id</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code></span><span><code class="p">]</code><code class="p">)</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">size</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">sort_values</code></span><span><code class="p">(</code></span><span><code class="n">ascending</code></span><span><code class="o">=</code></span><span><code class="kc">False</code></span><span><code class="p">)</code></span><code>&#13;
</code><code> </code><span><code class="o">.</code></span><span><code class="n">head</code></span><span><code class="p">(</code></span><span><code class="mi">5</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
business_id  date    &#13;
64859        20150924    2&#13;
87440        20160801    2&#13;
77427        20170706    2&#13;
19           20160513    1&#13;
71416        20171213    1&#13;
dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The combination of restaurant ID and inspection date uniquely identifies each record in this table, with the exception of three restaurants that have two records for their ID-date combination. Let’s examine the rows for restaurant <code>64859</code>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">insp</code></span><span><code class="o">.</code></span><span><code class="n">query</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">business_id == 64859 and date == 20150924</code><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>score</th>&#13;
			<th>date</th>&#13;
			<th>type</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>7742</strong></td>&#13;
			<td>64859</td>&#13;
			<td>96</td>&#13;
			<td>20150924</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>7744</strong></td>&#13;
			<td>64859</td>&#13;
			<td>91</td>&#13;
			<td>20150924</td>&#13;
			<td>routine</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>This restaurant got two different inspection scores on the same day! How could this happen? It may be that the restaurant had two inspections in one day, or it might be an error. We address these sorts of questions when we consider data quality in <a class="reference internal" data-type="xref" href="ch09.html#ch-wrangling">Chapter 9</a>. Since there are only three of these double-inspection days, we can ignore the issue until we clean the data. So the primary key would be the combination of restaurant ID and inspection date if same-day inspections are removed from the table.</p>&#13;
&#13;
<p>Note<a contenteditable="false" data-primary="foreign keys" data-type="indexterm" id="id1097"/> that the <code>business_id</code> field in the inspections table acts as a reference to the primary key in the business table. So <code>business_id</code> in <code>insp</code> is a <em>foreign key</em> because it links each record in the inspections table to a record in the business table. This means that we can readily join these two tables together.</p>&#13;
&#13;
<p>Next, we examine the granularity of the third table, the one that contains the <span class="keep-together">violations</span>:</p>&#13;
&#13;
<div class="cell tag_remove-input docutils container">&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>business_id</th>&#13;
			<th>date</th>&#13;
			<th>description</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>0</strong></td>&#13;
			<td>19</td>&#13;
			<td>20171211</td>&#13;
			<td>Inadequate food safety knowledge or lack of ce...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>19</td>&#13;
			<td>20171211</td>&#13;
			<td>Unapproved or unmaintained equipment or utensils</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>19</td>&#13;
			<td>20160513</td>&#13;
			<td>Unapproved or unmaintained equipment or utensi...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>...</strong></td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
			<td>...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>39039</strong></td>&#13;
			<td>94231</td>&#13;
			<td>20171214</td>&#13;
			<td>High risk vermin infestation [ date violation...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>39040</strong></td>&#13;
			<td>94231</td>&#13;
			<td>20171214</td>&#13;
			<td>Moderate risk food holding temperature [ dat...</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>39041</strong></td>&#13;
			<td>94231</td>&#13;
			<td>20171214</td>&#13;
			<td>Wiping cloths not clean or properly stored or ...</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<pre>&#13;
39042 rows × 3 columns</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>Looking at the first few records in this table, we see that each inspection has multiple entries. The granularity appears to be at the level of a violation found in an inspection. Reading the descriptions, we see that if corrected, a date is listed in the description within square brackets:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">viol</code></span><span><code class="o">.</code></span><span><code class="n">loc</code></span><span><code class="p">[</code></span><span><code class="mi">39039</code></span><span><code class="p">,</code></span><code> </code><span><code class="s1">'</code><code class="s1">description</code><code class="s1">'</code></span><span><code class="p">]</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
'High risk vermin infestation  [ date violation corrected: 12/15/2017 ]'&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>In brief, we have found that the three food safety tables have different granularities. Since we have identified primary and foreign keys for them, we can potentially join these tables. If we are interested in studying inspections, we can join the violations and inspections together using the business ID and inspection date. This would let us connect the number of violations found during an inspection to the inspection score.</p>&#13;
&#13;
<p>We can also reduce the inspection table to one per restaurant by selecting the most recent inspection for each restaurant. This reduced data table essentially has a granularity of restaurant and may be useful for a restaurant-based analysis. In <a class="reference internal" data-type="xref" href="ch09.html#ch-wrangling">Chapter 9</a>, we cover these kinds of actions that reshape a data table, transform columns, and create new columns.</p>&#13;
&#13;
<p>We conclude this section with a look at the shape and granularity of the DAWN survey data<a contenteditable="false" data-primary="" data-startref="ix_rest_food_dataset2" data-type="indexterm" id="id1098"/>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="DAWN Survey Shape and Granularity" data-type="sect2"><div class="sect2" id="dawn-survey-shape-and-granularity">&#13;
<h2>DAWN Survey Shape and Granularity</h2>&#13;
&#13;
<p>As noted<a contenteditable="false" data-primary="DAWN (Drug Abuse Warning Network) survey" data-type="indexterm" id="ix_dawn_survey"/> earlier in this chapter, the DAWN file has fixed-width formatting, and we need to rely on a codebook to find out where the fields are. As an example, a snippet of the codebook in <a class="reference internal" data-type="xref" href="#dawn-age">Figure 8-2</a> tells us that age appears in positions 34 and 35 in a row, and it is categorized into 11 age groups: 1 stands for age 5 and under, 2 for ages 6 to 11, …, and 11 for ages 65 and older. Also, –8 represents a missing value.</p>&#13;
&#13;
<figure><div class="figure" id="dawn-age"><img src="assets/leds_0802.png"/>&#13;
<h6><span class="label">Figure 8-2. </span>Screenshot of a portion of the DAWN coding for age</h6>&#13;
</div></figure>&#13;
&#13;
<p>Earlier, we determined that the file contains 200,000 lines and over 280 million characters, so on average, there are about 1,200 characters per line. This might be why they used a fixed-width rather than a CSV format. Think how much larger the file would be if there was a comma between every field!</p>&#13;
&#13;
<p>Given the tremendous<a contenteditable="false" data-primary="read_fwf() method" data-type="indexterm" id="id1099"/> amount of information on each line, let’s read just a few features into a dataframe. We can use the <code>pandas.read_fwf</code> method to do this. We <span class="keep-together">specify</span> the exact positions of the fields to extract, and we provide names for these fields and other information about the header and index:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">colspecs</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code><code class="p">(</code></span><span><code class="mi">0</code></span><span><code class="p">,</code></span><span><code class="mi">6</code></span><span><code class="p">)</code><code class="p">,</code></span><code> </code><span><code class="p">(</code></span><span><code class="mi">14</code></span><span><code class="p">,</code></span><span><code class="mi">29</code></span><span><code class="p">)</code><code class="p">,</code></span><code> </code><span><code class="p">(</code></span><span><code class="mi">33</code></span><span><code class="p">,</code></span><span><code class="mi">35</code></span><span><code class="p">)</code><code class="p">,</code></span><code> </code><span><code class="p">(</code></span><span><code class="mi">35</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">37</code></span><span><code class="p">)</code><code class="p">,</code></span><code> </code><span><code class="p">(</code></span><span><code class="mi">37</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">39</code></span><span><code class="p">)</code><code class="p">,</code></span><code> </code><span><code class="p">(</code></span><span><code class="mi">1213</code></span><span><code class="p">,</code></span><code> </code><span><code class="mi">1214</code></span><span><code class="p">)</code><code class="p">]</code></span><code>&#13;
</code><span><code class="n">varNames</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="p">[</code></span><span><code class="s2">"</code><code class="s2">id</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="s2">"</code><code class="s2">wt</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="s2">"</code><code class="s2">age</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="s2">"</code><code class="s2">sex</code><code class="s2">"</code></span><span><code class="p">,</code></span><code> </code><span><code class="s2">"</code><code class="s2">race</code><code class="s2">"</code></span><span><code class="p">,</code></span><span><code class="s2">"</code><code class="s2">type</code><code class="s2">"</code></span><span><code class="p">]</code></span><code>&#13;
</code><span><code class="n">dawn</code></span><code> </code><span><code class="o">=</code></span><code> </code><span><code class="n">pd</code></span><span><code class="o">.</code></span><span><code class="n">read_fwf</code></span><span><code class="p">(</code></span><span><code class="s1">'</code><code class="s1">data/DAWN-Data.txt</code><code class="s1">'</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">colspecs</code></span><span><code class="o">=</code></span><span><code class="n">colspecs</code></span><span><code class="p">,</code></span><code> </code><code>&#13;
</code><code>                   </code><span><code class="n">header</code></span><span><code class="o">=</code></span><span><code class="kc">None</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">index_col</code></span><span><code class="o">=</code></span><span><code class="mi">0</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">names</code></span><span><code class="o">=</code></span><span><code class="n">varNames</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell tag_remove-input docutils container">&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_html">&#13;
<div>&#13;
<table class="dataframe">&#13;
	<thead>&#13;
		<tr>&#13;
			<th> </th>&#13;
			<th>wt</th>&#13;
			<th>age</th>&#13;
			<th>sex</th>&#13;
			<th>race</th>&#13;
			<th>type</th>&#13;
		</tr>&#13;
		<tr>&#13;
			<th>id</th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
			<th> </th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td><strong>1</strong></td>&#13;
			<td>0.94</td>&#13;
			<td>4</td>&#13;
			<td>1</td>&#13;
			<td>2</td>&#13;
			<td>8</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>2</strong></td>&#13;
			<td>5.99</td>&#13;
			<td>11</td>&#13;
			<td>1</td>&#13;
			<td>3</td>&#13;
			<td>4</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>3</strong></td>&#13;
			<td>4.72</td>&#13;
			<td>11</td>&#13;
			<td>2</td>&#13;
			<td>2</td>&#13;
			<td>4</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>4</strong></td>&#13;
			<td>4.08</td>&#13;
			<td>2</td>&#13;
			<td>1</td>&#13;
			<td>3</td>&#13;
			<td>4</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td><strong>5</strong></td>&#13;
			<td>5.18</td>&#13;
			<td>6</td>&#13;
			<td>1</td>&#13;
			<td>3</td>&#13;
			<td>8</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>We can compare the rows in the table to the number of lines in the file:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">dawn</code></span><span><code class="o">.</code></span><span><code class="n">shape</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
(229211, 5)&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>The number<a contenteditable="false" data-primary="weights (wt) in data tables" data-type="indexterm" id="id1100"/><a contenteditable="false" data-primary="data tables" data-secondary="weights (wt) in" data-type="indexterm" id="id1101"/> of rows in the dataframe matches the number of lines in the file. That’s good. The granularity of the dataframe is a bit complicated due to the survey design. Recall that these data are part of a large scientific study, with a complex sampling scheme. A row represents an emergency room visit, so the granularity is at the emergency room visit level. However, in order to reflect the sampling scheme and be representative of the population of all drug-related ER visits in a year, weights are provided. We must apply the weight to each record when we compute summary statistics, build histograms, and fit models. (The <code>wt</code> field contains these values.)</p>&#13;
&#13;
<p>The weights take into account the chance of an ER visit like this one appearing in the sample. By “like this one” we mean a visit with similar features, such as the visitor age, race, visit location, and time of day. Let’s examine the different values in <code>wt</code>:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="n">dawn</code></span><span><code class="p">[</code></span><span><code class="s1">'</code><code class="s1">wt</code><code class="s1">'</code></span><span><code class="p">]</code></span><span><code class="o">.</code></span><span><code class="n">value_counts</code></span><span><code class="p">(</code><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output text_plain highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
wt&#13;
0.94     1719&#13;
84.26    1617&#13;
1.72     1435&#13;
         ... &#13;
1.51        1&#13;
3.31        1&#13;
3.33        1&#13;
Name: count, Length: 3500, dtype: int64&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1102">&#13;
<h1>What Do These Weights Mean?</h1>&#13;
&#13;
<p>As a simplified example, suppose you ran a survey and 45% of your respondents were under 18 years of age, but according to the US Census Bureau, only 22% of the population is under 18. You can adjust your survey responses to reflect the US population by using a small weight (22/45) for those under 18 and a larger weight (78/55) for those 18 and older. To see how we might use these weights, suppose the respondents are asked whether they use Facebook:</p>&#13;
&#13;
<table>&#13;
	<thead>&#13;
		<tr>&#13;
			<th>Facebook</th>&#13;
			<th>&lt; 18</th>&#13;
			<th>18+</th>&#13;
			<th>Total</th>&#13;
		</tr>&#13;
	</thead>&#13;
	<tbody>&#13;
		<tr>&#13;
			<td class="text-left">No</td>&#13;
			<td class="right">&#13;
			<p>1</p>&#13;
			</td>&#13;
			<td class="right">&#13;
			<p>20</p>&#13;
			</td>&#13;
			<td class="right">&#13;
			<p>21</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td class="text-left">Yes</td>&#13;
			<td class="right">&#13;
			<p>44</p>&#13;
			</td>&#13;
			<td class="right">&#13;
			<p>35</p>&#13;
			</td>&#13;
			<td class="right">&#13;
			<p>79</p>&#13;
			</td>&#13;
		</tr>&#13;
		<tr>&#13;
			<td class="text-left">Total</td>&#13;
			<td class="right">&#13;
			<p>45</p>&#13;
			</td>&#13;
			<td class="right">&#13;
			<p>55</p>&#13;
			</td>&#13;
			<td class="right">&#13;
			<p>100</p>&#13;
			</td>&#13;
		</tr>&#13;
	</tbody>&#13;
</table>&#13;
&#13;
<p>Overall, 79% of the respondents say they are Facebook users, but the sample is skewed toward the younger generation. We can adjust the estimate with the weights so that the age groups match the population. Then the adjusted percentage of Facebook users drops to:</p>&#13;
&#13;
<div data-type="equation">&#13;
<div class="math notranslate nohighlight"><math display="block"> <mo stretchy="false">(</mo> <mn>22</mn> <mrow> <mo>/</mo> </mrow> <mn>45</mn> <mo stretchy="false">)</mo> <mo>×</mo> <mn>44</mn> <mo>+</mo> <mo stretchy="false">(</mo> <mn>78</mn> <mrow> <mo>/</mo> </mrow> <mn>55</mn> <mo stretchy="false">)</mo> <mo>×</mo> <mn>35</mn> <mo>=</mo> <mn>71</mn> </math></div>&#13;
</div>&#13;
&#13;
<p>The DAWN survey uses the same idea, except that it splits the groups much more finely.</p>&#13;
</div></aside>&#13;
&#13;
<p>It is critical to include the survey weights in your analysis to get data that represents the population at large. For example, we can compare the calculation of the proportion of females among the ER visits both with and without the weights:</p>&#13;
&#13;
<div class="cell docutils container">&#13;
<div class="cell_input docutils container">&#13;
<div class="highlight-ipython3 notranslate">&#13;
<div class="highlight">&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="sa">f</code></span><span><code class="s1">'</code><code class="s1">Unweighted percent female: </code></span><span><code class="si">{</code></span><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">average</code></span><span><code class="p">(</code></span><span><code class="n">dawn</code></span><span><code class="p">[</code></span><span><code class="s2">"</code><code class="s2">sex</code><code class="s2">"</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">==</code></span><code> </code><span><code class="mi">2</code></span><span><code class="p">)</code></span><span><code class="si">:</code></span><span><code class="s1">.1%</code></span><span><code class="si">}</code></span><span><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code><span><code class="nb">print</code></span><span><code class="p">(</code></span><span><code class="sa">f</code></span><span><code class="s1">'</code><code class="s1">  Weighted percent female:</code><code class="s1">'</code></span><span><code class="p">,</code></span><code>&#13;
</code><code>      </code><span><code class="sa">f</code></span><span><code class="s1">'</code></span><span><code class="si">{</code></span><span><code class="n">np</code></span><span><code class="o">.</code></span><span><code class="n">average</code></span><span><code class="p">(</code></span><span><code class="n">dawn</code></span><span><code class="p">[</code></span><span><code class="s2">"</code><code class="s2">sex</code><code class="s2">"</code></span><span><code class="p">]</code></span><code> </code><span><code class="o">==</code></span><code> </code><span><code class="mi">2</code></span><span><code class="p">,</code></span><code> </code><span><code class="n">weights</code></span><span><code class="o">=</code></span><span><code class="n">dawn</code></span><span><code class="p">[</code></span><span><code class="s2">"</code><code class="s2">wt</code><code class="s2">"</code></span><span><code class="p">]</code><code class="p">)</code></span><span><code class="si">:</code></span><span><code class="s1">.1%</code></span><span><code class="si">}</code></span><span><code class="s1">'</code></span><span><code class="p">)</code></span><code>&#13;
</code></pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<div class="cell_output docutils container">&#13;
<div class="output stream highlight-myst-ansi notranslate">&#13;
<div class="highlight">&#13;
<pre data-type="programlisting">&#13;
Unweighted percent female: 48.0%&#13;
  Weighted percent female: 52.3%&#13;
</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
&#13;
<p>These figures differ by more than 4 percentage points. The weighted version is a more accurate estimate of the proportion of females among the entire population of drug-related ER visits.</p>&#13;
&#13;
<p>Sometimes the granularity can be tricky to figure out, like we saw with the inspections data. And at other times, we need to take sampling weights into account, like for the DAWN data. These examples show it’s important to take your time and review the data descriptions before proceeding with analysis<a contenteditable="false" data-primary="" data-startref="ix_data_table_gran" data-type="indexterm" id="id1103"/><a contenteditable="false" data-primary="" data-startref="ix_dawn_survey" data-type="indexterm" id="id1104"/><a contenteditable="false" data-primary="" data-startref="ix_shape_data_table" data-type="indexterm" id="id1105"/><a contenteditable="false" data-primary="" data-startref="ix_files_wr_shape" data-type="indexterm" id="id1106"/><a contenteditable="false" data-primary="" data-startref="ix_gran_data_table" data-type="indexterm" id="id1107"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="ch-files-summary">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>Data wrangling is an essential part of data analysis. Without it, we risk overlooking problems in data that can have major consequences for future analysis. This chapter covered an important first step in data wrangling: reading data from a plain-text source file into a Python dataframe and identifying its granularity. We introduced different types of file formats and encodings, and we wrote code that can read data from these formats. We checked the size of source files and considered alternative tools for working with large datasets.</p>&#13;
&#13;
<p>We also introduced command-line tools as an alternative to Python for checking the format, encoding, and size of a file. These CLI tools are especially handy for filesystem-oriented tasks because of their simple syntax. We’ve only touched the surface of what CLI tools can do. In practice, the shell is capable of sophisticated data processing and is well worth learning.</p>&#13;
&#13;
<p>Understanding the shape and granularity of a table gives us insight into what a row in a data table represents. This helps us determine whether the granularity is mixed, aggregation is needed, or weights are required. After looking at the granularity of your dataset, you should have answers to the following questions:</p>&#13;
&#13;
<dl>&#13;
	<dt>What does a record represent?</dt>&#13;
	<dd>Clarity on this will help you correctly analyze data and state your findings.</dd>&#13;
	<dt>Do all records in a table capture granularity at the same level?</dt>&#13;
	<dd>Sometimes a table contains additional summary rows that have a different granularity, and you want to use only those rows that are at the right level of detail.</dd>&#13;
	<dt>If the data are aggregated, how was the aggregation performed?</dt>&#13;
	<dd>Summing and averaging are common types of aggregation. With averaged data, the variability in the measurements is typically reduced and relationships often appear stronger.</dd>&#13;
	<dt>What kinds of aggregations might you perform on the data?</dt>&#13;
	<dd>Aggregations might be useful or necessary to combine one data table with another.</dd>&#13;
</dl>&#13;
&#13;
<p>Knowing your table’s granularity is a first step to cleaning your data, and it informs you of how to analyze the data. For example, we saw the granularity of the DAWN survey is an ER visit. That naturally leads us to think about comparisons of patient demographics to the US as a whole<a contenteditable="false" data-primary="" data-startref="ix_files_wr_ch8" data-type="indexterm" id="id1108"/>.</p>&#13;
&#13;
<p>The wrangling techniques in this chapter help us bring data from a source file into a dataframe and understand its structure. Once we have a dataframe, further wrangling is needed to assess and improve quality and prepare the data for analysis. We cover these topics in the next chapter.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id1015"><sup><a href="ch08.html#id1015-marker">1</a></sup> In 2020, the city began giving restaurants color-coded placards indicating whether the restaurant passed (green), conditionally passed (yellow), or failed (red) the inspection. These new placards no longer display a numeric inspection score. However, a restaurant’s scores and violations are still available at DataSF.</p></div></div></section></body></html>