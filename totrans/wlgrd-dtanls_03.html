<html><head></head><body>
<div id="sbo-rt-content"><div class="readable-text" id="p1">
<h1 class="readable-text-h1"><span class="chapter-title-numbering"><span class="num-string">4</span></span> <span class="chapter-title-text">Metrics</span></h1>
</div>
<div class="introduction-summary">
<h3 class="introduction-header sigil_not_in_toc">This chapter covers</h3>
<ul>
<li class="readable-text" id="p2">Defining metrics to set your projects up for success</li>
<li class="readable-text" id="p3">Identifying bad metrics that measure the wrong things</li>
<li class="readable-text" id="p4">Evaluating the effects of your chosen metrics</li>
</ul>
</div>
<div class="readable-text" id="p5">
<p>At some point in your career, you will likely be asked to create and maintain a dashboard that tracks key performance indicators (KPIs) for the business. That’s because there is so much going on in a business that simple, summary-level metrics are the most common way to measure and analyze what is happening. Rather than getting detailed verbal summaries from every business unit or employee, executives look at which direction figures such as turnover, profit, or margin are trending.</p>
</div>
<div class="callout-container sidebar-container">
<div class="readable-text" id="p6">
<h5 class="callout-container-h5 readable-text-h5 sigil_not_in_toc">Real business case: Defining key business metrics</h5>
</div>
<div class="readable-text" id="p7">
<p>An important metric in the used car auction domain, where I worked for years, is conversion. The business had multiple analyses and dashboards dedicated to questions about conversion.</p>
</div>
<div class="readable-text" id="p8">
<p>Conversion was used to measure the percentage of cars in an auction we were able to sell for our customers, the vendors. This seems straightforward, but it turned out that people across the business did not agree on a definition of conversion, especially when aggregating multiple auction events. There was also a separate but related metric called “first-time conversion,” which was even harder for stakeholders to agree on.</p>
</div>
<div class="readable-text" id="p9">
<p>What started as a simple metric turned into a large project where multiple areas of the business were corralled to define these fundamental terms. Metric definitions are crucial, and they form the basis of this chapter’s project.</p>
</div>
</div>
<div class="readable-text intended-text" id="p10">
<p>The metrics we choose define everything we do, from the executive board down to the individual analyst, so we need to be sure that they are well defined.</p>
</div>
<div class="readable-text" id="p11">
<h2 class="readable-text-h2" id="sigil_toc_id_42"><span class="num-string">4.1</span> The importance of well-defined metrics</h2>
</div>
<div class="readable-text" id="p12">
<p>Sometimes, you will be asked to measure and track a metric that is insufficiently defined or ill suited to the problem. The first step in any analysis, and our results-driven approach, is to understand the problem—in this case, the metric we are being asked to measure. Words such as “best” (e.g., “what’s the best month to run an advertising campaign?”) are giveaways that something hasn’t been properly defined.</p>
</div>
<div class="readable-text intended-text" id="p13">
<p>Some of the common ways the use of metrics can go wrong are</p>
</div>
<ul>
<li class="readable-text" id="p14"> Overreliance on a metric has unintended consequences. An example would be social media platforms trying to maximize users’ attention as their key metric. This incentivizes clickbait and content that elicits strong emotions. </li>
<li class="readable-text" id="p15"> The metric doesn’t incorporate every important element of the business. Schools being incentivized to maximize student attendance rather than the quality of education is one example. </li>
<li class="readable-text" id="p16"> The metric doesn’t measure the intended outcome. A common measure of customer satisfaction is the net promoter score or NPS. The way this score is calculated means only users who give a 9 or 10 out of 10 are deemed “promoters” and even scores of 8 out of 10 are discarded. This means it is possible to get a high average score but a low NPS, which can be misleading. </li>
</ul>
<div class="readable-text" id="p17">
<p>In each of these cases, the solution is to either choose a metric that better captures all aspects of the problem, choose additional metrics to complement the single chosen metric, or, ideally, choose both. We should always be skeptical of single metrics that claim to perfectly summarize a complex problem and look at solutions from different angles instead.</p>
</div>
<div class="readable-text intended-text" id="p18">
<p>Single metrics can give us at-a-glance views of an entire business’s operations, but the oversimplification often has consequences. A relevant aphorism, Goodhart’s law, states, “When a measure becomes a target, it ceases to be a good measure.” Once you start optimizing for a single metric, it becomes a bad metric to use as a measurement. This does not mean using simplifying metrics is wrong, but only that we should understand the consequences.</p>
</div>
<div class="readable-text intended-text" id="p19">
<p>The project in this chapter explores this idea; it is all about defining metrics based on a vague stakeholder request, so let’s dive right in.</p>
</div>
<div class="readable-text" id="p20">
<h2 class="readable-text-h2" id="sigil_toc_id_43"><span class="num-string">4.2</span> Project 3: Defining precise metrics for better decision making</h2>
</div>
<div class="readable-text" id="p21">
<p>Let’s take a look at the project, in which we will be asked to define and calculate metrics to find the best-performing products. The data is available for you to attempt it yourself at <a href="https://davidasboth.com/book-code">https://davidasboth.com/book-code</a>. You will find the datasets you can use to attempt the project, as well as the example solution in the form of a Jupyter notebook.</p>
</div>
<div class="readable-text intended-text" id="p22">
<p>First, let’s look at the problem statement and examine the business context.</p>
</div>
<div class="readable-text" id="p23">
<h3 class="readable-text-h3" id="sigil_toc_id_44"><span class="num-string">4.2.1</span> Problem statement</h3>
</div>
<div class="readable-text" id="p24">
<p>In this scenario, you are a junior analyst working for an e-commerce startup, Online Odyssey Outlet. If you have already attempted the project in chapter 3, it is in fact the same sort of startup. The data will be of a similar, if not identical, structure.</p>
</div>
<div class="readable-text print-book-callout" id="p25">
<p><span class="print-book-callout-head">NOTE </span> Thanks again to REES46 for providing the original transaction data (<a href="https://mng.bz/6eZo">https://mng.bz/6eZo</a>), which has only been altered for this project by filtering it to a manageable size by removing “view” events and only keeping registered users (those with a valid <code>user_id</code>).</p>
</div>
<div class="readable-text" id="p26">
<p>The date is January 2020, and the startup has just been through its first winter sale. Senior stakeholders are interested in knowing which products performed best during the Christmas period so that they can streamline the products they advertise in future sale periods. You will do this by analyzing up to two months of events data, presented as two separate data sources with identical structures. Events refer not just to sales but to more general customer actions, such as viewing a product on the website or placing it into their virtual cart.</p>
</div>
<div class="readable-text intended-text" id="p27">
<p>The challenge is that, when pressed, stakeholders aren’t exactly sure what they mean by “best.” In an initial brainstorming session, they highlight some aspects they care about when ranking their products:</p>
</div>
<ul>
<li class="readable-text" id="p28"> Volume of sales </li>
<li class="readable-text" id="p29"> Total revenue from a single product </li>
<li class="readable-text" id="p30"> Popularity, measured by the number of unique customers who bought a product </li>
<li class="readable-text" id="p31"> Conversion, meaning the percentage of time a product is bought once it has been placed in the virtual shopping cart </li>
<li class="readable-text" id="p32"> Products with increased performance from November to December </li>
</ul>
<div class="readable-text" id="p33">
<p>Your stakeholders do not assign weights to these factors, so their relative importance is unclear, but you should consider one or more of these metrics when presenting your findings. They are also open to suggestions for additional metrics that would help improve the performance of future sales.</p>
</div>
<div class="readable-text" id="p34">
<h3 class="readable-text-h3" id="sigil_toc_id_45"><span class="num-string">4.2.2</span> Data dictionary</h3>
</div>
<div class="readable-text" id="p35">
<p>Table 4.1 shows the data dictionary for the events data, and figure 4.1 shows some sample data. The November and December events are in separate tables but have the same structure and are therefore easily combined.<span class="aframe-location"/></p>
</div>
<div class="browsable-container browsable-table-container framemaker-table-container" id="p36">
<h5 class="browsable-container-h5 sigil_not_in_toc"><span class="num-string">Table 4.1</span> Data dictionary for events data</h5>
<table>
<thead>
<tr>
<th>
<div>
         Column 
       </div></th>
<th>
<div>
         Description 
       </div></th>
</tr>
</thead>
<tbody>
<tr>
<td> <code>event_time</code> <br/></td>
<td>  The date and time of the transaction <br/></td>
</tr>
<tr>
<td> <code>event_type</code> <br/></td>
<td>  The type of the user event, either <code>cart</code> (the customer placed a product into their cart) or <code>purchase</code> (the customer bought the item) <br/></td>
</tr>
<tr>
<td> <code>product_id</code> <br/></td>
<td>  The unique identifier of the product <br/></td>
</tr>
<tr>
<td> <code>category_id</code> <br/></td>
<td>  The unique identifier of the product category <br/></td>
</tr>
<tr>
<td> <code>category_code</code> <br/></td>
<td>  A code that describes the product’s main and subcategories <br/></td>
</tr>
<tr>
<td> <code>brand</code> <br/></td>
<td>  The brand of the product (if applicable) <br/></td>
</tr>
<tr>
<td> <code>price</code> <br/></td>
<td>  The price of the product (listed price when adding to cart, or sold price when the event is <code>purchase</code>) in USD <br/></td>
</tr>
<tr>
<td> <code>user_id</code> <br/></td>
<td>  The unique identifier of the registered customer <br/></td>
</tr>
<tr>
<td> <code>user_session</code> <br/></td>
<td>  The unique identifier of the user’s browsing session <br/></td>
</tr>
</tbody>
</table>
</div>
<div class="browsable-container figure-container" id="p37">
<img alt="figure" height="616" src="../Images/4-1.png" width="989"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.1</span> A snapshot of the events data</h5>
</div>
<div class="readable-text" id="p38">
<h3 class="readable-text-h3" id="sigil_toc_id_46"><span class="num-string">4.2.3</span> Desired outcomes</h3>
</div>
<div class="readable-text" id="p39">
<p>The output of the analysis should be recommendations of the best-performing products on whichever dimension(s) you choose. The recommendation could be for single product IDs or broader ones relating to brands or product categories, as long as your choice of best product is justified in your analysis. The recommendation could be presented to a stakeholder in any format. This could be a whole presentation deck, some choice visualizations, or even just data tables produced by your analysis tool.</p>
</div>
<div class="callout-container sidebar-container">
<div class="readable-text" id="p40">
<h5 class="callout-container-h5 readable-text-h5 sigil_not_in_toc">Activity: Presentation</h5>
</div>
<div class="readable-text" id="p41">
<p>Think about how you would present your findings. What format would be most appropriate? What details would your stakeholders be most interested in hearing? Crucially, what unnecessary details would you want to leave out? Knowing how to summarize your work for the right audience is an important analyst skill to practice.</p>
</div>
</div>
<div class="readable-text" id="p42">
<h3 class="readable-text-h3" id="sigil_toc_id_47"><span class="num-string">4.2.4</span> Required tools</h3>
</div>
<div class="readable-text" id="p43">
<p>For this chapter’s example solution, I will use the Python library <code>pandas</code> to read and manipulate the datasets, the <code>numpy</code> library for additional numerical computations, and <code>matplotlib</code> to create visualizations. As with each of the projects, the specific technology you use does not matter as long as it satisfies the criteria for each project. For this project, you need a tool that can</p>
</div>
<ul>
<li class="readable-text" id="p44"> Load a dataset in the order of millions of rows from CSV files </li>
<li class="readable-text" id="p45"> Create new columns and manipulate existing ones </li>
<li class="readable-text" id="p46"> Combine (union) two datasets of the same structure </li>
<li class="readable-text" id="p47"> Perform basic manipulation tasks such as sorting, grouping, and reshaping data </li>
<li class="readable-text" id="p48"> Create data visualizations (optional) </li>
</ul>
<div class="readable-text" id="p49">
<h2 class="readable-text-h2" id="sigil_toc_id_48"><span class="num-string">4.3</span> Applying the results-driven method to different metric definitions</h2>
</div>
<div class="readable-text" id="p50">
<p>Let’s use the results-driven approach again to break the problem down. In a problem that is as open ended as this one, it is particularly important to understand what our stakeholders want from the analysis. We need to understand the minimum viable answer that would be acceptable to present and could form the basis for future work iterations.</p>
</div>
<div class="browsable-container figure-container" id="p51">
<img alt="figure" height="175" src="../Images/4-unnumb-1.png" width="529"/>
</div>
<div class="readable-text" id="p52">
<p><em><span class="aframe-location"/></em>This step is always critical before starting the work itself, but even more so in open-ended questions like this one. What would it mean to focus on the different metrics the stakeholders have suggested?</p>
</div>
<ul>
<li class="readable-text" id="p53"> Focusing on volume alone could overinflate the importance of products that people simply buy in bulk more than others. </li>
<li class="readable-text" id="p54"> Focusing on total revenue alone could overemphasize expensive products. </li>
<li class="readable-text" id="p55"> Prioritizing popularity might simply reveal products that everyone buys, such as smartphones, clothes, or kitchen appliances. However, it might help distinguish the “better” products from similar ones in their category (i.e., we can assume almost everyone will buy a smartphone, but not the same one). </li>
<li class="readable-text" id="p56"> Focusing on conversion would highlight products that people are less likely to change their minds on, but it is unclear if that has a direct relationship with “best performance” particularly. </li>
<li class="readable-text" id="p57"> Comparing performance between November and December specifically would target the stakeholders’ questions directly since they asked about best performers over the Christmas period. </li>
</ul>
<div class="browsable-container figure-container" id="p58">
<img alt="figure" height="175" src="../Images/4-unnumb-2.png" width="529"/>
</div>
<div class="readable-text" id="p59">
<p><em><span class="aframe-location"/></em>This step forces us to think about the output of our work before we even begin. In this case, the output has not been explicitly defined. However, we know that our minimum viable answer should contain</p>
</div>
<ul>
<li class="readable-text" id="p60"> Measurements of our chosen metrics at a product level (e.g., a table of total revenue in December by product, sorted in descending revenue order) </li>
<li class="readable-text" id="p61"> A ranking so we can highlight top performers </li>
<li class="readable-text" id="p62"> Justifications for which metrics were chosen </li>
<li class="readable-text" id="p63"> A summary of our findings in tabular or visual form </li>
<li class="readable-text" id="p64"> Recommendations for further iterations (if requested) </li>
</ul>
<div class="readable-text" id="p65">
<p>These end goals help us identify what to focus on during our analysis, so we are less likely to unnecessarily go down rabbit holes.</p>
</div>
<div class="browsable-container figure-container" id="p66">
<img alt="figure" height="175" src="../Images/4-unnumb-3.png" width="1075"/>
</div>
<div class="readable-text" id="p67">
<p><em><span class="aframe-location"/></em>As in chapter 3, our data has been provided for us, and there is nothing to explicitly identify or obtain. However, one task we might want to perform here is to check whether all the possible metrics can be measured with the available data. This can be done by looking at the data dictionary and verifying our assumptions during the analysis. One choice to make is whether to focus on December’s events only or include the November data so that we can compare product performance before and during the Christmas period. In future iterations, we might also request data from the previous year to do a year-on-year comparison, which is not possible with the available data.</p>
</div>
<div class="browsable-container figure-container" id="p68">
<img alt="figure" height="175" src="../Images/4-unnumb-4.png" width="529"/>
</div>
<div class="readable-text" id="p69">
<p><em><span class="aframe-location"/></em>During the analysis, some steps to consider are</p>
</div>
<ul>
<li class="readable-text" id="p70"> Merge the November and December data if we decide to investigate those comparison metrics. </li>
<li class="readable-text buletless-item" id="p71"> Explore the events data. We are specifically interested in questions like 
    <ul>
<li> What makes a product unique? Is its ID sufficient, and is the ID truly a unique identifier? Some product catalogs might have the same product ID listed multiple times for different color variants, in which case ID would not be sufficient as a unique identifier. </li>
<li> Are there any gaps in our data (e.g., dates for which we do not have events)? Identifying gaps would help us understand the limitations of the available data. </li>
<li> What are the generally best-performing categories/subcategories/brands? This will help determine if our later results make sense in context. </li>
<li> What is the distribution of product price? Are there outliers to investigate further? This is particularly important if we choose to explore product revenue. </li>
<li> What are some baselines for product popularity and conversion? Again, knowing the conversion rate for a typical product or how many people generally buy something will help put results into context. </li>
</ul></li>
<li class="readable-text" id="p72"> Aggregate the data to a product level since the raw data is at a transaction level </li>
<li class="readable-text" id="p73"> Calculate the chosen metrics for each product </li>
<li class="readable-text" id="p74"> Compare products across multiple metrics if we have chosen to measure more than one </li>
<li class="readable-text" id="p75"> Summarize our findings in tabular or visual form </li>
<li class="readable-text" id="p76"> Recommend further work in case stakeholders want to dive deeper into the problem based on our findings </li>
</ul>
<div class="browsable-container figure-container" id="p77">
<img alt="figure" height="175" src="../Images/4-unnumb-5.png" width="529"/>
</div>
<div class="readable-text" id="p78">
<p><em><span class="aframe-location"/></em>When presenting our findings, we want to focus on summarizing our method, our chosen metrics, and the resulting best products. The important aspect to focus on is “so what?” Our findings should be presented in a way that suggests concrete action that can be taken. Telling a stakeholder that socks tend to sell well all year round with a spike of sales around Christmas is unlikely to be news to them. If we choose to create slides, we should aim for three to four slides with a natural flow, succinct messages, and appropriate visualizations. In our code, that means we should create visualizations that most effectively communicate our findings.</p>
</div>
<div class="browsable-container figure-container" id="p79">
<img alt="figure" height="175" src="../Images/4-unnumb-6.png" width="529"/>
</div>
<div class="readable-text" id="p80">
<p><em><span class="aframe-location"/></em>We generally want to present our findings to a stakeholder as soon as we have a minimum viable answer. This might mean iterating before our analysis is complete. However, in this instance, the possible metrics to investigate are well defined, and we should have a value calculated for each metric across our products and perhaps summarized across categories and brands, too. That way, when discussing future iterations, we could focus on metrics beyond those already suggested.</p>
</div>
<div class="readable-text" id="p81">
<h3 class="readable-text-h3" id="sigil_toc_id_49"><span class="num-string">4.3.1</span> Questions to consider</h3>
</div>
<div class="readable-text" id="p82">
<p>During this analysis, you should always be thinking about the following:</p>
</div>
<ul>
<li class="readable-text" id="p83"> What is the definition of each chosen metric? Words like “volume” or “revenue” sound self-explanatory, but they need to be strictly defined before they are calculated. </li>
<li class="readable-text" id="p84"> What are the effects of choosing a particular metric as the definition for “best”? What should “best” measure, and how will our definition be useful to our stakeholders? </li>
</ul>
<div class="readable-text" id="p85">
<h2 class="readable-text-h2" id="sigil_toc_id_50"><span class="num-string">4.4</span> An example solution: Finding the best performing products</h2>
</div>
<div class="readable-text" id="p86">
<p>Let’s go through an example solution to the problem. As with every project, I encourage you to attempt the project yourself before reviewing the solution and bear in mind this is one of many possible ways to tackle the problem. The order of the exploratory steps is not always important. You may choose to investigate different aspects of the data first compared to what I have chosen, and again, that is to be expected.</p>
</div>
<div class="readable-text intended-text" id="p87">
<p>As for our action plan, we will first combine the November and December events and explore the combined data, resolving any data problems along the way. Next, we will aggregate the data to produce a product-level dataset. We can then define and calculate multiple metrics to see how product rankings differ among the different metrics. Finally, we will summarize our findings to see what initial recommendations we can make to our stakeholders.</p>
</div>
<div class="readable-text" id="p88">
<h3 class="readable-text-h3" id="sigil_toc_id_51"><span class="num-string">4.4.1</span> Combining and exploring product data</h3>
</div>
<div class="readable-text" id="p89">
<p>Because our two datasets, November and December events, are identical in structure, we will explore the data only once they have been combined. Let’s start there:</p>
</div>
<div class="browsable-container listing-container" id="p90">
<div class="code-area-container">
<pre class="code-area">import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

november = pd.read_csv("./data/november.csv.gz")
december = pd.read_csv("./data/december.csv.gz")

events = pd.concat([november, december], axis=0, ignore_index=True)
print(events.shape)</pre>
</div>
</div>
<div class="readable-text" id="p91">
<p>Here, we use the <code>pandas</code> library to concatenate the two datasets. If you are familiar with SQL, this is the equivalent of a union operation. The output of the code is <code>(7033125,</code> <code>9)</code>, meaning we have over 7 million rows and nine columns of data.</p>
</div>
<div class="readable-text intended-text" id="p92">
<p>Now it’s time for some basic sanity checks of the data. Do we have any missing values? Figure 4.2 shows the output of looking for missing data:</p>
</div>
<div class="browsable-container listing-container" id="p93">
<div class="code-area-container">
<pre class="code-area">events.isnull().sum()<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p94">
<img alt="figure" height="256" src="../Images/4-2.png" width="274"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.2</span> The number of rows with missing values for each column in our events data</h5>
</div>
<div class="readable-text" id="p95">
<p>We have some user sessions missing, which means we don’t know which unique browsing session those 27 events belong to. That shouldn’t affect our analysis as we’re interested in products, so we can leave those rows in. The same goes for the <code>brand</code> column—missing values aren’t necessarily a worry at this stage because we don’t yet know to what extent we will use that information.</p>
</div>
<div class="readable-text intended-text" id="p96">
<p>Let’s start building our diagram to record our steps. So far, we completed the step shown in figure 4.3.<span class="aframe-location"/></p>
</div>
<div class="browsable-container figure-container" id="p97">
<img alt="figure" height="429" src="../Images/4-3.png" width="927"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.3</span> The first step in our analysis, visualized</h5>
</div>
<div class="readable-text" id="p98">
<p>It’s time to move on and validate different assumptions in our data, including ones about the date range and product categorization.</p>
</div>
<div class="readable-text" id="p99">
<h4 class="readable-text-h4 sigil_not_in_toc">Validating assumptions in the data</h4>
</div>
<div class="readable-text" id="p100">
<p>Our next assumption is that we really do have November and December data, which we should verify independently. Figure 4.4 shows the output of checking for the date range in our data:</p>
</div>
<div class="browsable-container listing-container" id="p101">
<div class="code-area-container code-area-with-html">
<pre class="code-area">events["event_time"] = pd.to_datetime(events["event_time"],
<span class="">↪</span> format="%Y-%m-%d %H:%M:%S %Z")
events["event_time"].agg(["min", "max"])<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p102">
<img alt="figure" height="85" src="../Images/4-4.png" width="545"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.4</span> The date range in our data</h5>
</div>
<div class="readable-text" id="p103">
<p>Our data is in the expected range (November 1 through December 31), but we still don’t know if we have event data for every single date in between. The following code calculates the number of unique days for each month, the output of which is shown in figure 4.5:</p>
</div>
<div class="browsable-container listing-container" id="p104">
<div class="code-area-container">
<pre class="code-area">(
    events
    .assign(month=events["event_time"].dt.month,
            day=events["event_time"].dt.day)     <span class="aframe-location"/> #1
    .groupby("month")
    ["day"]
    .nunique()    <span class="aframe-location"/> #2
)<span class="aframe-location"/></pre>
<div class="code-annotations-overlay-container">
     #1 Using the assign function to create temporary columns for day and month
     <br/>#2 The nunique function calculates the number of unique days per month.
     <br/>
</div>
</div>
</div>
<div class="browsable-container figure-container" id="p105">
<img alt="figure" height="114" src="../Images/4-5.png" width="306"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.5</span> The unique number of days encountered per month</h5>
</div>
<div class="readable-text" id="p106">
<p>The output is what we’d expect, so we have at least one event for each day in our data. Finally, we also want to know if the number of events is consistent across these days. The following code calculates and visualizes this, and the output chart is shown in figure 4.6:</p>
</div>
<div class="browsable-container listing-container" id="p107">
<div class="code-area-container">
<pre class="code-area">fig, axis = plt.subplots(figsize=(10, 6))

(
    events
    .assign(month=events["event_time"].dt.month,
            day=events["event_time"].dt.day)
    .groupby(["month", "day"])
    .size()
    .plot
    .bar(ax=axis)
)

labels = (
    pd.date_range(                  <span class="aframe-location"/> #1
        events["event_time"].dt.date.min(),
        events["event_time"].dt.date.max(),
        freq="D")
    .strftime("%b %d")    <span class="aframe-location"/> #2
)

axis.set(title="Number of events per calendar day",
         xlabel="Number of rows",
         ylabel="Calendar day",
         xticklabels=labels)

plt.show()<span class="aframe-location"/></pre>
<div class="code-annotations-overlay-container">
     #1 Creates custom axis labels based on dates in the data
     <br/>#2 Formats labels as “month day” (e.g., “Nov 1”)
     <br/>
</div>
</div>
</div>
<div class="browsable-container figure-container" id="p108">
<img alt="figure" height="727" src="../Images/4-6.png" width="1100"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.6</span> Number of events per calendar day, visualized</h5>
</div>
<div class="readable-text" id="p109">
<p>Our data clearly shows a wide range of volumes across the days. What we’re interested in with this chart is whether there are any outliers in either direction. There are seven low-activity days, and they correspond to the first week of November. This could mean customers hadn’t been using the platform as often yet, and knowing exactly when the startup launched the website would help put this into context. There are also three days of particularly high activity in mid-November. Again, this could be because of an organic increase in user engagement or a social media post that went viral. It could be artificial due to an advertising campaign that ran at that time, or there could have been a sale on. Without further information, we are only speculating, but it is the kind of speculating we would need to do upon seeing these results.</p>
</div>
<div class="readable-text intended-text" id="p110">
<p>The next column to turn our attention to is the event type. What is the proportion of the different events in our data? Figure 4.7 shows the output of the following code:</p>
</div>
<div class="browsable-container listing-container" id="p111">
<div class="code-area-container">
<pre class="code-area">events["event_type"].value_counts(dropna=False)<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p112">
<img alt="figure" height="90" src="../Images/4-7.png" width="380"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.7</span> The proportion of different event types</h5>
</div>
<div class="readable-text" id="p113">
<p>In a typical e-commerce environment, there is a funnel of events from users exploring, then placing items into a cart, and finally purchasing them. As expected, in this case, we observe that this funnel narrows, meaning we see much fewer purchase events than cart ones.</p>
</div>
<div class="readable-text intended-text" id="p114">
<p>Time to turn our attention to the product catalog and investigate what kind of products the e-commerce platform offers. First, what is the typical price range for our products? Figure 4.8 shows the output of our investigation into prices:</p>
</div>
<div class="browsable-container listing-container" id="p115">
<div class="code-area-container">
<pre class="code-area">fig, axis = plt.subplots()

(
    events["price"]
    .hist(bins=25, ax=axis)
)

axis.ticklabel_format(useOffset=False, style='plain')<span class="aframe-location"/> #1

axis.set(title="Distribution of product price",
         xlabel="Product price ($)",
         ylabel="Frequency")

plt.show()<span class="aframe-location"/></pre>
<div class="code-annotations-overlay-container">
     #1 Disables scientific notation
     <br/>
</div>
</div>
</div>
<div class="browsable-container figure-container" id="p116">
<img alt="figure" height="812" src="../Images/4-8.png" width="1100"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.8</span> The distribution of product prices</h5>
</div>
<div class="readable-text" id="p117">
<p>This output is common in price data, that is, a clustering of small values and a long skew to the right. This means most of our products are listed or sold under $500, with some outliers up to $2,500.</p>
</div>
<div class="readable-text" id="p118">
<p>What about brands? Figure 4.9 shows the top 10 brands obtained with the following code. Missing brands are intentionally not included:</p>
</div>
<div class="browsable-container listing-container" id="p119">
<div class="code-area-container">
<pre class="code-area">events["brand"].value_counts().head(10)<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p120">
<img alt="figure" height="309" src="../Images/4-9.png" width="323"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.9</span> Top 10 brands by number of events</h5>
</div>
<div class="readable-text" id="p121">
<p>At a glance, this suggests most of our user events are focused on the technology category. The actual makeup of our unique product catalog might differ, as might the top 10 brands if we only look at purchase events. Now that we’ve looked at brands, let’s also take a look at product categories.</p>
</div>
<div class="readable-text" id="p122">
<h4 class="readable-text-h4 sigil_not_in_toc">Investigating consistency of product categories</h4>
</div>
<div class="readable-text" id="p123">
<p>Are our products correctly categorized? This is a question that we should ask every time we have a dataset with IDs and associated assigned categories. One way to check this is to ask, do we have any product IDs that are assigned to multiple categories? The following code investigates this, and the output is shown in figure 4.10:</p>
</div>
<div class="browsable-container listing-container" id="p124">
<div class="code-area-container">
<pre class="code-area">(
    events
    .groupby("product_id")
    ["category_code"]
    .nunique()                    <span class="aframe-location"/> #1
    .loc[lambda x: x &gt; 1]         <span class="aframe-location"/> #2
    .sort_values(ascending=False)
)<span class="aframe-location"/></pre>
<div class="code-annotations-overlay-container">
     #1 First, counts the number of unique category codes encountered per product ID
     <br/>#2 Finds instances where that count is more than 1
     <br/>
</div>
</div>
</div>
<div class="browsable-container figure-container" id="p125">
<img alt="figure" height="388" src="../Images/4-10.png" width="653"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.10</span> The result of investigating products assigned to multiple categories</h5>
</div>
<div class="readable-text" id="p126">
<p>As we can see, almost 13,000 products are assigned to multiple categories. This suggests there is an error somewhere in our underlying product catalog. Let’s look at the top category codes to investigate further. Figure 4.11 shows the output of looking at the top 10 most common category codes:</p>
</div>
<div class="browsable-container listing-container" id="p127">
<div class="code-area-container">
<pre class="code-area">events["category_code"].value_counts().head(10)<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p128">
<img alt="figure" height="323" src="../Images/4-11.png" width="580"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.11</span> Top 10 category codes by number of rows</h5>
</div>
<div class="readable-text" id="p129">
<p>This doesn’t necessarily mean most of our products are in the “light construction tools” category because this is the number of events, not the number of unique products, but it does suggest a problem similar to the one we uncovered in figure 4.10. Let’s look at how brand and category codes intersect by looking at the top 10 brands in this “light construction tools” category. The following code produces the output in figure 4.12:</p>
</div>
<div class="browsable-container listing-container" id="p130">
<div class="code-area-container">
<pre class="code-area">(
    events
    .loc[events["category_code"] == "construction.tools.light", "brand"]
    .value_counts()
    .head(10)
)<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p131">
<img alt="figure" height="306" src="../Images/4-12.png" width="322"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.12</span> Top 10 brands in the <code>construction.tools.light</code> category</h5>
</div>
<div class="readable-text" id="p132">
<p>Unless technology manufacturers have secretly branched out into construction tools, we have a problem with our product categories. Most of these brands are typically known for smartphones, and we can look at some examples to verify this. The following code finds all product IDs that have multiple codes against them so that we know which ones to focus on. Figure 4.13 shows a sample of this subset of product IDs:</p>
</div>
<div class="browsable-container listing-container" id="p133">
<div class="code-area-container">
<pre class="code-area">dupe_product_ids = (
    events
    .groupby("product_id")
    ["category_code"]
    .nunique()
    .loc[lambda x: x &gt; 1]
    .index
    .values
)

dupe_product_ids[:10]<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p134">
<img alt="figure" height="65" src="../Images/4-13.png" width="867"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.13</span> A subset of product IDs with multiple assigned categories</h5>
</div>
<div class="readable-text" id="p135">
<p>From this subset of data, we can find instances where one category is “light construction tools” and see what other categories that product is assigned to. An example is shown in the following code and figure 4.14:</p>
</div>
<div class="browsable-container listing-container" id="p136">
<div class="code-area-container">
<pre class="code-area">(
    events.loc[events["product_id"] == 1001588,
               "category_code"]
    .value_counts()
)<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p137">
<img alt="figure" height="93" src="../Images/4-14.png" width="420"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.14</span> Breakdown of categories for a particular erroneous product</h5>
</div>
<div class="readable-text" id="p138">
<p>In this instance, we have a smartphone that is also incorrectly categorized as a construction tool. We have a major decision to make now: How do we handle these products? We have several options:</p>
</div>
<ul>
<li class="readable-text" id="p139"> <em>Ignore this problem</em> —The downside is we won’t be able to use the category code to investigate top-performing products since we know it is often incorrectly assigned. </li>
<li class="readable-text" id="p140"> <em>Drop products that are incorrectly categorized</em> —The problem is this could be a significant portion of our data. </li>
<li class="readable-text" id="p141"> <em>Fix the product categorization</em> —This seems like the best approach, but we might not have enough information to find the correct category for each product. </li>
</ul>
<div class="readable-text" id="p142">
<p>In reality, we would want more information about how these product categories came about and, ideally, fix the problem at the source. However, in this case, we only have this data to work with, so let’s attempt a fix using the data we have.</p>
</div>
<div class="readable-text" id="p143">
<h4 class="readable-text-h4 sigil_not_in_toc">Correcting inconsistencies in data categories</h4>
</div>
<div class="readable-text" id="p144">
<p>Our plan of action is to find products with duplicate categories, and for cases where one category is <code>construction.tools.light</code>, we use the other category. In instances where we have duplication that doesn’t involve the <code>construction.tools.light</code> category, we would need to investigate accordingly or use the majority one. For example, if a product ID is mostly categorized as a refrigerator but is sometimes categorized as a smartphone, we overwrite the data so that the product ID is always in the refrigerator category. There is the danger that we incorrectly categorize some products, but we will also fix the problem with the construction tools category.</p>
</div>
<div class="readable-text intended-text" id="p145">
<p>The following code defines a method to fix the category codes of a single product ID and applies it to all the duplicated product ID data. The output is a new category code for each of the affected product IDs, as shown in figure 4.15:</p>
</div>
<div class="browsable-container listing-container" id="p146">
<div class="code-area-container">
<pre class="code-area">def get_correct_category_code(product_id_rows):
    categories = product_id_rows["category_code"].value_counts()<span class="aframe-location"/> #1

    if "construction.tools.light" in categories.index:<span class="aframe-location"/> #2
        return categories.index.drop("construction.tools.light").values[0]
    else:
        return categories.index[0]<span class="aframe-location"/> #3

corrected_categories = (
    events[events["product_id"].isin(dupe_product_ids)]
    .groupby("product_id")
    .apply(get_correct_category_code)
    .reset_index(name="corrected_category")
)

corrected_categories.head()<span class="aframe-location"/></pre>
<div class="code-annotations-overlay-container">
     #1 product_id_rows contains all rows for a product ID so we can find the two categories associated with this ID.
     <br/>#2 If one is construction.tools.light, return the other one.
     <br/>#3 Otherwise, return the majority category.
     <br/>
</div>
</div>
</div>
<div class="browsable-container figure-container" id="p147">
<img alt="figure" height="256" src="../Images/4-15.png" width="396"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.15</span> A preview of the data we will use to correct product ID categories</h5>
</div>
<div class="readable-text" id="p148">
<p>As figure 4.15 shows, we have plenty of products that should be smartphones but aren’t always categorized that way. Now, we will join this corrected category data to our original events dataset and overwrite the categories where the original and the corrected categories do not match. To verify our changes, we will look at the top category codes again and compare our results to figure 4.11. The following code produces a similar result, as shown in figure 4.16:</p>
</div>
<div class="browsable-container listing-container" id="p149">
<div class="code-area-container code-area-with-html">
<pre class="code-area">events = events.merge(corrected_categories, on="product_id", how="left")
events.loc[events["corrected_category"].notnull(), "category_code"] = \
<span class="">↪</span> events.loc[events["corrected_category"].notnull(), "corrected_category"]

events["category_code"].value_counts()<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p150">
<img alt="figure" height="336" src="../Images/4-16.png" width="588"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.16</span> A breakdown of category codes after applying our fixes</h5>
</div>
<div class="readable-text" id="p151">
<p>Now, our data mostly consists of smartphones, which is more in line with our findings around the most popular brands. It is important to note that we may have inflated the prevalence of smartphones because we made specific assumptions about how to fix our data, which may not be correct. However, we do not have enough information in the available data to investigate this further.</p>
</div>
<div class="readable-text intended-text" id="p152">
<p>Upon inspection, this category code column also contains a “main” category, corresponding to the first part of the string up to the first period character, that may be useful in our analysis, so let’s isolate it. The output of the following code shows the breakdown of this main category, as shown in figure 4.17:</p>
</div>
<div class="browsable-container listing-container" id="p153">
<div class="code-area-container">
<pre class="code-area">events["category"] = events["category_code"].str.split(".").str[0]

events = events.rename(columns={"category_code": "subcategory"})

events["category"].value_counts()<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p154">
<img alt="figure" height="405" src="../Images/4-17.png" width="380"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.17</span> A breakdown of the “main” category of products</h5>
</div>
<div class="readable-text" id="p155">
<p>This table further convinces us that most of our products are electronics of some kind. Before we continue to summarize our data at the product level, we will want to make sure that a particular product ID only ever refers to one product. We will come to this step soon. Before we move on, let’s summarize our work so far. Figure 4.18 shows the steps we have taken and where our decisions could have diverged.<span class="aframe-location"/></p>
</div>
<div class="browsable-container figure-container" id="p156">
<img alt="figure" height="619" src="../Images/4-18.png" width="617"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.18</span> The steps in our analysis so far</h5>
</div>
<div class="readable-text" id="p157">
<p>Another way products are categorized is with their brand. We should also investigate whether there are any product IDs that have multiple brands against them. Considering that we have missing data for the <code>brand</code> column, this seems like a relevant step to take.</p>
</div>
<div class="readable-text" id="p158">
<h4 class="readable-text-h4 sigil_not_in_toc">Investigate consistency of brand labels</h4>
</div>
<div class="readable-text" id="p159">
<p>Here, to investigate whether each product only has one brand attached to it, we follow a process very similar to when we did this for product categories. The output of the following code is shown in figure 4.19:</p>
</div>
<div class="browsable-container listing-container" id="p160">
<div class="code-area-container">
<pre class="code-area">duplicated_brands = (
    events
    .assign(brand = events["brand"].fillna("No brand"))  <span class="aframe-location"/> #1
    .groupby("product_id")
    ["brand"]
    .nunique()
    .loc[lambda x: x &gt; 1]
    .index
)

print(len(duplicated_brands))

duplicated_brands[:10]<span class="aframe-location"/></pre>
<div class="code-annotations-overlay-container">
     #1 Temporarily fills missing brand data with a placeholder because the nunique function ignores missing values
     <br/>
</div>
</div>
</div>
<div class="browsable-container figure-container" id="p161">
<img alt="figure" height="124" src="../Images/4-19.png" width="869"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.19</span> The result of investigating products labeled with multiple brands</h5>
</div>
<div class="readable-text" id="p162">
<p>There are 1,245 products in our catalog that have either two different brands against them or have the <code>brand</code> column missing some of the time. To clean this data up, we will apply logic similar to what we used for categories: for products with multiple brands against them, we pick the majority non-null brand. The following code block implements this logic, and the output is a mapping of product IDs to the brand they should be assigned to. A subset of this output is shown in figure 4.20:</p>
</div>
<div class="browsable-container listing-container" id="p163">
<div class="code-area-container">
<pre class="code-area">def get_correct_brand(product_id_rows):
    brand_counts = product_id_rows["brand"].value_counts(dropna=False)<span class="aframe-location"/> #1

    if isinstance(brand_counts.index[0], str):
        return brand_counts.index[0]<span class="aframe-location"/> #2

    if len(brand_counts) == 1:
        return np.nan<span class="aframe-location"/> #3

    return brand_counts.index[1]<span class="aframe-location"/> #4

corrected_brands = (
    events[events["product_id"].isin(duplicated_brands)]
    .groupby("product_id")
    .apply(get_correct_brand)
    .reset_index(name="corrected_brand")
)

corrected_brands.head()<span class="aframe-location"/></pre>
<div class="code-annotations-overlay-container">
     #1 product_id_rows contains all rows for a product ID, so we can find the brands associated with this ID. Using value_counts will give us only non-NA values.
     <br/>#2 If there are no NA values, just return the majority brand.
     <br/>#3 Now, if np.NaN is the only value, return it.
     <br/>#4 Otherwise, return the second value (the majority non-null value).
     <br/>
</div>
</div>
</div>
<div class="browsable-container figure-container" id="p164">
<img alt="figure" height="251" src="../Images/4-20.png" width="341"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.20</span> Product IDs against the brand to which they should be allocated</h5>
</div>
<div class="readable-text" id="p165">
<p>Similarly to how we handled categories, we can join these corrected brands to the original events data and overwrite the <code>brand</code> column where necessary.</p>
</div>
<div class="readable-text" id="p166">
<h4 class="readable-text-h4 sigil_not_in_toc">Correcting inconsistencies in brand labels</h4>
</div>
<div class="readable-text" id="p167">
<p>We do this with the following code, after which we verify whether there are any product IDs that still have multiple combinations of brand and category. The expected output is that there are no such product IDs, and the number of unique product ID, category, and brand combinations should match the number of unique product IDs. Running the following code block does not result in an assertion error, meaning the condition is met, and product IDs are finally categorized in a unique way:</p>
</div>
<div class="browsable-container listing-container" id="p168">
<div class="code-area-container">
<pre class="code-area">events = events.merge(corrected_brands, on="product_id", how="left")
events.loc[events["corrected_brand"].notnull(), "brand"] = \
    events.loc[events["corrected_brand"].notnull(), "corrected_brand"]

assert (
    len(events[["product_id", "category", "subcategory", "brand"]]
        .drop_duplicates())
    ==
    events["product_id"].nunique()
)</pre>
</div>
</div>
<div class="readable-text" id="p169">
<p>In the remainder of the project, we will be working with product-level data, so a useful step is to give each product a more descriptive name, especially because we don’t have a “product name” column. Each product ID should have a unique name, meaning the product ID should be a part of the name since that’s what makes products unique in our dataset. We can combine the product’s ID, brand, and category code to get a more readable string for each product. The following code does this, and an output of the data with this additional column is shown in figure 4.21:</p>
</div>
<div class="browsable-container listing-container" id="p170">
<div class="code-area-container">
<pre class="code-area">def get_product_name(row):
    brand = ""

    if isinstance(row["brand"], str): <span class="aframe-location"/> #1
        brand = row["brand"]

    return f"{str(row['product_id'])} - {brand} {row['subcategory']}" 

events["product_name"] = events.apply(get_product_name, axis=1)

events.head()<span class="aframe-location"/></pre>
<div class="code-annotations-overlay-container">
     #1 Only include brand if it's available.
     <br/>
</div>
</div>
</div>
<div class="browsable-container figure-container" id="p171">
<img alt="figure" height="503" src="../Images/4-21.png" width="1100"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.21</span> A snapshot of the new columns added to the events data</h5>
</div>
<div class="readable-text" id="p172">
<p>Finally, we may wish to export this modified data to an intermediate dataset, which we can use for analysis. Some of the operations so far may take a few minutes due to the size of the data, and we do not want that to be a bottleneck every time we come back to work on our analysis.</p>
</div>
<div class="readable-text" id="p173">
<h4 class="readable-text-h4 sigil_not_in_toc">Exporting an intermediate data model to separate data cleaning from analysis</h4>
</div>
<div class="readable-text" id="p174">
<p>It is good practice to separate the code that cleans the data from the code that analyzes it. One way to do this is to output the cleaned data to a separate file, which the analysis code can read directly.</p>
</div>
<div class="readable-text intended-text" id="p175">
<p>The intermediate data can be any format, but <em>parquet</em> is useful because it is a compressed data format that stores type information, unlike other formats, such as CSVs. This means that when we read in a parquet file in the future, we do not have to convert date columns to date types as our code will already know about them:</p>
</div>
<div class="browsable-container listing-container" id="p176">
<div class="code-area-container">
<pre class="code-area">events.to_parquet("./data/events.parquet.gz", compression="gzip")</pre>
</div>
</div>
<div class="readable-text" id="p177">
<p>Let’s summarize this part of the analysis before moving on. Figure 4.22 shows the steps we have taken so far, up to the point where we exported our intermediate dataset. Notice that our investigations into categories and brands are represented side by side because they are independent of each other and could have been done in any order.<span class="aframe-location"/></p>
</div>
<div class="browsable-container figure-container" id="p178">
<img alt="figure" height="846" src="../Images/4-22.png" width="924"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.22</span> All the steps in part 1 of our analysis</h5>
</div>
<div class="readable-text intended-text" id="p179">
<p>Now, we are ready to move on to part 2 of our solution, which is summarizing data to the product level and calculating all the relevant metrics.</p>
</div>
<div class="readable-text" id="p180">
<h3 class="readable-text-h3" id="sigil_toc_id_52"><span class="num-string">4.4.2</span> Calculating product-level metrics</h3>
</div>
<div class="readable-text" id="p181">
<p>We have explored and cleaned our data and are now ready to start looking at our desired metrics. However, first we need to transform data to be at the right granularity.</p>
</div>
<div class="readable-text" id="p182">
<h4 class="readable-text-h4 sigil_not_in_toc">Changing the granularity of the data to suit the question</h4>
</div>
<div class="readable-text" id="p183">
<p>The raw data is at the event level, and we are interested in products, so we should aggregate the data to be one row per product. In doing so, we need to define various aggregations to summarize data at the right level. To understand what aggregations we need, we must define our metrics precisely. Based on our project brief, the metrics we will calculate are</p>
</div>
<ul>
<li class="readable-text" id="p184"> <em>Volume</em> —The count of purchase events for a given product ID. We do not have a “quantity” column, meaning if a particular user bought the same product twice, there would be two separate rows in the data to indicate this. Therefore, counting rows that correspond to purchase events is how we can count the sales volume for a product. </li>
<li class="readable-text" id="p185"> <em>Revenue</em> —The sum of the <code>price</code> column. We have no information about shipping costs, wholesale cost of products, or the amount of tax, so we can only calculate the gross total income from each product. </li>
<li class="readable-text" id="p186"> <em>Popularity</em> —The number of unique users who bought a product. This will ignore cases where a single user bought multiples of a product but is a good proxy for popularity. </li>
<li class="readable-text" id="p187"> <em>Change in performance</em> —For this, we will simply calculate each metric separately for November and December events. </li>
<li class="readable-text" id="p188"> <em>Conversion</em> —Given the data, it will be defined as the number of purchase events as a percentage of cart events in a given period. That is, out of all the times someone put an item into a cart, what percentage became a purchase event? Ideally, we would also consider what percentage of viewed items turned into sales, but we do not have the data to answer that question. </li>
</ul>
<div class="readable-text" id="p189">
<p>Conversion is a tricky metric because the denominator can be interpreted in multiple ways. For example, if a user puts an item into the cart, removes it, then adds it again, and finally purchases it, we may have two events contributing to the denominator instead of one. Our choice of whether to deduplicate these events as a single instance or to use both rows will affect our conversion figures. Here, when calculating conversion, we will keep things simple and count all cart events as our denominator and all purchase events as our numerator.</p>
</div>
<div class="readable-text intended-text" id="p190">
<p>Given the kinds of metrics we are interested in, our aggregations at a product level will include</p>
</div>
<ul>
<li class="readable-text" id="p191"> November and December data separately for month-on-month comparison </li>
<li class="readable-text" id="p192"> Sum of the <code>price</code> column for revenue </li>
<li class="readable-text" id="p193"> Count of rows for volume </li>
<li class="readable-text" id="p194"> Number of unique users for popularity </li>
<li class="readable-text" id="p195"> The difference between the monthly figures </li>
<li class="readable-text" id="p196"> Number of cart and purchase events so we can calculate conversion </li>
</ul>
<div class="readable-text" id="p197">
<p>For all but the conversion metrics, we only need the purchase events. It is only when introducing conversion that we want to look at cart events as well. Therefore, to make our code more efficient, we will calculate most of the metrics on the purchases before calculating conversion metrics separately and joining them afterward.</p>
</div>
<div class="readable-text intended-text" id="p198">
<p>To do this, we need to separate the cart events data from the purchase events:</p>
</div>
<div class="browsable-container listing-container" id="p199">
<div class="code-area-container">
<pre class="code-area">purchases = events[events["event_type"] == "purchase"].copy()
carts = events[events["event_type"] == "cart"].copy()</pre>
</div>
</div>
<div class="readable-text" id="p200">
<p>Now, let’s construct a league table (ranking system) of metrics at the individual product level step by step.</p>
</div>
<div class="readable-text" id="p201">
<h4 class="readable-text-h4 sigil_not_in_toc">Calculating multiple metrics at once</h4>
</div>
<div class="readable-text" id="p202">
<p>Creating this league table will be a dense piece of code because it is where we end up doing more of our calculations, so let’s deconstruct it into its individual steps. First, we create new indicator columns to calculate monthly values. Indicators are columns that contain either a value or a fallback value like 0 if a row of data does not meet the desired criteria. In this case, <code>november_revenue</code> will contain the value from the <code>price</code> column if the event is in November. Otherwise, it will contain 0. Calculating the sum of this column for a given product ID will therefore give us the total revenue for November alone. The following code creates the indicator columns:</p>
</div>
<div class="browsable-container listing-container" id="p203">
<div class="code-area-container code-area-with-html">
<pre class="code-area">purchases
    .assign(
        november_count=np.where(purchases["event_time"].dt.month==11,
<span class="">↪</span> 1, 0),
        november_revenue=np.where(purchases["event_time"].dt.month==11, 
<span class="">↪</span> purchases["price"], 0),
        november_user_id=np.where(purchases["event_time"].dt.month==11, 
<span class="">↪</span> purchases["user_id"], np.nan),
        december_count=np.where(purchases["event_time"].dt.month==12,
<span class="">↪</span> 1, 0),
        december_revenue=np.where(purchases["event_time"].dt.month==12, 
<span class="">↪</span> purchases["price"], 0),
        december_user_id=np.where(purchases["event_time"].dt.month==12, 
<span class="">↪</span> purchases["user_id"], np.nan))</pre>
</div>
</div>
<div class="readable-text" id="p204">
<p>Next, we group our data by product ID and summarize these new indicator columns to get monthly revenue, row count, and unique user ID count:</p>
</div>
<div class="browsable-container listing-container" id="p205">
<div class="code-area-container">
<pre class="code-area">.groupby(["product_id", "product_name"])
    .agg(november_volume=('november_count', 'sum'),
         november_revenue=('november_revenue', 'sum'),
         november_users=('november_user_id', 'nunique'),
         december_volume=('december_count', 'sum'),
         december_revenue=('december_revenue', 'sum'),
         december_users=('december_user_id', 'nunique')
    )</pre>
</div>
</div>
<div class="readable-text" id="p206">
<p>Finally, we create new columns that calculate the difference between November and December figures. This gives us all our desired metrics that only require the purchase events data. It is this dataset to which we will join our conversion metrics. Here is the final complete code block, and figure 4.23 shows a snapshot of the created league table:</p>
</div>
<div class="browsable-container listing-container" id="p207">
<div class="code-area-container code-area-with-html">
<pre class="code-area">purchases_league_table = (
    purchases
    .assign(
        november_count=np.where(purchases["event_time"].dt.month==11,
<span class="">↪</span> 1, 0),
        november_revenue=np.where(purchases["event_time"].dt.month==11, 
<span class="">↪</span> purchases["price"], 0),
        november_user_id=np.where(purchases["event_time"].dt.month==11, 
<span class="">↪</span> purchases["user_id"], np.nan),
        december_count=np.where(purchases["event_time"].dt.month==12, 
<span class="">↪</span> 1, 0),
        december_revenue=np.where(purchases["event_time"].dt.month==12, 
<span class="">↪</span> purchases["price"], 0),
        december_user_id=np.where(purchases["event_time"].dt.month==12, 
<span class="">↪</span> purchases["user_id"], np.nan))
    .groupby(["product_id", "product_name"])
    .agg(november_volume=('november_count', 'sum'),
         november_revenue=('november_revenue', 'sum'),
         november_users=('november_user_id', 'nunique'),
         december_volume=('december_count', 'sum'),
         december_revenue=('december_revenue', 'sum'),
         december_users=('december_user_id', 'nunique')
    )
    .assign(
        volume_diff=lambda x:
            x["december_volume"] - x["november_volume"],
        revenue_diff=lambda x:
            x["december_revenue"] - x["november_revenue"],
        users_diff=lambda x:
            x["december_users"] - x["november_users"])
    .reset_index()
)

purchases_league_table.head()<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p208">
<img alt="figure" height="577" src="../Images/4-23.png" width="1100"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.23</span> A snapshot of the purchases league table data</h5>
</div>
<div class="readable-text" id="p209">
<p>From this table, we get a lot of information at a glance, including</p>
</div>
<ul>
<li class="readable-text" id="p210"> Products that sold more in November than in December and vice versa </li>
<li class="readable-text" id="p211"> Products that did not sell at all in November but did sell in December </li>
<li class="readable-text" id="p212"> Products bought by more or fewer customers month-on-month </li>
</ul>
<div class="readable-text" id="p213">
<p>In some ways, we could even stop here and use this table to answer our questions by simply sorting it based on the column that we believe represents our metric for the best product. However, we also wanted to calculate conversion metrics first. The following code calculates the number of rows per event type for each product ID per month:</p>
</div>
<div class="browsable-container listing-container" id="p214">
<div class="code-area-container code-area-with-html">
<pre class="code-area">conversion_table = (
    pd.pivot_table(
        data=events.assign(month=events["event_time"].dt.month),
        index=["product_id", "product_name"],
        columns=["month", "event_type"],
        values="user_session",
        aggfunc="count"
    )
    .fillna(0)
    .set_axis(labels=["november_cart", "november_sold",
<span class="">↪</span> "december_cart", "december_sold"],
              axis=1)
    .reset_index()
    .assign(november_conversion
<span class="">↪</span> = lambda x: x["november_sold"] / x["november_cart"],
            december_conversion
<span class="">↪</span> = lambda x: x["december_sold"] / x["december_cart"])
)

conversion_table.head()</pre>
</div>
</div>
<div class="readable-text" id="p215">
<p>Using the <code>pivot_table</code> function in <code>pandas</code> means this table would extend to counting any number of event types and could be used if we were to obtain data for view events as well. This isn’t strictly necessary here, but it requires a bit of prophylactic coding to prepare for future eventualities. Figure 4.24 shows a snapshot of this conversion league table.<span class="aframe-location"/></p>
</div>
<div class="browsable-container figure-container" id="p216">
<img alt="figure" height="652" src="../Images/4-24.png" width="980"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.24</span> A snapshot of the conversion league table data</h5>
</div>
<div class="readable-text intended-text" id="p217">
<p>From this snapshot, we have already found a problem; this data will contain missing values. Having no cart or purchase events results in a missing value, rather than a zero, because strictly speaking, 0 conversion would mean we had cart events, and none of them resulted in a purchase. Whenever you calculate a division, you should also be prepared to encounter infinity values, which happen when you try to divide by zero.</p>
</div>
<div class="readable-text intended-text" id="p218">
<p>For now, let’s merge these two product league tables and ensure that product IDs are unique. Figure 4.25 shows the output when we look at the columns in this merged metrics dataset:</p>
</div>
<div class="browsable-container listing-container" id="p219">
<div class="code-area-container code-area-with-html">
<pre class="code-area">league_table = purchases_league_table.merge(conversion_table,
<span class="">↪</span> on=["product_id", "product_name"], how="left")
assert len(league_table) == purchases["product_id"].nunique()
league_table.dtypes<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p220">
<img alt="figure" height="483" src="../Images/4-25.png" width="368"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.25</span> Columns in our metrics table and their data types</h5>
</div>
<div class="readable-text" id="p221">
<p>Let’s add these latest steps to our growing diagram to show our analytical steps. Figure 4.26 shows the latest version. I put the investigations of product brands and categories alongside one another to indicate that they happen independently and don’t necessarily follow each other in a specific order.<span class="aframe-location"/></p>
</div>
<div class="browsable-container figure-container" id="p222">
<img alt="figure" height="1646" src="../Images/4-26.png" width="1054"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.26</span> Steps taken so far up to the creation of the metrics league table</h5>
</div>
<div class="readable-text" id="p223">
<p>Now, we have all the metrics we could be interested in, and the next step is to look at products that perform well.</p>
</div>
<div class="readable-text" id="p224">
<h3 class="readable-text-h3" id="sigil_toc_id_53"><span class="num-string">4.4.3</span> Finding the best products using our defined metrics</h3>
</div>
<div class="readable-text" id="p225">
<p>With all these metrics in place, how do we use them to find the “best” product? The answer is, as is often the case, it depends.</p>
</div>
<div class="readable-text" id="p226">
<h4 class="readable-text-h4 sigil_not_in_toc">Defining metrics based on the specific question</h4>
</div>
<div class="readable-text" id="p227">
<p>We have multiple options, such as</p>
</div>
<ul>
<li class="readable-text" id="p228"> Picking a single metric to sort the league table by and thinking of the top <em>N</em> products as being the best. </li>
<li class="readable-text" id="p229"> We could weight each metric by its relative importance, create a weighted combination of metric values to come up with a single value to define each product, and use that value to find the top <em>N</em>. </li>
<li class="readable-text" id="p230"> If we care specifically about December performers, we could look at outliers in our difference metrics, such as the difference in volume between November and December. </li>
</ul>
<div class="readable-text" id="p231">
<p>There are many more options, but since the brief was specifically about the December sale period, we will focus our efforts on products that showed the biggest month-on-month increases. For which of the metrics should we focus on this difference? Our options are</p>
</div>
<ul>
<li class="readable-text" id="p232"> <em>Change in revenue</em> —Focusing on absolute revenue might mean expensive items skew our results. </li>
<li class="readable-text" id="p233"> <em>Change in the number of unique users</em> —This might be a good measure for products that perform better month-on-month. </li>
<li class="readable-text" id="p234"> <em>Change in volume</em> —This seems like a solid, logical place to start as simply selling more of an item month-on-month is an indicator of good performance. </li>
</ul>
<div class="readable-text" id="p235">
<p>We should first understand the typical month-on-month change in volume. Figure 4.27 shows the histogram produced by the following code:</p>
</div>
<div class="browsable-container listing-container" id="p236">
<div class="code-area-container">
<pre class="code-area">fig, axis = plt.subplots()

league_table["volume_diff"].hist(bins=100, ax=axis)

axis.set(title="Distribution of month-on-month change in volume",
         xlabel="Change in volume from November to December",
         ylabel="Frequency")<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p237">
<img alt="figure" height="838" src="../Images/4-27.png" width="1100"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.27</span> Histogram of month-on-month change in product sales volume</h5>
</div>
<div class="readable-text" id="p238">
<p>Clearly, there are outliers that skew this histogram beyond usefulness. Let’s zoom into the middle to see if the month-on-month change is centered around zero. The following code produces the histogram in figure 4.28:</p>
</div>
<div class="browsable-container listing-container" id="p239">
<div class="code-area-container code-area-with-html">
<pre class="code-area">fig, axis = plt.subplots()

league_table.loc[league_table["volume_diff"].between(-100,100),
<span class="">↪</span> "volume_diff"].hist(bins=100, ax=axis)

axis.set(title="Distribution of month-on-month change in volume",
         xlabel="Change in volume from November to December",
         ylabel="Frequency")<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p240">
<img alt="figure" height="839" src="../Images/4-28.png" width="1100"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.28</span> A zoomed-in version of the histogram from figure 4.27</h5>
</div>
<div class="readable-text" id="p241">
<p>Looking at this histogram more closely, we see that most products haven’t changed much in sales volume month-on-month, and some products sold more, while others sold less. However, these are absolute values. Products that generally sell only a handful per month would be underrepresented in these graphs. Therefore, we should really calculate and look at the percentage change in sales volume. The following code calculates this value and produces a histogram of percentage change, as shown in figure 4.29. Note the code also removes missing percentage change values, as well as infinity values produced when dividing by zero:</p>
</div>
<div class="browsable-container listing-container" id="p242">
<div class="code-area-container">
<pre class="code-area">league_table["volume_diff_pct"] = (
    100 * (league_table["volume_diff"] / league_table["november_volume"])
)

fig, axis = plt.subplots()

(
    league_table["volume_diff_pct"]
    .replace([np.inf, -np.inf], np.nan)
    .dropna()
    .loc[lambda x: x.between(-101,501)]
    .hist(bins=50, ax=axis)
)

axis.set(
    title="Distribution of month-on-month percentage change in volume",
    xlabel="% difference between sales in November and December",
    ylabel="Frequency"
)<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p243">
<img alt="figure" height="567" src="../Images/4-29.png" width="765"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.29</span> Distribution of percentage month-on-month change in sales volume</h5>
</div>
<div class="readable-text" id="p244">
<p>This chart shows us that most products seem to have actually sold nothing in December versus November since a –100% change means zero items sold in December. There are also products that sold two, three, four, and five times more month-on-month. With percentage values, we need to be mindful of biases that can arise. For example, if we sold one of a product in November and five in December, that is a 500% change but is unlikely to be as significant as selling 1,000 of something when we sold only 500 in the previous month, although that is technically a smaller percentage change. One way to mitigate this problem is to exclude items that only typically sell a handful.</p>
</div>
<div class="readable-text intended-text" id="p245">
<p>Before we continue our analysis, however, we should include additional product details in our league table so that when we identify high performers, we can look at what categories or brands they represent.</p>
</div>
<div class="readable-text" id="p246">
<h4 class="readable-text-h4 sigil_not_in_toc">Iterating on our metrics based on our findings</h4>
</div>
<div class="readable-text" id="p247">
<p>We could have enhanced our products with this additional data when creating the league table, but we are doing it at this stage of the analysis in response to our desire to investigate further. The following code creates a product catalog, which we can join to our league table to add additional product details. Figure 4.30 shows a snapshot of this product catalog:</p>
</div>
<div class="browsable-container listing-container" id="p248">
<div class="code-area-container code-area-with-html">
<pre class="code-area">product_catalog = (
    events[["product_id", "product_name", "category_id", "subcategory",
<span class="">↪</span> "brand", "category"]]
    .drop_duplicates(subset=["product_id", "product_name", "subcategory",
<span class="">↪</span> "brand", "category"])
)

assert len(product_catalog) == events["product_id"].nunique()

print(product_catalog.shape)
product_catalog.head()<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p249">
<img alt="figure" height="641" src="../Images/4-30.png" width="892"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.30</span> A snapshot of the product catalog</h5>
</div>
<div class="readable-text" id="p250">
<p>Now, we continue our analysis by defining cutoffs for how many of a particular product we must have sold to consider it when we look for top performers. <span class="aframe-location"/>Discounting products that only sell a handful at a time means that high percentage change values are more likely to be meaningful:</p>
</div>
<div class="browsable-container listing-container" id="p251">
<div class="code-area-container">
<pre class="code-area">DEC_VS_NOV_PCT_CUTOFF = 200
NOV_VOLUME_CUTOFF = 10
ONLY_DEC_VOLUME_CUTOFF = 100

december_high_performers = (
    pd.concat(
    [
        league_table[(np.isinf(league_table["volume_diff_pct"]) == False)
            &amp; (league_table["november_volume"] &gt; NOV_VOLUME_CUTOFF)
            &amp; (league_table["volume_diff_pct"] &gt; DEC_VS_NOV_PCT_CUTOFF)],
        league_table[(np.isinf(league_table["volume_diff_pct"]))
            &amp; (league_table["december_volume"] &gt; ONLY_DEC_VOLUME_CUTOFF)]
    ],
    axis=0,
    ignore_index=True)
    .merge(product_catalog.drop(columns="product_name"), on="product_id")
)

print(december_high_performers.shape)</pre>
</div>
</div>
<div class="readable-text" id="p252">
<p>Here, we defined some cutoffs that mean we only consider products that<span class="aframe-location"/></p>
</div>
<ul>
<li class="readable-text" id="p253"> Sold at least twice as many in December as November </li>
<li class="readable-text" id="p254"> Sold at least 10 in November </li>
<li class="readable-text" id="p255"> Sold at least 100 in December </li>
</ul>
<div class="readable-text" id="p256">
<p>These cutoffs are somewhat arbitrary, and changing them will change our results, but they do ensure we only identify products that really did outperform themselves in December. Our particular choice of cutoffs resulted in 449 products. We could provide these directly to our stakeholders, or we could do further analysis to see what kinds of products show up more often as high performers. Let us look at the top categories, subcategories, and brands among these high-performing products. These are shown in figures 4.31 through 4.33, respectively:</p>
</div>
<div class="browsable-container listing-container" id="p257">
<div class="code-area-container">
<pre class="code-area">from IPython.display import display

for col in ["category", "subcategory", "brand"]:
    print(col)
    display(december_high_performers[col].value_counts())<span class="aframe-location"/><span class="aframe-location"/><span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p258">
<img alt="figure" height="441" src="../Images/4-31.png" width="360"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.31</span> Top-performing product categories</h5>
</div>
<div class="browsable-container figure-container" id="p259">
<img alt="figure" height="366" src="../Images/4-32.png" width="524"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.32</span> Top-performing product subcategories</h5>
</div>
<div class="browsable-container figure-container" id="p260">
<img alt="figure" height="395" src="../Images/4-33.png" width="499"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.33</span> Top-performing product brands</h5>
</div>
<div class="readable-text" id="p261">
<p>It appears that smartphones, various kinds of clothing, and products made by Lucente top the rankings in terms of December’s best performers. There are also some coffee grinders that appear to have performed well. In fact, digging into the results a bit more suggests that these coffee grinders account for most of Lucente’s success in the league table. The following code shows the top unique combinations of category, subcategory, and brand, as shown in figure 4.34:</p>
</div>
<div class="browsable-container listing-container" id="p262">
<div class="code-area-container code-area-with-html">
<pre class="code-area">december_high_performers[["category", "subcategory", "brand"]]
<span class="">↪</span> .value_counts().head(10)<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p263">
<img alt="figure" height="359" src="../Images/4-34.png" width="823"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.34</span> Top-performing products by category and brand</h5>
</div>
<div class="readable-text" id="p264">
<p>One aspect of this final table that might catch the eye is the presence of shoes made by Sony, which may warrant some investigation. They could be legitimate Sony-branded shoes or products categorized incorrectly.</p>
</div>
<div class="readable-text intended-text" id="p265">
<p>We now have enough results to present to stakeholders. To recap, we have</p>
</div>
<ul>
<li class="readable-text" id="p266"> Combined the events datasets </li>
<li class="readable-text" id="p267"> Cleaned up incorrectly categorized product data </li>
<li class="readable-text" id="p268"> Calculated all possible metrics of interest </li>
<li class="readable-text" id="p269"> Decided what to use as a measure of “best” </li>
<li class="readable-text" id="p270"> Extracted the highest-performing products based on our chosen metric </li>
<li class="readable-text" id="p271"> Investigated these high performers in more detail </li>
</ul>
<div class="readable-text" id="p272">
<p>Whichever metric(s) you chose, the process would have been similar to that shown in this example solution. We are unlikely to have reached the same conclusions because those depend entirely on your analytical choices throughout.</p>
</div>
<div class="readable-text intended-text" id="p273">
<p>Let us briefly look at what happens when we use a different metric to define the best product and how that affects our results.</p>
</div>
<div class="readable-text" id="p274">
<h4 class="readable-text-h4 sigil_not_in_toc">Investigating alternative metric definitions</h4>
</div>
<div class="readable-text" id="p275">
<p>What happens if we decide the best products are the ones that converted the most cart events into purchase ones in the month of December? First, we use the following code to produce the histogram in figure 4.35, showing the distribution of December conversion:</p>
</div>
<div class="browsable-container listing-container" id="p276">
<div class="code-area-container code-area-with-html">
<pre class="code-area">fig, axis = plt.subplots()

(
    league_table[(np.isinf(league_table["december_conversion"]) == False)
<span class="">↪</span> &amp; (np.isnan(league_table["december_conversion"]) == False)]
    ["december_conversion"]
    .mul(100)
    .hist(bins=50, ax=axis)
)

axis.set(
    title="Distribution of December conversion",
    xlabel="Conversion (%)",
    ylabel="Frequency"
)<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p277">
<img alt="figure" height="850" src="../Images/4-35.png" width="1100"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.35</span> Distribution of conversion percentage in December</h5>
</div>
<div class="readable-text" id="p278">
<p>Most products convert at around the 30% mark, but a lot of products convert at 100% and even more. That latter option shouldn’t be possible since we should logically not have more products purchased than were put into a cart. Let’s investigate these records. The following code extracts only rows with over 99% conversion and excludes infinite values and other data errors. Using those results, we examine a single example of high conversion, shown in figure 4.36:</p>
</div>
<div class="browsable-container listing-container" id="p279">
<div class="code-area-container code-area-with-html">
<pre class="code-area">(
    league_table[(np.isinf(league_table["december_conversion"]) == False)
                 &amp; (np.isnan(league_table["december_conversion"]) == False)
                 &amp; (league_table["december_conversion"] &gt; 0.99)]
    .sort_values("december_conversion", ascending=False)
    .head(20)
)
events[(events["product_id"] == 9200694)
<span class="">↪</span> &amp; (events["event_time"].dt.month == 12)]<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p280">
<img alt="figure" height="519" src="../Images/4-36.png" width="1100"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.36</span> An example of raw data leading to over 100% conversion</h5>
</div>
<div class="readable-text" id="p281">
<p>There is a scarf that was bought three times by the same user on two different dates but with only one associated cart event. This could mean either a data error where we are missing two cart events or that we made incorrect assumptions about the data-generating process. When we said conversion should not be over 100%, we assumed a linear process where a user cannot make a purchase without putting an item into their cart. However, it is possible there is an “orders” page where a user could review their past orders and reorder products, while bypassing the cart screens. If this were the case, the data shown in figure 4.35 would not be unexpected.</p>
</div>
<div class="readable-text intended-text" id="p282">
<p>As it stands, we have no way of knowing whether these instances are valid, so to get our top performers, we can simply restrict our data to under 100% conversion. Let us also stipulate some cutoffs and say that a product must have been bought by at least <em>N</em> users with a total of <em>M</em> sales to be included in our top conversion performers. The following code identifies the top performers, totaling 55 rows:</p>
</div>
<div class="browsable-container listing-container" id="p283">
<div class="code-area-container code-area-with-html">
<pre class="code-area">MIN_USERS = 5
MIN_PURCHASES = 10
CONVERSION_LOWER_LIMIT = 0.7

best_december_converters = (
    league_table[(np.isinf(league_table["december_conversion"]) == False)
             &amp; (np.isnan(league_table["december_conversion"]) == False)
             &amp; (league_table["december_conversion"]
<span class="">↪</span> .between(CONVERSION_LOWER_LIMIT, 1))
             &amp; (league_table["december_users"] &gt; MIN_USERS)
             &amp; (league_table["december_sold"] &gt; MIN_PURCHASES)]
    .sort_values("december_conversion", ascending=False)
    .merge(product_catalog.drop(columns=["product_name"]),
<span class="">↪</span> on=["product_id"])
)

print(best_december_converters.shape)</pre>
</div>
</div>
<div class="readable-text" id="p284">
<p>This means there are 55 products in total that were bought by at least five different users, totaling a minimum of 10 sales, and converted over 70% of their cart events to purchase ones. We could now look at what kinds of products these correspond to by looking at their categories. This output is shown in figure 4.37:</p>
</div>
<div class="browsable-container listing-container" id="p285">
<div class="code-area-container">
<pre class="code-area">best_december_converters["category"].value_counts()<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p286">
<img alt="figure" height="315" src="../Images/4-37.png" width="367"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.37</span> Top-performing categories among highest-converting products</h5>
</div>
<div class="readable-text" id="p287">
<p>The results are quite different from the volume-based rankings. When conversion is considered the key metric, furniture and construction items come up as the highest performers. Looking into this deeper, using the following code gives us the output in figure 4.38:</p>
</div>
<div class="browsable-container listing-container" id="p288">
<div class="code-area-container code-area-with-html">
<pre class="code-area">best_december_converters.loc[best_december_converters["category"]
<span class="">↪</span> .isin(["furniture", "construction"]), "subcategory"].value_counts()<span class="aframe-location"/></pre>
</div>
</div>
<div class="browsable-container figure-container" id="p289">
<img alt="figure" height="250" src="../Images/4-38.png" width="434"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.38</span> Furniture and construction products that converted best in December</h5>
</div>
<div class="readable-text" id="p290">
<p>What this tells us is that once most people have identified a faucet, drill, or sofa, they will most likely go ahead and purchase it. Smartphones feature less in conversion-based rankings, perhaps indicating that people are unsure about their smartphone purchase even after placing the item in their cart.</p>
</div>
<div class="readable-text intended-text" id="p291">
<p>Before summarizing our conclusions, let’s recap the entire analysis process as a diagram to remind ourselves of the steps we took and where our choices might have diverged. Figure 4.39 shows the final diagram.<span class="aframe-location"/></p>
</div>
<div class="browsable-container figure-container" id="p292">
<img alt="figure" height="1198" src="../Images/4-39.png" width="922"/>
<h5 class="figure-container-h5 sigil_not_in_toc"><span class="num-string">Figure 4.39</span> The final diagram showing all the steps and decision points in our analysis</h5>
</div>
<div class="readable-text intended-text" id="p293">
<p>We are now ready to summarize our results in preparation for presenting them to our stakeholders.</p>
</div>
<div class="readable-text" id="p294">
<h4 class="readable-text-h4 sigil_not_in_toc">Project outcomes</h4>
</div>
<div class="readable-text" id="p295">
<p>Based on these results, it looks like a safe bet to recommend to our stakeholders that classic Christmas present items like smartphones and kitchen appliances are likely to be high performers in December. The results based on conversion are less convincing since they only highlight products that people buy once they’ve added them to their cart, but they may not tell us anything about the success of those products.</p>
</div>
<div class="readable-text intended-text" id="p296">
<p>As always, there are limitations to our analysis. We did not look at the correlation between product price and performance. It is possible that our data implicitly tells us when a sale was on, which we could identify by looking at products whose price suddenly dropped, and this could inform our decision about which products sell best during sale periods. We could also request additional pricing data, such as postage costs, tax, or item wholesale costs. This latter figure could tell us not just which products generate the most revenue but also which ones generate the highest profit.</p>
</div>
<div class="readable-text intended-text" id="p297">
<p>Our restriction to two months of data also means our analysis is incomplete. Having more data would let us benchmark our products better and see which products deviate most from their average baseline performance. As it stands, we based this on a single month of data, which may be insufficient.</p>
</div>
<div class="readable-text intended-text" id="p298">
<p>Our initial findings warrant a further discussion with our stakeholders, and hopefully, showing them the effects of choosing different metrics will help focus them on the ones that truly matter to them. When choosing what to present to them, it is important to consider whether our recommendations are actionable. Telling stakeholders that people generally buy the faucets they have identified is less likely to result in them taking action than telling them that smartphones increase their sales the most in the December period.</p>
</div>
<div class="callout-container sidebar-container">
<div class="readable-text" id="p299">
<h5 class="callout-container-h5 readable-text-h5 sigil_not_in_toc">Activity: Further project ideas with this data</h5>
</div>
<div class="readable-text" id="p300">
<p>The e-commerce data in this chapter gives you plenty of opportunities to practice calculating and reflecting on different metrics. As with all projects, I recommend considering different research questions, such as</p>
</div>
<ul>
<li class="readable-text" id="p301"> What are some products whose prices fluctuate more than others? There is no reason to assume the same product ID sold for the same amount each time. </li>
<li class="readable-text" id="p302"> Are there temporal patterns in the data (products that sell more or convert better on weekends than weekdays, for example)? </li>
<li class="readable-text" id="p303"> You could go deeper into the product catalog and look for subcategories that perform better than others. What would “better” mean here? </li>
</ul>
</div>
<div class="readable-text" id="p304">
<h2 class="readable-text-h2" id="sigil_toc_id_54"><span class="num-string">4.5</span> Closing thoughts on metrics</h2>
</div>
<div class="readable-text" id="p305">
<p>As an analyst, you will encounter many projects like this one, where metrics will be insufficiently defined. Your job is not simply to perform the calculations given to you by a stakeholder, but to have a conversation with them to define metrics that are clear and measurable, given the available data, and that capture the right underlying concepts. We should generally be wary of summarizing complex problems into a single metric and should feel comfortable pushing back to help stakeholders create more usable problem definitions.</p>
</div>
<div class="readable-text intended-text" id="p306">
<p>There are two avenues to explore these concepts further: one is to understand different business metrics generally so that business terminology is more familiar to you, and the other is to research metrics specific to the industry you work in.</p>
</div>
<div class="readable-text intended-text" id="p307">
<p>How do you know what to read on the topic? As it turns out, generating reading lists for a new topic is a great use of generative AI tools, for example, large language models such as Open AI’s ChatGPT. I gave it the following prompt:</p>
</div>
<div class="readable-text" id="p308">
<blockquote>
<div>
     Give me a reading list for someone who is interested in exploring different business metrics and their impact
    </div>
</blockquote>
</div>
<div class="readable-text" id="p309">
<p>ChatGPT was able to generate a reading list of books to explore metrics further. The list includes general works such as <em>The Balanced Scorecard: Translating Strategy into Action</em> (Harvard Business School Press, 1996) by Robert S. Kaplan and David P. Norton, which “goes beyond financial metrics to measure various dimensions of organizational performance,” or a title focusing on a more specific domain, social media, in <em>Measure What Matters: Online Tools For Understanding Customers, Social Media, Engagement, and Key Relationships</em> (Wiley, 2011) by Katie Delahaye Paine.</p>
</div>
<div class="readable-text intended-text" id="p310">
<p>While not all recommendations by the AI might be usable, employing it to kickstart the research process is one way in which it becomes a valuable tool in the analyst’s toolkit.</p>
</div>
<div class="readable-text" id="p311">
<h3 class="readable-text-h3" id="sigil_toc_id_55"><span class="num-string">4.5.1</span> Skills for defining better metrics for any project</h3>
</div>
<div class="readable-text" id="p312">
<p>In this chapter, our biggest challenge was turning a vague request into measurable metrics that we could analyze. The key skills learned for defining metrics that are applicable to any similar project include</p>
</div>
<ul>
<li class="readable-text" id="p313"> Ensuring that definitions within the data are consistent (e.g., the same product is always assigned to the same category) </li>
<li class="readable-text" id="p314"> Exporting intermediate versions of the data to separate exploration and cleaning from analysis </li>
<li class="readable-text" id="p315"> Changing the granularity of the data to suit the question (e.g., summarizing transaction-level data to the product level) </li>
<li class="readable-text" id="p316"> Calculating multiple metrics to investigate the problem from different angles </li>
<li class="readable-text" id="p317"> Iterating on our chosen metrics once we have some initial findings </li>
<li class="readable-text" id="p318"> Investigating alternative metrics to present to our stakeholders for a more complete picture </li>
</ul>
<div class="readable-text" id="p319">
<h2 class="readable-text-h2" id="sigil_toc_id_56">Summary</h2>
</div>
<ul>
<li class="readable-text" id="p320"> Choosing the right metric is a vital professional skill for analysts to develop. </li>
<li class="readable-text" id="p321"> Any metric you choose to measure performance will affect the entire analysis path. </li>
<li class="readable-text" id="p322"> Be wary of summarizing complex problems into a single metric. </li>
<li class="readable-text" id="p323"> Definitions of key metrics should be unambiguous to avoid analytical errors. </li>
</ul>
</div></body></html>