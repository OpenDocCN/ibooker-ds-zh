- en: 11 Fixing failures
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 11 修复失败
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Determining how to roll forward failed changes to restore functionality
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 确定如何回滚失败更改以恢复功能
- en: Organizing an approach for IaC troubleshooting
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 组织 IaC 故障排除的方法
- en: Categorizing repairs for failed changes
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对失败更改的分类修复
- en: We took many chapters to discuss writing and collaborating on infrastructure
    as code. All of the practices and principles you learned for IaC accumulate to
    the crucial moment when you push a change, it causes your system to fail, and
    you need to roll it back! However, IaC doesn’t support rollback. You do not fully
    revert IaC changes. What does it mean to fix failures if you don’t roll them back?
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 我们花费了很多章节来讨论编写和协作基础设施即代码。您为 IaC 学习的所有实践和原则都积累到了一个关键时刻，那就是您推送更改，它导致您的系统失败，您需要将其回滚！然而，IaC
    不支持回滚。您不能完全撤销 IaC 更改。如果不回滚，修复失败意味着什么呢？
- en: This chapter focuses on fixing failed changes from IaC. First, we’ll discuss
    what it means to “revert” IaC changes by rolling *forward*. Then, you’ll learn
    workflows for troubleshooting and fixing the failed change. While the techniques
    in this chapter might not apply to every scenario you’ll encounter in your system,
    they establish a broad set of practices you can use to start repairing IaC failures.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 本章重点介绍如何修复 IaC 中的失败更改。首先，我们将讨论通过“回滚”来“撤销”IaC 更改的含义。然后，您将学习故障排除和修复失败更改的工作流程。虽然本章中介绍的技术可能不适用于您在系统中遇到的所有场景，但它们建立了一套广泛的实践，您可以使用这些实践开始修复
    IaC 失败。
- en: Troubleshooting and site reliability engineering
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 故障排除和站点可靠性工程
- en: I do not dive too deeply into the process and principles of troubleshooting
    failed systems in this book. Most of the discussion around troubleshooting centers
    around how to manage it in the context of IaC. For more information on troubleshooting
    and building reliable systems, I recommend *Site Reliability Engineering* by Betsy
    Beyer et al. (O’Reilly, 2016).
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书中，我不会深入探讨故障系统故障排除的过程和原则。关于故障排除的大部分讨论都集中在 IaC 的上下文中如何管理它。有关故障排除和构建可靠系统的更多信息，我推荐
    Betsy Beyer 等人所著的《站点可靠性工程》（O’Reilly，2016年）。
- en: As a general rule, prioritize stabilization and restoration of functionality
    for services and customers before you debug further for a root cause (the issue
    that led to the problem). A temporary bandage provides you the opportunity to
    troubleshoot and implement a longer-term fix for the system.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 作为一般规则，在进一步调试根本原因（导致问题的那个问题）之前，优先考虑服务和客户的稳定性和功能恢复。临时修补提供了您进行故障排除并实施系统长期修复的机会。
- en: 11.1 Restoring functionality
  id: totrans-10
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.1 恢复功能
- en: Imagine you work for a company called Cool Caps for Keys. It creates custom
    keyboard caps and connects customers with artists to design the caps. As the security
    engineer, you need to narrow down the access control for applications and users
    across GCP projects.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 想象一下，您在一家名为 Cool Caps for Keys 的公司工作。该公司创建定制的键盘帽，并将客户与艺术家联系起来以设计帽。作为安全工程师，您需要缩小
    GCP 项目中应用程序和用户的访问控制。
- en: You copy the Google Cloud SQL database configuration and update the access control
    to implement least-privilege access for team members and applications. You choose
    the policies required for different applications to use infrastructure and verify
    that the applications still work.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 您复制 Google Cloud SQL 数据库配置并更新访问控制，以实现团队成员和应用程序的最小权限访问。您选择不同应用程序使用基础设施所需的政策，并验证应用程序仍然可以工作。
- en: Next, you talk to the promotions team. Its application accesses the database
    directly by using a database username and password. Direct access to the database
    means that you can remove the policy for `roles/cloudsql.admin` from the promotions
    application’s service account. You remove the policy, test the changes, confirm
    with the promotions team that the change did not affect its application in its
    testing environment, and push it to production; see figure 11.1.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，您与推广团队交谈。其应用程序通过使用数据库用户名和密码直接访问数据库。直接访问数据库意味着您可以从推广应用程序的服务帐户中移除`roles/cloudsql.admin`策略。您移除策略，测试更改，与推广团队确认更改没有影响其在测试环境中的应用，然后将它推送到生产环境；见图
    11.1。
- en: '![](../../OEBPS/Images/CH11_F01_Wang.png)'
  id: totrans-14
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH11_F01_Wang.png)'
- en: Figure 11.1 After removing the administrative database access for the promotions
    service, you discover that the change broke the service’s ability to access the
    database.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11.1 在移除推广服务的数据库管理访问权限后，您发现更改破坏了服务访问数据库的能力。
- en: An hour later, the promotions team tells you that its application keeps throwing
    an error that it can’t access the database! You suspect that your change might
    have introduced a problem. While you could start digging around for the problem,
    you prioritize fixing the promotions service so it can access the database before
    investigating further.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 一小时后，促销团队告诉您，其应用程序持续抛出错误，无法访问数据库！您怀疑您的更改可能引入了问题。虽然您可以开始挖掘问题，但您优先修复促销服务，以便在进一步调查之前能够访问数据库。
- en: 11.1.1 Rolling forward to revert changes
  id: totrans-17
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.1.1 回滚以撤销更改
- en: You need to fix the service so users can make requests to the system. However,
    you cannot simply return the system to a previously working state. IaC prioritizes
    immutability, which means any changes to the system, including *reverted* changes,
    must create new resources!
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 您需要修复服务，以便用户可以向系统发出请求。然而，您不能简单地将系统恢复到之前的工作状态。IaC 优先考虑不可变性，这意味着对系统的任何更改，包括 *撤销*
    的更改，都必须创建新的资源！
- en: For example, let’s fix the promotions service for Cool Caps for Keys by reverting
    the change and adding the role to the service account. In figure 11.2, you revert
    the commit and add `roles/cloudsql.admin` back to the service account. Then, you
    push the changes to your testing and production environments.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，让我们通过撤销更改并添加角色到服务账户来修复 Cool Caps for Keys 的促销服务。在图 11.2 中，您撤销了提交并将 `roles/cloudsql.admin`
    添加回服务账户。然后，您将更改推送到测试和生产环境。
- en: '![](../../OEBPS/Images/CH11_F02_Wang.png)'
  id: totrans-20
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH11_F02_Wang.png)'
- en: Figure 11.2 You add the administrative database role for the promotions service
    to roll forward the system to a working state.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11.2 您为促销服务添加了管理数据库角色，以便将系统回滚到工作状态。
- en: You revert the commit and push *forward* the changes to the testing and production
    environments. You *roll forward* IaC because it uses immutability to return the
    system to a working state.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 您撤销了提交并将更改推送到测试和生产环境。您通过 IaC 推进更改，因为它使用不可变性将系统恢复到工作状态。
- en: Definition The practice of *rolling forward* IaC reverts changes to a system
    and uses immutability to return the system to a working state.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *回滚* IaC 的实践是将系统中的更改撤销，并使用不可变性将系统恢复到工作状态。
- en: Rollback implies that you return infrastructure to a previous state. In reality,
    the immutability of IaC means that you create a *new* state anytime you make changes.
    You cannot fully restore the state of infrastructure back to its previous state.
    Sometimes you can’t actually restore the infrastructure to a previous state because
    your change has a large blast radius.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 回滚意味着您将基础设施回滚到之前的状态。实际上，IaC 的不可变性意味着您在每次更改时都会创建一个新的状态。您无法完全恢复基础设施到之前的状态。有时您实际上无法将基础设施恢复到之前的状态，因为您的更改具有很大的影响范围。
- en: 'Let’s revert your changes to the service account and roll forward changes to
    add back the permission. First, check your commit history because version control
    keeps track of all the changes you make. The commit prefixed with `a31` includes
    your removal of `roles/cloudsql.admin`:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们撤销对服务账户的更改，并将更改回滚以恢复权限。首先，检查您的提交历史，因为版本控制会跟踪您所做的所有更改。带有 `a31` 前缀的提交包括您移除
    `roles/cloudsql.admin` 的操作：
- en: '[PRE0]'
  id: totrans-26
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Applying the GitOps practices from chapter 7, you want to avoid making manual,
    break-glass changes. Instead, you favor operational changes through IaC! You revert
    the commit to push updates to restore the promotions service to a working state:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 应用第 7 章中的 GitOps 实践，您希望避免进行手动、破坏性的更改。相反，您更倾向于通过基础设施即代码（IaC）进行操作更改！您撤销提交以推送更新，以恢复促销服务到工作状态：
- en: '[PRE1]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: You push the commit, and the pipeline adds the role back to the service account.
    After you roll forward, the application works again. You’ve successfully returned
    the infrastructure state to a working state. However, you never achieve a full
    restore of state. Instead, you rolled out a new state that matched the previous
    working state.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 您推送了提交，并且管道将角色添加回服务账户。在您回滚后，应用程序再次工作。您已成功将基础设施状态恢复到工作状态。然而，您从未实现状态的完全恢复。相反，您推出了一个与之前工作状态匹配的新状态。
- en: Rolling back IaC often means rolling forward changes to the infrastructure state.
    You use `git revert` as a forward-moving undo to preserve immutability and roll
    forward undo updates to infrastructure.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 回滚 IaC 通常意味着将更改回滚到基础设施状态。您使用 `git revert` 作为向前移动的撤销来保留不可变性，并将撤销更新回滚到基础设施。
- en: Configuration management
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 配置管理
- en: Configuration management does not prioritize immutability but still rolls forward
    reverted changes to a server or resource. For example, imagine you install a package
    with version 3.0.0 and need to revert to 2.0.0\. Your configuration management
    tool may choose to uninstall the new version and reinstall the old version. You
    do not restore the package and its configuration to its previous state. You just
    restore the server to a new working state with an older package.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 配置管理不优先考虑不可变性，但仍然将撤销的变更向前推进到服务器或资源。例如，想象你安装了一个版本为3.0.0的包，需要回滚到2.0.0。你的配置管理工具可能会选择卸载新版本并重新安装旧版本。你并没有将包及其配置恢复到先前的状态。你只是将服务器恢复到一个带有较旧包的新工作状态。
- en: 11.1.2 Rolling forward for new changes
  id: totrans-33
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.1.2 向前推进以实施新变更
- en: The benefit of taking a roll-forward mentality means that you expand your troubleshooting
    approach. In the example, you reverted a broken commit and restored functionality
    to the promotions service by matching the new state to a prior working one. However,
    sometimes reverting a commit doesn’t fix your system and makes everything worse!
    Instead, you can roll forward *new changes* and restore functionality.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 采用向前推进的心态带来的好处是扩展了你的故障排除方法。在示例中，你撤销了一个损坏的提交，并通过将新状态与先前的有效状态匹配来恢复促销服务的功能。然而，有时撤销提交并不能修复你的系统，反而使情况变得更糟！相反，你可以向前推进*新变更*并恢复功能。
- en: Let’s imagine the promotions service still doesn’t work after you roll forward
    changes. Rather than try to fix the application, you create a new environment
    with the change and a new promotions service. You start a canary deployment technique
    from chapter 9 to gradually increase the traffic to fully restore the application,
    as shown in figure 11.3\. You disable the failed environment after all requests
    go to the new service instance for debugging.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们假设在向前推进变更后，促销服务仍然无法工作。与其试图修复应用程序，不如创建一个新的环境，其中包含变更和新的促销服务。你从第9章开始使用金丝雀部署技术，逐渐增加流量以完全恢复应用程序，如图11.3所示。在所有请求都转到新服务实例后，你禁用失败的环境进行调试。
- en: '![](../../OEBPS/Images/CH11_F03_Wang.png)'
  id: totrans-36
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH11_F03_Wang.png)'
- en: Figure 11.3 When you cannot recover the promotions application, you can use
    a canary deployment to cut over traffic to a new instance and restore the system.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.3 当无法恢复促销应用程序时，你可以使用金丝雀部署将流量切换到新实例并恢复系统。
- en: IaC allows you to reproduce environments with less effort. Furthermore, conforming
    to immutability means that you already have a pattern of creating new environments
    for changes. The combination of the two principles helps mitigate higher-risk
    changes with a larger blast radius.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: IaC（基础设施即代码）允许你以更少的努力重现环境。此外，遵循不可变性意味着你已经有一个创建新环境以进行变更的模式。这两个原则的结合有助于减轻具有更大影响范围的更高风险变更。
- en: Use cases that involve data or completely irrecoverable resources cannot roll
    forward to a prior state. You could corrupt application data or affect other infrastructure
    while detangling a cascading failure. Rather than roll forward to revert, you
    can roll forward and implement new changes by applying the change techniques from
    chapter 9.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 涉及数据或完全无法恢复的资源的使用案例不能回滚到先前的状态。在解决级联故障的过程中，你可能会损坏应用程序数据或影响其他基础设施。与其回滚以恢复，不如通过应用第9章中的变更技术，向前推进并实施新的变更。
- en: You may also restore functionality with a combination of reverts and completely
    new changes. Expanding your roll-forward mentality to include new changes outside
    of undoing old ones offers a helpful alternative to restore functionality quickly
    and minimize disruption to other parts of your system.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以通过撤销和完全新的变更的组合来恢复功能。将你的向前推进心态扩展到包括在撤销旧变更之外的新变更，为快速恢复功能并提供了一种有用的替代方案，同时最大限度地减少对系统其他部分的干扰。
- en: 11.2 Troubleshooting
  id: totrans-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.2 故障排除
- en: You put a bandage on your system so the promotions team can still send out promotional
    offers for Cool Caps for Keys. However, you still need to secure the IAM of the
    application! Where do you start to find out why the promotions service failed
    when you removed administrative permission that the promotions team shouldn’t
    need?
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 你给你的系统贴上了一个创可贴，这样促销团队仍然可以发送Cool Caps for Keys的促销活动。然而，你仍然需要确保应用程序的IAM（身份和访问管理）安全！当你移除了促销团队不需要的管理权限时，你从哪里开始查找促销服务失败的原因？
- en: 'Troubleshooting your IaC also follows specific patterns. Even in the most complex
    infrastructure systems, many failed changes from IaC usually come from three causes:
    drift, dependencies, or differences. Examining your configuration for any of these
    causes helps you identify the problem and a potential fix.'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 故障排除您的 IaC 也遵循特定的模式。即使在最复杂的系统基础设施中，许多失败的 IaC 变更通常来自三个原因：漂移、依赖项或差异。检查您的配置以查找任何这些原因有助于您识别问题以及潜在的解决方案。
- en: 11.2.1 Check for drift
  id: totrans-44
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.2.1 检查漂移
- en: Many broken infrastructure changes stem from configuration drift between configuration
    and resource state. In figure 11.4, you start by checking for drift. Make sure
    the IaC for the service account matches the state of the service account in GCP.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 许多损坏的基础设施变更源于配置与资源状态之间的配置漂移。在图 11.4 中，您首先检查漂移。确保服务帐户的 IaC 与 GCP 中服务帐户的状态相匹配。
- en: '![](../../OEBPS/Images/CH11_F04_Wang.png)'
  id: totrans-46
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH11_F04_Wang.png)'
- en: Figure 11.4 Start by checking for drift between IaC and state.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11.4 首先检查基础设施即代码（IaC）与状态之间的漂移。
- en: Checking for drift between code and state ensures that you eliminate any failures
    due to differences between the two. Differences between code and state can introduce
    unexpected problems. Removing those differences ensures that your change behavior
    works as expected.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 检查代码与状态之间的漂移可以确保您消除由于两者之间的差异而导致的任何故障。代码与状态之间的差异可能会引入意外问题。消除这些差异可以确保您的更改行为按预期工作。
- en: In the case of Cool Caps for Keys, you review the permissions for the promotions
    service account that you define in IaC. The following listing outlines the IaC
    that defines the service and roles.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Cool Caps for Keys 的情况下，您将审查在 IaC 中定义的推广服务帐户的权限。以下列表概述了定义服务和角色的 IaC。
- en: Listing 11.1 Promotions service account with database admin permission
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 11.1 具有数据库管理员权限的推广服务帐户
- en: '[PRE2]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: ❶ Imports the database module to build the Google Cloud SQL database
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 导入数据库模块以构建 Google Cloud SQL 数据库
- en: ❷ Imports the Google service account module and creates the configuration with
    the permissions
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 导入 Google 服务帐户模块并创建具有权限的配置
- en: ❸ Imports the network module to build the Google network and subnetwork
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 导入网络模块以构建 Google 网络
- en: ❹ Imports the server module to build the Google compute instance
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 导入服务器模块以构建 Google 计算实例
- en: ❺ Promotions service account should have permission for the “cloudsql.admin”
    role to access the database
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 推广服务帐户应具有访问数据库的“cloudsql.admin”角色的权限
- en: ❻ Uses the module to create the JSON configuration for the database, network,
    service account, and server
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 使用模块创建数据库、网络、服务帐户和服务器的 JSON 配置
- en: ❼ Imports the network module to build the Google network and subnetwork
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: ❼ 导入网络模块以构建 Google 网络
- en: ❽ Imports the Google service account module and creates the configuration with
    the permissions
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: ❽ 导入 Google 服务帐户模块并创建具有权限的配置
- en: ❾ Imports the database module to build the Google Cloud SQL database
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: ❾ 导入数据库模块以构建 Google Cloud SQL 数据库
- en: ❿ Imports the server module to build the Google compute instance
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: ❿ 导入服务器模块以构建 Google 计算实例
- en: ⓫ Writes out the Python dictionary to a JSON file to be executed by Terraform
    later
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: ⓫ 将 Python 字典写入 JSON 文件，以便 Terraform 后续执行
- en: AWS and Azure equivalents
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 等效
- en: The AWS equivalent of the GCP Cloud SQL administrator permission is similar
    to `AmazonRDSFullAccess`. Azure does not have an exact equivalent. Instead, you
    will need to add an Azure Active Directory account to the database directly and
    grant administrative consent for Azure SQL Database API permissions.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: GCP Cloud SQL 管理员权限的 AWS 等效是 `AmazonRDSFullAccess`。Azure 没有确切的等效项。相反，您需要将 Azure
    Active Directory 帐户直接添加到数据库中，并授予 Azure SQL Database API 权限的管理同意。
- en: 'Then, compare the code to the promotions application’s service account permissions
    in GCP. The service account has only `roles/cloudsql.admin` permissions consistent
    with your IaC:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，将代码与 GCP 中推广应用程序的服务帐户权限进行比较。服务帐户只有与您的 IaC 一致的 `roles/cloudsql.admin` 权限：
- en: '[PRE3]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: If you find configuration drift between IaC and the active resource state, you
    can further investigate whether it affects system functionality. You may choose
    to eliminate some of the drift to ensure that it doesn’t contribute to the root
    cause. However, just because you detect some drift does not mean that it breaks
    your system! Some drift may have nothing to do with the failure.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你发现IaC和活动资源状态之间存在配置漂移，你可以进一步调查它是否影响系统功能。你可以选择消除一些漂移，以确保它不会导致根本原因。然而，仅仅因为检测到一些漂移并不意味着它会破坏你的系统！一些漂移可能与失败无关。
- en: 11.2.2 Check for dependencies
  id: totrans-68
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.2.2 检查依赖关系
- en: If you determine drift does not contribute to the failure, you can check for
    resources that depend on your updated one. In figure 11.5, you start graphing
    which resources depend on the service account. In both the IaC and production
    environment, the server depends on the service account.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你确定漂移没有导致失败，你可以检查依赖于你的更新资源的资源。在图11.5中，你开始绘制依赖于服务账户的资源。在IaC和生产环境中，服务器都依赖于服务账户。
- en: '![](../../OEBPS/Images/CH11_F05_Wang.png)'
  id: totrans-70
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH11_F05_Wang.png)'
- en: Figure 11.5 Troubleshoot any resources that depend on the one you want to update.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.5 修复任何依赖于您想要更新的资源的错误。
- en: You want to check that the expected dependencies match the actual. Unexpected
    dependencies disrupt change behavior. When you review the code in the following
    listing, you verify that the service account’s email gets passed to the server.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要检查预期的依赖关系是否与实际匹配。意外的依赖关系会干扰更改行为。当你审查以下列表中的代码时，你验证服务账户的电子邮件是否传递给了服务器。
- en: Listing 11.2 Promotions server depends on the promotions service account
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 列表11.2 推广服务器依赖于推广服务账户
- en: '[PRE4]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: ❶ Uses the module to create the JSON configuration for the server
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 使用模块创建服务器的JSON配置
- en: ❷ Creates the Google compute instance by using a Terraform resource based on
    the name, address, region, and network
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 通过基于名称、地址、区域和网络使用Terraform资源创建Google计算实例
- en: ❸ The factory for the promotions application’s server uses a service account
    to access GCP services.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 推广应用程序服务器的工厂使用服务账户访问GCP服务。
- en: AWS and Azure equivalents
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure的等效选项
- en: Create a network in AWS or Azure. Then, update the code listing to use an Azure
    Linux virtual machine Terraform resource ([http://mng.bz/J22p](https://shortener.manning.com/J22p))
    with a managed identity block. The `identity` block should include a list of user
    IDs with permissions to access Azure. For AWS, you would define an IAM instance
    profile for the AWS EC2 Terraform resource.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 在AWS或Azure中创建一个网络。然后，更新代码列表以使用带有托管身份块的Azure Linux虚拟机Terraform资源 ([http://mng.bz/J22p](https://shortener.manning.com/J22p))。`identity`块应包含具有访问Azure权限的用户ID列表。对于AWS，您将为AWS
    EC2 Terraform资源定义IAM实例配置文件。
- en: However, the promotions team mentions that its application *directly* accesses
    the database by using its IP address, username, and password. Why would the server
    need the service account if the application reads the database connection string
    from a file?
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，推广团队提到，其应用程序*直接*通过使用其IP地址、用户名和密码访问数据库。如果应用程序从文件中读取数据库连接字符串，服务器为什么还需要服务账户？
- en: You realize this highlights a discrepancy. You ask the promotions team to show
    you the application code. The application configuration does not use the database
    IP address, username, or password!
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 你意识到这突显了一个差异。你要求推广团队向你展示应用程序代码。应用程序配置没有使用数据库IP地址、用户名或密码！
- en: After additional debugging with the promotions team, you discover that the promotions
    application connects to the database on `localhost`. The configuration uses the
    Cloud SQL Auth proxy ([https://cloud.google.com/sql/docs/mysql/sql-proxy](https://cloud.google.com/sql/docs/mysql/sql-proxy)),
    which handles the connection and logs into the database! Therefore, the service
    account connected to the server needs database access.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在与推广团队进行额外的调试后，你发现推广应用程序连接到本地的数据库。配置使用Cloud SQL Auth代理 ([https://cloud.google.com/sql/docs/mysql/sql-proxy](https://cloud.google.com/sql/docs/mysql/sql-proxy))，该代理处理连接并登录到数据库！因此，连接到服务器的服务账户需要数据库访问权限。
- en: Figure 11.6 shows that the promotions application accesses the database through
    a proxy. The proxy uses the service account to authenticate and access the database.
    The service account needs access to the database with a policy.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.6显示，推广应用程序通过代理访问数据库。代理使用服务账户进行身份验证并访问数据库。服务账户需要具有策略的数据库访问权限。
- en: '![](../../OEBPS/Images/CH11_F06_Wang.png)'
  id: totrans-84
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH11_F06_Wang.png)'
- en: Figure 11.6 The promotions application accesses the database through a proxy,
    which needs a service account with database permissions.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.6 推广应用程序通过代理访问数据库，该代理需要一个具有数据库权限的服务账户。
- en: AWS and Azure equivalents
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure的等效选项
- en: The AWS equivalent of the GCP Cloud SQL Auth proxy is Amazon RDS Proxy. The
    proxy helps enforce database connections and avoids the need for database usernames
    and passwords in application code.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: GCP Cloud SQL Auth代理的AWS等效选项是Amazon RDS Proxy。代理有助于强制执行数据库连接，并避免在应用程序代码中需要数据库用户名和密码。
- en: Azure does not have an equivalent SQL proxy option. Instead, you must set up
    an Azure Private Link to the database. This allocates an IP address on a private
    network of your choice. You can configure your database to allow your application
    to log in with an Azure Active Directory service principal.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: Azure没有等效的SQL代理选项。相反，你必须设置一个指向数据库的Azure Private Link。这在你选择的私有网络上分配了一个IP地址。你可以配置你的数据库，允许你的应用程序使用Azure
    Active Directory服务主体登录。
- en: Congratulations, you discovered why the promotions application broke when you
    removed the service account! However, you get a little suspicious. Shouldn’t you
    have found the same problem in the testing environment? After all, you tested
    the change in a testing environment, and the application did not break.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 恭喜你，你发现了为什么当你移除服务账户时推广应用程序会损坏的原因！然而，你有点怀疑。你不应该在测试环境中发现相同的问题吗？毕竟，你在测试环境中测试了更改，应用程序并没有损坏。
- en: 11.2.3 Check for differences in environments
  id: totrans-90
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.2.3 检查环境差异
- en: Why did the change work in testing but not in production? You examine the promotions
    application in testing. The application *does not* connect to the database on
    `localhost`. Instead, it uses the database IP address, username, and password.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么更改在测试环境中有效但在生产环境中无效？你检查了测试环境中的推广应用程序。该应用程序*不*连接到`localhost`上的数据库。相反，它使用数据库IP地址、用户名和密码。
- en: You explain to the application team that the production IaC uses the Cloud SQL
    Auth proxy, while the testing IaC directly calls the database; see figure 11.7\.
    Both configurations use the `roles/cloudsql.admin` permission.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 你向应用程序团队解释说，生产IaC使用Cloud SQL Auth代理，而测试IaC直接调用数据库；参见图11.7。两种配置都使用`roles/cloudsql.admin`权限。
- en: '![](../../OEBPS/Images/CH11_F07_Wang.png)'
  id: totrans-93
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH11_F07_Wang.png)'
- en: Figure 11.7 Check for differences between testing and production to reconcile
    any tested changes that fail.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.7 检查测试和生产环境之间的差异，以解决任何失败的测试更改。
- en: After further discussion with the promotions team, you discover that the team
    implemented an emergency change to secure production with the Cloud SQL Auth proxy.
    However, the team did not have a chance to update the testing environment to match!
    The mismatch allowed your updates to succeed in the testing environment but fail
    in the production environment.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 在与推广团队进一步讨论后，你发现该团队实施了一个紧急更改，使用Cloud SQL Auth代理来保护生产环境。然而，团队没有机会更新测试环境以匹配！这种不匹配使得你的更新在测试环境中成功，但在生产环境中失败。
- en: You want to keep the testing and production environments as similar as possible.
    However, you cannot always reproduce production in testing environments. As a
    result, you will encounter failed changes due to discrepancies in both. Systematically
    identifying differences between testing and production environments helps highlight
    gaps in testing and change delivery.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 你希望测试和生产环境尽可能相似。然而，你无法总是复制生产环境。因此，你将遇到由于两者之间的差异而失败的更改。系统地识别测试和生产环境之间的差异有助于突出测试和变更交付中的差距。
- en: While IaC should document all changes and configuration to your system, you
    might still discover a few surprises between IaC and environments. Figure 11.8
    summarizes your structured approach to debugging failed changes in the promotions
    application’s IaC. You check for drift, dependencies, and finally, differences
    between environments.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然IaC应该记录系统中所有的更改和配置，但你可能在IaC和环境之间仍然会发现一些惊喜。图11.8总结了你在推广应用程序IaC中调试失败更改的结构化方法。你检查漂移、依赖关系，最后检查环境之间的差异。
- en: '![](../../OEBPS/Images/CH11_F08_Wang.png)'
  id: totrans-98
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH11_F08_Wang.png)'
- en: Figure 11.8 You use IaC to troubleshoot your broken change by checking for drift,
    unexpected dependencies, and differences between testing and production.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.8 你通过检查漂移、意外的依赖关系和测试与生产之间的差异，使用IaC来调试你的损坏更改。
- en: After determining a root cause, you can finally implement a long-term fix. You
    must now reconcile the difference between the testing and production environment
    and revisit least-privilege access to secure the promotions application’s service
    account.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 在确定根本原因后，你最终可以实施一个长期的修复方案。你现在必须协调测试环境和生产环境之间的差异，并重新审视对促销应用程序服务账户的最小权限访问。
- en: Exercise 11.1
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 练习11.1
- en: A team reports that that its application can no longer connect to another application.
    The application worked last week, but requests have failed since Monday. The team
    has made no changes to its application and suspects the problem may be a firewall
    rule. Which steps can you take to troubleshoot the problem? (Choose all that apply.)
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 一支团队报告称，其应用程序无法连接到另一个应用程序。该应用程序上周还能正常工作，但自周一以来请求都失败了。该团队没有对其应用程序进行任何更改，并怀疑问题可能是防火墙规则。你可以采取哪些步骤来排查这个问题？（选择所有适用的选项。）
- en: A) Log into the cloud provider and check the firewall rules for the application.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: A) 登录云服务提供商并检查应用程序的防火墙规则。
- en: B) Deploy new infrastructure and applications to a green environment for testing.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: B) 在绿色环境中部署新的基础设施和应用程序进行测试。
- en: C) Examine the changes in IaC for the application.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: C) 检查应用程序的IaC更改。
- en: D) Compare the firewall rules in the cloud provider with IaC.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: D) 将云服务提供商中的防火墙规则与IaC进行比较。
- en: E) Edit the firewall rules and allow all traffic between the applications.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: E) 编辑防火墙规则，允许应用程序之间的所有流量。
- en: See appendix B for answers to exercises.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 请参阅附录B以获取练习的答案。
- en: 11.3 Fixing
  id: totrans-109
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.3 修复
- en: Your original task for Cool Caps for Keys involved updating the service account
    permissions for each application to ensure least-privilege access to services.
    You tried to remove database administrative access from the promotions application’s
    service account but failed. After troubleshooting the issue, you can now fix the
    problem.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 你为Cool Caps for Keys的原任务是更新每个应用程序的服务账户权限，以确保对服务的最小权限访问。你尝试从促销应用程序的服务账户中移除数据库管理访问权限，但失败了。在排查了问题之后，你现在可以修复这个问题。
- en: You might find yourself a bit impatient at this point! After all, you have not
    finished updating the access for other applications in Cool Caps for Keys. However,
    don’t just go in and change everything at once. Pushing a batch of changes can
    make it difficult to debug the source of failure (previously referenced in chapter
    7). Your testing environment still doesn’t match production, and you can still
    affect the promotions application if you make too many changes at once.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会觉得有点不耐烦！毕竟，你还没有完成Cool Caps for Keys中其他应用程序的访问更新。然而，不要一次性改变所有东西。推送一批更改可能会使调试失败原因变得困难（如第7章中提到的）。你的测试环境仍然与生产环境不匹配，如果你一次性做出太多更改，你仍然可能会影响促销应用程序。
- en: Throughout the book, I mention the process of making minor changes to minimize
    the blast radius of potential failure. Similarly, *incremental fixes* break down
    the changes you need to make to a system to prevent future failure.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 在整本书中，我提到了通过进行小改动来最小化潜在失败的影响范围的过程。同样，*增量修复*将系统需要做出的更改分解成更小的部分，以防止未来的失败。
- en: Definition *Incremental fixes* break changes into smaller parts to gradually
    improve a system and prevent future failure.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *增量修复* 将更改分解成更小的部分，以逐步改进系统并防止未来的失败。
- en: Making minor configuration changes and gradually deploying them helps you recognize
    the first sign of trouble and stage your IaC for future success.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 进行小范围的配置更改并逐步部署有助于你识别麻烦的第一迹象，并为未来的IaC成功做好准备。
- en: 11.3.1 Reconcile drift
  id: totrans-115
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.3.1 协调漂移
- en: As I mentioned in chapter 2, you need to reconcile any manual changes to the
    infrastructure state with IaC. If you find some drift, you need to address it
    first! Your system should not have too many break-glass changes if you prioritize
    the use of IaC.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 如我在第2章中提到的，你需要协调对基础设施状态进行的任何手动更改与IaC。如果你发现一些漂移，你需要首先解决它！如果你优先考虑使用IaC，你的系统不应该有太多的紧急更改。
- en: Recall that the promotions application for Cool Caps for Keys implemented a
    break-glass change that resulted in a difference between testing and production
    environments. The production application uses the Cloud SQL Auth proxy to connect
    to the database, while the testing application directly connects to the database
    through the IP address and password. You need to build a Cloud SQL Auth proxy
    in the testing environment.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 回想一下，Cool Caps for Keys的促销应用程序实现了一个玻璃破碎更改，导致测试和生产环境之间存在差异。生产应用程序使用Cloud SQL
    Auth代理连接到数据库，而测试应用程序直接通过IP地址和密码连接到数据库。你需要在测试环境中构建一个Cloud SQL Auth代理。
- en: To start fixing drift, you need to reconstruct the current state of infrastructure
    in configuration. Figure 11.9 reconstructs the installation commands for the Cloud
    SQL Auth proxy based on the production server. Then, you add the commands to IaC
    and apply them to the testing environment.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 要开始修复漂移，你需要将基础设施的当前状态重构到配置中。图11.9根据生产服务器重构了Cloud SQL Auth代理的安装命令。然后，你将这些命令添加到IaC中，并应用到测试环境中。
- en: '![](../../OEBPS/Images/CH11_F09_Wang.png)'
  id: totrans-119
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH11_F09_Wang.png)'
- en: Figure 11.9 In testing, you need to install the Cloud SQL Auth proxy package
    onto the promotions application’s server to reconcile drift from the break-glass
    change.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.9 在测试中，你需要将Cloud SQL Auth代理包安装到促销应用程序的服务器上，以解决玻璃破碎更改的漂移。
- en: In this example, the team did not add IaC for the manual change. As a result,
    you spend additional time rebuilding the installation of the Cloud SQL Auth proxy.
    An out-of-band change such as the proxy caused a failed change, which takes even
    more time and effort to fix.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 在此示例中，团队没有为手动更改添加IaC。因此，你需要额外的时间来重建Cloud SQL Auth代理的安装。像代理这样的带外更改导致更改失败，修复它需要更多的时间和精力。
- en: To help minimize some of these problems, use the process of migrating to IaC
    described in chapter 2\. Capturing the manual change as IaC helps minimize differences
    between environments and drift between IaC and actual state. If you need to reconstruct
    the state of infrastructure, remember that chapter 2 includes a high-level example
    of migrating existing infrastructure into IaC. However, you typically have to
    find or write a tool to transform the state to IaC.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 为了帮助最小化这些问题，请使用第2章中描述的迁移到IaC的过程。将手动更改作为IaC捕获有助于最小化环境之间的差异以及IaC和实际状态之间的漂移。如果你需要重建基础设施的状态，请记住第2章包括将现有基础设施迁移到IaC的高级示例。然而，你通常需要找到或编写一个工具将状态转换为IaC。
- en: Let’s write the IaC to install the proxy. You checked the command history on
    the promotions application’s server in production and reconstructed the installation
    of the Cloud SQL Auth proxy. The following listing automates the commands and
    installation process in a startup script for the promotions application’s server.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们编写安装代理的IaC脚本。你检查了生产环境中促销应用程序服务器的命令历史，并重新构建了Cloud SQL Auth代理的安装过程。以下列表自动化了促销应用程序服务器启动脚本中的命令和安装过程。
- en: Listing 11.3 Installing the Cloud SQL Auth proxy in the server startup script
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 列表11.3 在服务器启动脚本中安装Cloud SQL Auth代理
- en: '[PRE5]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: ❶ Creates a startup script that reconstructs the manual installation commands
    for the Cloud SQL Auth proxy
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 创建一个启动脚本，以重构Cloud SQL Auth代理的手动安装命令
- en: ❷ Sets a variable as the proxy download URL
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 设置一个变量作为代理下载URL
- en: ❸ Sets a variable that runs the Cloud SQL Auth proxy binary on port 3306
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 设置一个变量，在端口3306上运行Cloud SQL Auth代理二进制文件
- en: ❹ Returns a shell script that installs the proxy and starts it up with the server
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 返回一个安装代理并使用服务器启动它的shell脚本
- en: ❺ Configures the systemd daemon to start and stop the Cloud SQL Auth proxy
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 配置systemd守护进程以启动和停止Cloud SQL Auth代理
- en: ❻ Uses the module to create the JSON configuration for the Google compute instance
    and includes a startup script to install the proxy
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 使用模块创建Google计算实例的JSON配置，并包括一个启动脚本以安装代理
- en: ❼ Adds the startup script to the server. I omit other attributes for clarity.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: ❼ 将启动脚本添加到服务器。为了清晰起见，我省略了其他属性。
- en: AWS and Azure equivalents
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure的等效方案
- en: For AWS and Azure, you do not have to install software for the proxy on the
    instance. If you would like to reproduce listing 11.3 in AWS and Azure for practice,
    you can pass the startup script to the resource as `user_data` to the AWS instance
    or `custom_ data` to the Azure Linux virtual machine.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 对于AWS和Azure，你不需要在实例上安装代理的软件。如果你想在AWS和Azure中练习重现列表11.3，你可以将启动脚本作为`user_data`传递给AWS实例或`custom_data`传递给Azure
    Linux虚拟机。
- en: You *do not* update the service account with new permissions! In the spirit
    of incremental fixes, you want to avoid adding more changes to track as you push
    to production. You add the startup script to the promotions application’s server
    and change the testing environment without more updates.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 你**不**更新服务账户以添加新权限！本着增量修复的精神，你希望在推向生产时避免添加更多需要跟踪的变更。你将启动脚本添加到促销应用程序的服务器，并更改测试环境而无需更多更新。
- en: Startup script, configuration manager, or image builder?
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 启动脚本、配置管理器，还是镜像构建器？
- en: I use the startup script field in this example to avoid introducing more syntax.
    Instead, you should implement the configuration of any new packages or processes
    with a *configuration manager* or *image builder*.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，我使用启动脚本字段来避免引入更多语法。相反，你应该使用**配置管理器**或**镜像构建器**来实施任何新软件包或进程的配置。
- en: For example, the configuration manager would push the Cloud SQL Auth proxy installation
    process to any server with the promotions application. Similarly, the image builder
    configures the proxy for each image you bake! Whenever you reference the image
    for the promotions application, you always have the proxy built into the server.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，配置管理器会将 Cloud SQL Auth 代理安装过程推送到任何带有促销应用程序的服务器。同样，镜像构建器为每个你烘焙的镜像配置代理！每次你引用促销应用程序的镜像时，你总是会在服务器中内置了代理。
- en: 11.3.2 Reconcile differences in environments
  id: totrans-139
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.3.2 调和环境之间的差异
- en: While you updated your IaC to account for drift, you also need to make sure
    testing and production environments use your new IaC. For Cool Caps for Keys,
    you make sure the database connection works in the testing environment. Then,
    you ask the promotions team to update its application configuration to connect
    to the database through the proxy on `localhost`.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 当你更新你的基础设施即代码（IaC）以处理漂移时，你还需要确保测试和生产环境使用你的新 IaC。对于 Cool Caps for Keys，你确保数据库连接在测试环境中工作。然后，你要求促销团队更新其应用程序配置，通过
    `localhost` 上的代理连接到数据库。
- en: The promotions team pushes its application configuration to use the Cloud SQL
    Auth proxy into the testing environment, run tests, and update production, as
    shown in figure 11.10\. You keep the `roles/cloudsql.admin` permission on the
    service account because the proxy needs it.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 促销团队将其应用程序配置推送到测试环境以使用 Cloud SQL Auth 代理，运行测试，并更新生产环境，如图 11.10 所示。你保留服务账户上的
    `roles/cloudsql.admin` 权限，因为代理需要它。
- en: '![](../../OEBPS/Images/CH11_F10_Wang.png)'
  id: totrans-142
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH11_F10_Wang.png)'
- en: Figure 11.10 You need to push your IaC changes onto the promotions application’s
    server in testing and production environments.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11.10 你需要将你的 IaC 变更推送到测试和生产环境中的促销应用程序服务器。
- en: The push re-creates the production server with the new startup script. After
    additional end-to-end testing for the promotions application, you confirm that
    you successfully updated both testing and production environments.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 推送重新创建带有新启动脚本的生成服务器。在为促销应用程序进行额外的端到端测试之后，你确认你成功更新了测试和生产环境。
- en: Why start with reconciling drift before differences between production and testing
    environments? In this example, you opt to reconcile drift first because you will
    spend more time manually installing the packages in the testing environment. If
    you update your IaC and automate the package installation, you can ensure that
    the change works in the testing environment before pushing it to the production
    environment.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么在生产环境和测试环境之间的差异之前先调和漂移？在这个例子中，你选择先调和漂移，因为你将花费更多时间手动在测试环境中安装软件包。如果你更新你的 IaC
    并自动化软件包安装，你可以在将其推送到生产环境之前确保更改在测试环境中工作。
- en: You might choose to reconcile testing and production environments first because
    you have a large amount of drift. In that case, match testing and production environments
    before fixing drift. You want an accurate testing environment before you implement
    your reconciliation changes.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会选择首先调和测试环境和生产环境，因为你有很多漂移。在这种情况下，在修复漂移之前先匹配测试环境和生产环境。在你实施调和变更之前，你希望有一个准确的测试环境。
- en: Reconcile drift and differences in environments to help the next person make
    updates to the system. They do not have to worry about knowing the difference
    in configuration or manually configuring the proxy. The extra time you spend updating
    your IaC helps you avoid additional time debugging!
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 调和漂移和环境差异，以帮助下一个人更新系统。他们不必担心了解配置差异或手动配置代理。你花费在更新你的 IaC 上的额外时间可以帮助你避免额外的调试时间！
- en: 11.3.3 Implement the original change
  id: totrans-148
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.3.3 实施原始变更
- en: Now that you’ve minimized the blast radius of potential failure by reconciling
    drift and updating your environments, you can finally push forward the original
    change. Your debugging and incremental fixes change your infrastructure. When
    you return to implementing the original change, you may need to adjust your code.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您通过对齐漂移和更新环境最小化了潜在失败的范围，您最终可以推进原始更改。您的调试和增量修复更改了您的基础设施。当您返回实施原始更改时，您可能需要调整您的代码。
- en: Let’s finish the original change for the Cool Caps for Keys promotions application.
    Recall that the security team asked you to remove administrative permissions from
    the service account. This process ensures least-privilege access and accounts
    for using the Cloud SQL Auth proxy.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们完成Cool Caps for Keys促销应用程序的原始更改。回想一下，安全团队要求您从服务账户中移除管理权限。这个过程确保了最小权限访问，并考虑到了使用Cloud
    SQL Auth代理。
- en: You know that the service account must have database access because the application
    uses the Cloud SQL Auth proxy. Now, you try to figure out what kind of minimal
    access the application *should* use. The `roles/cloudsql.client` permission offers
    enough access for a service account to get a list of instances and connect to
    them.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 您知道服务账户必须具有数据库访问权限，因为应用程序使用了Cloud SQL Auth代理。现在，您试图弄清楚应用程序*应该*使用什么样的最小访问权限。`roles/cloudsql.client`权限为服务账户提供了足够的访问权限，以便获取实例列表并连接到它们。
- en: In figure 11.11, you change the service account’s permissions from administrative
    access to `roles/cloudsql.client`. You push this change to the testing environment,
    verify that promotions still work, and deploy the `roles/cloudsql.client` permission
    to production.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 在图11.11中，您将服务账户的权限从管理访问更改为`roles/cloudsql.client`。您将此更改推送到测试环境，验证促销是否仍然工作，并将`roles/cloudsql.client`权限部署到生产环境。
- en: '![](../../OEBPS/Images/CH11_F11_Wang.png)'
  id: totrans-153
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH11_F11_Wang.png)'
- en: Figure 11.11 You need to push your IaC changes onto the promotions application’s
    server in testing and production environments.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.11 您需要将IaC更改推送到测试和生产环境中的促销应用程序服务器。
- en: You reconciled the difference between testing and production environments for
    the proxy. In theory, the testing environment should now catch any issues with
    your change. Any failed changes should now appear in the testing environment.
    Let’s change the permission for the service account in the following listing from
    `roles/cloudsql.admin` to `roles/cloudsql.client`.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 您已对代理的测试和生产环境之间的差异进行了对齐。理论上，测试环境现在应该能够捕捉到您更改中的任何问题。任何失败的更改现在应该出现在测试环境中。让我们在以下列表中将服务账户的权限从`roles/cloudsql.admin`更改为`roles/cloudsql.client`。
- en: Listing 11.4 Changing the service account role to the database client
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 列表11.4 将服务账户角色更改为数据库客户端
- en: '[PRE6]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: ❶ Changes the promotions service account role to client access, which allows
    connecting to the database instance
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将促销服务账户角色更改为客户端访问，允许连接到数据库实例
- en: ❷ Imports the network, database, and server modules without changing the resources
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 不更改资源导入网络、数据库和服务器模块
- en: ❸ Imports the service account and attaches the “roles/cloudsql .client” role
    to its permissions
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 导入服务账户并将其“roles/cloudsql.client”角色附加到其权限
- en: AWS and Azure equivalents
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure的等效权限
- en: The AWS equivalent of the GCP Cloud SQL administrator permission is similar
    to `AmazonRDSFullAccess`. Azure does not have an exact equivalent. Instead, you
    will need to add an Azure Active Directory account to the database directly and
    grant administrative consent for Azure SQL Database API permissions.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: AWS中与GCP云SQL管理员权限等效的是`AmazonRDSFullAccess`。Azure没有确切的等效权限。相反，您需要直接将Azure Active
    Directory账户添加到数据库中，并授予Azure SQL数据库API权限的管理权限。
- en: In AWS, you can add the `rds-db:connect` action to the IAM role attached to
    the EC2 instance. In Azure, you will need to revoke administrative access and
    grant `SELECT` access to the Azure AD user linked to the database user ([http://mng.bz/woo7](https://shortener.manning.com/woo7)).
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 在AWS中，您可以将`rds-db:connect`操作添加到附加到EC2实例的IAM角色中。在Azure中，您需要撤销管理访问权限，并授予与数据库用户链接的Azure
    AD用户的`SELECT`访问权限（[http://mng.bz/woo7](https://shortener.manning.com/woo7)）。
- en: You commit and apply the change. The testing environment applies the change
    and validates that the application still works! You confirm with the promotions
    team, which approves the production change.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 您提交并应用更改。测试环境应用更改并验证应用程序仍然可以工作！您与促销团队确认，该团队批准了生产更改。
- en: The team promotes the new permissions change to production, runs end-to-end
    tests, and confirms that the promotions application can access the database! After
    a few weeks of debugging and making changes, you can *finally* fix the other applications
    in Cool Caps for Keys.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 团队将新的权限更改推广到生产环境，运行端到端测试，并确认推广应用程序可以访问数据库！经过几周的调试和更改后，你终于可以修复Cool Caps for Keys中的其他应用程序了。
- en: Why dedicate an entire chapter with a single example of fixing failed changes?
    It represents the reality of fixing IaC. You want to resolve the failure as quickly
    as possible without making it worse.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么用一个修复失败的更改的例子来单独占据一整章？这代表了修复基础设施即代码（IaC）的现实。你希望尽快解决问题，而不要使问题变得更糟。
- en: Rolling *forward* helps restore the system’s working state and minimize disruption
    to infrastructure resources. Then, you can work on troubleshooting the root cause.
    Many infrastructure failures come from drift, dependencies, or differences between
    testing and production environments. After you address these discrepancies, you
    implement your original change.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 向前滚动有助于恢复系统的正常工作状态并最小化对基础设施资源的影响。然后，你可以着手排查根本原因。许多基础设施故障源于漂移、依赖关系或测试和生产环境之间的差异。在你解决这些差异之后，你实施你的原始更改。
- en: Learning the art of rolling forward IaC takes time and experience. While you
    could just log into the cloud provider console and make manual changes to get
    the system working, remember that the bandage will fall off very quickly and won’t
    promote long-term system healing. Using IaC to track and fix the system incrementally
    minimizes the impact of the repairs and provides context for anyone else updating
    the system.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 学习滚动前进基础设施即代码的艺术需要时间和经验。虽然你可以直接登录云服务提供商的控制台进行手动更改以使系统工作，但请记住，这种临时修补很快就会失效，而且不会促进长期系统的修复。使用IaC跟踪和逐步修复系统可以最小化维修的影响，并为其他更新系统的人提供上下文。
- en: Summary
  id: totrans-169
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: Repairing failures for IaC involves rolling forward fixes instead of rolling
    them back.
  id: totrans-170
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于基础设施即代码的故障修复，涉及向前滚动修复而不是回滚。
- en: Rolling forward IaC uses immutability to return the system to a working state.
  id: totrans-171
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 向前滚动基础设施即代码使用不可变性将系统恢复到工作状态。
- en: Before debugging and implementing long-term fixes, prioritize stabilizing and
    restoring the system to a working state.
  id: totrans-172
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在进行调试和实施长期修复之前，应优先稳定系统并恢复其到工作状态。
- en: When troubleshooting IaC, check for drift, unexpected dependencies, and differences
    between environments as part of the root cause.
  id: totrans-173
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在排查基础设施即代码的问题时，检查漂移、意外的依赖关系以及环境之间的差异，作为根本原因的一部分。
- en: Work on incremental fixes to quickly recognize and reduce the blast radius of
    potential failure.
  id: totrans-174
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 专注于增量修复，以便快速识别并减少潜在故障的影响范围。
- en: Before you re-implement the original change that failed, make sure you reconcile
    drift and differences between environments for accurate testing and future system
    updates.
  id: totrans-175
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在重新实施失败的原始更改之前，确保你解决了漂移和环境之间的差异，以便进行准确的测试和未来的系统更新。
- en: Reconstructing state in IaC to reconcile drift involves aggregating manual commands
    for server configuration or transforming infrastructure metadata into IaC.
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在基础设施即代码（IaC）中重建状态以解决漂移问题，涉及聚合服务器配置的手动命令或将基础设施元数据转换为IaC。
