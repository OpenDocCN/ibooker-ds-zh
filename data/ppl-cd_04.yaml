- en: 5 Discovering Jenkins as code with Terraform
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5 使用 Terraform 发现 Jenkins 作为代码
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Introducing infrastructure as code (IaC)
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 介绍基础设施即代码 (IaC)
- en: Using HashiCorp Terraform, which enables IaC
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用支持基础设施即代码 (IaC) 的 HashiCorp Terraform
- en: Deploying Jenkins in a secure private network
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在安全的私有网络中部署 Jenkins
- en: Scaling Jenkins workers dynamically with AWS Auto Scaling
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 AWS Auto Scaling 动态扩展 Jenkins 工作节点
- en: In the previous chapter, we used HashiCorp Packer to create custom Jenkins machine
    images; in this chapter, we will use those images (figure 5.1) to deploy the machines.
    To do that, we will write declarative definitions of the Jenkins infrastructure
    we want to exist and use an automation tool to deploy the resources on the given
    infrastructure-as-a service (IaaS) provider.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，我们使用了 HashiCorp Packer 来创建自定义 Jenkins 机器镜像；在本章中，我们将使用这些镜像（图 5.1）来部署机器。为此，我们将编写我们希望存在的
    Jenkins 基础设施声明性定义，并使用自动化工具在给定的基础设施即服务 (IaaS) 提供商上部署资源。
- en: In the past, managing IT infrastructure was a hard job. System administrators
    had to manually manage and configure all of the hardware and software that was
    needed for the applications to run. However, in recent years, things have changed
    dramatically. Trends like cloud computing revolutionized—and improved—the way
    organizations design, develop, and maintain their IT infrastructure. One of the
    critical components of this trend is called infrastructure as code.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 在过去，管理 IT 基础设施是一项艰巨的工作。系统管理员必须手动管理和配置所有必需的硬件和软件，以便应用程序运行。然而，近年来，情况发生了巨大变化。云计算等趋势彻底改变并改善了组织设计、开发和维护
    IT 基础设施的方式。这一趋势的关键组成部分之一被称为基础设施即代码。
- en: '![](Images/CH05_F01_Labouardy.png)'
  id: totrans-8
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F01_Labouardy.png)'
- en: Figure 5.1 Jenkins custom machine images
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.1 Jenkins 自定义机器镜像
- en: 5.1 Introducing infrastructure as code
  id: totrans-10
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 5.1 介绍基础设施即代码
- en: '*Infrastructure* *as code* (IaC) allows you to manage your infrastructure by
    using configuration files. This decreases costs, reduces risks, and deploys faster
    resources on the cloud. Another benefit is that your infrastructure becomes testable,
    repeatable, self-healing, idempotent, and, most importantly, easy to understand,
    because your infrastructure code will essentially be your documentation.'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: '*基础设施* *即代码* (IaC) 允许您通过使用配置文件来管理您的基础设施。这降低了成本，减少了风险，并在云上更快地部署资源。另一个好处是，您的基础设施变得可测试、可重复、自我修复、幂等，最重要的是，易于理解，因为您的基础设施代码本质上将是您的文档。'
- en: Several IaC tools are available, each with its own implementation (figure 5.2).
    Some tools are focused on specific clouds, including AWS CloudFormation ([https://aws.amazon.com/cloudformation/](https://aws.amazon.com/cloudformation/)),
    Azure Resource Manager ([https://azure.microsoft.com/features/resource-manager/](https://azure.microsoft.com/features/resource-manager/)),
    OpenStack Heat ([https://wiki.openstack.org/wiki/Heat](https://wiki.openstack.org/wiki/Heat)),
    and Google Cloud Deployment Manager ([https://cloud.google.com/deployment-manager](https://cloud.google.com/deployment-manager)).
    Others are attempting to bridge all cloud providers and mask their semantic differences
    to provide a cloud-agnostic implementation. This category includes HashiCorp Terraform,
    HashiCorp Vagrant, Chef Provisioning, and Pulumi.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 可用几种 IaC 工具，每种都有自己的实现（图 5.2）。一些工具专注于特定的云，包括 AWS CloudFormation ([https://aws.amazon.com/cloudformation/](https://aws.amazon.com/cloudformation/))、Azure
    Resource Manager ([https://azure.microsoft.com/features/resource-manager/](https://azure.microsoft.com/features/resource-manager/))、OpenStack
    Heat ([https://wiki.openstack.org/wiki/Heat](https://wiki.openstack.org/wiki/Heat))
    和 Google Cloud Deployment Manager ([https://cloud.google.com/deployment-manager](https://cloud.google.com/deployment-manager))。其他工具试图连接所有云提供商并屏蔽它们的语义差异，以提供云无关的实现。这一类别包括
    HashiCorp Terraform、HashiCorp Vagrant、Chef Provisioning 和 Pulumi。
- en: '![](Images/CH05_F02_Labouardy.png)'
  id: totrans-13
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F02_Labouardy.png)'
- en: Figure 5.2 Infrastructure-as-code tools
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.2 基础设施即代码工具
- en: In this book, we will focus exclusively on using HashiCorp Terraform to deploy
    Jenkins components. Terraform provides a flexible abstraction of resources and
    providers, is platform-agnostic, and supports multiple IaaS providers such as
    AWS, Microsoft Azure, Google Cloud Platform, and DigitalOcean. Moreover, Terraform
    is open source and comes with a simple and unified syntax with no steep learning
    curve for new users and easy-to-access online resources for any infrastructure
    deployment use case.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书中，我们将专注于使用 HashiCorp Terraform 来部署 Jenkins 组件。Terraform 提供了灵活的资源和服务提供者抽象，平台无关，并支持多个
    IaaS 提供商，如 AWS、Microsoft Azure、Google Cloud Platform 和 DigitalOcean。此外，Terraform
    是开源的，并附带简单统一的语法，对于新用户来说没有陡峭的学习曲线，并且对于任何基础设施部署用例都有易于访问的在线资源。
- en: Note Configuration management tools like Ansible and Puppet were built to install
    and manage configuration on existing servers. Terraform focuses on bootstrapping
    and initialization of servers and other infrastructure resources.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：配置管理工具如 Ansible 和 Puppet 是为了在现有服务器上安装和管理配置而构建的。Terraform 专注于服务器的引导和初始化以及其他基础设施资源。
- en: Over the next few sections, you will learn how to use Terraform to deploy a
    Jenkins cluster on AWS.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的几节中，您将学习如何使用 Terraform 在 AWS 上部署 Jenkins 集群。
- en: 5.1.1 Terraform usage
  id: totrans-18
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.1.1 Terraform 使用
- en: 'Terraform uses a push approach: the developer or ops engineer describes the
    desired infrastructure in a template file, and Terraform directly interacts with
    the cloud provider through its API. For example, if the target cloud provider
    is AWS, Terraform uses the Terraform AWS provider plugin ([https://registry.terraform.io/providers/hashicorp/aws/latest](https://registry.terraform.io/providers/hashicorp/aws/latest)),
    which, under the hood, uses the AWS official SDK to create/update or destroy resources.'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: Terraform 使用推送方法：开发者或运维工程师在模板文件中描述所需的架构，Terraform 通过其 API 直接与云服务提供商交互。例如，如果目标云服务提供商是
    AWS，Terraform 使用 Terraform AWS 提供商插件 ([https://registry.terraform.io/providers/hashicorp/aws/latest](https://registry.terraform.io/providers/hashicorp/aws/latest))，它底层使用
    AWS 官方 SDK 来创建/更新或销毁资源。
- en: To maintain the desired state of the infrastructure and detect changes, Terraform
    generates a JSON file named terraform.tfstate that stores the state of your managed
    infrastructure and configuration. Terraform uses a diffing technique to detect
    the changes before any operation. Therefore, individuals and teams can safely
    and predictably change the infrastructure.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 为了维护基础设施的期望状态并检测变更，Terraform 生成一个名为 terraform.tfstate 的 JSON 文件，该文件存储了您管理的基础设施和配置的状态。Terraform
    使用差异技术来在任何操作之前检测变更。因此，个人和团队可以安全且可预测地更改基础设施。
- en: Terraform itself is a CLI tool, which can be downloaded from its official release
    page ([www.terraform.io/downloads.html](http://www.terraform.io/downloads.html)),
    as shown in figure 5.3, by installing the binary for your operating system and
    architecture. It supports all major operating systems. Windows, macOS, and any
    Linux distribution are supported in both 32-bit and 64-bit versions.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: Terraform 本身是一个 CLI 工具，可以从其官方发布页面 ([www.terraform.io/downloads.html](http://www.terraform.io/downloads.html))
    下载，如图 5.3 所示，通过安装适用于您操作系统和架构的二进制文件。它支持所有主要操作系统。Windows、macOS 以及任何 Linux 发行版都支持
    32 位和 64 位版本。
- en: '![](Images/CH05_F03_Labouardy.png)'
  id: totrans-22
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F03_Labouardy.png)'
- en: Figure 5.3 Terraform download page
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.3 Terraform 下载页面
- en: 'Once you download the zip archive, unzip it to any convenient folder. Make
    sure that this folder is available in your `PATH` environment variable. To check
    whether Terraform is properly installed, issue this command:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 下载 zip 压缩文件后，将其解压到任何方便的文件夹中。请确保此文件夹包含在您的 `PATH` 环境变量中。要检查 Terraform 是否正确安装，请执行以下命令：
- en: '[PRE0]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Note At the time of writing this book, the latest stable version of HashiCorp
    Terraform is 1.0.0.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：在编写本书时，HashiCorp Terraform 的最新稳定版本是 1.0.0。
- en: If you get output similar to `Terraform vX.Y.Z`, congrats! You have a working
    Terraform installation. We’re ready to write our Terraform template files.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您得到类似 `Terraform vX.Y.Z` 的输出，恭喜！您已成功安装 Terraform。我们现在可以编写 Terraform 模板文件了。
- en: 5.2 Provisioning an AWS VPC
  id: totrans-28
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 5.2 部署 AWS VPC
- en: 'As discussed in chapter 3, our Jenkins cluster will be deployed inside a VPC
    within private subnets; see figure 5.4\. We can deploy the cluster in the default
    VPC created by AWS. However, to have full control of the network topology, we
    will create a VPC from scratch to isolate the Jenkins cluster from the application
    workloads we’re going to deploy in advanced chapters. The following schema summarizes
    the target VPC architecture:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 如第 3 章所述，我们的 Jenkins 集群将部署在 VPC 内的私有子网中；请参阅图 5.4。我们可以将集群部署在 AWS 创建的默认 VPC 中。然而，为了完全控制网络拓扑，我们将从头创建一个
    VPC，以将 Jenkins 集群与我们将在高级章节中部署的应用程序工作负载隔离开来。以下方案总结了目标 VPC 架构：
- en: Note To understand Amazon VPC terminology (subnets, security groups, route tables,
    and so forth), refer to chapter 3.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：为了理解 Amazon VPC 术语（子网、安全组、路由表等），请参阅第 3 章。
- en: '![](Images/CH05_F04_Labouardy.png)'
  id: totrans-31
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F04_Labouardy.png)'
- en: Figure 5.4 AWS virtual private cloud architecture
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.4 AWS 虚拟专用云架构
- en: In essence, this VPC will be divided into subnets. Some subnets will be public,
    with access to the internet; and some will be private. Then, we define routing
    rules between subnets to allow traffic to go through either an internet gateway
    or NAT gateway. We will also deploy a bastion host to be able to SSH to Jenkins
    private instances without exposing them to the public.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 从本质上讲，这个 VPC 将被划分为子网。一些子网将是公共的，可以访问互联网；而一些将是私有的。然后，我们定义子网之间的路由规则，允许流量通过互联网网关或
    NAT 网关进行传输。我们还将部署一个堡垒主机，以便能够 SSH 到 Jenkins 的私有实例，而无需将其暴露给公众。
- en: 5.2.1 AWS VPC
  id: totrans-34
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.2.1 AWS VPC
- en: Terraform uses a DSL called *HashiCorp Configuration Language* (HCL), a declarative
    language to describe infrastructure resources. These resources are described in
    a simple text file with a .tf extension.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: Terraform 使用一种称为 *HashiCorp 配置语言* (HCL) 的 DSL，这是一种声明性语言，用于描述基础设施资源。这些资源以 .tf
    扩展名的简单文本文件进行描述。
- en: 'Instead of writing one big template file, we will use a modular development
    approach and split our Jenkins cluster deployment into multiple template files.
    Each file is responsible for deploying a component or an AWS resource of the target
    infrastructure. First, create a terraform.tf file with the following content:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 我们不会编写一个大型的模板文件，而是将采用模块化开发方法，并将 Jenkins 集群部署拆分为多个模板文件。每个文件负责部署目标基础设施的一个组件或 AWS
    资源。首先，创建一个包含以下内容的 terraform.tf 文件：
- en: '[PRE1]'
  id: totrans-37
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Note Through the rest of the chapters, Terraform will store the state locally,
    which isn’t ideal for team collaboration, as the state might contain sensitive
    information (if you plan to use SCM for versioning). I recommend using a remote
    backend such as Amazon S3 to store the state.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：在本章的其余部分，Terraform 将本地存储状态，这对于团队协作来说并不理想，因为状态可能包含敏感信息（如果您计划使用版本控制系统进行版本控制）。我建议使用远程后端，如
    Amazon S3 来存储状态。
- en: 'For Terraform to interact with an IaaS, it needs to have a provider configured.
    In the preceding code block, we defined AWS as a provider and configured the needed
    credentials to interact with the AWS API to create AWS resources afterward. The
    AWS provider supports multiple methods of authentication:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使 Terraform 能够与 IaaS 交互，它需要配置一个提供程序。在前面的代码块中，我们定义了 AWS 作为提供程序，并配置了与 AWS API
    交互所需的凭据，以便随后创建 AWS 资源。AWS 提供程序支持多种身份验证方法：
- en: Static credentials by providing `access_key` and `secret_key` attributes inline
    in the `aws` provider block.
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过在 `aws` 提供程序块中内联提供 `access_key` 和 `secret_key` 属性来提供静态凭据。
- en: Environment variables via `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS _KEY` variables.
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过 `AWS_ACCESS_KEY_ID` 和 `AWS_SECRET_ACCESS_KEY` 变量提供环境变量。
- en: A shared credentials file located by default at ~/.aws/credentials on Linux
    and macOS, and %USERPROFILE%\.aws\credentials for Windows users. By default, Terraform
    will check these locations, but you can optionally specify a different location
    in the configuration by providing the `shared_credentials_file` attribute. Also,
    if you have multiple profiles defined in the credentials file, you can specify
    the profile to use through the `AWS_PROFILE` environment variable by setting the
    `profile` attribute.
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 默认情况下，位于 Linux 和 macOS 的 ~/.aws/credentials 文件以及 Windows 用户的 %USERPROFILE%\.aws\credentials
    文件中的共享凭据文件。默认情况下，Terraform 将检查这些位置，但您可以通过提供 `shared_credentials_file` 属性在配置中指定不同的位置。此外，如果您在凭据文件中定义了多个配置文件，您可以通过设置
    `profile` 属性通过 `AWS_PROFILE` 环境变量来指定要使用的配置文件。
- en: An EC2 IAM instance profile if you’re using Terraform from an EC2 instance.
    Terraform will fetch the temporary access tokens from the instance’s metadata.
    This is a preferred approach over the preceding strategies when running in an
    EC2 instance, as you can avoid hardcoding credentials.
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果你从EC2实例使用Terraform，则需要一个EC2 IAM实例配置文件。Terraform将从实例的元数据中获取临时访问令牌。当在EC2实例中运行时，这是一种比前面策略更受欢迎的方法，因为它可以避免硬编码凭证。
- en: 'Next, we will declare an AWS VPC resource in a vpc.tf file. The following code
    snippet uses the CIDR block 10.0.0.0/16 for the VPC, but you can choose a different
    CIDR block:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将在vpc.tf文件中声明一个AWS VPC资源。以下代码片段使用CIDR块10.0.0.0/16为VPC，但您可以选择不同的CIDR块：
- en: '[PRE2]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Note All available AWS resources can be found in the Terraform AWS documentation
    at [www.terraform.io/docs/providers/aws/index.html](http://www.terraform.io/docs/providers/aws/index.html).
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：所有可用的AWS资源都可以在Terraform AWS文档中找到，请参阅[www.terraform.io/docs/providers/aws/index.html](http://www.terraform.io/docs/providers/aws/index.html)。
- en: Note the use of variables instead of hardcoded values to create reusable resources
    (portability) and give users the flexibility to override them during runtime.
    We’ll define the list of variables in the variables.tf file, shown in the following
    listing.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 注意使用变量而不是硬编码的值来创建可重用的资源（可移植性）并允许用户在运行时覆盖它们。我们将在variables.tf文件中定义变量列表，如下所示。
- en: Listing 5.1 Terraform variables file
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 列表5.1 Terraform变量文件
- en: '[PRE3]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Terraform variables are created with a `variable` block. They have a name and
    an optional type, default value, and description arguments. Table 5.1 provides
    the full list of variables.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: Terraform变量是通过`variable`块创建的。它们有一个名称，以及可选的类型、默认值和描述参数。表5.1提供了变量的完整列表。
- en: Table 5.1 VPC’s Terraform variables
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 表5.1 VPC的Terraform变量
- en: '| Variable | Type | Value | Description |'
  id: totrans-52
  prefs: []
  type: TYPE_TB
  zh: '| 变量 | 类型 | 值 | 描述 |'
- en: '| `region` | String | None | The name of the region, such as `eu-central-1`,
    in which to deploy the VPC. |'
  id: totrans-53
  prefs: []
  type: TYPE_TB
  zh: '| `region` | 字符串 | None | 部署VPC的区域名称，例如`eu-central-1`。 |'
- en: '| `shared_credentials_file` | String | `~/.aws/credentials` | The path to the
    shared credentials file. If this is not set and a profile is specified, `~/.aws/credentials`
    will be used. |'
  id: totrans-54
  prefs: []
  type: TYPE_TB
  zh: '| `shared_credentials_file` | 字符串 | `~/.aws/credentials` | 共享凭证文件的路径。如果未设置且指定了配置文件，则使用`~/.aws/credentials`。
    |'
- en: '| `aws_profile` | String | `profile` | The AWS profile name as set in the shared
    credentials file. |'
  id: totrans-55
  prefs: []
  type: TYPE_TB
  zh: '| `aws_profile` | 字符串 | `profile` | 在共享凭证文件中设置的AWS配置文件名称。 |'
- en: '| `cidr_block` | String | `10.0.0.0/16` | The CIDR block for the VPC. The allowed
    block size is between a /16 netmask (65,536 IP addresses) and /28 netmask (16
    IP addresses). |'
  id: totrans-56
  prefs: []
  type: TYPE_TB
  zh: '| `cidr_block` | 字符串 | `10.0.0.0/16` | VPC的CIDR块。允许的块大小介于/16子网掩码（65,536个IP地址）和/28子网掩码（16个IP地址）之间。
    |'
- en: '| `vpc_name` | String | `management` | Ensure that your VPC is using appropriate
    naming for tagging to manage it more efficiently and adhere to AWS resource tagging
    best practices. |'
  id: totrans-57
  prefs: []
  type: TYPE_TB
  zh: '| `vpc_name` | 字符串 | `management` | 确保您的VPC使用适当的命名来标记，以便更有效地管理，并遵循AWS资源标记最佳实践。
    |'
- en: '| `autho`r | String | None | Name of the owner of the VPC. It’s optional, but
    it’s recommended to tag your AWS resources to track the monthly costs by owner
    or environment. |'
  id: totrans-58
  prefs: []
  type: TYPE_TB
  zh: '| `author` | 字符串 | None | VPC的所有者名称。这是可选的，但建议您对AWS资源进行标记，以便按所有者或环境跟踪月度成本。 |'
- en: 'Before running Terraform, we need to install the AWS plugin for Terraform.
    You can do this by executing the following command:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 在运行Terraform之前，我们需要安装Terraform的AWS插件。您可以通过执行以下命令来完成此操作：
- en: '[PRE4]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'This installs the AWS provider plugin and initializes a new configuration:'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 这将安装AWS提供者插件并初始化一个新的配置：
- en: '![](Images/CH05_F04_UN01_Labouardy.png)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F04_UN01_Labouardy.png)'
- en: Note To be able to use Terraform for the examples in this chapter, add the VPCFullAccess
    policy to the IAM user associated with Terraform.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：为了能够使用本章中的Terraform示例，请将VPCFullAccess策略添加到与Terraform关联的IAM用户。
- en: 'Use the following command to generate an execution plan of changes that will
    be applied (for a dry run):'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下命令生成将要应用的变化的执行计划（用于干运行）：
- en: '[PRE5]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: You can specify individual variables on the command line with the `-var` option
    when running `terraform plan`. However, because we have a lot of variables to
    set, it is more convenient and handy to use a variable definitions file called
    variables.tfvars.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 当运行`terraform plan`时，您可以使用`-var`选项在命令行上指定单个变量。然而，由于我们需要设置很多变量，使用名为variables.tfvars的变量定义文件会更方便和实用。
- en: This file contains dynamic variables declared in the variables.tf file such
    as for the AWS region and credentials file. Any variable for which you define
    a value needs to exist in variables.tf, as shown in the following listing.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 此文件包含在variables.tf文件中声明的动态变量，例如AWS区域和凭证文件。任何你定义了值的变量都需要存在于variables.tf中，如下所示。
- en: Listing 5.2 Terraform dynamic variables
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 列表5.2 Terraform动态变量
- en: '[PRE6]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Note If you named the variable definition files terraform.tfvars or terraform
    .tfvars.json, they will be loaded automatically by Terraform.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：如果你将变量定义文件命名为terraform.tfvars或terraform.tfvars.json，它们将被Terraform自动加载。
- en: You can also load variables from environment variables. Terraform will parse
    any environment variables that are prefixed with `TF_VAR`. For example, if Terraform
    finds an environment variable named `TF_VAR_aws_profile`, it will use its value
    as the string value of the `aws_profile` variable.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以从环境变量中加载变量。Terraform将解析任何以`TF_VAR`为前缀的环境变量。例如，如果Terraform找到一个名为`TF_VAR_aws_profile`的环境变量，它将使用其值作为`aws_profile`变量的字符串值。
- en: 'The `terraform plan` command will display the target plan, which is particularly
    useful to validate the changes in advance and avoid unwanted changes. The output
    should look like this:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: '`terraform plan`命令将显示目标计划，这在提前验证更改和避免不希望的变化方面特别有用。输出应该看起来像这样：'
- en: '![](Images/CH05_F04_UN02_Labouardy.png)'
  id: totrans-73
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F04_UN02_Labouardy.png)'
- en: Note I highly recommend encrypting the state and plan files because they can
    potentially store secrets.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：我强烈建议加密状态和计划文件，因为它们可能存储机密信息。
- en: 'We can see that one resource will be created. Now we are comfortable that Terraform
    is going to do the right thing! We can apply the changes with the following command:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以看到将创建一个资源。现在我们放心了，Terraform将会做正确的事情！我们可以使用以下命令应用更改：
- en: '[PRE7]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Type `yes` to apply the actions, and Terraform will create the AWS VPC resource:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 输入`yes`以应用操作，Terraform将创建AWS VPC资源：
- en: '![](Images/CH05_F04_UN03_Labouardy.png)'
  id: totrans-78
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F04_UN03_Labouardy.png)'
- en: On the AWS VPC dashboard, you should see an additional VPC called *management*
    with the 10.0.0.0/16 CIDR block created, as shown in figure 5.5.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 在AWS VPC仪表板上，你应该看到一个新的VPC，名为*management*，并创建了10.0.0.0/16 CIDR块，如图5.5所示。
- en: '![](Images/CH05_F05_Labouardy.png)'
  id: totrans-80
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F05_Labouardy.png)'
- en: Figure 5.5 AWS VPC dashboard
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.5 AWS VPC仪表板
- en: Awesome—we have a custom VPC!
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 太棒了——我们有一个定制的VPC！
- en: 5.2.2 VPC subnets
  id: totrans-83
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.2.2 VPC子网
- en: Creating a VPC is not enough; to be able to place Jenkins instances in this
    isolated network, we also need a subnet. This subnet belongs to a previously created
    VPC, so we have to pass a VPC ID when we create it. We don’t have to hardcode
    it, though. Terraform, via interpolation syntax, allows us to reference any other
    resource via its ID.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个VPC是不够的；为了能够在这个隔离的网络中放置Jenkins实例，我们还需要一个子网。这个子网属于之前创建的VPC，因此我们在创建它时必须传递一个VPC
    ID。不过，我们不需要硬编码它。Terraform通过插值语法允许我们通过其ID引用任何其他资源。
- en: Create a subnets.tf file with two public subnets and two private subnets in
    different availability zones for resiliency, as shown in the following listing.
    Each subnet has its own CIDR block that is a subset of the VPC CIDR block.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个subnets.tf文件，其中包含两个公共子网和两个私有子网，分别位于不同的可用区以实现弹性，如下所示。每个子网都有自己的CIDR块，它是VPC
    CIDR块的子集。
- en: Listing 5.3 VPC subnets
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 列表5.3 VPC子网
- en: '[PRE8]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: ❶ The count.index variable has the distinct index number (starting with 0) and
    is used to construct a unique CIDR block within the 10.0.0.0/16 range
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ `count.index`变量具有独特的索引号（从0开始），用于在10.0.0.0/16范围内构建唯一的CIDR块
- en: ❷ Specify true to indicate that instances launched into the subnet should be
    assigned a public IP address
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 指定true以指示在子网中启动的实例应分配一个公共IP地址
- en: ❸ Gives a unique name to the subnet; for example, public_10.0.0.0_eu-central-1
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 为子网提供一个唯一的名称；例如，public_10.0.0.0_eu-central-1
- en: The code uses interpolation with a `count` attribute to give us a parameterized
    subnet. With this, we can calculate the subnet CIDR block with expressions such
    as `10.0.${count.index*2+1}.0/24`. You can also use the `cidrsubnet(prefix, newbits,`
    `netnum)` method to calculate the subnet address within a VPC CIDR block. (Refer
    to the documentation at [http://mng.bz/WBj0](http://mng.bz/WBj0) for more details.)
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 代码使用`count`属性进行插值，为我们提供了一个参数化的子网。有了这个，我们可以使用如`10.0.${count.index*2+1}.0/24`之类的表达式来计算子网CIDR块。你也可以使用`cidrsubnet(prefix,
    newbits, netnum)`方法来计算VPC CIDR块内的子网地址。（有关更多详细信息，请参阅[http://mng.bz/WBj0](http://mng.bz/WBj0)上的文档。）
- en: Set the default number of subnets to 2 and define the availability zones where
    the subnets will be located as variables in the variables.tf file. (You can use
    the `aws` `ec2 describe-availability-zones` command to view the availability zones
    within your AWS region.) Table 5.2 provides the complete list of Terraform variables.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在 variables.tf 文件中将子网默认数量设置为 2，并定义子网所在的可用区作为变量。（您可以使用 `aws ec2 describe-availability-zones`
    命令查看 AWS 区域内的可用区。）表 5.2 提供了 Terraform 变量的完整列表。
- en: Table 5.2 Subnet Terraform variables
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 表 5.2 子网 Terraform 变量
- en: '| Variable | Type | Value | Description |'
  id: totrans-94
  prefs: []
  type: TYPE_TB
  zh: '| 变量 | 类型 | 值 | 描述 |'
- en: '| `availability_zones` | List | None | Availability zone for spinning up the
    VPC subnet |'
  id: totrans-95
  prefs: []
  type: TYPE_TB
  zh: '| `availability_zones` | 列表 | 无 | 启动 VPC 子网可用区的列表 |'
- en: '| `public_subnets_count` | Number | 2 | The number of public subnets to create
    |'
  id: totrans-96
  prefs: []
  type: TYPE_TB
  zh: '| `public_subnets_count` | 数字 | 2 | 要创建的公共子网数量 |'
- en: '| `private_subnets_count` | Number | 2 | The number of private subnets to create
    |'
  id: totrans-97
  prefs: []
  type: TYPE_TB
  zh: '| `private_subnets_count` | 数字 | 2 | 要创建的私有子网数量 |'
- en: 'Run the `terraform` `plan` command to generate an action plan. This validates
    the configuration that will apply to the current infrastructure:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 运行 `terraform plan` 命令以生成操作计划。这验证了将应用于当前基础设施的配置：
- en: '![](Images/CH05_F05_UN04_Labouardy.png)'
  id: totrans-99
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F05_UN04_Labouardy.png)'
- en: If you are comfortable with the deployment plan, apply the configuration with
    the `terraform apply` command. The subnets should be created inside the VPC, as
    shown in figure 5.6.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您对部署计划感到满意，请使用 `terraform apply` 命令应用配置。子网应创建在 VPC 内，如图 5.6 所示。
- en: '![](Images/CH05_F06_Labouardy.png)'
  id: totrans-101
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F06_Labouardy.png)'
- en: Figure 5.6 VPC’s public and private subnets
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.6 VPC 的公共和私有子网
- en: After you’ve created the VPC and subnets, you need to create private and public
    route tables to define the traffic-routing mechanism in VPC subnets.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建 VPC 和子网之后，您需要创建私有和公共路由表以定义 VPC 子网中的流量路由机制。
- en: 5.2.3 VPC route tables
  id: totrans-104
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.2.3 VPC 路由表
- en: As stated earlier, the typical configuration for a VPC divides it into public
    and private subnets. To let instances deployed in private subnets have access
    to the internet without being exposed to the public, we will create private and
    public route tables for fine-grained traffic control.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，VPC 的典型配置将其分为公共和私有子网。为了让部署在私有子网中的实例能够访问互联网而不暴露在公共网络中，我们将创建私有和公共路由表以进行细粒度的流量控制。
- en: 'Create a public_rt.tf file, define an internet gateway resource, and attach
    it to the VPC created earlier:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个 public_rt.tf 文件，定义一个互联网网关资源，并将其附加到之前创建的 VPC：
- en: '[PRE9]'
  id: totrans-107
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Within public_rt.tf, define a public route table and a route that points all
    traffic (0.0.0.0/0) to the internet gateway:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 在 public_rt.tf 文件中，定义一个公共路由表和一个将所有流量（0.0.0.0/0）指向互联网网关的路由：
- en: '[PRE10]'
  id: totrans-109
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'So far, the public route table is not associated with any subnet. You need
    to associate it with public subnets in your VPC so that traffic coming from those
    subnets is routed to the internet gateway:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，公共路由表尚未与任何子网关联。您需要将其与 VPC 中的公共子网关联，以便来自这些子网的流量被路由到互联网网关：
- en: '[PRE11]'
  id: totrans-111
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Note I recommend generating an execution plan before deploying resources with
    Terraform to avoid any surprises when Terraform manipulates infrastructure.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：我建议在用 Terraform 部署资源之前生成执行计划，以避免 Terraform 操作基础设施时出现任何意外。
- en: Once you’ve applied Terraform changes with `terraform apply`, head over to the
    VPC dashboard and jump to the Route Tables section. You should see the public
    route table, as shown in figure 5.7.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦您使用 `terraform apply` 应用 Terraform 变更，请转到 VPC 仪表板并跳转到路由表部分。您应该看到公共路由表，如图 5.7
    所示。
- en: '![](Images/CH05_F07_Labouardy.png)'
  id: totrans-114
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F07_Labouardy.png)'
- en: Figure 5.7 VPC’s public route table
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.7 VPC 的公共路由表
- en: With the public route table created, go ahead and create the private route table.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建公共路由表后，继续创建私有路由表。
- en: Create a private_rt.tf file and define a NAT gateway resource inside a public
    subnet to enable Jenkins instances that will be deployed in private subnets later
    to connect to the internet. Then, associate an Elastic IP address with the NAT
    gateway, shown in the following listing.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个 private_rt.tf 文件，并在公共子网内定义一个 NAT 网关资源，以使稍后将在私有子网中部署的 Jenkins 实例能够连接到互联网。然后，将弹性
    IP 地址与 NAT 网关关联，如下所示。
- en: Listing 5.4 VPC NAT gateway
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.4 VPC NAT 网关
- en: '[PRE12]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Within the same file, create a private route table with a route that forwards
    all traffic (0.0.0.0/0) to the ID of the NAT gateway that you created, as shown
    in the following listing.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 在同一文件中，创建一个具有将所有流量（0.0.0.0/0）转发到您创建的 NAT 网关 ID 的私有路由表，如下所示。
- en: Listing 5.5 Private route table
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 列表5.5私有路由表
- en: '[PRE13]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Note If you prefer to manage a NAT instance, you can replace the current route
    that points to the NAT gateway with a route to the NAT instance.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：如果您更喜欢管理NAT实例，可以将指向NAT网关的当前路由替换为指向NAT实例的路由。
- en: 'Finally, assign private subnets to the private route table with the following
    code block:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，使用以下代码块将私有子网分配给私有路由表：
- en: '[PRE14]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: The Elastic IP address is a static public IPv4 address, so it may be useful
    to mask the failure of a NAT gateway by rapidly remapping the address to another
    NAT gateway.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 弹性IP地址是一个静态的公共IPv4地址，因此通过快速将地址重新映射到另一个NAT网关来掩盖NAT网关的故障可能是有用的。
- en: Use `terraform` `apply` to apply the infrastructure changes. A private route
    table should be created, as shown in figure 5.8.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`terraform apply`应用基础设施更改。应创建一个私有路由表，如图5.8所示。
- en: '![](Images/CH05_F08_Labouardy.png)'
  id: totrans-128
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F08_Labouardy.png)'
- en: Figure 5.8 VPC’s private route table
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.8 VPC的私有路由表
- en: An additional route table rule should be created to point internet-bound traffic
    to the NAT gateway. This enables Jenkins instances in the private subnets to have
    access to the internet.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 应创建一个额外的路由表规则，将互联网流量指向NAT网关。这使私有子网中的Jenkins实例能够访问互联网。
- en: Our Jenkins cluster will be deployed inside private subnets. Hence, instances
    won’t be publicly accessible from the internet (because the cluster doesn’t have
    a public IP). To securely access Jenkins instances, we will deploy a bastion host.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的Jenkins集群将部署在私有子网中。因此，实例不会从互联网公开访问（因为集群没有公共IP）。为了安全地访问Jenkins实例，我们将部署一个堡垒主机。
- en: Note You can skip this solution if you set up a remote access virtual private
    network (VPN) like OpenVPN Access Server. Refer to the official guide at [https://openvpn.net/aws-video-tutorials/byol/](https://openvpn.net/aws-video-tutorials/byol/)
    for instructions.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：如果您设置了类似OpenVPN Access Server的远程访问虚拟专用网络（VPN），则可以跳过此解决方案。有关说明，请参阅官方指南[https://openvpn.net/aws-video-tutorials/byol/](https://openvpn.net/aws-video-tutorials/byol/)。
- en: 5.2.4 VPC bastion host
  id: totrans-133
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.2.4 VPC堡垒主机
- en: A *bastion host*, also called a *jump box*, provides secure access to EC2 instances
    located in private subnets via a single controlled point of entry. A bastion host
    is a special-purpose machine, deployed in a public subnet, and has access to private
    instances within private subnets.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 一个*堡垒主机*，也称为*跳板机*，通过一个受控的入口点提供对位于私有子网中的EC2实例的安全访问。堡垒主机是一种专用机器，部署在公共子网中，并可以访问私有子网内的私有实例。
- en: These instances are accessed with the help of SSH or RDP protocols. After a
    connection is established with the bastion host, it allows using SSH or RDP to
    log in to other instances. In this way, it behaves like a jump box.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 这些实例通过SSH或RDP协议访问。与堡垒主机建立连接后，它允许使用SSH或RDP登录到其他实例。这样，它就像一个跳板。
- en: 'In a new bastion.tf file, define an EC2 instance resource within a public subnet
    to reach it from the outside internet:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 在新的bastion.tf文件中，定义一个位于公共子网中的EC2实例资源，以便从外部互联网访问它：
- en: '[PRE15]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'The EC2 instance uses an Amazon 2 Linux machine image. We use the `aws_ami`
    data source to get the AMI ID from the AWS marketplace. The `most_recent` attribute
    is enabled to use the recent AMI if more than one result is returned:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: EC2实例使用Amazon 2 Linux机器镜像。我们使用`aws_ami`数据源从AWS市场获取AMI ID。启用`most_recent`属性以使用最近的AMI，如果返回多个结果：
- en: '[PRE16]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Note If you want to add an extra layer of security for the bastion host, you
    can bake your own machine image with HashiCorp Packer by using the same procedure
    described in chapter 4.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：如果您想为堡垒主机添加额外的安全层，可以使用与第4章中描述的相同程序使用HashiCorp Packer创建自己的机器镜像。
- en: 'While creating the EC2, we attached an SSH key pair to be able to access via
    SSH to the bastion host with the private key. The key pair uses our public SSH
    key located under the .ssh folder in the working directory. You can also generate
    a new one with the `ssh-keygen` command. The following is the Terraform snippet
    code; the `aws_key_pair` resource takes as a parameter the SSH public-key file
    location:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建EC2时，我们附加了一个SSH密钥对，以便能够使用私钥通过SSH访问堡垒主机。该密钥对使用位于工作目录下的.ssh文件夹中的我们的公共SSH密钥。您也可以使用`ssh-keygen`命令生成一个新的密钥对。以下是一个Terraform代码片段；`aws_key_pair`资源将SSH公钥文件位置作为参数：
- en: '[PRE17]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'By default, SSH access to newly created EC2 instances is disabled. To allow
    SSH access to the bastion hosts, we will associate a security group to the running
    instance. The security group will allow inbound (ingress) traffic on port 22 (SSH)
    from anywhere (0.0.0.0/0). The CIDR source block can be replaced with your own
    public IP address/32 or network address to enhance security and prevent security
    breaches:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，SSH 访问新创建的 EC2 实例是禁用的。为了允许对堡垒主机进行 SSH 访问，我们将安全组关联到正在运行的实例。该安全组将允许来自任何地方（0.0.0.0/0）的端口
    22（SSH）的入站（入口）流量。CIDR 源块可以用你自己的公共 IP 地址/32 或网络地址替换，以增强安全性并防止安全漏洞：
- en: '[PRE18]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'You can use a website such as [icanhazip.com](https://icanhazip.com/) to retrieve
    your machine’s public IP address with the following code block:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用诸如 [icanhazip.com](https://icanhazip.com/) 这样的网站，通过以下代码块检索你的机器的公共 IP 地址：
- en: '[PRE19]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: If you want to use this in a network ingress rule, you can reference the IP
    address with the `data.http.ip.body` attribute.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想在网络入口规则中使用它，你可以使用 `data.http.ip.body` 属性引用 IP 地址。
- en: Once we have our networking setup ready, declare the new Terraform variables
    in variables.tf. Refer to chapter5/variables.tf for the complete list of variables.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们的网络设置就绪，就在 variables.tf 中声明新的 Terraform 变量。有关变量的完整列表，请参阅 chapter5/variables.tf。
- en: Then, apply the changes with `terraform` `apply`. A public EC2 instance should
    be deployed inside the VPC in a public subnet, as shown in figure 5.9.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，使用 `terraform apply` 应用更改。一个公共 EC2 实例应该部署在 VPC 的公共子网中，如图 5.9 所示。
- en: '![](Images/CH05_F09_Labouardy.png)'
  id: totrans-150
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F09_Labouardy.png)'
- en: Figure 5.9 Bastion host deployed in a public subnet
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.9 在公共子网中部署的堡垒主机
- en: 'We can copy the instance’s public IP address directly from the EC2 console.
    Alternatively, we can use the Terraform outputs feature to display the IP address
    in the terminal session by defining an outputs.tf file with the following content:'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以直接从 EC2 控制台中复制实例的公共 IP 地址。或者，我们可以使用 Terraform 输出功能，通过定义一个包含以下内容的 outputs.tf
    文件，在终端会话中显示 IP 地址：
- en: '[PRE20]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'To get the instance’s IPv4 public IP, you can reissue the `terraform` `apply`
    or `terraform` `output` command:'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 要获取实例的 IPv4 公共 IP，你可以重新发出 `terraform apply` 或 `terraform output` 命令：
- en: '![](Images/CH05_F09_UN05_Labouardy.png)'
  id: totrans-155
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F09_UN05_Labouardy.png)'
- en: 'With this Terraform code, we have our bastion host ready and can use it to
    set up an SSH tunnel to access private instances:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这段 Terraform 代码，我们已经准备好了堡垒主机，并可以使用它来设置 SSH 隧道以访问私有实例：
- en: '[PRE21]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Note You can take this further and deploy an Auto Scaling group (`min=1` and
    `max=1`) to ensure that a bastion host instance is always available. Also for
    cost optimization, you can use Spot instances instead of on-demand instances.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：你可以进一步部署一个自动扩展组（`min=1` 和 `max=1`），以确保堡垒主机实例始终可用。此外，为了成本优化，你可以使用 Spot 实例而不是按需实例。
- en: 'After creating these files, the directory structure should look as follows:'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 创建这些文件后，目录结构应如下所示：
- en: '[PRE22]'
  id: totrans-160
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: The files can be called anything. We’ve named them based on the AWS resources
    declared on each, and for convenience and identification. Remember all files that
    end in .tf will be loaded by Terraform.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 文件可以命名为任何东西。我们根据每个文件上声明的 AWS 资源进行了命名，以便于方便和识别。请记住，所有以 .tf 结尾的文件都将由 Terraform
    加载。
- en: 5.3 Setting up a self-healing Jenkins master
  id: totrans-162
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 5.3 设置自愈 Jenkins 主
- en: 'Now that our VPC has been created, we can deploy a dedicated EC2 instance to
    host the Jenkins master component within a private subnet, by defining an `aws_instance`
    resource in the jenkins_master.tf file with the following attributes. The instance
    is backed by an EBS volume (SSD) of 30 GB, which makes it suitable for a broad
    range of workloads:'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经创建了 VPC，我们可以在私有子网中部署一个专门的 EC2 实例来托管 Jenkins 主组件，通过在 jenkins_master.tf
    文件中定义 `aws_instance` 资源，并具有以下属性。该实例由一个 30 GB 的 EBS 卷（SSD）支持，这使得它适用于广泛的负载：
- en: '[PRE23]'
  id: totrans-164
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: The 30 GB storage value can change based on the number and size of the projects
    you will continuously build, because Jenkins settings and build logs are stored
    on the master by default.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 30 GB 的存储值可以根据你将连续构建的项目数量和大小而变化，因为 Jenkins 设置和构建日志默认存储在主节点上。
- en: Note A proper tagging policy for Jenkins instances is pivotal in cloud cost
    optimization. It leverages the use of filters within AWS bills and enforces tracking
    and cost allocation.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：为 Jenkins 实例制定适当的标记策略对于云成本优化至关重要。它利用 AWS 账单中的过滤器功能，并强制执行跟踪和成本分配。
- en: 'The EC2 instance uses the Jenkins master AMI baked by Packer in chapter 4,
    referenced by the `aws_ami` data resource:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: EC2 实例使用第 4 章中由 Packer 烘焙的 Jenkins 主 AMI，通过 `aws_ami` 数据资源引用：
- en: '[PRE24]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: We’ll attach a security group to the instance to allow SSH from the bastion
    host only and inbound traffic on port 8080 (Jenkins web dashboard) from VPC CIDR
    block; see the following listing.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将向实例附加一个安全组，仅允许从堡垒主机进行 SSH 连接，并允许来自 VPC CIDR 块的端口 8080（Jenkins 网页仪表板）的入站流量；请参阅以下列表。
- en: Listing 5.6 Jenkins security group
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.6 Jenkins 安全组
- en: '[PRE25]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: Next, define the instance type used to deploy the EC2 instance as a variable.
    For the sake of simplicity, `t2.large` (8 GB of memory and 2vCPU) should be enough,
    as we won’t be allocating executors/workers on the master. Hence, the Jenkins
    master won’t be overloaded by build jobs.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，将用于部署 EC2 实例的实例类型定义为变量。为了简化，`t2.large`（8 GB 内存和 2vCPU）应该足够了，因为我们不会在主节点上分配执行器/工作者。因此，Jenkins
    主机不会被构建作业所超载。
- en: However, the amount of memory Jenkins needs depends on your project build needs
    and tools required by the same builds. Each build node connection will take two
    to three threads, which equals about 2 MB or more of memory. You will also need
    to factor in CPU overhead for Jenkins if a lot of users will be accessing the
    Jenkins user interface.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，Jenkins 需要的内存量取决于您的项目构建需求和相同构建所需的工具。每个构建节点连接将占用两个到三个线程，这相当于大约 2 MB 或更多的内存。如果您有很多用户将访问
    Jenkins 用户界面，您还需要考虑 Jenkins 的 CPU 负载。
- en: That’s why we will deploy Jenkins workers later, to delegate builds to workers
    and keep the bulk of the work off the master itself. Therefore, a general-purpose
    instance to host a Jenkins master can provide a balance between compute and memory
    resources.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 正因如此，我们将在稍后部署 Jenkins 工作者，将构建委托给工作者，并将大部分工作从主节点本身移除。因此，用于托管 Jenkins 主机的一般用途实例可以在计算和内存资源之间提供平衡。
- en: 'Note For more information, see the EC2 general-purpose instance documentation:
    [https://aws.amazon.com/ec2/pricing/on-demand/](https://aws.amazon.com/ec2/pricing/on-demand/).'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：有关更多信息，请参阅 EC2 通用实例文档：[https://aws.amazon.com/ec2/pricing/on-demand/](https://aws.amazon.com/ec2/pricing/on-demand/)。
- en: 'The `t2.large` instance type may be a good option (though this instance type
    is not part of the AWS Free Tier, so you should terminate it or turn it off when
    you’re done experimenting). Declare it as a variable in the variables.tfvars file:'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: '`t2.large` 实例类型可能是一个不错的选择（尽管这种实例类型不属于 AWS 免费层，所以当你完成实验后应该终止它或将其关闭）。在 variables.tfvars
    文件中将它声明为一个变量：'
- en: '[PRE26]'
  id: totrans-177
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Note I encourage you to benchmark your project builds on several Amazon EC2
    instance types to select the most appropriate configuration.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：我鼓励您在几个 Amazon EC2 实例类型上对项目构建进行基准测试，以选择最合适的配置。
- en: 'Generate an execution plan with this command:'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下命令生成执行计划：
- en: '[PRE27]'
  id: totrans-180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'You should see output similar to the following (the full `terraform` `plan`
    has been cropped for brevity):'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该看到类似以下输出（为了简洁，已裁剪完整的 `terraform` `plan`）：
- en: '![](Images/CH05_F09_UN06_Labouardy.png)'
  id: totrans-182
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F09_UN06_Labouardy.png)'
- en: Since the execution plan looks good, enter `yes`, and you’ll see your Jenkins
    master EC2 instance being deployed. Once the provisioning process is completed,
    the instance should be available on the EC2 dashboard, as shown in figure 5.10.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 由于执行计划看起来很好，输入 `yes`，您将看到您的 Jenkins 主机 EC2 实例正在部署。一旦配置过程完成，实例应该可以在 EC2 仪表板上看到，如图
    5.10 所示。
- en: '![](Images/CH05_F10_Labouardy.png)'
  id: totrans-184
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F10_Labouardy.png)'
- en: Figure 5.10 Jenkins master EC2 instance
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.10 Jenkins 主机 EC2 实例
- en: 'While this instance is private (it has no public IP address), we can set up
    an SSH tunnel by using the bastion host and executing the following commands (obviously,
    with different values):'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然这个实例是私有的（它没有公共 IP 地址），但我们可以通过使用堡垒主机并执行以下命令来设置 SSH 隧道（显然，使用不同的值）：
- en: '[PRE28]'
  id: totrans-187
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: You can check that Jenkins is running by issuing the `service jenkins status`
    command. Figure 5.11 shows the output.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过发出 `service jenkins status` 命令来检查 Jenkins 是否正在运行。图 5.11 显示了输出。
- en: '![](Images/CH05_F11_Labouardy.png)'
  id: totrans-189
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F11_Labouardy.png)'
- en: Figure 5.11 SSH tunnel connection
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.11 SSH 隧道连接
- en: 'To access the Jenkins dashboard, we will create a public load balancer in front
    of the EC2 instance. This Elastic load balancer will accept HTTP traffic on port
    80 and forward it to the EC2 instance on port 8080\. Also, it automatically checks
    the health of the registered EC2 instance on port 8080\. If the Elastic Load Balancing
    (ELB) finds the instance unhealthy, it stops sending traffic to the Jenkins instance.
    Within jenkins_ master.tf, declare the load balancer resource:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 要访问Jenkins仪表板，我们将在EC2实例前面创建一个公共负载均衡器。这个弹性负载均衡器将在端口80上接受HTTP流量，并将其转发到端口8080上的EC2实例。它还会自动检查注册的EC2实例在端口8080上的健康状态。如果弹性负载均衡（ELB）发现实例不健康，它将停止向Jenkins实例发送流量。在jenkins_master.tf中声明负载均衡器资源：
- en: '[PRE29]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'The load balancer will accept incoming HTTP traffic from anywhere (you should
    lock the incoming traffic to the specific IP address range from which you expect
    traffic) by assigning the following security group configuration. Later, we will
    add an HTTPS listener to use an SSL protocol to establish secure connections over
    the HTTP layer. Define the load balancer’s security group within jenkins_master.tf;
    here is the resource code block:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 负载均衡器将通过分配以下安全组配置接受来自任何地方的传入HTTP流量（您应该锁定来自您期望流量来源的特定IP地址范围的传入流量）。稍后，我们将添加一个HTTPS监听器，使用SSL协议在HTTP层上建立安全连接。在jenkins_master.tf中定义负载均衡器的安全组；以下是资源代码块：
- en: '[PRE30]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Next, update the Jenkins master security group to allow traffic on port 8080
    from the load balancer security group ID only:'
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，更新Jenkins主安全组，仅允许来自负载均衡器安全组ID的流量在端口8080上：
- en: '[PRE31]'
  id: totrans-196
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'Output the load balancer DNS URL by defining a new output section in the outputs.tf
    file:'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 通过在outputs.tf文件中定义一个新的输出部分来输出负载均衡器的DNS URL：
- en: '[PRE32]'
  id: totrans-198
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'After you apply the changes with Terraform, the Jenkins master load balancer
    URL should be displayed in your terminal session:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 在您使用Terraform应用更改后，Jenkins主负载均衡器URL应在您的终端会话中显示：
- en: '![](Images/CH05_F11_UN07_Labouardy.png)'
  id: totrans-200
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F11_UN07_Labouardy.png)'
- en: Point your favorite browser to the URL, and you should have access to the Jenkins
    web dashboard. You can see the Welcome to Jenkins! message on the home page (figure
    5.12).
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 将您喜欢的浏览器指向URL，您应该可以访问Jenkins网络仪表板。您可以在主页上看到“欢迎使用Jenkins！”的消息（图5.12）。
- en: '![](Images/CH05_F12_Labouardy.png)'
  id: totrans-202
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F12_Labouardy.png)'
- en: Figure 5.12 Jenkins web dashboard
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.12 Jenkins网络仪表板
- en: Awesome! You have a running Jenkins server behind an Elastic Load Balancer.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 太棒了！您已经有一个位于弹性负载均衡器后面的运行中的Jenkins服务器。
- en: If your goal is to architect for high availability, you need to maintain a redundant
    Jenkins master in separate availability zones. However, because the Jenkins master
    configuration is stored in the $JENKINS_HOME directory instead of a centralized
    database, you need to use an external plugin such as the High Availability Management
    plugin from CloudBees ([https://docs.cloudbees.com/plugins/ci/cloudbees-ha](https://docs.cloudbees.com/plugins/ci/cloudbees-ha))
    or set up the $JENKINS_HOME directory on a shared network drive, so it could be
    accessible by multiple Jenkins master instances.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的目标是设计高可用性架构，您需要在不同的可用区维护一个冗余的Jenkins主实例。然而，由于Jenkins主配置存储在$JENKINS_HOME目录中，而不是集中式数据库中，您需要使用外部插件，如CloudBees的High
    Availability Management插件([https://docs.cloudbees.com/plugins/ci/cloudbees-ha](https://docs.cloudbees.com/plugins/ci/cloudbees-ha))，或者在一个共享网络驱动器上设置$JENKINS_HOME目录，以便多个Jenkins主实例可以访问它。
- en: Note In chapter 14, we will go through how to use a solution like Amazon Elastic
    File System (EFS) to mount a volume to share the $JENKINS_HOME folder across multiple
    instances.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：在第14章中，我们将介绍如何使用类似Amazon Elastic File System (EFS)的解决方案将卷挂载到多个实例共享$JENKINS_HOME文件夹。
- en: 5.4 Running Jenkins with native SSL/HTTPS
  id: totrans-207
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 5.4 使用原生SSL/HTTPS运行Jenkins
- en: Having secure access to the Jenkins dashboard is a plus. That’s why we will
    use a free SSL provided by AWS to serve the content with HTTPS at your custom
    domain name and provide encrypted network connections; see figure 5.13.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 能够安全地访问Jenkins仪表板是一个加分项。这就是为什么我们将使用AWS提供的免费SSL，在自定义域名上以HTTPS方式提供内容，并提供加密的网络连接；见图5.13。
- en: Note If you're running Jenkins locally, you can generate a self-signed certificate
    and deploy a reverse proxy like NGINX. If you opt to go with a different cloud
    provider, you can generate a certificate issued by a certificate authority (CA)
    for free with Let’s Encrypt.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：如果您在本地运行Jenkins，您可以生成一个自签名证书并部署一个反向代理，如NGINX。如果您选择使用不同的云服务提供商，您可以使用Let’s
    Encrypt免费生成由证书颁发机构（CA）签发的证书。
- en: '![](Images/CH05_F13_Labouardy.png)'
  id: totrans-210
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F13_Labouardy.png)'
- en: Figure 5.13 Free SSL certificates from AWS Certificate Manager
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.13 来自 AWS 证书管理器的免费 SSL 证书
- en: You can easily get an SSL certificate with AWS Certificate Manager (ACM). This
    service makes it easy to provision, manage, and deploy SSL/TLS certificates on
    AWS-managed resources.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用 AWS 证书管理器 (ACM) 轻松获取 SSL 证书。此服务使您能够在 AWS 管理的资源上轻松配置、管理和部署 SSL/TLS 证书。
- en: Head to the ACM dashboard and click the Request a Certificate button to create
    a new SSL certificate. Select Request a Public Certificate and add your domain
    name. You might also want to secure your subdomains by adding an asterisk. Once
    AWS validates that you own those domain names, the status will change from Pending
    Validation to Issued. Copy the SSL Amazon Resource Name (ARN).
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 前往 ACM 控制台并点击“请求证书”按钮以创建新的 SSL 证书。选择“请求公共证书”并添加您的域名。您还可能想通过添加一个星号来保护您的子域名。一旦
    AWS 验证您拥有这些域名，状态将从“待验证”变为“已发行”。复制 SSL Amazon 资源名称 (ARN)。
- en: 'Update the load balancer resource to enable the HTTPS listener on port 443\.
    Set the ACM SSL ARN on the HTTPS listener. The load balancer uses the certificate
    to terminate the connection and then decrypt requests from clients before sending
    them to the Jenkins instance:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 更新负载均衡器资源以在端口 443 上启用 HTTPS 监听器。在 HTTPS 监听器上设置 ACM SSL ARN。负载均衡器使用证书终止连接，然后在将请求发送到
    Jenkins 实例之前解密来自客户端的请求：
- en: '[PRE33]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: ❶ Exposes an HTTPS listener and forwards incoming requests on port 443 to port
    8080 of the EC2 instance.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 暴露 HTTPS 监听器并将传入请求从端口 443 转发到 EC2 实例的端口 8080。
- en: 'Add an ingress rule to the load balancer security group to allow incoming HTTPS
    traffic:'
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 向负载均衡器安全组添加一个入站规则，以允许传入的 HTTPS 流量：
- en: '[PRE34]'
  id: totrans-218
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: ❶ Allows inbound traffic on port 443 from anywhere (0.0.0.0/0)
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 允许来自任何地方的端口 443 的入站流量
- en: 'Then create an A record in the Route 53 service ([https://aws.amazon.com/route53/](https://aws.amazon.com/route53/))
    pointing to the load balancer fully qualified domain name (FQDN). The Terraform
    code for the DNS record will look like this:'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 然后在 Route 53 服务中创建一个 A 记录，指向负载均衡器的完全限定域名 (FQDN)。DNS 记录的 Terraform 代码将类似于以下内容：
- en: '[PRE35]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: ❶ Sets up an alias record (jenkins.domain.com) that points to the Jenkins load
    balancer FQDN
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 设置一个别名记录（jenkins.domain.com），指向 Jenkins 负载均衡器 FQDN
- en: Note If you don’t have a hosted zone in Amazon Route 53, you can skip to the
    next section and stick with the load balancer FQDN.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：如果您在 Amazon Route 53 中没有托管区域，您可以跳到下一节，并继续使用负载均衡器 FQDN。
- en: This resource block will create an A record, which maps the jenkins.domain.com
    URL to an AWS alias to the load balancer FQDN.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 此资源块将创建一个 A 记录，将 jenkins.domain.com URL 映射到 AWS 负载均衡器 FQDN 的别名。
- en: Finally, define the referenced Terraform variables in the variables.tf file.
    Table 5.3 lists the variables to define in addition to the variables defined earlier
    in this chapter.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，在 variables.tf 文件中定义引用的 Terraform 变量。表 5.3 列出了除本章先前定义的变量外还需要定义的变量。
- en: Table 5.3 DNS Terraform variables
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 表 5.3 DNS Terraform 变量
- en: '| Variable | Type | Value | Description |'
  id: totrans-227
  prefs: []
  type: TYPE_TB
  zh: '| 变量 | 类型 | 值 | 描述 |'
- en: '| `hosted_zone_id` | String | None | The ID of the hosted zone to contain the
    A record |'
  id: totrans-228
  prefs: []
  type: TYPE_TB
  zh: '| `hosted_zone_id` | 字符串 | 无 | 包含 A 记录的托管区域 ID |'
- en: '| `domain_name` | String | None | The domain name to use, such as domain.com
    |'
  id: totrans-229
  prefs: []
  type: TYPE_TB
  zh: '| `domain_name` | 字符串 | 无 | 要使用的域名，例如 domain.com |'
- en: '| `ssl_arn` | String | None | ARN of SSL certificate you have created in AWS
    ACM |'
  id: totrans-230
  prefs: []
  type: TYPE_TB
  zh: '| `ssl_arn` | 字符串 | 无 | 您在 AWS ACM 中创建的 SSL 证书的 ARN |'
- en: 'Define an `output` section to display the Jenkins public DNS URL by referencing
    the Route 53 A record resource:'
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 定义一个 `output` 部分，通过引用 Route 53 A 记录资源来显示 Jenkins 公共 DNS URL：
- en: '[PRE36]'
  id: totrans-232
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: ❶ Concatenates the alias record name with the https:// keyword to construct
    the Jenkins HTTPS URL
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将别名记录名称与 https:// 关键字连接起来，构建 Jenkins HTTPS URL
- en: 'Issue the `terraform apply` command for changes to take effect. It should deploy
    the needed resources and display the Jenkins dashboard URL:'
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 执行 `terraform apply` 命令以使更改生效。它应部署所需的资源并显示 Jenkins 仪表板 URL：
- en: '![](Images/CH05_F13_UN08_Labouardy.png)'
  id: totrans-235
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F13_UN08_Labouardy.png)'
- en: The Jenkins load balancer now should be listening on both the HTTP (80) and
    HTTPS (433) ports, as shown in figure 5.14.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: Jenkins 负载均衡器现在应该正在监听 HTTP（80）和 HTTPS（433）端口，如图 5.14 所示。
- en: '![](Images/CH05_F14_Labouardy.png)'
  id: totrans-237
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F14_Labouardy.png)'
- en: Figure 5.14 Allowing HTTPS and HTTP on ELB
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.14 在 ELB 上允许 HTTPS 和 HTTP
- en: Point your browser to the subdomain name created with Terraform. The Jenkins
    web dashboard should be served through HTTPS, as shown in figure 5.15.
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 将您的浏览器指向由 Terraform 创建的子域名。Jenkins 网络仪表板应通过 HTTPS 提供服务，如图 5.15 所示。
- en: '![](Images/CH05_F15_Labouardy.png)'
  id: totrans-240
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F15_Labouardy.png)'
- en: Figure 5.15 The Jenkins dashboard is now served through HTTPS. If you’re using
    Chrome, you should see a green lock in the URL bar.
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.15 Jenkins 仪表板现在通过 HTTPS 提供服务。如果你使用的是 Chrome，你应该在 URL 栏中看到一个绿色的锁。
- en: So far, we have deployed a private standalone Jenkins master instance behind
    a public load balancer, as shown in figure 5.16.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们已经在公共负载均衡器后面部署了一个私有独立的 Jenkins 主实例，如图 5.16 所示。
- en: '![](Images/CH05_F16_Labouardy.png)'
  id: totrans-243
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F16_Labouardy.png)'
- en: Figure 5.16 Jenkins standalone setup on AWS
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.16 AWS 上的 Jenkins 独立设置
- en: In the next section, we will deploy additional Jenkins workers to offload the
    load from the Jenkins master.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，我们将部署额外的 Jenkins 工作节点以减轻 Jenkins 主节点的负载。
- en: 'Note Maintaining a regular backup of your Jenkins EBS volume is crucial to
    ensuring that the Jenkins instance can be restored in the event of data corruption
    or loss. Refer to the official documentation for instructions: [http://mng.bz/807P](http://mng.bz/807P).'
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：定期备份你的 Jenkins EBS 卷对于确保在数据损坏或丢失的情况下可以恢复 Jenkins 实例至关重要。请参阅官方文档以获取说明：[http://mng.bz/807P](http://mng.bz/807P)。
- en: 5.5 Dynamically autoscaling the Jenkins worker pool
  id: totrans-247
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 5.5 动态自动扩展 Jenkins 工作节点池
- en: Running a single Jenkins instance is a good start, but in the real world, a
    single instance is a single point of failure. If that instance crashes or becomes
    overwhelmed by too many builds, developers can no longer deliver their releases.
    The solution is to run a cluster of Jenkins workers and adjust the size of the
    cluster up or down based on resource utilization.
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 运行单个 Jenkins 实例是一个好的开始，但在现实世界中，单个实例是一个单点故障。如果该实例崩溃或因构建过多而超负荷，开发者将无法交付他们的发布。解决方案是运行一个
    Jenkins 工作节点集群，并根据资源利用率调整集群的大小。
- en: 5.5.1 Launch configuration
  id: totrans-249
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.5.1 启动配置
- en: You can certainly deploy Jenkins workers as separate EC2 instances (rerunning
    the previous steps). However, we want the instances to be deployed and replaced
    automatically for autorecovery. That’s why we will rely on a standard AWS feature
    called *Auto Scaling groups*.
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 你当然可以部署 Jenkins 工作节点作为单独的 EC2 实例（重新运行前面的步骤）。然而，我们希望实例能够自动部署和替换以实现自动恢复。这就是为什么我们将依赖于一个标准的
    AWS 功能，称为 *自动扩展组*。
- en: Note For more details on how the AWS EC2 autoscaling feature works, refer to
    chapter 3 about architecting Jenkins for scale.
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：有关 AWS EC2 自动扩展功能如何工作的更多详细信息，请参阅第 3 章关于扩展 Jenkins 的架构。
- en: 'The first step in creating an ASG is to create a launch configuration, which
    describes how to configure each Jenkins worker instance. Declare an `aws_launch_configuration`
    resource in the jenkins_workers.tf file:'
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 创建自动扩展组的第一步是创建一个启动配置，它描述了如何配置每个 Jenkins 工作节点实例。在 jenkins_workers.tf 文件中声明一个
    `aws_launch_configuration` 资源：
- en: '[PRE37]'
  id: totrans-253
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: ❶ Configures a blueprint with the baked Jenkins worker AMI and key name that
    should be used for the instances, and assigns a security group
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 配置蓝图，使用预制的 Jenkins 工作节点 AMI 和应用于实例的密钥名称，并分配一个安全组
- en: ❷ The user data to provide when launching the instance. It will autojoin the
    running instance to the Jenkins cluster.
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 启动实例时提供的用户数据。它将自动将运行实例加入 Jenkins 集群。
- en: ❸ Customizes details about the root block device of the instance
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 自定义实例根块设备的详细信息
- en: Note You should benchmark performance for your projects to determine the appropriate
    instance type you need, as well as the amount of disk space.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：你应该对你的项目进行性能基准测试，以确定所需的适当实例类型以及磁盘空间的大小。
- en: Similarly to the Jenkins master, the workers will be deployed across private
    subnets and will use the Jenkins worker AMI built with Packer in chapter 4.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 与 Jenkins 主节点类似，工作节点将在私有子网中部署，并使用第 4 章中用 Packer 构建的 Jenkins 工作节点 AMI。
- en: '[PRE38]'
  id: totrans-259
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: ❶ The data source resource is used to get the ID of the baked Jenkins worker
    AMI.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 使用数据源资源获取预制的 Jenkins 工作节点 AMI 的 ID。
- en: 'To be able to set up the Jenkins cluster, the master needs to set up a bidirectional
    connection with the workers. Hence, we need to allow SSH from the Jenkins master
    security group ID (allowing SSH from the bastion host can be helpful for future
    debugging and troubleshooting):'
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 要设置 Jenkins 集群，主节点需要与工作节点建立双向连接。因此，我们需要允许来自 Jenkins 主安全组 ID 的 SSH 访问（允许堡垒主机进行
    SSH 访问有助于未来的调试和故障排除）：
- en: '[PRE39]'
  id: totrans-262
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: ❶ Allows inbound traffic on port 22 (SSH) from the Jenkins master and bastion
    host security groups
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 允许来自 Jenkins 主和工作堡垒主机的安全组对端口 22（SSH）的入站流量
- en: ❷ Allows outbound traffic from anywhere for all protocols (–1)
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 允许所有协议从任何地方出站流量（–1）
- en: Finally, we define `user-data`, a script that will be executed at boot time
    on each Jenkins worker instance. The script takes as a parameter the Jenkins admin
    credentials, Jenkins SSH credential ID, as well as the Jenkins IP address.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们定义了 `user-data`，这是一个在 Jenkins 工作者实例启动时执行的脚本。该脚本将 Jenkins 管理员凭据、Jenkins
    SSH 凭据 ID 以及 Jenkins IP 地址作为参数。
- en: 'The SSH credential ID refers to the credential we created with the Groovy script
    at initialization time in chapter 4; the credential contains the private SSH key
    located in the .ssh folder in the working directory. The private SSH key will
    be used by the Jenkins master to add the Jenkins workers via SSH:'
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: SSH 凭据 ID 指的是我们在第 4 章初始化时使用 Groovy 脚本创建的凭据；该凭据包含位于工作目录 .ssh 文件夹中的私有 SSH 密钥。私有
    SSH 密钥将由 Jenkins 主服务器用于通过 SSH 添加 Jenkins 工作者：
- en: '[PRE40]'
  id: totrans-267
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: The scripts/join-cluster.tpl script will fetch the running instance’s private
    IP address from the EC2 metadata (available at 169.254.169.254/latest/meta-data).
    The script will then issue an HTTP request to Jenkins with the Groovy script in
    the following listing to add the instance to the cluster.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: scripts/join-cluster.tpl 脚本将从 EC2 元数据（可在 169.254.169.254/latest/meta-data 获取）获取运行实例的私有
    IP 地址。然后，脚本将使用以下列表中的 Groovy 脚本向 Jenkins 发送 HTTP 请求，将实例添加到集群中。
- en: Listing 5.7 Autojoining Jenkins workers
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.7 自动加入 Jenkins 工作者
- en: '[PRE41]'
  id: totrans-270
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: ❶ Replaces the variables with the given values in the user_data_jenkins_worker
    Terraform resource
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 在 user_data_jenkins_worker Terraform 资源中将变量替换为给定的值
- en: ❷ Fetches a valid token from the Jenkins master server
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 从 Jenkins 主服务器获取有效令牌
- en: ❸ Fetches the instance private IP address and hostname from the EC2 metadata
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 从 EC2 元数据获取实例私有 IP 地址和主机名
- en: ❹ Issues a GET request on the Jenkins server with a Groovy script in the request
    payload. The script will add the current instance as a Jenkins agent.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 在请求负载中使用 Groovy 脚本向 Jenkins 服务器发送 GET 请求。该脚本将当前实例添加为 Jenkins 代理。
- en: This configuration allows three executors to be run in parallel in each worker.
    If you plan to use only the master as a job scheduler, you can configure its number
    of executors setting to 0 to ensure that project builds will happen on only the
    worker machines. The resource block also defines a workspace directory on the
    worker instance that the worker agent can use to run build jobs. This configuration
    uses /home/ec2-user as a workspace. Nothing mission-critical is stored in this
    directory; everything important is transferred back to the master instance after
    the build is done, so you usually don’t need to be concerned with backing up this
    directory.
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 此配置允许每个工作者上并行运行三个执行器。如果您计划仅使用主服务器作为作业调度器，可以将其执行器数量设置为零，以确保项目构建仅在工作者机器上发生。资源块还定义了工作实例上的工作空间目录，工作代理可以使用该目录运行构建作业。此配置使用
    /home/ec2-user 作为工作空间。此目录中不存储任何关键任务；所有重要内容在构建完成后都会传输回主实例，因此您通常不需要担心备份此目录。
- en: We have also defined a label called `workers`, so each worker instance will
    join the Jenkins cluster under that label. Hence, you can configure your build
    jobs to run on only workers’ machines.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还定义了一个名为 `workers` 的标签，因此每个工作实例都将加入该标签下的 Jenkins 集群。因此，您可以配置您的构建作业仅在工作者机器上运行。
- en: Next, define the Jenkins master credentials and worker instance type as variables
    in the variable.tf file. Table 5.4 lists the variables.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，在 variable.tf 文件中将 Jenkins 主服务器凭据和工作者实例类型定义为变量。表 5.4 列出了变量。
- en: Table 5.4 Jenkins workers’ Terraform variables
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: 表 5.4 Jenkins 工作者的 Terraform 变量
- en: '| Variable | Type | Value | Description |'
  id: totrans-279
  prefs: []
  type: TYPE_TB
  zh: '| 变量 | 类型 | 值 | 描述 |'
- en: '| `jenkins_username` | String | None | Jenkins admin username |'
  id: totrans-280
  prefs: []
  type: TYPE_TB
  zh: '| `jenkins_username` | 字符串 | 无 | Jenkins 管理员用户名 |'
- en: '| `jenkins_password` | String | None | Jenkins admin password |'
  id: totrans-281
  prefs: []
  type: TYPE_TB
  zh: '| `jenkins_password` | 字符串 | 无 | Jenkins 管理员密码 |'
- en: '| `jenkins_credentials_id` | String | None | Jenkins worker SSH-based credential
    ID |'
  id: totrans-282
  prefs: []
  type: TYPE_TB
  zh: '| `jenkins_credentials_id` | 字符串 | 无 | Jenkins 工作者基于 SSH 的凭据 ID |'
- en: '| `jenkins_worker_instance_type` | String | `t2.medium` | Jenkins worker EC2
    instance type |'
  id: totrans-283
  prefs: []
  type: TYPE_TB
  zh: '| `jenkins_worker_instance_type` | 字符串 | `t2.medium` | Jenkins 工作者 EC2 实例类型
    |'
- en: Note You can significantly reduce your Jenkins workers’ costs (up to 90% cost
    savings) by using Amazon EC2 Spot instances ([http://aws.amazon.com/ec2/spot](http://aws.amazon.com/ec2/spot)),
    or by subscribing to Amazon Savings Plans ([https://aws.amazon.com/savingsplans/](https://aws.amazon.com/savingsplans/)).
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：您可以通过使用 Amazon EC2 Spot 实例（[http://aws.amazon.com/ec2/spot](http://aws.amazon.com/ec2/spot)）或订阅
    Amazon Savings Plans（[https://aws.amazon.com/savingsplans/](https://aws.amazon.com/savingsplans/））来显著降低
    Jenkins 工作者的成本（高达 90% 的成本节省）。
- en: Finally, issue `terraform apply` to deploy the Jenkins workers.
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，执行 `terraform apply` 命令以部署 Jenkins 工作节点。
- en: 5.5.2 Auto Scaling group
  id: totrans-286
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.5.2 自动扩展组
- en: Now that the Jenkins workers’ blueprint is defined in a launch configuration,
    we can deploy an Auto Scaling group to deploy similar Jenkins workers based on
    the launch configuration.
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 现在由于 Jenkins 工作节点的蓝图已定义在启动配置中，我们可以部署一个自动扩展组来基于启动配置部署类似的 Jenkins 工作节点。
- en: 'Create the ASG by using the `aws_autoscaling_group` resource within the jenkins_workers.tf
    file:'
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 jenkins_workers.tf 文件中的 `aws_autoscaling_group` 资源创建 ASG：
- en: '[PRE42]'
  id: totrans-289
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: ❶ Deploys an ASG of two EC2 instances (minimum) in different subnets for resiliency
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 在不同的子网中部署两个 EC2 实例的 ASG（最小），以提高容错能力
- en: This ASG will run 2 to 10 workers (defaulting to 2 for the initial launch),
    each tagged with the name `jenkins_worker`. The ASG uses a reference to fill in
    the launch configuration name.
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: 此 ASG 将运行 2 到 10 个工作节点（默认为 2 个初始启动），每个都带有名称 `jenkins_worker` 的标签。ASG 使用引用来填充启动配置名称。
- en: Note The keyword `depends_on` is used to ensure that the Jenkins master instance
    is running before deploying workers, as the workers need the Jenkins master IP
    to join the cluster successfully.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：使用关键字 `depends_on` 确保在部署工作节点之前 Jenkins 主实例正在运行，因为工作节点需要 Jenkins 主 IP 以成功加入集群。
- en: The launch configuration is immutable, so you can’t modify it after it was created
    (for example, to upgrade the Jenkins worker instance type or change the base AMI).
    Therefore, you will need to destroy the launch configuration and create a new
    one instead; that’s why the `create_before_destroy` life cycle setting is used.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 启动配置是不可变的，因此创建后无法修改它（例如，升级 Jenkins 工作节点实例类型或更改基础 AMI）。因此，您需要销毁启动配置并创建一个新的；这就是为什么使用
    `create_before_destroy` 生命周期设置的原因。
- en: 'To create the autoscaling group, run `terraform apply` on your terminal session:'
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 要创建自动扩展组，请在您的终端会话中运行 `terraform apply` 命令：
- en: '![](Images/CH05_F16_UN09_Labouardy.png)'
  id: totrans-295
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F16_UN09_Labouardy.png)'
- en: The provisioning process should take a few seconds. When you refresh your EC2
    console, you’ll see the output in figure 5.17 in the dashboard.
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 配置过程应只需几秒钟。当您刷新 EC2 控制台时，您将在仪表板中看到图 5.17 的输出。
- en: '![](Images/CH05_F17_Labouardy.png)'
  id: totrans-297
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F17_Labouardy.png)'
- en: Figure 5.17 Jenkins workers deploying inside an ASG
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.17 Jenkins 工作节点在 ASG 内部部署
- en: 'Note Chapter 14 covers another approach: we’ll deploy the worker nodes in Docker
    containers to use EC2 instances efficiently (with multiple builds to run independently
    on the same server) as well as to run in a “clean” build environment every time.'
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：第 14 章介绍了另一种方法：我们将使用 Docker 容器部署工作节点，以有效地使用 EC2 实例（在相同的服务器上独立运行多个构建）以及每次都在“干净”的构建环境中运行。
- en: Great! We have two Jenkins workers running inside an ASG.
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 太好了！我们现在在 ASG 内部运行着两个 Jenkins 工作节点。
- en: 5.5.3 Autoscaling scaling policies
  id: totrans-301
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.5.3 自动扩展缩放策略
- en: So far, the number of workers is static and fixed. To scale the number of workers
    dynamically, we will define scaling policies based on CPU utilization. This gives
    you extra capacity to handle the build of additional jobs without maintaining
    an excessive number of idle Jenkins workers and paying extra money.
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，工作节点的数量是静态和固定的。为了动态地调整工作节点的数量，我们将基于 CPU 利用率定义缩放策略。这为您提供了额外的容量来处理额外作业的构建，而无需维护过多的空闲
    Jenkins 工作节点并支付额外费用。
- en: Create a cloudwatch.tf file and define an AWS CloudWatch metric alarm based
    on CPU utilization. The CloudWatch alarm will trigger a scale-out event to add
    a new Jenkins worker instance if the average CPU utilization is over 80% for a
    period of 2 minutes, as shown in the following listing.
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个 cloudwatch.tf 文件，并基于 CPU 利用率定义一个 AWS CloudWatch 指标警报。如果平均 CPU 利用率在 2 分钟内超过
    80%，CloudWatch 警报将触发扩容事件以添加新的 Jenkins 工作节点实例，如下所示。
- en: Listing 5.8 CloudWatch scale-out alarm
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.8 CloudWatch 扩容警报
- en: '[PRE43]'
  id: totrans-305
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: Note It’s up to you what to monitor, but the metrics most useful for knowing
    when you should scale up and add another Jenkins worker or scale down by terminating
    a worker are probably CPU utilization, memory utilization, and network utilization.
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：您可以选择要监控的内容，但最有用的指标可能是 CPU 利用率、内存利用率和网络利用率，以了解何时应该扩展并添加另一个 Jenkins 工作节点或通过终止工作节点进行缩容。
- en: Similarly, we define another CloudWatch alarm to trigger a scale-in event to
    remove a Jenkins worker if the average CPU utilization is less than 20% for a
    period of 2 minutes; see the following listing.
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: 类似地，我们定义另一个 CloudWatch 警报来触发缩容事件，以移除 Jenkins 工作节点，如果平均 CPU 利用率在 2 分钟内低于 20%，请参阅以下列表。
- en: Listing 5.9 CloudWatch scale-in alarm
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.9 CloudWatch 缩容警报
- en: '[PRE44]'
  id: totrans-309
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: The cooldown period is set to 300 seconds to ensure that the ASG doesn’t launch
    or terminate additional Jenkins workers before the previous scaling activity takes
    effect.
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
  zh: 冷却时间设置为 300 秒，以确保 ASG 在之前的扩展活动生效之前不会启动或终止额外的 Jenkins 工作节点。
- en: Note When a scale-in event occurs, the ASG will terminate a Jenkins worker based
    on the termination policy. Refer to chapter 3 for more information.
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：当发生缩容事件时，ASG 将根据终止策略终止一个 Jenkins 工作节点。更多详细信息请参阅第 3 章。
- en: 'If you run the `terraform apply` command, you’ll see that Terraform wants to
    create two CloudWatch alarms (the output has been cropped for brevity):'
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你运行 `terraform apply` 命令，你会看到 Terraform 想要创建两个 CloudWatch 警报（输出已被裁剪以节省空间）：
- en: '![](Images/CH05_F17_UN10_Labouardy.png)'
  id: totrans-313
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F17_UN10_Labouardy.png)'
- en: You can access Amazon EC2 Auto Scaling (figure 5.18) by signing into the AWS
    Management Console, choosing EC2 from the console home page, and then choosing
    Auto Scaling Groups from the navigation pane.
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过登录 AWS 管理控制台，从控制台主页选择 EC2，然后在导航面板中选择自动扩展组来访问 Amazon EC2 自动扩展（图 5.18）。
- en: '![](Images/CH05_F18_Labouardy.png)'
  id: totrans-315
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F18_Labouardy.png)'
- en: Figure 5.18 Auto Scaling group scaling policies
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.18 自动扩展组扩展策略
- en: Next, we will run the Stress tool to test the scaling policies of the workers’
    ASG.
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将运行 Stress 工具来测试工作节点 ASG 的扩展策略。
- en: 5.5.4 Workers CPU utilization load
  id: totrans-318
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.5.4 工作节点 CPU 利用率负载
- en: 'SSH to one of the Jenkins workers by setting up an SSH tunnel from a bastion
    host. Install the Stress tool with the Yum package manager:'
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 通过从堡垒主机设置 SSH 隧道来 SSH 连接到 Jenkins 工作节点。使用 Yum 软件包管理器安装 Stress 工具：
- en: '[PRE45]'
  id: totrans-320
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: 'To run the Stress tool, enter the following command. It will generate a thread
    to max out two CPU cores (which is all we need, as we’re using `t2.large` instances):'
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
  zh: 要运行 Stress 工具，请输入以下命令。它将生成一个线程以使两个 CPU 核心达到最大（因为我们使用的是 `t2.large` 实例，所以这已经足够了）：
- en: '[PRE46]'
  id: totrans-322
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: This gives you a chance to see what will happen to the autoscaling policies
    when real jobs are being built on Jenkins and CloudWatch alarms start triggering.
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: 这让你有机会看到当在 Jenkins 上构建实际工作负载并且 CloudWatch 警报开始触发时，自动扩展策略会发生什么。
- en: You can use the `top` command to monitor the CPU utilization of the process
    created by the Stress tool or use CloudWatch metrics on the EC2 instance. The
    CPU utilization will hit 100% for an amount of time, as shown in figure 5.19.
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用 `top` 命令来监控 Stress 工具创建的进程的 CPU 利用率，或者使用 EC2 实例上的 CloudWatch 指标。CPU 利用率将保持在
    100% 一段时间，如图 5.19 所示。
- en: Note CloudWatch basic monitoring refreshes every 5 minutes, and our autoscaling
    policies require a metric to be met for 2 consecutive minutes, so we had to run
    stress tests for at least 5 minutes to ensure that our policies had enough time
    to be triggered.
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：CloudWatch 基本监控每 5 分钟刷新一次，而我们的自动扩展策略需要一个指标连续满足 2 分钟，因此我们必须运行至少 5 分钟的负载测试，以确保我们的策略有足够的时间被触发。
- en: '![](Images/CH05_F19_Labouardy.png)'
  id: totrans-326
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F19_Labouardy.png)'
- en: Figure 5.19 Jenkins worker CPU utilization usage
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.19 Jenkins 工作节点 CPU 利用率使用情况
- en: CloudWatch aggregates metric data points based on the statistic of CPU utilization
    associated with the CloudWatch alarm. When the alarm is breached, the scale-out
    policy is triggered, as shown in figure 5.20.
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: CloudWatch 根据与 CloudWatch 警报相关的 CPU 利用率统计信息聚合指标数据点。当警报被触发时，扩展策略被触发，如图 5.20 所示。
- en: '![](Images/CH05_F20_Labouardy.png)'
  id: totrans-329
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F20_Labouardy.png)'
- en: Figure 5.20 CloudWatch scale-out alarm triggered
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.20 CloudWatch 扩展警报触发
- en: When the metric value gets to 80%, the desired capacity of the group increases
    by one instance to two instances; see figure 5.21.
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
  zh: 当指标值达到 80% 时，组的期望容量增加一个实例，达到两个实例；请参阅图 5.21。
- en: '![](Images/CH05_F21_Labouardy.png)'
  id: totrans-332
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F21_Labouardy.png)'
- en: Figure 5.21 Scale-out policy invoked
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.21 触发扩展策略
- en: After the new instance is running, the user-data script will be executed, and
    the worker will join the cluster, as you can see in figure 5.22.
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
  zh: 新实例运行后，用户数据脚本将被执行，工作节点将加入集群，如图 5.22 所示。
- en: '![](Images/CH05_F22_Labouardy.png)'
  id: totrans-335
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F22_Labouardy.png)'
- en: Figure 5.22 The new worker has joined the cluster automatically.
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.22 新的工作节点已自动加入集群。
- en: If the metric value gets to 20%, the desired capacity of the group decreases
    by one instance; see figure 5.23.
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
  zh: 如果指标值达到 20%，组的期望容量将减少一个实例；请参阅图 5.23。
- en: '![](Images/CH05_F23_Labouardy.png)'
  id: totrans-338
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F23_Labouardy.png)'
- en: Figure 5.23 Terminating an unused worker because of a scale-in event
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.23 由于缩容事件终止未使用的节点
- en: As a result, the terminated worker won’t be reachable and will be marked offline
    on the Jenkins web dashboard (figure 5.24).
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，终止的工作节点将无法访问，并在 Jenkins 网络仪表板上标记为离线（图 5.24）。
- en: '![](Images/CH05_F24_Labouardy.png)'
  id: totrans-341
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F24_Labouardy.png)'
- en: Figure 5.24 The terminated Jenkins worker is unreachable.
  id: totrans-342
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.24 终止的 Jenkins 工作节点无法访问。
- en: Note When you’re done experimenting with Terraform, it’s a good idea to remove
    all the resources you created so AWS doesn’t charge you for them. Run the `terraform
    destroy` command to delete the existing AWS infrastructure.
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：当你完成 Terraform 的实验后，一个好的做法是删除你创建的所有资源，这样 AWS 就不会为此向你收费。运行 `terraform destroy`
    命令以删除现有的 AWS 基础设施。
- en: In this chapter, you learned how to deploy a highly available, secure, and resilient
    Jenkins cluster on AWS by using the IaC tool Terraform and how to use the baked
    Packer images to deploy workers to scale. Figure 5.25 summarizes the deployed
    architecture.
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你学习了如何使用基础设施即代码工具 Terraform 在 AWS 上部署一个高可用性、安全且弹性的 Jenkins 集群，以及如何使用预制的
    Packer 镜像部署工作节点以进行扩展。图 5.25 总结了部署的架构。
- en: '![](Images/CH05_F25_Labouardy.png)'
  id: totrans-345
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F25_Labouardy.png)'
- en: Figure 5.25 Jenkins distributed builds on AW.
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.25 Jenkins 分布式构建在 AW 上。
- en: Terraform is a vendor-agnostic tool that can manage infrastructure for multiple
    resource providers. Therefore, in the upcoming chapter, you’ll learn to deploy
    the preceding architecture on other cloud providers such as Microsoft Azure and
    Google Cloud Platform by using the same configuration files.
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
  zh: Terraform 是一个与供应商无关的工具，可以管理多个资源提供者的基础设施。因此，在接下来的章节中，你将学习如何使用相同的配置文件在其他云提供商上部署前面的架构，例如
    Microsoft Azure 和 Google Cloud Platform。
- en: Summary
  id: totrans-348
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: Infrastructure as code is an approach to defining infrastructure and network
    components through descriptive or high-level code.
  id: totrans-349
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 基础设施即代码是一种通过描述性或高级代码定义基础设施和网络组件的方法。
- en: Terraform is an IaC tool that works with any cloud, be it private, on premises,
    or a public provider. Terraform allows safe and convenient management of infrastructure
    resources.
  id: totrans-350
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Terraform 是一个与任何云环境兼容的基础设施即代码工具，无论是私有云、本地部署还是公共提供商。Terraform 允许安全且方便地管理基础设施资源。
- en: The Jenkins master should be hosted on an instance that has enough CPU and network
    bandwidth to handle concurrent users.
  id: totrans-351
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Jenkins 主节点应托管在具有足够 CPU 和网络带宽的实例上，以便处理并发用户。
- en: Jenkins workers should be immutable, able to be thrown away quickly and brought
    up or added into the cluster with as little manual interaction as possible. This
    can be achieved by leveraging AWS Auto Scaling groups.
  id: totrans-352
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Jenkins 工作节点应该是不可变的，能够快速丢弃，并以尽可能少的手动交互将其提升或添加到集群中。这可以通过利用 AWS 自动扩展组来实现。
- en: Architect Jenkins for high availability and fault tolerance by spreading Jenkins
    workers across multiple availability zones.
  id: totrans-353
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过在多个可用区之间分散 Jenkins 工作节点，为高可用性和容错性设计 Jenkins。
