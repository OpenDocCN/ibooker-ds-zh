- en: Appendix D. Cluster Federation
  id: totrans-0
  prefs: []
  type: TYPE_NORMAL
  zh: 附录 D. 集群联邦
- en: In the section about high availability in [chapter 11](index_split_087.html#filepos1036287)
    we explored how Kubernetes can deal with failures of individual machines and even
    failures of whole server racks or the supporting infrastructure. But what if the
    whole datacenter goes dark?
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在第 11 章[关于高可用性的部分](index_split_087.html#filepos1036287)中，我们探讨了 Kubernetes 如何处理单个机器甚至整个服务器机架或支持基础设施的故障。但整个数据中心如果出现故障怎么办呢？
- en: To make sure you’re not susceptible to datacenter-wide outages, apps should
    be deployed in multiple datacenters or cloud availability zones. When one of those
    datacenters or availability zones becomes unavailable, client requests can be
    routed to the apps running in the remaining healthy datacenters or zones.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确保您不会受到数据中心级故障的影响，应用应该部署在多个数据中心或云可用区。当其中一个数据中心或可用区不可用时，客户端请求可以被路由到剩余健康的数据中心或区域中运行的应用。
- en: While Kubernetes doesn’t require you to run the Control Plane and the nodes
    in the same datacenter, you’ll almost always want to do that to keep network latency
    between them low and to reduce the possibility of them becoming disconnected from
    each other. Instead of having a single cluster spread across multiple locations,
    a better alternative is to have an individual Kubernetes cluster in every location.
    We’ll explore this approach in this appendix.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然 Kubernetes 不要求您在同一个数据中心运行控制平面和节点，但您几乎总是想这样做，以保持它们之间的网络延迟低，并减少它们彼此断开连接的可能性。而不是有一个跨多个位置的单一集群，更好的选择是在每个位置都有一个独立的
    Kubernetes 集群。我们将在此附录中探讨这种方法。
- en: D.1\. Introducing Kubernetes Cluster Federation
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: D.1\. 介绍 Kubernetes 集群联邦
- en: Kubernetes allows you to combine multiple clusters into a cluster of clusters
    through Cluster Federation. It allows users to deploy and manage apps across multiple
    clusters running in different locations in the world, but also across different
    cloud providers combined with on-premises clusters (hybrid cloud). The motivation
    for Cluster Federation isn’t only to ensure high availability, but also to combine
    multiple heterogeneous clusters into a single super-cluster managed through a
    single management interface.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes 允许您通过集群联邦将多个集群组合成一个集群的集群。它允许用户在世界不同位置的多个集群中部署和管理应用，也可以跨不同云提供商与本地集群（混合云）结合。集群联邦的动机不仅是为了确保高可用性，而且是为了将多个异构集群合并成一个由单个管理界面管理的超级集群。
- en: For example, by combining an on-premises cluster with one running on a cloud
    provider’s infrastructure, you can run privacy-sensitive components of your application
    system on-premises, while the non-sensitive parts can run in the cloud. Another
    example is initially running your application only in a small on-premises cluster,
    but when the application’s compute requirements exceed the cluster’s capacity,
    letting the application spill over to a cloud-based cluster, which is automatically
    provisioned on the cloud provider’s infrastructure.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，通过将本地集群与运行在云提供商基础设施上的集群相结合，您可以在本地运行应用程序系统的隐私敏感组件，而无需敏感部分运行在云中。另一个例子是最初仅在小型本地集群中运行您的应用程序，但当应用程序的计算需求超过集群的容量时，允许应用程序溢出到基于云的集群，该集群在云提供商的基础设施上自动配置。
- en: D.2\. Understanding the architecture
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: D.2\. 理解架构
- en: Let’s take a quick look at what Kubernetes Cluster Federation is. A cluster
    of clusters can be compared to a regular cluster where instead of nodes, you have
    complete clusters. Just as a Kubernetes cluster consists of a Control Plane and
    multiple worker nodes, a federated cluster consists of a Federated Control Plane
    and multiple Kubernetes clusters. Similar to how the Kubernetes Control Plane
    manages applications across a set of worker nodes, the Federated Control Plane
    does the same thing, but across a set of clusters instead of nodes.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们快速了解一下 Kubernetes 集群联邦是什么。集群的集群可以与一个常规集群相比较，其中不是节点，而是完整的集群。正如 Kubernetes
    集群由控制平面和多个工作节点组成一样，联邦集群由联邦控制平面和多个 Kubernetes 集群组成。类似于 Kubernetes 控制平面如何管理一组工作节点上的应用，联邦控制平面做的是同样的事情，但跨一组集群而不是节点。
- en: 'The Federated Control Plane consists of three things:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 联邦控制平面由三部分组成：
- en: etcd for storing the federated API objects
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: etcd 用于存储联邦 API 对象
- en: Federation API server
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 联邦 API 服务器
- en: Federation Controller Manager
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 联邦控制器管理器
- en: This isn’t much different from the regular Kubernetes Control Plane. etcd stores
    the federated API objects, the API server is the REST endpoint all other components
    talk to, and the Federation Controller Manager runs the various federation controllers
    that perform operations based on the API objects you create through the API server.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 这与常规Kubernetes控制平面没有太大区别。etcd存储联邦API对象，API服务器是所有其他组件通信的REST端点，联邦控制器管理器运行各种基于您通过API服务器创建的API对象的操作执行的联邦控制器。
- en: Users talk to the Federation API server to create federated API objects (or
    federated resources). The federation controllers watch these objects and then
    talk to the underlying clusters’ API servers to create regular Kubernetes resources.
    The architecture of a federated cluster is shown in [figure D.1](#filepos1784652).
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 用户通过联邦API服务器创建联邦API对象（或联邦资源）。联邦控制器监视这些对象，然后与底层集群的API服务器通信以创建常规Kubernetes资源。联邦集群的架构如图D.1所示。
- en: Figure D.1\. Cluster Federation with clusters in different geographical locations
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 图D.1\. 不同地理位置的集群联邦
- en: '![](images/00018.jpg)'
  id: totrans-16
  prefs: []
  type: TYPE_IMG
  zh: '![图片](images/00018.jpg)'
- en: D.3\. Understanding federated API objects
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: D.3\. 理解联邦API对象
- en: The federated API server allows you to create federated variants of the objects
    you learned about throughout the book.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 联邦API服务器允许您创建本书中提到的对象的联邦版本。
- en: D.3.1\. Introducing federated versions of Kubernetes resources
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: D.3.1\. 介绍Kubernetes资源的联邦版本
- en: 'At the time of writing this, the following federated resources are supported:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 在撰写本文时，以下联邦资源得到支持：
- en: Namespaces
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 命名空间
- en: ConfigMaps and Secrets
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ConfigMaps和Secrets
- en: Services and Ingresses
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 服务和入口
- en: Deployments, ReplicaSets, Jobs, and Daemonsets
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 部署、副本集、作业和守护进程集
- en: HorizontalPodAutoscalers
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: HorizontalPodAutoscalers
- en: '|  |'
  id: totrans-26
  prefs: []
  type: TYPE_TB
  zh: '|  |'
- en: Note
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Check the Kubernetes Cluster Federation documentation for an up-to-date list
    of supported federated resources.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 请查阅Kubernetes集群联邦文档，以获取支持的联邦资源的最新列表。
- en: '|  |'
  id: totrans-29
  prefs: []
  type: TYPE_TB
  zh: '|  |'
- en: In addition to these resources, the Federated API server also supports the Cluster
    object, which represents an underlying Kubernetes cluster, the same way a Node
    object represents a worker node in a regular Kubernetes cluster. To help you visualize
    how federated objects relate to the objects created in the underlying clusters,
    see [figure D.2](#filepos1786567).
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 除了这些资源外，联邦API服务器还支持集群对象，该对象代表底层Kubernetes集群，就像节点对象代表常规Kubernetes集群中的工作节点一样。为了帮助您可视化联邦对象与底层集群中创建的对象之间的关系，请参阅[图D.2](#filepos1786567)。
- en: Figure D.2\. The relationship between federated resources and regular resources
    in underlying clusters
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 图D.2\. 联邦资源与底层集群中常规资源之间的关系
- en: '![](images/00039.jpg)'
  id: totrans-32
  prefs: []
  type: TYPE_IMG
  zh: '![图片](images/00039.jpg)'
- en: D.3.2\. Understanding what federated resources do
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: D.3.2\. 理解联邦资源的作用
- en: For part of the federated objects, when you create the object in the Federation
    API server, the controllers running in the Federation Controller Manager will
    create regular cluster-scoped resources in all underlying Kubernetes clusters
    and manage them until the federated object is deleted.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 对于部分联邦对象，当您在联邦API服务器中创建对象时，运行在联邦控制器管理器中的控制器将在所有底层Kubernetes集群中创建常规集群范围资源，并管理它们，直到联邦对象被删除。
- en: For certain federated resource types, the resources created in the underlying
    clusters are exact replicas of the federated resource; for others, they’re slightly
    modified versions, whereas certain federated resources don’t cause anything to
    be created in the underlying clusters at all. The replicas are kept in sync with
    the original federated versions. But the synchronization is one-directional only—from
    the federation server down to the underlying clusters. If you modify the resource
    in an underlying cluster, the changes will not be synced up to the Federation
    API server.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 对于某些联邦资源类型，底层集群中创建的资源是联邦资源的精确副本；对于其他类型，它们是略微修改的版本，而某些联邦资源在底层集群中根本不会引起任何创建。副本与原始联邦版本保持同步。但同步是单向的，仅从联邦服务器到底层集群。如果您在底层集群中修改资源，更改将不会同步到联邦API服务器。
- en: For example, if you create a namespace in the federated API server, a namespace
    with the same name will be created in all underlying clusters. If you then create
    a federated ConfigMap inside that namespace, a ConfigMap with that exact name
    and contents will be created in all underlying clusters, in the same namespace.
    This also applies to Secrets, Services, and DaemonSets.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果您在联邦API服务器中创建一个命名空间，所有底层集群中都会创建一个具有相同名称的命名空间。如果您然后在那个命名空间内创建一个联邦ConfigMap，所有底层集群中都会创建一个具有该确切名称和内容的ConfigMap，位于相同的命名空间中。这也适用于Secrets、Services和DaemonSets。
- en: ReplicaSets and Deployments are different. They aren’t blindly copied to the
    underlying clusters, because that’s not what the user usually wants. After all,
    if you create a Deployment with a desired replica count of 10, you probably don’t
    want 10 pod replicas running in each underlying cluster. You want 10 replicas
    in total. Because of this, when you specify a desired replica count in a Deployment
    or ReplicaSet, the Federation controllers create underlying Deployments/ReplicaSets
    so that the sum of their desired replica counts equals the desired replica count
    specified in the federated Deployment or ReplicaSet. By default, the replicas
    are spread evenly across the clusters, but this can be overridden.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: ReplicaSets和Deployments是不同的。它们不会被盲目地复制到底层集群，因为这不是用户通常想要的。毕竟，如果您创建了一个期望副本数为10的Deployment，您可能不希望每个底层集群都运行10个Pod副本。您希望总共有10个副本。因此，当您在Deployment或ReplicaSet中指定期望副本数时，联邦控制器会创建底层Deployments/ReplicaSets，使得它们的期望副本数之和等于联邦Deployment或ReplicaSet中指定的期望副本数。默认情况下，副本会在集群之间均匀分布，但这可以被覆盖。
- en: '|  |'
  id: totrans-38
  prefs: []
  type: TYPE_TB
  zh: '|'
- en: Note
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 备注
- en: Currently, you need to connect to each cluster’s API server individually to
    get the list of pods running in that cluster. You can’t list all the clusters’
    pods through the Federated API server.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 目前，您需要单独连接到每个集群的API服务器，以获取在该集群中运行的Pod列表。您无法通过联邦API服务器列出所有集群的Pod。
- en: '|  |'
  id: totrans-41
  prefs: []
  type: TYPE_TB
  zh: '|'
- en: A federated Ingress resource, on the other hand, doesn’t result in the creation
    of any Ingress objects in the underlying clusters. You may remember from [chapter
    5](index_split_046.html#filepos469093) that an Ingress represents a single point
    of entry for external clients to a Service. Because of this, a federated Ingress
    resource creates a global, multi-cluster-wide entry point to the Services across
    all underlying clusters.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 另一方面，联邦Ingress资源不会在底层集群中创建任何Ingress对象。您可能还记得[第5章](index_split_046.html#filepos469093)，Ingress代表外部客户端访问服务的单个入口点。因此，联邦Ingress资源创建了一个全局的、跨所有底层集群的服务的多集群入口点。
- en: '|  |'
  id: totrans-43
  prefs: []
  type: TYPE_TB
  zh: '|'
- en: Note
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 备注
- en: As for regular Ingresses, a federated Ingress controller is required for this.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 对于常规的Ingress，需要联邦Ingress控制器来实现这一点。
- en: '|  |'
  id: totrans-46
  prefs: []
  type: TYPE_TB
  zh: '|'
- en: Setting up federated Kubernetes clusters is outside the scope of this book,
    so you can learn more about the subject by referring to the Cluster Federation
    sections in the user and administration guides in the Kubernetes online documentation
    at [http://kubernetes.io/docs/](http://kubernetes.io/docs/).
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 设置联邦Kubernetes集群超出了本书的范围，因此您可以通过参考Kubernetes在线文档中的用户和管理指南中的集群联邦部分来了解更多关于该主题的信息，[http://kubernetes.io/docs/](http://kubernetes.io/docs/)。
