- en: Appendix F. Compute environment running on Windows
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 附录F. 运行在Windows上的计算环境
- en: Kaslin Fields
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: Kaslin Fields
- en: 'This chapter includes:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章包括：
- en: What Windows containers are and how they are different from Linux containers
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows容器是什么以及它们与Linux容器有何不同
- en: How to run Windows containers on Anthos and GKE clusters.
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何在Anthos和GKE集群上运行Windows容器。
- en: Unique considerations for storage and networking in Anthos and GKE Windows environments.
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在Anthos和GKE Windows环境中存储和网络独特的考虑因素。
- en: F.1 Windows containers
  id: totrans-6
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: F.1 Windows容器
- en: To understand Windows containers, it’s important to first build an understanding
    of container technology. Containers are a lightweight packaging and isolation
    mechanism for running applications. Instead of virtualizing the hardware stack
    as with the virtual machine's approach, containers virtualize at the operating
    system level, with multiple containers running on top of the Operating System
    (OS) kernel directly.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 要理解Windows容器，首先需要建立对容器技术的理解。容器是运行应用程序的轻量级打包和隔离机制。与虚拟机方法虚拟化硬件堆栈不同，容器在操作系统级别进行虚拟化，多个容器直接在操作系统（OS）内核上运行。
- en: In essence, a "container" is generally simply a process or set of processes
    being run on its host operating system with some key tooling in place to isolate
    that process and its dependencies from the rest of the environment. The goal is
    to make that running process safely isolated, while taking up minimal resources
    from the system to perform that isolation.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 从本质上讲，“容器”通常只是在其宿主操作系统上运行的一个进程或一组进程，其中包含一些关键工具来隔离该进程及其依赖项，使其与其他环境隔离开来。目标是使该运行进程安全隔离，同时从系统中占用最少的资源来执行隔离。
- en: 'This poses a question: If containers are based on OS kernel-level capabilities,
    what does that mean for containers running on systems with totally separate kernels,
    as is the case with Linux compared to Windows? On Linux, the tooling used to isolate
    processes to create containers commonly boils down to cgroups and namespaces (among
    a few others), which are themselves tools built into the Linux Kernel. Linux cgroups
    or “control groups” are used to manage resources such as memory and cpu, while
    namespaces provide a degree of isolation by separating processes into groups.
    For Windows containers, Microsoft implemented functionality native to the Windows
    kernel in order to create the native “Windows Server Container.” (Microsoft also
    has a concept called a “Hyper-V container” which we will explore in greater detail
    in a few paragraphs.)'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 这引发了一个问题：如果容器基于操作系统内核级的能力，那么对于在具有完全不同内核的系统上运行的容器意味着什么？与Windows相比，Linux中用于隔离进程以创建容器的工具通常归结为cgroups和namespaces（以及其他一些工具），这些工具本身是集成到Linux内核中的。Linux
    cgroups或“控制组”用于管理内存和CPU等资源，而namespaces通过将进程分组提供一定程度的隔离。对于Windows容器，微软实现了Windows内核的本地功能，以创建本地的“Windows
    Server容器”。（微软还有一个名为“Hyper-V容器”的概念，我们将在接下来的几段中更详细地探讨。）
- en: 'The benefits of containers, whether Linux or Windows varieties, include:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 容器的优势，无论是Linux还是Windows版本，包括：
- en: Increased portability and agility
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提高可移植性和敏捷性
- en: Faster deployments and enhanced developer productivity
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 更快的部署和增强的开发者生产力
- en: Improved scalability and reliability
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 改进的扩展性和可靠性
- en: Containers decouple the OS from the application dependencies in the code. Since
    the application code and the dependent libraries are packaged together into one
    unit, there are fewer version inconsistencies, and you won't have the problem
    of "It worked on my machine."
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 容器将操作系统与应用程序代码中的依赖项解耦。由于应用程序代码和相关库被打包成一个单元，版本不一致性更少，你也不会遇到“在我的机器上它工作过”的问题。
- en: A unique benefit of Windows containers is that they may help users to save on
    licensing costs. As a proprietary operating system, Windows has licensing which
    must be accounted for when running a copy of the Operating System. By using containers,
    applications can be isolated without the need to run a full copy of the operating
    system. By sharing a single underlying operating system, Windows container users
    can save on licensing costs, while still packaging and isolating their applications.
    The architecture of VM-isolated applications is compared with that of container-isolated
    applications in Figure F.1.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: Windows容器的独特优势之一是它们可能有助于用户节省许可费用。作为一个专有操作系统，Windows有许可费用，在运行操作系统副本时必须考虑。通过使用容器，应用程序可以隔离，而无需运行操作系统的完整副本。通过共享单个底层操作系统，Windows容器用户可以在打包和隔离其应用程序的同时节省许可费用。图F.1比较了VM隔离应用程序的架构与容器隔离应用程序的架构。
- en: '![F_01](../../OEBPS/Images/F_01.png)'
  id: totrans-16
  prefs: []
  type: TYPE_IMG
  zh: '![F_01](../../OEBPS/Images/F_01.png)'
- en: Figure F.1 illustrates potential cost savings by bin packing multiple containers
    on a node.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 图F.1说明了在节点上对多个容器进行装箱可能带来的潜在成本节约。
- en: F.1.1 Two modes of runtime isolation for Windows containers
  id: totrans-18
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.1.1 Windows容器的两种运行时隔离模式
- en: Starting with Windows Server 2016, Microsoft began offering two modes of runtime
    isolation for Windows containers. The process isolation mode is most similar to
    Linux containers, and the Hyper-V isolation mode essentially runs the container
    using a very lightweight VM. Hyper-V isolated containers are meant to be used
    in a similar way to process isolated containers, but each container gets its kernel
    using a Hyper-V virtual machine rather than process isolation, unlike standard
    Linux containers.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 从Windows Server 2016开始，微软开始为Windows容器提供两种运行时隔离模式。进程隔离模式与Linux容器最相似，而Hyper-V隔离模式本质上是在一个非常轻量级的虚拟机上运行容器。Hyper-V隔离容器旨在以类似于进程隔离容器的方式使用，但每个容器通过Hyper-V虚拟机而不是进程隔离来获取其内核，这与标准Linux容器不同。
- en: Process isolated containers are containers running on a host that share the
    same kernel with the host and are isolated from each other using resource control,
    namespaces, and other process isolation techniques. Of the two modes, this is
    the more similar implementation to native Linux containers. Windows Server Containers
    provide a process and resource isolation boundary and hence can be used for enterprise
    multi-tenancy. However, because Microsoft has stated they do not intend to service
    Windows container escape vulnerabilities, the use of process isolated containers
    is not recommended in hostile multi-tenancy scenarios or those where differing
    risk levels are needed. Kubernetes added support for Windows Server Containers
    running on Windows Server 2019 nodes in Kubernetes version 1.14, which launched
    in the Spring of 2019.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 进程隔离容器是在主机上运行的容器，它们与主机共享相同的内核，并通过资源控制、命名空间和其他进程隔离技术相互隔离。在这两种模式中，这是与原生Linux容器更相似的实施方式。Windows
    Server容器提供了一个进程和资源隔离边界，因此可用于企业多租户。然而，由于微软表示他们不打算服务Windows容器逃逸漏洞，因此在敌对的多租户场景或需要不同风险水平的情况下不建议使用进程隔离容器。Kubernetes在2019年春季发布的1.14版本中增加了对在Windows
    Server 2019节点上运行的Windows Server容器的支持。
- en: Hyper-V isolated containers are isolated at the kernel level – each container
    gets its own kernel and runs inside a virtual machine (VM). This provides better
    security/isolation and compatibility between host and container operating system
    versions. They tend to have a heavier footprint, taking up more resources such
    as CPU and memory than process isolated containers (Windows Server Containers)
    due to the resource cost of the virtual machine/kernel level of isolation. The
    higher resource utilization and kernel level of isolation of Hyper-V containers
    make them least like native Linux containers. As of the time of writing, these
    containers are not officially supported by Kubernetes and thus not supported by
    GKE or Anthos.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: Hyper-V隔离容器在内核级别进行隔离 - 每个容器都拥有自己的内核并在虚拟机（VM）内部运行。这提供了更好的安全/隔离和主机与容器操作系统版本之间的兼容性。由于虚拟机/内核级别隔离的资源成本，它们通常占用更多资源，如CPU和内存，比进程隔离容器（Windows
    Server容器）的占用更多。Hyper-V容器的较高资源利用率和内核级别隔离使它们与原生Linux容器最不相似。截至撰写本文时，这些容器尚未由Kubernetes官方支持，因此GKE或Anthos也不支持。
- en: As Kubernetes does not support Hyper-V containers at this time, all discussions
    of Windows containers from this point on will refer to process isolated Windows
    Server Containers. We use the terms “Windows containers” and “Windows Server Containers”
    interchangeably in this text.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 由于 Kubernetes 目前不支持 Hyper-V 容器，因此从现在起所有关于 Windows 容器的讨论都将指代进程隔离的 Windows Server
    容器。在本文本中，我们交替使用“Windows 容器”和“Windows Server 容器”这两个术语。
- en: F.2 Using Windows containers
  id: totrans-23
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: F.2 使用 Windows 容器
- en: This section outlines use cases and core concepts for using Windows containers,
    including workloads that are good candidates for Windows containers, an exploration
    of .NET vs. .NET Core applications, and details about Windows container licensing.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 本节概述了使用 Windows 容器的用例和核心概念，包括适合 Windows 容器的良好工作负载、.NET 与 .NET Core 应用程序的探讨，以及
    Windows 容器许可的详细信息。
- en: F.2.1 Good candidates for Windows workloads
  id: totrans-25
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.2.1 适合 Windows 工作负载的良好候选者
- en: 'Suitable applications for Windows containers include:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 适合 Windows 容器的应用程序包括：
- en: Existing .NET Framework 3.5+ based applications – N-Tier apps, WCF services,
    Windows services, etc
  id: totrans-27
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 基于 .NET Framework 3.5+ 的现有应用程序——N-Tier 应用程序、WCF 服务、Windows 服务等。
- en: All [ASP.NET](http://asp.net) applications, including Web Forms, [ASP.NET](http://asp.net)
    MVC, [ASP.NET](http://asp.net) Web Pages, [ASP.NET](http://asp.net) Web API, etc.
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 所有 [ASP.NET](http://asp.net) 应用程序，包括 Web Forms、[ASP.NET](http://asp.net) MVC、[ASP.NET](http://asp.net)
    Web Pages、[ASP.NET](http://asp.net) Web API 等。
- en: IIS 7+ applications, including ISAPI filters and other pipelining techniques.
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: IIS 7+ 应用程序，包括 ISAPI 过滤器和其他管道技术。
- en: Classic ASP applications.
  id: totrans-30
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 经典 ASP 应用程序。
- en: Any console/batch application that does not have WinUI dependencies.
  id: totrans-31
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 任何没有 WinUI 依赖的控制台/批处理应用程序。
- en: Applications refactored to the Cloud Native and Microservices-based architecture.
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 应用程序重构为基于云原生和微服务架构。
- en: Newer applications* built on the .NET Core, .NET 5.0+ or ASP.NET Core.
  id: totrans-33
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 基于 .NET Core、.NET 5.0+ 或 ASP.NET Core 的新应用程序*。
- en: '*Newer applications built on the .NET Core, .NET 5.0+, or ASP.NET Core have
    cross-platform compatibility and can be deployed as Linux or Windows containers.'
  id: totrans-34
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 基于 .NET Core、.NET 5.0+ 或 ASP.NET Core 的新应用程序具有跨平台兼容性，可以部署为 Linux 或 Windows 容器。
- en: 'Applications that are not suitable for Windows containers:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 不适合 Windows 容器的应用程序：
- en: UI applications with a visual user interface.
  id: totrans-36
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 带有可视化用户界面的 UI 应用程序。
- en: Applications that use Microsoft Distributed Transaction Coordinator (MSDTC).
  id: totrans-37
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 Microsoft 分布式事务协调器 (MSDTC) 的应用程序。
- en: Windows infrastructure roles (DNS, DHCP, DC, NTP, PRINT, File server, IAM, etc.)
    and Microsoft Office are not supported.
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: Windows 基础设施角色（DNS、DHCP、DC、NTP、PRINT、文件服务器、IAM 等）以及 Microsoft Office 不受支持。
- en: To see the latest set of limitations, see ([https://docs.microsoft.com/en-us/virtualization/windowscontainers/quick-start/lift-shift-to-containers#applications-not-supported-by-containers](https://docs.microsoft.com/en-us/virtualization/windowscontainers/quick-start/lift-shift-to-containers#applications-not-supported-by-containers)).
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看最新的限制集，请参阅 ([https://docs.microsoft.com/en-us/virtualization/windowscontainers/quick-start/lift-shift-to-containers#applications-not-supported-by-containers](https://docs.microsoft.com/en-us/virtualization/windowscontainers/quick-start/lift-shift-to-containers#applications-not-supported-by-containers))。
- en: Note that existing applications (including monolithic and N-Tier) don't need
    to be re-architected or rewritten to take advantage of the benefits of containerization
    and modernization. Multiple options are available depending on the use case, business
    needs, and the type of application, and some of the options don't involve costly
    rewrites or rearchitecting. The following section explains this in more detail.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，现有的应用程序（包括单体和 N-Tier）不需要重新架构或重写，以利用容器化和现代化的好处。根据用例、业务需求和应用程序类型，有多种选项可供选择，其中一些选项不需要昂贵的重写或重新架构。以下部分将更详细地解释这一点。
- en: F.2.2 .NET Core vs .NET Framework applications
  id: totrans-41
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.2.2 .NET Core 与 .NET Framework 应用程序
- en: There are two popular options for modernizing an existing .NET Framework application
    – the application can be containerized into a Windows Server container and run
    on a Windows node, or the application can be ported to .NET Core/.NET 5+ and run
    as a Linux container on a Linux node. These two options for the process of containerizing
    Windows applications are illustrated in Figure F.2.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 现代化现有的 .NET Framework 应用程序有两种流行的选择——应用程序可以容器化到 Windows Server 容器中并在 Windows
    节点上运行，或者应用程序可以移植到 .NET Core/.NET 5+ 并在 Linux 节点上作为 Linux 容器运行。这两种容器化 Windows 应用程序的过程在图
    F.2 中进行了说明。
- en: '![F_02](../../OEBPS/Images/F_02.png)'
  id: totrans-43
  prefs: []
  type: TYPE_IMG
  zh: '![F_02](../../OEBPS/Images/F_02.png)'
- en: Figure F.2 shows the branching processes one could take to containerize a .NET
    application. Either directly to Windows Server Containers running on a Windows
    Server operating system, or the application could be ported to .NET Core to be
    run in containers on a Linux operating system.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 图F.2显示了将.NET应用程序容器化的可能分支过程。可以直接在Windows Server操作系统上运行的Windows Server容器，或者应用程序可以被移植到.NET
    Core，以便在Linux操作系统上的容器中运行。
- en: The first option (Windows Server containers on Windows) allows users to gain
    significant modernization benefits with a few deployment changes. It does not
    require changes to the code or architecture of the application and hence is an
    easier option. Users can containerize their application using Docker tools (e.g.,
    Image2Docker), Visual Studio Docker extension, or manually creating a docker file
    and then using the CLI to generate the image. They can also use the Migrate for
    Anthos option to create the container images without touching the application
    code. With bin packing and better resource utilization brought by Windows containers,
    users get licensing and infrastructure savings in addition to the numerous benefits
    brought by containerization.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 第一个选项（在Windows上运行Windows Server容器）允许用户通过一些部署更改获得显著的现代化好处。它不需要更改应用程序的代码或架构，因此是一个更简单的选项。用户可以使用Docker工具（例如，Image2Docker）、Visual
    Studio Docker扩展或手动创建docker文件，然后使用CLI生成镜像。他们还可以使用Migrate for Anthos选项创建容器镜像，而无需接触应用程序代码。凭借Windows容器带来的bin打包和更好的资源利用，用户除了获得容器化带来的众多好处外，还可以节省许可和基础设施成本。
- en: The second option (porting applications to .NET Core/.NET 5+ and using Linux
    Containers) requires upfront investment, and applications need to be ported or
    re-architected/rewritten. However, after the initial toil, the applications run
    without any dependency on Windows Server Licensing, resulting in 100% savings
    on licensing costs. Furthermore, Linux containers are lightweight and perform
    much better when compared to Windows containers.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个选项（将应用程序移植到.NET Core/.NET 5+并使用Linux容器）需要前期投资，并且应用程序需要移植或重新架构/重写。然而，在初始的辛勤工作之后，应用程序运行时无需依赖Windows
    Server许可，从而在许可成本上节省了100%。此外，与Windows容器相比，Linux容器轻量且性能更佳。
- en: The choice between the two options depends on the user and their business goals
    and constraints. Suppose the user needs to run many replicas(high scalability
    requirement) of a relatively fewer number of applications. In that case, it is
    recommended that they spend the extra effort to rewrite their Windows applications
    entirely to run on Linux or port them to the .NET Core/.NET 5+. The heavy lifting
    upfront is a good trade-off for better performance and obviates the MS licensing
    dependency.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 两种选项的选择取决于用户及其业务目标和限制。假设用户需要运行相对较少的应用程序的大量副本（高可扩展性要求），在这种情况下，建议他们花费额外精力将他们的Windows应用程序完全重写以在Linux上运行，或者将它们移植到.NET
    Core/.NET 5+。前期的大量工作是为了更好的性能，并且消除了对MS许可的依赖。
- en: On the contrary, porting to .NET Core or rewriting the apps to run on Linux
    can be cumbersome and painful if the user has several brownfield applications.
    Porting involves non-trivial effort and development investment, and it may not
    be possible to convert some applications because of dependencies. In such cases,
    running Windows Server containers on Windows hosts is a preferred and more accessible
    option – it provides significant benefits with a few lightweight deployment changes.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 相反，如果用户有几个遗留应用程序，将应用程序移植到.NET Core或重写以在Linux上运行可能会很繁琐且痛苦。移植涉及非平凡的劳动和开发投资，并且由于依赖关系，可能无法转换某些应用程序。在这种情况下，在Windows主机上运行Windows
    Server容器是一个更受欢迎且更易于访问的选项——它通过一些轻量级的部署更改提供了显著的好处。
- en: F.2.3 Container Licensing
  id: totrans-49
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.2.3 容器许可
- en: 'Currently, Kubernetes supports two Windows operating systems: Windows Server
    Standard and Windows Server Datacenter. These operating systems have no limit
    on the process-isolated Windows containers you may run. Windows Server Standard
    limits you to only two Hyper-V isolated containers, whereas Windows Server Datacenter
    allows unlimited Hyper-V isolated containers.'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 目前，Kubernetes支持两种Windows操作系统：Windows Server Standard和Windows Server Datacenter。这些操作系统对您可能运行的进程隔离Windows容器没有限制。Windows
    Server Standard限制了您只能运行两个Hyper-V隔离容器，而Windows Server Datacenter则允许无限数量的Hyper-V隔离容器。
- en: 'At the time of writing, open-source Kubernetes and thus GKE only support process-isolated
    Windows containers. A Kubernetes cluster could, therefore, include nodes running
    any version of Windows Server Standard or Datacenter that supports process-isolated
    containers: Windows Server 2016, Windows Server 2019, or in the near future, Windows
    Server 2022.'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 在撰写本文时，开源Kubernetes以及因此GKE仅支持进程隔离的Windows容器。因此，Kubernetes集群可以包括运行任何支持进程隔离容器的Windows
    Server Standard或Datacenter版本的节点：Windows Server 2016、Windows Server 2019或不久的将来，Windows
    Server 2022。
- en: The Windows Server versions supported by GKE are covered in more detail in the
    “Which Windows Versions/Types are Supported” section.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: GKE支持的Windows Server版本在“支持哪些Windows版本/类型”部分有更详细的说明。
- en: Be sure to check Microsoft’s resources for the most up-to-date container licensing
    models. ([https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/faq#how-are-containers-licensed--is-there-a-limit-to-the-number-of-containers-i-can-run](https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/faq#how-are-containers-licensed--is-there-a-limit-to-the-number-of-containers-i-can-run))
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 一定要检查微软的资源，以获取最新的容器许可模式信息。([https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/faq#how-are-containers-licensed--is-there-a-limit-to-the-number-of-containers-i-can-run](https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/faq#how-are-containers-licensed--is-there-a-limit-to-the-number-of-containers-i-can-run))
- en: F.2.4 Windows container base images
  id: totrans-54
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.2.4 Windows容器基础镜像
- en: 'When considering how to run your .NET applications in containers, your first
    step will be to select a base image to build your container from which is compatible
    with the application you intend to run. Microsoft offers four base images for
    users to build Windows containers from: Windows Server Core, Windows Nano Server,
    Windows, and Windows Server. The majority of use cases should be fulfilled by
    just two of these, Windows Server Core and Windows Nano Server. Additionally,
    it is possible to run .NET Core applications in Linux containers. Figure F.3 illustrates
    how to choose the container base image to best fit the needs of .NET applications.'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 当考虑如何在容器中运行你的.NET应用程序时，你的第一步将是选择一个基础镜像来构建你的容器，这个镜像需要与你要运行的应用程序兼容。微软为用户提供了四个基础镜像，用于构建Windows容器：Windows
    Server Core、Windows Nano Server、Windows和Windows Server。大多数用例只需其中两个即可满足，即Windows
    Server Core和Windows Nano Server。此外，你还可以在Linux容器中运行.NET Core应用程序。图F.3展示了如何选择最适合.NET应用程序需求的容器基础镜像。
- en: '![F_03](../../OEBPS/Images/F_03.png)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
  zh: '![F_03](../../OEBPS/Images/F_03.png)'
- en: Figure F.3 illustrates the decision tree for determining which type of container
    base image should be used to run a .NET application.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 图F.3展示了确定运行.NET应用程序时应使用哪种类型的容器基础镜像的决策树。
- en: Windows Nano Server base image - Modernized or newly developed .NET applications
    running on Windows may be able to make use of the Windows Nano Server container
    image. The Windows Nano Server image is designed to be lightweight and resource-efficient,
    offering a level of resource utilization most comparable to Linux container base
    images. The environment has fewer of the features you would find in a full Windows
    Server operating system, but enough to run many applications. This image takes
    up the smallest footprint of the four native Windows container base images.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: Windows Nano Server基础镜像 - 在Windows上运行的现代化或新开发的.NET应用程序可能能够利用Windows Nano Server容器镜像。Windows
    Nano Server镜像旨在轻量级和资源高效，提供与Linux容器基础镜像最相似的资源利用率。该环境具有比全功能的Windows Server操作系统更少的特性，但足以运行许多应用程序。这个镜像在四个原生Windows容器基础镜像中占用的空间最小。
- en: Windows Server Core base image - For legacy .NET applications that may have
    previously run on Windows Server VMs, the Windows Server Core base image offers
    a more fully-featured Windows Server-like environment. This is the larger of the
    two most commonly used base images. Compared to all four base images, it is the
    second smallest.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: Windows Server Core基础镜像 - 对于可能之前在Windows Server VM上运行的遗留.NET应用程序，Windows Server
    Core基础镜像提供了一个更全面功能的类似Windows Server的环境。这是两个最常用基础镜像中较大的一个。与所有四个基础镜像相比，它是第二小的。
- en: Windows base image - this is the largest of Microsoft’s currently offered container
    base images. It offers the full Windows API, giving you the ability to run a wide
    variety of workloads. However, your containers will also have the largest resource
    utilization compared with a container running the same application but built using
    one of the other base images. The image is available for Windows Server 2019 LTSC
    and SAC variants.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 基础镜像 - 这是微软目前提供的容器基础镜像中最大的一个。它提供了完整的 Windows API，使您能够运行各种工作负载。然而，与使用其他基础镜像构建的运行相同应用程序的容器相比，您的容器将具有最大的资源利用率。该镜像适用于
    Windows Server 2019 LTSC 和 SAC 版本。
- en: Windows Server base image - this base image is similar to the previously mentioned
    “Windows base” image, but with none of the by design constraints as it’s being
    treated as a “Windows Server” like license. This base image is available starting
    with Windows Server 2022.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: Windows Server 基础镜像 - 这个基础镜像与之前提到的“Windows 基础”镜像类似，但没有设计上的限制，因为它被视为“Windows
    Server”类型的许可。这个基础镜像从 Windows Server 2022 开始可用。
- en: .NET Apps in Linux Containers - One additional consideration is running .NET
    applications on Linux using .NET Core/.NET 5+. This allows you to avoid Windows
    licensing costs entirely but requires that applications be written or rewritten
    to use .NET Core/.NET 5+. In this case, the application would be able to run using
    Linux containers and thus could be built using any of the many available Linux
    container base images.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: Linux 容器中的 .NET 应用 - 另一个需要考虑的因素是在 Linux 上使用 .NET Core/.NET 5+ 运行 .NET 应用程序。这可以使您完全避免
    Windows 许可费用，但要求应用程序被编写或重写以使用 .NET Core/.NET 5+。在这种情况下，应用程序将能够使用 Linux 容器运行，因此可以使用许多可用的
    Linux 容器基础镜像之一进行构建。
- en: F.3 How Windows containers are different from Linux containers
  id: totrans-63
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: F.3 Windows 容器与 Linux 容器的不同之处
- en: Windows containers and Linux containers are both packaging and isolation mechanisms
    which, in the case of Windows Server containers, run applications while sharing
    an underlying kernel. Since the implementations of these concepts are unique to
    the Windows and Linux kernels, it makes sense that there would be a number of
    differences between them. As you explore container resources, you will likely
    find that the majority of “container” information in the world today is geared
    toward Linux containers, and often does not explicitly call out this assumption.
    This section calls out significant differences between Linux and Windows containers
    which should help you identify useful container resources and products for Windows
    use cases. Keep them in mind as you explore the world of process packaging and
    isolation with containers.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 容器和 Linux 容器都是打包和隔离机制，在 Windows Server 容器的情况下，它们在共享底层内核的同时运行应用程序。由于这些概念的实施是针对
    Windows 和 Linux 内核的独特，因此它们之间会有许多差异是有道理的。当您探索容器资源时，您可能会发现世界上大多数“容器”信息都是针对 Linux
    容器的，并且通常没有明确指出这个假设。本节突出了 Linux 和 Windows 容器之间的重要差异，这应该有助于您识别对 Windows 用例有用的容器资源和产品。在您探索使用容器进行进程打包和隔离的世界时，请记住这些差异。
- en: Windows Containers tend to require more resources. One of the most commonly
    encountered differences between native Windows and Linux containers is that Windows
    containers tend to take up considerably more resources than their Linux counterparts.
    A commonly cited benefit of container technology is that containers provide “lightweight,”
    resource-efficient isolation. This is a relative judgment, which depends largely
    on the implementation of the container technology as well as the application you
    are trying to run. While the size of the application being run is one factor,
    another key factor in the larger resource utilization on average for Windows containers
    when compared with Linux containers can be largely attributed to the design of
    the two available Windows container base images, Windows Server Core and Windows
    Nano Server, discussed in the previous section.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 容器通常需要更多的资源。在原生 Windows 和 Linux 容器之间最常见的差异之一是，Windows 容器通常比它们的 Linux
    对应物占用更多的资源。容器技术的一个常见好处是，容器提供“轻量级”、资源高效的隔离。这是一个相对判断，很大程度上取决于容器技术的实现以及您试图运行的应用程序。虽然正在运行的应用程序的大小是一个因素，但与
    Linux 容器相比，Windows 容器平均资源利用率更高的另一个关键因素可以很大程度上归因于前一部分中讨论的两个可用的 Windows 容器基础镜像的设计，即
    Windows Server Core 和 Windows Nano Server。
- en: Windows Containers have fewer available base images. As a proprietary technology,
    the base images available for Windows Server Containers are limited to the “flavors”
    provided by Microsoft and based on their Windows Server operating system. This
    is a difference from the plethora of base images available both from open source
    and proprietary sources for Linux containers.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 容器可用的基础镜像较少。作为一种专有技术，Windows Server 容器可用的基础镜像仅限于微软提供的“风味”，并基于其 Windows
    Server 操作系统。这与 Linux 容器从开源和专有来源可用的丰富基础镜像形成对比。
- en: Windows Container image pull times tend to be slower. Windows container base
    images are generally considerably larger than Linux container base images. Therefore,
    pulling Windows images from a repository will generally to take longer due to
    the larger image size.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 容器镜像的拉取时间通常较慢。Windows 容器的基础镜像通常比 Linux 容器的基础镜像大得多。因此，从存储库拉取 Windows
    镜像通常需要更长的时间，因为镜像大小较大。
- en: Linux security features vs. Windows security features. Windows Server containers
    running in process-isolated mode are similar to Linux containers in terms of the
    level of isolation. Nonetheless, some security features specific to Linux systems
    and containers, such as Seccomp and SELinux, don't have the Windows analog. HostProcess
    containers for Windows are the equivalent of Linux privileged containers and provide
    privileged access to the host – it is disabled in the baseline policy. Note that
    HostProces containers are not generally available at the time of writing (beta
    feature as of Kubernetes v1.23).
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: Linux 安全功能与 Windows 安全功能。以进程隔离模式运行的 Windows Server 容器在隔离级别上与 Linux 容器相似。尽管如此，一些特定于
    Linux 系统和容器的安全功能，如 Seccomp 和 SELinux，在 Windows 中没有对应的功能。Windows 的 HostProcess
    容器相当于 Linux 的特权容器，并提供对主机的特权访问——在基线策略中已禁用。请注意，截至编写时，HostProcess 容器通常不可用（Kubernetes
    v1.23 时的 beta 功能）。
- en: RunAsUserName is the equivalent of Linux RunAsUser can be used to run the containers
    using a non-default user. It can take values such as ContainerAdministrator and
    ContainerUser. ContainerAdministrator has elevated privileges and is used to perform
    administrative tasks, install services and tools, and make configuration changes.
    Following the principle of least privilege, running the container as ContainerUser
    is recommended unless admin access is needed.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: RunAsUserName 等同于 Linux 的 RunAsUser，可以用来使用非默认用户运行容器。它可以取值如 ContainerAdministrator
    和 ContainerUser。ContainerAdministrator 具有提升的权限，用于执行管理任务、安装服务和工具以及进行配置更改。遵循最小权限原则，除非需要管理员访问权限，否则建议以
    ContainerUser 运行容器。
- en: If the use case requires running hostile multi-tenant workloads, i.e., if at
    least one of the workloads is untrusted, running Windows Server containers with
    process isolation in the same cluster is not recommended.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 如果用例需要运行敌对的多租户工作负载，即至少有一个工作负载是不可信的，则不建议在同一集群中运行具有进程隔离的 Windows Server 容器。
- en: Also, there are some differences in how Linux handles File paths, File Permissions,
    Signals, Identity, etc. compared with how Windows handles those aspects. For instance,
    Windows uses backslashes in the file path instead of the forward slash. It is
    good to be aware of such differences. See ([https://kubernetes.io/docs/setup/production-environment/windows/_print/#compatibility-linux-similarities](https://kubernetes.io/docs/setup/production-environment/windows/_print/#compatibility-linux-similarities))
    for more information.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，Linux 在处理文件路径、文件权限、信号、身份等方面与 Windows 处理这些方面的方式存在一些差异。例如，Windows 在文件路径中使用反斜杠而不是正斜杠。了解这些差异是有好处的。更多信息请参阅([https://kubernetes.io/docs/setup/production-environment/windows/_print/#compatibility-linux-similarities](https://kubernetes.io/docs/setup/production-environment/windows/_print/#compatibility-linux-similarities))。
- en: F.4 Windows containers on Anthos and Google Kubernetes Engine (GKE) clusters
  id: totrans-72
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: F.4 Anthos 和 Google Kubernetes Engine (GKE) 集群上的 Windows 容器
- en: This section explores the architecture and considerations of both Anthos and
    GKE clusters running Windows workloads. The two types of clusters have considerable
    overlap in terms of architecture, so the two are explained hand-in-hand. On-Prem
    Anthos clusters, which have some unique considerations, are called out separately
    later in this section. Often the best way to learn is to try it out for yourself,
    so in this section you will find a hands-on tutorial that walks through creating
    a Windows container and deploying it onto Kubernetes via a GKE cluster. The process
    would be similar, though with slightly different tools, for Anthos clusters running
    in non-GCP environments.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 本节探讨了运行Windows工作负载的Anthos和GKE集群的架构和考虑因素。这两种类型的集群在架构方面有相当大的重叠，因此它们是相互关联地解释的。具有一些独特考虑因素的On-Prem
    Anthos集群将在本节稍后单独说明。通常，最好的学习方式是亲自尝试，因此在本节中，您将找到一个动手教程，指导您创建Windows容器并将其部署到Kubernetes上，通过GKE集群。对于在非GCP环境中运行的Anthos集群，过程将类似，尽管工具略有不同。
- en: F.4.1 Architecture of Anthos and Google Kubernetes Engine (GKE) clusters with
    Windows node pools
  id: totrans-74
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.4.1 带有Windows节点池的Anthos和Google Kubernetes Engine (GKE)集群的架构
- en: When running containers at scale, a container orchestration tool is needed.
    By far, the most popular container orchestration tool is Kubernetes. Anthos managed
    Kubernetes clusters can run in a variety of environments, and wherever they are
    run, they are primarily based on the architecture of GKE clusters. Be sure to
    check out the chapter Computing environment built on Kubernetes in this book for
    a more complete overview of Google Kubernetes Engine and how it relates to Anthos.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 在大规模运行容器时，需要一个容器编排工具。迄今为止，最受欢迎的容器编排工具是Kubernetes。Anthos管理的Kubernetes集群可以在各种环境中运行，无论它们在哪里运行，它们主要基于GKE集群的架构。务必查看本书中关于基于Kubernetes的计算环境的章节，以获得对Google
    Kubernetes Engine及其与Anthos之间关系的更全面概述。
- en: This section provides a reference architecture for running Windows container-based
    applications via a GKE or Anthos cluster with Windows node pools.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 本节提供了通过GKE或Anthos集群使用Windows节点池运行基于Windows容器的参考架构。
- en: '![F_04](../../OEBPS/Images/F_04.png)'
  id: totrans-77
  prefs: []
  type: TYPE_IMG
  zh: '![F_04](../../OEBPS/Images/F_04.png)'
- en: Figure F.4 Illustration of Windows Server and Linux containers running side-by-side
    in the same cluster
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 图F.4 在同一集群中并排运行Windows Server和Linux容器的说明
- en: Figure F.4 illustrates the high-level architecture of an Anthos or GKE cluster
    with Windows node pools. The green block represents the managed master or control
    plane that continues to run using Linux, and the yellow blocks represent the worker
    node pools. Windows Server node pools can be attached to an existing or new GKE
    or Anthos cluster, just as you would add Linux node pools. The shared control
    plane for Linux and Windows is the key factor that provides a consistent experience.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 图F.4说明了带有Windows节点池的Anthos或GKE集群的高级架构。绿色块代表继续使用Linux运行的托管主节点或控制平面，而黄色块代表工作节点池。Windows
    Server节点池可以连接到现有的或新的GKE或Anthos集群，就像您添加Linux节点池一样。Linux和Windows共享的控制平面是提供一致体验的关键因素。
- en: A single cluster can have multiple Windows Server node pools using different
    Windows Server versions, but each node pool can only use one Windows Server version.
    Labels are used to funnel Windows pods to Windows nodes. Taints and tolerations
    can be used to prevent or repel Linux pods from running in Windows nodes. Kubelet
    and Kube-proxy run natively on Windows nodes. The overall architecture allows
    you to seamlessly run mixed Windows and Linux container workloads in the same
    cluster.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 单个集群可以使用不同的Windows Server版本拥有多个Windows Server节点池，但每个节点池只能使用一个Windows Server版本。标签用于将Windows
    pod引导到Windows节点。可以使用污点（Taints）和容忍度（Tolerations）来防止或排斥Linux pod在Windows节点上运行。Kubelet和Kube-proxy在Windows节点上本地运行。整体架构允许您在同一个集群中无缝运行混合的Windows和Linux容器工作负载。
- en: Advantages of running Windows workloads using Anthos
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 使用Anthos运行Windows工作负载的优点
- en: 'Modernization Benefits: Containerizing and running Windows workloads using
    Kubernetes allows users to take advantage of many of the modernization benefits
    previously limited to Linux-based applications. There are numerous advantages,
    from better scalability and portability to simplified management and speed of
    deployment.'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 现代化优势：使用Kubernetes容器化和运行Windows工作负载允许用户利用许多以前仅限于基于Linux应用程序的现代化优势。有众多优势，从更好的可伸缩性和可移植性到简化的管理和部署速度。
- en: 'Operational Consistency: By running Windows and Linux workloads side-by-side
    in a consistent manner, users get operational efficiency. You no longer need multiple
    teams specializing in different tooling or platforms for managing different types
    of applications – you can have consistent operations across Windows and Linux
    applications.'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 运营一致性：通过以一致的方式在 Windows 和 Linux 工作负载中并行运行，用户可以获得运营效率。您不再需要多个团队专门针对不同的工具或平台来管理不同类型的应用程序——您可以在
    Windows 和 Linux 应用程序之间实现一致的运营。
- en: 'Cost Savings: GKE/Anthos Windows provides better bin packing - by running multiple
    applications as containers in a worker node, users get better resource utilization
    and hence the infrastructure savings, and more importantly, you also benefit from
    Windows Server license savings.'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 成本节省：GKE/Anthos Windows 提供更好的二进制打包——通过在工作节点上以容器形式运行多个应用程序，用户可以获得更好的资源利用率，从而节省基础设施成本，更重要的是，您还可以从
    Windows Server 许可证节省中获得好处。
- en: Which Windows Versions/Types are Supported
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 支持的 Windows 版本/类型
- en: At the time of writing, Windows Node Pools in GKE and Anthos clusters support
    the Windows Server 2019 LTSC (Long-Term Servicing Channel) version as the Node
    OS image. And support for Windows Server 2022 is in the pipeline. Although support
    for Windows containers was added with Windows Server 2016, Kubernetes made support
    for [Windows Server containers available in GA](https://kubernetes.io/blog/2019/03/25/kubernetes-1-14-release-announcement/)
    in version 1.14 in March 2019 with Windows Server 2019\. Consequently, Windows
    Server 2016 is not supported.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 在撰写本文时，GKE 和 Anthos 集群中的 Windows Node Pools 支持将 Windows Server 2019 LTSC（长期服务渠道）版本作为节点操作系统镜像。Windows
    Server 2022 的支持正在计划中。尽管 Windows Server 2016 中添加了对 Windows 容器的支持，但 Kubernetes 在
    2019 年 3 月的 1.14 版本中提供了 [Windows Server 容器的 GA 支持](https://kubernetes.io/blog/2019/03/25/kubernetes-1-14-release-announcement/)，使用的是
    Windows Server 2019。因此，Windows Server 2016 不再受支持。
- en: Note that GKE previously supported Semi-Annual Channel (SAC) versions of Windows
    Server as well; however, Microsoft [deprecated](https://docs.microsoft.com/en-us/windows-server/get-started/removed-deprecated-features-windows-server-2022)
    support for the SAC channel starting with Windows Server 2022.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，GKE 之前也支持 Windows Server 的半年度渠道（SAC）版本；然而，从 Windows Server 2022 开始，Microsoft
    [弃用了](https://docs.microsoft.com/en-us/windows-server/get-started/removed-deprecated-features-windows-server-2022)
    对 SAC 渠道的支持。
- en: There are two options for the container runtime – Docker and containerd. The
    container runtime is used by Kubernetes nodes to launch and manage the containers
    that make up the Kubernetes pods. Containerd support was [released by Kubernetes](https://kubernetes.io/blog/2018/05/24/kubernetes-containerd-integration-goes-ga/)
    open-source (OSS) community in 2018 and has shown to decrease resource usage and
    improve startup latency. For GKE and Anthos clusters created in 2022 and later,
    it is strongly recommended that you use the containerd runtime (which is the default)
    if available.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 容器运行时有两个选项——Docker 和 containerd。容器运行时由 Kubernetes 节点用于启动和管理构成 Kubernetes Pod
    的容器。containerd 支持在 2018 年由 Kubernetes [发布到开源社区](https://kubernetes.io/blog/2018/05/24/kubernetes-containerd-integration-goes-ga/)，并显示出降低资源使用和提高启动延迟的效果。对于
    2022 年及以后创建的 GKE 和 Anthos 集群，如果可用，强烈建议您使用 containerd 运行时（这是默认设置）。
- en: Compatibility between the container base OS version and the host OS
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 容器基础操作系统版本与主机操作系统之间的兼容性
- en: For Windows Server containers deployed in process isolation mode, the operating
    system version of the container's base image must [match](https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/version-compatibility?tabs=windows-server-2022%2Cwindows-10-21H1#matching-container-host-version-with-container-image-versions)
    the host's version (illustrated in Figure F.5). In the four-part version tuple
    - major.minor.build.patch, the first three parts (i.e., the major, minor, and
    build versions) need to match. The patch versions need not match.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 对于以进程隔离模式部署的 Windows Server 容器，容器的基础镜像的操作系统版本必须 [匹配](https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/version-compatibility?tabs=windows-server-2022%2Cwindows-10-21H1#matching-container-host-version-with-container-image-versions)
    主机的版本（如图 F.5 所示）。在四部分版本元组 - 主版本.minor.build.patch 中，前三个部分（即主版本、次要版本和构建版本）需要匹配。修补版本不需要匹配。
- en: This restriction does not apply for Windows Server containers running in Hyper-V
    isolated mode, and the versions can be different.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 此限制不适用于在 Hyper-V 隔离模式下运行的 Windows Server 容器，版本可以不同。
- en: '![F_05](../../OEBPS/Images/F_05.png)'
  id: totrans-92
  prefs: []
  type: TYPE_IMG
  zh: '![F_05](../../OEBPS/Images/F_05.png)'
- en: Figure F.5 Windows Container versions must share the third value of the container
    tuple. For example, a host running Windows Server version 10.0.16299.1 would be
    compatible with a container running version 10.0.16299.0, but the same container
    would not be compatible with a host running version 10.0.17134.0.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 图F.5 Windows容器版本必须共享容器元组的第三个值。例如，运行Windows Server版本10.0.16299.1的主机与运行版本10.0.16299.0的容器兼容，但相同的容器与运行版本10.0.17134.0的主机不兼容。
- en: Prerequisites
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 先决条件
- en: Even for a dedicated Windows cluster, at least one Linux node is required in
    the GKE/Anthos cluster because some system pods only run on Linux nodes.
  id: totrans-95
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 即使是专门的Windows集群，GKE/Anthos集群中也至少需要一个Linux节点，因为一些系统Pod只能在Linux节点上运行。
- en: 'Larger machine types are recommended for running Windows Server containers:
    n1-standard-2 is the minimum recommended machine type on GCP as Windows Server
    nodes require additional resources. Smaller machine types f1-micro and g1-small
    are not supported.'
  id: totrans-96
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 建议使用更大的机器类型来运行Windows Server容器：在GCP上，n1-standard-2是最低推荐的机器类型，因为Windows Server节点需要额外的资源。不支持较小的机器类型f1-micro和g1-small。
- en: 'Licensing:'
  id: totrans-97
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 许可证：
- en: In the GCP cloud environment, the license is baked into the VM. When a user
    adds a Windows VM to their GKE or Anthos cluster, the corresponding license is
    also added. It is the same as how customers provision a Windows VM in GCE. Check
    Google Cloud’s [compute disk image pricing](https://cloud.google.com/compute/disks-image-pricing)
    documentation for the most up-to-date information and details.
  id: totrans-98
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在GCP云环境中，许可证已嵌入到虚拟机中。当用户将Windows虚拟机添加到他们的GKE或Anthos集群时，相应的许可证也会添加。这与客户在GCE中配置Windows虚拟机的方式相同。请查阅Google
    Cloud的[计算磁盘镜像定价](https://cloud.google.com/compute/disks-image-pricing)文档以获取最新信息和详细信息。
- en: In the Anthos On-Premises environment, users need to procure their Windows Server
    licenses (BYOL - Bring your own license model). Consequently, users need to download
    a Windows Server ISO from Microsoft or use their company-curated OS image per
    Microsoft licensing terms. A vanilla OS image from Microsoft is recommended. Users
    need to create a base Windows VM template from the Windows Server ISO, which gets
    used when a node pool is added to the user cluster.
  id: totrans-99
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在Anthos On-Premises环境中，用户需要自行采购Windows Server许可证（BYOL - 带自己的许可证模式）。因此，用户需要从Microsoft下载Windows
    Server ISO，或者根据Microsoft的许可条款使用公司定制的操作系统镜像。建议使用Microsoft的纯操作系统镜像。用户需要从Windows
    Server ISO创建一个基本的Windows虚拟机模板，该模板在向用户集群添加节点池时使用。
- en: Running Windows Containers on Google Cloud and GKE (Tutorial)
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 在Google Cloud和GKE上运行Windows容器（教程）
- en: 'This section provides a hands-on tutorial to create a Windows container and
    run it on GKE. It is adapted from the “Running Windows containers on Google Cloud”
    codelabs available at:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 本节提供了一个动手教程，用于创建Windows容器并在GKE上运行它。它改编自以下“在Google Cloud上运行Windows容器”codelabs：
- en: 'Part 1: [https://codelabs.developers.google.com/codelabs/cloud-windows-containers-computeengine](https://codelabs.developers.google.com/codelabs/cloud-windows-containers-computeengine)'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: '第1部分: [https://codelabs.developers.google.com/codelabs/cloud-windows-containers-computeengine](https://codelabs.developers.google.com/codelabs/cloud-windows-containers-computeengine)'
- en: 'Part 2: [https://codelabs.developers.google.com/codelabs/cloud-windows-containers-kubernetesengine](https://codelabs.developers.google.com/codelabs/cloud-windows-containers-kubernetesengine)'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: '第2部分: [https://codelabs.developers.google.com/codelabs/cloud-windows-containers-kubernetesengine](https://codelabs.developers.google.com/codelabs/cloud-windows-containers-kubernetesengine)'
- en: Setup and Requirements
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 设置和需求
- en: This tutorial expects you to have a Google Cloud Platform project to work within.
    You can use an existing one, or create a new one.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 本教程假设您有一个Google Cloud Platform项目用于工作。您可以使用现有的项目，或者创建一个新的项目。
- en: 'Part 1: Creating a Windows Container'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 第1部分：创建Windows容器
- en: Create a Windows VM
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 创建Windows虚拟机
- en: In order to create a Windows container, you will need access to a Windows operating
    system which supports them. Begin by creating a Windows Server instance in Google
    Cloud on which you will create your Windows Container. You could do this either
    using the gcloud cli, or the console. In this section, we provide instructions
    for doing this in the Google Cloud Console.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 为了创建一个Windows容器，您需要访问支持它们的Windows操作系统。首先，在Google Cloud上创建一个Windows Server实例，您将在该实例上创建您的Windows容器。您可以使用gcloud
    cli或控制台来完成此操作。在本节中，我们提供了在Google Cloud控制台上执行此操作的说明。
- en: In the Google Cloud Platform Console, go to the Compute Engine section and create
    an instance. For this exercise, select Windows Server 2019 Datacenter for Containers
    as the version for your boot disk, as seen in Figure F.6.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Google Cloud Platform 控制台中，转到计算引擎部分并创建一个实例。对于这个练习，选择如图 F.6 所示的 Windows Server
    2019 Datacenter for Containers 作为引导磁盘的版本。
- en: '![F_06](../../OEBPS/Images/F_06.png)'
  id: totrans-110
  prefs: []
  type: TYPE_IMG
  zh: '![F_06](../../OEBPS/Images/F_06.png)'
- en: Figure F.6 The “Boot disk” section of the VM creation workflow on Google Cloud
    Platform (GCP) has an “OS images” tab where you can select the desired Operating
    System image for your VM. For this tutorial, we will use “Windows Server 2019
    Datacenter for Containers.”
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 图 F.6 在 Google Cloud Platform (GCP) 上虚拟机创建工作流程的“引导磁盘”部分有一个“操作系统镜像”标签，您可以在其中选择您虚拟机的所需操作系统镜像。对于本教程，我们将使用“Windows
    Server 2019 Datacenter for Containers。”
- en: Also make sure that HTTP and HTTPS traffic are enabled for this VM, as shown
    in the below screenshot.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 确保此虚拟机的 HTTP 和 HTTPS 流量已启用，如图中所示。
- en: '![F_07](../../OEBPS/Images/F_07.png)'
  id: totrans-113
  prefs: []
  type: TYPE_IMG
  zh: '![F_07](../../OEBPS/Images/F_07.png)'
- en: 'FIg F.7 The “Firewall” section of the VM creation workflow offers two checkboxes
    which must be checked for this tutorial: “Allow HTTP traffic” and “Allow HTTPS
    traffic.”'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 图 F.7 在虚拟机创建工作流程的“防火墙”部分提供了两个必须勾选的复选框，以便进行本教程： “允许 HTTP 流量”和“允许 HTTPS 流量。”
- en: Select “Allow full access to all Cloud APIs,” as shown in Figure F.8.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 选择如图 F.8 所示的“允许访问所有云 API 的完全访问权限。”
- en: '![F_08](../../OEBPS/Images/F_08.png)'
  id: totrans-116
  prefs: []
  type: TYPE_IMG
  zh: '![F_08](../../OEBPS/Images/F_08.png)'
- en: Figure F.8 In the “Access scopes” subsection of the “Identity and API access”
    section of the VM creation workflow, select “Allow full access to all Cloud APIs.”
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 图 F.8 在虚拟机创建工作流程的“身份和 API 访问”部分的“访问范围”子部分中，选择“允许访问所有云 API 的完全访问权限。”
- en: After you click “Create,” it will take a few minutes for the VM to start up.
    Once the VM has started, you should see your VM running in the console, as shown
    in Figure F.9.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“创建”后，虚拟机启动需要几分钟。一旦虚拟机启动，您应该在控制台中看到您的虚拟机正在运行，如图 F.9 所示。
- en: '![F_09](../../OEBPS/Images/F_09.png)'
  id: totrans-119
  prefs: []
  type: TYPE_IMG
  zh: '![F_09](../../OEBPS/Images/F_09.png)'
- en: Figure F.9 A running VM instance in Google Cloud will display the VM name, with
    additional information such as region and IP shown in line to the right of the
    name.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 图 F.9 在 Google Cloud 中运行的虚拟机实例将显示虚拟机名称，名称右侧的行将显示附加信息，如区域和 IP。
- en: Remote Desktop (RDP) in to the Windows VM
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 通过远程桌面 (RDP) 登录到 Windows 虚拟机
- en: 'To access the VM you created, you will need to configure a password. There
    are two ways to do this. You can either set a new Windows password using the RDP
    button as seen in Figure F.10:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 要访问您创建的虚拟机，您需要配置一个密码。有两种方法可以做到这一点。您可以使用如图 F.10 所示的 RDP 按钮设置新的 Windows 密码：
- en: '![F_10](../../OEBPS/Images/F_10.png)'
  id: totrans-123
  prefs: []
  type: TYPE_IMG
  zh: '![F_10](../../OEBPS/Images/F_10.png)'
- en: Figure F.10 Clicking the “RDP” drop down menu as shown in the VM information
    from the previous image will give you an option to Set the Windows password.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 图 F.10 点击如图中上一张图片所示的虚拟机信息中的“RDP”下拉菜单将提供设置 Windows 密码的选项。
- en: Alternatively, you can click “View gcloud command to reset password” and run
    the command displayed in order to set the password.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，您可以点击“查看 gcloud 命令以重置密码”并运行显示的命令以设置密码。
- en: After a few seconds, you should see the Windows password in the console or Cloud
    Shell. Make sure you make a secure note of it. You will need it to access the
    Windows VM.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 几秒钟后，您应该在控制台或 Cloud Shell 中看到 Windows 密码。请确保您安全地记录下来。您将需要它来访问 Windows 虚拟机。
- en: To log in to the Windows VM, you can click the RDP button of the VM, as shown
    in the last two images, this time clicking the “RDP” rather than the drop down
    symbol.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 要登录到 Windows 虚拟机，您可以点击虚拟机的 RDP 按钮，如图中最后两张图片所示，这次点击“RDP”而不是下拉符号。
- en: You may also use your own RDP client to log in to the VM if you prefer.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您愿意，您也可以使用自己的 RDP 客户端登录到虚拟机。
- en: Once inside the VM, open a command prompt in admin mode. Docker and the Windows
    Server Core base image are installed by default, which you can confirm by running
    “docker images” as shown in Figure F.11.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦进入虚拟机，以管理员模式打开一个命令提示符。默认安装了 Docker 和 Windows Server Core 基础镜像，您可以通过运行如图 F.11
    所示的“docker images”来确认。
- en: '![F_11](../../OEBPS/Images/F_11.png)'
  id: totrans-130
  prefs: []
  type: TYPE_IMG
  zh: '![F_11](../../OEBPS/Images/F_11.png)'
- en: Figure F.11 Running “docker images” in the command prompt of the created Windows
    VM will provide output showing that the Windows Server Core base image is already
    installed.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 图 F.11 在创建的 Windows 虚拟机的命令提示符中运行“docker images”将提供输出，显示 Windows Server Core
    基础镜像已经安装。
- en: Create an application to containerize
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个用于容器化的应用程序
- en: For the app inside the Windows container, we will use an IIS Web Server. IIS
    has an image for Windows Server 2019\. Using the image as-is will allow us to
    serve the default IIS page. Let’s configure IIS to instead serve a custom page.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 对于Windows容器内的应用程序，我们将使用IIS Web服务器。IIS为Windows Server 2019提供了一个镜像。直接使用这个镜像将允许我们提供默认的IIS页面。让我们配置IIS以提供自定义页面。
- en: 'Create a folder called my-windows app with the following folder and file structure:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个名为my-windows app的文件夹，其文件夹和文件结构如下：
- en: '[PRE0]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Replace index.xhtml with the following content:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 将index.xhtml替换为以下内容：
- en: '[PRE1]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: This is the page IIS will serve.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 这是IIS将提供的页面。
- en: Build container image using Docker
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 使用Docker构建容器镜像
- en: To containerize this IIS Web Server application using Docker, you will need
    to create a file called a Dockerfile. The Dockerfile consists of several key commands
    which essentially instruct Docker on how to create a container image to run your
    application.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用Docker容器化此IIS Web服务器应用程序，你需要创建一个名为Dockerfile的文件。Dockerfile包含几个关键命令，这些命令本质上指导Docker如何创建一个容器镜像来运行你的应用程序。
- en: 'Create a file called “Dockerfile,” with no file extension, consisting of the
    following lines:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个名为“Dockerfile”的文件，没有文件扩展名，包含以下行：
- en: '[PRE2]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Build the Docker image and tag it with Google Container Registry (GCR) and your
    project id. This will be useful when we push the image to GCR later. Run the following
    command, replacing [project id] with your project id.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 构建Docker镜像，并使用Google容器注册库（GCR）和你的项目ID进行标记。这将在我们稍后推送镜像到GCR时很有用。运行以下命令，将[project
    id]替换为你的项目ID。
- en: '[PRE3]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Once the docker image build has completed, you can see it along with its IIS
    dependency by running “docker images.”
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦docker镜像构建完成，你可以通过运行“docker images”看到它及其IIS依赖项。
- en: Run Windows container
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 运行Windows容器
- en: 'Before running the container, you might need to open the port 80 from the VM
    Instance. Inside the Command Prompt inside the Windows VM, run the following:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 在运行容器之前，你可能需要从虚拟机实例中打开端口80。在Windows虚拟机内的命令提示符中运行以下命令：
- en: '[PRE4]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: You should now be ready to run the Windows container. To run the container and
    expose it on port 80, execute the following command, replacing [project id] with
    your project id.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在应该准备好运行Windows容器了。要运行容器并在端口80上公开它，请执行以下命令，将[project id]替换为你的项目ID。
- en: '[PRE5]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Confirm that the container is now running by running the command docker ps.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 通过运行命令docker ps确认容器现在正在运行。
- en: To see the web page, go to the External IP column of the Compute Engine instance
    and simply open it with HTTP in the browser. It should look similar to Figure
    F.12.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看网页，请转到计算引擎实例的外部IP列，并在浏览器中简单地使用HTTP打开它。它应该类似于图F.12。
- en: '![F_12](../../OEBPS/Images/F_12.png)'
  id: totrans-153
  prefs: []
  type: TYPE_IMG
  zh: '![F_12](../../OEBPS/Images/F_12.png)'
- en: Figure F.12 Inputting the External IP of your workload into a browser should
    open a website proclaiming “Windows containers are cool!”
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 图F.12 将你的工作负载的外部IP输入到浏览器中应该会打开一个宣称“Windows容器很酷！”的网站
- en: You are now running an IIS site inside a Windows container!
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在已经在Windows容器内运行了一个IIS网站！
- en: Note that this setup is not ideal for production. It does not survive server
    restarts or crashes. In a production system, you want to get a static IP for your
    VM and have a startup script to start the container. This will take care of server
    restarts but doesn't help so much for server crashes.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，这个设置对于生产环境来说并不理想。它不能在服务器重启或崩溃时存活。在一个生产系统中，你希望为你的虚拟机获取一个静态IP，并有一个启动脚本来启动容器。这将处理服务器重启，但对于服务器崩溃帮助不大。
- en: To make the app resilient against server crashes, you can run the container
    inside a pod managed by Kubernetes. This is what you will do in Part 2.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 要使应用程序能够抵御服务器崩溃，你可以在由Kubernetes管理的pod内运行容器。这就是第2部分你要做的事情。
- en: 'Part 2: Running a Windows Container on GKE'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 第2部分：在GKE上运行Windows容器
- en: Push the container image to Google Container Registry (GCR)
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 将容器镜像推送到Google容器注册库（GCR）
- en: To make the container image you created in Part 1 accessible in GKE, you will
    need to host it in an image repository. We will use the Google Container Registry
    for this purpose.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 要使第1部分中创建的容器镜像在GKE中可用，你需要将其托管在镜像仓库中。我们将为此目的使用Google容器注册库。
- en: 'To push a container image from a Windows VM to GCR, you need to:'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 要将容器镜像从Windows虚拟机推送到GCR，你需要：
- en: Make sure that the Container Registry API is enabled in your project.
  id: totrans-162
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确保你的项目中启用了容器注册库API。
- en: Configure Docker to point to GCR.
  id: totrans-163
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 配置Docker以指向GCR。
- en: 'First, make sure the Container Registry API is enabled by running the following
    gcloud command in the command prompt with administrator privileges in your Windows
    VM:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，确保通过在具有管理员权限的 Windows VM 命令提示符中运行以下 gcloud 命令来启用 Container Registry API：
- en: '[PRE6]'
  id: totrans-165
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Configure Docker to point to GCR by running:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 通过运行以下命令配置 Docker 以指向 GCR：
- en: '[PRE7]'
  id: totrans-167
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: When you are asked if you wish to continue, enter “Y.”
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 当你被询问是否继续时，输入“Y”。
- en: 'To push the image to GCR, run the following docker command, replacing [project
    id] with your project id:'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 要将镜像推送到 GCR，请运行以下 docker 命令，将 [项目 ID] 替换为你的项目 ID：
- en: '[PRE8]'
  id: totrans-170
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: If you go to GCR section in Cloud Console, you should be able to see the image,
    as shown in Figure F.13.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你转到云控制台的 GCR 部分，你应该能看到镜像，如图 F.13 所示。
- en: '![F_13](../../OEBPS/Images/F_13.png)'
  id: totrans-172
  prefs: []
  type: TYPE_IMG
  zh: '![F_13](../../OEBPS/Images/F_13.png)'
- en: Figure F.13 Navigating to the Images section of your container registry in Google
    cloud should display information about the iis-site-windows.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 图 F.13 在 Google Cloud 中导航到容器注册表的镜像部分应显示有关 iis-site-windows 的信息。
- en: Create a Kubernetes cluster with Windows nodes
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 创建具有 Windows 节点的 Kubernetes 集群
- en: For this exercise, you will create a zonal GKE cluster. This cluster will only
    have nodes within a single zone, as opposed to a regional GKE cluster which has
    multiple control planes and nodes in multiple zones.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个练习，你将创建一个区域 GKE 集群。这个集群将只包含单个区域内的节点，与具有多个控制平面和多个区域节点的区域 GKE 集群不同。
- en: 'Before creating a GKE cluster, make sure the project id is set to your project
    and a compute/zone is set the zone you want (replace [project id] and [preferred
    zone] with your preferred zone):'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建 GKE 集群之前，请确保项目 ID 设置为你的项目，并设置 compute/zone 为你想要的区域（将 [项目 ID] 和 [首选区域] 替换为你首选的区域）：
- en: '[PRE9]'
  id: totrans-177
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Creating a Kubernetes cluster in GKE with Windows nodes happens in 2 steps:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 在 GKE 中使用 Windows 节点创建 Kubernetes 集群分为 2 步：
- en: Create a GKE cluster with IP alias and 1 Linux node. At least 1 Linux node is
    needed before Windows nodes can be added to the cluster.
  id: totrans-179
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建具有 IP 别名和 1 个 Linux 节点的 GKE 集群。在将 Windows 节点添加到集群之前，至少需要 1 个 Linux 节点。
- en: Add a Windows node pool to the GKE cluster.
  id: totrans-180
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 向 GKE 集群添加 Windows 节点池。
- en: Use the following command to create a GKE cluster. Replace [cluster name] with
    your preferred name for the cluster.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下命令创建 GKE 集群。将 [集群名称] 替换为你想要的集群名称。
- en: '[PRE10]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Once your GKE cluster is up, you can add a node pool consisting of Windows
    nodes to it:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你的 GKE 集群启动，你可以向其中添加一个包含 Windows 节点的节点池：
- en: '[PRE11]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Notice that we're disabling automatic node upgrades. Windows container versions
    need to be compatible with the node OS version. To avoid unexpected workload disruption,
    it is recommended that users disable node autoupgrade for Windows node pools.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，我们正在禁用自动节点升级。Windows 容器版本需要与节点操作系统版本兼容。为了避免意外的工作负载中断，建议用户禁用 Windows 节点池的节点自动升级。
- en: For Windows Server containers in GKE, you're already licensed for underlying
    Windows host VMs – containers need no additional licensing.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 GKE 中的 Windows Server 容器，你已为底层的 Windows 主机 VM 获得了许可 - 容器不需要额外的许可。
- en: Configure kubectl for your GKE cluster
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 为你的 GKE 集群配置 kubectl
- en: 'You will use the Kubernetes command line tool, kubectl, to interact with your
    cluster. To configure kubectl, run the command:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 你将使用 Kubernetes 命令行工具 kubectl 与你的集群交互。要配置 kubectl，请运行以下命令：
- en: '[PRE12]'
  id: totrans-189
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Before using the cluster, wait for several seconds until windows.config.common-webhooks.networking.gke.io
    is created. This webhook adds scheduling tolerations to Pods created with the
    kubernetes.io/os: windows (or beta.kubernetes.io/os: windows) node selector to
    ensure they are allowed to run on Windows Server nodes. It also validates the
    Pod to ensure that it only uses features supported on Windows.'
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: '在使用集群之前，等待几秒钟，直到 windows.config.common-webhooks.networking.gke.io 创建。此 webhook
    为使用 kubernetes.io/os: windows（或 beta.kubernetes.io/os: windows）节点选择器创建的 Pods 添加调度容忍度，以确保它们可以在
    Windows Server 节点上运行。它还验证 Pod，以确保它只使用在 Windows 上受支持的功能。'
- en: 'You can confirm that the webhooks were created by outputting webhook configuration
    information using the following command:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过使用以下命令输出 webhook 配置信息来确认已创建 webhook：
- en: '[PRE13]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Run your Windows container as a pod in GKE
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 在 GKE 中以 pod 的形式运行你的 Windows 容器
- en: Kubernetes takes a declarative approach to running containers. A user defines
    their desired state using yaml files, which Kubernetes uses to create and maintain
    objects to match the desired state.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes 对运行容器采用声明式方法。用户使用 yaml 文件定义他们希望的状态，Kubernetes 使用这些文件来创建和维护对象，以匹配期望状态。
- en: To run your IIS container as a pod in Kubernetes, you will need to create a
    file called iis-site-windows.yaml consisting of the following lines. Be sure to
    replace [project id] with your project id.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 要将您的 IIS 容器作为 Kubernetes 中的 pod 运行，您需要创建一个名为 iis-site-windows.yaml 的文件，包含以下行。请确保将[项目
    ID]替换为您的项目 ID。
- en: iis-site-windows.yaml
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: iis-site-windows.yaml
- en: '[PRE14]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Note that this yaml will create two replica pods running the image you published
    earlier to GCR. This yaml also ensures that your pods will be run on Windows nodes
    using the nodeSelector tag.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，此 yaml 将创建两个运行您之前发布到 GCR 的镜像的副本 pod。此 yaml 还确保您的 pod 将在带有 nodeSelector 标签的
    Windows 节点上运行。
- en: 'To create the deployment defined in the iis-site-windows.yaml file, run:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 要创建 iis-site-windows.yaml 文件中定义的部署，请运行：
- en: '[PRE15]'
  id: totrans-200
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'After a few minutes, you should see the deployment created and pods running.
    Run the following command to confirm:'
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 几分钟后，您应该看到创建的部署和正在运行的 pod。运行以下命令以确认：
- en: '[PRE16]'
  id: totrans-202
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: You should see output similar to Figure F.14.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该看到类似于图 F.14 的输出。
- en: '![F_14](../../OEBPS/Images/F_14.png)'
  id: totrans-204
  prefs: []
  type: TYPE_IMG
  zh: '![F_14](../../OEBPS/Images/F_14.png)'
- en: Figure F.14 The “kubectl get” command is used to display high-level information
    about Kubernetes objects. In this case, deployments and pods in the default namespace
    are shown.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 图 F.14 “kubectl get”命令用于显示 Kubernetes 对象的高级信息。在本例中，默认命名空间中的部署和 pod 被显示。
- en: Create a Kubernetes Service
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 创建 Kubernetes 服务
- en: Your application is now running in Kubernetes. To confirm the IIS site is up,
    you will need to create a Kubernetes service to make the created pods accessible
    to the outside world.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 您的应用程序现在正在 Kubernetes 中运行。为了确认 IIS 网站已启动，您需要创建一个 Kubernetes 服务，以便外部世界可以访问创建的
    pod。
- en: Run the following kubectl command to create a service of type LoadBalancer which
    can be used to reach your IIS Web Server.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 运行以下 kubectl 命令以创建一个类型为 LoadBalancer 的服务，可以用来访问您的 IIS Web 服务器。
- en: '[PRE17]'
  id: totrans-209
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'You can confirm the service is up by running:'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过运行以下命令来确认服务是否启动：
- en: '[PRE18]'
  id: totrans-211
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Note that it will take a few minutes for the service to be up and running. Once
    the EXTERNAL-IP section of the “kubectl get service” command’s output has been
    populated, you can visit that IP to see the page IIS is serving. The website should
    look the same as before despite being reached on a different IP, as shown in Figure
    F.15.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，服务启动并运行可能需要几分钟。一旦“kubectl get service”命令输出的“EXTERNAL-IP”部分被填充，您就可以访问该 IP
    来查看 IIS 提供的页面。尽管是通过不同的 IP 访问，但网站应该与之前相同，如图 F.15 所示。
- en: '![F_15](../../OEBPS/Images/F_15.png)'
  id: totrans-213
  prefs: []
  type: TYPE_IMG
  zh: '![F_15](../../OEBPS/Images/F_15.png)'
- en: Figure F.15 A webpage proclaiming “Windows containers are cool!” should be displayed
    when you enter the External IP of your LoadBalancer type Kubernetes service.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 图 F.15 当您输入负载均衡器类型 Kubernetes 服务的外部 IP 时，应该显示一个宣称“Windows 容器很酷！”的网页。
- en: This web page should be the same as the one you saw in part 1\. The big difference
    now is that Kubernetes is managing the application. If something goes wrong with
    the pod running your application, or with the node on which the pod is running,
    Kubernetes will recreate and reschedule the pod for us. This is great for resiliency.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 当您进入负载均衡器类型 Kubernetes 服务的外部 IP 时，应该显示与第 1 部分中看到的相同的网页。现在最大的不同之处在于 Kubernetes
    正在管理应用程序。如果运行应用程序的 pod 或 pod 所在的节点出现错误，Kubernetes 将为我们重新创建和重新调度 pod。这对于弹性来说非常好。
- en: Clean Up
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 清理
- en: Once you have finished exploring your containerized application running GKE,
    it’s a good idea to delete the cluster to avoid incurring additional costs from
    idle resources. If you’re done with the resources used in this tutorial, follow
    these steps to delete them.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦您完成了对在 GKE 上运行的容器化应用的探索，删除集群是一个好主意，以避免因闲置资源而产生额外费用。如果您完成了本教程中使用的资源，请按照以下步骤删除它们。
- en: 'To clean up your environment, first delete the service and the deployment.
    This will also automatically delete the external load balancer that was created
    for that service:'
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 要清理您的环境，首先删除服务和部署。这将自动删除为该服务创建的外部负载均衡器：
- en: '[PRE19]'
  id: totrans-219
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Then, delete your GKE cluster:'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，删除您的 GKE 集群：
- en: '[PRE20]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: You should also delete the VM you used to create your Windows container.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 您还应该删除用于创建 Windows 容器的虚拟机。
- en: 'This can be done either in the console or via command line. To delete the VM
    via the Google Cloud Console, go to Compute Engine VM instances page and select
    Delete from the menu for the VM you want to delete, as shown in Figure F.16:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 这可以在控制台或通过命令行完成。要通过 Google Cloud Console 删除虚拟机，请转到计算引擎虚拟机实例页面，并选择您要删除的虚拟机的“删除”菜单，如图
    F.16 所示：
- en: '![F_16](../../OEBPS/Images/F_16.png)'
  id: totrans-224
  prefs: []
  type: TYPE_IMG
  zh: '![F_16](../../OEBPS/Images/F_16.png)'
- en: Figure F.16 Clicking the dots at the rightmost end of the line of VM information
    should give you the option to delete that VM via the Google Cloud console.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 图F.16 点击VM信息行最右侧的点，应该会提供通过Google Cloud控制台删除该VM的选项。
- en: Running Windows Containers on Anthos On-Premises
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 在Anthos On-Premises上运行Windows容器
- en: The user experience running Windows containers in either Anthos or GKE is fairly
    consistent across the two. However, some additional setup and installation requirements
    are specific to Anthos clusters in on-prem environments, and this section highlights
    those requirements. A general Anthos architecture on-prem is shown in Figure F.17.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 在Anthos或GKE上运行Windows容器的用户体验在这两个平台上相当一致。然而，一些额外的设置和安装要求是针对本地环境中Anthos集群特定的，本节将突出这些要求。本地环境中的一般Anthos架构如图F.17所示。
- en: '![F_17](../../OEBPS/Images/F_17.png)'
  id: totrans-228
  prefs: []
  type: TYPE_IMG
  zh: '![F_17](../../OEBPS/Images/F_17.png)'
- en: Figure F.17 Illustration of Windows Server and Linux containers running side-by-side
    in the same Anthos on-prem VMware cluster
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 图F.17 Windows Server和Linux容器在同一Anthos本地VMware集群中并行运行的示意图
- en: The differences for on-prem environments originate primarily due to two reasons.
    First, Anthos users must procure their licenses (BYOL) in the On-Prem environment.
    In a BYOL model, Google cannot ship the Windows Server OS image with the Anthos
    bits.Consequently, users have to take the additional steps to download the OS
    ISO image from Microsoft and create a VM template for the node-pool creation.
    Also, when Microsoft releases security patches for the OS image, Google will test
    and qualify the latest security patch version and publish the results. Users will
    need to build a new VM template with the security patch and perform a rolling
    update on their Windows node pools.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 在本地环境中，差异主要源于两个原因。首先，Anthos用户必须在本地环境中获取他们的许可证（BYOL）。在BYOL模型中，Google无法将Windows
    Server操作系统镜像与Anthos组件一起发货。因此，用户需要额外步骤从Microsoft下载OS ISO镜像，并为节点池创建创建VM模板。此外，当Microsoft为操作系统镜像发布安全补丁时，Google将测试和验证最新的安全补丁版本，并发布结果。用户需要使用带有安全补丁的新VM模板，并在他们的Windows节点池上执行滚动更新。
- en: Second, In the Anthos On VMware environment, admin clusters and the underlying
    VMware constructs come into play, and hence it is essential to ensure those prerequisites
    are met. Windows nodes are supported running as user cluster worker nodes only,
    the control plane node and admin cluster nodes continue to be Linux-based.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 第二，在Anthos On VMware环境中，管理员集群和底层VMware结构发挥作用，因此确保满足这些先决条件至关重要。Windows节点仅支持作为用户集群工作节点运行，控制平面节点和管理集群节点继续基于Linux。
- en: 'Specifically, in addition to the prerequisites listed above, users need to
    ensure the following:'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 具体来说，除了上述先决条件外，用户还需要确保以下事项：
- en: An admin cluster is in place before you can create a Windows node pool, because
    a Windows node pool is only supported in the user cluster.
  id: totrans-233
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在您创建Windows节点池之前，必须有一个管理员集群，因为Windows节点池仅支持在用户集群中。
- en: The vSphere environment is vSphere 6.7, Update 3 or later.
  id: totrans-234
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: vSphere环境是vSphere 6.7，更新3或更高版本。
- en: A user cluster with Windows node pools must have the enabledataplanev2 field
    set to true in the user cluster configuration file. This enables Dataplane V2
    on the Linux nodes in that cluster. Additionally, If you want Windows Dataplane
    V2 to be enabled for the Windows node pools in the user cluster, the user cluster
    configuration file must have the enableWindowsDataplaneV2 field set to true.
  id: totrans-235
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 具有Windows节点池的用户集群必须在用户集群配置文件中将enabledataplanev2字段设置为true。这将在该集群的Linux节点上启用Dataplane
    V2。另外，如果您希望Windows节点池中的Windows Dataplane V2被启用，用户集群配置文件中必须将enableWindowsDataplaneV2字段设置为true。
- en: 'High-level steps for adding Windows node pool to an Anthos On-Prem cluster
    include:'
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 将Windows节点池添加到Anthos On-Prem集群的高级步骤包括：
- en: Create the Windows VM Template for Anthos clusters on VMware.
  id: totrans-237
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在VMware上为Anthos集群创建Windows VM模板。
- en: Upload Windows container images to a private registry if using a private registry.
  id: totrans-238
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果使用私有注册表，将Windows容器镜像上传到私有注册表。
- en: If your cluster is behind a proxy server, allowlist URLs to your proxy server.
  id: totrans-239
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果您的集群位于代理服务器后面，允许代理服务器URL列表。
- en: Add a Windows node pool to the user cluster configuration file.
  id: totrans-240
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将Windows节点池添加到用户集群配置文件中。
- en: Finally, create the Windows node pool.
  id: totrans-241
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，创建Windows节点池。
- en: Once this is complete, you can deploy your Windows containers just as you would
    deploy to GKE. For details, check out the step-by-step instructions in the Google
    Cloud documentation page for "User guide for Windows Server OS node pools".
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦完成这些，您就可以像部署到 GKE 一样部署您的 Windows 容器。有关详细信息，请参阅 Google Cloud 文档页面“Windows Server
    OS 节点池用户指南”中的分步说明。
- en: F.4.2 Unique storage, networking, and identity considerations for Anthos and
    Google Kubernetes Engine (GKE) Windows environments
  id: totrans-243
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.4.2 Anthos 和 Google Kubernetes Engine (GKE) Windows 环境的独特存储、网络和身份考虑因素
- en: Storage and networking are key to running workloads in distributed computing
    environments such as Kubernetes clusters. Kubernetes is well known for its capabilities
    in the realm of stateless workloads, but it can be a great home for stateful workloads
    too. Networking containers together both within a single machine and across a
    cluster of machines, as Kubernetes does, involves layers of abstraction from hardware
    through various levels of software. This section explores unique considerations
    for storage and networking common to both Anthos and GKE Windows environments.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 存储和网络对于在分布式计算环境中运行工作负载（如 Kubernetes 集群）至关重要。Kubernetes 以其在无状态工作负载领域的功能而闻名，但它也可以成为有状态工作负载的绝佳家园。Kubernetes
    通过将容器连接在一起，无论是在单个机器内部还是在机器集群之间，涉及从硬件到各种软件级别的抽象层。本节探讨了 Anthos 和 GKE Windows 环境共有的存储和网络独特考虑因素。
- en: F.4.3 Storage
  id: totrans-245
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.4.3 存储
- en: In a nutshell, the way Kubernetes manages storage in Windows is similar to Linux.
    The volume plugins including in-tree and CSI (mentioned in appendix Anthos, Data
    and Analytics ) provide an abstraction layer for storage vendors to support provisioning,
    attaching, and mounting of storage for containers. End-users interact with Persistent
    Volumes (PVs), Permanent Volumes Claims (PVCs), and StorageClass objects, the
    same way as Linux.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 简而言之，Kubernetes 在 Windows 中管理存储的方式与 Linux 类似。包括树内和 CSI（在附录 Anthos、数据和 Analytics
    中提及）的卷插件为存储供应商提供了一个抽象层，以支持为容器提供、附加和挂载存储。最终用户以与 Linux 相同的方式与持久卷（PV）、持久卷声明（PVC）和
    StorageClass 对象交互。
- en: Windows Storage Limitations
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 存储限制
- en: However, Windows storage support has some limitations compared to Linux at the
    time of writing. Some are listed in the following. (Check the [documentation](https://kubernetes.io/docs/setup/production-environment/windows/intro-windows-in-kubernetes/#compatibility-storage)
    here to see more details.)
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，与 Linux 相比，Windows 存储支持在撰写本文时有一些限制。以下列出了一些。（有关更多详细信息，请参阅[文档](https://kubernetes.io/docs/setup/production-environment/windows/intro-windows-in-kubernetes/#compatibility-storage)）
- en: Docker runtime can only support volume mounts targeting a directory, not a file.
    However, the containerd runtime no longer has this limitation and is strongly
    recommended instead of the Docker runtime.
  id: totrans-249
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Docker 运行时只能支持针对目录的卷挂载，而不是文件。然而，containerd 运行时不再有此限制，并且强烈建议使用 containerd 运行时而不是
    Docker 运行时。
- en: Windows storage currently does NOT support the following
  id: totrans-250
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows 存储目前不支持以下功能
- en: Memory as the storage medium for ephemeral storage. As a result, if you define
    an emptyDir volume, you cannot set its emptyDir.medium to memory
  id: totrans-251
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 内存作为临时存储的存储介质。因此，如果您定义了一个 emptyDir 卷，您不能将其 emptyDir.medium 设置为内存
- en: raw block volume (Windows cannot attach raw block devices to pods.)
  id: totrans-252
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 原始块卷（Windows 无法将原始块设备附加到 pods。）
- en: mountPropagation with Bidirectional for volume mounts
  id: totrans-253
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 支持双向传播的卷挂载
- en: Read-only volumes are supported for Windows but not read-only filesystems.
  id: totrans-254
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于 Windows，支持只读卷，但不支持只读文件系统。
- en: User-masks and permissions are not supported for the volume. Permissions are
    instead resolved at the container.
  id: totrans-255
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于卷，不支持用户掩码和权限。权限而是在容器中解析。
- en: Windows CSI support
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: Windows CSI 支持
- en: In the past, storage providers would have to create plugins to enable their
    storage through Kubernetes. However, storage plugins were treated as “in-tree”
    components, meaning they had to become part of the core Kubernetes code to be
    used. This model was problematic as it opened up Kubernetes’ core code to bloat
    and made the process of creating and maintaining plugins challenging for storage
    providers.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: 在过去，存储供应商必须创建插件才能通过 Kubernetes 启用他们的存储。然而，存储插件被视为“树内”组件，这意味着它们必须成为核心 Kubernetes
    代码的一部分才能使用。这种模式存在问题，因为它使 Kubernetes 的核心代码变得臃肿，并使存储供应商创建和维护插件的过程变得具有挑战性。
- en: Due to its flaws and limitations, the plugin system was replaced in Kubernetes
    version 1.13 when the Container Storage Interface (CSI) became Generally Available
    (GA). Since then, storage providers have created CSI-compatible plugins which
    allow their users to consume storage via Kubernetes.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 由于其缺陷和限制，插件系统在 Kubernetes 版本 1.13 时被替换，当时容器存储接口（CSI）成为通用可用（GA）。从那时起，存储提供商创建了与
    CSI 兼容的插件，允许他们的用户通过 Kubernetes 消费存储。
- en: Windows support in Kubernetes was introduced in Kubernetes version 1.19\. However,
    the initial versions did not support HostProcess containers (the equivalent of
    Privileged containers for Linux), which the CSI volume plugin requires to deploy
    as containers. HostProcess container support is currently available in Alpha as
    of Kubernetes 1.22, and the Beta is slated to launch with Kubernetes 1.23.
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes 中的 Windows 支持是在 Kubernetes 版本 1.19 中引入的。然而，最初的版本不支持 HostProcess 容器（Linux
    中特权容器的等效物），这是 CSI 卷插件部署为容器所必需的。截至 Kubernetes 1.22，HostProcess 容器支持目前处于 Alpha 阶段，Beta
    版本计划与 Kubernetes 1.23 一起发布。
- en: An interim solution is to use the Open Source Software (OSS) project CSI-Proxy.
    The CSI-proxy provides a mechanism to deploy the node plugins as unprivileged
    pods and use the proxy to perform privileged storage operations on the node. The
    CSI Proxy API includes the Disk, Filesystem, SMB, and Volume API groups, which
    graduated to v1 in 2021\. It also has iSCSI and system APIs, which are still Alpha
    at the time of writing.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 一个临时的解决方案是使用开源软件（OSS）项目 CSI-Proxy。CSI-proxy 提供了一种将节点插件作为非特权 pod 部署的机制，并使用代理在节点上执行特权存储操作。CSI
    Proxy API 包括磁盘、文件系统、SMB 和卷 API 组，这些在 2021 年毕业到 v1。它还包括 iSCSI 和系统 API，这些在撰写本文时仍处于
    Alpha 阶段。
- en: Anthos aims to provide a consistent experience across a variety of environments.
    However, not all environments always move forward at the same rate. Be sure to
    check the Anthos documentation ([https://cloud.google.com/anthos/docs/concepts/overview](https://cloud.google.com/anthos/docs/concepts/overview))
    for the types of storage drivers available in each environment.
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: Anthos 旨在在各种环境中提供一致的经验。然而，并非所有环境都以相同的速度前进。请务必检查 Anthos 文档（[https://cloud.google.com/anthos/docs/concepts/overview](https://cloud.google.com/anthos/docs/concepts/overview)），以了解每个环境中可用的存储驱动程序类型。
- en: Windows Google Cloud Storage Drivers in Action
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: Windows Google Cloud 存储驱动程序的实际应用
- en: The following shows an example of using StorageClass, PV/PVC and pod to access
    persistent storage in Anthos on Google Cloud.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例展示了在 Google Cloud 的 Anthos 中使用 StorageClass、PV/PVC 和 pod 访问持久存储的示例。
- en: '[PRE21]'
  id: totrans-264
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Data sharing between Linux and Windows using SMB
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 SMB 在 Linux 和 Windows 之间共享数据
- en: 'There are several scenarios where data sharing is required between pods running
    on Linux nodes and those running on Windows nodes. The following examples illustrate
    scenarios that may require data sharing:'
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Linux 节点上运行的 pod 和在 Windows 节点上运行的 pod 之间需要共享数据的场景有几个。以下示例说明了可能需要数据共享的场景：
- en: Suppose an app is being migrated from the .NET framework on Windows to .NET
    core on Linux, some parts are migrated, and other parts of the app are still using
    Windows containers.
  id: totrans-267
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 假设一个应用程序正在从 Windows 上的 .NET 框架迁移到 Linux 上的 .NET core，一些部分已经迁移，而应用程序的其他部分仍在使用
    Windows 容器。
- en: Logs written by Windows pods need to be captured and shipped to a common search
    and analytics engine, and the log shipper is written in Linux.
  id: totrans-268
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 需要捕获由 Windows pod 编写的日志并将其发送到公共搜索和分析引擎，并且日志传输程序是用 Linux 编写的。
- en: Suppose a legacy .NET app running using Windows Server Containers is getting
    new features, and the new features are developed as separate, new microservices
    running on Linux using .NET Core. And let us say old and new parts of the app
    work against the same database.
  id: totrans-269
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 假设一个使用 Windows Server 容器运行的遗留 .NET 应用正在获得新功能，这些新功能作为在 Linux 上使用 .NET Core 运行的独立、新的微服务进行开发。让我们假设应用程序的旧部分和新部分针对同一个数据库进行操作。
- en: You can use the Server Message Block (SMB) Protocol in such scenarios. SMB is
    one of the most popular network file-sharing protocols for Windows users. The
    CSI Windows community has launched an OSS SMB CSI driver, and it supports both
    Linux and Windows clusters. We recommend using this driver to access SMB volumes
    either on a self-managed samba server or cloud volume service (CVS) in GKE. You
    can check the Google Cloud documentation which contains an example of how to use
    the open source SMB CSI Driver for Kubernetes to access a NetApp Cloud Volumes
    Service SMB volume on a Google Kubernetes Engine (GKE) cluster with Windows server
    nodes.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种场景下，您可以使用服务器消息块（SMB）协议。SMB 是 Windows 用户最受欢迎的网络文件共享协议之一。CSI Windows 社区已启动一个开源
    SMB CSI 驱动程序，并支持 Linux 和 Windows 集群。我们建议使用此驱动程序访问 SMB 卷，无论是自管理的 samba 服务器还是云卷服务（CVS）在
    GKE 上。您可以检查 Google Cloud 文档，其中包含如何使用开源 SMB CSI 驱动程序访问 Google Kubernetes Engine（GKE）集群上
    Windows 服务器节点的 NetApp Cloud Volumes Service SMB 卷的示例。
- en: F.4.4 Networking
  id: totrans-271
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.4.4 网络
- en: 'Like Linux networking, Windows networking relies on Container Network Interface
    (CNI) to connect Kubernetes pods into the cluster networking. There are two modes
    of Windows network implementation for GKE and Anthos:'
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 与 Linux 网络一样，Windows 网络依赖于容器网络接口（CNI）将 Kubernetes pods 连接到集群网络。对于 GKE 和 Anthos，Windows
    网络实现有两种模式：
- en: The traditional Dataplane for Windows, which is based on win-bridge (L2bridge
    networking mode)
  id: totrans-273
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 基于 win-bridge（L2bridge 网络模式）的传统 Windows Dataplane
- en: The newer Dataplane V2 for Windows, which is based on Open vSwitch (OVS) and
    Antrea.
  id: totrans-274
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新的基于 Open vSwitch（OVS）和 Antrea 的 Windows Dataplane V2
- en: Traditional Dataplane for Windows
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 传统 Windows Dataplane
- en: In GKE and Anthos on-prem (on VMware), win-bridge network mode is used to connect
    pods to the underlying network - it leverages the Hyper-V virtual switch (vSwitch).
    There is a small difference between GKE and Anthos on-prem (VMware) for cross-node
    connectivity.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 在 GKE 和 Anthos on-prem（在 VMware 上），使用 win-bridge 网络模式将 pods 连接到底层网络 - 它利用 Hyper-V
    虚拟交换机（vSwitch）。GKE 和 Anthos on-prem（VMware）在跨节点连接性方面存在细微差异。
- en: In GKE's VPC native cluster, pods use real VPC IP addresses in the secondary
    IP address range, so pod IPs are native routable inside the VPC. Pods across different
    nodes are natively supported.
  id: totrans-277
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 GKE 的 VPC 原生集群中，pods 使用辅助 IP 地址范围内的真实 VPC IP 地址，因此 pod IP 在 VPC 内是原生可路由的。跨不同节点的
    pods 是原生支持的。
- en: In Anthos on-prem (on VMware), there is no VPC support. Flannel is used to exchange
    routes between Windows nodes. Dataplane v2 on Linux nodes is required to exchange
    routes between Linux and Windows nodes.
  id: totrans-278
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 Anthos on-prem（在 VMware 上），没有 VPC 支持。Flannel 用于在 Windows 节点之间交换路由。Linux 节点上的
    Dataplane v2 用于在 Linux 和 Windows 节点之间交换路由。
- en: GKE/Anthos Dataplane V2 for Windows
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: GKE/Anthos Windows Dataplane V2
- en: The newer Dataplane V2 is a more programmable Dataplane that is optimized for
    Kubernetes networking and can perform Kubernetes-aware packet manipulations without
    sacrificing performance. While the Dataplane V2 for Linux is based on eBPF (Extended
    Berkeley Packet Filter) and Cilium, the Windows solution is based on Open vSwitch
    and Antrea (an OSS project that implements CNI).
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: 更新的 Dataplane V2 是一个更可编程的 Dataplane，针对 Kubernetes 网络进行了优化，可以在不牺牲性能的情况下执行 Kubernetes
    意识的包操作。虽然 Linux 的 Dataplane V2 基于 eBPF（扩展伯克利包过滤器）和 Cilium，但 Windows 解决方案基于 Open
    vSwitch 和 Antrea（一个实现 CNI 的开源项目）。
- en: Dataplane V2 helps overcome some of the limitations of the traditional implementation
    and enables features such as network policy. It adds new components to the cluster
    - antrea-agent and antrea-controller. While the Antrea-agent runs on every node
    and programs Open vSwitch datapath, the Antrea-controller runs one instance per
    cluster. Antrea-controller watches the Kubernetes API server for updates and exposes
    API for antrea-agent to query per node policy rules.
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: Dataplane V2 有助于克服传统实现的一些限制，并启用网络策略等特性。它向集群添加了新组件 - antrea-agent 和 antrea-controller。虽然
    Antrea-agent 在每个节点上运行并编程 Open vSwitch 数据路径，但 Antrea-controller 在每个集群上运行一个实例。Antrea-controller
    监视 Kubernetes API 服务器以获取更新，并为 antrea-agent 提供查询每个节点策略规则的 API。
- en: GKE Dataplane V2 provides a consistent user experience for networking across
    all Anthos and GKE environments, provides real-time visibility of network activity,
    and has a simpler architecture that makes troubleshooting easier. Furthermore,
    most new features will only be supported in the Dataplane V2\. Hence, the use
    of Dataplane V2 for your container networking is strongly recommended. See the
    chapter on Networking environment for more details about networking.
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: GKE Dataplane V2为所有Anthos和GKE环境提供一致的联网用户体验，提供网络活动的实时可见性，并具有更简单的架构，使得故障排除更加容易。此外，大多数新功能将仅支持Dataplane
    V2。因此，强烈建议使用Dataplane V2进行容器联网。有关联网的更多详细信息，请参阅联网环境章节。
- en: 'To create a new cluster with GKE Dataplane V2, use the following command:'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用GKE Dataplane V2创建新的集群，请使用以下命令：
- en: '[PRE22]'
  id: totrans-284
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: F.4.5 Active Directory Integration
  id: totrans-285
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: F.4.5 活动目录集成
- en: Active Directory(AD) integration is the most frequently used mechanism for authentication
    and authorization in Windows-based networks. Active Directory keeps track of objects
    in the network in a data store and makes it easy for authorized users to discover
    and access the resources. Windows containers cannot be domain-joined directly.
    Nonetheless, you can configure and use a group Managed Service Account (gMSA)
    for applications running in Windows containers to utilize AD functionality. Anthos
    and GKE support group Managed Service Accounts – you can configure gMSA credential
    specs as custom resources in your cluster. Windows pods can then be configured
    to use a gMSA to access and interact with other resources and services. Check
    the documentation ([https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows#using_gmsa](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows#using_gmsa)[)](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows#using_gmsa)
    and [tutorial (https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-aspnet-with-windows-authentication-in-gke-windows-containers)](https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-aspnet-with-windows-authentication-in-gke-windows-containers)
    for more details.
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
  zh: 活动目录（AD）集成是Windows网络中最常用的身份验证和授权机制。活动目录在数据存储中跟踪网络中的对象，并使授权用户能够轻松发现和访问资源。Windows容器不能直接加入域。尽管如此，您可以为在Windows容器中运行的应用程序配置和使用组托管服务帐户（gMSA）来利用AD功能。Anthos和GKE支持组托管服务帐户——您可以在集群中配置gMSA凭证规范作为自定义资源。然后，Windows
    Pod可以配置为使用gMSA来访问和交互其他资源和服务。有关更多详细信息，请参阅文档（[https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows#using_gmsa](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows#using_gmsa)）和[教程](https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-aspnet-with-windows-authentication-in-gke-windows-containers)。
- en: F.5 Summary
  id: totrans-287
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: F.5 摘要
- en: Windows containers, as with Linux containers, come with several benefits - better
    agility, improved scalability and reliability, cost savings achieved through bin
    packing, to name a few.
  id: totrans-288
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 与Linux容器一样，Windows容器具有多项好处——更好的灵活性、改进的可伸缩性和可靠性，通过装箱节省成本等。
- en: There are two modes of runtime isolation for Windows containers - the process
    isolation and the Hyper-V isolation. Process isolation mode is more similar to
    native Linux containers, while the Hyper-V isolation provides more security and
    isolation and is better suited for hostile multi-tenancy scenarios.
  id: totrans-289
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows容器有两种运行时隔离模式——进程隔离和Hyper-V隔离。进程隔离模式更类似于原生Linux容器，而Hyper-V隔离提供了更多的安全性和隔离性，更适合敌对的多租户场景。
- en: There are two popular options for modernizing an existing .NET Framework application
    – the application can be containerized into a Windows Server container and run
    on a Windows node, or the application can be ported to .NET Core/.NET 5+ and run
    as a Linux container on a Linux node.
  id: totrans-290
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 现代化现有.NET Framework应用程序有两种流行的选择——应用程序可以被容器化到Windows Server容器中并在Windows节点上运行，或者应用程序可以被移植到.NET
    Core/.NET 5+并在Linux节点上作为Linux容器运行。
- en: Anthos/GKE allows you to run your Linux and Windows containers side-by-side
    in the same cluster, resulting in consistent experience and operational efficiency,
    among several other benefits.
  id: totrans-291
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Anthos/GKE允许您在同一集群中并行运行Linux和Windows容器，从而实现一致的用户体验和操作效率，以及其他多项好处。
- en: For Windows Server containers deployed in process isolation mode, the operating
    system version of the container's base image must match the host's version.
  id: totrans-292
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于以进程隔离模式部署的 Windows Server 容器，容器的基础镜像操作系统版本必须与主机版本匹配。
- en: The experience of running Windows containers in different Anthos environments
    is pretty consistent. However, there are some differences to consider, such as
    the OS licensing model for the Windows nodes.
  id: totrans-293
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在不同的 Anthos 环境中运行 Windows 容器的体验相当一致。然而，也有一些需要考虑的差异，例如 Windows 节点的操作系统许可模式。
- en: The way Kubernetes manages storage and networking in Windows is similar to Linux.
    The volume plugins (in-tree and CSI) provide an abstraction layer, and end-users
    interact with Persistent Volumes (PVs), Permanent Volumes Claims (PVCs), and StorageClass
    objects, the same way as Linux. The traditional Dataplane for Windows is based
    on win-bridge, and the newer Dataplane V2 for Windows is based on Open vSwitch
    (OVS) and Antrea.
  id: totrans-294
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Kubernetes 在 Windows 中管理存储和网络的方式与 Linux 类似。卷插件（树内和 CSI）提供了一个抽象层，最终用户以与 Linux
    相同的方式与持久卷（PVs）、持久卷声明（PVCs）和 StorageClass 对象交互。Windows 的传统数据平面基于 win-bridge，而较新的
    Windows 数据平面 V2 基于 Open vSwitch (OVS) 和 Antrea。
- en: Active Directory (AD) integration is the most common approach to authentication
    and authorization for Windows-based Networks. AD gMSAs are supported by Anthos
    and GKE.
  id: totrans-295
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Active Directory (AD) 集成是 Windows 基础网络中最常见的身份验证和授权方法。Anthos 和 GKE 支持基于 AD 的
    gMSA。
