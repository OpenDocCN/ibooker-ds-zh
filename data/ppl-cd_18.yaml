- en: 14 Jenkins administration and best practices
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 14 Jenkins 管理和最佳实践
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Sharing common code and steps across CI/CD pipelines
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 CI/CD 管道中共享通用代码和步骤
- en: Granting job permissions for a user
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 授予用户作业权限
- en: Using GitHub for authentication information to secure a Jenkins instance
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 GitHub 进行认证信息以保护 Jenkins 实例
- en: Backing up and restoring Jenkins plugins and jobs
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 备份和恢复 Jenkins 插件和作业
- en: Using Jenkins as a scheduler for cron jobs
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将 Jenkins 用作 cron 作业的调度器
- en: Migrating build jobs to a new Jenkins instance
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将构建作业迁移到新的 Jenkins 实例
- en: Chapter 13 covered how to monitor a Jenkins cluster, and how to configure alerts
    and correlate Jenkins logs and metrics to identify issues and avoid downtime.
    In this chapter, you will learn how to enforce security on Jenkins by setting
    up granular access with role-based access control (RBAC) for logged-in users and
    how to add an extra security layer by using the GitHub authentication mechanism.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 第 13 章介绍了如何监控 Jenkins 集群，以及如何配置警报并将 Jenkins 日志和指标关联起来以识别问题和避免停机。在本章中，您将学习如何通过为登录用户设置基于角色的访问控制
    (RBAC) 以实现细粒度访问来加强 Jenkins 的安全性，以及如何通过使用 GitHub 认证机制添加额外的安全层。
- en: We also will discuss a few tips and tricks that you might find useful when maintaining
    a Jenkins instance. We will look at things like how to back up, restore, and archive
    build jobs or migrate them from one server to another.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还将讨论一些在维护 Jenkins 实例时可能觉得有用的技巧和窍门。我们将探讨如何备份、恢复和存档构建作业，或者将它们从一个服务器迁移到另一个服务器。
- en: 14.1 Exploring Jenkins security and RBAC authorization
  id: totrans-10
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.1 探索 Jenkins 安全性和 RBAC 授权
- en: The current configuration of Jenkins allows not-logged users to have read access,
    and logged users to access almost everything. To override this default behavior,
    head to the Configure Global Security section from Manage Jenkins (figure 14.1).
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 当前 Jenkins 的配置允许未登录用户具有读取访问权限，而登录用户几乎可以访问一切。要覆盖此默认行为，请从管理 Jenkins（图 14.1）转到配置全局安全性部分。
- en: '![](Images/CH14_F01_Labouardy.png)'
  id: totrans-12
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F01_Labouardy.png)'
- en: Figure 14.1 Enabling security in Jenkins
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.1 在 Jenkins 中启用安全性
- en: Disable Allow Anonymous Read Access and enable Allow Users to Sign Up, and you
    will be redirected to the sign-in page. This option allows users to create accounts
    by themselves via the Create an Account link, shown in figure 14.2.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 禁用允许匿名读取访问并启用允许用户注册，然后您将被重定向到登录页面。此选项允许用户通过图 14.2 中显示的创建账户链接自行创建账户。
- en: '![](Images/CH14_F02_Labouardy.png)'
  id: totrans-15
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F02_Labouardy.png)'
- en: Figure 14.2 Jenkins sign-in page
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.2 Jenkins 登录页面
- en: Click the Create an Account link. You will be prompted to add a new user. In
    figure 14.3, we are setting up a developer account.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 点击创建账户链接。您将被提示添加新用户。在图 14.3 中，我们正在设置一个开发者账户。
- en: '![](Images/CH14_F03_Labouardy.png)'
  id: totrans-18
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F03_Labouardy.png)'
- en: Figure 14.3 Setting up a developer account
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.3 设置开发者账户
- en: Once the new account is created, sign in. You’ll notice that it has full control
    of Jenkins. Letting signed-in users do anything is certainly flexible, and maybe
    all you need for a small team. For larger or multiple teams, or when Jenkins is
    being used outside the development environment, a more secure approach is generally
    required.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 创建新账户后，登录。您会注意到它对 Jenkins 具有完全控制权。让登录用户做任何事情当然很灵活，也许这对一个小团队来说就足够了。对于更大的团队或多个团队，或者当
    Jenkins 在开发环境之外使用时，通常需要更安全的方法。
- en: Note By default, Jenkins does not use CAPTCHA verification if the user creates
    an account. If you’d like to enable CAPTCHA verification, install a support plugin
    such as the Jenkins JCaptcha plugin ([https://plugins.jenkins.io/jcaptcha-plugin/](https://plugins.jenkins.io/jcaptcha-plugin/)).
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 注意 默认情况下，如果用户创建账户，Jenkins 不使用 CAPTCHA 验证。如果您想启用 CAPTCHA 验证，请安装支持插件，例如 Jenkins
    JCaptcha 插件 ([https://plugins.jenkins.io/jcaptcha-plugin/](https://plugins.jenkins.io/jcaptcha-plugin/))。
- en: 14.1.1 Matrix authorization strategy
  id: totrans-22
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 14.1.1 矩阵授权策略
- en: To set up granular access for logged-in users, we can use the Jenkins Matrix
    Authorization Strategy plugin ([https://plugins.jenkins.io/matrix-auth/](https://plugins.jenkins.io/matrix-auth/)).
    This plugin allows you to control job permission on each project with specific
    users who can do something on that job.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 要为登录用户设置细粒度访问，我们可以使用 Jenkins 矩阵授权策略插件 ([https://plugins.jenkins.io/matrix-auth/](https://plugins.jenkins.io/matrix-auth/))。此插件允许您通过指定用户控制每个项目的作业权限，这些用户可以在该作业上执行某些操作。
- en: Once the Matrix Authorization Strategy plugin is installed, head to Configure
    Global Security. In the Authorization section, enable Project-Based Matrix Authorization
    Strategy. Jenkins will display a table containing authorized users, and check
    boxes corresponding to the various permissions that you can assign to these users
    (figure 14.4).
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦安装了矩阵授权策略插件，请转到配置全局安全。在授权部分，启用基于项目的矩阵授权策略。Jenkins 将显示一个包含授权用户和对应于你可以分配给这些用户的各种权限的复选框的表格（图
    14.4）。
- en: '![](Images/CH14_F04_Labouardy.png)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F04_Labouardy.png)'
- en: Figure 14.4 Matrix-based security configuration
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.4 基于矩阵的安全配置
- en: The permissions are organized into several groups, such as these.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 权限被组织到几个组中，例如这些。
- en: '*Overall*—Covers basic system-wide permissions.'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*总体*—涵盖基本的系统级权限。'
- en: '*Credentials*—Covers managing Jenkins credentials.'
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*凭据*—涵盖管理 Jenkins 凭据。'
- en: '*Agent*—Covers permissions about build nodes or workers (adding or removing
    Jenkins nodes).'
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*代理*—涵盖与构建节点或工作者的权限（添加或删除 Jenkins 节点）。'
- en: '*Job*—Covers job-related permissions (creating a new build job, updating or
    deleting an existing build job).'
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*作业*—涵盖与作业相关的权限（创建新的构建作业、更新或删除现有的构建作业）。'
- en: '*Run*—Covers rights related to particular builds in the build history.'
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*运行*—涵盖与构建历史中特定构建相关的权利。'
- en: '*View*—Covers managing views. Views in Jenkins allow us to organize jobs and
    content into tabbed categories.'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*查看*—涵盖管理视图。Jenkins 中的视图允许我们将作业和内容组织到标签页分类中。'
- en: '*SCM*—Covers permissions related to a version-control system (such as Git or
    SVN).'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*源代码管理（SCM）*—涵盖与版本控制系统（如 Git 或 SVN）相关的权限。'
- en: 'The matrix controls what users can do (read jobs, execute builds, install plugins,
    and so forth). We have a couple of built-in authorizations to consider:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 矩阵控制用户可以执行的操作（读取作业、执行构建、安装插件等）。我们有几个内置的授权需要考虑：
- en: '*Anonymous*—Anyone who has not logged in'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*匿名用户*—任何未登录的用户'
- en: '*Authenticated*—Anyone who has logged in'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*认证用户*—任何已登录的用户'
- en: 'You can configure permissions for a specific user by clicking Add User or Group.
    Add two users: one administrator (say, `mlabouardy/admin`) and a regular user
    (say, `developer`).'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过点击添加用户或组来为特定用户配置权限。添加两个用户：一个管理员（例如，`mlabouardy/admin`）和一个普通用户（例如，`developer`）。
- en: All the check boxes next to users are for setting global permissions. Select
    all check boxes to give admin full permissions. For Developer (aka John Doe),
    we are selecting read permissions under Job. With this, Developer would now have
    read permission to view all jobs that we created in the previous chapters; see
    figure 14.5.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 用户旁边的所有复选框都是用于设置全局权限的。选择所有复选框以授予管理员完全权限。对于开发者（即 John Doe），我们在作业下选择读取权限。这样，开发者现在将有权查看我们在前几章中创建的所有作业；请参阅图
    14.5。
- en: Click Save, and the login page opens if you log in using developer credentials.
    In this mode, the developer account has only read permissions, as shown in figure
    14.6 (for example, the developer can’t trigger a build or configure job settings).
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 点击保存，如果你使用开发者凭据登录，则会打开登录页面。在此模式下，开发者账户只有读取权限，如图 14.6 所示（例如，开发者无法触发构建或配置作业设置）。
- en: '![](Images/CH14_F05_Labouardy.png)'
  id: totrans-41
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F05_Labouardy.png)'
- en: Figure 14.5 Fine-tuning user permissions
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.5 精细调整用户权限
- en: '![](Images/CH14_F06_Labouardy.png)'
  id: totrans-43
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F06_Labouardy.png)'
- en: Figure 14.6 Jenkins read-only access
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.6 Jenkins 只读访问
- en: So far, you have seen how to create and manage Jenkins users as well as how
    to give granular access to these users. However, in a large organization, assigning
    granular permissions to multiple users can be tedious. Luckily, you can create
    different roles with the appropriate permissions and assign them to different
    users in Jenkins.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，你已经看到了如何创建和管理 Jenkins 用户，以及如何为这些用户授予细粒度的访问权限。然而，在一个大型组织中，为多个用户分配细粒度的权限可能会很繁琐。幸运的是，你可以在
    Jenkins 中创建具有适当权限的不同角色，并将它们分配给不同的用户。
- en: 14.1.2 Role-based authorization strategy
  id: totrans-46
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 14.1.2 基于角色的授权策略
- en: To manage different roles, install the Role-Based Authorization Strategy plugin
    ([https://plugins.jenkins.io/role-strategy/](https://plugins.jenkins.io/role-strategy/))
    from the Plugin Manager page. Then activate the Role-Based Strategy option from
    the Manage Global Security page, as shown in figure 14.7.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 要管理不同的角色，请从插件管理页面安装基于角色的授权策略插件（[https://plugins.jenkins.io/role-strategy/](https://plugins.jenkins.io/role-strategy/))。然后从管理全局安全页面激活基于角色的策略选项，如图
    14.7 所示。
- en: '![](Images/CH14_F07_Labouardy.png)'
  id: totrans-48
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F07_Labouardy.png)'
- en: Figure 14.7 Enabling the Role-Based Authorization Strategy plugin
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.7 启用基于角色的授权策略插件
- en: Then you can define global roles on the Manage Jenkins page by selecting the
    Manage and Assign Roles option (figure 14.8). Note that Manage and Assign Roles
    will be visible only if you have installed the plugin correctly.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，你可以在管理 Jenkins 页面上通过选择管理并分配角色选项（图 14.8）来定义全局角色。请注意，只有当你正确安装了插件时，管理并分配角色才会可见。
- en: '![](Images/CH14_F08_Labouardy.png)'
  id: totrans-51
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F08_Labouardy.png)'
- en: Figure 14.8 Defining custom roles
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.8 定义自定义角色
- en: 'Click the Manage Roles option to add new roles. Create three custom roles with
    the appropriate permissions:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 点击管理角色选项以添加新角色。创建三个具有适当权限的自定义角色：
- en: '*Admin*—Will be assigned to Jenkins administrators for full access to Jenkins'
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*管理员*—将被分配给 Jenkins 管理员以获得对 Jenkins 的完全访问权限'
- en: '*Developer*—Will be assigned to developers for permissions to build jobs and
    view their logs and status'
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*开发者*—将被分配给开发者以获得构建作业和查看其日志和状态的权限'
- en: '*QA*—Will be assigned to software quality assurance engineer for permissions
    to view jobs status/health'
  id: totrans-56
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*质量保证*—将被分配给软件质量保证工程师以查看作业状态/健康的权限'
- en: Then, assign these roles to specific users from the Assign Roles screen (figure
    14.9). In these settings, we assign the admin’s role to the administrator account,
    the developer’s role to a member of the development team, and QA’s role to a software
    QA.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，从分配角色屏幕（图 14.9）将这些角色分配给特定的用户。在这些设置中，我们将管理员角色分配给管理员账户，将开发者角色分配给开发团队成员，将质量保证角色分配给软件质量保证人员。
- en: '![](Images/CH14_F09_Labouardy.png)'
  id: totrans-58
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F09_Labouardy.png)'
- en: Figure 14.9 Managing and assigning roles
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.9 管理和分配角色
- en: If you’re using Jenkins within an organization, creating and managing users’
    access might be a tedious task. You can use GitHub as an authentication mechanism.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你在组织内部使用 Jenkins，创建和管理用户访问可能是一项繁琐的任务。你可以使用 GitHub 作为认证机制。
- en: Note You can configure many OAuth2 authentication services with Jenkins, including
    GitLab, Google, and OpenID.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：你可以使用 Jenkins 配置许多 OAuth2 认证服务，包括 GitLab、Google 和 OpenID。
- en: 14.2 Configuring GitHub OAuth for Jenkins
  id: totrans-62
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.2 配置 Jenkins 的 GitHub OAuth
- en: Jenkins supports several authentication plugins, in addition to built-in username
    and password authentication. If you’re using GitHub as your version-control system
    within your organization, you can also use the GitHub OAuth service for user authentication
    and privileges management.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: Jenkins 支持多个认证插件，除了内置的用户名和密码认证之外。如果你在组织内部使用 GitHub 作为版本控制系统，你也可以使用 GitHub OAuth
    服务进行用户认证和权限管理。
- en: On Jenkins, install the GitHub Authentication plugin ([https://plugins.jenkins.io/github-oauth/](https://plugins.jenkins.io/github-oauth/))
    from Manage Plugins. Once it’s installed, head to your GitHub account and create
    a new application ([https://github.com/settings/applications/new](https://github.com/settings/applications/new))
    called `Jenkins` with the settings in figure 14.10.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Jenkins 上，从管理插件中安装 GitHub 认证插件（[https://plugins.jenkins.io/github-oauth/](https://plugins.jenkins.io/github-oauth/))。安装完成后，前往你的
    GitHub 账户并创建一个新的应用程序（[https://github.com/settings/applications/new](https://github.com/settings/applications/new))，命名为
    `Jenkins`，并使用图 14.10 中的设置。
- en: '![](Images/CH14_F10_Labouardy.png)'
  id: totrans-65
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F10_Labouardy.png)'
- en: Figure 14.10 Configuring the GitHub OAuth application
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.10 配置 GitHub OAuth 应用
- en: The authorization callback URL must be JENKINS_URL/securityRealm/finishLogin.
    Click the Register Application button. A Client ID and secret will be generated,
    as shown in figure 14.11\. Keep the page open to the application registration,
    so this information can be copied into your Jenkins configuration.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 授权回调 URL 必须是 JENKINS_URL/securityRealm/finishLogin。点击注册应用程序按钮。将生成客户端 ID 和密钥，如图
    14.11 所示。保持页面打开以进行应用程序注册，以便可以将此信息复制到你的 Jenkins 配置中。
- en: '![](Images/CH14_F11_Labouardy.png)'
  id: totrans-68
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F11_Labouardy.png)'
- en: Figure 14.11 Application client ID and client secret
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.11 应用程序客户端 ID 和客户端密钥
- en: Head back to Jenkins, and in the Global Security configuration, set the Security
    Realm option to GitHub Authentication Plugin. Then set the Client ID, Client Secret,
    and OAuth scopes as shown in figure 14.12.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 返回 Jenkins，在全局安全配置中，将安全领域选项设置为 GitHub 认证插件。然后设置客户端 ID、客户端密钥和 OAuth 范围，如图 14.12
    所示。
- en: '![](Images/CH14_F12_Labouardy.png)'
  id: totrans-71
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F12_Labouardy.png)'
- en: Figure 14.12 Configuring the Jenkins client settings for OAuth
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.12 配置 Jenkins 客户端设置以进行 OAuth
- en: Click the Save and Apply buttons to reload the configuration. You can now sign
    in with your GitHub account, as shown in figure 14.13.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 点击保存和应用按钮以重新加载配置。你现在可以使用你的 GitHub 账户登录，如图 14.13 所示。
- en: '![](Images/CH14_F13_Labouardy.png)'
  id: totrans-74
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F13_Labouardy.png)'
- en: Figure 14.13 Authorizing Jenkins to access your GitHub account
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.13 授权 Jenkins 访问您的 GitHub 账户
- en: Similar to classic username and password authentication, you can use a project-based
    matrix authorization strategy to determine Jenkins permissions for each GitHub
    account.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 与经典的用户名和密码身份验证类似，您可以使用基于项目的矩阵授权策略来确定每个 GitHub 账户的 Jenkins 权限。
- en: Another option is to use the GitHub Committer Authorization strategy. If you
    check this option, you can use GitHub repository permissions to determine permissions
    for each Jenkins project. If the GitHub repository of the project is public, all
    authenticated users will have read-only access, while project collaborators can
    build, edit, configure, cancel, or delete the Jenkins job. However, if the GitHub
    repository of the project is private, only collaborators can manage the Jenkins
    job.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个选项是使用 GitHub 提交者授权策略。如果您选择此选项，可以使用 GitHub 仓库权限来确定每个 Jenkins 项目的权限。如果项目的 GitHub
    仓库是公开的，所有经过身份验证的用户都将具有只读访问权限，而项目协作者可以构建、编辑、配置、取消或删除 Jenkins 作业。然而，如果项目的 GitHub
    仓库是私有的，只有协作者才能管理 Jenkins 作业。
- en: To determine Jenkins access based on GitHub access, head to the Configure Global
    Security section from Manage Jenkins (figure 14.14).
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 要根据 GitHub 访问权限确定 Jenkins 访问权限，请从“管理 Jenkins”转到“配置全局安全”部分（图 14.14）。
- en: '![](Images/CH14_F14_Labouardy.png)'
  id: totrans-79
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F14_Labouardy.png)'
- en: Figure 14.14 Configuring GitHub Authorization settings
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.14 配置 GitHub 授权设置
- en: Note We have authorized the use of the /github-webhook callback URL to receive
    post-commit hooks from GitHub.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：我们已经授权使用 /github-webhook 回调 URL 接收来自 GitHub 的 post-commit 钩子。
- en: 14.3 Keeping track of Jenkins users’ actions
  id: totrans-82
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.3 跟踪 Jenkins 用户操作
- en: 'In addition to configuring user accounts and access rights, keeping track of
    individual user actions can also be useful: in other words, who did what to your
    Jenkins configuration. This sort of audit trail facility is even required in many
    organizations for security compliance.'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 除了配置用户账户和访问权限之外，跟踪个别用户操作也可能很有用：换句话说，谁对您的 Jenkins 配置做了什么。这种审计跟踪功能在许多组织中对于安全合规性甚至是必需的。
- en: The Audit Trail plugin ([https://plugins.jenkins.io/audit-trail/](https://plugins.jenkins.io/audit-trail/))
    keeps track of the main user actions in a set of rolling log files. To set this
    up, go to the Plugin Manager page and select the Audit Trail plugin in the list
    of available plugins. Then, as usual, click Install and Restart Jenkins after
    the plugin has been downloaded.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: Audit Trail 插件([https://plugins.jenkins.io/audit-trail/](https://plugins.jenkins.io/audit-trail/))会跟踪一组滚动日志文件中的主要用户操作。要设置此插件，请转到插件管理器页面，并在可用插件列表中选择
    Audit Trail 插件。然后，像往常一样，在插件下载完成后，点击安装并重启 Jenkins。
- en: To enable audit logging, configure the plugin from the main Jenkins configuration
    page. Select Logfile as a Logger; that way, the plugin will produce a system-style
    log file. Then, set the log location (the directory in which the log files are
    to be written), as shown in figure 14.15\. Of course, you need to ensure that
    the user running your Jenkins instance is allowed to write to this directory.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 要启用审计日志记录，请从主 Jenkins 配置页面配置插件。选择“日志文件”作为记录器；这样，插件将生成系统风格的日志文件。然后，设置日志位置（日志文件要写入的目录），如图
    14.15 所示。当然，您需要确保运行您的 Jenkins 实例的用户有权写入此目录。
- en: '![](Images/CH14_F15_Labouardy.png)'
  id: totrans-86
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F15_Labouardy.png)'
- en: Figure 14.15 Configuring the Audit Trail plugin
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.15 配置 Audit Trail 插件
- en: By default, the details recorded in the audit logs are fairly sparse—they effectively
    record key actions performed, such as creating, modifying, or deleting job configurations
    or views, and the user who performed the actions. The log also shows how individual
    build jobs started. Figure 14.16 shows an extract of the default log.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，审计日志中记录的详细信息相对较少——它们有效地记录了执行的关键操作，例如创建、修改或删除作业配置或视图，以及执行这些操作的用户。日志还显示了单个构建作业是如何启动的。图
    14.16 显示了默认日志的摘录。
- en: '![](Images/CH14_F16_Labouardy.png)'
  id: totrans-89
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F16_Labouardy.png)'
- en: Figure 14.16 Viewing audit logs for the authorized user activity
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.16 查看授权用户活动审计日志
- en: You can also configure the number of log files to be maintained and the maximum
    size of each file. In the previous configuration, we have the Log File Count set
    to 10; in this case, Jenkins will write to log files with names like jenkins-audit.log.0,
    jenkins-audit.log.1 . . . jenkins-audit.log.9\. Now, you can access the configuration
    history for the whole server, including system configuration updates, as well
    as the changes made to the configuration of each project.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以配置要维护的日志文件数量以及每个文件的最大大小。在之前的配置中，我们将日志文件计数设置为10；在这种情况下，Jenkins将写入名为jenkins-audit.log.0、jenkins-audit.log.1
    ... jenkins-audit.log.9的日志文件。现在，您可以访问整个服务器的配置历史，包括系统配置更新以及每个项目配置的更改。
- en: Note You can take the preceding configuration further and stream those log files
    to a centralized ELK platform and set up alerts on unauthorized user activities.
    For a step-by-step guide, head back to chapter 13.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：您可以将前面的配置进一步扩展，将这些日志文件流式传输到集中的ELK平台，并设置对未经授权用户活动的警报。有关分步指南，请返回第13章。
- en: 14.4 Extending Jenkins with shared libraries
  id: totrans-93
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.4 使用共享库扩展Jenkins
- en: Throughout this book, you have learned how to write a CI/CD pipeline for multiple
    applications, and while implementing those pipeline steps, we have invoked multiple
    custom functions. Those functions, shown in the following listing, were duplicated
    in multiple Jenkinsfiles.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 在整本书中，您已经学习了如何为多个应用程序编写CI/CD管道，在实现这些管道步骤时，我们已经调用了多个自定义函数。以下列表中显示的这些函数在多个Jenkinsfiles中重复出现。
- en: Listing 14.1 Helper functions for Git and Slack
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 列表14.1 Git和Slack的辅助函数
- en: '[PRE0]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Therefore, we had some common code across different pipelines. To avoid copying
    and pasting the same code into different pipelines, and to reduce redundancies,
    we can centralize the common code in a shared library within Jenkins. That way,
    we can reference the same code in all of the pipelines.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们在不同的管道中有些共同的代码。为了避免在不同的管道中复制粘贴相同的代码，并减少冗余，我们可以在Jenkins中的共享库中集中这些共同代码。这样，我们就可以在所有管道中引用相同的代码。
- en: A *shared library* is a collection of independent Groovy scripts stored in a
    Git repository. This means you can version, tag, and do all the stuff you’re used
    to with Git. Before writing our first shared library in Jenkins, we need to create
    a GitHub repository where Groovy scripts will be stored.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: '*共享库*是一组存储在Git仓库中的独立Groovy脚本。这意味着您可以进行版本控制、打标签，并执行您习惯使用Git的所有操作。在我们编写第一个Jenkins共享库之前，我们需要创建一个GitHub仓库，其中将存储Groovy脚本。'
- en: Inside the repository, create a vars folder and write a Groovy script per function.
    For example, create a file named commitAuthor.groovy and define a function called
    `call`. The body of the function is what will be executed when the `commitAuthor`
    instruction is invoked, as shown in the following listing.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 在仓库内部，创建一个vars文件夹，并为每个函数编写一个Groovy脚本。例如，创建一个名为commitAuthor.groovy的文件，并定义一个名为`call`的函数。当调用`commitAuthor`指令时，将执行函数的主体，如下所示。
- en: Listing 14.2 Defining a global variable in the shared library
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 列表14.2 在共享库中定义全局变量
- en: '[PRE1]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: ❶ Searches your path looking for Groovy to execute the script
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 在您的路径中搜索Groovy以执行脚本
- en: ❷ Allows the global variable to be invoked in a manner similar to a step
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 允许以类似于步骤的方式调用全局变量
- en: ❸ Prints the Git commit author
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 打印Git提交作者
- en: Notice that the Groovy script must implement the `call` method. Write your custom
    code within the braces `{}`. You can also add parameters to your method. Do the
    same for other functions and push the changes to the remote repository. Eventually,
    your repository should look like figure 14.17.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，Groovy脚本必须实现`call`方法。在花括号`{}`内编写您的自定义代码。您还可以向您的函数添加参数。对其他函数也这样做，并将更改推送到远程仓库。最终，您的仓库应该看起来像图14.17所示。
- en: '![](Images/CH14_F17_Labouardy.png)'
  id: totrans-106
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F17_Labouardy.png)'
- en: Figure 14.17 Shared library custom global variables
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 图14.17 共享库自定义全局变量
- en: 'Now that you’ve created your library with custom steps, you need to tell Jenkins
    about it. To add a shared library, head to a job configuration. Under Pipeline
    Libraries, add a library with the following settings:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您已经使用自定义步骤创建了您的库，您需要通知Jenkins。要添加共享库，请转到作业配置。在Pipeline Libraries下，添加具有以下设置的库：
- en: '*Name*—A short identifier that will be used in pipeline scripts'
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*名称*—在管道脚本中将使用的简短标识符'
- en: '*Default version*—Could be anything understood by Git—for example, branches,
    tags, or commit ID hashes'
  id: totrans-110
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*默认版本*—可以是Git能理解的任何内容，例如分支、标签或提交ID哈希'
- en: Next, load the library from the GitHub repository at the master branch, as shown
    in figure 14.18.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，从图 14.18 所示的 GitHub 仓库的 master 分支加载库。
- en: '![](Images/CH14_F18_Labouardy.png)'
  id: totrans-112
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F18_Labouardy.png)'
- en: Figure 14.18 Loading a shared library from GitHub
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.18 从 GitHub 加载共享库
- en: Note You can also define a shared library globally, from Manage Jenkins > Configure
    System > Global Pipeline Libraries. That way, all pipelines can use functionality
    implemented in this library.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：你还可以在“管理 Jenkins”>“配置系统”>“全局管道库”中全局定义共享库。这样，所有管道都可以使用在此库中实现的功能。
- en: To load the shared library in a pipeline, you need to import it with the `@Library`
    annotation at the top of your pipeline definition. Then call the target function
    by its name, as shown in the following listing.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 要在管道中加载共享库，你需要使用管道定义顶部的 `@Library` 注解来导入它。然后通过其名称调用目标函数，如下面的列表所示。
- en: Listing 14.3 Importing the shared library in the scripted pipeline
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.3 在脚本管道中导入共享库
- en: '[PRE2]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: ❶ The underscore is required if the line immediately after the @Library annotation
    is not an import statement.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 如果紧跟在 `@Library` 注解之后的行不是导入语句，则需要下划线。
- en: The underscore is not a typo or mistake; you need this if the line immediately
    after the `@Library` annotation is not an import statement. You can override the
    default version defined for the library with the `@Library('id@version')` annotation.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 下划线不是打字错误或错误；如果紧跟在 `@Library` 注解之后的行不是导入语句，你需要这个下划线。你可以使用 `@Library('id@version')`
    注解覆盖为库定义的默认版本。
- en: If you’re using a declarative pipeline, you need to wrap the library name inside
    a libraries section, as shown in the following listing.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用的是声明式管道，你需要将库名称包裹在库部分中，如下面的列表所示。
- en: Listing 14.4 Importing shared library in the declarative pipeline
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.4 在声明式管道中导入共享库
- en: '[PRE3]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'When using a library, you may also specify a version with the following format:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 当使用库时，你也可以指定以下格式的版本：
- en: '[PRE4]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Run the previous pipeline, and the output should look something like figure
    14.19.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 运行前面的管道，输出应该类似于图 14.19。
- en: '![](Images/CH14_F19_Labouardy.png)'
  id: totrans-126
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F19_Labouardy.png)'
- en: Figure 14.19 Loading the shared library from Git within a pipelin.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.19 在管道中从 Git 加载共享库。
- en: Another way to write a library is to define the functions within a Groovy class.
    Create the `Git.groovy` class in src/com/labouardy/utils, as shown in the following
    listing.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 编写库的另一种方法是定义 Groovy 类中的函数。在 src/com/labouardy/utils 中创建 `Git.groovy` 类，如下面的列表所示。
- en: Listing 14.5 Writing a shared library
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.5 编写共享库
- en: '[PRE5]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'You can load classes defined in the library by selecting their fully qualified
    name:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过选择它们的完全限定名称来加载库中定义的类：
- en: '[PRE6]'
  id: totrans-132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Or you can create an object constructor function and then call the method from
    the object:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 或者你可以创建一个对象构造函数，然后从对象中调用方法：
- en: '[PRE7]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Note It is possible to use third-party Java libraries, typically found in Maven
    Central ([https://search.maven.org/](https://search.maven.org/)), from trusted
    library code by using the `@Grab` annotation. Refer to the Grape documentation
    for details ([http://mng.bz/nrxg](http://mng.bz/nrxg)).
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：通过使用 `@Grab` 注解，你可以从受信任的库代码中使用 Maven Central ([https://search.maven.org/](https://search.maven.org/))
    中找到的第三方 Java 库。有关详细信息，请参阅 Grape 文档 ([http://mng.bz/nrxg](http://mng.bz/nrxg))。
- en: 14.5 Backing up and restoring Jenkins
  id: totrans-136
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.5 备份和恢复 Jenkins
- en: Backing up your data is a universally recommended practice, and your Jenkins
    server should be no exception. Fortunately, backing up Jenkins is relatively easy.
    In this section, we will look at a few ways to do this.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 备份数据是一种普遍推荐的做法，你的 Jenkins 服务器不应例外。幸运的是，备份 Jenkins 相对容易。在本节中，我们将探讨几种备份的方法。
- en: In Jenkins, all the settings, build logs, and archives of the artifacts are
    stored under the $JENKINS_HOME directory. You can back up the directory manually,
    or by using a plugin like ThinBackup ([https://plugins.jenkins.io/thinBackup/](https://plugins.jenkins.io/thinBackup/)).
    The plugin provides a simple user interface that you can use to back up and restore
    your Jenkins configurations and data.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Jenkins 中，所有设置、构建日志和归档的工件都存储在 `$JENKINS_HOME` 目录下。你可以手动备份该目录，或者使用像 ThinBackup
    ([https://plugins.jenkins.io/thinBackup/](https://plugins.jenkins.io/thinBackup/))
    这样的插件。该插件提供了一个简单的用户界面，你可以使用它来备份和恢复你的 Jenkins 配置和数据。
- en: Once you install the plugin, you need to configure the backup directory, as
    shown in figure 14.20\. Specify the backup directory to be /var/lib/backups. Be
    sure Jenkins has write rights!
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 安装插件后，您需要配置备份目录，如图14.20所示。指定备份目录为/var/lib/backups。确保Jenkins有写入权限！
- en: '![](Images/CH14_F20_Labouardy.png)'
  id: totrans-140
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F20_Labouardy.png)'
- en: Figure 14.20 Configuring the ThinBackup plugin
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 图14.20 配置 ThinBackup 插件
- en: 'Now, you can test whether the backup is working by clicking the Backup Now
    option. It will create a backup of Jenkins data in the backup directory you specified
    in the settings:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您可以通过点击“立即备份”选项来测试备份是否正常工作。它将在设置中指定的备份目录中创建Jenkins数据的备份：
- en: '![](Images/CH14_F20_UN01_Labouardy.png)'
  id: totrans-143
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F20_UN01_Labouardy.png)'
- en: To restore a previous configuration, just go to the Restore page and choose
    the date of the configuration you wish to reinstate, as shown in figure 14.21\.
    Once the configuration has been restored to the previous state, you need to reload
    the Jenkins configuration from disk or restart Jenkins.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 要恢复以前的配置，只需转到“恢复”页面并选择您希望恢复的配置日期，如图14.21所示。一旦配置已恢复到之前的状态，您需要从磁盘重新加载Jenkins配置或重启Jenkins。
- en: '![](Images/CH14_F21_Labouardy.png)'
  id: totrans-145
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F21_Labouardy.png)'
- en: Figure 14.21 Restoring a previous configuration
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 图14.21 恢复以前的配置
- en: As a result of the backup, you can restore Jenkins from an earlier point in
    time in case of data corruption or a human-caused event.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 由于备份，在数据损坏或人为事件发生的情况下，您可以从较早的时间点恢复Jenkins。
- en: Note The ThinBackup plugin stores the backup locally for production usage. It’s
    highly recommended to store your backups on a remote server or mount an external
    data storage.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：ThinBackup插件将备份存储在本地以供生产使用。强烈建议将备份存储在远程服务器上或挂载外部数据存储。
- en: If you’re not a fan of plugins, you can set up a cron job (see the next section
    for more details) on Jenkins to schedule regular backups. It will back up everything
    located at /var/lib/jenkins to a remote repository such as S3 bucket, as shown
    in the following listing.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您不喜欢插件，您可以在Jenkins上设置一个cron作业（下一节将提供更多详细信息）来安排定期备份。它将备份位于/var/lib/jenkins的所有内容到远程存储库，如以下列表所示。
- en: Listing 14.6 Backing up the $JENKINS_HOME folder to an S3 bucket
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 列表14.6 将$JENKINS_HOME文件夹备份到S3存储桶
- en: '[PRE8]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Sometimes you need to move or copy Jenkins build jobs from one Jenkins instance
    to another, without copying the entire Jenkins configuration. For example, you
    might be migrating your build jobs to a Jenkins server on a brand-new instance.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 有时您需要将Jenkins构建作业从一个Jenkins实例移动或复制到另一个实例，而不复制整个Jenkins配置。例如，您可能正在将构建作业迁移到全新实例上的Jenkins服务器。
- en: You can copy or move build jobs between instances of projects simply by copying
    or moving the build job directories to the new Jenkins instance. I have built
    an open source CLI called Butler ([https://github.com/mlabouardy/butler](https://github.com/mlabouardy/butler))
    to import/export Jenkins jobs and plugins easily.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过简单地复制或移动构建作业目录到新的Jenkins实例来在项目实例之间复制或移动构建作业。我已经构建了一个名为Butler的开源CLI（[https://github.com/mlabouardy/butler](https://github.com/mlabouardy/butler)），以便轻松导入/导出Jenkins作业和插件。
- en: 'To get started, find the appropriate package for your system and download it.
    Here’s the command for Linux:'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 要开始，找到适合您系统的适当软件包并下载它。以下是Linux的命令：
- en: '[PRE9]'
  id: totrans-155
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Verify that the installation worked by opening a new terminal session and checking
    whether Butler is available. To export Jenkins plugins, you need to provide the
    Jenkins URL:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 通过打开新的终端会话并检查Butler是否可用来验证安装是否成功。要导出Jenkins插件，您需要提供Jenkins URL：
- en: '[PRE10]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: A new jobs/ directory will be created with every job in Jenkins. Each job will
    have its own configuration file, config.xml.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 每次在Jenkins中创建一个新的工作目录，每个工作都会有一个自己的配置文件，config.xml。
- en: To import the plugins, issue the `butler plugins export` command. Butler will
    dump a list of plugins installed to stdout, and a new file, plugins.txt, will
    be generated, with a list of installed Jenkins plugins with name and version pairs,
    as shown in fig- ure 14.22.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 要导入插件，请运行`butler plugins export`命令。Butler将列出已安装的插件到stdout，并生成一个新文件，plugins.txt，其中包含已安装的Jenkins插件的名称和版本对，如图14.22所示。
- en: '![](Images/CH14_F22_Labouardy.png)'
  id: totrans-160
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F22_Labouardy.png)'
- en: Figure 14.22 Listing of installed Jenkins plugins
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 图14.22 已安装Jenkins插件的列表
- en: You can import exported jobs and plugins with the `butler plugins/jobs import`
    commands. Butler will use the exported files to issue API calls to the target
    Jenkins instance to import plugins and jobs.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用 `butler plugins/jobs import` 命令导入导出的作业和插件。Butler 将使用导出的文件向目标 Jenkins 实例发出
    API 调用来导入插件和作业。
- en: So, all in all, migrating build jobs between Jenkins instances isn’t all that
    hard—you just need to know a couple of tricks for the corner cases, and if you
    know where to look, Jenkins provides some nice tools to make the process smoother.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，总的来说，在 Jenkins 实例之间迁移构建作业并不那么困难——您只需要知道一些针对特殊情况的小技巧，并且如果您知道在哪里查找，Jenkins
    提供了一些很好的工具来使过程更顺畅。
- en: If you want $JENKINS_HOME content to be persisted on disk even if the Jenkins
    master instance has been restarted or shut down, you can mount a remote filesystem
    on the $JENKINS_HOME folder.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您希望 $JENKINS_HOME 内容即使在 Jenkins 主实例重启或关闭后也能在磁盘上持久化，您可以在 $JENKINS_HOME 文件夹上挂载一个远程文件系统。
- en: If you’re running Jenkins on AWS, you can use an AWS service called Amazon Elastic
    File System, or EFS ([https://aws.amazon.com/efs/](https://aws.amazon.com/efs/)).
    Create a filesystem on EFS by clicking the Create File System button (figure 14.23).
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您在 AWS 上运行 Jenkins，可以使用 AWS 的一项服务，称为 Amazon Elastic File System（EFS）。通过单击创建文件系统按钮（图
    14.23）在 EFS 上创建一个文件系统。
- en: '![](Images/CH14_F23_Labouardy.png)'
  id: totrans-166
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F23_Labouardy.png)'
- en: Figure 14.23 Creating an Amazon EFS filesystem
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.23 创建 Amazon EFS 文件系统
- en: 'Once the filesystem is created and its state is Available, mount the EFS filesystem
    in the /var/lib/jenkins directory, so all the configuration will be saved in EFS:'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦文件系统创建并处于可用状态，请在 /var/lib/jenkins 目录下挂载 EFS 文件系统，这样所有配置都将保存在 EFS 中：
- en: '[PRE11]'
  id: totrans-169
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: If you want to test it, terminate your EC2 instance and a new one will be launched
    automatically with the same configuration (make sure to add the mount commands
    to the Packer template while baking the Jenkins master AMI).
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想测试它，终止您的 EC2 实例，将自动启动一个新的具有相同配置的实例（确保在烘焙 Jenkins 主 AMI 时将挂载命令添加到 Packer
    模板中）。
- en: 14.6 Setting up cron jobs with Jenkins
  id: totrans-171
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.6 使用 Jenkins 设置 cron 作业
- en: Jenkins provides a cron-like feature to periodically build a project. This feature
    is primarily used to run scheduled builds, like nightly/weekly builds or running
    tests. For example, you might want to run performance tests or integration tests
    for Android or iOS releases at night, when users do not access the backend under
    test.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: Jenkins 提供了一个类似于 cron 的功能，用于定期构建项目。此功能主要用于运行计划构建，如夜间/周构建或运行测试。例如，您可能希望在用户不访问测试的后端时，在夜间运行
    Android 或 iOS 发布的性能测试或集成测试。
- en: To configure a scheduled nightly build that runs at a certain day and time,
    head over to Jenkins dashboard. Create a new job and select Freestyle Project.
    Configure the job accordingly by adding the job details shown in figure 14.24.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 要配置一个在特定日期和时间运行的计划夜间构建，请转到 Jenkins 仪表板。创建一个新的作业并选择 Freestyle Project。根据图 14.24
    中的作业详情进行相应配置。
- en: '![](Images/CH14_F24_Labouardy.png)'
  id: totrans-174
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F24_Labouardy.png)'
- en: Figure 14.24 Creating a Freestyle project
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.24 创建 Freestyle 项目
- en: Schedule your build from the Build Triggers tab by writing the cron syntax shown
    in figure 14.25, and then select the Build Periodically option. Fill in a cron-like
    value for the time you wish to trigger the pipeline execution.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 通过在构建触发器选项卡中编写图 14.25 中所示的 cron 语法，并选择构建周期性选项，来安排您的构建。填写一个 cron 类似的值，以触发管道执行的所需时间。
- en: '![](Images/CH14_F25_Labouardy.png)'
  id: totrans-177
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F25_Labouardy.png)'
- en: Figure 14.25 Defining a cron job expression
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.25 定义 cron 作业表达式
- en: Jenkins uses a cron expression, with fields as follows.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: Jenkins 使用 cron 表达式，字段如下。
- en: MINUTES —Minutes in one hour (0–59)
  id: totrans-180
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: MINUTES — 一小时中的分钟数（0–59）
- en: HOURS —Hours in one day (0–23)
  id: totrans-181
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: HOURS — 一天中的小时数（0–23）
- en: DAYMONTH—A day in a month (1–31)
  id: totrans-182
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: DAYMONTH — 一个月中的某一天（1–31）
- en: MONTH—Month in a year (1–12)
  id: totrans-183
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: MONTH — 一年中的月份（1–12）
- en: DAYWEEK —Day of the week (0–7), where 0 and 7 are Sunday
  id: totrans-184
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: DAYWEEK — 周中的某一天（0–7），其中 0 和 7 是周日
- en: For example (figure 14.26), to trigger a build at midnight on Sunday, the cron
    value `H 12 * * 7` will do the job.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 例如（图 14.26），要在周日午夜触发构建，cron 值 `H 12 * * 7` 就可以完成这项工作。
- en: Note You should be aware that the time zone is relative to the location where
    your Jenkins virtual machine is running. This example uses Coordinated Universal
    Time (UTC).
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：您应该知道时区是相对于您的 Jenkins 虚拟机运行的位置而言的。此示例使用协调世界时（UTC）。
- en: '![](Images/CH14_F26_Labouardy.png)'
  id: totrans-187
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F26_Labouardy.png)'
- en: Figure 14.26 Shell script to back up the $JENKINS_HOME folder
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.26 备份 $JENKINS_HOME 文件夹的 Shell 脚本
- en: Build your job to test that everything is working as you’ve expected. Your build
    results should look like figure 14.27.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 构建你的作业以测试一切是否按预期工作。你的构建结果应类似于图 14.27。
- en: '![](Images/CH14_F27_Labouardy.png)'
  id: totrans-190
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F27_Labouardy.png)'
- en: Figure 14.27 Triggering a cron job manually
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.27 手动触发 cron 作业
- en: Next time, your job will automatically execute at 12:00 A.M. since you have
    scheduled it to run at this time using cron syntax.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 下次，你的作业将在午夜 12:00 自动执行，因为你已经使用 cron 语法安排了在此时间运行。
- en: Jenkins jobs could be run programmatically, using API calls or the Jenkins CLI.
    That opens up the opportunity to implement complex schedule builds by integrating
    an external service like AWS Lambda to invoke a Jenkins build job based on different
    events; see figure 14.28.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: Jenkins 作业可以通过程序方式运行，使用 API 调用或 Jenkins CLI。这为通过集成外部服务（如 AWS Lambda）根据不同事件调用
    Jenkins 构建作业以实现复杂的计划构建提供了机会；参见图 14.28。
- en: '![](Images/CH14_F28_Labouardy.png)'
  id: totrans-194
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH14_F28_Labouardy.png)'
- en: Figure 14.28 Triggering a Jenkins job from a Lambda function
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.28 从 Lambda 函数触发 Jenkins 作业
- en: This diagram covers how to trigger a Jenkins build job from a Lambda function
    through the Jenkins RESTful API. The Lambda function is invoked on the upcoming
    CloudWatch event rule (cloud-managed cron job) or HTTPS requests from API Gateway.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 此图说明了如何通过 Jenkins RESTful API 从 Lambda 函数触发 Jenkins 构建作业。Lambda 函数在即将到来的 CloudWatch
    事件规则（云管理的 cron 作业）或来自 API Gateway 的 HTTPS 请求上被调用。
- en: 14.7 Running Jenkins locally as a Docker container
  id: totrans-197
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.7 在本地作为 Docker 容器运行 Jenkins
- en: If you need to debug Jenkins or test a new plugin, you can deploy Jenkins locally
    on your machine and run it as a Docker container. That way, you can easily create
    and destroy a Jenkins server.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你需要调试 Jenkins 或测试新的插件，你可以在你的机器上本地部署 Jenkins 并将其作为 Docker 容器运行。这样，你可以轻松创建和销毁
    Jenkins 服务器。
- en: You can use the official Jenkins Docker image from the DockerHub repository
    ([https://hub.docker.com/_/jenkins](https://hub.docker.com/_/jenkins)). The image
    contains the current LTS release of Jenkins (v2.60.3 at the time of this writing).
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用来自 DockerHub 仓库的官方 Jenkins Docker 镜像（[https://hub.docker.com/_/jenkins](https://hub.docker.com/_/jenkins)）。该镜像包含
    Jenkins 的当前 LTS 版本（在撰写本文时为 v2.60.3）。
- en: 'To get started, on your terminal, create a bridge network in Docker with the
    following command:'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 要开始，在你的终端中，使用以下命令在 Docker 中创建一个桥接网络：
- en: '[PRE12]'
  id: totrans-201
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'We will need the Docker daemon to be able to provision Jenkins workers dynamically.
    That’s why we will deploy a Docker container based on the Docker image:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 我们需要 Docker 守护进程来动态配置 Jenkins 工作节点。这就是为什么我们将基于 Docker 镜像部署一个 Docker 容器：
- en: '[PRE13]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: To avoid exposing the Docker daemon (/var/run.docker.sock) running in the host
    machine, we will run a Docker container providing a self-service and ephemeral
    Docker Engine, which Jenkins will use instead of the worker machine’s Docker engine.
    This pattern is referred to as *Docker in Docker*, or *nested containerization*.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 为了避免暴露在主机机器上运行的 Docker 守护进程（/var/run.docker.sock），我们将运行一个提供自助和短暂 Docker 引擎的
    Docker 容器，Jenkins 将使用它而不是工作机的 Docker 引擎。这种模式被称为 *Docker in Docker*，或 *嵌套容器化*。
- en: We will override the Jenkins official image to install the Docker CLI and needed
    plugins for Jenkins. Create a Dockerfile with the content in the following listing.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将覆盖 Jenkins 官方镜像以安装 Docker CLI 和 Jenkins 所需的插件。创建一个包含以下列表内容的 Dockerfile。
- en: Listing 14.7 Dockerfile to build custom Jenkins image
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.7 构建自定义 Jenkins 镜像的 Dockerfile
- en: '[PRE14]'
  id: totrans-207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: ❶ Installs Docker community edition (CE) client
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 安装 Docker 社区版（CE）客户端
- en: ❷ Switches to Jenkins user to avoid running the container by default in privileged
    mode
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 切换到 Jenkins 用户，以避免默认以特权模式运行容器
- en: ❸ Installs the Jenkins plugins
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 安装 Jenkins 插件
- en: 'This Dockerfile does the following:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 此 Dockerfile 执行以下操作：
- en: Installs the Docker Community Edition CLI
  id: totrans-212
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安装 Docker 社区版 CLI
- en: 'Installs Jenkins plugins, including the following:'
  id: totrans-213
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安装 Jenkins 插件，包括以下内容：
- en: '*Blue Ocean*—Sophisticated visualizations of CD pipelines for fast and intuitive
    comprehension of software pipeline status'
  id: totrans-214
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*Blue Ocean*—对 CD 管道的高级可视化，快速直观地理解软件管道状态'
- en: '*Workflow*—A suite of plugins that lets you write pipelines as code (Jenkinsfiles)'
  id: totrans-215
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*Workflow*—一套插件，允许你将管道作为代码（Jenkinsfiles）编写'
- en: '*GitHub*—GitHub API integration and support of Git operations'
  id: totrans-216
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*GitHub*—GitHub API 集成和对 Git 操作的支持'
- en: '*Docker*—Lets you provision Jenkins workers on Docker containers'
  id: totrans-217
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*Docker*—允许你在 Docker 容器上配置 Jenkins 工作节点'
- en: 'Build a new Docker image from this Dockerfile and assign the image a meaningful
    name:'
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 从此 Dockerfile 构建一个新的 Docker 镜像，并为镜像分配一个有意义的名称：
- en: '[PRE15]'
  id: totrans-219
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Then, deploy a container based on the built image with the following `docker`
    `run` command:'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，使用以下`docker` `run`命令基于构建的镜像部署容器：
- en: '[PRE16]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: This command will map a Docker volume to the /var/jenkins_home folder. In case
    you need to restart or recover your Jenkins instance, all of the state is stored
    inside the Docker volume.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令将Docker卷映射到/var/jenkins_home文件夹。如果你需要重新启动或恢复Jenkins实例，所有状态都存储在Docker卷中。
- en: You can also build and deploy all the services by writing a docker-compose.yml
    file, as shown in the following listing.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以通过编写docker-compose.yml文件来构建和部署所有服务，如下所示。
- en: Listing 14.8 Grok custom patterns definition
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 列表14.8 Grok自定义模式定义
- en: '[PRE17]'
  id: totrans-225
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Run `docker-compose up`, and Docker Compose starts and runs Jenkins.
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 运行`docker-compose up`，Docker Compose将启动并运行Jenkins。
- en: 'Visit localhost:8080; you should see the login page. As a part of the Jenkins
    setup, we need to view the password inside the container instance; use the container
    ID (or the name) and run the `docker exec` command:'
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 访问localhost:8080；你应该看到登录页面。作为Jenkins设置的一部分，我们需要查看容器实例内的密码；使用容器ID（或名称）并运行`docker
    exec`命令：
- en: '[PRE18]'
  id: totrans-228
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: After running the command, you should see the code. Copy and paste it on the
    dashboard to unlock Jenkins; see figure 14.29.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 运行命令后，你应该看到代码。将其复制并粘贴到仪表板上以解锁Jenkins；见图14.29。
- en: '![](Images/CH14_F29_Labouardy.png)'
  id: totrans-230
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F29_Labouardy.png)'
- en: Figure 14.29 Jenkins server running inside a Docker container
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 图14.29 Jenkins服务器在Docker容器内运行
- en: To set up workers, choose Manage Jenkins and System Configuration. Then click
    the Configure tab in the Cloud section. The Docker option will be available. Set
    the Docker URI to `tcp://docker:2376`, as shown in figure 14.30\. Click the Test
    button to check the connection.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 要设置工作者，选择“管理Jenkins”和“系统配置”。然后在云部分点击“配置”标签。Docker选项将可用。将Docker URI设置为`tcp://docker:2376`，如图14.30所示。点击“测试”按钮以检查连接。
- en: '![](Images/CH14_F30_Labouardy.png)'
  id: totrans-233
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F30_Labouardy.png)'
- en: Figure 14.30 Configuring Docker remote API on Jenkins
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 图14.30在Jenkins上配置Docker远程API
- en: 'The Docker API should return an error: `server gave HTTP response to HTTPS
    client`. You need to configure the client TLS certificates to connect with the
    Docker daemon. The certificates can be found at the /certs/client folder within
    the Jenkins container.'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: Docker API应该返回一个错误：“服务器向HTTPS客户端返回HTTP响应”。你需要配置客户端TLS证书以连接到Docker守护进程。证书可以在Jenkins容器内的/certs/client文件夹中找到。
- en: 'Create a new Jenkins credential of type Certificate with the following settings:'
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个新的Jenkins凭据，类型为证书，并设置以下设置：
- en: '*Client Key*—/certs/client/key.pem content'
  id: totrans-237
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*客户端密钥*—/certs/client/key.pem内容'
- en: '*Client Certificate*—/certs/client/cert.pem content'
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*客户端证书*—/certs/client/cert.pem内容'
- en: '*Server CA Certificate*—/certs/client/ca.pem content'
  id: totrans-239
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*服务器CA证书*—/certs/client/ca.pem内容'
- en: The credential settings should look similar to those in figure 14.31.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 凭据设置应类似于图14.31中的设置。
- en: '![](Images/CH14_F31_Labouardy.png)'
  id: totrans-241
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F31_Labouardy.png)'
- en: Figure 14.31 Jenkins server deployed locally inside a Docker container
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 图14.31 Jenkins服务器在本地Docker容器内部署
- en: Then, we need to define an agent template, as shown in figure 14.32; this template
    is the blueprint used to spin up Jenkins workers. You need a Docker image that
    can be used to run the Jenkins agent runtime. You can use the jenkins/ssh-agent
    ([https://hub.docker.com/r/jenkins/ssh-agent](https://hub.docker.com/r/jenkins/ssh-agent))
    as a base for Jenkins workers. The image has SSHD installed (this listens for
    an incoming connection when you attempt to connect via SSH).
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们需要定义一个代理模板，如图14.32所示；此模板是启动Jenkins工作者的蓝图。你需要一个可以用来运行Jenkins代理运行时的Docker镜像。你可以使用jenkins/ssh-agent
    ([https://hub.docker.com/r/jenkins/ssh-agent](https://hub.docker.com/r/jenkins/ssh-agent))作为Jenkins工作者的基础。该镜像已安装了SSHD（当你尝试通过SSH连接时，它会监听传入的连接）。
- en: '![](Images/CH14_F32_Labouardy.png)'
  id: totrans-244
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F32_Labouardy.png)'
- en: Figure 14.32 Configuring a new Docker agent template
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 图14.32配置新的Docker代理模板
- en: You can also build a custom Docker agent image with all dependencies and packages
    needed to build your projects. To test it out, create a new Jenkins pipeline with
    the content shown in figure 14.33.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以构建一个包含所有依赖项和构建项目所需的软件包的自定义Docker代理镜像。为了测试它，创建一个新的Jenkins管道，内容如图14.33所示。
- en: '![](Images/CH14_F33_Labouardy.png)'
  id: totrans-247
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F33_Labouardy.png)'
- en: Figure 14.33 New inline pipeline
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 图14.33新的内联管道
- en: Trigger the pipeline by clicking the Build Now link from the left navigation
    menu; the job will launch a container and execute the pipeline (figure 14.34).
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: 通过点击左侧导航菜单中的“立即构建”链接来触发管道；作业将启动一个容器并执行管道（图14.34）。
- en: '![](Images/CH14_F34_Labouardy.png)'
  id: totrans-250
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH14_F34_Labouardy.png)'
- en: Figure 14.34 Spinning up the Jenkins agent based on a Docker container
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.34 基于Docker容器启动Jenkins代理
- en: The agents are provisioned dynamically and stopped after each build.
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 代理将在每次构建后动态配置并停止。
- en: Summary
  id: totrans-253
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: You can share common code and steps across multiple pipelines by writing a Jenkins
    shared library.
  id: totrans-254
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以通过编写Jenkins共享库来在多个管道中共享通用代码和步骤。
- en: You can define fine-grained control over user/group permissions per project
    with the Matrix Authorization Strategy plugin.
  id: totrans-255
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以使用矩阵授权策略插件对每个项目的用户/组权限进行细粒度控制。
- en: You can also create a custom role with a list of permissions and assign the
    role to users instead of assigning appropriate permissions to each user with the
    Role Strategy plugin.
  id: totrans-256
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您还可以使用角色策略插件创建一个具有权限列表的自定义角色，并将该角色分配给用户，而不是为每个用户分配适当的权限。
- en: Use GitHub’s own authentication scheme for implementing authentication in your
    Jenkins instance.
  id: totrans-257
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在您的Jenkins实例中实现身份验证时，请使用GitHub自己的身份验证方案。
- en: The Docker plugin will run dynamic Jenkins agents inside Docker containers.
  id: totrans-258
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Docker插件将在Docker容器内运行动态Jenkins代理。
- en: Wrapping up
  id: totrans-259
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 总结
- en: We’re at the end of our journey in this book. You learned about Jenkins and
    the pipeline-as-code approach. You discovered several CI/CD implementations for
    cloud-native applications, such as containerized applications in Kubernetes and
    serverless applications. You designed and deployed a Jenkins cluster on the cloud
    for scale and mastered monitoring and troubleshooting Jenkins.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在这本书中的旅程即将结束。您了解了Jenkins和代码化管道方法。您发现了针对云原生应用的几个CI/CD实现，例如Kubernetes中的容器化应用和无服务器应用。您设计和部署了云上的Jenkins集群以实现可扩展性，并精通了Jenkins的监控和故障排除。
- en: Technology changes quickly, so it’s great to have a few resources to go to for
    recent news and information. The weekly newsletter DevOps Bulletin ([https://devopsbulletin
    .com](https://devopsbulletin.com)) features a great collection of posts regarding
    PaC and the latest wonders in the DevOps space. I also recommend keeping an eye
    on DevOps World ([www.devopsworld .com](http://www.devopsworld.com)), where you
    can be inspired by experts and your peers and gain the tools you need to shape
    the future of software delivery at your organization and at large.
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 技术变化迅速，因此拥有一些可以获取最新新闻和信息资源的渠道是非常好的。每周的DevOps Bulletin ([https://devopsbulletin.com](https://devopsbulletin.com))
    特集了一系列关于PaC和DevOps领域最新奇的文章。我还建议关注DevOps World ([http://www.devopsworld.com](http://www.devopsworld.com))，在那里您可以受到专家和同行的启发，并获得您在组织内部和整体上塑造软件交付未来的工具。
- en: I hope you’ve enjoyed the book and learned something from it. PaC is still new,
    but awareness is growing rapidly. Over the next few years, you’ll see many organizations,
    small and large, embrace PaC to release faster and reduce the feedback loop.
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 我希望您喜欢这本书，并从中有所收获。PaC仍然很新，但意识正在迅速增长。在未来几年里，您将看到许多大小组织都将采用PaC以实现更快发布并缩短反馈循环。
