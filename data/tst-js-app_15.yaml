- en: 12 Continuous integration and continuous delivery
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 12 持续集成和持续交付
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Continuous integration (CI) and continuous delivery (CD)
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 持续集成（CI）和持续交付（CD）
- en: Reasons to adopt CI and CD
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 采用CI和CD的原因
- en: The role of tests in building a CI/CD pipeline
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 测试在构建CI/CD管道中的作用
- en: Version-control checks
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 版本控制检查
- en: The advantages of adopting version-control checks
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 采用版本控制检查的优势
- en: Louis always tells his staff not to bake different parts of a recipe without
    talking to each other. Pastry chefs who make an éclair’s choux pastry are frequently
    talking to others making its pastry cream and to those making its chocolate glazing.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 路易斯总是告诉他的员工在互相交流之前不要烘烤食谱的不同部分。制作闪电泡芙松饼皮的糕点师通常会与其他制作糕点奶油的人以及制作巧克力糖衣的人交流。
- en: When pastry chefs don’t talk to each other, they try to be more efficient by
    making all the pastry cream they possibly can or baking the bare minimum they
    need. The problem with this lack of communication is that, often, they’ll waste
    ingredients by making either too much cream or too little. If they make too much,
    the surplus gets thrown away because Louis doesn’t sell anything that isn’t fresh.
    If they make too little, it’s the choux pastry that gets thrown out, because there’s
    not enough cream to fill every éclair.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 当糕点师们不互相交流时，他们会通过尽可能多地制作糕点奶油或只烘烤所需的最少量来提高效率。这种缺乏沟通的问题在于，他们往往会因为制作过多的奶油或过少的奶油而浪费原料。如果他们制作过多，多余的奶油就会被扔掉，因为路易斯不卖任何不新鲜的东西。如果他们制作过少，那么被扔掉的就是松饼皮，因为奶油不够用来填充每个闪电泡芙。
- en: On the other hand, when his staff works together, they agree on how many éclairs
    they’ll bake and what should be their glazing’s flavor. They bake one batch at
    a time and continuously put together each one’s work to make fresh éclairs.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 另一方面，当他的员工一起工作时，他们会就制作多少个闪电泡芙以及糖衣应该是什么味道达成一致。他们一次烘烤一批，并持续地将每个人的工作组合起来制作新鲜的闪电泡芙。
- en: Combining their work early and frequently reduces waste because it guarantees
    that the pastry’s flavor goes well with the cream and that the glazing has the
    ideal level of sweetness to complement the rest.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 通过早期和频繁地结合他们的工作，可以减少浪费，因为这保证了糕点的风味与奶油相得益彰，糖衣的甜度理想，能够衬托其他部分。
- en: When developers write code in their own branch for a long time without integrating
    their work with others’ work, the consequences are similar.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 当开发者长时间在自己的分支上编写代码而不与其他人的工作集成时，后果是相似的。
- en: Developers who remain siloed for too long build on unstable foundations. If
    they work in isolation for too long, by the time they try to merge their work
    to the project’s main branch, the code upon which they’ve built might have already
    changed.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 长时间孤立工作的开发者建立在不稳定的基础上。如果他们长时间独立工作，等到他们尝试将他们的工作合并到项目的主要分支时，他们所建立的基础代码可能已经发生变化。
- en: Because the siloed developer took too long to integrate their work, they end
    up having to do a lot of rework and solve too many conflicts all at once, which
    is costly, risky, and frustrating.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 由于孤立工作的开发者整合工作的时间过长，他们最终不得不进行大量的返工，同时解决太多冲突，这既昂贵又风险高，令人沮丧。
- en: By continually integrating their work, developers reduce the amount of rework
    they have to do because they’re constantly making sure that the assumptions upon
    which they’re building are reliable. If anything changes, they can correct course
    earlier, avoid unnecessary work, and, therefore, reduce costs.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 通过持续集成他们的工作，开发者减少了他们必须做的返工量，因为他们一直在确保他们所建立的基础假设是可靠的。如果有什么变化，他们可以更早地纠正方向，避免不必要的劳动，从而降低成本。
- en: Another important part of making both bakers and software producers more efficient
    is to reduce the time it takes from someone coming up with a recipe to it being
    on a customer’s plate.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 使糕点师和软件生产者更高效的一个重要部分是减少从有人想出食谱到它出现在顾客盘子上所需的时间。
- en: By delivering earlier and delivering often, pastry chefs can adapt their recipes
    so that they become successful. When it comes to building software, early and
    frequent releases lead to less rework because it allows teams to get customer
    feedback sooner and, therefore, learn more about what to build next.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 通过更早和更频繁地交付，糕点师可以调整他们的食谱，使其变得成功。在构建软件方面，早期和频繁的发布导致更少的返工，因为这允许团队更早地获得客户反馈，因此可以更多地了解接下来要构建的内容。
- en: 'In this chapter, you’ll learn more about these two practices: continuous integration
    (CI) and continuous delivery (CD), which depends on the first.'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你将了解更多关于这两种实践：持续集成（CI）和持续交付（CD），后者依赖于前者。
- en: I’ll start the chapter by explaining continuous integration, continuous delivery,
    and how these two practices relate to each other. Besides understanding what they
    are, I’ll talk about their advantages and how to apply them.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 我将首先解释持续集成、持续交付以及这两种实践如何相互关联。除了了解它们是什么之外，我还会讨论它们的优点以及如何应用它们。
- en: Once you’ve learned about these two practices, I’ll explain the crucial role
    that tests have in building a CI/CD pipeline and how combining tests with these
    practices helps you produce better software faster, with less frustration, for
    less money.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你了解了这两种实践，我将解释测试在构建CI/CD管道中的关键作用，以及将测试与这些实践相结合如何帮助你更快、更少挫折、更经济地生产更好的软件。
- en: Finally, in this chapter’s third section, I’ll talk about how to integrate checks
    into your version-control system and how they can complement the practices about
    which you’ve learned.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，在本章的第三部分，我将讨论如何将检查集成到你的版本控制系统中，以及它们如何补充你已学到的实践。
- en: Throughout these sections, you’ll learn by understanding how I’d solve hypothetical
    situations faced by this book’s beloved pastry chef as he was building the online
    branch of his business.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，你将通过了解我是如何解决这本书所喜爱的糕点师在建立其业务在线分支时面临的假设情况来学习。
- en: NOTE Continuous integration and continuous delivery are extensive topics. This
    chapter covers only the essential information you need to get started and understand
    the role of tests when adopting these two practices.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：持续集成和持续交付是广泛的主题。本章仅涵盖你开始并理解在采用这两种实践时测试的作用所必需的基本信息。
- en: 'To see these two topics explored in-depth, I’d recommend the books *Continuous
    Integration: Improving Software Quality and Reducing Risk* by Paul M. Duvall,
    Steve Matyas, and Andrew Glover (Addison-Wesley Professional, 2007); and *Continuous
    Delivery: Reliable Software Releases through Build, Test, and Deployment Automation*
    by Jez Humble and David Farley (Addison-Wesley Professional, 2010).'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 为了深入了解这两个主题，我推荐以下书籍：Paul M. Duvall、Steve Matyas和Andrew Glover合著的《持续集成：提高软件质量和降低风险》（Addison-Wesley
    Professional，2007年）；以及Jez Humble和David Farley合著的《持续交付：通过构建、测试和部署自动化实现可靠的软件发布》（Addison-Wesley
    Professional，2010年）。
- en: 12.1 What are continuous integration and continuous delivery?
  id: totrans-24
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.1 什么是持续集成和持续交付？
- en: Successful businesses delight customers by communicating frequently, iterating
    quickly, delivering early, listening to feedback, and acting on it. These businesses
    focus on delivering delightful finished products rather than constantly working
    on mediocre new features.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 成功的企业通过频繁沟通、快速迭代、尽早交付、倾听反馈并据此行动来取悦客户。这些企业专注于交付令人愉悦的成品，而不是不断开发平庸的新功能。
- en: 'At the very core of these successful behaviors are two practices: continuous
    delivery and continuous integration.'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 这些成功行为的核心是两种实践：持续交付和持续集成。
- en: Doing continuous integration means frequently integrating your work with others’
    work. Continuous delivery means delivering products to your customers early and
    often.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 进行持续集成意味着频繁地将你的工作与其他人的工作集成在一起。持续交付意味着尽早和经常地向客户交付产品。
- en: In this section, you’ll understand how these two practices help make a business
    successful and how to apply them.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，你将了解这两种实践如何帮助企业成功，以及如何应用它们。
- en: 12.1.1 Continuous integration
  id: totrans-29
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.1.1 持续集成
- en: Louis’s cakes never fail to amuse a customer. The flavor of their filling, icing,
    and batter are *always* harmonic. Even though a separate pastry chef makes each
    part, these chefs frequently talk to each other and experiment combining their
    work as early as possible to ensure that ingredients go well together.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 路易的蛋糕总是能逗得顾客开心。他们的馅料、糖衣和面糊的味道总是*和谐*。尽管每个部分都是由单独的糕点师制作的，但这些糕点师经常互相交流，并尽可能早地尝试将他们的工作结合起来，以确保成分搭配得当。
- en: By frequently updating others on what they’re baking, pastry chefs can ensure
    they’re baking the right quantities, of the right thing, at the right time. They
    won’t, for example, bake a chocolate frosting and have to throw it away because
    their partner was baking a vanilla cheesecake. Otherwise, that would be a weird
    cheesecake.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 通过经常更新其他人他们正在烘焙的内容，糕点师可以确保他们烘焙的是正确的数量、正确的东西、正确的时间。例如，他们不会烘焙巧克力糖霜然后不得不丢弃它，因为他们的合作伙伴正在烘焙香草芝士蛋糕。否则，那将是一个奇怪的芝士蛋糕。
- en: Furthermore, by tasting the cake’s parts together, pastry chefs can figure out
    whether the icing needs to be less sugary to harmonize with the extra-sweet filling
    or vice versa.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，通过一起品尝蛋糕的不同部分，糕点师可以判断糖霜是否需要减少糖分以与额外的甜馅料相协调，反之亦然。
- en: Combining ingredients early reduces waste and rework. If different parts of
    a cake don’t go well together, a pastry chef will have spent less time before
    finding that out and won’t have to throw away a large amount of his work.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 早期结合成分可以减少浪费和返工。如果蛋糕的不同部分不搭配，糕点师在发现这一点之前花费的时间会更少，而且不需要丢弃大量他的工作。
- en: This practice—*continuous integration—*translates easily to the software world
    and yields similar benefits.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 这种实践——*持续集成*——很容易应用到软件世界中，并产生类似的好处。
- en: Imagine you’re implementing a feature that allows customers to apply discount
    coupons to their orders. To implement this feature, you’ve split off of the project’s
    main branch and started committing to your own feature branch.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 想象一下，你正在实现一个允许客户将折扣券应用于订单的功能。为了实现这个功能，你从项目的主分支分叉出来，并开始在自己的功能分支上提交代码。
- en: As you work on your discount coupons mechanism, another developer is working
    on automatically discounting bulk orders. This developer’s work interferes with
    yours because it changes a few fundamentals of how discounts work.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 当你正在处理折扣券机制时，另一位开发者正在自动折扣批量订单。这位开发者的工作干扰了你的工作，因为它改变了折扣工作的一些基本原理。
- en: If your team practices continuous integration, you’ll avoid having to do a significant
    amount rework to integrate these two changes.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的团队实践持续集成，你将避免在集成这两个更改时需要进行大量重工作。
- en: Continuous integration makes work less frustrating and more predictable because
    you will have fewer surprises when the time comes to merge the branch with your
    implementation of discount coupons.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 持续集成让工作不再令人沮丧，更加可预测，因为当合并分支与你的折扣券实现时，你将遇到 fewer surprises。
- en: Instead of doing a week’s worth of work only to figure out that what you’ve
    done on day two is no longer valid, you’ll frequently integrate your work with
    the project’s main branch, and so will your coworker. Therefore, you will constantly
    correct course as you develop your feature.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 你不会在做了整整一周的工作后才发现第二天所做的工作已经不再有效，你将频繁地将你的工作与项目的主分支集成，你的同事也是如此。因此，你将在开发功能的过程中不断纠正方向。
- en: In software engineering, constantly integrating your work with the project’s
    main branch is the equivalent of communicating the changes you’re doing, so that
    everyone is always working on top of a working version of your software.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 在软件工程中，不断将你的工作与项目的主分支集成相当于沟通你所做的更改，这样每个人都可以始终在软件的有效版本上工作。
- en: One major caveat is that the longer it takes to integrate work, the longer it
    takes to detect problems. Additionally, if integrating work is time-consuming,
    this practice won’t be as efficient, and developers won’t integrate work as often.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 一个主要的注意事项是，集成工作所需的时间越长，检测问题所需的时间就越长。此外，如果集成工作耗时，这种实践将不会那么高效，开发者也不会那么频繁地集成工作。
- en: Therefore, to make it as quick and painless as possible to integrate work, you
    should automate whatever you can to make it easier to validate the software whenever
    there are changes. Among the tasks you should automate are executing static analysis,
    enforcing code style, running tests, and building the project, as shown in the
    pipeline in figure 12.1.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，为了使集成工作尽可能快且痛苦最小，你应该自动化尽可能多的任务，以便在有任何更改时更容易验证软件。你应该自动化的任务包括执行静态分析、强制执行代码风格、运行测试和构建项目，如图12.1中的管道所示。
- en: TIP In addition to these automated checks, I recommend teams to adopt a code-review
    process before they merge code to the project’s main branch.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 小贴士：除了这些自动化检查之外，我建议团队在将代码合并到项目的主分支之前采用代码审查流程。
- en: Once these tasks are automated, it takes only a few seconds for a developer
    to know whether their work is valid when combined with the changes in the project’s
    main branch. Instead of delegating quality control to another team, you incorporate
    it *into* your build process so that you can tighten your feedback loop.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦这些任务自动化，开发者只需几秒钟就能知道他们的工作与项目主分支的更改结合后是否有效。你不需要将质量控制委托给另一个团队，而是将其**纳入**你的构建过程中，以便你可以缩短你的反馈循环。
- en: '![](../Images/CH12_F01_DaCosta.png)'
  id: totrans-45
  prefs: []
  type: TYPE_IMG
  zh: '![图12.1](../Images/CH12_F01_DaCosta.png)'
- en: Figure 12.1 When performing continuous integration, your CI server will automatically
    analyze, build, and test every change you submit.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.1 在执行持续集成时，你的CI服务器将自动分析、构建和测试你提交的每个更改。
- en: After automating your quality control processes and incorporating them *into*
    your build process, whenever a developer pushes work to the project’s repository,
    a continuous integration server should execute these automated tasks to continually
    monitor whether the software works as it should.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 在自动化你的质量控制流程并将它们**纳入**你的构建过程之后，每当开发者将工作推送到项目仓库时，持续集成服务器应执行这些自动化任务，以持续监控软件是否按预期工作。
- en: In addition to checking if the code submitted passes the tests and other automated
    validations, running these tasks in a separate environment helps to eliminate
    any possible inconsistencies among different developers’ machines. Additionally,
    it excludes the possibility of having bugs or inconsistent code due to developers
    forgetting to run tests or use static analysis tools.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 除了检查提交的代码是否通过测试和其他自动化验证之外，在单独的环境中运行这些任务有助于消除不同开发者机器之间可能存在的任何不一致性。此外，它排除了由于开发者忘记运行测试或使用静态分析工具而导致出现错误或不一致代码的可能性。
- en: Warning Adopting a continuous integration tool does *not* necessarily mean you’re
    practicing continuous integration.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 警告：采用持续集成工具**并不**一定意味着你正在实践持续集成。
- en: Teams that perform continuous integration frequently merge their work with the
    project’s main branch. Automating builds and validations and having a continuous
    integration server is a way to make those frequent integrations safer and quicker.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 经常执行持续集成的团队会频繁地将他们的工作与项目主分支合并。自动化构建和验证以及拥有持续集成服务器是使这些频繁集成更安全、更快捷的一种方式。
- en: If you use a continuous integration tool, but you integrate your work with the
    project’s main branch only once a month, you’re *not* doing continuous integration.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用持续集成工具，但每月只与项目主分支集成一次，你**不是**在进行持续集成。
- en: After you’ve adopted a continuous integration tool, you should then ensure that
    the build process of the project’s main branch is *always* working. If it breaks,
    you and your team must either fix it as soon as possible or rollback the changes
    that caused the failure. Otherwise, others will work on top of broken software.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 在你采用持续集成工具之后，你应该确保项目主分支的构建过程**始终**工作。如果它损坏了，你和你的团队必须尽快修复它，或者回滚导致失败的更改。否则，其他人将在损坏的软件之上工作。
- en: Additionally, if you have a broken build, you will forbid others from merging
    new code because, if they do, you won’t know whether their code has failures,
    too, given that the build is already broken. Furthermore, it will be more challenging
    to find the problem’s root cause because you’ll have more changes to investigate.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，如果你有一个损坏的构建，你将禁止其他人合并新代码，因为如果他们这样做，你将不知道他们的代码是否也有失败，因为构建已经损坏。此外，找到问题的根本原因将更具挑战性，因为你将需要调查更多的更改。
- en: Important Your continuous integration builds should *always* be working.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 重要：你的持续集成构建**始终**应该工作。
- en: Besides having quality control checks incorporated into builds that always pass
    on a continuous integration server, you should make sure that those builds happen
    quickly.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 除了将质量控制检查纳入始终在持续集成服务器上通过构建之外，你还应确保这些构建快速完成。
- en: Like what happens with tests, the more time it takes for a build to run, the
    longer it takes for developers to notice they’ve made mistakes. Additionally,
    slow builds can impact the team’s delivery rhythm because it will take time for
    everyone to get their changes merged and validated.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 就像测试一样，构建运行所需的时间越长，开发者发现他们犯错误的时间就越长。此外，缓慢的构建可能会影响团队的交付节奏，因为每个人都需要时间将他们的更改合并并验证。
- en: Continuous integration services
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 持续集成服务
- en: Since I’ve been working in tech, I’ve tried a wide array of continuous integration
    tools, from on-premises software to cloud services.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 自从我从事技术工作以来，我已经尝试了各种各样的持续集成工具，从本地软件到云服务。
- en: Unless you work at Big Co. or have strict requirements that enforce you to build
    code in your own servers, I’d highly recommend you to use on-premise third-party
    CI software, such as Drone, JetBrains’ TeamCity, or Jenkins.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 除非你在大型公司工作或你有严格的要求强制你在自己的服务器上构建代码，否则我强烈建议你使用本地第三方CI软件，如Drone、JetBrains的TeamCity或Jenkins。
- en: Otherwise, I’d opt for a cloud-based service. When I’m building software, I
    want to focus on building software, not on fixing the machine on which my continuous
    integration is running.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 否则，我会选择基于云的服务。当我构建软件时，我希望专注于构建软件，而不是修复我的持续集成正在运行的机器。
- en: If you opt for a cloud offering, my particular favorite is CircleCI. Besides
    being easy to set up, the service is reliable, and has extensive documentation.
    Additionally, CircleCI makes it easy for you to debug failing builds by allowing
    you to SSH into the servers on which the builds run. This feature will enable
    you to update configurations manually in the server itself as you retry builds
    to understand what’s causing those builds to fail.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你选择云服务，我特别喜欢的服务是CircleCI。除了易于设置外，该服务可靠，并且有广泛的文档。此外，CircleCI允许你通过SSH进入构建运行的服务器来调试失败的构建。这个功能将使你能够在服务器上手动更新配置，以便在重试构建时了解导致构建失败的原因。
- en: Other excellent options are TravisCI, which I’ve used extensively in open source
    projects, JetBrains’ managed TeamCity service, and GitLab CI.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 其他优秀的选择包括TravisCI，我在开源项目中广泛使用它，JetBrains管理的TeamCity服务，以及GitLab CI。
- en: The most important factors I’d consider when choosing one of these tools are
    their flexibility, security, and debuggability. Additionally, as you’ll see in
    this chapter’s final section, I consider it essential to be able to integrate
    those tools with your version-control system (VCS) provider.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 在选择这些工具时，我会考虑的最重要因素是它们的灵活性、安全性和可调试性。此外，正如你在本章的最后部分将看到的，我认为能够将工具与你的版本控制系统（VCS）提供商集成是至关重要的。
- en: Regardless of the tool you choose, remember that **it’s more important to practice
    continuous integrating your work with the project’s mainline than it is to select
    a fantastic continuous integration service**.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你选择哪种工具，请记住，**与项目主线持续集成你的工作比选择一个出色的持续集成服务更重要**。
- en: I’ve previously seen the same continuous integration service fail in some projects
    but succeed in others. The tool’s features were identical in both kinds of projects—what
    made the most difference was how disciplined developers were when it came to integrating
    their work.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 我之前看到同一个持续集成服务在一些项目中失败，但在其他项目中成功。这两种项目中的工具功能都是相同的——最大的区别在于开发人员在集成他们的工作时是否自律。
- en: 'NOTE You can find more about each of these tools at the following sites:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：你可以在以下网站上找到有关这些工具的更多信息：
- en: Drone—[https://drone.io](https://drone.io)
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Drone—[https://drone.io](https://drone.io)
- en: TeamCity—[https://jetbrains.com/teamcity](https://jetbrains.com/teamcity)
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: TeamCity—[https://jetbrains.com/teamcity](https://jetbrains.com/teamcity)
- en: Jenkins—[https://jenkins.io](https://jenkins.io)
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Jenkins—[https://jenkins.io](https://jenkins.io)
- en: CircleCI—[https://circleci.com](https://jenkins.io)
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CircleCI—[https://circleci.com](https://jenkins.io)
- en: TravisCI—[https://travis-ci.org](https://travis-ci.org)
  id: totrans-71
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: TravisCI—[https://travis-ci.org](https://travis-ci.org)
- en: GitLab CI—[https://docs.gitlab.com/ee/ci](https://docs.gitlab.com/ee/ci)
  id: totrans-72
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: GitLab CI—[https://docs.gitlab.com/ee/ci](https://docs.gitlab.com/ee/ci)
- en: 12.1.2 Continuous delivery
  id: totrans-73
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.1.2 持续交付
- en: One of the most valuable lessons you’ve learned from Louis’s pastry chefs is
    that delivering early and often helps businesses succeed.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 从路易斯的糕点师那里学到的最有价值的教训之一是，尽早和经常交付有助于企业成功。
- en: When developing new desserts, for example, it’s risky to bake a large batch
    at once and try to sell all of it, because the pastry chefs don’t yet know whether
    customers will like it.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，在开发新甜点时，一次性烘焙一大批并试图全部卖出是有风险的，因为糕点师还不知道顾客是否会喜欢它。
- en: If the bakery’s staff bakes a large batch of a dessert that the clientele thinks
    is sour, for example, they’ll have wasted a significant amount of time and resources.
    Instead, they bake a small batch, sell it to a few customers, and listen to their
    feedback. Then they iteratively improve the dessert and, therefore, waste fewer
    resources in the process.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果面包店的员工烘焙了一大批客户认为酸味过重的甜点，他们将浪费大量时间和资源。相反，他们先烘焙一小批，卖给几位客户，并听取他们的反馈。然后他们迭代地改进甜点，因此在这个过程中浪费的资源更少。
- en: As chefs try out these new recipes, they are also reluctant to present customers
    with terribly sour desserts, which would cause them not to come back. To avoid
    scaring customers with an experimental recipe, the bakery’s staff tastes the new
    desserts first and only then gradually sells the novel dessert to smaller cohorts
    of more receptive carbohydrate lovers.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 当厨师尝试这些新食谱时，他们也不愿意向客户提供味道极差的甜点，这可能会使他们不再回来。为了避免用实验性食谱吓到客户，面包店的员工首先品尝新甜点，然后才逐渐将新颖的甜点卖给更敏感的碳水化合物爱好者。
- en: If their customers don’t like the new offering, the staff quickly stops the
    taste-testing and gets back to the kitchen to improve the recipe. Otherwise, they
    start selling a recipe to a larger and larger number of customers.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 如果客户不喜欢新的产品，员工会迅速停止品尝测试，回到厨房改进食谱。否则，他们开始向越来越多的客户销售食谱。
- en: Continuously testing their desserts with customers keeps the bakery’s staff
    focused on making desserts successful instead of always trying to develop brand-new
    ones that don’t sell well enough.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 通过与客户持续测试甜点，面包店的员工能够专注于使甜点成功，而不是总是试图开发销售不佳的新产品。
- en: Additionally, by baking fewer desserts at a time, pastry chefs are less likely
    to get the cooking time wrong as they get used to the new recipe.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，通过每次烘焙较少的甜点，糕点师们不太可能出错，因为他们习惯了新的食谱。
- en: Finally, because they have to deliver new desserts frequently, they optimize
    the layout of their kitchen in favor of throughput and put in place the necessary
    metrics and processes for them to be able to determine whether a dessert is performing
    well.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，因为他们必须频繁地交付新的甜点，所以他们优化了厨房布局，以利于吞吐量，并建立了必要的指标和流程，以便他们能够确定甜点是否表现良好。
- en: If you apply this same practice—*continuous delivery—*to the software world,
    you’ll see analogous advantages.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您将这种相同的实践——*持续交付*——应用到软件世界中，您将看到类似的优点。
- en: As teams that practice continuous delivery complete their changes, instead of
    merely merging their work to the project’s main branch, they produce artifacts
    that they can immediately put into the hands of customers.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 对于实践持续交付的团队来说，在完成变更后，他们不仅将工作合并到项目的主分支，而是产生可以直接交给客户的工件。
- en: To be able to deploy an up-to-date version of their software at any point in
    time, these teams perform continuous integration to ensure that each commit to
    the project’s main branch takes the software from one valid working state to another.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 为了能够在任何时间点部署软件的最新版本，这些团队执行持续集成，以确保项目主分支的每次提交都将软件从一个有效的工作状态转换到另一个。
- en: Important As illustrated in figure 12.2, continuous integration is a prerequisite
    to being able to perform continuous deployment.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 重要 如图12.2所示，持续集成是能够执行持续部署的前提。
- en: As developers write code, to avoid delivering features that customers may not
    like or that may have bugs that haven’t yet been caught by automated tests, they
    roll out changes to a small cohort of more receptive users first.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 当开发者编写代码时，为了避免交付客户可能不喜欢或可能存在尚未被自动化测试捕获的bug的功能，他们首先将变更推出给一小群更敏感的用户。
- en: '![](../Images/CH12_F02_DaCosta.png)'
  id: totrans-87
  prefs: []
  type: TYPE_IMG
  zh: '![图12.2](../Images/CH12_F02_DaCosta.png)'
- en: Figure 12.2 You must already perform continuous integration before implementing
    continuous delivery. When practicing continuous delivery, each change you integrate
    must be releasable so that you can deploy an up-to-date version of your software
    whenever you want.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.2 在实施持续交付之前，您必须已经执行了持续集成。在实践持续交付时，您集成的每个变更都必须是可发布的，这样您就可以在需要时部署软件的最新版本。
- en: If anything goes wrong as they gradually roll out changes, teams that practice
    continuous delivery should have put in place mechanisms that allow them to quickly
    roll back changes and deploy a previous version of their software.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在逐步推出变更的过程中出现任何问题，实践持续交付的团队应该已经建立了机制，允许他们快速回滚变更并部署软件的先前版本。
- en: To illustrate the benefits of practicing continuous deployment on a software
    project, consider that you’re making major changes to the bakery’s backend service
    so that it can display a customer’s order status and, if an order has been dispatched,
    its location.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 为了说明在软件项目中实践持续部署的好处，考虑一下你正在对面包店的底层服务进行重大更改，以便它可以显示客户的订单状态，如果订单已发货，还可以显示其位置。
- en: Imagine what would happen if, for example, you tried to deploy this feature
    all at once, and its deployment failed because of one of the many lengthy database
    migrations you added. In that case, it would be hard to discover what part of
    which migration caused problems because there are more lines of code to investigate.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 想象一下，例如，如果你试图一次性部署这个功能，由于你添加的许多漫长的数据库迁移之一导致部署失败，会发生什么。在这种情况下，很难发现哪个迁移的哪个部分导致了问题，因为需要调查的代码行数更多。
- en: Had you been able to deploy your feature more frequently, and in smaller increments,
    you’d be able to find bugs and fix them more quickly because you’d have fewer
    lines of code to investigate as soon as the first failing migration ran.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你能够更频繁、分阶段地部署你的功能，你将能够更快地发现并修复错误，因为一旦第一次失败的迁移运行，你将需要调查的代码行数会更少。
- en: Additionally, deploying your order-tracking system more frequently and in smaller
    increments helps you tailor it to suit your customers’ needs. Instead of spending
    a lot of time on developing a detailed order-tracking system your customers may
    not need, you can build small parts at a time, listen to your customers’ feedback,
    and deliver the exact product they want.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，更频繁且分阶段地部署你的订单跟踪系统可以帮助你根据客户的需求进行调整。你不必花费大量时间开发客户可能不需要的详细订单跟踪系统，而是可以分阶段构建，听取客户的反馈，并交付他们真正想要的产品。
- en: TIP Feature flags are a useful technique to enable teams to perform continuous
    deployment.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 小贴士：功能标志是一种有用的技术，可以帮助团队执行持续部署。
- en: By deploying new features behind feature flags, developers can send to production
    code that doesn’t yet impact users or that is available only for a small percentage
    of them.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 通过在功能标志后面部署新功能，开发者可以向生产代码发送尚未影响用户或仅对一小部分用户可用的代码。
- en: Besides allowing developers to ship code more often, feature flags reduce communication
    overhead because they separate the process of making features available from the
    process of deploying them.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 除了让开发者更频繁地发布代码外，功能标志还能减少通信开销，因为它们将功能可用性和部署过程分开。
- en: Additionally, you can use feature flags to hide certain parts of the application
    that aren’t yet ready for users to see, such as screens whose UI is incomplete.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，你可以使用功能标志来隐藏应用程序中尚未准备好供用户查看的部分，例如UI不完整的屏幕。
- en: If you’d like to learn more about feature flags, I’d highly recommend Pete Hodgson’s
    post on this subject on Martin Fowler’s website at [https://martinfowler.com/articles/feature-toggles.html](https://martinfowler.com/articles/feature-toggles.html).
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想要了解更多关于功能标志的信息，我强烈推荐你阅读Pete Hodgson在Martin Fowler网站上关于这个主题的文章，网址为[https://martinfowler.com/articles/feature-toggles.html](https://martinfowler.com/articles/feature-toggles.html)。
- en: Imagine, for example, how disastrous it would be to spend three months building
    a detailed order-tracking system only to find out that customers care only about
    whether their order has been placed successfully.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，想象一下，如果你花费了三个月时间构建一个详细的订单跟踪系统，却发现客户只关心他们的订单是否成功提交，这将多么灾难性。
- en: By splitting the order-tracking system into smaller deliverables, you would
    have reduced the risk of the project by getting early feedback. This early feedback
    would’ve helped you understand what matters to your customers and, therefore,
    avoid writing unnecessary code. In this case, for example, instead of writing
    an entire order-tracking system, you could’ve built a small piece of software
    that, once an order has been accepted, sends an SMS or email to the customers.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 通过将订单跟踪系统拆分为更小的可交付成果，你可以通过获得早期反馈来降低项目风险。这种早期反馈将帮助你了解客户关心什么，因此可以避免编写不必要的代码。例如，在这种情况下，你本可以构建一个小型的软件，一旦订单被接受，就会向客户发送短信或电子邮件。
- en: Important Delivering early and frequently shifts your focus from writing as
    much code as possible to providing as much *value* as possible.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示：尽早和频繁地交付可以将你的重点从尽可能多地编写代码转移到尽可能多地提供价值。
- en: Code that sits on your version-control system doesn’t deliver any value to your
    customers. The earlier you put your software into the hands of customers, the
    earlier it starts delivering value.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 存放在你的版本控制系统中的代码不会为你的客户提供任何价值。你越早将软件交到客户手中，它就越早开始创造价值。
- en: Finally, if you and your team have to deploy changes frequently, you’d have
    a stronger reason to automate as much of the deployment process as you can. Otherwise,
    these slow deployments would significantly slow down the feedback loop, thus diminishing
    the benefits of performing continuous delivery and reducing the whole team’s throughput.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，如果你和你的团队需要频繁部署变更，你就有更强的理由尽可能自动化部署过程。否则，这些缓慢的部署会显著减慢反馈循环，从而降低执行持续交付的好处，并减少整个团队的吞吐量。
- en: As I’ve illustrated, teams that perform continuous delivery reduce their deployments’
    risks and usually spend less time on deployments due to the automation they’ve
    put in place. These teams get earlier feedback to build the product their customers
    want, not the product they *think* customers want.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 正如我之前所阐述的，执行持续交付的团队可以降低部署的风险，并且由于他们实施的自动化，通常在部署上花费的时间更少。这些团队能够更早地获得反馈，以构建客户真正需要的而不是他们认为客户需要的产品。
- en: Warning **Continuous delivery is different from continuous deployment.** When
    you perform continuous delivery, your team *can* deploy your project’s main branch
    to production at any point in time. Ideally, these deployments should be as automated
    as possible. Yet, a human still needs to decide to “push the button.” Continuous
    deployment takes continuous delivery a step further.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 警告 **持续交付与持续部署不同。** 当你执行持续交付时，你的团队可以在任何时间点将项目的主分支部署到生产环境中。理想情况下，这些部署应该尽可能自动化。然而，仍然需要有人决定“按下按钮”。持续部署将持续交付推进了一步。
- en: Teams that practice continuous deployment have their code automatically deployed
    to production whenever a new successful build happens on the project’s main branch.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 实践持续部署的团队，每当项目主分支上发生新的成功构建时，他们的代码会自动部署到生产环境中。
- en: Because there is no need for a human to press the “deployment” button, changes
    get to production even faster.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 由于不需要有人按下“部署”按钮，变更可以更快地进入生产环境。
- en: When performing continuous deployment, every release is sent to production automatically,
    as shown in figure 12.3.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 在执行持续部署时，每个版本都会自动发送到生产环境中，如图12.3所示。
- en: '![](../Images/CH12_F03_DaCosta.png)'
  id: totrans-109
  prefs: []
  type: TYPE_IMG
  zh: '![图12.3 持续部署时，每个版本都会自动发送到生产环境中](../Images/CH12_F03_DaCosta.png)'
- en: Figure 12.3 When performing con-tinuous deployment, every release is sent to
    production automatically.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.3 在执行持续部署时，每个版本都会自动发送到生产环境中。
- en: As you move from continuous integration to continuous delivery, and then toward
    continuous deployment, the pace of releases becomes quicker, forcing you to implement
    more sophisticated deployment techniques and put in place more automation, better
    monitoring, and more reliable quality guarantees.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 当你从持续集成过渡到持续交付，然后向持续部署迈进时，发布速度会加快，迫使你实施更复杂的部署技术，并实施更好的监控和更可靠的质量保证。
- en: 12.2 The role of automated tests in a CI/CD pipeline
  id: totrans-112
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.2 自动化测试在CI/CD流水线中的作用
- en: Tasting a sample of a dessert before selling the whole batch to customers is
    an essential activity in Louis’s bakery. It helps ensure that whatever chefs deliver
    to customers will be up to Louis’s rigorous quality standards.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 在将整个批次的甜点卖给客户之前先品尝样品，这是路易斯面包店的一项基本活动。这有助于确保提供给客户的任何东西都符合路易斯严格的品质标准。
- en: Similarly, testing your software before delivering it to your customers helps
    you prevent shipping bugs.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 同样，在将软件交付给客户之前测试你的软件可以帮助你防止发布带有错误的产品。
- en: Testing your software is time-consuming. Therefore, the more often you have
    to do it, the more expensive your tests become.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 测试你的软件是耗时的。因此，你不得不更频繁地进行测试，你的测试成本就会越高。
- en: Considering that continuous delivery will enforce your team to deliver software
    more frequently, it can quickly ramp up your costs if you don’t have efficient
    automated tests.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑到持续交付将迫使你的团队更频繁地交付软件，如果你没有高效的自动化测试，它可能会迅速增加你的成本。
- en: By having automated tests, you reduce deployments’ costs because machines can
    validate your software way more rigorously than a human could, much more quickly,
    for virtually zero cost.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 通过实施自动化测试，你可以降低部署成本，因为机器可以比人类更严格、更快地验证你的软件，几乎不需要成本。
- en: '**Automated testing is the most crucial technique to enable a team to perform
    continuous delivery because it allows you to increase your delivery frequency
    without significantly increasing your costs**.'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: '**自动化测试是使团队能够执行持续交付的最关键技术，因为它允许你在不显著增加成本的情况下提高交付频率**。'
- en: These tests are integrated into what’s usually called a CI/CD pipeline, which
    runs in your continuous integration service and is responsible for automatically
    validating your software and preparing any artifacts necessary for a release.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 这些测试集成到通常称为 CI/CD 流程中，在持续集成服务中运行，负责自动验证你的软件并准备任何必要的发布工件。
- en: Warning Setting up a continuous integration routine is different from implementing
    a CI/CD pipeline.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 警告 设置持续集成流程与实施 CI/CD 流程不同。
- en: When performing continuous integration, your team will **validate** its software
    every time someone pushes code to the project’s main branch. This validation process
    may include trying to build the application, running tests, and performing static
    analysis.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 在执行持续集成时，每当有人向项目的主要分支推送代码时，你的团队将**验证**其软件。此验证过程可能包括尝试构建应用程序、运行测试和执行静态分析。
- en: A CI/CD pipeline, besides **validating** your software, prepares any artifacts
    necessary for releases so that you can deploy them by “pushing a button.”
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: CI/CD 流程除了**验证**你的软件外，还准备任何必要的发布工件，以便你可以通过“按按钮”来部署它们。
- en: If you are writing a Node.js application, for example, your CI/CD pipeline can
    validate it, build the necessary containers, and push them to a container repository.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果你正在编写 Node.js 应用程序，你的 CI/CD 流程可以验证它，构建必要的容器，并将它们推送到容器仓库。
- en: After your pipeline runs, you will be able to quickly deploy your software by
    pushing a button because you won’t have to build containers again. Instead, you’ll
    simply pull what’s already built.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 在你的流程运行后，你可以通过按按钮快速部署你的软件，因为你不需要再次构建容器。相反，你只需简单地拉取已经构建好的内容。
- en: Additionally, to test the deployment process itself, you should have a separate
    production-like environment to which you deploy your software.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，为了测试部署过程本身，你应该有一个类似生产环境的独立环境，将你的软件部署到该环境中。
- en: As you increase the frequency of deployments, you’ll have to increase the number
    of automatic validations your CI/CD pipeline performs. These validations should
    give you quick and precise feedback so that you can detect mistakes earlier. Otherwise,
    you’re more likely to ship bugs.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 随着你增加部署的频率，你将不得不增加 CI/CD 流程执行的自动验证数量。这些验证应该提供快速而精确的反馈，以便你能够尽早发现错误。否则，你更有可能发布带有错误的软件。
- en: To make these validations as valuable as possible, besides your standard unit
    and integration tests, your CI/CD pipeline must include end-to-end tests and,
    if possible, acceptance tests similar to the ones you saw in chapter 10.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使这些验证尽可能有价值，除了你的标准单元和集成测试外，你的 CI/CD 流程必须包括端到端测试，如果可能的话，还应包括类似于第 10 章中看到的验收测试。
- en: End-to-end and acceptance tests are especially important in the context of a
    CI/CD pipeline because they’re the tests that most resemble your users’ behavior,
    and, therefore, are the ones more likely to prevent you from shipping bugs.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 端到端和验收测试在 CI/CD 流程的背景下尤为重要，因为它们是最接近用户行为的测试，因此更有可能防止你发布带有错误的软件。
- en: Important When building your CI/CD pipeline, make sure to include not only unit
    and integration tests but also end-to-end and acceptance tests.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 重要 当构建你的 CI/CD 流程时，确保不仅包括单元和集成测试，还包括端到端和验收测试。
- en: Besides making deployments quicker and cheaper, effective tests incentivize
    your team to deploy more often because they reduce the amount of work necessary
    for code to get to production. Like tests, the quicker your deployment is, the
    more often it will happen.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 除了使部署更快、更便宜之外，有效的测试还能激励你的团队更频繁地部署，因为它们减少了代码到达生产所需的工量。像测试一样，你的部署越快，发生的频率就越高。
- en: Despite tests’ potential for detecting mistakes, they can’t *always* guarantee
    your application is bug-free. Therefore, they don’t eliminate the need for manual
    verification. If you have a QA team, its professionals will still be valuable
    when it comes to performing manual and exploratory testing, as I explained in
    chapter 2.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管测试有检测错误的能力，但它们**并不总是**能保证你的应用程序没有错误。因此，它们不能消除手动验证的需要。如果你有一个质量保证团队，其专业人员在进行手动和探索性测试时仍然很有价值，正如我在第
    2 章中解释的那样。
- en: Yet, to make the entire validation process quicker, despite the need for manual
    verification, you can take advantage of mechanisms that allow you to detect bugs
    earlier and minimize their impact. Such mechanisms include having monitoring in
    place and using feature flags to gradually roll out changes.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管需要手动验证，但为了使整个验证过程更快，您可以利用允许您更早检测到错误并最小化其影响的机制。这些机制包括实施监控和使用功能标志逐步推出更改。
- en: 12.3 Version-control checks
  id: totrans-133
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.3 版本控制检查
- en: At Louis’s bakery, no one ever covers a giant cake with chocolate frosting before
    tasting the frosting itself. Otherwise, if the frosting is not sweet enough, instead
    of going to a customer’s mouth, the whole cake goes into the trash.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 在路易斯的面包店，没有人会在品尝巧克力霜之前就把它涂在巨大的蛋糕上。否则，如果巧克力霜不够甜，整个蛋糕就会直接进入垃圾桶。
- en: Trying individual parts of a recipe before combining them allows a pastry chef
    to avoid mixing an inedible filling with an otherwise sublime dough.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 在将配料混合之前尝试它们的单独部分，允许糕点师避免将不可食用的馅料与原本完美的面团混合。
- en: Version-control checks, shown in the pipeline in figure 12.4, have a similar
    role in the process of developing software. By automatically validating the code
    developers push before they can merge it, version-control checks guarantee that
    a team won’t add broken code to an otherwise healthy codebase.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 版本控制检查，如图12.4所示，在软件开发过程中起着类似的作用。通过在开发者合并代码之前自动验证他们推送的代码，版本控制检查确保团队不会将损坏的代码添加到本应健康的代码库中。
- en: '![](../Images/CH12_F04_DaCosta.png)'
  id: totrans-137
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../Images/CH12_F04_DaCosta.png)'
- en: Figure 12.4 Version-control checks can prevent your team from producing invalid
    releases.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.4 版本控制检查可以防止您的团队发布无效的版本。
- en: These checks can happen either locally as you commit code or before you push
    it or once your changes get to a remote repository.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 这些检查可以在您提交代码时本地发生，或者在您推送代码之前，或者一旦您的更改到达远程仓库。
- en: In the first case, these local checks usually happen through Git hooks. These
    hooks allow you to execute programs as a developer performs specific actions in
    a repository.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 在第一种情况下，这些本地检查通常通过Git钩子来完成。这些钩子允许您在开发者在仓库中执行特定动作时执行程序。
- en: You can, for example, configure a precommit hook that lints your code, executes
    tests, and prevents developers from committing code that doesn’t pass these validations.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，您可以配置一个precommit钩子，该钩子检查您的代码，执行测试，并阻止开发者提交未通过这些验证的代码。
- en: To configure such an automatic validation, you can use the package `husky`,
    whose documentation you can find at [https://github.com/typicode/husky](https://github.com/typicode/husky).
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 要配置这种自动验证，您可以使用`husky`包，其文档可以在[https://github.com/typicode/husky](https://github.com/typicode/husky)找到。
- en: After installing `husky`, creating hooks is as easy as adding a `husky` property
    to your `package.json` file, which contains the commands you want to run when
    different kinds of actions happen in your version-control system.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 安装`husky`后，创建钩子就像在`package.json`文件中添加一个`husky`属性一样简单，该文件包含您希望在版本控制系统中发生不同动作时运行的命令。
- en: Listing 12.1  package.json
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.1 package.json
- en: '[PRE0]'
  id: totrans-145
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: ❶ Automatically lints the code before consolidating a commit
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 在合并提交前自动检查代码
- en: ❷ Automatically runs tests before pushing the code
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 在推送代码前自动运行测试
- en: The downside of running these kinds of validations as users perform actions
    locally is that they can slow a developer’s workflow. Even though developers can
    append a `--no-verify` option to their Git commands to prevent these hooks from
    running, using this option defeats the purpose of having these hooks in the first
    place.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 当用户在本地执行操作时运行这些类型的验证的缺点是，它们可能会减慢开发者的工作流程。尽管开发者可以在Git命令中添加`--no-verify`选项来防止这些钩子运行，但使用此选项就失去了设置这些钩子的初衷。
- en: Personally, I limit my Git hooks to actions that terminate quickly. I do not
    run linting or testing before each commit, for example. Instead, I run code-formatting
    tools, such as Prettier.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 个人来说，我限制我的Git钩子只执行快速终止的动作。例如，我不会在每个提交之前运行代码检查或测试。相反，我会运行代码格式化工具，如Prettier。
- en: Then, to make sure that my team will review and merge only valid code, I configure
    my version-control provider to trigger a continuous integration pipeline. This
    pipeline then runs slower validations like linting and testing. If these validations
    fail, my version-control provider disallows the rest of my team from merging my
    code until I’ve fixed it.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，为了确保我的团队能够审查并合并只有有效代码，我配置了我的版本控制提供者以触发持续集成管道。这个管道随后运行更慢的验证，如代码风格检查和测试。如果这些验证失败，我的版本控制提供者将不允许我的团队在我修复之前合并我的代码。
- en: Besides linting and testing, you can also configure other kinds validations.
    You can, for example, validate that each pull request never decreases the percentage
    of code covered by tests.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 除了代码风格检查和测试之外，你还可以配置其他类型的验证。例如，你可以验证每个拉取请求都不会降低测试覆盖的代码百分比。
- en: 'Thanks to these automatic validations, you don’t need to rely on humans to
    remember they must execute any commands. Instead, you let humans be creative and
    delegate to the machines the work at which they’re better: flawlessly performing
    repetitive tasks.'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 多亏了这些自动验证，你不需要依赖人类去记住他们必须执行任何命令。相反，你让人类发挥创造力，将他们更擅长的重复性工作委托给机器：完美地执行重复性任务。
- en: Summary
  id: totrans-153
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: Teams that practice continuous integration frequently integrate their code instead
    of working on long-lived feature branches that only get merged when the entire
    set of changes is complete.
  id: totrans-154
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实践持续集成的团队经常集成他们的代码，而不是在长期存在的功能分支上工作，这些分支只有在所有更改都完成时才会合并。
- en: In case a continuous integration build fails, the developer who broke it must
    either fix the build as soon as possible or roll back their changes. Otherwise,
    these failing builds can cause others to work on top of broken software. Additionally,
    when a build is already failing, you won’t know whether new changes have problems,
    too, and it will be more challenging to find the failure’s root cause.
  id: totrans-155
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果持续集成构建失败，破坏构建的开发者必须尽快修复构建或回滚他们的更改。否则，这些失败的构建可能导致其他人基于损坏的软件工作。此外，当构建已经失败时，你将不知道新更改是否也存在问题，这将更难以找到失败的根本原因。
- en: Continuous integration facilitates communication among developers because it
    leads them to integrate their work more often. Therefore, they’re more frequently
    updated in regard to what’s happening in the codebase.
  id: totrans-156
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 持续集成促进了开发者之间的沟通，因为它促使他们更频繁地集成他们的工作。因此，他们能更频繁地了解代码库中的最新动态。
- en: When teams practice continuous integration, they decrease the amount of rework
    they need to do because they’ll have a tighter feedback loop. This tight feedback
    loop helps developers correct course as they implement changes instead of forcing
    them to spend a significant amount of time fixing conflicts or rewriting code
    because the underlying software changed.
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当团队实践持续集成时，他们减少了需要重做的工作量，因为他们将拥有更紧密的反馈循环。这个紧密的反馈循环有助于开发者在他们实施更改时纠正方向，而不是迫使他们花费大量时间解决冲突或重写代码，因为底层软件已经改变。
- en: To expedite the process of integrating a developer’s changes, teams that practice
    continuous integration use a CI server that automatically builds, analyzes, and
    tests the submitted code.
  id: totrans-158
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为了加快集成开发者更改的过程，实践持续集成的团队使用CI服务器来自动构建、分析和测试提交的代码。
- en: Performing these validations on a CI server assists developers in eliminating
    inconsistencies between their own development environments and others’ environments.
    This practice helps a team prevent merging code that works in one way on a developer’s
    machine and in another once it’s deployed.
  id: totrans-159
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在CI服务器上执行这些验证有助于开发者消除他们自己的开发环境与其他人环境之间的一致性问题。这种做法有助于团队防止合并那些在开发者的机器上以一种方式工作，一旦部署就以一种不同方式工作的代码。
- en: The faster your builds are, the earlier developers will be able to detect and
    correct mistakes. Additionally, fast builds will accelerate the speed with which
    developers integrate their code because they will quickly know whether they’ve
    submitted valid code.
  id: totrans-160
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你的构建越快，开发者就越早能够检测并纠正错误。此外，快速的构建将加速开发者集成代码的速度，因为他们将很快知道他们是否提交了有效的代码。
- en: Teams that practice continuous delivery can release the latest version of their
    software at any point in time.
  id: totrans-161
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实践持续交付的团队可以在任何时间点发布他们软件的最新版本。
- en: To be able to release software whenever they want, these teams must practice
    continuous integration to validate that each change in the project’s main branch
    takes the code from one working state to another.
  id: totrans-162
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为了能够随时发布软件，这些团队必须实践持续集成，以验证项目主分支中的每个更改都能将代码从一个工作状态转换到另一个状态。
- en: Being able to deliver code more frequently helps developers take smaller, iterative
    steps and validate their software as they build it instead of performing unnecessary
    work upfront.
  id: totrans-163
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 能够更频繁地交付代码有助于开发者采取更小、更迭的步骤，并在构建软件时验证它们，而不是在前期进行不必要的操作。
- en: Delivering code earlier causes developers to focus on delivering value sooner
    instead of writing the largest number of lines of code they can. Pieces of software
    that sit in a version-control system do not deliver value. Software delivers value
    only when it’s in the hands of customers.
  id: totrans-164
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 早期交付代码导致开发者更专注于尽快交付价值，而不是编写尽可能多的代码行数。存放在版本控制系统中的软件不会产生价值。软件只有在客户手中时才能产生价值。
- en: Continuous delivery incentivizes teams to automate tasks as much as they can
    so that releasing doesn’t become a significant burden. Besides implementing deployment
    processes that can happen “at the push of a button,” they put in place the necessary
    mechanisms to monitor their software after deploying it.
  id: totrans-165
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 持续交付激励团队尽可能自动化任务，以便发布不会成为重大的负担。除了实施可以“一键”发生的部署流程外，他们还建立了必要的机制来监控部署后的软件。
- en: Tests are crucial for practicing continuous integration and continuous delivery
    because both of these practices take an iterative approach to software development.
    Consequently, the more iterations you need, the more important tests become, because
    the more often they run, the more they save you time, and, therefore, the more
    value they deliver.
  id: totrans-166
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 测试对于实践持续集成和持续交付至关重要，因为这两种实践都采用迭代的方法进行软件开发。因此，你需要更多的迭代，测试就越重要，因为它们运行得越频繁，就能为你节省更多时间，因此它们带来的价值就越大。
- en: To prevent developers from accidentally merging inadequate code, you can implement
    checks tied to your version-control system. Such checks can happen either locally,
    through the use of hooks, or remotely, by triggering actions in your VCS provider.
  id: totrans-167
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为了防止开发者意外合并不合适的代码，你可以实施与你的版本控制系统相关的检查。这些检查可以本地发生，通过使用钩子，或者远程触发你的版本控制系统提供商中的操作。
- en: Local hooks should be fast so as not to hinder a developer’s progress. As developers
    commit code, these hooks will trigger actions that quickly validate and adjust
    code, such as executing code formatters.
  id: totrans-168
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本地钩子应该快速，以免阻碍开发者的进度。随着开发者提交代码，这些钩子将触发快速验证和调整代码的操作，例如执行代码格式化器。
- en: The checks that happen on your VCS may include blocking merges if the build
    process fails on the continuous integration tool you use or if the new changes
    decrease the percentage of code covered.
  id: totrans-169
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在你的版本控制系统中发生的检查可能包括阻止合并，如果你在持续集成工具中构建过程失败，或者新更改降低了代码覆盖率百分比。
- en: Implementing such checks frees humans to be creative and delegates to a machine
    the tedious and repetitive tasks in which it excels.
  id: totrans-170
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实施此类检查可以释放人类进行创新，并将机器擅长且繁琐重复的任务委托给机器。
