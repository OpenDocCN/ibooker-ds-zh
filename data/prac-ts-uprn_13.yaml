- en: Chapter 13\. Healthcare Applications
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第13章。医疗应用
- en: 'In this chapter we will look at time series analysis in the healthcare context
    with two case studies: Flu forecasting and nowcasting and Blood glucose forecasting.
    >These are both important healthcare applications for common health problems.
    Also, in both cases these are not solved problems but rather topics of ongoing
    research in academia and in the healthcare industry.'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将在医疗背景下进行时间序列分析，涉及两个案例研究：流感预测和即时预测以及血糖预测。 >这两者都是常见健康问题的重要医疗应用。此外，在这两种情况下，这些都不是解决的问题，而是学术界和医疗行业正在研究的课题。
- en: Predicting the Flu
  id: totrans-2
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 预测流感
- en: Predicting the flu rate from week to week in a given geographic area is a longstanding
    and ongoing problem. Infectious disease specialists and global security professionals
    alike agree that infectious diseases pose a [significant risk to human welfare](https://perma.cc/ZDA8-AKX6).
    This is particularly the case for the flu, which strikes the vulnerable worldwide,
    inflicting hundreds of fatalities every year, mostly among the very young and
    very old. It’s crucial from both a health and national security standpoint to
    develop accurate models of how the flu will run its course in a given season.
    Flu prediction models are useful both to predict the virus specifically and also
    to help researchers explore general theories for how infectious diseases travel
    geographically.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在给定地理区域内从一周到另一周预测流感率是一个长期而持续的问题。传染病专家和全球安全专业人员一致认为，传染病对人类福祉构成[重大风险](https://perma.cc/ZDA8-AKX6)。对于流感来说尤为如此，它在全球范围内侵袭弱势群体，每年造成数百人死亡，大多数是婴幼儿和老年人。从健康和国家安全的角度来看，开发流感在给定季节中的准确模型至关重要。流感预测模型不仅有助于具体预测病毒，还帮助研究人员探索传染病地理传播的一般理论。
- en: A Case Study of Flu in One Metropolitan Area
  id: totrans-4
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 一个大都市地区流感的案例研究
- en: We’ll look at a data set of weekly flu reports for a variety of administrative
    regions in France for the years of 2004 through 2013\. We will predict the flu
    rate for Île de France, the Paris metropolitan region. The data can be downloaded
    from [Kaggle](https://perma.cc/W9VQ-UUJC)^([1](ch13.html#idm45576020450136)) and
    is also available in the code repository for this book.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将研究2004年至2013年法国各行政区域每周流感报告的数据集。我们将预测巴黎大都会地区Île de France的流感率。可以从[Kaggle](https://perma.cc/W9VQ-UUJC)^([1](ch13.html#idm45576020450136))下载数据，也可以在本书的代码库中找到。
- en: Data exploration and some cleanup
  id: totrans-6
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 数据探索和一些清理工作
- en: 'We begin by familiarizing ourselves with the raw data, first examining it in
    tabular form:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 我们首先要熟悉原始数据，首先以表格形式进行检查：
- en: '[PRE0]'
  id: totrans-8
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'We also do some basic quality checks, such as looking for `NA` in our variables
    of interest. We may not know where these `NA` values come from, but we need to
    account for them:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还进行一些基本的质量检查，比如在我们感兴趣的变量中查找`NA`。我们可能不知道这些`NA`值来自哪里，但我们需要对其进行处理：
- en: '[PRE1]'
  id: totrans-10
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: The overall rate of `NA` data points is not very high. Additionally, our region
    of interest, Île-de-France, is not included in the list of regions with `NA` values.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 整体`NA`数据点的比率并不是很高。此外，我们感兴趣的Île-de-France地区不在`NA`值列表中。
- en: 'We perform some data cleanup, separating out the week and year portion of the
    timestamp column (which is currently in character format, not numerical or timestamp
    format):'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 我们进行一些数据清理工作，将时间戳列的周和年份部分分开（目前是字符格式，而不是数值或时间戳格式）：
- en: '[PRE2]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'We add a `Date` class column so we can have better plotting axes for time than
    if we treated the data as nontimestamped:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 我们添加了一个`Date`类列，以便在时间绘图中有更好的绘图轴，而不是将数据视为非时间戳形式：
- en: '[PRE3]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'This line of code is slightly tricky. To convert the month-week combinations
    into dates, we add a component indicating the day. This is the purpose of `paste0()`,
    which marks each date as the first day of the week, pasting a `"1"` onto a string
    that already designates year and week of the year (out of 52 weeks of the year—more
    on this shortly).^([2](ch13.html#idm45576020181752)) Notice the `%U` and `%u`
    in the format string: these have to do with marking time according to the week
    of the year and day of the week, a somewhat unusual timestamping format.^([3](ch13.html#idm45576020179704))'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 这行代码稍微有些复杂。为了将月份-周数组合转换为日期，我们添加了一个表示天的组件。这就是`paste0()`的目的，它将每个日期标记为周的第一天，将一个`"1"`粘贴到已经指定了年份和周数的字符串中（一年52周——稍后详述）。^([2](ch13.html#idm45576020181752))
    注意格式字符串中的`%U`和`%u`：这些与根据年份周数和星期几标记时间有关，这是一种稍显不同的时间戳格式。^([3](ch13.html#idm45576020179704))
- en: We then subset to the data relating specifically to Paris and sort the data
    by date:^([4](ch13.html#idm45576020178408))
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们将数据子集化以涉及具体巴黎的数据，并按日期排序：^([4](ch13.html#idm45576020178408))
- en: '[PRE4]'
  id: totrans-18
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: If you are paying attention, the row count should surprise you. If there are
    52 weeks in a year, and we have 10 years’ worth of data, why do we have 522 rows?
    We would have expected 52 weeks × 10 years = 520 rows. Similarly, why are there
    two `NA` dates? You will see an explanation if you go back to the original data.
    There seems to be a 53rd week both for 2004 and for 2009\. Every few years there
    is a year that has 53 weeks rather than 52—it’s not a mistake but rather a part
    of the [Gregorian calendar system](https://perma.cc/4ETJ-88QR).
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你注意到，行数可能会让你感到惊讶。如果一年有52周，我们有10年的数据，为什么我们有522行？我们本来预期是52周 × 10年 = 520行。类似地，为什么有两个`NA`日期？如果您返回原始数据，您将看到解释。似乎2004年和2009年都有第53周。每隔几年，一年有53周而不是52周——这不是错误，而是[格里高利历](https://perma.cc/4ETJ-88QR)系统的一部分。
- en: We then check that the data covers a full and regularly sampled date range by
    first making sure that each year has the same number of data points:^([5](ch13.html#idm45576020010376))
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们检查数据是否覆盖了一个完整且定期采样的日期范围，首先确保每年具有相同数量的数据点：^([5](ch13.html#idm45576020010376))
- en: '[PRE5]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: We can see that the data is as expected; that is, each year (other than the
    two just discussed) has 52 weeks, and each week-of-year label has 10 data points,
    one for each year (except week 53).
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以看到数据符合预期；即每年（除了刚刚讨论过的两年）有52周，并且每个年度周标签有10个数据点，除了第53周。
- en: 'Now that we’ve considered the timestamps of the data, we inspect the actual
    values of the time series (so far we have considered only the time indexing).
    Is there a trend? Seasonality? Let’s find out (see [Figure 13-1](#fig-1301)):'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经考虑了数据的时间戳，我们要检查时间序列的实际值（到目前为止我们只考虑了时间索引）。有趋势吗？季节性？让我们找出来（见[图 13-1](#fig-1301)）：
- en: '[PRE6]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: It’s clear from a simple line plot that there is substantial seasonality (something
    you’ve likely experienced in your own community). This plot suggests a strong
    seasonal component but does not suggest there is a temporal drift apart from the
    seasonality.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 从简单的折线图可以明显看出有明显的季节性（这是您可能在您自己的社区中经历过的）。这个图表表明有强烈的季节性成分，但并不表明除了季节性外有时间漂移。
- en: 'The seasonal behavior complicates the 53rd week. If we want to fit a seasonal
    model, we need to define the seasonality in terms of weeks of the year, and we
    cannot have variable seasonal sizes (that is what distinguishes a season from
    a cycle, as discussed in [Chapter 3](ch03.html#exploratory_data_analysis_for_time_series)).
    While we could imagine some creative solutions to the problem of the 53rd week,
    we will take the simple option of suppressing this data:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 季节性行为使得第53周变得复杂。如果我们想要拟合一个季节性模型，我们需要根据年的周来定义季节性，而不能有可变的季节性大小（这是季节与周期不同的地方，如[第3章](ch03.html#exploratory_data_analysis_for_time_series)所讨论的）。虽然我们可以想象一些创造性的解决方案来解决第53周的问题，但我们将采取简单的方式来抑制这些数据：
- en: '[PRE7]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '![](assets/ptsa_1301.png)'
  id: totrans-28
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1301.png)'
- en: Figure 13-1\. By plotting the time series of the flu rate, we can see the seasonality
    of the flu rate in Paris.
  id: totrans-29
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-1\. 通过绘制流感率的时间序列，我们可以看出巴黎的流感率的季节性。
- en: Whether it is a significant problem to delete a data point depends on the data
    set and the question we are asking. I leave it as an exercise to the reader to
    explore other possibilities for fitting the data while keeping the 53rd week data.
    There are a variety of options to do so. One is merging the 53rd week data into
    the 52nd week of data by averaging the two weeks. Another is to use a model that
    can account for cyclical behavior without having to be locked into exactly the
    same length cycle each year. A third option is that a machine learning model might
    be able to accommodate this with some creative labeling of the data to indicate
    seasonality to the model as an input feature.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 是否删除数据点对于数据集和我们提出的问题是否是一个重要问题。我把它留给读者来探索在保留第53周数据的同时拟合数据的其他可能性。有多种选择可以做到这一点。其中一种是通过对两周取平均数将第53周数据合并到第52周数据中。另一种方法是使用一个可以考虑周期行为而无需锁定于每年完全相同长度周期的模型。第三个选项是，机器学习模型也许可以通过对数据进行创造性标记以指示季节性作为输入特征来适应这种情况。
- en: Fitting a seasonal ARIMA model
  id: totrans-31
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 拟合季节性ARIMA模型
- en: We first consider fitting a seasonal ARIMA model to the data because of the
    strong seasonality. In this case the periodicity of the data is 52, since the
    data is sampled weekly. We want to choose a fairly parsimonious model—that is,
    one without too many parameters—because at 520 data points our time series is
    not particularly long.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 首先考虑对数据拟合季节性ARIMA模型，因为存在强烈的季节性。在这种情况下，数据的周期性为52，因为数据是每周抽样的。我们希望选择一个相当简洁的模型——即没有太多参数的模型——因为我们的时间序列有520个数据点，并不是特别长。
- en: 'This time series is a good example of how we can go wrong if we rely too strongly
    on autopilot. For example, we might first consider whether to difference the data,
    and so we might consider the plot of the autocorrelation of the flu rate and the
    autocorrelation of the differenced time series of the flu rate, each shown in
    [Figure 13-2](#fig-1302):'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 这个时间序列是我们如果过于依赖自动化可能会出错的一个很好的例子。例如，我们可能首先考虑是否对数据进行差分，因此我们可能会考虑流感率的自相关图以及流感率差分时间序列的自相关图，分别显示在[图 13-2](#fig-1302)中：
- en: '[PRE8]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '![](assets/ptsa_1302.png)'
  id: totrans-35
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1302.png)'
- en: Figure 13-2\. Plot of the autocorrelation function for the Paris flu rate and
    the differenced Paris flu rate. We look only at a limited range of lag values.
  id: totrans-36
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-2\. 巴黎流感率及其差分流感率的自相关函数图。我们只考虑了有限范围的滞后值。
- en: 'If we were careless, we could very well congratulate ourselves on having solved
    the stationarity issue for this time series by differencing once. But this doesn’t
    make sense at all. This is weekly data, and we observed a strong seasonality.
    Why aren’t we seeing it in our autocorrelation plot? We took the default parameters
    of the `acf()` function, and this does not take us out nearly far enough in the
    lag space to see the seasonal effects, which we begin at lag 52 (one year). Let’s
    redo the `acf()` with an adequate window ([Figure 13-3](#fig-1303)):'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们粗心大意，可能会因为一次差分而自我祝贺，认为解决了这个时间序列的平稳性问题。但这完全没有任何意义。这是周数据，我们观察到了强烈的季节性。为什么我们在自相关图中看不到它呢？我们使用了`acf()`函数的默认参数，这在滞后空间中不能足够远地展示季节效应，我们从第52个滞后开始（一年）。让我们用一个充分的窗口重新运行`acf()`（参见[图 13-3](#fig-1303)）：
- en: '[PRE9]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '![](assets/ptsa_1303.png)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1303.png)'
- en: Figure 13-3\. Plot of the autocorrelation function for the Paris flu rate and
    the differenced Paris flu rate. We now look at a more extensive range of lag values.
  id: totrans-40
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-3\. 巴黎流感率及其差分流感率的自相关函数图。现在我们考虑了更广泛范围的滞后值。
- en: This gives us a more realistic picture of the autocorrelation of our series.
    As we can see there are substantial autocorrelations at various lags, and this
    makes sense (at least given my experience) living in a four-season climate. Flu
    rates will have a strong correlation with neighboring weeks—that is, close to
    their time of measurement.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 这给了我们一个更真实的系列自相关图。正如我们所看到的，各种滞后值都有显著的自相关，这是有道理的（至少根据我在四季气候中的经验）。流感率与其测量时间附近的周有很强的相关性。
- en: Flu rates will also have a strong correlation, given the seasonality, with time
    periods lagged by around 52 or around 104 because this indicates the yearly seasonality.
    But flu rates also have a fairly strong relationship with time periods lagged
    by intermediary values, such as half a year, such as half a year (26 weeks) because
    such lags also relate to seasonal differences and predictable weather variations.
    For example, we know that in half a year the flu value will likely have changed
    quite a bit. If it was high earlier, it should be low now and vice versa, again
    due to the seasonality. All this is depicted in the upper plot of [Figure 13-3](#fig-1303).
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 流感率也会有很强的相关性，与时间间隔约为52或104的时间段具有季节性相关性。但流感率还与中间值的时间段（例如半年，即26周）具有相当强的关系，因为这些滞后也涉及到季节性差异和可预测的天气变化。例如，我们知道半年时间内，流感值可能会发生相当大的变化。如果之前很高，现在应该很低，反之亦然，这也是由于季节性。所有这些都在[图 13-3](#fig-1303)的上图中显示。
- en: We then examine the differenced series as is illustrated in the lower plot in
    [Figure 13-3](#fig-1303). Now we see a substantial amount of the time series autocorrelation
    has been diminished. However, there remains quite a bit of autocorrelation over
    a range of values, not just at 52 or 104 weeks (one or two years), but also at
    intermediate values.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们检查差分后的系列，如[图 13-3](#fig-1303)中的下图所示。现在我们看到大量时间序列的自相关已经减少。然而，仍然存在相当多的自相关，不仅在52或104周（一年或两年）处，而且在中间值处也有。
- en: 'While we might be tempted to continue differencing, we need to remember that
    real-world data will never fit a SARIMA model perfectly. We instead seek out the
    most reasonable way to model the data. We can consider differencing again seasonally
    or taking a different tactic and differencing in linear time. We plot each of
    these possibilities here (see [Figure 13-4](#fig-1304)):'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然我们可能会试图继续差分，但我们需要记住，真实世界的数据永远不会完美地适合一个SARIMA模型。相反，我们寻求模拟数据的最合理方式。我们可以考虑再次进行季节性差分或采用不同的策略并在线性时间上进行差分。我们在这里绘制了每一种可能性（参见[图 13-4](#fig-1304)）：
- en: '[PRE10]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: '![](assets/ptsa_1304.png)'
  id: totrans-46
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1304.png)'
- en: Figure 13-4\. Plot of two versions of differencing our series to get a sense
    of seasonal behavior in the data.
  id: totrans-47
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-4\. 我们选择的两个版本进行序列差分以了解数据的季节行为。
- en: While neither result is ideal, the latter, a standard first differencing of
    a seasonal differencing, is more satisfactory.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然两种结果都不理想，但后者——季节性差分的标准第一次差分更为令人满意。
- en: 'The decision of a fit or a parameter choice is a judgment call as much as it
    is a matter of applying tests. Here we choose to give weight to the seasonality
    we clearly observed but also to not overcomplicate the model or make it unduly
    opaque. So in a SARIMA (*p*, *d*, *q*) (*P*, *D*, *Q*) model, we will fit with
    *d* = 1 and *D* = 1\. We then choose our AR and MA parameters for our standard
    ARIMA parameters, *p* and *q*. We do this with standard visualizations, using
    the following code (see [Figure 13-5](#fig-1305)):'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 选择拟合或参数选择是一种判断调用，正如应用测试一样。在这里，我们选择给季节性明显的权重，但也不要过于复杂化模型或使其不透明。因此，在SARIMA (*p*,
    *d*, *q*) (*P*, *D*, *Q*)模型中，我们将使用 *d* = 1 和 *D* = 1 进行拟合。然后我们选择我们的AR和MA参数作为标准的ARIMA参数，*p*
    和 *q*。我们通过标准的可视化方法进行这些选择，使用以下代码（参见[图 13-5](#fig-1305)）：
- en: '[PRE11]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: '![](assets/ptsa_1305.png)'
  id: totrans-51
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1305.png)'
- en: Figure 13-5\. Plot of the partial autocorrelation function of the differenced
    series we have selected.
  id: totrans-52
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-5\. 我们选择的差分序列的偏自相关函数图。
- en: We have a limited data set and err on the side of a simpler model. The PACF
    model suggests an AR(2) model could be appropriate, so we will model our data
    parsimoniously as a SARIMA (2, 1, 0), (0, 1, 0).
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 我们有限的数据集并且在选择更简单的模型方面犯了错误。PACF模型表明AR(2)模型可能是合适的，因此我们将我们的数据以SARIMA (2, 1, 0),
    (0, 1, 0)的形式简洁地建模。
- en: 'We are interested in understanding how this model would work if we fit it continuously
    on new data as it becomes available, the way most models built for real-world
    systems will function. That is, if we were modeling the flu starting several years
    ago, each week modeling only with the data that was available up to that point
    in time, how would our model do? We answer this by rolling the fitting and evaluation
    of the model forward, as follows:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 我们对于了解这个模型如何在连续拟合新数据时运行感兴趣，这种方式是大多数为真实世界系统构建的模型所采用的。也就是说，如果我们从几年前开始对流感进行建模，每周只使用到那个时间点为止的数据，我们的模型将如何运行？我们通过按照以下方式推进模型的拟合和评估来回答这个问题：
- en: '[PRE12]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'We then plot these rolling results (see [Figure 13-6](#fig-1306)):'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们绘制这些滚动结果（参见[图 13-6](#fig-1306)）：
- en: '[PRE13]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: The plot shows a helpful forecast but also highlights some limitations of this
    model. It is insufficiently realistic, demonstrated by the fact that it sometimes
    forecasts negative flu rates. The model can do so because there is nothing intrinsic
    to an ARIMA model to enforce constraints such as flu rates having to be nonnegative.
    Enforcing these kinds of physical constraints is something we must do with data
    transformations prior to fitting a model.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 该图展示了一个有用的预测，但也突显了该模型的一些局限性。这个模型不够现实，有时会预测出负的流感率，这表明ARIMA模型本身没有固有的东西来强制施加诸如流感率必须为非负的约束条件。在拟合模型之前，我们必须通过数据转换来实施这些物理约束。
- en: Also, the model appears more sensitive to outlier points than we would like.
    Early 2013 is a prime example where several times the model drastically overestimates
    the flu rate. When it comes to allocation of resources crucial to fighting diseases,
    this is not an acceptable model.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，该模型对异常点的敏感度似乎超出我们的预期。2013年初就是一个典型例子，模型多次严重高估了流感率。当涉及到分配关键的抗疾病资源时，这不是一个可接受的模型。
- en: Finally, this model produces more extreme values at the peaks than are ever
    measured in a given year. This could lead to overallocation of resources relative
    to actual need, which is not a good outcome, particularly when resources are highly
    constrained. This is a concern about the model that is just as rooted in real-world
    resource constraints as it is in pure data analysis.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，该模型在峰值处产生的极端值比任何一年内测量到的值都要高。这可能导致资源分配过多，超过实际需要，这不是一个好结果，特别是当资源高度受限时。这是一个关于模型的担忧，既根植于现实世界的资源限制，也根植于纯粹的数据分析。
- en: '![](assets/ptsa_1306.png)'
  id: totrans-61
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1306.png)'
- en: Figure 13-6\. The flu rates (points) paired with our SARIMA predictions (dotted
    line). The predictions of this simple model could assist with public health planning.
  id: totrans-62
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图13-6\. 流感率（点）与我们的SARIMA预测（虚线）配对。这个简单模型的预测可以帮助公共卫生规划。
- en: Now that we have considered the fit of a basic ARIMA model to this problem,
    we will take a look at other modeling possibilities.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经考虑了基本ARIMA模型对这个问题的拟合情况，我们将看看其他建模可能性。
- en: 'An alternative ARIMA model: Exogenous harmonic regressors instead of seasonality'
  id: totrans-64
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 替代ARIMA模型：外生谐波回归器取代季节性
- en: Given the performance of the SARIMA model discussed in the previous section,
    there are a number of modifications we can make. Here we consider two modifications,
    each of which is independent of the other and could be applied separately.^([6](ch13.html#idm45576019018648))
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑到前一节讨论的SARIMA模型的表现，我们可以进行一些修改。在这里，我们考虑两种修改，每种修改都是独立的，可以分别应用。^([6](ch13.html#idm45576019018648))
- en: First, we would like to build in constraints to our model to prevent the prediction
    of negative values. One way to do this is a log transformation of the data, such
    that we are predicting the logarithm of the value of the time series rather than
    the value itself. Then, when we want to see the “true” series representing the
    numbers actually measured, we will use an exponential transform to back out the
    logarithmic transform and get the predictions in their real units.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们希望在我们的模型中建立约束条件，以防止预测负值。一种方法是对数据进行对数转换，这样我们预测的是时间序列值的对数，而不是值本身。然后，当我们想要看到“真实”的系列，表示实际测量到的数字时，我们将使用指数变换来撤消对数变换，并得到它们的实际单位预测值。
- en: Second, we would like to find a more transparent way of dealing with the seasonality
    of the data. While we described our seasonal ARIMA model as simple, in fact a
    model dealing with a seasonal recurrence of 52 is not simple at all. Seasonal
    ARIMA models do better on shorter seasonal cycles and less well on longer seasonal
    cycles (52 is a long seasonal cycle).
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 其次，我们希望找到一种更透明的方法来处理数据的季节性。虽然我们将我们的季节性ARIMA模型描述为简单的，但实际上，处理52周季节性重复的模型并不简单。季节性ARIMA模型在较短季节周期上表现更好，在较长季节周期（52周是一个长季节周期）上表现不佳。
- en: Here we will use *dynamic harmonic regression*. In this approach, we find a
    Fourier series that describes the periodicity in our data, and then use this series
    as an exogenous regressor that is fit alongside the ARIMA terms.^([7](ch13.html#idm45576019012664))
    Because we can extrapolate the Fourier series forward in time (due to its purely
    periodic nature), we can also precompute the values we expect for the future when
    generating forecasts.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里我们将使用*动态谐波回归*。在这种方法中，我们找到描述数据周期性的傅立叶级数，然后将该级数用作与ARIMA项一起拟合的外生回归器。^([7](ch13.html#idm45576019012664))
    由于我们可以在时间上向前外推傅立叶级数（由于其纯粹周期性的性质），在生成预测时，我们还可以预先计算未来预期的值。
- en: The strength of this model is that the degrees of freedom of the model can be
    used to explain underlying behavior in addition to the seasonal behavior rather
    than devoting a lot of explanatory power to the seasonal behavior.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 该模型的优势在于，模型的自由度可以用来解释基础行为，而不是将大量解释力量用于季节行为。
- en: There are a few downsides to dynamic harmonic regression. First, we assume the
    behavior is quite regular and recurs at exactly the same interval. Second, we
    assume that the seasonal behavior is not changing; that is, the period and amplitude
    of the seasonal behavior are not changing. These limitations are similar to the
    SARIMA model, although the SARIMA model shows more flexibility in how the amplitude
    of seasonality affects data over time.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 动态谐波回归有一些缺点。首先，我们假设行为非常规律，并在完全相同的间隔内重复。其次，我们假设季节性行为不会改变；也就是说，季节性行为的周期和振幅不会改变。这些限制与SARIMA模型类似，尽管SARIMA模型在振幅如何影响数据随时间变化方面更具灵活性。
- en: 'Here, we demonstrate how to perform a dynamic harmonic regression with R code
    similar to what we employed before:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们展示了如何执行类似于之前使用的 R 代码的动态谐波回归：
- en: '[PRE14]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Here we have made a few adjustments to the code from the previous section. First,
    we use a `ts` object.^([8](ch13.html#idm45576019000504)) With a `ts` object, we
    indicate explicitly the seasonality of the time series (52 weeks), when creating
    the `ts` object.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们对上一节中的代码进行了一些调整。首先，我们使用了一个 `ts` 对象。^([8](ch13.html#idm45576019000504))
    使用 `ts` 对象时，我们在创建 `ts` 对象时明确指定了时间序列的季节性（52 周）。
- en: 'We log-transform the data at this point as well to ensure positive predictions
    of our ultimate value of interest, the flu rate:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 此时我们也对数据进行对数变换，以确保对我们最终感兴趣的值，即流感率，进行正面预测：
- en: '[PRE15]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: We also add a small numerical offset (`+ 0.0001`) because numerical fitting
    does not play well with strict zero values or even very small values. One of our
    two adjustments is already accomplished with just this line of code (i.e., the
    log transformation to enforce a physical condition of nonnegative values).
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还添加了一个小的数值偏移（`+ 0.0001`），因为数值拟合不太适合严格的零值或者非常小的值。我们的两个调整之一已经通过这行代码实现了（即对数变换以强制非负值的物理条件）。
- en: 'Next we generate the exogenous harmonic regressors (that is, the Fourier approximation)
    we are using in place of seasonal parameters in the SARIMA. We do this via the
    `forecast` package’s `fourier()` function:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来我们生成外生谐波回归器（即傅里叶逼近），以替代 SARIMA 中的季节性参数。我们通过 `forecast` 包的 `fourier()` 函数来实现这一点：
- en: '[PRE16]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: We generate the accompanying harmonic series for our entire time series first,
    and then we subset it as appropriate to our expanding window rolling fit later
    in the loop.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们生成了伴随的谐波序列，覆盖整个时间序列，然后根据需要将其子集化，以适应后续的循环滚动拟合。
- en: The hyperparameter `K` indicates how many separate sine/cosine pairs we will
    include in our fit, where each one represents a new frequency used to fit the
    sine/cosine. In general, `K` will be larger for larger seasonal period lengths
    and smaller for smaller ones. In a more extended example, we could consider how
    to use an information criterion to tune `K`, but for this example we use `K` =
    2 as a reasonable model.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 超参数 `K` 表示我们将包括多少个单独的正弦/余弦对来拟合我们的模型，其中每个对代表一个新的用于拟合正弦/余弦的频率。一般来说，`K` 对于更长的季节周期长度会更大，对于较短的季节周期长度会更小。在更详细的示例中，我们可以考虑如何使用信息准则来调整
    `K`，但在本例中我们使用 `K` = 2 作为一个合理的模型。
- en: 'Finally, all that is left to do is to generate new fits that take into account
    the exogenous Fourier components we just fit. We do the fitting as follows, where
    the `xreg` parameter takes the fit Fourier series as additional regressors, which
    are fit along with the standard ARIMA parameters:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们所需做的就是生成新的拟合，考虑到我们刚刚拟合的外生 Fourier 组件。我们进行拟合如下，其中 `xreg` 参数将拟合的 Fourier
    级数作为附加的回归器，这些回归器与标准的 ARIMA 参数一起拟合：
- en: '[PRE17]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: We set the `seasonal` parameter to `FALSE` to ensure that we will not have redundant
    seasonal parameters given our decision to use dynamic harmonic regression in this
    case.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将 `seasonal` 参数设置为 `FALSE`，以确保我们不会在这种情况下具有多余的季节性参数。
- en: 'We also need to include regressors when we generate a forecast, meaning we
    need to indicate what the regressors will be at the time the forecast is targeting:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们生成预测时，我们还需要包括回归器，这意味着我们需要指示预测目标时回归器的内容：
- en: '[PRE18]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'We plot the performance of this model, as follows (see [Figure 13-7](#fig-1307)):'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 我们绘制该模型的性能，如下所示（参见[图 13-7](#fig-1307)）：
- en: '[PRE19]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: On the positive side, our predicted series no longer features negative values.
    However, there are many disappointing aspects of the model’s performance. Most
    obviously, many of the predictions are quite off. The peaks are far the wrong
    magnitude, and they occur at the wrong time.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 正面的一点是，我们预测的系列不再出现负值。然而，模型性能中有许多令人失望的方面。最明显的是，许多预测相差甚远。峰值的幅度完全错误，并且出现时间也错误。
- en: '![](assets/ptsa_1307.png)'
  id: totrans-89
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1307.png)'
- en: Figure 13-7\. Plot of the actual flu rates (points) compared to our ARIMA +
    dynamic harmonic regression model predictions (dashed line).
  id: totrans-90
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-7\. 显示实际流感率（点）与我们的 ARIMA + 动态谐波回归模型预测（虚线）的图表。
- en: 'One explanation for the problems is that regular seasonality is not a good
    description of the seasonality of the flu.^([9](ch13.html#idm45576018349528))
    [According to the Centers for Disease Control and Prevention (CDC)](https://perma.cc/58SP-B3YH),
    in the United States flu can peak each winter season as early as December or as
    late as March. We can see this in the test data. Consider the following code and
    the plot in [Figure 13-8](#fig-1308), which identify the peaks in the testing
    range of the data:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 一个解释问题的原因是，规律性的季节性并不是流感的季节性的一个好描述。根据疾病控制和预防中心（CDC）的说法，在美国，流感可能在每年冬季的12月至3月间出现高峰。我们可以在测试数据中看到这一点。考虑下面的代码和[图
    13-8](#fig-1308)中的图，这些识别了数据测试范围内的峰值：
- en: '[PRE20]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: '![](assets/ptsa_1308.png)'
  id: totrans-93
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1308.png)'
- en: Figure 13-8\. Plot of only the test values for the flu and their apparent peak
    locations.
  id: totrans-94
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-8\. 仅显示流感测试值及其明显峰值位置的图。
- en: The peaks occur at indices 59 and 109, that is 50 weeks (not 52 weeks) apart
    from one another. Also the peak that came at index 59 came at least 59 weeks after
    the previous peak, and possibly more since we do not have the full extent of the
    peak around index = 0 in our plot.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 峰值出现在索引59和109处，相距50周（而不是52周）。此外，出现在索引59处的峰值至少比上一个峰值晚了59周，而且可能更久，因为我们的图中没有完整展示索引=0周围的峰值情况。
- en: With sample peak-to-peak distances of more than 59 in one case and 50 in another,
    we can see quite a bit of variability from year to year. Our dynamic harmonic
    regression would not take this into account, and it enforces a more rigid model
    of seasonality than does the SARIMA model, because the latter’s seasonal behavior
    can change over time. This mismatch between assumptions and the data could go
    a long way toward explaining the poor performance of this model, such that using
    a bad model actually drew our attention to an important feature of our data we
    had not noticed earlier.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 在一个案例中，样本峰值间距超过59周，在另一个案例中为50周，我们可以看到年度间存在相当大的变异性。我们的动态谐波回归没有考虑到这一点，它比SARIMA模型具有更严格的季节性模型，因为后者的季节性行为会随着时间变化。假设与数据之间的这种不匹配可能在很大程度上解释了这个模型的性能不佳，使用一个不好的模型实际上引起了我们对数据一个重要特征的注意，这是我们之前没有注意到的。
- en: Despite poor performance, this alternate model has proven useful for a few reasons.
    It showed us the value of building the physical limitations of the system into
    our data preprocessing, in this case via a log transformation. It has also shown
    us the value of experimenting with several classes of models with an underlying
    theory behind the model selection at each point. We chose this model to simplify
    our seasonality, but instead what we discovered is that, likely, neither the SARIMA
    nor the dynamic harmonic regression model of seasonality is a very good one for
    this system.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管性能不佳，这个替代模型在几个方面已经证明是有用的。它向我们展示了将系统的物理限制纳入数据预处理的价值，例如通过对数转换。它还向我们展示了尝试在每个时间点选择带有模型背后理论的几类模型的价值。我们选择了这个模型来简化我们的季节性，但我们发现，很可能，无论是SARIMA还是动态谐波回归季节性模型都不是这个系统的很好选择。
- en: What Is State of the Art in Flu Forecasting?
  id: totrans-98
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 流感预测的技术水平是什么？
- en: The models we just explored were relatively simple but reasonably effective
    in making either forecasts or nowcasts of flu rates in the Paris metropolitan
    region for short forecast horizons. These models are a good start both in getting
    to know your data set and in recognizing the limitations of what could be predictive
    in a noisy but complicated system, such as flu in a given geographic region.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 我们刚刚探讨的模型在进行巴黎大都会区流感率的短期预测或现场预测方面相对简单但相当有效。这些模型是开始了解数据集并认识到在嘈杂但复杂的系统中什么东西可能具有预测能力的良好起点，例如在特定地理区域的流感中。
- en: It’s interesting to compare our simple approaches with some cutting-edge approaches
    currently deployed by government agencies or recently published by academics seeking
    to discuss the state of the art. Next I provide a brief overview of how well flu
    forecasts currently work and what novel approaches researchers have developed
    in recent years to try to improve upon traditional models.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 将我们简单的方法与目前政府机构部署的一些尖端方法或最近学者们发表的讨论当前技术水平的方法进行比较是很有趣的。接下来，我将简要概述当前流感预测的工作情况以及研究人员近年来发展的试图改进传统模型的新方法。
- en: Research in flu forecasts
  id: totrans-101
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 流感预测研究
- en: 'The CDC actively encourages researchers to work on forecasting the flu, even
    sponsoring an [R package](https://perma.cc/TDX8-4Z7T) to make its data readily
    available. For more than five years, the CDC has also sponsored flu forecasting
    competitions, although it was only for the 2017–2018 flu season that it actually
    incorporated a flu forecast into its official communications and bulletins. The
    Delphi research group from Carnegie Mellon has won the majority of competitions
    so far, and the group forecasts the flu with what they describe as three distinct
    efforts:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 疾病控制与预防中心（CDC）积极鼓励研究人员从事流感预测研究，甚至赞助一个[R包](https://perma.cc/TDX8-4Z7T)来使其数据更容易获取。五年多来，CDC还主办了流感预测竞赛，尽管直到2017-2018流感季节才将流感预测正式纳入其官方通讯和公告中。来自卡内基梅隆大学的Delphi研究小组迄今赢得了大多数竞赛，并使用他们描述的三种不同方法预测流感：
- en: An [Empirical Bayes approach](https://perma.cc/8EBA-GN2C) that applies past
    flu season data with a series of manipulations to form priors for the current
    season’s data based on the overall “shapes” of the time series from past flu seasons
  id: totrans-103
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一种[经验贝叶斯方法](https://perma.cc/8EBA-GN2C)，将过去的流感季节数据应用到一系列操作中，形成当前季节数据的先验，基于过去流感季节时间序列的总体“形状”。
- en: A [crowdsourcing platform](https://perma.cc/XDE9-A9Y4) where anyone is welcome
    to submit a prediction of flu rates
  id: totrans-104
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个[众包平台](https://perma.cc/XDE9-A9Y4)，任何人都可以提交对流感率的预测。
- en: A nowcasting method that uses [*sensor fusion*](https://perma.cc/NGZ8-TD39),
    aggregating data from many sources, such as Wikipedia access counts and relevant
    Twitter queries, to produce geographically localized flu predictions
  id: totrans-105
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一种现在预测方法，利用[*传感器融合*](https://perma.cc/NGZ8-TD39)，聚合来自多个来源的数据，例如维基百科访问计数和相关Twitter查询，以生成地理位置化的流感预测。
- en: 'This is the set of diverse approaches used in just one academic research group!
    If we look further afield into academia, we see even more diversity:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 这是仅仅一个学术研究团队中使用的多种方法集合！如果我们进一步观察学术界，我们会看到更多的多样性：
- en: Using deep convolutional networks (CNNs) to classify Instagram pictures and
    use the outputs of these CNNS along with text-related features from Twitter as
    inputs into a variety of machine learning models, including `XGBoost` trees. One
    such [paper](https://perma.cc/N39F-GSL5) had the advantage of focusing on a small
    linguistic community (Finnish speakers), which enabled the use of mainstream social
    media platforms in a way that could still be regionally specific.
  id: totrans-107
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用深度卷积网络（CNNs）对Instagram图片进行分类，并将这些CNN的输出与来自Twitter的文本相关特征一起作为各种机器学习模型（包括`XGBoost`树）的输入。一篇名为[paper](https://perma.cc/N39F-GSL5)的论文因专注于小型语言社区（芬兰语使用者）而具有优势，这使得可以在一定程度上区域特定地使用主流社交媒体平台。
- en: Identifying reliable users within larger social media clusterings. One [paper](https://perma.cc/25GR-MHRK)
    focuses on improving flu predictions by finding the users best placed and most
    trustworthy on social media platforms.
  id: totrans-108
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 识别大型社交媒体群集中可靠用户。一篇名为[paper](https://perma.cc/25GR-MHRK)的论文专注于通过找到在社交媒体平台上位置最佳且最值得信赖的用户来改进流感预测。
- en: Accessing electronic health records to have a more complete and complementary
    data source in addition to publicly available data. One [paper](https://perma.cc/Q8B7-5TC4)
    showed that extremely large gains in forecast accuracy at a number of timescales
    could be obtained via the integration of electronic health records into forecasting
    input streams. Unfortunately, this is difficult to arrange and suggests that accurate
    flu forecasting abilities will go to wealthy data holders rather than to the most
    creative researchers (although, of course, sometimes these can be one and the
    same).
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 访问电子健康记录以获取更完整和补充的数据源，除了公开可用数据。一篇名为[paper](https://perma.cc/Q8B7-5TC4)的论文表明，通过将电子健康记录整合到预测输入流中，可以在多个时间尺度上极大提高预测准确性。不幸的是，这很难安排，并且表明准确的流感预测能力将落入富有的数据持有者手中，而不是最有创造力的研究人员手中（尽管有时二者可能是同一个人）。
- en: As we can see from the diversity of approaches to this problem, there are many
    routes to make a flu forecast, and none is the definitive winner just yet. This
    continues to be an area of active research and development, even as some of the
    better strategies have been applied to governmental uses and public information.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 从解决这一问题的多样化方法可以看出，有许多途径可以进行流感预测，目前没有一个方法是绝对胜出的。尽管一些更好的策略已经被应用于政府使用和公共信息，但这仍然是一个积极的研究和发展领域。
- en: Our discussion here is only the tip of the iceberg. There is a lot of biology,
    sociology, medicine, and economic policy that goes into determining the course
    of a flu season, and there are a variety of models that are less oriented toward
    time series analysis and more oriented toward other aspects of the flu behavior.
    Time series brings one rich perspective to a very complicated topic.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在这里的讨论只是冰山一角。决定流感季节走向涉及大量的生物学、社会学、医学和经济政策，还有各种不同的模型，这些模型不仅仅是面向时间序列分析，还包括其他流感行为方面的导向。时间序列为这个非常复杂的主题提供了一个丰富的视角。
- en: Predicting Blood Glucose Levels
  id: totrans-112
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 预测血糖水平
- en: Another active area of machine learning research for time series data in health
    applications is the prediction of blood glucose levels for individual patients.
    Diabetes patients themselves make such predictions all the time, particularly
    if they have a level of disease such that they inject themselves with bolus insulin,
    which is specifically used at mealtimes. In such cases, diabetics need to estimate
    how the food they are about to eat will affect their blood sugar and adjust their
    dose accordingly.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 在健康应用的时间序列数据的机器学习研究的另一个活跃领域是预测个体患者的血糖水平。糖尿病患者自己经常进行这种预测，特别是如果他们有一定程度的疾病需要在餐时注射胰岛素的话。在这种情况下，糖尿病患者需要估计他们即将食用的食物将如何影响他们的血糖，并相应地调整剂量。
- en: Similarly, diabetes patients must time their meals and medication to optimize
    their blood sugar, which is best kept within a specific range, neither too high
    nor too low. In addition to needing to account for blood-sugar-changing activities
    such as eating and exercise, diabetics also need to account for specific time-of-day
    effects. For example, the [dawn phenomenon](https://perma.cc/GE3B-MAKY) is a rise
    in blood sugar that occurs in all humans but can be problematic for those with
    diabetes. On the other hand, for people with type 1 diabetes, blood sugar lows
    during sleeping hours can be life-threatening events resulting from the failure
    to make an accurate prediction.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 同样地，糖尿病患者必须根据时间安排饮食和药物，以优化血糖水平，最好保持在特定范围内，既不过高也不过低。除了需要考虑诸如进食和运动等影响血糖的活动外，糖尿病患者还需考虑特定的一天中时间的影响。例如，[黎明现象](https://perma.cc/GE3B-MAKY)是所有人都会出现的血糖上升，但对糖尿病患者可能成为问题。另一方面，对于1型糖尿病患者来说，在睡眠时间内的血糖过低可能是生命威胁性事件，由于未能准确预测而导致。
- en: 'Here we look at a small data set: the self-reported continuous glucose monitor
    (CGM) data for one individual in several noncontiguous segments of time. This
    data was self-published on the internet and modified to preserve the privacy of
    the patient.'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们查看一个小型数据集：一个个体的自我报告连续血糖监测（CGM）数据，分布在几个不连续的时间段内。这些数据是在互联网上自行发布的，并进行了修改以保护患者的隐私。
- en: There are other options for obtaining diabetes data sets. In addition to large
    healthcare organizations and some startups with large troves of CGM data, there
    are numerous self-published data sets available as individuals increasingly manage
    their diabetes via DIY efforts, such as the [Night Scout project](https://perma.cc/N42T-A35K).
    There are also several diabetes [CGM data sets](https://perma.cc/RXG2-CYEE) open
    for research purposes.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 获取糖尿病数据集还有其他选择。除了大型医疗机构和一些拥有大量连续血糖监测数据的初创公司外，随着个体越来越多地通过DIY方法管理糖尿病，还有许多自行发布的数据集可供使用，例如[Night
    Scout 项目](https://perma.cc/N42T-A35K)。此外，还有几个糖尿病[CGM数据集](https://perma.cc/RXG2-CYEE)可供研究目的使用。
- en: In this section, we will explore the messiness of a real-world data set and
    attempt to forecast that data.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将探索真实数据集的混乱，并尝试对该数据进行预测。
- en: Data Cleaning and Exploration
  id: totrans-118
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 数据清理和探索
- en: 'The data is stored in several files available on this book’s [GitHub repository](https://github.com/PracticalTimeSeriesAnalysis/BookRepo).
    We first load the files and combine them into one `data.table`:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 数据存储在本书的几个文件中，可以在这本书的[GitHub存储库](https://github.com/PracticalTimeSeriesAnalysis/BookRepo)中找到。我们首先加载这些文件并将它们合并为一个`data.table`：
- en: '[PRE21]'
  id: totrans-120
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Strings of date information are available, but we don’t have a proper timestamp
    class column, so we make one with the information we have, which includes a time
    zone as well as a date string:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 有日期信息的字符串可用，但我们没有适当的时间戳类列，因此我们使用现有的信息制作一个，包括时区和日期字符串：
- en: '[PRE22]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Then we inspect the data post-processing:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们检查数据的后处理：
- en: '[PRE23]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'There are many duplicated data entries, so we need to scrub these for two reasons:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 存在许多重复的数据条目，因此我们需要出于两个原因进行清理：
- en: There is no reason a priori that certain data points should be privileged or
    weighted more highly than others, but duplication will produce such an effect.
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 事先没有理由认为某些数据点应该比其他数据点更优越或更高权重，但是重复会产生这样的效果。
- en: If we are going to form a feature based on time series windows, these will be
    nonsensical if there are duplicated time points.
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果我们要基于时间序列窗口生成特征，如果存在重复的时间点，这些特征将是没有意义的。
- en: 'We first see if we can solve this problem by removing all perfectly duplicated
    rows:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 我们首先看看是否可以通过删除所有完全重复的行来解决这个问题：
- en: '[PRE24]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'However, we should not assume this resolves the problem, so we check whether
    nonidentical data points exist for the same timestamp:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，我们不应假设这解决了问题，所以我们检查是否存在相同时间戳的非相同数据点：
- en: '[PRE25]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'Since we still have duplicate time points, we do some data review to see what
    this means. We identify the timestamp with the most duplicate rows and examine
    these:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 由于我们仍然有重复的时间点，我们进行一些数据审查以查看其含义。我们确定具有最多重复行的时间戳，并检查这些行：
- en: '[PRE26]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Looking at these values, we can see that there are distinct blood glucose values
    reported, but they are not wildly different,^([10](ch13.html#idm45576017778568))
    so we suppress the duplicate timestamps even though they are not exact duplicates:^([11](ch13.html#idm45576017777784))
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 从这些数值来看，我们可以看到报告的血糖值是不同的，但它们并不是完全不同^([10](ch13.html#idm45576017778568))，所以我们会抑制重复的时间戳，即使它们并非完全相同^([11](ch13.html#idm45576017777784))。
- en: '[PRE27]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Now that we have proper timestamps and single values per timestamp, we are in
    a position to plot our data and get a sense of its extent and behavior (see [Figure 13-9](#fig-1313)).
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们有了正确的时间戳和每个时间戳的单一值，我们可以绘制我们的数据并了解其范围和行为（参见 [图 13-9](#fig-1313)）。
- en: '![](assets/ptsa_1309.png)'
  id: totrans-137
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1309.png)'
- en: Figure 13-9\. The full time domain and value range of the available data in
    this naive plot of the time series. Unfortunately, the data is so spread out in
    time and disjointed that this plot does not give us a good understanding of the
    system’s behavior.
  id: totrans-138
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-9\. 这个天真的时间序列图显示了可用数据的全时域和值范围。不幸的是，数据在时间上分布很广且不连贯，这个图并不能给我们一个关于系统行为的良好理解。
- en: 'We zoom in on the period we see early in the time series, March 2015 (see [Figure 13-10](#fig-1314)):'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 我们放大到我们在时间序列早期看到的时期，即2015年3月（参见 [图 13-10](#fig-1314)）：
- en: '[PRE28]'
  id: totrans-140
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: '![](assets/ptsa_1310.png)'
  id: totrans-141
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1310.png)'
- en: Figure 13-10\. Focusing on a specific segment of the time series is more helpful
    but still too compressed for us to get a sense of any sort of time series dynamics.
    We should zoom in even further on the time axis.
  id: totrans-142
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-10\. 关注时间序列的特定段落更有帮助，但对于我们理解任何时间序列动态来说仍然太过压缩。我们应该在时间轴上进一步放大。
- en: 'Even in the plot of just the March dates, we still don’t get a sense of the
    behavior of the time series. Is there seasonality? Drift? A daily pattern? We
    don’t know, so we plot an even shorter time window (see [Figure 13-11](#fig-1315)):'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 即使在仅仅显示三月日期的图中，我们仍然无法理解时间序列的行为。是否有季节性？漂移？日常模式？我们不知道，因此我们绘制了一个更短的时间窗口（参见 [图 13-11](#fig-1315)）：
- en: '[PRE29]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: '![](assets/ptsa_1311.png)'
  id: totrans-145
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1311.png)'
- en: Figure 13-11\. Plot of the data from two specific days in July. We can see something
    of a daily pattern emerge. Finally, we are looking at the data at a temporal scale
    where the human eye can make sense of what is going on.
  id: totrans-146
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 13-11\. 展示了七月份两天的数据。我们可以看到某种日常模式正在形成。最后，我们在一个时间尺度上观察数据，这样人眼可以理解正在发生的事情。
- en: 'By doing more of these exploratory plots (left as an exercise for the reader),
    you should develop an intuition of the scale of the data, the qualitative dynamics,
    and what might be important in describing its behavior. Some further exploratory
    techniques you should apply to this data set include:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 通过更多的探索性绘图（留给读者作为练习），您应该对数据的规模、质量动态以及描述其行为的重要性有直观的理解。您应该对此数据集应用的一些进一步的探索技术包括：
- en: Day-length 2D histograms to look for intraday patterns, and related clustering
    exercises. Are there different kinds of days?
  id: totrans-148
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 日长度的二维直方图，用于查找一天内的模式，以及相关的聚类练习。是否存在不同类型的日子？
- en: Group-by statistics on hours of the day or seasons of the year to look for systematic
    difference across time.
  id: totrans-149
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 根据一天中的小时或一年中的季节进行分组统计，以寻找时间上的系统差异。
- en: Smoothing of the data to look for long-term trends and particularly to compare
    interday relationships rather than intraday relationships. It would be valuable
    to develop ultra-long-range blood glucose predictions, which you can do only by
    looking beyond the more obvious intraday patterns.
  id: totrans-150
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 平滑数据以寻找长期趋势，特别是比较一天之间的关系，而不是一天内的关系。开发超长期血糖预测将是有价值的，这只能通过超越更明显的一天内模式来实现。
- en: Generating Features
  id: totrans-151
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 生成特征
- en: Armed with some background knowledge—as well as with observations from our brief
    exploration of the data set―we can generate features for our data that would be
    helpful for predicting blood glucose.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 有了一些背景知识，以及我们对数据集的简要探索的观察，我们可以为我们的数据生成有助于预测血糖的特征。
- en: 'We begin by featurizing time itself. For example, we noticed the day appears
    to have a structure to it, which suggests that the time of day should be relevant
    for making predictions. Likewise, if you plot the time series of blood glucose
    for different months of the data, some months show greater variance than others.^([12](ch13.html#idm45576017241352))
    We generate a few time-related features here (see [Figure 13-12](#fig-1316)):'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 我们从时间本身的特征化开始。例如，我们注意到一天中有一定的结构，这表明一天中的时间应该与预测相关。同样，如果你绘制不同月份的血糖时间序列数据，一些月份显示的方差比其他月份大。^([12](ch13.html#idm45576017241352))
    我们在这里生成了一些与时间相关的特征（见[图13-12](#fig-1316)）：
- en: '[PRE30]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'We also consider qualities of the time series values and not just the timestamps
    of data collection. For example, we can see that the mean blood glucose values
    vary with the time of day ([Figure 13-13](#fig-1317)):'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还考虑时间序列值的特质，而不仅仅是数据收集的时间戳。例如，我们可以看到平均血糖浓度随一天中的时间变化（见[图13-13](#fig-1317)）：
- en: '[PRE31]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: '![](assets/ptsa_1312.png)'
  id: totrans-157
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1312.png)'
- en: Figure 13-12\. From the histogram of local hour we can see that the times the
    CGM is collecting and reporting data are not random. The heavy concentration around
    midnight additionally suggests an irregularity in reporting or device functioning
    that is most likely not due to user behavior (the user is not likely manipulating
    their device at that time of day).
  id: totrans-158
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图13-12。从本地小时的直方图中我们可以看出，CGM收集和报告数据的时间并不是随机的。午夜附近的高度集中还表明了报告或设备功能上的不规则性，这很可能不是由用户行为引起的（用户不太可能在那个时候操纵他们的设备）。
- en: '![](assets/ptsa_1313.png)'
  id: totrans-159
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1313.png)'
- en: Figure 13-13\. Mean blood glucose varies substantially by the time of day.
  id: totrans-160
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图13-13。平均血糖浓度在一天中显著变化。
- en: There is other interesting data about the blood glucose values. The column named
    `direction` in the data set pulls information from the CGM device, applies the
    manufacturer’s proprietary software, and comes up with a directional trend label
    for the data. We can use this rather than computing our own trend statistics,
    and so we try to understand it a little, such as by asking whether there are different
    trends for different hours.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 血糖值的数据中还有其他有趣的数据。数据集中名为`direction`的列从CGM设备中提取信息，应用制造商的专有软件，并为数据提供方向趋势标签。我们可以使用这一点而不是计算自己的趋势统计，因此我们试图稍微理解一下，例如询问不同小时是否有不同的趋势。
- en: 'We define a function that will give us the *n*th most popular label for a given
    vector, and we use that first to find the most popular label for each local hour
    of the day:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 我们定义一个函数，它将为给定向量提供第n个最流行的标签，并且我们首先使用它来找到每个本地小时的最流行标签：
- en: '[PRE32]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: The most popular direction label is “flat” for all hours of the day, which is
    reassuring because the dynamics of the system would be questionable if the trend
    could be strongly predicted simply by the time of day.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 全天最流行的方向标签是“flat”，这让人感到放心，因为如果趋势仅仅可以通过一天中的时间强烈预测，系统的动态将是可疑的。
- en: 'However, the second most common directional label per hour of the day does
    vary with the time of day, as we can see here:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，一天中每小时第二常见的方向标签确实随时间变化，我们可以在这里看到：
- en: '[PRE33]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: It’s interesting to cross-reference these labels against the intraday data plots
    we included in the previous section. Do the results match? (Answering this is
    left as an exercise for the reader.)
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 有趣的是，我们可以将这些标签与我们在前一节中包含的一天内数据图进行交叉引用。结果是否匹配？（读者留作练习）
- en: Next we address a numeric label that may be predictive, namely the variance
    of the blood glucose measures in the most recent time window. We compute the standard
    deviation for a short lookback window.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来我们解决一个可能具有预测性的数字标签，即最近时间窗口内血糖测量的方差。我们计算一个短期回溯窗口的标准差。
- en: 'To do so, we must account for the noncontiguous nature of the data. We don’t
    want to be computing standard deviations of data points that are not adjacent
    in time but merely adjacent in the `data.table`. We will compute time deltas between
    target window beginnings and ends to ensure they are of the right timescale, but
    we need to be careful about how we do this. Here is an example of how we could
    easily go wrong:'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 为此，我们必须考虑数据的非连续性。我们不想计算时间表中不相邻但在`data.table`中仅相邻的数据点的标准差。我们将计算目标窗口起始点和结束点之间的时间差，以确保它们是正确的时间尺度，但我们需要小心处理。以下是我们可能会出错的一个例子：
- en: '[PRE34]'
  id: totrans-170
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'It is possible the time differences are returned in different units, which
    would make the results of the preceding code nonsense. The correct way to compute
    a time delta, as well as the way we use this time delta to determine the validity
    of a standard deviation computation for a given row, is as follows:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 时间差可能以不同的单位返回，这会使前面代码的结果变得毫无意义。计算时间差的正确方法，以及我们如何使用这个时间差来确定给定行的标准差计算的有效性，如下所示：
- en: '[PRE35]'
  id: totrans-172
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'Once we have labeled the rows for which a standard deviation calculation is
    appropriate, we run the calculations. We compute across all rows, and we plan
    to overwrite the invalid values with a column average as a simple form of missing
    value imputation:'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们标记了适合进行标准差计算的行，我们就开始进行计算。我们在所有行上进行计算，并计划用列平均值覆盖无效值，作为简单的缺失值插补方法：
- en: '[PRE36]'
  id: totrans-174
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'Next, we set up a column to establish the true value we should target for our
    forecast. We choose to forecast blood glucose values 30 minutes in advance, which
    would be enough time to warn someone with diabetes if a dangerously high or low
    blood sugar was predicted. We put the target forecast value into a column called
    `target`. We also create another column, `pred.valid`, which indicates whether
    the data points preceding the time when we want to make a forecast are sufficiently
    complete (that is, regularly sampled in the previous 30 minutes at 5-minute increments):'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们设置了一个列来确定我们应该为我们的预测目标选择的真实值。我们选择预测血糖值提前30分钟，这足以在预测到血糖危险高或低时提醒糖尿病患者。我们将目标预测值放入名为`target`的列中。我们还创建了另一个名为`pred.valid`的列，该列指示在我们希望进行预测之前的数据点是否足够完整（即，在前30分钟以5分钟间隔定期采样）：
- en: '[PRE37]'
  id: totrans-176
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'We spot-check our work to see if it produces sensible results:'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 我们抽查我们的工作，看看它是否产生了合理的结果：
- en: '[PRE38]'
  id: totrans-178
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: Take a careful look at this output. Something in it should make you question
    whether we were too harsh in assessing “validity” for computing the standard deviation
    of a recent window on the blood glucose data. As an independent exercise, see
    if you can spot those points, and think about how you could rework the `pred.valid`
    labeling to be more correctly inclusive.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 仔细看看这个输出。其中的某些内容可能会让你质疑我们在评估“有效性”计算最近窗口的血糖数据标准差时是否太苛刻。作为一个独立的练习，看看你能否发现这些点，并思考如何重新设计`pred.valid`标签，使其更正确地包含。
- en: 'Now we have a wide array of features and a target value to use for training
    whatever model we will use to generate forecasts, but we are not done generating
    features. We should simplify some of the temporal features we have already generated
    to lessen the complications of our model. For example, rather than having local
    hour be an input of 23 binaries (one for each hour of the day minus one), we should
    lessen the number of “hour” categories. We do this like so:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们有了大量的特征和一个用于训练模型的目标值，但我们还没有生成所有的特征。我们应该简化我们已经生成的一些时间特征，以减少模型的复杂性。例如，而不是将本地小时作为输入的23个二进制值（每天的每小时减去一个），我们应该减少“小时”类别的数量。我们可以这样做：
- en: '[PRE39]'
  id: totrans-181
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'We also simplify the month data to a simpler set of categories:'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还将月份数据简化为一组更简单的类别：
- en: '[PRE40]'
  id: totrans-183
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'Finally, to use the `direction` column we need to one-hot-encode this value,
    just as we did the different times of the day. We also clean up some inconsistently
    labeled features (`"NOT COMPUTABLE"` versus `"NOT_COMPUTABLE"`):'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，要使用`direction`列，我们需要对该值进行独热编码，就像我们对不同时间的处理方式一样。我们还清理了一些不一致标记的特征（`"NOT COMPUTABLE"`与`"NOT_COMPUTABLE"`）：
- en: '[PRE41]'
  id: totrans-185
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: Now we have one-hot-encoded relevant features and simplified others, so we are
    ready to direct these features into a model.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经对相关特征进行了独热编码，并简化了其他特征，所以我们准备将这些特征引导到模型中。
- en: Fitting a Model
  id: totrans-187
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 拟合模型
- en: 'At last we get to the fun part of time series analysis: making a prediction.'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们开始进行时间序列分析中有趣的部分：做出预测。
- en: How Much Time Should You Spend Modeling?
  id: totrans-189
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 模型建模需要花费多少时间？
- en: As you have seen with the two real-world models of this chapter, real-world
    data is messy, and each time it is scrubbed it has to be done so with domain knowledge
    and common sense. There is no general template. However, you should always proceed
    carefully and without rushing to fit a model. We only want to fit models once
    we are confident we are not putting garbage into them!
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 正如您在本章的两个真实模型中看到的那样，真实世界的数据是混乱的，每次清理都必须以领域知识和常识为基础进行。没有通用模板。然而，您应该始终小心谨慎，不要急于适应模型。我们只想在确信我们没有投入垃圾数据时才适应模型！
- en: Our first order of business is to create training and testing data sets:^([13](ch13.html#idm45576015635496))
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的首要任务是创建训练和测试数据集：^([13](ch13.html#idm45576015635496))
- en: '[PRE42]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: Consistent with much cutting-edge work, we choose `XGBoost` gradient boosted
    trees as our model. In recent publications, these have met or exceeded state-of-the-art
    metrics for glucose prediction in some use cases:^([14](ch13.html#idm45576015629992))
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 与许多前沿工作一致，我们选择`XGBoost`梯度提升树作为我们的模型。在最近的出版物中，这些模型在某些用例中达到或超过了血糖预测的最新标准：^([14](ch13.html#idm45576015629992))
- en: '[PRE43]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'We can then inspect the results of this prediction (see [Figure 13-14](#fig-1318)).
    We also look at our prediction for a specific day (see [Figure 13-15](#fig-1319)):'
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们可以检查这次预测的结果（见[图13-14](#fig-1318)）。我们还看了我们对特定一天的预测（见[图13-15](#fig-1319)）：
- en: '[PRE44]'
  id: totrans-196
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: '![](assets/ptsa_1314.png)'
  id: totrans-197
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1314.png)'
- en: Figure 13-14\. At this large scale our predictions look good, but it’s hard
    to judge zoomed out so far. This is not how someone using the prediction would
    experience it.
  id: totrans-198
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图13-14\. 在这么大的尺度上，我们的预测看起来不错，但是从这么远的距离看很难判断。这不是使用预测的人会体验到的方式。
- en: '![](assets/ptsa_1315.png)'
  id: totrans-199
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1315.png)'
- en: Figure 13-15\. Examining single days at a time offers a better perspective on
    how well our prediction algorithm works.
  id: totrans-200
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图13-15\. 逐日检查可以更好地了解我们预测算法的工作效果。
- en: The predictions look reasonable, but this plot suggests there may also be problems
    with the underlying data. The blob around midnight between Sunday and Monday seems
    unrealistically low, particularly as neighboring points are not low. It’s more
    likely the device malfunctioned than that someone experienced such a drastic but
    short-lived low blood glucose. We might consider more data scrubbing or perhaps
    additional labels to indicate that particular points seem suspect.^([15](ch13.html#idm45576015122376))
    It’s probably a sign of overfitting that our model forecasts these likely invalid
    low blood glucose data points. We want our model to forecast actual blood glucose
    values and not device malfunctions.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 预测看起来合理，但这个图表表明底层数据可能存在问题。周日到周一之间午夜时的这个点看起来异常低，特别是其邻近点并不低。更可能是设备故障，而不是某人经历了如此剧烈但短暂的低血糖。我们可能需要考虑更多数据清理，或者也许是添加额外标签来表明这些特定点看起来可疑。^([15](ch13.html#idm45576015122376))
    我们的模型预测这些可能无效的低血糖数据点，可能是过拟合的迹象。我们希望我们的模型预测实际的血糖值，而不是设备故障。
- en: At this point, we should consider the goals of our algorithm. If we merely want
    to show that we can do a reasonably good job of predicting blood glucose half
    an hour in advance—without even the benefit of knowing what someone is eating
    or when they are exercising—we can already say “mission accomplished.” That’s
    already quite something—and it’s impressive that we can make reasonable forecasts
    without having relevant inputs, such as meal and exercise information.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 此时，我们应该考虑我们算法的目标。如果我们仅想展示我们能在半小时内做出合理的血糖预测——甚至没有知道某人正在吃什么或者何时锻炼的好处——我们已经可以说“任务完成”。这已经相当了不起——令人印象深刻的是，我们可以在没有相关输入（如饮食和运动信息）的情况下做出合理的预测。
- en: However, we are aiming mostly for a forecast that will warn people of danger—that
    is, when their blood sugar will go too low or too high. Let’s focus on those data
    points as we consider how our predictions stack up against measured values.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，我们主要的目标是预测会提醒人们危险的预测——即他们的血糖将过低或过高的时候。让我们专注于这些数据点，同时考虑我们的预测与测量值的比较。
- en: 'Importantly, we plot the high and low blood glucose value separately. If we
    plotted them together, we’d see a seemingly high correlation by creating an artificially
    dumbbell-shaped distributed of high and low points (see [Figure 13-16](#fig-1320)):'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 重要的是，我们将高血糖和低血糖值分开绘制。如果将它们绘制在一起，我们将看到一个看似高相关性的人工哑铃形状分布的高低点（见[图13-16](#fig-1320)）：
- en: '[PRE45]'
  id: totrans-205
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: These plots put our model’s performance in a harsher light. Particularly concerning
    is that the model does not do very well at low blood sugar levels. This may be
    because dangerously low blood sugar occurrences are rare incidents, so the model
    does not have much opportunity to train on them. We should consider data augmentation
    or resampling to find ways to make this phenomenon more salient to our model.
    We can also modify our loss function to more heavily weight the examples already
    in our data.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 这些图表更加严格地评估了我们模型的表现。特别令人关注的是，该模型在低血糖水平下表现不佳。这可能是因为危险低血糖发生率较低，所以模型没有太多机会进行训练。我们应考虑数据增强或重新采样，以找到使这种现象对我们的模型更加显著的方法。我们还可以修改我们的损失函数，更加重视我们数据中已有的示例。
- en: '![](assets/ptsa_1316.png)'
  id: totrans-207
  prefs: []
  type: TYPE_IMG
  zh: '![](assets/ptsa_1316.png)'
- en: Figure 13-16\. Plot of the predictions and actual values against one another
    individually at each end of the extreme. On top we plot the values against one
    another for high measured blood glucose values and on the bottom for low measured
    blood glucose values.
  id: totrans-208
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图13-16。绘制预测值与实际值在极端端点处的对比图。在顶部，我们绘制高测量血糖值相互之间的值，底部是低测量血糖值。
- en: Here we have seen a case where an initial model’s forecasts appear respectable
    but may not fulfill the most essential purpose of the model. In this case we can
    predict general blood glucose trends, but we should do more work to predict high
    and low blood sugars, with a particular emphasis on life-threateningly low levels
    of blood sugar.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们看到了一个案例，初始模型的预测看起来令人满意，但可能并没有实现模型最基本的目的。在这种情况下，我们可以预测一般的血糖趋势，但我们应该更多地预测高低血糖，特别是关注血糖严重低下的情况。
- en: In this case, as in the case of flu forecasting, we have seen that common sense
    is essential to modeling time series. We cannot blindly clean data or prepare
    features without thinking about what they mean in context. Similarly, the more
    we know about the domain of the time series, such as understanding the importance
    of the time of day for blood sugars in humans, the better equipped we are to clean
    data, prepare features, and examine our forecasts for important success or failure
    cases.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，就像流感预测一样，我们看到了常识对建模时间序列的重要性。我们不能盲目地清理数据或准备特征，而不考虑它们在上下文中的含义。同样，我们对时间序列领域的了解越多，比如理解时间对人类血糖的重要性，我们就越能够清理数据、准备特征，并检查我们的预测在重要的成功或失败案例中的表现。
- en: More Resources
  id: totrans-211
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 更多资源
- en: Vasileios Lampos et al.,[“Advances in Nowcasting Influenza-Like Illness Rates
    Using Search Query Logs,”](https://perma.cc/NQ6B-RUXF) *Scientific Reports* 5,
    no. 12760 (2015), https://perma.cc/NQ6B-RUXF.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: Vasileios Lampos等人，[“利用搜索查询日志进行流感样疾病率的现场预测进展,”](https://perma.cc/NQ6B-RUXF)
    *科学报告* 5卷，第12760号（2015年），https://perma.cc/NQ6B-RUXF。
- en: This 2015 Nature Communications paper is highly accessible and both a good introduction
    to flu nowcasting as well as a historical piece that shows how nowcasting and
    forecasting were revolutionized by big data and real-time social media and internet
    data inputs. The authors work with both a traditional linear model and an innovative
    nonlinear model to compare different approaches and show the utility of nonlinear
    models in such a complex system as seasonal infectious diseases rates.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 这篇2015年《自然通讯》论文非常易懂，既是流感现场预测的良好介绍，也是一篇历史性的文章，展示了大数据和实时社交媒体以及互联网数据输入如何革新了现场预测和预报。作者们运用传统的线性模型和创新的非线性模型来比较不同的方法，并展示了在季节性传染病率这样复杂系统中非线性模型的实用性。
- en: David Farrow, [“Modeling the Past, Present, and Future of Influenza,”](https://perma.cc/96CZ-5SX2)
    doctoral thesis, Computational Biology Department, School of Computer Science,
    Carnegie Mellon University, 2016, https://perma.cc/96CZ-5SX2.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 大卫·法罗，[“模拟流感的过去、现在和未来,”](https://perma.cc/96CZ-5SX2) 卡内基梅隆大学计算生物学系博士论文，2016年，https://perma.cc/96CZ-5SX2。
- en: This thesis details some of the theory and practice of “sensor fusion” for the
    purposes of integrating social media sources of various geographic and temporal
    granularity to produce one of the Delphi group’s principle influenza forecasts.
    It provides an extremely in-depth overview of predicting the flu, from virology
    to population dynamics to data science experiments on how data processing affects
    forecasts.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 这篇论文详细阐述了“传感器融合”的理论和实践，用于整合各种地理和时间粒度的社交媒体来源，以制定 Delphi 小组的主要流感预测之一。它提供了从病毒学到人口动态再到数据科学实验的深入预测流感的概述。
- en: Rob J. Hyndman, [“Dynamic Regression,”](https://perma.cc/5TPY-PYZS) lecture
    notes, n.d., https://perma.cc/5TPY-PYZS.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: Rob J. Hyndman，《动态回归》，讲义，无日期，https://perma.cc/5TPY-PYZS。
- en: These lecture notes offer practical examples of how to use dynamic regression
    to supplement traditional statistical forecasting models with a series of alternative
    models for seasonality when SARIMA is not expected to be a good fit—usually because
    the periodicity is too complex or the periods are too long relative to the amount
    of data or computing resources available.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 这些讲义提供了如何使用动态回归来补充传统统计预测模型的实际示例，当SARIMA不适合时，可以使用一系列替代模型来处理季节性，通常是因为周期性太复杂或周期相对于可用数据或计算资源来说太长。
- en: ^([1](ch13.html#idm45576020450136-marker)) While this is not a public data set,
    it is possible to access the data by registering for the competition.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: ^([1](ch13.html#idm45576020450136-marker)) 虽然这不是公共数据集，但可以通过注册参加竞赛来访问数据。
- en: ^([2](ch13.html#idm45576020181752-marker)) The correct day of the week (with
    the options being 1 through 7) to begin with depends on what date the flu rate
    was calculated, but we don’t know that from the data provided. We choose the first
    day for simplicity. The last day would be just as sensible in this situation,
    and it is not important to the analysis so long as we are consistent.
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: ^([2](ch13.html#idm45576020181752-marker)) 选择一周的第几天（选项为 1 到 7）作为起始日取决于计算流感率的具体日期，但从提供的数据中我们无法知道这一点。出于简便起见，我们选择第一天。在这种情况下选择最后一天也同样合理，只要我们在分析中保持一致即可。
- en: ^([3](ch13.html#idm45576020179704-marker)) The appropriate formatting string
    for week of the year and day of the week can depend on your operating system.
    My solution worked on a macOS, whereas I used slightly different formatting on
    Linux.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: ^([3](ch13.html#idm45576020179704-marker)) 一年中的周数和星期几的适当格式化字符串可能取决于您的操作系统。我的解决方案在
    macOS 上有效，而在 Linux 上我使用了稍微不同的格式。
- en: ^([4](ch13.html#idm45576020178408-marker)) If we were working in a large data
    set, we should do this as a first step to avoid computationally taxing operations,
    such as converting strings to `Date` objects, for irrelevant data.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: ^([4](ch13.html#idm45576020178408-marker)) 如果我们在处理大数据集时，应将此作为第一步，以避免计算负担较重的操作，例如将字符串转换为`Date`对象，对于无关数据而言。
- en: ^([5](ch13.html#idm45576020010376-marker)) This is not the only necessary check
    to make sure the data is regularly sampled and complete. I leave the rest to you.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: ^([5](ch13.html#idm45576020010376-marker)) 这并非确保数据定期采样和完整性的唯一必要检查。我将其余部分留给你。
- en: ^([6](ch13.html#idm45576019018648-marker)) Normally, you should consider these
    separately, but here they are combined for succinctness.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: ^([6](ch13.html#idm45576019018648-marker)) 通常情况下，你应该单独考虑它们，但这里它们被合并以简洁表达。
- en: ^([7](ch13.html#idm45576019012664-marker)) A Fourier series is the practice
    of describing a function as a series of sines and cosines. We have mentioned Fourier
    series previously in passing. If you are not familiar with Fourier series, consider
    taking a few minutes to read up on the background. There are well-established
    ways to “fit” a Fourier series to any time series, and these are widely available
    in R and Python packages. Ritchie Vink has [one brief tutorial I like a lot](https://perma.cc/7HJJ-HC2T).
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: ^([7](ch13.html#idm45576019012664-marker)) 傅立叶级数是将函数描述为一系列正弦和余弦函数的实践。我们之前曾提及过傅立叶级数。如果您对傅立叶级数不熟悉，请考虑花几分钟了解其背景。在
    R 和 Python 包中广泛提供了将傅立叶级数“拟合”到任何时间序列的方法。Ritchie Vink有一个我非常喜欢的[简短教程](https://perma.cc/7HJJ-HC2T)。
- en: ^([8](ch13.html#idm45576019000504-marker)) These were briefly discussed in [Chapter 3](ch03.html#exploratory_data_analysis_for_time_series).
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: ^([8](ch13.html#idm45576019000504-marker)) 这些在[第 3 章](ch03.html#exploratory_data_analysis_for_time_series)中简要讨论过。
- en: ^([9](ch13.html#idm45576018349528-marker)) To test whether this explanation
    is a good one for the situation, you could use a simulation to generate some synthetic
    data to test alternative data sets with this model and see whether behavior that
    is cyclic rather than seasonal, as the flu data seems to suggest, causes this
    kind of failure of the exogenous harmonic regressor model.
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: ^([9](ch13.html#idm45576018349528-marker)) 要测试这个解释是否适合当前情况，您可以使用模拟生成一些合成数据，以测试使用此模型的替代数据集时，流感数据似乎表明的周期性行为是否会导致外生谐波回归模型失败。
- en: ^([10](ch13.html#idm45576017778568-marker)) The accepted error on blood glucose
    meters tends to be about 15 in the US system of measurement units, which these
    numbers use.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: ^([10](ch13.html#idm45576017778568-marker)) 在美国的测量单位系统中，血糖仪的接受误差通常约为 15，而这些数字使用了该系统。
- en: ^([11](ch13.html#idm45576017777784-marker)) There are other options besides
    suppressing. You can explore these on your own.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: ^([11](ch13.html#idm45576017777784-marker)) 除了抑制之外，还有其他选项。你可以自己探索这些选项。
- en: ^([12](ch13.html#idm45576017241352-marker)) All these observations should be
    taken with a large degree of skepticism. This data set consists only of data from
    a single user for portions of a single year, and the data is not continuous. That
    means we cannot draw conclusions about seasonality even if we are tempted to speculate.
    Still, for purposes of fitting the limited data we have, we will consider these
    temporal components.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: ^([12](ch13.html#idm45576017241352-marker)) 所有这些观察结果都应以高度怀疑的态度看待。这个数据集只包含来自单个用户在部分一年内的数据，并且数据并不连续。这意味着即使我们有诱惑去推测，我们也不能就季节性得出结论。尽管如此，为了适应我们拥有的有限数据，我们将考虑这些时间组件。
- en: ^([13](ch13.html#idm45576015635496-marker)) In practice, and with a larger data
    set, you’d also want to set aside a validation test set, which would be a special
    subset of your training data that was test-like without polluting your actual
    test data. Just as the test data should generally be the most temporally recent
    data (to prevent future information leaking backward, e.g., lookahead), the validation
    data set in such cases should come at the end of the training period. Consider
    setting this up on your own to explore the hyperparameters of the model.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: ^([13](ch13.html#idm45576015635496-marker)) 在实践中，对于较大的数据集，你还需要设置一个验证测试集，这将是你的训练数据的一个特殊子集，类似于测试数据但不会污染你的实际测试数据。正如测试数据通常应该是最近的数据（以防止未来信息向后泄漏，例如前瞻性），在这种情况下，验证数据集应该在训练期末出现。考虑自行设置这一点，以探索模型的超参数。
- en: ^([14](ch13.html#idm45576015629992-marker)) We do not tune the hyperparameters
    here (which would require a validation data set), but that is something you should
    do with XGBoost once you have settled on a general modeling pipeline.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: ^([14](ch13.html#idm45576015629992-marker)) 这里我们不调整超参数（这需要一个验证数据集），但一旦你确定了一般的建模流程，这是你应该在XGBoost中做的事情。
- en: ^([15](ch13.html#idm45576015122376-marker)) One idea would be to apply outlier
    detection in a time series–aware manner to note that these points don’t seem to
    match the general trend for that time window. We could also use basic physics,
    chemistry, and biology in some cases to say that certain drops just aren’t possible.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: ^([15](ch13.html#idm45576015122376-marker)) 一个想法是以时间序列感知的方式应用异常值检测，以注意到这些点与该时间窗口的一般趋势不符。在某些情况下，我们还可以使用基础物理学、化学和生物学来说明某些下降是不可能的。
