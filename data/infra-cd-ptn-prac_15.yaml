- en: 12 Cost of cloud computing
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 12 云计算的成本
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Investigating cost drivers for cloud cost
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 调查云成本的成本驱动因素
- en: Comparing cost-optimization practices
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 比较成本优化实践
- en: Implementing tests for cost-compliant IaC
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实施符合成本规范的IaC测试
- en: Calculating an estimate for infrastructure cost
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 计算基础设施成本估算
- en: When you use a cloud provider, you get very excited at the ease of provisioning.
    After all, you can create a resource at the click of a mouse or a single command.
    However, the cost of cloud computing becomes a concern as your organization scales
    and grows. Your updates to infrastructure as code can affect the overall cost
    of the cloud!
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 当您使用云服务提供商时，您会对配置的便捷性感到非常兴奋。毕竟，您只需点击鼠标或执行一个命令即可创建资源。然而，随着组织的规模扩大和增长，云计算的成本就会成为一个问题。您对基础设施即代码的更新可能会影响云的整体成本！
- en: We must build cost considerations into our infrastructure just as we build security
    into it. If you make your system and find out you overran your cost, you could
    break the system while trying to remove resources and reduce your cloud computing
    bill. In chapter 8, I recommended baking security into IaC like a cake. The cost
    of ingredients affects how many cakes we could bake, essential to know *before*
    you start.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 我们必须像在基础设施中建立安全性一样，将成本考虑纳入其中。如果您发现您的系统成本超支，您在尝试移除资源并减少您的云计算账单时可能会破坏系统。在第8章中，我建议像烘焙蛋糕一样将安全性融入IaC。原料的成本会影响我们可以烘焙的蛋糕数量，这在您开始之前是至关重要的。
- en: This chapter covers the practices you can combine with IaC to manage the cost
    of cloud computing and reduce unused resources. You will find some high-level,
    general cost-control practices and patterns that I describe in the context of
    IaC. However, regularly apply these practices to re-optimize costs as your system
    evolves based on customer demand, organizational scale, and cloud provider billing.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 本章介绍了您可以与基础设施即代码（IaC）结合使用的实践，以管理云计算的成本并减少未使用的资源。您将发现一些高级的、通用的成本控制实践和模式，这些模式我在IaC的背景下进行了描述。然而，根据客户需求、组织规模和云服务提供商的计费情况，随着系统的演变，您需要定期应用这些实践以重新优化成本。
- en: What about the cost of my data center or managed services?
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 我的数据中心或托管服务的成本如何？
- en: I focus primarily on cloud computing because of its flexibility and on-demand
    billing. You often account for the cost of data center computing with your organization’s
    chargeback system. Each business unit establishes a budget for its data center
    resources, and the technology department issues *chargeback* based on resource
    usage, taking into account the operating cost of the data center.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 我主要关注云计算，因为它具有灵活性和按需计费。您通常使用组织的计费系统来计算数据中心计算的成本。每个业务单元为其数据中心资源设立预算，技术部门根据资源使用情况发出*计费*，并考虑数据中心运营成本。
- en: You can always apply the practices for managing your cost drivers with cost
    control and estimation. However, the techniques I outline for cost reduction and
    optimization may or may not work for every situation (no matter whether you’re
    using the cloud, data center, or managed service). Depending on your scale, geographic
    architecture, business domain, or data center usage, your use cases and systems
    may require specialized assessment or re-platforming.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 您始终可以应用管理成本驱动因素的成本控制和估算实践。然而，我概述的成本降低和优化技术可能并不适用于所有情况（无论您是否使用云、数据中心或托管服务）。根据您的规模、地理架构、业务领域或数据中心使用情况，您的用例和系统可能需要专门的评估或重新平台化。
- en: 12.1 Manage cost drivers
  id: totrans-12
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.1 管理成本驱动因素
- en: 'Say you work as a consultant for a company that needs to migrate its platform
    that supports conferences and events to the public cloud. The company asks you
    to “lift and shift” its configuration in its data center to the public cloud.
    You help the company’s teams build out infrastructure in GCP, applying all of
    the principles and practices you learned from this book. Eventually, your team
    rolls out the platform on GCP and successfully supports its first customer: a
    small three-hour community conference.'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 假设您是一家公司的顾问，该公司需要将其支持会议和活动的平台迁移到公共云。公司要求您将数据中心中的配置“迁移和转换”到公共云。您帮助公司的团队在GCP中构建基础设施，应用您从本书中学到的所有原则和实践。最终，您的团队在GCP上推出了平台，并成功支持了其第一位客户：一场为期三小时的社区会议。
- en: 'A few weeks after the event, your client schedules a cryptic meeting. When
    the meeting starts, the client shows you their cloud bill. It totals over $10,000
    for the development and support of a single three-hour conference! The finance
    team does not seem happy with the cost, especially since the company lost money
    running the conference. You get your next task: *reduce the cost per conference
    as much as possible*.'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 事件几周后，您的客户安排了一场神秘的会议。当会议开始时，客户向您展示了他们的云账单。仅一个三小时的会议的开发和支持费用就超过$10,000！财务团队似乎对成本不太满意，尤其是公司举办会议还亏损了。您接下来的任务是：*尽可能降低每场会议的成本*。
- en: Are you using an actual cloud bill?
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 您是否使用实际的云账单？
- en: The preceding example uses a fictitious, *very* simplified cloud bill that approximates
    the cost of a conference platform service based on GCP’s pricing calculator ([https://cloud.google.com/products/calculator](https://cloud.google.com/products/calculator))
    as of 2021\. The estimates may not include all of the offerings you need, updated
    pricing for the platform, differences between environments, or the sizes you might
    use in a comparable system. I rounded the subtotals to streamline the example.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 上述示例使用了一个虚构的、*非常*简化的云账单，该账单基于GCP定价计算器（[https://cloud.google.com/products/calculator](https://cloud.google.com/products/calculator)）2021年的价格，近似计算了会议平台服务的成本。这些估计可能不包括您需要的所有服务、平台的更新定价、环境之间的差异或您可能在类似系统中使用的尺寸。我将小计四舍五入以简化示例。
- en: If you run the example, you may reach a GCP quota for the N2D machine type instances.
    The servers will exceed the platform’s free tier! You can change the machine type
    to free-tier instances to run the examples without a charge.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您运行示例，可能会达到N2D机器类型实例的GCP配额。服务器将超过平台的免费层！您可以将机器类型更改为免费层实例，以便免费运行示例。
- en: Thanks to the tagging practices you borrowed from chapter 8, the bill uses the
    tag to identify which resources belong to the community conference and their environment.
    You manage to break down your cloud computing bill, as shown in table 12.1, and
    identify the costs by the type and size of the infrastructure resource.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 感谢您从第8章借用的标记实践，账单使用标记来识别哪些资源属于社区会议及其环境。您设法将云计算账单分解，如表12.1所示，并按基础设施资源的类型和大小识别成本。
- en: Table 12.1 Your cloud bill by offering and the environment
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 表12.1 按服务和环境划分的云账单
- en: '| Offering | Subtotal, testing environment | Subtotal, production environment
    | Subtotal |'
  id: totrans-20
  prefs: []
  type: TYPE_TB
  zh: '| 服务 | 测试环境小计 | 生产环境小计 | 小计 |'
- en: '| Compute (servers) | $400 | $3,600 | $4,000 |'
  id: totrans-21
  prefs: []
  type: TYPE_TB
  zh: '| 计算机服务器 | $400 | $3,600 | $4,000 |'
- en: '| Database (Cloud SQL) | $250 | $2,250 | $2,500 |'
  id: totrans-22
  prefs: []
  type: TYPE_TB
  zh: '| 数据库（云SQL） | $250 | $2,250 | $2,500 |'
- en: '| Messaging (Pub/Sub) | $100 | $900 | $1,000 |'
  id: totrans-23
  prefs: []
  type: TYPE_TB
  zh: '| 消息传递（Pub/Sub） | $100 | $900 | $1,000 |'
- en: '| Object storage (Cloud Storage) | $100 | $900 | $1,000 |'
  id: totrans-24
  prefs: []
  type: TYPE_TB
  zh: '| 对象存储（云存储） | $100 | $900 | $1,000 |'
- en: '| Data transfer (networking egress) | $100 | $900 | $1,000 |'
  id: totrans-25
  prefs: []
  type: TYPE_TB
  zh: '| 数据传输（网络出口） | $100 | $900 | $1,000 |'
- en: '| Other (Cloud CDN, Support) | $50 | $450 | $500 |'
  id: totrans-26
  prefs: []
  type: TYPE_TB
  zh: '| 其他（云CDN、支持） | $50 | $450 | $500 |'
- en: '| Total | $1,000 | $9,000 | $10,000 |'
  id: totrans-27
  prefs: []
  type: TYPE_TB
  zh: '| 总计 | $1,000 | $9,000 | $10,000 |'
- en: AWS and Azure equivalents
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure等效服务
- en: 'The cloud bill mostly abstracts the specific names for equivalent Azure and
    AWS services. For clarity, I list some of the GCP offerings with approximations
    to AWS or Azure ones:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 云账单主要抽象了等效的Azure和AWS服务的具体名称。为了清晰起见，我列出了一些GCP服务及其对AWS或Azure的近似值：
- en: '*Database (Cloud SQL)*—Amazon RDS, Azure SQL Database'
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*数据库（云SQL）*—Amazon RDS、Azure SQL数据库'
- en: '*Messaging (Pub/Sub)*—Amazon Simple Queue Service (SQS) and Simple Notification
    Service (SNS), Azure Service Bus'
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*消息传递（Pub/Sub）*—Amazon Simple Queue Service (SQS) 和 Simple Notification Service
    (SNS)、Azure Service Bus'
- en: '*Object storage (Cloud Storage)*—Amazon S3, Azure Blob Storage'
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*对象存储（云存储）*—Amazon S3、Azure Blob存储'
- en: '*Other (Cloud CDN, Support)*—Amazon CloudFront, Azure Content Delivery Network
    (CDN)'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*其他（云CDN、支持）*—Amazon CloudFront、Azure内容分发网络（CDN）'
- en: Separating cost by offerings and environments helps you identify which factors
    contribute to the cost and where you should investigate further. To start reducing
    the bill, you must determine the *cost drivers*, the factors or activities that
    affect the total cost.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 按服务和环境划分成本有助于您确定哪些因素导致成本，以及您应该进一步调查的地方。为了开始减少账单，您必须确定*成本驱动因素*，即影响总成本的因素或活动。
- en: Definition *Cost drivers* are the factors or activities that affect your total
    cloud computing cost.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 定义*成本驱动因素*是影响您总云计算成本的因素或活动。
- en: When you assess cost drivers, calculate the percentage cost of cloud offerings.
    Some offerings will always cost more than others. You can still use the breakdown
    to help you identify services to optimize. Breaking down cost by environment helps
    you identify the footprint of testing versus production environments. Comparing
    the two will give you a better picture of which environment has inefficiencies
    you can reduce.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 当你评估成本驱动因素时，计算云服务的百分比成本。某些服务始终比其他服务成本更高。你仍然可以使用这种分解来帮助你识别可以优化的服务。按环境分解成本有助于你识别测试环境和生产环境的足迹。比较这两个环境将为你提供一个更好的图景，了解哪个环境存在你可以减少的低效率。
- en: Based on your breakdown, you calculate the percentage for each offering and
    environment. In figure 12.1, you chart out that compute resources take 40% of
    the bill. You also discover that the team spent 10% of the total on the testing
    environment and 90% on the production environment.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 根据你的分解，你计算每个服务和环境的百分比。在图12.1中，你绘制出计算资源占账单的40%。你还发现，团队在测试环境中花费了总成本的10%，在生产环境中花费了90%。
- en: '![](../../OEBPS/Images/CH12_F01_Wang.png)'
  id: totrans-38
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F01_Wang.png)'
- en: Figure 12.1 The resource tags break down the cost by service and environment.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.1 资源标签按服务和环境分解成本。
- en: A large part of the bill goes to compute resources—specifically, servers. If
    your team members need to support an even larger conference, they need to control
    the type of resources they create and to optimize the resource size based on usage.
    You decide to investigate methods of controlling the size and types of servers
    the team can use.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 账单的大部分都花在了计算资源上——特别是服务器。如果你的团队成员需要支持更大型的会议，他们需要控制他们创建的资源类型，并根据使用情况优化资源大小。你决定调查控制团队可以使用的服务器和类型的方法。
- en: 12.1.1 Implement tests to control cost
  id: totrans-41
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.1.1 实施测试以控制成本
- en: You examine the metrics for the conference and the resource usage for each server.
    None of the servers exceeded their virtual CPU (vCPU) or memory usage. For the
    most part, you determine that you need at most 32 vCPUs for your production environment.
    Your client’s infrastructure team confirms that the maximum usage does not exceed
    32 vCPUs.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 你检查了会议的指标和每个服务器的资源使用情况。没有服务器超过它们的虚拟CPU（vCPU）或内存使用量。大部分情况下，你确定你的生产环境最多需要32个vCPU。你的客户的IT团队确认最大使用量不超过32个vCPU。
- en: Note GCP uses the term *machine type* to refer to a predefined virtual machine
    shape with specific vCPU and memory ratios to fit your workload requirements.
    Similarly, AWS uses the term *instance type*, and Azure uses the term *size*.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 注意GCP使用术语*机器类型*来指代一个预定义的虚拟机形状，具有特定的vCPU和内存比率，以适应你的工作负载需求。同样，AWS使用术语*实例类型*，而Azure使用术语*大小*。
- en: However, the public cloud makes it easy for anyone to adjust a server to use
    48 vCPU. Your bill increases by 50% because of the additional CPU, and you don’t
    even use all of it. To more proactively control the cost using IaC, you combine
    unit testing from chapter 6 and policy enforcement from chapter 8.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，公共云使得任何人都可以轻松地将服务器调整为使用48个vCPU。由于额外的CPU，你的账单增加了50%，而你甚至没有使用完所有这些CPU。为了更积极地使用IaC来控制成本，你结合了第6章中的单元测试和第8章中的策略执行。
- en: '![](../../OEBPS/Images/CH12_F02_Wang.png)'
  id: totrans-45
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F02_Wang.png)'
- en: Figure 12.2 Your test should parse machine types from server configurations,
    check the GCP API for the number of CPUs, and verify they do not exceed the limit.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.2 你的测试应该从服务器配置中解析机器类型，检查GCP API中的CPU数量，并验证它们不超过限制。
- en: Figure 12.2 adds a new policy test to the server’s delivery pipeline. The test
    checks every server defined in IaC for its number of vCPUs and compares it to
    the value returned by the GCP API. If the API’s information exceeds your maximum
    vCPU limit of 32, your test fails.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.2在服务器的交付管道中添加了一个新的策略测试。该测试检查IaC中定义的每个服务器的vCPU数量，并将其与GCP API返回的值进行比较。如果API的信息超过了你32个最大vCPU限制，则测试失败。
- en: Why call the infrastructure provider’s API for vCPU information? Many infrastructure
    providers offer an API or client library to retrieve information about a given
    machine type from their catalogs. You can use this to dynamically get information
    about the number of CPUs and memory.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么调用基础设施提供商的API来获取vCPU信息？许多基础设施提供商提供API或客户端库，可以从他们的目录中检索有关给定机器类型的信息。你可以使用它来动态获取关于CPU数量和内存的信息。
- en: Infrastructure providers change offerings frequently. Furthermore, you cannot
    account for every possible server type. Writing your test to call the infrastructure
    provider API for the most updated information helps improve the overall evolvability
    of the test.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 基础设施提供商经常更改其产品。此外，你无法计算每种可能的服务器类型。编写测试以调用基础设施提供商API以获取最新信息有助于提高测试的整体可扩展性。
- en: In listing 12.1, let’s implement the policy test to check for the maximum vCPU
    limit. First, you build a method to call the GCP API for the number of vCPUs for
    a given machine type.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 在列表12.1中，让我们实现策略测试以检查最大vCPU限制。首先，你构建一个方法来调用GCP API以获取给定机器类型的vCPU数量。
- en: Listing 12.1 Retrieving vCPU count for machine type from the GCP API
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.1 从GCP API检索机器类型的vCPU计数
- en: '[PRE0]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: ❶ Defines a machine type object to store any attributes you might need to check,
    including number of vCPUs
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 定义一个机器类型对象以存储你可能需要检查的任何属性，包括vCPU数量
- en: ❷ Converts megabytes of memory to gigabytes for consistent unit measure
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 将兆字节内存转换为千兆字节以实现一致的单位度量
- en: ❸ Calls the GCP API to retrieve the number of vCPUs for a given machine type
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 调用GCP API以检索给定机器类型的vCPU数量
- en: ❹ Returns a machine type object with vCPU and disk attributes
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 返回一个包含vCPU和磁盘属性的机器类型对象
- en: AWS and Azure equivalents
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure等效
- en: You can use AWS’s Python SDK to retrieve the EC2 instances and parse the instance
    type. Then, describe the instance types to get the vCPU and memory information
    ([http://mng.bz/qYYK](http://mng.bz/qYYK)).
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用AWS的Python SDK来检索EC2实例并解析实例类型。然后，描述实例类型以获取vCPU和内存信息（[http://mng.bz/qYYK](http://mng.bz/qYYK)）。
- en: To get the machine type and stock-keeping units (SKUs) from Azure, use the Azure
    library for Python. After retrieving the size from a list of instances, you can
    call the Resource Skus API for information on the number of CPUs and memory ([http://mng.bz/YG1N](http://mng.bz/YG1N)).
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 要从Azure获取机器类型和库存单位（SKU），请使用Python的Azure库。在从实例列表中检索大小后，你可以调用资源SKU API以获取CPU数量和内存信息（[http://mng.bz/YG1N](http://mng.bz/YG1N)）。
- en: Anytime you use a new machine type, you can use the same function to retrieve
    vCPUs and memory. Next, you write a test to parse every server defined in your
    configuration for its machine type. In the following listing, you retrieve the
    number of vCPUs for the machine type for a list of servers and verify that the
    vCPUs do not exceed the limit of 32.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 每次使用新的机器类型时，你都可以使用相同的函数来检索vCPU和内存。接下来，你编写一个测试来解析配置中定义的每个服务器的机器类型。在下面的列表中，你检索服务器列表中机器类型的vCPU数量，并验证vCPU数量不超过32的限制。
- en: Listing 12.2 Writing a policy test to check that servers do not exceed 32 vCPUs
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.2 编写策略测试以检查服务器是否不超过32个vCPU
- en: '[PRE1]'
  id: totrans-62
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: ❶ Parses and extracts any server JSON configurations across testing and production
    environments
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 解析和提取测试和生产环境中任何服务器的JSON配置
- en: ❷ Sets the CPU limit to 32, the maximum required for the application
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 将CPU限制设置为32，这是应用程序所需的最大值
- en: ❸ Initializes a list of noncompliant servers that exceed the 32 vCPU limit
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 初始化一个超过32个vCPU限制的不合规服务器列表
- en: ❹ For each server configuration, retrieves the machine type attribute and calls
    the GCP API for more information
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 对于每个服务器配置，检索机器类型属性并调用GCP API获取更多信息
- en: ❺ If the server configuration includes a machine type that exceeds 32 vCPUs,
    add it to a list of noncompliant servers.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 如果服务器配置中包含超过32个vCPU的机器类型，将其添加到不符合规定的服务器列表中。
- en: ❻ Checks that all servers comply with the CPU limit. If not, fail the test and
    throw an error for the servers that exceed 32 CPUs.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 检查所有服务器是否遵守CPU限制。如果不遵守，则测试失败，并对超过32个CPU的服务器抛出错误。
- en: You configure the test with a soft mandatory enforcement policy. *Soft mandatory
    enforcement* means your team reviews and approves the more expensive resource
    type before you create it. You can override the machine type to a larger size
    if you have a business justification.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 你使用软强制性执行策略配置测试。*软强制性执行*意味着在你创建之前，你的团队会审查和批准更昂贵的资源类型。如果你有业务理由，你可以将机器类型覆盖为更大的尺寸。
- en: Outside of checking machine types for vCPU and memory limits, you may also need
    to add overrides for unique architectures or machine types that apply to certain
    use cases, like machine learning. However, they cost more than a general-purpose
    resource type.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 除了检查机器类型的vCPU和内存限制外，你可能还需要为适用于某些用例（如机器学习）的独特架构或机器类型添加覆盖。然而，它们比通用资源类型成本更高。
- en: You can test that IaC uses general-purpose resources by default. General-purpose
    machine or resource types offer lower-cost options. If someone needs a specialized,
    more expensive resource, you can enable it with soft mandatory enforcement.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过测试IaC默认使用通用资源来验证。通用机器或资源类型提供更低成本的选项。如果有人需要专用、更昂贵的资源，您可以通过软强制性执行来启用它。
- en: Other tests might include checks for specific configurations like scheduled
    reboots, automatic scaling, or private networking. Each of these configurations
    contributes to optimizing the cost of your resources. Expressing them in IaC lets
    you verify that configuration conforms to best practices to reduce cost early
    in the development process.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 其他测试可能包括对特定配置的检查，如计划重启、自动扩展或私有网络。这些配置中的每一个都有助于优化您资源的成本。在IaC中表达它们可以让您验证配置是否符合最佳实践，从而在开发早期阶段降低成本。
- en: 12.1.2 Automate cost estimation
  id: totrans-73
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.1.2 自动化成本估算
- en: You react to too large or expensive resource changes with policy tests to control
    costs. What if you want a proactive way to check how you change your budget by
    changing cost drivers? Imagine you want to know how adjusting your production
    server size to the machine type of `n2d-standard-16` (16 vCPUs) might affect the
    future cost of a different three-hour conference.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 您通过策略测试来应对过大或昂贵的资源变更以控制成本。那么，如果您想通过改变成本驱动因素来主动检查您的预算如何变化呢？想象一下，您想知道将您的生产服务器大小调整为`n2d-standard-16`（16个vCPU）的机器类型可能会如何影响未来不同三小时会议的成本。
- en: Figure 12.3 outlines the workflow to *estimate* the cost of five servers with
    the machine type `n2d-standard-16`. Once you calculate the price, you can add
    a policy test to verify that the total does not exceed your monthly budget.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.3概述了使用机器类型`n2d-standard-16`估算五台服务器成本的流程。一旦计算出价格，您就可以添加策略测试来验证总额不超过您的月度预算。
- en: '![](../../OEBPS/Images/CH12_F03_Wang.png)'
  id: totrans-76
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F03_Wang.png)'
- en: Figure 12.3 Cost estimation parses IaC for machine types, calculates the monthly
    cost of the resource, and generates a value to compare with your expected budget.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.3成本估算解析IaC的机器类型，计算资源的月度成本，并生成一个与您预期预算进行比较的值。
- en: '*Cost estimation* parses your IaC for resource attributes and generates an
    estimate of their cost. You can use cost estimation to check that your changes
    stay within your budget or assess adjustments to cost drivers.'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: '*成本估算* 解析您的IaC以获取资源属性并生成其成本的估算。您可以使用成本估算来检查您的更改是否在预算范围内，或评估对成本驱动因素的调整。'
- en: Definition *Cost estimation* extracts infrastructure resource attributes and
    generates an estimate of their total cost.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *成本估算* 从基础设施资源属性中提取并生成其总成本的估算。
- en: How does cost estimation help you evolve your infrastructure? Cost estimation
    offers additional transparency into cost drivers that may affect your architecture.
    As you change your system, you can use these tests to help budget and communicate
    charge-back across teams.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 成本估算如何帮助您演进您的基础设施？成本估算提供了对可能影响您架构的成本驱动因素的额外透明度。随着您改变系统，您可以使用这些测试来帮助预算和跨团队之间的费用报销沟通。
- en: Cost estimation example and tools
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 成本估算示例和工具
- en: I wrote minimal code to demonstrate the general workflow of cost estimation.
    For clarity, I omitted some of the code from the text. You can find all of the
    code organized at [https://github.com/joatmon08/manning-book/tree/main/ch12](https://github.com/joatmon08/manning-book/tree/main/ch12).
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 我编写了最少的代码来展示成本估算的一般工作流程。为了清晰起见，我从文本中省略了一些代码。您可以在[https://github.com/joatmon08/manning-book/tree/main/ch12](https://github.com/joatmon08/manning-book/tree/main/ch12)找到所有组织好的代码。
- en: The example uses the Google Cloud Billing Catalog API, which offers a service
    catalog with pricing. I also use a specialized Python client library for the Cloud
    Catalog to access the billing API ([http://mng.bz/mOOn](http://mng.bz/mOOn)).
    The example does not account for specialized pricing, such as sustained use discounts
    or preemptible (equivalent to spot instances in AWS).
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 该示例使用Google Cloud Billing Catalog API，该API提供了一个包含定价的服务目录。我还使用了一个专门的Python客户端库来访问Cloud
    Catalog的API（[http://mng.bz/mOOn](http://mng.bz/mOOn)）。该示例没有考虑专门的定价，例如持续使用折扣或预留实例（在AWS中相当于spot
    instances）。
- en: You will find a few tools that offer cost estimation. Each cloud provider offers
    its own cost estimator user interface for entering your resources. Other tools
    implement a more scalable workflow than my example code to parse configuration,
    call a cloud provider’s API, and calculate a cost estimate. I will not list them
    in this chapter, as they change frequently and depend on the cloud provider and
    your IaC tooling.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 您会发现一些提供成本估算的工具。每个云服务提供商都为其资源提供自己的成本估算用户界面。其他工具实现了一个比我的示例代码更可扩展的工作流程，用于解析配置、调用云服务提供商的
    API 并计算成本估算。我不会在本章中列出它们，因为它们经常变化，并且取决于云服务提供商和您的 IaC 工具。
- en: Get the price per unit
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 获取单价
- en: I recommend dynamically requesting information from a cloud provider’s service
    catalog API. Price per unit can change, and hardcoding the prices often results
    in the wrong cost estimation. To start implementing cost estimation in the example,
    you need some logic to call the cloud provider’s catalog and retrieve the price
    per unit based on your machine type.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 我建议动态地从云服务提供商的服务目录 API 请求信息。单价可能会变化，而硬编码价格通常会导致成本估算错误。要在示例中开始实现成本估算，您需要一些逻辑来调用云服务提供商的目录并获取基于您的机器类型的单价。
- en: The Google Cloud Billing Catalog API offers a list of services and SKUs based
    on price per unit of CPU or memory (RAM). In listing 12.3, you get the service
    identifier for the Google Compute Engine service. The Google Cloud Billing Catalog
    API categorizes prices based on service identifiers, which you must retrieve dynamically.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: Google Cloud 计费目录 API 根据每单位 CPU 或内存（RAM）的价格提供服务和 SKU 列表。在列表 12.3 中，您获取了 Google
    Compute Engine 服务的服务标识符。Google Cloud 计费目录 API 根据服务标识符对价格进行分类，您必须动态检索这些标识符。
- en: Listing 12.3 Getting the Google Compute Engine service from the catalog
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 12.3 从目录中获取 Google Compute Engine 服务
- en: '[PRE2]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: ❶ Creates a client with the Python library for Google Cloud Billing Catalog
    API
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 使用 Python 库创建 Google Cloud 计费目录 API 的客户端
- en: ❷ Gets the service identifier for Google Compute Engine in the catalog
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 在目录中获取 Google Compute Engine 的服务标识符
- en: AWS and Azure equivalents
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 的等效功能
- en: Update the GCP client library to call the AWS Cost Explorer API ([http://mng.bz/5Qm4](http://mng.bz/5Qm4))
    for AWS. On the other hand, Azure offers an open REST API endpoint for retail
    prices ([http://mng.bz/6X9G](http://mng.bz/6X9G)). You can write some additional
    code to request catalog information.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 将 GCP 客户端库更新为调用 AWS 成本探索器 API ([http://mng.bz/5Qm4](http://mng.bz/5Qm4)) 用于
    AWS。另一方面，Azure 提供了一个用于零售价格的开放 REST API 端点 ([http://mng.bz/6X9G](http://mng.bz/6X9G))。您可以编写一些额外的代码来请求目录信息。
- en: You can call the Google Cloud Billing Catalog API a second time for the price
    of a machine type in listing 12.4\. Using the service identifier from the preceding
    step, you get a list of SKUs for the Google Compute Engine service. You write
    some code to parse its response list of SKUs to match the machine type and purpose,
    and retrieve the unit price per CPU or gigabyte of memory.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在列表 12.4 中再次调用 Google Cloud 计费目录 API 来获取机器类型的成本。使用上一步中的服务标识符，您获取了 Google
    Compute Engine 服务的 SKU 列表。您编写一些代码来解析其 SKU 列表响应，以匹配机器类型和用途，并检索每 CPU 或每千兆内存的单元价格。
- en: Listing 12.4 Getting the CPU and RAM price for Compute Engine SKUs
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 12.4 获取 Compute Engine SKU 的 CPU 和 RAM 价格
- en: '[PRE3]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: ❶ Creates a client with the Python library for the Google Cloud Billing Catalog
    API
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 使用 Python 库创建 Google Cloud 计费目录 API 的客户端
- en: ❷ For a machine type like n2d-standard-16, extracts the machine family (N2D)
    and purpose (standard) to identify the SKU
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 对于像 n2d-standard-16 这样的机器类型，提取机器系列（N2D）和用途（标准）以识别 SKU
- en: ❸ If you use a standard machine type, do not search for any specialized Compute
    Service SKUs in the catalog.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 如果您使用标准机器类型，不要在目录中搜索任何专门的计算服务 SKU。
- en: ❹ Retrieves the unit price per CPU or RAM in nano-dollars (10^(–9))
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 获取每 CPU 或 RAM 的单价（以纳美元计，10^(-9)）
- en: ❺ Calls the Google Cloud Billing Catalog and retrieves a list of SKUs for the
    Compute Service
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 调用 Google Cloud 计费目录并检索计算服务的 SKU 列表
- en: ❻ Finds SKUs that match the region, machine family, and purpose of the machine
    type based on its description
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 根据机器类型的描述，找到与区域、机器系列和用途匹配的 SKU
- en: The Google Cloud Billing Catalog sets a unit price based on the number of CPUs
    and gigabytes of memory. As a result, you cannot search based on the name of the
    machine type. Instead, you need to correlate the general-purpose machine type
    with the catalog’s description.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: Google Cloud 计费目录根据 CPU 数量和内存的千兆字节数设定单价。因此，您不能根据机器类型的名称进行搜索。相反，您需要将通用机器类型与目录描述相关联。
- en: Calculate the monthly cost for a single resource
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 计算单个资源的月度成本
- en: Once you retrieve the CPU and RAM unit price for a given machine type, you can
    use it to calculate a monthly cost for a single instance of the machine. Some
    cloud catalogs set up a unit price by a factor. For example, GCP uses nano units,
    which means you need to also multiply by the factor. Listing 12.5 implements the
    code to calculate the monthly cost for a single server. You multiply the unit
    price by the average number of hours per month, 730, and the nano units.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你检索到给定机器类型的 CPU 和 RAM 单价，你可以用它来计算单个实例的月度成本。一些云目录通过一个因子设置单价。例如，GCP 使用纳单位，这意味着你还需要乘以这个因子。列表12.5实现了计算单个服务器月度成本的代码。你将单价乘以每月平均小时数，730，以及纳单位。
- en: Listing 12.5 Calculating the monthly cost for a single server
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.5 计算单个服务器的月度成本
- en: '[PRE4]'
  id: totrans-107
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: ❶ Sets a constant for the average of 730 hours in a month and converts nano-dollars
    to dollars (10^(–9)).
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 设置一个常量，表示一个月730小时的平均值，并将纳美元转换为美元（10^(-9)）。
- en: ❷ Gets the Compute Engine service identifier from the Google Cloud Billing Catalog
    API
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 从 Google Cloud Billing Catalog API 获取 Compute Engine 服务标识符
- en: ❸ Sets up the SKU for the machine type and gets its CPU and RAM unit pricing
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 为机器类型设置 SKU 并获取其 CPU 和 RAM 单价
- en: ❹ Multiplies a machine type’s number of CPUs by unit price and hours in the
    month
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 将机器类型的 CPU 数量乘以单价和该月的小时数
- en: ❺ Multiplies a machine type’s gigabytes of memory (RAM) by unit price and hours
    in the month
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 将机器类型的内存（RAM）容量（以千兆字节为单位）乘以单价和该月的小时数
- en: ❻ Sums up the CPU and RAM cost and converts it to dollar units
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 将 CPU 和 RAM 成本相加，并将其转换为美元单位
- en: You now have a minimal form of cost estimation that calculates the cost of a
    single server. With the initial cost calculation for a single server, you can
    parse your IaC for all servers, retrieve their machine types and regions, and
    calculate a total cost. In the future, you can add more logic to retrieve SKUs
    for other services, like databases or messaging.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经有一个最小化的成本估算形式，它可以计算单个服务器的成本。通过单个服务器的初始成本计算，你可以解析所有服务器的 IaC，检索它们的机器类型和区域，并计算总成本。在未来，你可以添加更多逻辑来检索其他服务的
    SKU，如数据库或消息传递。
- en: Check that your cost does not exceed the budget
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 检查你的成本是否不超过预算
- en: You decide that you can do more with your cost estimation. You write a test
    with a soft mandatory enforcement approach to check whether your estimated cost
    exceeds your monthly budget. For example, your client tells you that a conference
    should not exceed a monthly budget of $4,500\. You can compare your cost estimation
    to the budget and proactively identify any cost drivers.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 你决定你可以用你的成本估算做更多的事情。你编写了一个带有软强制性执行方法的测试，以检查你的估算成本是否超过了你的月度预算。例如，你的客户告诉你，一个会议不应超过4500美元的月度预算。你可以将你的成本估算与预算进行比较，并主动识别任何成本驱动因素。
- en: Let’s write a test to estimate the new cost of servers and compare it to the
    budget. In the following listing, you parse your IaC for all servers and count
    the number of servers with specific machine types and regions.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们编写一个测试来估算服务器的新的成本，并将其与预算进行比较。在以下列表中，你解析所有服务器的 IaC 并计算具有特定机器类型和区域的服务器数量。
- en: Listing 12.6 Parsing IaC for all servers
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.6 解析所有服务器的 IaC
- en: '[PRE5]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: ❶ Reads every configuration file that defines each environment, such as testing
    and production
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 读取定义每个环境的配置文件，例如测试和生产
- en: ❷ For each server in the configuration file, creates a list of their regions
    and machine types
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 对于配置文件中的每个服务器，创建它们的区域和机器类型列表
- en: ❸ Calls the Google Compute API and gets details on the machine type, such as
    its number of CPUs and memory
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 调用 Google Compute API 并获取有关机器类型的详细信息，例如其 CPU 数量和内存
- en: ❹ Tracks the number of servers with the specific machine type and region to
    streamline the SKUs you need to retrieve
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 跟踪具有特定机器类型和区域的服务器数量，以简化你需要检索的 SKU
- en: You can call these methods in your test to retrieve cost information for each
    machine type in a specific region and sum the total cost. The test in the following
    listing checks whether the total cost exceeds the monthly budget of $4,500.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在测试中调用这些方法来检索特定区域中每种机器类型的成本信息，并计算总成本。以下列表中的测试检查总成本是否超过4500美元的月度预算。
- en: Listing 12.7 Getting CPU and RAM price for Compute Engine SKUs
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.7 获取 Compute Engine SKU 的 CPU 和 RAM 价格
- en: '[PRE6]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: ❶ Sets a constant to communicate the expected monthly compute budget
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 设置一个常量，以传达预期的月度计算预算
- en: ❷ Tests that the cost of your servers does not exceed the monthly compute budget
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 测试你的服务器成本是否不超过月度计算预算
- en: ❸ Calculates the monthly total per server based on machine type and region,
    multiplied by servers for that machine type, and sums up the total
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 根据机器类型和区域计算每台服务器的月度总成本，乘以该机器类型的服务器数量，然后汇总总成本
- en: ❹ Confirms that the estimated total cost does not exceed the monthly compute
    budget
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 确认估算的总成本不超过月度计算预算
- en: You now have a test to estimate the total monthly cost of computing resources
    and compare it to your budget! Each time someone changes the infrastructure, the
    test recalculates the new cost of the system.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在有一个测试来估算计算资源的总月度成本，并将其与你的预算进行比较！每次有人更改基础设施时，测试都会重新计算系统的新的成本。
- en: A cost estimation gives you a general view of your infrastructure cost but may
    not accurately reflect your actual bill. You’ll have to account for a certain
    margin of error. If your estimation exceeds the monthly budget, it may indicate
    that you need to reassess size and resource usage. You’ll also refine your monthly
    budget over time depending on the growth of your systems.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 成本估算可以给你提供一个关于基础设施成本的一般视图，但可能无法准确反映你的实际账单。你必须考虑到一定的误差范围。如果你的估算超过了月度预算，这可能表明你需要重新评估规模和资源使用。你还将根据你系统的增长，随着时间的推移调整你的月度预算。
- en: Continuous delivery with cost estimation
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 带有成本估算的持续交付
- en: How do you check that infrastructure changes do not exceed your budget? Each
    time you change your IaC and push it to a repository, your cost estimation and
    test for budget runs. Budget tests in your pipeline help you identify costly infrastructure
    changes and refine the resource in a testing environment. The process prevents
    chargeback in the production environment.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 你如何检查基础设施变更是否不超过你的预算？每次你更改IaC并将其推送到仓库时，你的成本估算和预算测试都会运行。管道中的预算测试帮助你识别昂贵的基础设施变更并在测试环境中优化资源。这个过程可以防止生产环境中的费用追回。
- en: For example, let’s say you want to add another server to the testing environment
    for a different conference. In figure 12.4, you create a configuration to add
    another server with the machine type of `n2d-standard-8`. The pipeline runs a
    test to calculate the monthly cost with the new server and check it against the
    monthly budget.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，假设你想要为不同的会议向测试环境添加另一台服务器。在图12.4中，你创建了一个配置来添加一台具有`n2d-standard-8`机器类型的另一台服务器。管道运行一个测试来计算带有新服务器的月度成本，并将其与月度预算进行比较。
- en: '![](../../OEBPS/Images/CH12_F04_Wang.png)'
  id: totrans-136
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F04_Wang.png)'
- en: Figure 12.4 Adding another server exceeds your budget of $4,500, causing the
    test to fail.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.4 添加另一台服务器超出了4,500美元的预算，导致测试失败。
- en: 'You push the configuration to the repository, and your delivery pipeline runs
    the tests to check for budget compliance. The pipeline fails! You check the logs
    and discover that your cost estimation exceeds the expected monthly budget:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 你将配置推送到仓库，并且你的交付管道会运行测试来检查预算合规性。管道失败了！你检查日志并发现你的成本估算超过了预期的月度预算：
- en: '[PRE7]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: You speak with your finance team. The finance analyst confirms that the budget
    can increase to accommodate the new testing instance. You update the monthly budget
    within the test to $4,700 for future changes!
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 你与财务团队进行了沟通。财务分析师确认预算可以增加以适应新的测试实例。你更新了测试中的月度预算，将其调整为4,700美元，以应对未来的变化！
- en: Whether you write a cost estimation mechanism or use a tool, you should consider
    adding it to your delivery pipelines as another test for policy. Estimation helps
    guide instance sizing and usage. It should *never* stop a change before production.
    Instead, it should provide an *opportunity* for you to reassess the need for the
    resource.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你是编写成本估算机制还是使用工具，你应该考虑将其添加到你的交付管道中作为另一个策略测试。估算有助于指导实例大小和用量。它应该*永远*不会在生产前阻止变更。相反，它应该为你提供一个*机会*来重新评估资源的需求。
- en: Do not account for every cost driver as part of your cost estimation. Instead,
    choose the resources that make up the bulk of your bill. The example focuses on
    computing resources like servers, which often contribute significantly to the
    cost. You might implement cost estimation for other resources, like databases
    or messaging frameworks.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 不要将每个成本驱动因素都计入你的成本估算中。相反，选择构成你账单大部分的资源。示例侧重于计算资源，如服务器，这些资源通常对成本贡献很大。你可能还需要对其他资源，如数据库或消息框架，实施成本估算。
- en: Always question the accuracy of your cost estimation! You cannot predict the
    resources you will create or how you use them. For example, you might find it
    hard to estimate the cost to transfer data between regions or services until it
    happens. Reconcile your cost estimate with your monthly bill and assess which
    cost drivers contribute to the difference.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 总是质疑你的成本估算的准确性！你不能预测你将创建的资源或你如何使用它们。例如，你可能发现很难估算在不同区域或服务之间传输数据的成本，直到它发生。将你的成本估算与你的月度账单对账，并评估哪些成本驱动因素导致了差异。
- en: A monthly comparison can help you identify any changes and budget for the actual
    cost based on a multiplier of the estimate. In the remainder of the chapter, we’ll
    discuss ways to reduce cloud waste and optimize cost outside of proactive measures
    like testing or estimation.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 每月比较可以帮助你识别任何变化，并根据估算的乘数预算实际成本。在本章的剩余部分，我们将讨论减少云浪费和优化成本的方法，这些方法超出了主动措施，如测试或估算。
- en: Exercise 12.1
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 练习12.1
- en: Given the following code, which of the following statements are true? (Choose
    all that apply.)
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 给定以下代码，以下哪些陈述是正确的？（选择所有适用的选项。）
- en: '[PRE8]'
  id: totrans-147
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: A) The test will pass because the cost of the database is within the budget.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: A) 测试将通过，因为数据库的成本在预算内。
- en: B) The test estimates the monthly cost of databases.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: B) 测试估算数据库的每月成本。
- en: C) The test does not account for different database types.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: C) 测试不考虑不同数据库类型。
- en: D) The test calculates the monthly cost per database instance.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: D) 测试计算每个数据库实例的每月成本。
- en: E) The test includes a buffer of 10% for any cost overage as a soft mandatory
    policy.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: E) 测试包括10%的缓冲，作为软强制性政策，以应对任何成本超支。
- en: See appendix B for answers to exercises.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 请参阅附录B以获取练习的答案。
- en: 12.2 Reduce cloud waste
  id: totrans-154
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.2 减少云浪费
- en: You can use IaC to implement proactive measures to manage cost drivers for cloud
    computing. However, you need to combine them with other practices to continue
    to reduce and optimize costs. After all, your client in the example still doesn’t
    appreciate a $10,000 cloud bill for a three-hour conference!
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用IaC（基础设施即代码）来实施主动措施，以管理云计算的成本驱动因素。然而，你需要将它们与其他实践相结合，以继续减少和优化成本。毕竟，在示例中，你的客户仍然不欣赏为三小时会议支付10,000美元的云账单！
- en: If you provision a large server but do not use all the CPU or memory, you have
    wasted unused CPU or memory. You have an opportunity to reduce your cloud computing
    cost! One approach you can take to improve your bill’s state involves eliminating
    *cloud waste*, unused or underutilized infrastructure resources.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你配置了一个大服务器但未使用所有CPU或内存，你浪费了未使用的CPU或内存。你有机会降低你的云计算成本！你可以采取的一种改进账单状态的方法是消除*云浪费*，即未使用或利用率不足的基础设施资源。
- en: Definition *Cloud waste* is unused or underutilized infrastructure resources.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 定义*云浪费*是指未使用或利用率不足的基础设施资源。
- en: You can reduce cloud waste by deleting, expiring, or stopping unused resources;
    scheduling or scaling instances based on usage; and assessing the right resource
    size or type for your system; see figure 12.5.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过删除、过期或停止未使用的资源；根据使用情况安排或调整实例；以及评估适合你系统的正确资源大小或类型来减少云浪费；参见图12.5。
- en: '![](../../OEBPS/Images/CH12_F05_Wang.png)'
  id: totrans-159
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F05_Wang.png)'
- en: Figure 12.5 You can reduce cloud waste by removing unused resources, or scheduling
    and sizing resources to accommodate usage patterns.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.5 你可以通过删除未使用的资源，或安排和调整资源以适应使用模式来减少云浪费。
- en: Identifying cloud waste often starts as the first response to a surprising cost
    on your public cloud bill. However, you can use these techniques in your data
    center, especially for a private cloud. While they do not provide an immediate
    short-term benefit, they help optimize data center resource usage and long-term
    cost reduction.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 识别云浪费通常是从对公共云账单上令人惊讶的成本的第一反应开始的。然而，你可以在数据中心使用这些技术，特别是对于私有云。虽然它们不会提供即时的短期利益，但它们有助于优化数据中心资源使用和长期成本降低。
- en: 12.2.1 Stop untagged or unused resources
  id: totrans-162
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.2.1 停止未标记或未使用的资源
- en: Sometimes you and your team will create infrastructure resources for testing
    or other configuration. You end up forgetting about them until they show up on
    your cloud bill. As a first iteration of reducing cloud waste, you can identify
    unused resources and remove them.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 有时你和你的团队会创建基础设施资源进行测试或其他配置。你最终会忘记它们，直到它们出现在你的云账单上。作为减少云浪费的第一步迭代，你可以识别未使用的资源并将它们删除。
- en: Recall that you have a mission of reducing the cost of running a conference
    for your client. Could you reduce costs by identifying unused resources? Yes!
    Sometimes our teams create resources for testing and forget to remove them.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 回想一下，你有一个使命，那就是降低你客户举办会议的运营成本。你能通过识别未使用资源来降低成本吗？是的！有时我们的团队为测试创建了资源，却忘记了移除它们。
- en: For example, you retrieve a list of servers in your Google Cloud projects and
    examine them in table 12.2\. While many of them in testing and production have
    tags, you notice two instances with no tags. The `n2d-standard-16` machines cost
    about $700 (7% of the total monthly bill).
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，你检索了你 Google Cloud 项目中的服务器列表，并在表 12.2 中检查它们。虽然许多测试和生产中的服务器都有标签，但你注意到有两个实例没有标签。`n2d-standard-16`
    机器的费用约为 $700（占月度总账单的 7%）。
- en: Table 12.2 Cost of servers by type and environment
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 表 12.2 按类型和环境划分的服务器成本
- en: '| Machine type | Environment | Number of servers | Subtotal |'
  id: totrans-167
  prefs: []
  type: TYPE_TB
  zh: '| 机器类型 | 环境 | 服务器数量 | 小计 |'
- en: '| `n2d-standard-8` | Testing | 2 | $400 |'
  id: totrans-168
  prefs: []
  type: TYPE_TB
  zh: '| `n2d-standard-8` | 测试 | 2 | $400 |'
- en: '| `n2d-standard-16` | Production | 2 | $700 |'
  id: totrans-169
  prefs: []
  type: TYPE_TB
  zh: '| `n2d-standard-16` | 生产 | 2 | $700 |'
- en: '| `n2d-standard-32` | Production | 3 | $2,900 |'
  id: totrans-170
  prefs: []
  type: TYPE_TB
  zh: '| `n2d-standard-32` | 生产 | 3 | $2,900 |'
- en: '| Total | $4,000 |'
  id: totrans-171
  prefs: []
  type: TYPE_TB
  zh: '| 总计 | $4,000 |'
- en: You ask the team about the untagged instances in production. They created the
    servers for a sandbox to verify the application but never used them. Just to make
    sure, you check the server usage metrics over the month, and they all stayed at
    zero. You identified some cloud waste!
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 你询问团队关于生产中的未标记实例。他们为沙盒创建了服务器以验证应用程序，但从未使用过它们。为了确保，你检查了整个月的服务器使用指标，它们都保持在零。你识别了一些云浪费！
- en: The team did create the servers with IaC. You delete the configuration and push
    the changes to remove the unused instances. Deleting the configuration removes
    the disks and resources attached to the instances. Fortunately, the cloud bill
    for your next conference reflects the reduction.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 团队确实使用基础设施即代码(IaC)创建了服务器。你删除了配置并推送更改以移除未使用的实例。删除配置会移除附加到实例的磁盘和资源。幸运的是，你下一次会议的云账单反映了这种减少。
- en: Why would you confirm usage of the server by metrics and team members? You do
    not want to remove the resource by accident. Sometimes you have unexpected dependencies
    on what seems like an unused resource.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么你会通过指标和团队成员确认服务器的使用情况？你不想意外地删除资源。有时你对看似未使用的资源有意外依赖。
- en: Make sure that any resources you intend to delete do not have additional dependencies.
    If you have concerns about deleting an untagged or unused resource, you can always
    stop the resource for a week or two, wait to determine if it breaks the system,
    and then delete it.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 确保你打算删除的资源没有其他依赖。如果你对删除未标记或未使用的资源有顾虑，你可以总是停止资源一周或两周，等待确定它是否破坏了系统，然后删除它。
- en: 12.2.2 Start and stop resources on a schedule
  id: totrans-176
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.2.2 按计划启动和停止资源
- en: Your next cloud bill comes back 7% less, thanks to the removal of unused servers.
    However, the finance team wants you to reduce it even more. You puzzle over this
    until you talk to one of the client’s team members. They mention that they never
    run testing or use any of their infrastructure resources over the weekends. The
    client needs the platform available the weekend before the conference.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 你的下一次云账单比上次减少了7%，这得益于未使用服务器的移除。然而，财务团队希望你能进一步降低成本。你对此感到困惑，直到你与客户团队的一员交谈。他们提到，他们周末从不运行测试或使用任何基础设施资源。客户需要在会议前一周的平台可用。
- en: Could you find a way to turn off the servers on a Friday night and turn them
    on each Monday? You do not get charged for the 48 hours you shut down the servers.
    Scheduling a regular shutdown means cost reduction.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 你能否找到一种方法在周五晚上关闭服务器，并在每周一打开它们？你不会因为关闭服务器48小时而付费。安排定期关机意味着成本降低。
- en: You discover that GCP defines an instance shutdown schedule with a compute resource
    policy ([http://mng.bz/o25N](http://mng.bz/o25N)). You start the servers each
    Monday and shut them down each Saturday, as outlined in figure 12.6.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 你发现 GCP 使用计算资源策略定义了一个实例关机时间表([http://mng.bz/o25N](http://mng.bz/o25N))。你每周一启动服务器，每周六关闭它们，如图
    12.6 所示。
- en: '![](../../OEBPS/Images/CH12_F06_Wang.png)'
  id: totrans-180
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F06_Wang.png)'
- en: Figure 12.6 You can reduce cost by scheduling a resource to start and stop when
    not in use.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.6 你可以通过安排资源在不使用时启动和停止来降低成本。
- en: Shutting down instances on a schedule alleviates the cost of running servers.
    However, this technique works *only* if you understand the behavior of your system.
    Starting and stopping resources on a schedule can disrupt development work.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 按计划关闭实例可以减轻运行服务器的成本。然而，这项技术*仅*在你了解你系统的行为时才有效。按计划启动和停止资源可能会干扰开发工作。
- en: Some applications do not have fault tolerance and would continue to fail even
    if a resource restarts successfully. In general, most reboot schedules run only
    in testing environments. The schedule provides an opportunity for you to verify
    your system’s resilience because you have a planned outage each weekend.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 一些应用程序没有容错机制，即使资源成功重启，也会继续失败。一般来说，大多数重启计划只在测试环境中运行。该计划为你提供了一个机会来验证你系统的弹性，因为每个周末你都有一个计划中的停机。
- en: Listing 12.8 implements the resource policy for instance scheduling in GCP.
    The schedule expires the week before the conference, so it does not shut down
    the servers over the weekend. The development team might need to work on the platform
    in the few days before the conference.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.8 在GCP中实现了实例调度的资源策略。该计划在会议前一周到期，因此周末不会关闭服务器。开发团队可能需要在会议前的几天内在该平台上工作。
- en: Listing 12.8 Creating a resource policy for instance scheduling
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.8 为实例调度创建资源策略
- en: '[PRE9]'
  id: totrans-186
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: ❶ Expires the schedule the week before the conference, using the RFC 3339 date
    format
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 在会议前一周使用RFC 3339日期格式过期计划
- en: ❷ Creates a compute resource policy with an instance schedule
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 创建一个具有实例调度的计算资源策略
- en: ❸ Starts the virtual machines every Monday at midnight
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 每周一午夜启动虚拟机
- en: ❹ Stops the virtual machines every Saturday at midnight
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 每周六午夜停止虚拟机
- en: ❺ Runs the schedule in the US central time zone since development teams work
    in the central United States
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 在美国中部时区运行计划，因为开发团队在中部美国工作
- en: AWS and Azure equivalents
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure的等效功能
- en: Other public cloud providers usually offer a similar automation capability to
    start and stop the virtual machines on a schedule. For example, AWS uses Instance
    Scheduler to start and stop servers and databases ([http://mng.bz/nNev](http://mng.bz/nNev)).
    Similarly, Azure uses a start/stop virtual machine workflow based on Azure functions
    ([http://mng.bz/v6Xx](http://mng.bz/v6Xx)).
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 其他公共云提供商通常提供类似的自动化功能，以按计划启动和停止虚拟机。例如，AWS使用实例调度器来启动和停止服务器和数据库([http://mng.bz/nNev](http://mng.bz/nNev))。同样，Azure基于Azure函数使用启动/停止虚拟机工作流([http://mng.bz/v6Xx](http://mng.bz/v6Xx))。
- en: If your public or private cloud platform does not offer scheduled shutdown capabilities,
    you will need to write your automation to run on a regular schedule. I implemented
    this before using various tools, including serverless functions, cron jobs on
    container orchestrators, or scheduled runs on continuous integration frameworks.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的公共或私有云平台不提供计划关闭功能，你需要编写自动化代码以定期运行。我在使用各种工具之前实现了这一点，包括无服务器函数、容器编排器上的cron作业或持续集成框架上的计划运行。
- en: Instead of running seven servers 730 hours per month, you run it about 144 hours
    less (assuming three weekends in a month and a 48-hour shutdown). Using your cost
    estimation code, you update your calculation for 586 hours per month. It outputs
    that you reduced the overall cost by $700 (7% of the total monthly bill)!
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 与每月运行730小时的服务器相比，你大约少运行了144小时（假设一个月有三个周末和48小时的关闭时间）。使用你的成本估算代码，你更新了每月586小时的计算。它输出你将整体成本降低了700美元（总月账单的7%）！
- en: The example adds the schedule to the testing environment. However, you could
    add a reboot schedule to a production environment if it has cyclical usage patterns.
    For example, the conference platform runs on demand for three hours and serves
    user traffic only during the week. Shutting down servers and databases for 48
    hours does not disrupt user traffic. However, you may not want to implement a
    reboot schedule in a production environment that serves requests continuously.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 该示例将计划添加到测试环境中。然而，如果你有一个具有周期性使用模式的运行环境，你也可以将重启计划添加到生产环境中。例如，会议平台按需运行三小时，仅在周一至周五服务用户流量。关闭服务器和数据库48小时不会干扰用户流量。然而，你可能不希望在持续服务请求的生产环境中实施重启计划。
- en: 12.2.3 Choose the correct resource type and size
  id: totrans-197
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.2.3 选择正确的资源类型和大小
- en: If your production environment needs to serve customers 24 hours a day, seven
    days a week, you can still reduce cloud waste without a resource schedule by assessing
    your resource types and sizes. Many resources do not utilize their CPU or memory
    fully.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的生产环境需要每天24小时、每周7天服务客户，您仍然可以通过评估资源类型和大小来减少云浪费，而无需资源计划。许多资源并没有充分利用它们的CPU或内存。
- en: Many times, we provision larger resources because we don’t know how much we
    need. After running a system for some time, you can adjust the size of the resource
    for its actual usage. You can reduce cost by changing a resource type, size, reservation,
    replicas, or even cloud provider, as shown in figure 12.7.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 许多时候，我们分配更大的资源是因为我们不知道需要多少。运行系统一段时间后，您可以调整资源的大小以适应其实际使用。您可以通过更改资源类型、大小、预留、副本甚至云服务提供商来降低成本，如图12.7所示。
- en: '![](../../OEBPS/Images/CH12_F07_Wang.png)'
  id: totrans-200
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F07_Wang.png)'
- en: Figure 12.7 You can change a resource’s attributes to utilize it better and
    reduce its cost.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.7 您可以通过更改资源的属性来更好地利用它并降低其成本。
- en: You decide to investigate your client’s conference platform to find cloud waste
    in resource type and size. You realize you cannot reduce the cost of computing
    resources, so you check the database (Cloud SQL). The team provisioned the production
    database for 4 TB of solid-state drive (SSD) storage, detailed in table 12.3.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 您决定调查客户的会议平台以找到资源类型和大小上的云浪费。您意识到您无法降低计算资源的成本，因此您检查了数据库（Cloud SQL）。团队为生产数据库预留了4
    TB的固态硬盘（SSD）存储，详情见表12.3。
- en: Table 12.3 Your cloud bill by offering and resource
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 表12.3 按提供和资源计算您的云账单
- en: '| Offering | Type | Environment | Number | Subtotal |'
  id: totrans-204
  prefs: []
  type: TYPE_TB
  zh: '| 提供商 | 类型 | 环境 | 数量 | 小计 |'
- en: '| Cloud SQL | $2,500 |'
  id: totrans-205
  prefs: []
  type: TYPE_TB
  zh: '| Cloud SQL | $2,500 |'
- en: '|  | db-standard-1, 400 GB SSD, 600 GB backup | Testing | 1 | $250 |'
  id: totrans-206
  prefs: []
  type: TYPE_TB
  zh: '|  | db-standard-1, 400 GB SSD, 600 GB backup | 测试 | 1 | $250 |'
- en: '|  | db-standard-4, 4 TB SSD, 6 TB backup | Production | 1 | $2,250 |'
  id: totrans-207
  prefs: []
  type: TYPE_TB
  zh: '|  | db-standard-4, 4 TB SSD, 6 TB backup | 生产 | 1 | $2,250 |'
- en: After checking metrics and database usage, you realize that it needs only a
    1 TB SSD. You update the disk size of the database in your IaC. Fixing the size
    reduces the cost of the database by $1,350 (22.5% of the total monthly bill)!
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 在检查指标和数据库使用情况后，您意识到它只需要1 TB的SSD。您更新了IaC中数据库的磁盘大小。调整大小将数据库成本降低了$1,350（占月度总账单的22.5%）！
- en: You might not use a resource to its full potential in many other ways. You might
    consider changing the type of resource if it uses a more expensive machine type.
    You need to ask yourself and your team, “Do we need this high-performance database
    in my testing environment if we do not run performance tests?”
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 您可能以许多其他方式没有充分利用资源。如果它使用更昂贵的机器类型，您可能需要考虑更改资源类型。您需要问自己和您的团队，“如果我们不运行性能测试，我们是否真的需要在测试环境中运行这个高性能数据库？”
- en: Probably not! Choosing the right size and type for a given environment may take
    a few iterations. You want to choose a resource type, size, and replicas that
    simulate production without making it an exact duplicate in cost.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 可能不是！为特定环境选择正确的大小和类型可能需要几次迭代。您希望选择一个资源类型、大小和副本，以模拟生产环境，而不使其在成本上完全相同。
- en: For the conference example, you might have three `n2d-standard-32` instances
    in production and three `n2d-standard-8` instances in your testing environment.
    The configuration still tests the three application instances without incurring
    a cost of 72 CPUs.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 对于会议示例，您可能在生产中有三个`n2d-standard-32`实例，在测试环境中有三个`n2d-standard-8`实例。配置仍然测试了三个应用程序实例，而没有产生72个CPU的成本。
- en: Other times, you can change the resource’s reservation type. GCP and many other
    cloud providers offer an *ephemeral* (also known as *spot* or *preemptible*) resource
    type. The resource costs less, but the cloud provider reserves the right to stop
    the resource and give CPU or memory to another customer. While an ephemeral resource
    reservation can reduce cost, you need to carefully consider whether your application
    and system can handle the disruption.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 有时，您还可以更改资源的预留类型。GCP和许多其他云服务提供商提供了一种*短暂性*（也称为*现货*或*可抢占性*）的资源类型。这种资源成本较低，但云服务提供商保留停止资源并将CPU或内存分配给其他客户的权利。虽然短暂性资源预留可以降低成本，但您需要仔细考虑您的应用程序和系统是否能够处理这种中断。
- en: 12.2.4 Enable autoscaling
  id: totrans-213
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.2.4 启用自动扩展
- en: You tried to identify as much cloud waste as possible in your environment but
    still want to reduce costs further. Many systems have customer usage patterns
    that do not require their CPU, memory, or bandwidth in the system every hour of
    every day.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 您试图在环境中识别尽可能多的云浪费，但仍希望进一步降低成本。许多系统具有客户使用模式，这些模式不需要系统中的CPU、内存或带宽在每天每小时都使用。
- en: For example, the conference platform needed 100% of its capacity during only
    the three hours of the conference! Could you have automatically increased or decreased
    the number of servers based on demand?
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，会议平台只在会议的三小时内需要其全部容量！您能否根据需求自动增加或减少服务器数量？
- en: Figure 12.8 sets the target utilization to 75% of CPU usage so that the GCP
    managed instance group starts and stops servers to match the target metric. It
    increases and decreases the size of the group based on demand.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.8 将目标利用率设置为CPU使用量的 75%，以便 GCP 管理实例组启动和停止服务器以匹配目标指标。它根据需求增加和减少组的大小。
- en: '![](../../OEBPS/Images/CH12_F08_Wang.png)'
  id: totrans-217
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH12_F08_Wang.png)'
- en: Figure 12.8 An autoscaling group includes a target utilization rate, which allows
    it to start and stop resources to adjust for usage automatically.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.8 自动扩展组包括一个目标利用率，这允许它自动启动和停止资源以调整使用情况。
- en: You added autoscaling for each group of servers. *Autoscaling* increases or
    decreases the number of resources in a group based on a metric, such as CPU or
    memory. Many public cloud providers offer an autoscaling group resource that you
    can create with IaC.
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 您为每个服务器组添加了自动扩展。*自动扩展* 根据指标（如CPU或内存）增加或减少组中的资源数量。许多公共云提供商提供自动扩展组资源，您可以使用基础设施即代码（IaC）创建。
- en: Definition *Autoscaling* is the practice of automatically increasing or decreasing
    the number of resources in a group based on a metric.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *自动扩展* 是根据指标自动增加或减少组中资源数量的实践。
- en: GCP autoscaling requires that you set a target metric to scale up or scale down
    resources to achieve. For most of the month with low traffic, you expect to use
    only one server. However, when peak traffic runs through your conference platform,
    you need a maximum of three. You decide to use a metric for CPU utilization and
    set the target to 75%.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: GCP 自动扩展要求您设置一个目标指标以扩展或缩减资源以达到。在大多数月份的低流量期间，您预计只需使用一台服务器。然而，当高峰流量通过您的会议平台时，您需要最多三台。您决定使用CPU利用率作为指标，并将目标设置为
    75%。
- en: You update the IaC for the servers. In listing 12.9, you replace the original
    servers and instance scheduling resource policy with a managed instance group
    and autoscaling policy. The autoscaling schedule starts each morning, increases
    or decreases instances to achieve 75% CPU utilization, and scales the instances
    to zero each evening.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 您更新了服务器的 IaC。在列表 12.9 中，您用托管实例组和自动扩展策略替换了原始的服务器和实例调度资源策略。自动扩展计划每天早上启动，增加或减少实例以达到
    75% 的CPU利用率，并在每天晚上将实例扩展为零。
- en: Listing 12.9 Creating an autoscaling group based on CPU utilization
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 12.9 基于CPU利用率创建自动扩展组
- en: '[PRE10]'
  id: totrans-224
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: ❶ Attaches an instance group to the autoscaling resource. We omitted the instance
    group for clarity.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将实例组附加到自动扩展资源。我们省略了实例组以保持清晰。
- en: ❷ Sets the maximum number of replicas to scale up if CPU utilization increases
    above 75%
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 当CPU利用率超过 75% 时，设置最大副本数以扩展
- en: ❸ Sets the minimum number of replicas to zero by default, which means it stops
    the virtual machines
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 默认将最小副本数设置为零，这意味着它停止虚拟机
- en: ❹ Uses CPU utilization as the target metric for the autoscaling group
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 将CPU利用率作为自动扩展组的目标指标
- en: ❺ Sets a scaling schedule that increases the minimum number of replicas each
    Monday through Friday morning for the development team’s usage patterns
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 设置一个扩展计划，每周一至周五上午增加开发团队使用模式下的最小副本数
- en: AWS and Azure equivalents
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 等效
- en: GCP attaches managed instance groups to autoscaling policies. GCP does not allow
    you to attach a resource policy. You must implement the schedule in the autoscaling
    group.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: GCP 将托管实例组附加到自动扩展策略中。GCP 不允许您附加资源策略。您必须在自动扩展组中实现计划。
- en: Other public cloud providers also offer autoscaling capabilities for servers
    and sometimes databases. AWS uses autoscaling groups. Azure uses autoscale rules
    for scale sets.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 其他公共云提供商也提供服务器和有时数据库的自动扩展功能。AWS 使用自动扩展组。Azure 使用自动扩展规则进行规模集。
- en: You can set a scaling schedule in the example to mimic a weekend shutdown that
    you previously implemented. In general, use the patterns for modules to create
    an autoscaling module. The module should set an opinionated, default target metric
    depending on your workload.
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在示例中设置一个扩展计划来模拟你之前实施的周末关闭。一般来说，使用模块的模式来创建自动扩展模块。该模块应根据你的工作负载设置一个有见地的默认目标指标。
- en: If you have a unique workload that does not fit the module’s preset target metrics,
    you can set its default to target CPU utilization or memory and assess its behavior
    over time. When you roll out the instance group, apply the blue-green deployment
    pattern from chapter 9 to replace active workloads or instances. Rolling out a
    schedule and autoscaling group should not disrupt applications.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你有一个不适合模块预设目标指标的独特工作负载，你可以将其默认设置为针对 CPU 利用率或内存，并评估其随时间的行为。当你推出实例组时，应用第 9 章中的蓝绿部署模式来替换活动工作负载或实例。推出计划和自动扩展组不应干扰应用程序。
- en: To encourage teams to use autoscaling groups and scheduling, you can create
    several policy tests to make sure your autoscaling group reduces cloud waste.
    For example, one test could verify that your IaC has no individual servers and
    contains only autoscaling groups. The test encourages the team to take advantage
    of elasticity.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 为了鼓励团队使用自动扩展组和调度，你可以创建几个策略测试，以确保你的自动扩展组减少云浪费。例如，一个测试可以验证你的 IaC 没有单独的服务器，只包含自动扩展组。这个测试鼓励团队利用弹性。
- en: Another test you can add involves checking the maximum replica limit. Suppose
    your application suddenly consumes a lot of CPU or memory, or a bad actor injects
    a cryptocurrency mining binary on your machine. In that case, you don’t want the
    autoscaling group to automatically increase its capacity to 100 machines.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以添加另一个测试，涉及检查最大副本限制。假设你的应用程序突然消耗了大量的 CPU 或内存，或者一个恶意行为者在你的机器上注入了加密货币挖矿的二进制文件。在这种情况下，你不想自动扩展组自动将其容量增加到
    100 台机器。
- en: 12.2.5 Set a resource expiration tag
  id: totrans-237
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.2.5 设置资源过期标签
- en: You may reduce cloud waste by dynamically scaling up and down resources based
    on utilization, but you also need to accommodate on-demand, manually created resources.
    For example, the client team members complain that they often need to create sandbox
    servers for further testing. However, they often forget about the servers. Can
    you “expire” the servers after some time if no one updates them?
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过根据利用率动态扩展和缩减资源来减少云浪费，但你还需要适应按需手动创建的资源。例如，客户端团队成员抱怨他们经常需要创建沙盒服务器进行进一步测试。然而，他们经常忘记服务器。如果没有人更新它们，你能在一段时间后“过期”服务器吗？
- en: You decide to update your tag module to attach a new tag for the *expiration
    date* in the testing environment. Recall that you can use the prototype pattern
    (chapter 3) to establish standard tags. After applying the policy tests to check
    for tag compliance in chapter 8, you know that each resource in the testing environment
    will have an expiration date.
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 你决定更新你的标签模块，在测试环境中附加一个新的标签用于**过期日期**。回想一下，你可以使用原型模式（第 3 章）来建立标准标签。在应用第 8 章中的策略测试以检查标签合规性之后，你知道测试环境中的每个资源都将有一个过期日期。
- en: For example, the team members might create a server with an initial expiration
    date of February 2, as shown in figure 12.9\. However, they decide to update the
    server. As part of the change, the tag module retrieves the current date (February
    5), adds seven days, and updates the tag on the server to a new date (February
    12).
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，团队成员可能会创建一个初始过期日期为 2 月 2 日的服务器，如图 12.9 所示。然而，他们决定更新服务器。作为变更的一部分，标签模块检索当前日期（2
    月 5 日），添加七天，并将服务器上的标签更新为新日期（2 月 12 日）。
- en: '![](../../OEBPS/Images/CH12_F09_Wang.png)'
  id: totrans-241
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F09_Wang.png)'
- en: Figure 12.9 Create an expiration date in the tag module that resets the expiration
    date of the module to one week from the change.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.9 在标签模块中创建一个过期日期，将模块的过期日期重置为更改后的一个星期。
- en: Why use set expiration as part of the tag module? Your tag module should get
    applied across all your IaC. This allows you to establish a *default duration*
    of seven days and apply it to all infrastructure resources.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么要在标签模块中使用设置过期日期？你的标签模块应该应用于你所有的 IaC。这允许你建立一个**默认持续时间**为七天，并将其应用于所有基础设施资源。
- en: You can also control when to apply the expiration tag as part of a module. The
    module applies the expiration tag only if you don’t create a resource in the production
    environment or continuously run it in the testing environment. The following listing
    updates the prototype module for default tags with an expiration date.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以控制何时应用到期标签作为模块的一部分。只有当您在生产环境中未创建资源或持续在测试环境中运行时，模块才会应用到期标签。以下列表更新了具有到期日期的默认标签的原型模块。
- en: Listing 12.10 Tag module with an expiration date
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.10 带有到期日期的标签模块
- en: '[PRE11]'
  id: totrans-246
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: ❶ Formats the date to a string of year, month, and day
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将日期格式化为年、月、日的字符串
- en: ❷ Calculates the expiration date for seven days from the current date
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 从当前日期计算七天后的到期日期
- en: ❸ Sets the expiration tag if you do not create the resource in production or
    mark it as a long-term resource
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 如果在生产环境中未创建资源或将其标记为长期资源，则设置到期标签
- en: ❹ Calculates the expiration date for seven days from the current date
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 从当前日期计算七天后的到期日期
- en: ❺ Formats the date to a string of year, month, and day
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 将日期格式化为年、月、日的字符串
- en: You set one week as a default because it gives team members enough time to develop
    and test a resource. They can always renew another week if needed by running their
    delivery pipeline to update the tag automatically. However, you do need to enable
    an override to allow long-term resources in testing environments.
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 您将一周设为默认值，因为这给团队成员足够的时间开发和测试资源。他们可以通过运行交付管道自动更新标签来续订另一周。然而，您确实需要启用覆盖，以便在测试环境中允许长期资源。
- en: How do you enforce expiration date tagging by default but exempt resources from
    an expiration date? You can create a policy test with soft mandatory enforcement.
    A soft mandatory policy makes exceptions and audits long-term resources in testing
    environments.
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 如何默认强制执行到期日期标签，但豁免资源不设置到期日期？您可以创建一个具有软强制性执行的策略测试。软强制性策略允许对测试环境中的长期资源进行例外和审计。
- en: Let’s write a test that enforces the expiration tag for each server resource
    in listing 12.11\. If the server does not exist in the list of exempt resources,
    it fails the test and stops the delivery pipeline from deploying all changes to
    production.
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们编写一个测试，强制执行列表12.11中每个服务器资源的到期标签。如果服务器不在免于策略的资源列表中，测试将失败，并停止交付管道部署所有更改到生产环境。
- en: Listing 12.11 Test checks that testing resources have an expiration date
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 列表12.11 测试检查测试资源是否具有到期日期
- en: '[PRE12]'
  id: totrans-256
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: ❶ Retrieves a list of servers in configuration and those exempt from the policy
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 从配置中检索服务器列表以及免于策略的服务器
- en: ❷ Checks if the tag for expiration exists in server tags
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 检查服务器标签中是否存在到期标签
- en: ❸ If you did not exempt the server, you must flag the server as noncompliant
    with the policy.
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 如果您未豁免服务器，您必须将服务器标记为不符合策略。
- en: Adding the resource to an exemption list means that your teammates will carefully
    examine which resources persist in the testing environment. During peer review
    (chapter 7), you can identify any new, persistent resource based on changes to
    the exemption list. A single source of persistent resources in a testing environment
    ensures that you can audit and discuss cost control early in the development process.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 将资源添加到豁免列表意味着您的团队成员将仔细检查哪些资源持续存在于测试环境中。在同行评审（第7章）期间，您可以根据豁免列表的更改识别任何新的持久资源。测试环境中的持久资源单一来源确保您可以在开发早期审计和讨论成本控制。
- en: After implementing the expiration tag in IaC, you need to write a script that
    runs daily. Figure 12.10 shows the script’s workflow. It checks whether the expiration
    date matches the current date. If so, the automation deletes the resource.
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 在IaC中实现到期标签后，您需要编写一个每天运行的脚本。图12.10显示了脚本的流程。它检查到期日期是否与当前日期匹配。如果是，自动化会删除资源。
- en: Why set an expiration date by using IaC? The workflow of setting an expiration
    date using a tag module *builds in* the ability to renew the resource expiration
    date! Rather than introduce development friction by adding separate automation,
    you build renewals into the development process.
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么使用IaC设置到期日期？使用标签模块设置到期日期的工作流程内置了更新资源到期日期的能力！而不是通过添加单独的自动化来引入开发摩擦，您将续订纳入开发过程。
- en: '![](../../OEBPS/Images/CH12_F10_Wang.png)'
  id: totrans-263
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH12_F10_Wang.png)'
- en: Figure 12.10 Setting an expiration tag allows daily automation to determine
    whether to delete a temporary resource and thus reduce cost.
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.10 设置到期标签允许每日自动化确定是否删除临时资源，从而降低成本。
- en: For example, if a team still needs the resource, it can always rerun its IaC
    delivery pipeline to reset the expiration date for another seven days. Active
    changes to the resource also reset the expiration date. If you change your infrastructure,
    you probably still need the resource.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果一个团队仍然需要资源，它总是可以重新运行其IaC交付管道来重置有效期，再延长七天。对资源的主动更改也会重置有效期。如果您更改了基础设施，您可能仍然需要该资源。
- en: What happens when a resource expires and you still need it? You can always rerun
    your IaC and create a new one. Using IaC to add and renew the expiration date
    provides cost compliance and functional visibility across teams.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 当资源到期而您仍然需要它时会发生什么？您总是可以重新运行您的IaC并创建一个新的。使用IaC添加和更新到期日期提供跨团队的成本合规性和功能可见性。
- en: Note Sometimes you’ll find separate automation for automatic tagging. The automation
    adds the expiration date to infrastructure resources after their creation. While
    the automatic tagging means greater control for cost compliance, it also introduces
    drift between the actual and intended configurations. Furthermore, automatic expiration
    often confuses team members. Unless they paid attention to your communications,
    they might find their resource deleted after a few days!
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：有时您会发现针对自动标记的单独自动化。自动化在创建基础设施资源后添加到期日期。虽然自动标记意味着对成本合规性有更大的控制，但它也引入了实际配置和预期配置之间的偏差。此外，自动到期通常会让团队成员感到困惑。除非他们注意到了您的沟通，否则他们可能会在几天后发现他们的资源被删除了！
- en: You can always set the expiration time interval to something other than several
    days. If you want to offer more flexibility to teams, you can offer a range of
    days through the tag module. I recommend calculating the absolute expiration date
    and adding it to the tag instead of the time interval for easier cleanup automation.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 您总是可以将到期时间间隔设置为几天以外的其他时间。如果您想为团队提供更多灵活性，您可以通过标签模块提供一系列天数。我建议计算绝对到期日期并将其添加到标签中，而不是时间间隔，以便更容易进行清理自动化。
- en: With all of the changes in the example, what happened to your client’s cloud
    computing bill? Your bill went from a little over $10,000 to about $6,500 (a 35%
    reduction)! Your client appreciates the efficient use of their cloud resources.
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 在示例中的所有更改之后，您的客户的云计算账单发生了什么变化？您的账单从略高于10,000美元降至约6,500美元（减少了35%）！您的客户感谢他们云资源的有效使用。
- en: In reality, you might not achieve the same dramatic cost reduction as the example.
    However, you can always apply the practices and techniques to your IaC to introduce
    minor changes that reduce cost when possible. Capturing cost reduction practices
    in IaC with tests ensures that everyone writes it with the constraint of cost
    in mind.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 在现实中，您可能无法实现与示例相同的戏剧性成本降低。然而，您始终可以将这些实践和技术应用于您的IaC，以在可能的情况下引入减少成本的小幅变化。通过测试捕获成本降低实践确保每个人在考虑成本约束的情况下编写代码。
- en: Exercise 12.2
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 练习12.2
- en: 'Imagine you have three servers. You examine their utilization and notice the
    following:'
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 假设您有三台服务器。您检查它们的利用率，并注意到以下情况：
- en: You need one server to serve the minimum traffic.
  id: totrans-273
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您需要一个服务器来处理最小流量。
- en: You need three servers to serve the maximum traffic.
  id: totrans-274
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您需要三个服务器来处理最大流量。
- en: The server handles traffic 24 hours a day, seven days a week.
  id: totrans-275
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 服务器每天24小时、每周7天处理流量。
- en: What can you do to optimize the cost of the servers for the next month?
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以做什么来优化下个月服务器的成本？
- en: A) Schedule the resources to stop on the weekends.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: A) 将资源安排在周末停止。
- en: B) Add an `autoscaling_policy` to scale based on memory.
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: B) 添加一个基于内存的`autoscaling_policy`进行扩展。
- en: C) Set an expiration of three hours for all servers.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: C) 为所有服务器设置三小时的到期时间。
- en: D) Change the servers to smaller CPU and memory machine types.
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: D) 将服务器更改为较小的CPU和内存机器类型。
- en: E) Migrate the application to containers and pack applications more densely
    on servers.
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: E) 将应用程序迁移到容器中，并在服务器上更密集地打包应用程序。
- en: See appendix B for answers to exercises.
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: 请参阅附录B以获取练习的答案。
- en: 12.3 Optimize cost
  id: totrans-283
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.3 优化成本
- en: You can apply other IaC principles and practices to reduce cloud waste and manage
    cost drivers. Techniques like building environments on demand, updating routes
    between regions, or testing in production can use IaC to further optimize cost,
    as shown in figure 12.11.
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以将其他基础设施即代码（IaC）原则和实践应用于减少云浪费和管理成本驱动因素。例如，按需构建环境、更新区域间的路由或在生产环境中进行测试等技术可以使用IaC进一步优化成本，如图12.11所示。
- en: '![](../../OEBPS/Images/CH12_F11_Wang.png)'
  id: totrans-285
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH12_F11_Wang.png)'
- en: Figure 12.11 Cost optimization requires IaC practices for scaling and deploying
    infrastructure resources.
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.11 成本优化需要IaC实践来扩展和部署基础设施资源。
- en: In particular, the principles of reproducibility, composability, and evolvability
    can help with creative techniques to further optimize cost. These techniques include
    reproducing environments on demand to reduce persistent testing environments,
    composing infrastructure across cloud providers, and evolving production infrastructure
    across regions and cloud providers.
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 尤其是可重复性、可组合性和可进化性的原则可以帮助通过创造性的技术进一步优化成本。这些技术包括按需复制环境以减少持久测试环境、跨云提供商组合基础设施以及跨区域和云提供商演进生产基础设施。
- en: Recall that you reduced your client’s cloud computing cost for a conference
    by 35%. A year later, the finance team asks for your help to optimize the cost
    of their platform. They’ve grown their business and want to optimize costs across
    hundreds of customers and a managed service.
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 回想一下，你通过减少客户用于会议的云计算成本35%。一年后，财务团队请求你的帮助来优化他们平台的成本。他们的业务已经增长，并希望优化数百名客户和托管服务的成本。
- en: 12.3.1 Build environments on demand
  id: totrans-289
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.3.1 按需构建环境
- en: From a broader perspective, you need to examine which environments exist in
    testing and production. You might start by reducing cloud waste across all environments.
    However, as your company grows, it adds more environments to support and test
    more products.
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 从更广泛的角度来看，你需要检查测试和生产中存在哪些环境。你可能从减少所有环境中的云浪费开始。然而，随着你的公司发展壮大，它需要添加更多环境来支持和支持更多产品。
- en: Imagine you examine your client’s infrastructure. The client has many testing
    environments. You determine that three or four of them run continuously and support
    specialized testing. For example, the quality assurance (QA) team uses one of
    the environments for performance testing twice a year. For the rest of the year,
    these environments remain dormant.
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: 想象一下你检查了客户的架构。客户有许多测试环境。你确定其中三到四个环境持续运行并支持专业测试。例如，质量保证（QA）团队每年使用其中一个环境进行性能测试两次。在其余的一年中，这些环境保持休眠状态。
- en: You decide to *remove the continuously running environments*. If the QA team
    wants an environment for performance testing, it can do that on demand. The team
    copies the production environment with its factory and builder modules that allow
    inputs. The modules provide flexibility to specify variables and parameters for
    different environments.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: 你决定*移除持续运行的环境*。如果QA团队需要用于性能测试的环境，他们可以按需创建。团队会复制生产环境，包括其工厂和构建模块，这些模块允许输入。这些模块提供了指定不同环境变量和参数的灵活性。
- en: Figure 12.12 shows the rest of the workflow for creating an on-demand environment.
    The QA team copies the IaC to a new repository specific to the testing environment
    in the organization’s multirepository structure. The team updates the parameters
    and variables, runs its tests, and removes the environment.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.12显示了创建按需环境的其余工作流程。QA团队将IaC复制到组织多仓库结构中针对测试环境的特定新仓库。团队更新参数和变量，运行其测试，并移除环境。
- en: '![](../../OEBPS/Images/CH12_F12_Wang.png)'
  id: totrans-294
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F12_Wang.png)'
- en: Figure 12.12 You can copy the configuration for production to create and customize
    on-demand environments for testing.
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.12 你可以复制生产环境的配置来创建和定制用于测试的按需环境。
- en: Why use reproducibility to create new environments on demand and delete them?
    A new, updated environment ensures that the latest configuration matches production.
    If you use the environment only once a year, you do not want to keep it constantly
    running for 11 months.
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么使用可重复性按需创建新环境并删除它们？一个新的、更新的环境确保最新的配置与生产环境匹配。如果你一年只使用一次环境，你不想让它持续运行11个月。
- en: While it takes time to create a new environment, you probably take the same
    amount of time trying to fix drift between your testing and production environment.
    Identifying unnecessary long-running environments and switching them to an on-demand
    model can help mitigate costs, especially if you can easily re-create them.
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然创建新环境需要时间，但你可能花费同样多的时间试图修复测试环境和生产环境之间的漂移。识别不必要的长时间运行的环境并将它们切换到按需模式可以帮助减轻成本，尤其是如果你可以轻松地重新创建它们。
- en: 12.3.2 Use multiple clouds
  id: totrans-298
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.3.2 使用多个云
- en: With a few cloud provider options, you may also consider deploying to other
    clouds and optimizing cost based on resource, workload, and time of day. IaC can
    help standardize and organize your configuration for multiple clouds. Deploying
    to multiple clouds can accommodate specialized workloads or teams that want specific
    infrastructure resources.
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 在有限的云提供商选项中，您也可以考虑部署到其他云，并根据资源、工作负载和一天中的时间优化成本。IaC可以帮助标准化和组织多个云的配置。部署到多个云可以满足需要特定基础设施资源的专业工作负载或团队。
- en: For example, imagine your client uses Google Cloud Dataflow for stream data
    processing. However, the cost varies depending on the type of pipeline. You convince
    some reporting teams to convert a few of the batch-processing pipelines to Amazon
    EMR to reduce the overall cost.
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，假设您的客户使用Google Cloud Dataflow进行流数据处理。然而，成本取决于管道的类型。您说服一些报告团队将一些批处理管道转换为Amazon
    EMR以降低整体成本。
- en: Azure equivalent
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
  zh: Azure等效
- en: The Azure equivalent of Amazon EMR or Google Cloud Dataflow is Azure HDInsight.
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: Azure中与Amazon EMR或Google Cloud Dataflow等效的是Azure HDInsight。
- en: In figure 12.13, the report service team switches its IaC to use the Amazon
    EMR module. To minimize the disruption of jobs, the team members use the blue-green
    deployment pattern from chapter 9 to gradually increase the number of jobs they
    run in Amazon EMR.
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: 在图12.13中，报告服务团队将其IaC切换到使用Amazon EMR模块。为了最小化作业的中断，团队成员使用第9章中提到的蓝绿部署模式，逐渐增加他们在Amazon
    EMR中运行的作业数量。
- en: '![](../../OEBPS/Images/CH12_F13_Wang.png)'
  id: totrans-304
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F13_Wang.png)'
- en: Figure 12.13 The report service switches its batch-processing job to use Amazon
    EMR instead of Google Cloud Dataflow by referencing a different module.
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.13 报告服务通过引用不同的模块将其批处理作业切换到使用Amazon EMR而不是Google Cloud Dataflow。
- en: The principle of composability becomes an important part of a multicloud configuration.
    IaC makes it easier to manage and identify infrastructure resources across different
    cloud providers. Using modules to express dependencies between clouds also helps
    you evolve your resources over time.
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 可组合性原则成为多云配置的重要组成部分。IaC使得管理并识别不同云提供商的基础设施资源变得更加容易。使用模块来表示云之间的依赖关系也有助于您随着时间的推移演进资源。
- en: In chapter 5, we separated IaC configuration into different folders based on
    tools and providers. Many IaC tools do not offer a unified data model for cloud
    provider resources. Build a different module for each cloud you plan to support.
    Separating modules by provider reduces the complexity and supports isolated testing
    of modules. Maintaining separate modules for each cloud provider also enables
    easy identification of infrastructure resources and providers.
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: 在第5章中，我们将IaC配置根据工具和提供商分到了不同的文件夹中。许多IaC工具不提供云提供商资源的统一数据模型。为每个计划支持的云构建不同的模块。按提供商分离模块可以降低复杂性并支持模块的独立测试。为每个云提供商维护独立的模块也有助于轻松识别基础设施资源和提供商。
- en: 12.3.3 Assess data transfer between regions and clouds
  id: totrans-308
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.3.3 评估区域和云之间的数据传输
- en: With the adoption of multiple clouds, you might discover that you didn’t reduce
    your overall cloud computing bill. You need to consider multiple clouds carefully
    because providers will charge for data transfer between regions and outside their
    cloud network. Data transfer costs add up in surprising ways!
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
  zh: 随着多云的采用，您可能会发现您并没有降低整体云计算账单。您需要仔细考虑多云，因为提供商将根据区域间和云网络外的数据传输收费。数据传输成本以令人惊讶的方式累积！
- en: You check your client’s cloud computing bill and notice that a lot of the cost
    comes from data transfers across regions and out of the network. After some investigation,
    you discover that many of the services and testing environments communicate across
    regions, availability zones, and over the public internet.
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
  zh: 您检查客户的云计算账单，发现大部分成本来自区域间和网络外的数据传输。经过一些调查，您发现许多服务和测试环境都在跨区域、可用区和公共互联网中进行通信。
- en: For example, integration tests for the chat service in `us-central1-a` use the
    public IP address of the user profile service in `us-central1-b`! You realize
    that all of the services in the integration testing environment do not need to
    test across regions, availability zones, or out of the network.
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，`us-central1-a`中聊天服务的集成测试使用了`us-central1-b`中用户配置文件服务的公网IP地址！你意识到集成测试环境中的所有服务都不需要跨区域、可用区或网络外进行测试。
- en: Integration testing tests the functionality of the service only relative to
    other services and not the system itself. Figure 12.14 uses the refactoring techniques
    from chapter 10 to consolidate the infrastructure resources in the integration
    testing environment into one availability zone.
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 集成测试仅测试服务相对于其他服务的功能，而不是系统本身。图12.14使用第10章中的重构技术将集成测试环境中的基础设施资源整合到一个可用区。
- en: '![](../../OEBPS/Images/CH12_F14_Wang.png)'
  id: totrans-313
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F14_Wang.png)'
- en: Figure 12.14 Refactor your IaC to support an integration testing environment
    in a single availability zone and resolve to a private IP address.
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.14重构您的IaC以支持单个可用区中的集成测试环境，并解析到私有IP地址。
- en: What happens if the availability zone fails? You can always switch the IaC to
    a different zone or region. The applications still communicate over a private
    network and do not charge for data transfer out of Google Cloud’s network or between
    regions and zones.
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: 如果可用区失败会怎样？您始终可以将IaC切换到不同的区域或地区。应用程序仍然通过私有网络进行通信，并且不会对谷歌云网络之外的数据传输或区域和区域之间的数据传输收费。
- en: Favor private over public networking, not just for security but also for cost
    and efficiency. If you use multiple clouds, know which resources need to communicate
    across clouds. Sometimes you might find it more cost-efficient to shift an entire
    set of services to another cloud than pay for data transfer between clouds. Applying
    the change and refactoring techniques in chapters 9 and 10 can help consolidate
    services and communications.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 优先考虑私有网络而非公共网络，这不仅关乎安全，还关乎成本和效率。如果您使用多个云，了解哪些资源需要在云之间进行通信。有时，您可能会发现将整个服务集转移到另一个云比支付云之间的数据传输费用更经济高效。应用第9章和第10章中的更改和重构技术可以帮助整合服务和通信。
- en: 12.3.4 Test in production
  id: totrans-317
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.3.4 生产环境测试
- en: Even after shifting to multiple clouds and optimizing data transfer, you might
    find that your testing environment cannot fully mimic production and costs too
    much to run. At some point, you cannot get away with testing in an isolated environment.
    Rather than simulate the production environment in its entirety, you can continue
    to optimize costs by testing directly in the production environment.
  id: totrans-318
  prefs: []
  type: TYPE_NORMAL
  zh: 即使在转移到多个云并优化数据传输之后，您可能会发现您的测试环境无法完全模拟生产环境，并且运行成本过高。在某个时候，您无法在隔离环境中进行测试。与其完全模拟生产环境，不如通过直接在生产环境中进行测试来继续优化成本。
- en: In the case of the conference platform, you help the video service team implement
    changes to test in production. In figure 12.15, the team members stage a new set
    of infrastructure resources with the expected changes hidden behind a feature
    flag. Then, they toggle the flag to direct all applications and user traffic and
    verify its functionality in production. The two sets of resources run simultaneously
    for a few weeks. After a few weeks, they delete the old infrastructure resources.
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 在会议平台的案例中，您帮助视频服务团队实施更改以进行生产测试。在图12.15中，团队成员使用功能标志隐藏预期更改，并创建了一组新的基础设施资源。然后，他们切换标志以将所有应用程序和用户流量导向，并在生产环境中验证其功能。这两组资源同时运行几周。几周后，他们删除了旧的基础设施资源。
- en: '![](../../OEBPS/Images/CH12_F15_Wang.png)'
  id: totrans-320
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH12_F15_Wang.png)'
- en: Figure 12.15 Testing in production for IaC applies blue-green deployments and
    feature flagging for a set of resources.
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.15展示了IaC在生产环境中的测试应用了蓝绿部署和功能标志来针对一组资源。
- en: The team tested its service in production by using blue-green services without
    using a testing environment. *Testing in production* involves a set of practices
    that enable you to run tests against production data and systems.
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
  zh: 团队通过使用蓝绿服务而不是测试环境来在生产环境中测试其服务。*生产环境测试*涉及一系列实践，这些实践使您能够对生产数据和服务运行测试。
- en: Definition *Testing in production* is a set of practices that allow you to run
    tests against production data and systems.
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: 定义*生产环境测试*是一系列实践，允许您对生产数据和服务运行测试。
- en: In software development, you use techniques like feature flagging to hide certain
    functionality in production for testing. Similarly, you use canary deployments
    to test functionality with a small group of users before offering it to everyone
    on the platform.
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: 在软件开发中，您使用特征标志等技术来在生产环境中隐藏某些功能以进行测试。同样，您可以使用金丝雀部署在向平台上的所有人提供之前，先对一小组用户的功能进行测试。
- en: For IaC, testing in production does not fit entirely with the software development
    practices. You don’t want to test that the code works with a small group of users.
    You just want to know if you create broken infrastructure systems that might *affect*
    the users! You can apply a few techniques, like feature flagging and canary deployment.
    We did this in chapters 9 and 10.
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 对于基础设施即代码（IaC），在生产环境中进行测试并不完全符合软件开发实践。你不想测试代码是否与一小群用户兼容。你只想知道你是否创建了可能*影响*用户的损坏的基础设施系统！你可以应用一些技术，比如功能标志和金丝雀部署。我们在第9章和第10章中就是这样做的。
- en: You could test IaC directly in production without a blue-green deployment pattern
    or feature flagging. However, you will need an established roll-forward plan in
    case of failure. I worked in one organization that depended entirely on local
    testing before pushing changes to production. If our change failed, we would attempt
    to update the system to a previous state. If all else failed, we would create
    a whole new infrastructure environment and direct all application and user traffic
    to the new environment.
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以直接在生产环境中测试IaC，而不需要蓝绿部署模式或功能标志。然而，在出现故障的情况下，你需要一个已建立的回滚计划。我在一个组织工作，该组织在将更改推送到生产之前完全依赖于本地测试。如果我们的更改失败，我们会尝试将系统更新到之前的状态。如果所有其他方法都失败了，我们会创建一个全新的基础设施环境，并将所有应用程序和用户流量直接导向新环境。
- en: You might go through all cost optimization, cloud waste reduction, and cost
    driver control techniques and *still* never fully optimize your cloud bill! Over
    time, your organization’s usage and product demands change.
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能已经尝试了所有成本优化、云浪费减少和成本驱动控制技术，但*仍然*无法完全优化你的云账单！随着时间的推移，你组织的使用和产品需求会发生变化。
- en: If you have proper monitoring and instrumentation in your systems, you might
    discover that you have periods of greater or lower demand. For example, your client’s
    platform has the most demand in May, June, October, and November, for peak conference
    season.
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你系统中有适当的监控和仪表，你可能会发现你有需求更高或更低的时间段。例如，你的客户的平台在5月、6月、10月和11月需求最高，因为这是高峰会议季节。
- en: Note You might need to re-architect your systems to take advantage of public
    cloud *elasticity*, the ability to scale up or down, and reduce cost over time.
    Some software architectures do not make it easy for you to dynamically scale resources
    up or down. The solution often requires a refactor or re-platform of the application
    to improve system cost efficiency.
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：你可能需要重新架构你的系统，以利用公共云的*弹性*，即扩展或缩减的能力，并随着时间的推移降低成本。某些软件架构并不容易让你动态地扩展或缩减资源。通常，解决方案需要重构或重新平台化应用程序，以提高系统成本效率。
- en: Understanding your system’s resource usage and requirements over time can help
    you further optimize costs beyond the techniques I described in this chapter.
    You could reduce costs even further by negotiating a contract with the infrastructure
    provider. Choosing a new pricing model lets you save on a certain number of reserved
    instances or volume-based discounts.
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
  zh: 了解你的系统在一段时间内的资源使用和需求可以帮助你进一步优化成本，超出我在本章中描述的技术。你还可以通过与基础设施提供商协商合同来进一步降低成本。选择新的定价模型让你可以在一定数量的预留实例或基于容量的折扣上节省费用。
- en: The longer you run the system, the more metrics you aggregate. The information
    can help you iterate on cost driver control, cloud waste reduction, and overall
    cost optimization in IaC. You can also use the information to negotiate with your
    cloud provider and reduce the surprises on your cloud computing bill!
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
  zh: 系统运行时间越长，你聚集的指标就越多。这些信息可以帮助你在基础设施即代码中迭代成本驱动控制、云浪费减少和整体成本优化。你还可以使用这些信息与云提供商协商，减少云计算账单中的意外费用！
- en: Summary
  id: totrans-332
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: Before changing IaC to optimize cost, identify the cost drivers (resources or
    activities) that may affect the total cost.
  id: totrans-333
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在更改IaC以优化成本之前，确定可能影响总成本的成本驱动因素（资源或活动）。
- en: Manage cost drivers in infrastructure, such as compute resources, by adding
    policy tests to check for resource type, size, and reservation.
  id: totrans-334
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过添加策略测试来检查资源类型、大小和预留，管理基础设施中的成本驱动因素，例如计算资源。
- en: Cost estimation parses your IaC for resource attributes and generates an estimate
    of their cost based on a cloud provider’s API.
  id: totrans-335
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 成本估算解析你的IaC以获取资源属性，并根据云提供商的API生成其成本的估算。
- en: You can add a policy test to check the output of cost estimation to approximate
    whether you exceeded your budget.
  id: totrans-336
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可以添加策略测试来检查成本估算的输出，以近似你是否超出了预算。
- en: Cloud waste describes unused or underutilized infrastructure resources.
  id: totrans-337
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 云浪费描述了未使用或利用率不足的基础设施资源。
- en: Eliminating cloud waste can help decrease your cloud computing cost.
  id: totrans-338
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 消除云浪费可以帮助降低您的云计算成本。
- en: Reduce cloud waste by removing or stopping untagged or unused resources, starting
    and stopping resources on a schedule, right-sizing infrastructure resources for
    better utilization, enabling autoscaling, and tagging a resource expiration date.
  id: totrans-339
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过移除或停止未标记或未使用的资源、按计划启动和停止资源、为更好的利用调整基础设施资源的大小、启用自动扩展以及标记资源到期日期来减少云浪费。
- en: Autoscaling increases or decreases the number or amount of resources in a given
    group based on a metric, such as CPU or memory.
  id: totrans-340
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自动扩展根据如CPU或内存等指标增加或减少给定组中资源数量或数量。
- en: Techniques for optimizing cloud computing cost involve building environments
    on demand, using multiple clouds, assessing data transfer, and testing in production.
  id: totrans-341
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 优化云计算成本的技术包括按需构建环境、使用多云、评估数据传输以及在生产中进行测试。
- en: Testing in production uses practices like blue-green deployments and feature
    flagging to test infrastructure changes without a testing environment.
  id: totrans-342
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 生产测试使用如蓝绿部署和功能标志等实践来测试基础设施更改，而不需要测试环境。
