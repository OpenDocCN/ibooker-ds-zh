- en: 8 Kubernetes-native continuous delivery and Secrets
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 8 Kubernetes原生持续交付和机密信息
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Introducing continuous delivery and deployment methodology
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 介绍持续交付和部署方法
- en: Implementing a Kubernetes-native continuous deployment pipeline using GitOps
    methodology
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用GitOps方法实现Kubernetes原生持续部署管道
- en: Showing ArgoCD as a Kubernetes-native solution for implementing GitOps
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 展示ArgoCD作为实现GitOps的Kubernetes原生解决方案
- en: In the previous chapter, you saw how to manage secrets during the CI phase,
    build the application, create a container image, and publish it to the container
    registry. But the service is neither deployed nor released yet to the Kubernetes
    cluster. In this chapter you’ll see how to deliver the application securely.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，你了解了如何在CI阶段管理机密信息，构建应用程序，创建容器镜像，并将其发布到容器注册库。但是，服务尚未部署或发布到Kubernetes集群。在本章中，你将了解如何安全地交付应用程序。
- en: In this chapter, you’ll see how to use continuous deployment and GitOps methodology
    to deploy and release services to a Kubernetes cluster, using Argo CD to deliver
    quality applications rapidly, while managing the secrets correctly throughout
    the whole pipeline to prevent a leak from occurring in this phase of development.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你将了解如何使用持续部署和GitOps方法将服务部署和发布到Kubernetes集群，使用Argo CD快速交付高质量应用程序，同时在整个管道中正确管理机密信息，以防止在开发阶段发生泄露。
- en: 8.1 Introduction to continuous delivery and deployment
  id: totrans-7
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.1 持续交付和部署简介
- en: '*Continuous Delivery* is a methodology that involves releasing software faster
    and more frequently. This methodology helps reduce the cost, time, and risk of
    delivering changes that potentially affect the user experience. Because delivery
    of the application is performed continuously and with incremental updates, it’s
    easier to capture feedback from the end user and react accordantly.'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: '*持续交付*是一种涉及更快、更频繁发布软件的方法。这种方法有助于降低可能影响用户体验的更改交付的成本、时间和风险。由于应用程序的交付是持续进行的，并且是增量更新，因此更容易从最终用户那里收集反馈并相应地做出反应。'
- en: 'The central concept of CD is the *deployment pipeline*. As the name suggests,
    it is a set of steps or procedures through which the application must pass to
    be released for production. The deployment pipeline may be changed, depending
    on the process you choose to follow when releasing the application, but one typical
    pipeline is composed of the following stages:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: CD的核心概念是*部署管道*。正如其名所示，它是一系列步骤或程序，应用程序必须通过这些步骤或程序才能发布到生产环境。部署管道可能会根据你在发布应用程序时选择遵循的过程而改变，但一个典型的管道通常由以下阶段组成：
- en: '*Commit stage*—The first part of the release process, which is triggered after
    a team member commits something to the SCM server. This stage is the continuous
    integration phase shown in the previous chapter.'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*提交阶段*——发布流程的第一部分，在团队成员向SCM服务器提交内容后触发。这一阶段是前一章中展示的持续集成阶段。'
- en: '*Acceptance tests*—This stage tests that the application meets expectations
    from a business standpoint. Some of these tests might be automatic, but others
    not, such as exploratory testing.'
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*验收测试*——这一阶段测试应用程序是否满足业务方面的预期。其中一些测试可能是自动的，但也有一些不是，例如探索性测试。'
- en: '*Release*—Based on feedback from each stage, key users decide whether to release
    to production or drop the version.'
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*发布*——基于每个阶段的反馈，关键用户决定是否将版本发布到生产环境或放弃该版本。'
- en: Notice that a release process in continuous delivery implies a manual decision
    to perform the actual release. On the other hand, continuous deployment automatically
    releases every change to production on a successful build. Figure 8.1 shows the
    stages of the CI/CD pipelines.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，持续交付中的发布流程意味着进行实际发布的手动决策。另一方面，持续部署在构建成功后自动将每个更改发布到生产环境。图8.1显示了CI/CD管道的阶段。
- en: '![](../Images/CH08_F01_Sotobueno3.png)'
  id: totrans-14
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/CH08_F01_Sotobueno3.png)'
- en: Figure 8.1 Continuous integration vs continuous delivery stages
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.1 持续集成与持续交付阶段对比
- en: In the following sections, you will focus on the service’s release process,
    deploying it automatically to the Kubernetes cluster, and keeping the involved
    secrets protected using the DevOps methodology.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下章节中，你将专注于服务的发布流程，自动将其部署到Kubernetes集群，并使用DevOps方法保护涉及到的机密信息。
- en: 8.2 Continuous delivery for the welcome message
  id: totrans-17
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.2 欢迎信息的持续交付
- en: In this chapter you will deploy the same application used in the previous chapter
    to a Kubernetes cluster. It picks up where the CI phase left off (the Welcome
    Message container pushed to a container registry) and delivers it to the production
    environment. As a reminder, figure 8.2 shows an overview of the application and
    the parts it is composed of.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你将部署与上一章相同的应用程序到 Kubernetes 集群中。它从 CI 阶段结束的地方（将欢迎信息容器推送到容器注册库）继续，并将其交付到生产环境中。提醒一下，图
    8.2 展示了应用程序及其组成部分的概述。
- en: '![](../Images/CH08_F02_Sotobueno3.png)'
  id: totrans-19
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/CH08_F02_Sotobueno3.png)'
- en: Figure 8.2 Overview of the interactions between Welcome and Name services
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.2 欢迎和名称服务之间交互的概述
- en: Now that you have an overview of the application to deploy, show the Kubernetes
    resources files to deploy it.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经对要部署的应用程序有了概述，展示部署它的 Kubernetes 资源文件。
- en: 8.2.1 Deploying the Name Generator service
  id: totrans-22
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.2.1 部署名称生成器服务
- en: This chapter focuses on applying CD principles in the Welcome Message service
    to deploy it in the Kubernetes cluster, using GitOps methodology automatically.
    Although this is an example for one specific service, the same approach can be
    applied to any other service, including a payment service, stock service, or user
    management service. To keep things simple, deploy the Name Generator service manually
    using the following deployment file.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 本章重点介绍在欢迎信息服务中应用 CD 原则，以使用 GitOps 方法自动将其部署到 Kubernetes 集群中。虽然这是一个特定服务的示例，但相同的方法可以应用于任何其他服务，包括支付服务、股票服务或用户管理服务。为了保持简单，使用以下部署文件手动部署名称生成器服务。
- en: Listing 8.1 src/main/kubernetes/deployment.yml
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.1 src/main/kubernetes/deployment.yml
- en: '[PRE0]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: ① Creating a Kubernetes Service for the Name Generator service
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: ① 为名称生成器服务创建 Kubernetes 服务
- en: ② Deploying the name-generator container
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: ② 部署名称生成器容器
- en: With the deployment file created, run the following command.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 创建部署文件后，运行以下命令。
- en: Listing 8.2 Deploying the name generator service
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.2 部署名称生成器服务
- en: '[PRE1]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: ① Creating a service and a deployment for the name generator service
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: ① 为名称生成器服务创建服务和部署
- en: With the Name Generator service up and running, deploy and release the Welcome
    Message service using GitOps methodology.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 当名称生成器服务运行起来后，使用 GitOps 方法部署和发布欢迎信息服务。
- en: 8.2.2 DevOps and GitOps
  id: totrans-33
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.2.2 DevOps 和 GitOps
- en: '*DevOps* is a set of practices that automates and helps integrate the processes
    of software development and IT teams, so applications are built, tested, and released
    faster and more reliably. DevOps isn’t only about developer and operator team;
    it involves the whole organization. Every team should be a part of the software
    lifecycle from the planning phase until the application is released in the production
    environment (figure 8.3).'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: '*DevOps* 是一套自动化并帮助整合软件开发和 IT 团队流程的实践，以便更快、更可靠地构建、测试和发布应用程序。DevOps 不仅关乎开发者和运维团队；它涉及整个组织。每个团队都应从规划阶段开始，直到应用程序在生产环境中发布（图
    8.3）成为软件生命周期的一部分。'
- en: '![](../Images/CH08_F03_Sotobueno3.png)'
  id: totrans-35
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/CH08_F03_Sotobueno3.png)'
- en: Figure 8.3 DevOps lifecycle
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.3 DevOps 生命周期
- en: '*GitOps* is a way of implementing DevOps methodology, based on the assumption
    that Git is the one and only source of truth. Not only is the source code of the
    application stored in Git, but the scripts and pipeline definitions that build
    the application and infrastructure code to release and update the application
    is stored in Git as well. This implies that all parts of the application are versioned,
    branched, and, of course, they can be audited.'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: '*GitOps* 是一种实现 DevOps 方法的方式，基于 Git 是唯一真相来源的假设。不仅应用程序的源代码存储在 Git 中，构建应用程序和基础设施代码的脚本以及用于发布和更新应用程序的管道定义也存储在
    Git 中。这意味着应用程序的所有部分都是版本化的、分叉的，当然，它们也可以被审计。'
- en: 'In summary GitOps principles include the following:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 总结来说，GitOps 原则包括以下内容：
- en: Git is the single source of truth.
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Git 是唯一的真相来源。
- en: Treat everything as code.
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将一切视为代码。
- en: Operations come about through Git workflows.
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 运维是通过 Git 工作流程产生的。
- en: 'One of the important aspects of GitOps is that any update on the Git repository
    related to the infrastructure must trigger an update to the environment to meet
    the desired state of the application. When there is a divergence between the desired
    state (set in the Git repo) and the observed state (the real state in the cluster),
    the convergence mechanism is executed to drive the observed state toward the desired
    state defined in the version control. There are two ways to cause a divergence:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: GitOps 的重要方面之一是，与基础设施相关的任何 Git 仓库更新都必须触发环境的更新，以满足应用程序的期望状态。当期望状态（在 Git 仓库中设置）与观察状态（集群中的实际状态）之间存在差异时，收敛机制将被执行，以将观察状态驱动到版本控制中定义的期望状态。有两种方式可以导致差异：
- en: If a human operator manually updates the Kubernetes cluster, the desired and
    observed state will be different and the convergence mechanism will update the
    Kubernetes cluster to the desired state defined in Git.
  id: totrans-43
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果手动更新 Kubernetes 集群，期望状态和观察状态将不同，收敛机制将更新 Kubernetes 集群到 Git 中定义的期望状态。
- en: If a file is updated in Git (e.g., a new container image needs to be released),
    the desired and observed state will be different, and the Kubernetes cluster state
    will be updated to the new state defined in Git.
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果在 Git 中更新了文件（例如，需要发布新的容器镜像），期望状态和观察状态将不同，Kubernetes 集群状态将更新到 Git 中定义的新状态。
- en: Let’s see how to update a Kubernetes cluster via Git using Argo CD, a GitOps
    continuous delivery tool for Kubernetes.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看如何使用 Argo CD，一个 Kubernetes 的 GitOps 持续交付工具，通过 Git 更新 Kubernetes 集群。
- en: 8.3 Argo CD
  id: totrans-46
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.3 Argo CD
- en: Now it’s time to deploy the Welcome Message service to the Kubernetes cluster
    using Argo CD and following GitOps methodology. As previously mentioned, the source
    code of the application is stored in Git as well as the scripts and pipeline definitions
    for building the application and the infrastructure code for releasing and updating
    the application.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 现在是时候使用 Argo CD 和 GitOps 方法将欢迎信息服务部署到 Kubernetes 集群了。如前所述，应用程序的源代码以及构建应用程序的脚本和管道定义，以及发布和更新应用程序的基础设施代码都存储在
    Git 中。
- en: 'Argo CD has three major components:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: Argo CD 有三个主要组件：
- en: '*API server*—The ArgoCD backend exposes the API to Web UI, CLI, or any other
    system. The main responsibilities of this component are application management,
    security concerns, and managing Git webhook events.'
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*API 服务器*——ArgoCD 后端将 API 暴露给 Web UI、CLI 或任何其他系统。该组件的主要职责是应用程序管理、安全问题和管理 Git
    webhook 事件。'
- en: '*Repository server*—This is an internal service for maintaining the local cache
    of the Git repositories.'
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*仓库服务器*——这是一个内部服务，用于维护 Git 仓库的本地缓存。'
- en: '*Application controller*—This is implemented as a Kubernetes controller that
    continuously monitors the manifests placed at the Git repository and compares
    them with the live state on the cluster. Optionally it takes corrective actions.'
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*应用程序控制器*——这是一个 Kubernetes 控制器，它持续监控 Git 仓库中放置的清单，并将其与集群上的实时状态进行比较。可选地，它可以采取纠正措施。'
- en: Figure 8.4 shows each of these parts and how they are related.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.4 展示了这些部分及其相互关系。
- en: '![](../Images/CH08_F05_Sotobueno3.png)'
  id: totrans-53
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/CH08_F05_Sotobueno3.png)'
- en: Figure 8.4 Interactions between ArgoCD elements and the Kubernetes cluster for
    deploying an application
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.4 ArgoCD 元素与 Kubernetes 集群之间部署应用程序的交互
- en: 8.3.1 Installation of ArgoCD
  id: totrans-55
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.3.1 安装 ArgoCD
- en: To install ArgoCD 1.8.7, create a new Kubernetes namespace, and apply the Argo
    CD resource to the Kubernetes cluster, as shown in the following listing.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 要安装 ArgoCD 1.8.7，创建一个新的 Kubernetes 命名空间，并将 Argo CD 资源应用到 Kubernetes 集群中，如下所示。
- en: Listing 8.3 Installing ArgoCD
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.3 安装 ArgoCD
- en: '[PRE2]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: ① Creating the argocd namespace
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: ① 创建 argocd 命名空间
- en: ② Installing Argo CD from official resources at the argocd namespace
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: ② 从 argocd 命名空间中的官方资源安装 Argo CD
- en: TIP `argocd` CLI is a command-line utility used to interact with Argo CD. To
    install it, just visit [https://github.com/argoproj/argo-cd/releases/tag/v1.7.14](https://github.com/argoproj/argo-cd/releases/tag/v1.7.14),
    download the package for your platform, uncompress the archive, and copy the `argocd`
    file into a `PATH` directory, so it’s accessible from any directory.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: TIP `argocd` CLI 是一个用于与 Argo CD 交互的命令行工具。要安装它，只需访问 [https://github.com/argoproj/argo-cd/releases/tag/v1.7.14](https://github.com/argoproj/argo-cd/releases/tag/v1.7.14)，下载您平台上的包，解压缩存档，并将
    `argocd` 文件复制到 `PATH` 目录中，这样就可以从任何目录访问它。
- en: Next expose the `Argo CD server` by changing the Argo CD Kubernetes Service
    to the `LoadBalancer` type using the patch command shown in listing 8.4.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，通过使用列表8.4中所示的补丁命令，将Argo CD Kubernetes服务更改为`LoadBalancer`类型以暴露`Argo CD服务器`。
- en: Listing 8.4 Exposing ArgoCD server
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.4 暴露ArgoCD服务器
- en: '[PRE3]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: ① Changing the Kubernetes Service type to LoadBalancer
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: ① 将Kubernetes服务类型更改为LoadBalancer
- en: To use the `argocd` CLI tool, you need the external IP and the Argo CD server
    exposed port. You can get them by running the commands shown in the following
    listing.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用`argocd` CLI工具，你需要外部IP和暴露的Argo CD服务器端口。你可以通过运行以下列表中的命令来获取它们。
- en: Listing 8.5 Argo CD access IP and port
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.5 Argo CD访问IP和端口
- en: '[PRE4]'
  id: totrans-68
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: ① Setting the IP to access the Argo CD server
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: ① 设置访问Argo CD服务器的IP
- en: ② Setting the exposed port to access the Argo CD server
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: ② 设置暴露的端口以访问Argo CD服务器
- en: The last step before configuring Argo CD is logging in to the Argo CD server
    using the CLI tool. By default, the username is `admin`, and the initial password
    is autogenerated to be the Pod name of the Argo CD API server. The password is
    retrieved with the command shown in the following listing.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 在配置Argo CD之前，最后一步是使用CLI工具登录到Argo CD服务器。默认情况下，用户名为`admin`，初始密码是自动生成的Argo CD API服务器Pod名称。密码可以通过以下列表中的命令检索。
- en: Listing 8.6 Getting the Argo CD password
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.6 获取Argo CD密码
- en: '[PRE5]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: ① Gets the Argo CD Pod name
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: ① 获取Argo CD Pod名称
- en: Run `login` command, as shown in the following listing, to log in to the Argo
    CD server using the `admin` username and password retrieved in the last step.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 运行如下所示的`login`命令，使用在最后一步检索到的`admin`用户名和密码登录到Argo CD服务器。
- en: Listing 8.7 ArgoCD login
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.7 ArgoCD登录
- en: '[PRE6]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: ① Log in to Argo CD.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: ① 登录到Argo CD。
- en: 8.3.2 Welcome service and GitOps
  id: totrans-79
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.3.2 欢迎服务与GitOps
- en: 'When you installed Gitea in section 7.2.1, a Git repository with the sources
    required in this chapter were migrated inside. This repo contains two source directories:
    one for each service and one named `welcome-message-gitops`, where all Kubernetes
    YAML files related to the deployment of the Welcome Message service and GitOps
    definitions are placed. The repository layout is shown in the following listing.'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 在7.2.1节中安装Gitea时，本章所需源代码的Git仓库已迁移到内部。此仓库包含两个源目录：每个服务一个，还有一个名为`welcome-message-gitops`的目录，其中放置了与欢迎信息服务和GitOps定义相关的所有Kubernetes
    YAML文件。仓库布局如下所示。
- en: Listing 8.8 Repository layout
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.8 仓库布局
- en: '[PRE7]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: ① Name Generator service source code
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: ① 名称生成器服务源代码
- en: ② Welcome Message service source code
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: ② 欢迎信息服务源代码
- en: ③ GitOps files
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: ③ GitOps文件
- en: ④ Welcome Message Service deployment files
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: ④ 欢迎信息服务部署文件
- en: ⑤ One-time operations deployment files
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: ⑤ 单次操作部署文件
- en: ⑥ Argo CD definitions
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: ⑥ Argo CD定义
- en: 'The `welcome-message-gitops` directory is composed of three directories:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: '`welcome-message-gitops`目录由三个目录组成：'
- en: '*apps*—A deployment YAML file for releasing the Welcome Message service to
    Kubernetes'
  id: totrans-90
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*应用程序*—发布欢迎信息服务到Kubernetes的部署YAML文件'
- en: '*cluster*—YAML files for deploying external dependencies required by the Welcome
    Message service (PostgreSQL and Vault)'
  id: totrans-91
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*集群*—部署欢迎信息服务（PostgreSQL和Vault）所需的外部依赖项的YAML文件'
- en: '*gitops*—YAML files required to register the application in Argo CD'
  id: totrans-92
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*GitOps*—在Argo CD中注册应用程序所需的YAML文件'
- en: '[PRE8]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Apps
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 应用程序
- en: The apps folder contains the deployment files required to deploy the service
    into a Kubernetes cluster. In this case, there are two standard Kubernetes `Deployment`
    and `Service` resources.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 应用程序文件夹包含将服务部署到Kubernetes集群所需的部署文件。在这种情况下，有两个标准的Kubernetes `Deployment`和`Service`资源。
- en: '[PRE9]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: To deploy the Welcome Message service, create the `apps.yaml` file with the
    content shown in the following listing.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 要部署欢迎信息服务，创建包含以下列表中内容的`apps.yaml`文件。
- en: Listing 8.9 apps/apps.yml
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.9 apps/apps.yml
- en: '[PRE10]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: ① Deploying first version of Welcome Message
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: ① 部署欢迎信息的第一个版本
- en: Create a `service.yml` file to make the Welcome Message accessible with the
    content shown in the following listing.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个`service.yml`文件，使其内容如下所示，以便使欢迎信息可访问。
- en: Listing 8.10 apps/service.yml
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.10 apps/service.yml
- en: '[PRE11]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Cluster
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 集群
- en: 'The cluster folder contains all YAML files required to deploy and configure
    the external dependencies required by the service—in this case, PostgreSQL as
    the database and HashiCorp Vault as the secret management system:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 集群文件夹包含部署和配置服务所需的所有YAML文件，在这种情况下，作为数据库的PostgreSQL和作为秘密管理系统HashiCorp Vault：
- en: '[PRE12]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: The `postgresql.yaml` and `vault.yaml` files are standard deployment files for
    deploying both of the services to the Kubernetes cluster, but two more files deserve
    an explanation. The `vault-secrets.yaml` file is a Kubernetes `Secret` object
    containing secrets required to be stored into HashiCorp Vault and consumed by
    the application. In this case, these are the token to log in to HashiCorp Vault
    and the API token used by the Welcome service to authenticate to the Name Generator
    service. The file is partially shown in the following listing.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: '`postgresql.yaml` 和 `vault.yaml` 文件是部署这两个服务到 Kubernetes 集群的标准部署文件，但还有两个文件需要解释。`vault-secrets.yaml`
    文件是一个 Kubernetes `Secret` 对象，包含需要存储到 HashiCorp Vault 并由应用程序使用的机密。在这种情况下，这些是登录
    HashiCorp Vault 的令牌和 Welcome 服务用于验证 Name Generator 服务的 API 令牌。文件的部分内容如下所示。'
- en: Listing 8.11 cluster/vault-secrets.yml
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.11 cluster/vault-secrets.yml
- en: '[PRE13]'
  id: totrans-109
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: ① Access token for HashiCorp Vault
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: ① HashiCorp Vault 访问令牌
- en: ② API key
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: ② API 密钥
- en: The `vault-job.yaml` file is a Kubernetes `Job` object configuring the HashiCorp
    Vault instance. It’s applied after the deployment of HashiCorp Vault and enables
    Kubernetes auth mode and database dynamic secrets, configures policies, and adds
    the API token into the key–value secrets store. The file is shown partially in
    the following listing.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: '`vault-job.yaml` 文件是一个 Kubernetes `Job` 对象，用于配置 HashiCorp Vault 实例。它在部署 HashiCorp
    Vault 之后应用，启用 Kubernetes 认证模式和数据库动态机密，配置策略，并将 API 令牌添加到键值机密存储中。文件的部分内容如下所示。'
- en: Listing 8.12 cluster/vault-job.yml
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.12 cluster/vault-job.yml
- en: '[PRE14]'
  id: totrans-114
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: ① The file is applied after HashiCorp Vault is deployed.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: ① 该文件在部署 HashiCorp Vault 之后应用。
- en: ② Secrets are injected as environment variables.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: ② 机密作为环境变量注入。
- en: ③ HasiCorp Vault configuration files are mounted as volumes.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: ③ 将 HashiCorp Vault 配置文件挂载为卷。
- en: ④ Job commands for configuring HashiCorp Vault
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: ④ 配置 HashiCorp Vault 的作业命令
- en: ImportanT To keep things simple, vault-secrets.yaml is a standard Kubernetes
    Secrets file, but it should be protected in any of the ways explained in chapter
    3\.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 重要的是，为了保持简单，`vault-secrets.yaml` 是一个标准的 Kubernetes Secrets 文件，但它应该以第 3 章中解释的任何一种方式得到保护。
- en: Gitops
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: Gitops
- en: The gitops folder contains all files used to register the previous folders as
    Argo CD applications.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: '`gitops` 文件夹包含所有用于将前面的文件夹注册为 Argo CD 应用程序的文件。'
- en: '[PRE15]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: ① Configuring Argo CD to monitor any change on the apps directory
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: ① 配置 Argo CD 以监控 apps 目录上的任何更改
- en: ② Configuring Argo CD to monitor any change on the cluster directory
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: ② 配置 Argo CD 以监控集群目录上的任何更改
- en: In the following section, you’ll see these files in more detail.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，您将更详细地了解这些文件。
- en: TIP You could add the application and the external dependencies deployment files
    into the same directory. However our advice is to keep the files that usually
    change separated from those that rarely do.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 提示：您可以将应用程序和外部依赖项部署文件放入同一目录中。然而，我们的建议是将通常会更改的文件与很少更改的文件分开。
- en: 8.3.3 Creating a Welcome Message service from a Git repository
  id: totrans-127
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.3.3 从 Git 仓库创建欢迎信息服务
- en: An Argo CD *application* is a group of Kubernetes resources used to deploy the
    application to the target environment and keep it in the desired state. An application
    is defined in an Argo CD custom resource definition (CRD) file, where you specify
    parameters like Git repository, the path of Kubernetes resources, or the target
    where the application will be deployed. Figure 8.5 shows the schema of what is
    deployed by `cluster-ops` and `apps-ops` Argo CD applications.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: Argo CD 的 *应用程序* 是一组 Kubernetes 资源，用于将应用程序部署到目标环境并保持其处于期望状态。应用程序在 Argo CD 自定义资源定义
    (CRD) 文件中定义，其中您指定参数，如 Git 仓库、Kubernetes 资源路径或应用程序将要部署的目标。图 8.5 显示了 `cluster-ops`
    和 `apps-ops` Argo CD 应用程序部署的架构。
- en: '![](../Images/CH08_F06_Sotobueno3.png)'
  id: totrans-129
  prefs: []
  type: TYPE_IMG
  zh: '![图 8.5](../Images/CH08_F06_Sotobueno3.png)'
- en: Figure 8.5 Argo CD application deployments
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.5 Argo CD 应用程序部署
- en: Listing 8.13 shows how to define an Argo CD application that clones the Git
    repo defined in Gitea, listens to any change in the welcome-message-gitops/apps
    directory, and applies these changes to meet the desired state. As we said before,
    the apps directory contains the resources to deploy the Welcome Message service
    to the Kubernetes cluster. Create the `apps-ops.yaml` file in the welcome-message-gitops/gitops
    folder.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.13 展示了如何定义一个 Argo CD 应用程序，该程序克隆 Gitea 中定义的 Git 仓库，监听 welcome-message-gitops/apps
    目录中的任何更改，并将这些更改应用到满足期望状态。正如我们之前所说的，apps 目录包含将欢迎信息服务部署到 Kubernetes 集群所需的所有资源。在
    welcome-message-gitops/gitops 文件夹中创建 `apps-ops.yaml` 文件。
- en: Listing 8.13 welcome-message-gitops/gitops/apps-ops.yaml
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.13 welcome-message-gitops/gitops/apps-ops.yaml
- en: '[PRE16]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: ① Synchronizes resources automatically
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: ① 自动同步资源
- en: ② Deletes resources when Argo CD detects they are no longer defined in Git
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: ② 当 Argo CD 检测到 Git 中不再定义资源时删除资源
- en: ③ When the live cluster’s state drifts, an automatic sync is performed for the
    values defined in Git.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: ③ 当实时集群的状态漂移时，对 Git 中定义的值执行自动同步。
- en: ④ Sets the Git repository URL
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: ④ 设置 Git 仓库 URL
- en: ⑤ The directory with application manifests
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: ⑤ 应用清单的目录
- en: ⑥ The destination cluster where manifests are applied
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: ⑥ 应用清单的目标集群
- en: In a similar way, the cluster directory is added as an Argo CD application.
    Create the `cluster-ops.yaml` file in the welcome-message-gitops/gitops folder.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 以类似的方式，将集群目录添加为 Argo CD 应用。在 welcome-message-gitops/gitops 文件夹中创建 `cluster-ops.yaml`
    文件。
- en: Listing 8.14 welcome-message-gitops/gitops/cluster-ops.yaml
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.14 welcome-message-gitops/gitops/cluster-ops.yaml
- en: '[PRE17]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: ① Directory with manifests for external dependencies
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: ① 外部依赖的清单目录
- en: Apply the cluster-ops.yaml resource to install and configure the external dependencies
    required by the Welcome Message service. In a terminal window, run the command
    shown in the following listing.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 将 cluster-ops.yaml 资源应用到安装和配置 Welcome Message 服务所需的外部依赖。在终端窗口中，运行以下列表中显示的命令。
- en: Listing 8.15 Registering the cluster application
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.15 注册集群应用
- en: '[PRE18]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: ① Registering the cluster application
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: ① 注册集群应用
- en: The previous execution registers the cluster directory as the Argo CD application.
    Since it’s the first time, and the `syncPolicy` parameter is set to `automated`,
    Argo CD automatically applies the resources defined there. Validate that PostgreSQL
    and Vault are deployed by getting Pods of the default namespace using the command
    shown in the following listing.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 上次执行将集群目录注册为 Argo CD 应用。由于是第一次，并且 `syncPolicy` 参数设置为 `automated`，Argo CD 会自动应用那里定义的资源。通过以下列表中显示的命令获取默认命名空间中的
    Pods 来验证 PostgreSQL 和 Vault 是否已部署。
- en: Listing 8.16 Getting all `pods`
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.16 获取所有 `pods`
- en: '[PRE19]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: ① PostgreSQL is deployed.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: ① PostgreSQL 已部署。
- en: ② Vault statefulset is deployed.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: ② Vault 状态集已部署。
- en: The `argocd` CLI tool also lets you review the status of the deployment using
    the command shown in the following listing.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: '`argocd` CLI 工具还允许你使用以下列表中显示的命令来审查部署的状态。'
- en: Listing 8.17 Listing ArgoCD applications
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.17 列出 ArgoCD 应用
- en: '[PRE20]'
  id: totrans-155
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: ① Lists current Argo CD applications
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: ① 列出当前 Argo CD 应用
- en: The `status` field shows the current status of the resources. When it’s set
    to `Synced`, the cluster is aligned with the state specified with the Git repository.
    To deploy the Welcome Message service, apply the `apps-ops.yaml` file created
    in the previous step using the command shown in the following listing.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: '`status` 字段显示资源的当前状态。当它设置为 `Synced` 时，集群与 Git 仓库中指定的状态保持一致。要部署 Welcome Message
    服务，使用以下列表中显示的命令应用之前步骤中创建的 `apps-ops.yaml` 文件。'
- en: Listing 8.18 Registering the service application
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.18 注册服务应用
- en: '[PRE21]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: ① Registering the apps application
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: ① 注册应用
- en: The Welcome Message service is deployed when its Pod is in the running state
    using the command shown in the following listing.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下列表中显示的命令，当 Pod 处于运行状态时，部署 Welcome Message 服务。
- en: Listing 8.19 Getting all `pods`
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.19 获取所有 `pods`
- en: '[PRE22]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: ① The Welcome Message service is deployed.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: ① Welcome Message 服务已部署。
- en: 8.3.4 Updating the Welcome service
  id: totrans-165
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.3.4 更新 Welcome 服务
- en: So far you’ve learned how to build the Welcome Message service using Tekton
    and how to deploy it the first time automatically, using the Argo CD project.
    But what happens when the service is already deployed and a new version needs
    to be released?
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，你已经学习了如何使用 Tekton 构建 Welcome Message 服务，以及如何使用 Argo CD 项目自动部署它。但是，当服务已经部署并且需要发布新版本时会发生什么呢？
- en: Aside from packaging the new version of the service, building a container, and
    pushing it to the container registry, as explained in section 7.3, now the CI
    pipeline needs to update the Welcome Message service Kubernetes Deployment file
    with the new container tag and push the update to the Git repository to start
    the rolling update of the service. Figure 8.6 shows how Tekton (Continuous Integration
    part) and Argo CD (Continuous Delivery part) work together to implement a CD pipeline.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 除了打包服务的新版本、构建容器并将其推送到容器注册库，如第 7.3 节中所述，现在 CI 管道需要更新 Welcome Message 服务的 Kubernetes
    部署文件，并使用新容器标签将其推送到 Git 仓库以启动服务的滚动更新。图 8.6 展示了 Tekton（持续集成部分）和 Argo CD（持续交付部分）如何协同工作以实现
    CD 管道。
- en: '![](../Images/CH08_F07_Sotobueno3.png)'
  id: totrans-168
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/CH08_F07_Sotobueno3.png)'
- en: Figure 8.6 Interrelationship between Tekton and Argo CD
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.6 Tekton 和 Argo CD 之间的相互关系
- en: To implement these two remaining steps, some changes need to be made to Tekton
    resources.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 要实现这两个剩余步骤，需要对 Tekton 资源进行一些更改。
- en: PipelineResource for GitOps repository
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: GitOps 仓库的 PipelineResource
- en: The first thing to register is a new PipelineResource registering the GitOps
    repository location. This repository is the place Argo CD is listening for changes.
    The definition is shown in the following listing.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 首先需要注册的是一个新的 PipelineResource，用于注册 GitOps 仓库位置。这个仓库是 Argo CD 监听更改的地方。定义如下所示。
- en: Listing 8.20 welcome-service-gitops-resource.yaml
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.20 welcome-service-gitops-resource.yaml
- en: '[PRE23]'
  id: totrans-174
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: ① The repository migrated at the beginning of the chapter
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: ① 章节开头迁移的仓库
- en: In a terminal window, apply the resource using the command shown in the following
    listing.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 在终端窗口中，使用以下列表中的命令应用资源。
- en: Listing 8.21 Registering the GitOps repository
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.21 注册 GitOps 仓库
- en: '[PRE24]'
  id: totrans-178
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: ① Regsitering the pipline resource
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: ① 注册管道资源
- en: You need to set the username and password to push the changes made in the deployment
    file to the previous repository. This is done by creating a Kubernetes Secret
    and service account with the content shown in the following listing.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 您需要设置用户名和密码，以便将部署文件中做出的更改推送到先前存储库。这通过创建包含以下列表内容的 Kubernetes Secret 和服务帐户来完成。
- en: Listing 8.22 git-secret.yaml
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.22 git-secret.yaml
- en: '[PRE25]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: ① Setting the URL of the service to authenticate (gitea host)
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: ① 设置用于认证的服务 URL（gitea 主机）
- en: ② Configuring the authentication schema.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: ② 配置认证模式。
- en: ③ The username and password used in the Basic Auth mechanism
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: ③ 在基本认证机制中使用的用户名和密码
- en: ④ The service account with the created secret
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: ④ 使用创建的密钥的服务帐户
- en: ImportanT Remember to manage these secrets correctly using any of the techniques
    shown in chapter 3.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示：请记住使用第 3 章中展示的任何技术正确管理这些密钥。
- en: In a terminal window apply the resource using the command shown in the following
    listing.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 在终端窗口中，使用以下列表中的命令应用资源。
- en: Listing 8.23 Registering the Gitea secret
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.23 注册 Gitea 密钥
- en: '[PRE26]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: ① Creating the secret
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: ① 创建密钥
- en: Updating the Tekton task to update the container image
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 更新 Tekton 任务以更新容器镜像
- en: About `yq`
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 关于 `yq`
- en: '`yq` is a lightweight and portable command-line YAML processor. It can be used
    to query YAML documents or modify them. The `yq` tool uses the following structure:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: '`yq` 是一个轻量级且便携的命令行 YAML 处理器。它可以用于查询 YAML 文档或修改它们。`yq` 工具使用以下结构：'
- en: '[PRE27]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Given the following YAML document:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 给定以下 YAML 文档：
- en: '[PRE28]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'You can refer to the `image` field by using the following expression: `.spec.template
    .spec.containers[0].image`. Run the following to update the `image` field to a
    new value using `yq`:'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用以下表达式通过 `image` 字段进行引用：`.spec.template .spec.containers[0].image`。运行以下命令使用
    `yq` 更新 `image` 字段到新值：
- en: '[PRE29]'
  id: totrans-199
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'Before configuring the pipeline, you need to modify the task defined previously
    with two new additions:'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 在配置管道之前，您需要修改先前定义的任务，并添加两个新功能：
- en: Defining a new resource for the GitOps repository, so it’s automatically cloned
  id: totrans-201
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 定义 GitOps 存储库的新资源，以便自动克隆
- en: Defining a step that updates the deployment definition with the container image
    tag created in the previous step
  id: totrans-202
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 定义一个步骤，使用前一个步骤中创建的容器镜像标签更新部署定义
- en: '[PRE30]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: ① Defining the GitOps input resource with gitops name
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: ① 使用 gitops 名称定义 GitOps 输入资源
- en: ② Custom image with git and yq installed
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: ② 使用 git 和 yq 安装的定制镜像
- en: ③ Moving into the cloned repository
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: ③ 进入克隆的仓库
- en: ④ Creating a new branch for the update
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: ④ 为更新创建新分支
- en: ⑤ Configuring the Git user
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: ⑤ 配置 Git 用户
- en: ⑥ Updating the deployment file with the new container
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: ⑥ 使用新容器更新部署文件
- en: ⑦ Committing and pushing the changes to the repository
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: ⑦ 将更改提交并推送到仓库
- en: The following listing shows the full version of the `Task`.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 以下列表显示了 `Task` 的完整版本。
- en: Listing 8.24 welcome-service-task.yaml
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.24 welcome-service-task.yaml
- en: '[PRE31]'
  id: totrans-213
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: ① Apache Maven task to package the application
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: ① Apache Maven 任务打包应用程序
- en: ② The Buildah command to build the container
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: ② 构建容器的 Buildah 命令
- en: ③ The Buildah command to push the container to the container registry
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: ③ 将容器推送到容器注册表的 Buildah 命令
- en: ④ Moving to the gitops repository
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: ④ 移动到 gitops 仓库
- en: ⑤ Creating a new branch
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: ⑤ 创建新分支
- en: ⑥ Updating the deployment YAML file with the new container image tag
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: ⑥ 使用新容器镜像标签更新部署 YAML 文件
- en: ⑦ Committing and pushing the change to the Git repository
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: ⑦ 将更改提交并推送到 Git 仓库
- en: In a terminal window, apply the resource executing the command shown in the
    following listing.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 在终端窗口中，执行以下列表中的命令以应用资源。
- en: Listing 8.25 Upating the Welcome service task
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.25 更新 Welcome 服务任务
- en: '[PRE32]'
  id: totrans-223
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: ① Updating the task from the previous chapter
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: ① 更新上一章中的任务
- en: ImportanT Substitute `replace` with `apply` if you didn’t apply the Tekton `task`
    in the previous section.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 重要：如果你在上一节中没有应用 Tekton `task`，请将 `replace` 替换为 `apply`。
- en: Updating the pipeline definition
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 更新 pipeline 定义
- en: The `pipeline` definition requires an update on the resources part, as shown
    in the following listing to register the GitOps repository.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: '`pipeline` 定义需要在资源部分进行更新，如下所示，以注册 GitOps 仓库。'
- en: Listing 8.26 welcome-service-pipeline.yaml
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.26 welcome-service-pipeline.yaml
- en: '[PRE33]'
  id: totrans-229
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: ① Defining a new Git resoure
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: ① 定义一个新的 Git 资源
- en: ② Setting the resource to the task
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: ② 将资源设置为任务
- en: In a terminal window apply the resource executing the command shown in the following
    listing.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 在终端窗口中，执行以下列表中的命令以应用资源。
- en: Listing 8.27 Updating the Welcome service pipeline
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.27 更新 Welcome 服务 pipeline
- en: '[PRE34]'
  id: totrans-234
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: ImportanT Substitute `replace` with `apply` if you didn’t apply the Tekton `task`
    in the previous section.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 重要：如果你在上一节中没有应用 Tekton `task`，请将 `replace` 替换为 `apply`。
- en: Updating PipelineRun
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 更新 PipelineRun
- en: 'Finally, create a new `PipelineRun` with the following changes:'
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，创建一个新的 `PipelineRun`，包含以下更改：
- en: Increase the image tag number.
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 增加镜像标签号。
- en: Set the reference of the new `PipelineResource`.
  id: totrans-239
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置新的 `PipelineResource` 的引用。
- en: Configure the service account running the Pipeline.
  id: totrans-240
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 配置运行 Pipeline 的服务账户。
- en: The new `PipelineRun` is shown in the following listing.
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 新的 `PipelineRun` 如下所示。
- en: Listing 8.28 welcome-service-gitops-resource-2.yaml
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.28 welcome-service-gitops-resource-2.yaml
- en: '[PRE35]'
  id: totrans-243
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: ① The new PipelineRun
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: ① 新的 PipelineRun
- en: ② The version of the container is increased.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: ② 增加容器版本。
- en: ③ A new GitOps resource is registered.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: ③ 注册一个新的 GitOps 资源。
- en: ④ The serviceAccount with gitea credentials
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: ④ 使用 gitea 凭据的 serviceAccount
- en: In a terminal window, apply the resource executing the command shown in the
    following listing.
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 在终端窗口中，执行以下列表中的命令以应用资源。
- en: Listing 8.29 Registering PipelineRun
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.29 注册 PipelineRun
- en: '[PRE36]'
  id: totrans-250
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: ① Registering the new PipelineRun
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: ① 注册新的 PipelineRun
- en: Inspecting the output
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 检查输出
- en: 'After applying the previous `PipelineRun`, a new `Pipeline` instance is started.
    It executes the following steps in Tekton:'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 在应用了之前的 `PipelineRun` 之后，一个新的 `Pipeline` 实例被启动。它在 Tekton 中执行以下步骤：
- en: Clones the service Git repository and GitOps repository from `gitea`
  id: totrans-254
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从 `gitea` 克隆 service Git 仓库和 GitOps 仓库
- en: Builds the service
  id: totrans-255
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 构建 service
- en: Creates a container image and pushes it to the container `registry` instance
  id: totrans-256
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建容器镜像并将其推送到容器 `registry` 实例
- en: Updates the deployment file with the new image
  id: totrans-257
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用新镜像更新部署文件
- en: Pushes the deployment file to the GitOps repository
  id: totrans-258
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将部署文件推送到 GitOps 仓库
- en: To view the currently executing log lines, run the command shown in the following
    listing.
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看当前正在执行的日志行，请运行以下列表中的命令。
- en: Listing 8.30 Listing the PipelineRun
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.30 列出 PipelineRun
- en: '[PRE37]'
  id: totrans-261
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: ① Showing the logs of the current PipelineRun
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: ① 显示当前 PipelineRun 的日志
- en: 'The steps are shown in the following log lines:'
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 步骤如下面的日志行所示：
- en: '[PRE38]'
  id: totrans-264
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: ① The Welcome service Git repo is cloned.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: ① 克隆 Welcome 服务 Git 仓库。
- en: ② The Welcome service GitOps repo is cloned.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: ② 克隆 Welcome 服务 GitOps 仓库。
- en: ③ Building the Welcome service Java project
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: ③ 构建 Welcome 服务 Java 项目
- en: ④ Building the Welcome service Linux container
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: ④ 构建 Welcome 服务 Linux 容器
- en: ⑤ Pushing the Linux container to the container registry
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: ⑤ 将 Linux 容器推送到容器注册库
- en: ⑥ Updating the Welcome service deployment file
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 更新欢迎服务部署文件
- en: ⑦ Pushing the Deployment file to the GitOps repo
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: ⑦ 将部署文件推送到 GitOps 仓库
- en: After these steps are executed, Argo CD will detect the change on the `welcome-message-gitops/apps/app.yml`
    Deployment file. It will apply these changes, triggering a rolling update of the
    service to the new version.
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 执行这些步骤后，Argo CD 将检测 `welcome-message-gitops/apps/app.yml` 部署文件上的更改。它将应用这些更改，触发服务的滚动更新到新版本。
- en: ImportanT The Argo CD controller can detect and sync the new manifests using
    a webhook or polling every three minutes. The polling strategy is the default
    one.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 重要：Argo CD 控制器可以使用 webhook 或每三分钟轮询来检测和同步新的清单。轮询策略是默认的。
- en: After waiting up to three minutes, Argo CD will detect the change and start
    the synchronization process, applying the new deployment file. Suppose you continuously
    monitor the status of the Pods. In that case, you’ll see how the old Welcome Message
    Pod is terminated, and a new one is started automatically with the container created
    in the Tekton process. Execute the command shown in the following listing continuously
    to inspect the change.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 等待最多三分钟后，Argo CD 将检测到更改并开始同步过程，应用新的部署文件。假设你持续监控 Pod 的状态，你会看到旧的欢迎信息 Pod 被终止，并自动启动一个新的
    Pod，该 Pod 在 Tekton 流程中创建的容器中。连续执行以下列表中的命令以检查更改。
- en: Listing 8.31 Getting all pods
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.31 获取所有 pod
- en: '[PRE39]'
  id: totrans-276
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: ① The new version of the service is deployed.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: ① 已部署服务的最新版本。
- en: ② The old version of the service is undeployed.
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: ② 服务的老版本已卸载。
- en: ③ The PipelineRun is completed.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: ③ PipelineRun 已完成。
- en: Describing the newly deployed Pod like listing 8.32 shows the new container
    is used.
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: 如列表 8.32 所示，描述新部署的 Pod 显示了新容器被使用。
- en: Listing 8.32 Describing the new Welcome service `pod`
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.32 描述新的欢迎服务 `pod`
- en: '[PRE40]'
  id: totrans-282
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: ① Changing the pod name to the correct one
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: ① 将 pod 名称更改为正确的名称
- en: ② The version tag is updated.
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: ② 版本标签已更新。
- en: Figure 8.7 shows a screenshot of the Argo CD dashboard, where the Welcome Message
    status is shown. If you look closely, you’ll see that `rev:2` is the current deployment,
    as the service has been updated.
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.7 显示了 Argo CD 仪表板的截图，其中显示了欢迎信息的状态。如果你仔细看，你会看到 `rev:2` 是当前的部署，因为服务已被更新。
- en: '![](../Images/CH08_F08_Sotobueno3.png)'
  id: totrans-286
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/CH08_F08_Sotobueno3.png)'
- en: Figure 8.7 Argo CD dashboard
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.7 Argo CD 仪表板
- en: Summary
  id: totrans-288
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: Kubernetes Secrets are used in the application code (e.g., usernames, passwords,
    and API keys) and the CI/CD pipelines (e.g., usernames and passwords of external
    services).
  id: totrans-289
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Kubernetes Secrets 被用于应用程序代码（例如，用户名、密码和 API 密钥）以及 CI/CD 管道（例如，外部服务的用户名和密码）。
- en: Enable Kubernetes data encryption at rest to store encrypted secrets inside
    Kubernetes.
  id: totrans-290
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 启用 Kubernetes 数据静态加密以在 Kubernetes 内部存储加密密钥。
- en: CD secrets need to be protected like any other secret. Use `SealSecrets` in
    Argo CD to store encrypted secrets in Git.
  id: totrans-291
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CD 密钥需要像其他密钥一样受到保护。使用 Argo CD 中的 `SealSecrets` 将加密密钥存储在 Git 中。
- en: Git is used as a single source of truth for the source code and deploying scripts.
  id: totrans-292
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Git 被用作源代码和部署脚本的单一真相来源。
- en: Argo CD is a Kubernetes controller that allows you to implement GitOps in Kubernetes.
  id: totrans-293
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Argo CD 是一个 Kubernetes 控制器，允许你在 Kubernetes 中实现 GitOps。
