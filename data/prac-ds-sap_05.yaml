- en: Chapter 5\. Anomaly Detection with R and Python
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第5章。使用R和Python进行异常检测
- en: McKesson Corporation (McKesson), one of the nation’s largest distributors of
    pharmaceutical drugs, agreed to pay a record $150 million civil penalty for alleged
    violations of the Controlled Substances Act (CSA), the Justice Department announced
    today.
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 麦克森公司（McKesson），美国最大的药品分销商之一，同意支付创纪录的1.5亿美元民事罚款，涉嫌违反《受控物质法》（CSA），司法部今天宣布。
- en: ''
  id: totrans-2
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Department of Justice, January 17, 2017
  id: totrans-3
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 司法部，2017年1月17日
- en: Upon reading those headlines, Janine’s heart sank. She read the article with
    rapt attention; this affected her. She worked in the regulatory department at
    Big Bonanza Warehouse where she was responsible for maintaining corporate compliance.
    She was aware of [Suspicious Order Monitoring Regulations](http://bit.ly/2lRRCHu)
    (21 C.F.R. 1301.74(b)). Lately the Department of Justice was hitting companies
    left and right for noncompliance with this regulation, much more than they had
    done in the past. The regulation loosely states that companies that manufacture
    and distribute controlled substances “know their customers.” In the regulation’s
    exact words,
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 阅读这些头条新闻时，简妮的心沉了下去。她专心阅读了文章；这影响了她。她在大宝矿库的监管部门工作，负责维护公司的合规性。她知道《可疑订单监控法规》（21
    C.F.R. 1301.74(b)）。最近，司法部因不符合该法规而连续打击公司，比过去更为频繁。法规大致规定，从事受控物质的制造和分销公司“了解他们的客户”。法规的确切措辞是，
- en: It is fundamental for sound operations that handlers take reasonable measures
    to identify their customers, understand the normal and expected transactions typically
    conducted by those customers, and, consequently, identify those transactions conducted
    by their customers that are suspicious in nature.
  id: totrans-5
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 对于健全运营来说，处理人员采取合理措施识别他们的客户、了解这些客户通常进行的正常和预期交易，从而识别客户进行的那些可疑交易是至关重要的。
- en: ''
  id: totrans-6
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: 21 C.F.R. 1301.74(b)
  id: totrans-7
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 21 C.F.R. 1301.74(b)
- en: But what exactly did this mean? She knew that her company had their sales orders
    in SAP. There were over 10 years of sales orders. But what did it mean to *understand
    the normal and expected transactions* of their customers? She decided to take
    this to the SAP team and discuss with them what, if anything, could be done to
    protect them from noncompliance and potential fines.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 但这究竟意味着什么？她知道她的公司在SAP中有销售订单。已经有超过10年的销售订单了。但了解客户的*正常和预期交易*意味着什么？她决定把这个问题带给SAP团队，并与他们讨论，如果可能的话，可以采取什么措施来保护他们免受违规行为和潜在罚款的影响。
- en: 'Duane, an analyst on the SAP team, was intrigued by her query. SAP contains/stores
    sales orders and sales order history, but it doesn’t provide ordering patterns
    or a system to detect when there is an anomaly. The first question: “What is an
    anomaly?” It’s not as simple as saying a customer typically orders 5 of a product
    one week and then suddenly orders 10\. What if they missed a week? What if they
    had steadily been increasing their supply chain and now 10 was acceptable?'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 杜安，SAP团队的分析师，对她的问题很感兴趣。SAP包含/存储销售订单和销售订单历史记录，但它没有提供订购模式或检测系统，以便在出现异常时进行检测。首先要问的问题是：“什么是异常？”这并不像简单地说一个客户通常一周订购5件产品，然后突然订购10件那么简单。如果他们错过了一周怎么办？如果他们一直在稳步增加他们的供应链，现在10件就是可以接受的？
- en: When Duane brought the problem to data scientists Greg and Paul, they immediately
    smelled an *anomaly detection* issue. Anomaly detection is fundamentally a method
    of identifying unusual patterns in data that do not conform to what is expected.
    Most of us have experienced anomaly detection using data science already. When
    you get that text message or call from your credit card company asking you about
    a recent transaction, you have experienced anomaly detection. Fraud detection
    is a sophisticated method of anomaly detection that credit card companies use
    to prevent loss.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 当杜安把问题带给数据科学家格雷格和保罗时，他们立刻嗅到了*异常检测*问题。异常检测基本上是一种识别数据中不符合预期模式的异常模式的方法。我们大多数人已经通过数据科学体验过异常检测。当你收到信用卡公司的短信或电话询问最近的交易时，你就体验过异常检测。欺诈检测是信用卡公司用来防止损失的一种复杂的异常检测方法。
- en: Greg and Paul fired up their program editors, ready to find those anomalies.
    Duane stuck around, primarily to provide SAP insight to Greg and Paul—but also
    to check out how they went about doing what they did. Duane felt pretty sure that
    while he didn’t have a PhD in statistics or computer science, he could follow
    along enough to start to understand.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: Greg 和 Paul 启动了他们的程序编辑器，准备找出那些异常。Duane 逗留在旁边，主要是为了向 Greg 和 Paul 提供 SAP 的见解，但也想看看他们是如何做到这一点的。Duane
    相当确定，虽然他没有统计学或计算机科学的博士学位，但他能够跟上足够的速度开始理解。
- en: Types of Anomalies
  id: totrans-12
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 异常类型
- en: 'There are three general types of anomalies:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 有三种一般类型的异常：
- en: Point
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 点
- en: Anomalies in data identified by a significant outlier. In our ordering pattern
    example, let’s say a customer typically orders 10 of an item per week but one
    week they order 100\. This increase of 10 times their typical order is a simple
    point anomaly.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 数据中的异常由一个显著的离群值确定。在我们的订购模式示例中，假设一个客户通常每周订购 10 个项目，但某周他们订购了 100 个。这种订单量比他们典型订单增加了
    10 倍，是一个简单的点异常。
- en: Contextual
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 环境
- en: Anomalies within a condition. Often, this is an analysis within time-series
    data. Taking sales data as an example, let’s say a customer orders many products
    throughout the year, but they order mittens in July. An order of mittens in December
    is not an anomaly, but in July it is.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 在一个条件内的异常。通常，这是对时间序列数据的分析。以销售数据为例，假设一个客户整年都订购很多产品，但七月份订购手套。十二月份订购手套不是异常，但七月份是。
- en: Collective
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 集体
- en: Anomalies viewed within the context of a set of data. This relates to patterns
    overall in the data, like an EKG or sine wave. If a customer’s ordering pattern
    breaks out of their typical wave or pattern, this would be anomalous.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在数据集的上下文中查看的异常。这与数据整体的模式相关，如心电图或正弦波。如果客户的订购模式突破了他们典型的波动或模式，这将是异常的。
- en: Perhaps the simplest method of detecting anomalies is to flag data points as
    anomalous if they are a certain standard deviation from the mean or median. Sales
    data is over a time series so a rolling window will have to be taken into consideration.
    Defining the width of the rolling window would be determined by the business conditions,
    as each business’s situation is a little different. In our case of suspicious
    order detection, a three-year window would be appropriate. The rolling window
    (or rolling average) flattens fluctuations over the short term and emphasizes
    long-term fluctuations. In our current scenario, we could use a regression and
    fit the line with a tolerance. Anything that appears outside the tolerance is
    an anomaly.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 或许检测异常的最简单方法是，如果数据点距离均值或中位数有一定标准偏差，则将其标记为异常。销售数据是一个时间序列，所以必须考虑一个滚动窗口。定义滚动窗口的宽度将由业务条件决定，因为每个企业的情况都有所不同。在我们怀疑的订单检测案例中，三年的窗口是合适的。滚动窗口（或滚动平均）平滑短期波动并强调长期波动。在我们当前的情况下，我们可以使用回归并带有容差地拟合线条。任何超出容差范围的东西都是异常。
- en: However, this is a fairly static approach and for us...not enough. It would
    not take into consideration any context, such as seasonality. We do not know if
    there is seasonality in our sales order data; therefore, to be prudent we should
    at least check for it. We know that our requirement is to *know our customers*
    so we want to see ordering patterns over time. Simply put, we want to identify
    collective anomalies.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，这是一个相当静态的方法，对我们来说……不够。它不会考虑到任何背景信息，比如季节性。我们不知道我们的销售订单数据是否有季节性；因此，为了慎重起见，我们至少应该检查一下。我们知道我们的要求是*了解我们的客户*，所以我们希望看到随时间变化的订购模式。简而言之，我们想识别集体异常。
- en: Tools in R
  id: totrans-22
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: R 中的工具
- en: 'There are many well-documented techniques for detecting anomalies using static
    methods (like the ones discussed earlier), machine learning techniques, and neural
    network models. When considering which technique to use, answer the following
    questions:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 有许多文档详细描述的技术，用于使用静态方法（如前面讨论过的方法）、机器学习技术和神经网络模型来检测异常。在考虑使用哪种技术时，请回答以下问题：
- en: What type of data is it?
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它是什么类型的数据？
- en: For our scenario, it is time-series data.
  id: totrans-25
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 对于我们的情景来说，这是时间序列数据。
- en: Is the data labeled?
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 数据被标记了吗？
- en: We don’t have labeled data so we are in an unsupervised learning scenario.^([1](ch05.html#ch05fn1))
    If the data is labeled it can be broken into test and training sets and basically
    turned into a classification problem.
  id: totrans-27
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 我们没有标记的数据，因此我们处于无监督学习的场景中。^([1](ch05.html#ch05fn1)) 如果数据被标记，它可以被分成测试和训练集，并基本上被转化为分类问题。
- en: We have a number of tools in the data scientist’s toolbox to conduct unsupervised
    learning with time-series data. We could go all sledgehammer on this and build
    a recursive neural network using TensorFlow/Keras. That would complicate things
    greatly and not necessarily (actually unlikely) return us any better results than
    a couple of R libraries and Python packages built for this very purpose.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 数据科学家工具箱中有许多工具可用于使用时间序列数据进行无监督学习。我们可以采用 TensorFlow/Keras 构建递归神经网络。这将大大复杂化事情，并且不一定（实际上不太可能）会比为此目的构建的几个
    R 库和 Python 包提供更好的结果。
- en: Tip
  id: totrans-29
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 提示
- en: In R there are vignettes. These are tutorials for packages and most of the time
    they are very informative and useful. To see the available vignettes for your
    packages, type `**browseVignettes()**` in the console of your R tool. To see a
    detailed tutorial on dplyr, for instance, type `**browseVignettes(“dplyr”)**`.
    In this case there are multiple tutorials for this essential package in R.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 在 R 中有小品文档（vignettes）。这些是包的教程，大多数时候非常信息丰富和有用。要查看您包中可用的小品文档，请在 R 工具的控制台中输入 `**browseVignettes()**`。例如，要查看关于
    dplyr 的详细教程，请输入 `**browseVignettes(“dplyr”)**`。在这种情况下，这个关键包在 R 中有多个教程。
- en: AnomalyDetection
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: AnomalyDetection
- en: This is a package that has been open sourced by Twitter. It is built to detect
    anomalies in time-series data...just what we are looking to do. It is based on
    a seasonal extreme studentized deviate (ESD), which in turn is based on the generalized
    ESD. The generalized ESD is a test to detect anomalies in univariate data that
    is approximately normally distributed. The advantage of the generalized ESD is
    that it does not require the number of outliers to be specified, just that there
    is an upper bound for the suspected number.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个由 Twitter 开源的包。它专门用于检测时间序列数据中的异常……正是我们正在寻找的。它基于季节性极端学生化偏差（ESD），而季节性极端学生化偏差则基于广义
    ESD。广义 ESD 是一种检测近似正态分布的单变量数据异常的测试方法。广义 ESD 的优点在于，它不需要指定异常值的数量，只需指定疑似异常值的上限。
- en: Given this upper bound, let’s say *u*, the package essentially performs *u*
    number of tests, first a test for one anomaly, then two, and so on up to *u* anomalies.^([2](ch05.html#ch05fn2))
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 给定这个上限，假设为 *u*，该包实际上执行 *u* 个测试，首先是一个异常测试，然后是两个，依此类推，直到 *u* 个异常。
- en: Anomalize
  id: totrans-34
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Anomalize
- en: The `anomalize package` is yet another testament to the functionality and power
    of programming languages like R and Python. There is [wonderful documentation](http://bit.ly/2mkWhlB)
    on this package on CRAN.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: '`anomalize package` 是对像 R 和 Python 这样的编程语言功能和能力的又一个证明。在 CRAN 上有关于这个包的 [精彩文档](http://bit.ly/2mkWhlB)。'
- en: 'This package is designed to detect all types of anomalies: point, contextual,
    and collective. It is a scalable adaptation of the Twitter `AnomalyDetection`
    package developed by *Business Science.^([3](ch05.html#ch05fn3))* It is a time-series
    based anomaly detection package that is scalable from one to many time series.'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 这个包被设计用于检测所有类型的异常：点异常、上下文异常和集体异常。它是由 *Business Science.* 开发的 Twitter `AnomalyDetection`
    包的可扩展适应版。这是一个基于时间序列的异常检测包，可以适用于一个到多个时间序列。
- en: We understand the scenario and the data needed from SAP. We have also identified
    some useful libraries in R for the detecting anomalies. Our mission is defined
    by the Justice Department. We need to understand our customers and their ordering
    patterns. Namely, we want to know when there are anomalies. The steps that follow
    will walk through the process of taking our SAP order data and turning it into
    a report of anomalies.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 我们了解来自 SAP 所需的情景和数据。我们还在 R 中为检测异常识别了一些有用的库。我们的任务由司法部定义。我们需要理解我们的客户及其订购模式。换句话说，我们想知道何时发生异常。接下来的步骤将详细介绍将我们的
    SAP 订单数据转化为异常报告的过程。
- en: Getting the Data
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 获取数据
- en: There are many ways to get data out of SAP. For our anomaly detection scenario
    we could simply download the data in a CSV, read it through SAP Gateway, or use
    a CDS view. We may or may not need to house the data in a separate system, but
    for illustrative purposes, we will do so here. In our scenario, we will read data
    from SAP via the NetWeaver Gateway using SQL Server Integration Services (SSIS).
    We then pull that data from SQL into Power BI. Finally we’ll use R and Python
    code to create an interactive dashboard for anomaly detection.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 有许多方法可以从SAP中获取数据。对于我们的异常检测场景，我们可以简单地通过CSV下载数据，通过SAP Gateway读取，或使用CDS视图。我们可能需要或不需要将数据存储在单独的系统中，但为了说明目的，我们将在这里执行这些操作。在我们的场景中，我们将通过NetWeaver
    Gateway从SAP中读取数据，使用SQL Server Integration Services（SSIS）将数据从SQL中提取到Power BI中。最后，我们将使用R和Python代码创建一个交互式仪表板进行异常检测。
- en: SAP ECC System
  id: totrans-40
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: SAP ECC系统
- en: Our first step is to define a structure of data that we would like to analyze.
    We want to see sales order line quantities by material and customer.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的第一步是定义我们想要分析的数据结构。我们希望看到按材料和客户的销售订单行数量。
- en: Enter transaction code `**SE11**` into SAP and give a name to the data structure
    and then click on the Create button ([Figure 5-1](#sap_data_dictionary)).
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 在SAP中输入事务码`**SE11**`，为数据结构命名，然后点击创建按钮（[图 5-1](#sap_data_dictionary)）。
- en: '![SAP Data Dictionary](assets/pdss_0501.png)'
  id: totrans-43
  prefs: []
  type: TYPE_IMG
  zh: '![SAP数据字典](assets/pdss_0501.png)'
- en: Figure 5-1\. SAP data dictionary
  id: totrans-44
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-1\. SAP数据字典
- en: Select the Structure radio button and click on Enter ([Figure 5-2](#sap_structure_selection)).
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 选择“Structure”单选按钮，然后点击Enter（[图 5-2](#sap_structure_selection)）。
- en: '![SAP Structure selection](assets/pdss_0502.png)'
  id: totrans-46
  prefs: []
  type: TYPE_IMG
  zh: '![SAP结构选择](assets/pdss_0502.png)'
- en: Figure 5-2\. SAP structure selection
  id: totrans-47
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-2\. SAP结构选择
- en: We want to gather sales order, sales order item, material ordered, quantity,
    customer, and the order date. Enter a Short Description of the data and the fields
    ([Figure 5-3](#components_of_a_data_structure)). (Staying with the original SAP
    names as field names makes integration with the gateway simpler. We will rename
    them out of the gateway as something meaningful.)
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 我们想要收集销售订单、销售订单项目、订购材料、数量、客户和订单日期。输入数据和字段的简短描述（[图 5-3](#components_of_a_data_structure)）。（保持原始SAP字段名称作为字段名称使得与网关的集成更简单。我们将在网关之外将它们重命名为有意义的名称。）
- en: '![Components of a data structure](assets/pdss_0503.png)'
  id: totrans-49
  prefs: []
  type: TYPE_IMG
  zh: '![数据结构的组成部分](assets/pdss_0503.png)'
- en: Figure 5-3\. Components of a data structure
  id: totrans-50
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-3\. 数据结构的组成部分
- en: Click on the Currency/quantity fields tab to add a reference value for the quantity
    field.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 点击货币/数量字段选项卡，为数量字段添加参考值。
- en: If you do not know what the reference table and field are you can refer to the
    tables from which we will be reading. In this case those tables are VBAK (sales
    order header) and VBAP (sales order item).
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你不知道参考表和字段是什么，你可以参考我们将要读取的表格。在这种情况下，这些表格是VBAK（销售订单头）和VBAP（销售订单项目）。
- en: '![Currency and Quantity fields copied from the VBAP table for the quantity
    (KWMENG).](assets/pdss_0504.png)'
  id: totrans-53
  prefs: []
  type: TYPE_IMG
  zh: '![从VBAP表复制的货币和数量字段用于数量（KWMENG）。](assets/pdss_0504.png)'
- en: Figure 5-4\. Currency and quantity fields copied from the VBAP table for the
    quantity (KWMENG)
  id: totrans-54
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-4\. 从VBAP表复制的货币和数量字段用于数量（KWMENG）
- en: Follow the menu path Extras → Enhancement Category to enter whether this structure
    can be enhanced or not. We do not need enhancements, so we will choose Cannot
    be Enhanced (Figures [5-5](#data_structure_enhancement_category) and [5-6](#selection_for_enhancement_category)).
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 按照菜单路径 Extras → Enhancement Category 输入该结构是否可以增强。我们不需要增强，所以我们将选择不能增强（图[5-5](#data_structure_enhancement_category)
    和 [5-6](#selection_for_enhancement_category)）。
- en: '![Data Structure Enhancement Category](assets/pdss_0505.png)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
  zh: '![数据结构增强类别](assets/pdss_0505.png)'
- en: Figure 5-5\. Data structure enhancement category
  id: totrans-57
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-5\. 数据结构增强类别
- en: '![Selection for Enhancement Category](assets/pdss_0506.png)'
  id: totrans-58
  prefs: []
  type: TYPE_IMG
  zh: '![增强类别的选择](assets/pdss_0506.png)'
- en: Figure 5-6\. Selection for enhancement category
  id: totrans-59
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-6\. 增强类别的选择
- en: Click on the Copy button, then click on the Activate button. The pop-up dialog
    is asking for a package to assign this structure. For our purposes we are using
    a $TMP object so it will not be transported.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“复制”按钮，然后点击“激活”按钮。弹出对话框要求分配一个包以分配此结构。出于我们的目的，我们使用的是一个$TMP对象，因此不会进行传输。
- en: '![Activating the SAP Structure](assets/pdss_0507.png)'
  id: totrans-61
  prefs: []
  type: TYPE_IMG
  zh: '![激活SAP结构](assets/pdss_0507.png)'
- en: Figure 5-7\. Activating the SAP structure
  id: totrans-62
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-7\. 激活SAP结构
- en: If all is done correctly, you will get a confirmation “Object saved and activated”
    at the bottom of the screen.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 如果所有操作都正确完成，屏幕底部将显示“对象已保存并已激活”的确认消息。
- en: Next, click on the Back button. A table type is needed for the function module.
    We will create that now.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，点击“返回”按钮。函数模块需要一个表类型。我们现在将创建它。
- en: Enter the same name as used for the structure but prepend a “_TT” to it, as
    shown in [Figure 5-8](#sap_create_table_type).
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 在结构的名称前面加上“_TT”，与结构名称相同，如 [图 5-8](#sap_create_table_type) 中所示。
- en: '![SAP Create Table Type](assets/pdss_0508.png)'
  id: totrans-66
  prefs: []
  type: TYPE_IMG
  zh: '![SAP 创建表类型](assets/pdss_0508.png)'
- en: Figure 5-8\. Creating a table type in SAP
  id: totrans-67
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-8\. 在 SAP 中创建表类型
- en: Click on the Create button. This time choose the “Table type” radio button and
    press Enter ([Figure 5-9](#sap_table_type_selection)).
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“创建”按钮。这次选择“表类型”单选按钮，并按 Enter 键（参见 [图 5-9](#sap_table_type_selection)）。
- en: '![SAP Table Type Selection](assets/pdss_0509.png)'
  id: totrans-69
  prefs: []
  type: TYPE_IMG
  zh: '![SAP 表类型选择](assets/pdss_0509.png)'
- en: Figure 5-9\. SAP table type selection
  id: totrans-70
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-9\. SAP 表类型选择
- en: Enter a “Short text” and put in the structure previously created into the Line
    Type field ([Figure 5-10](#assigning_the_structure_to_the_table_typ)).
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 输入“简短文本”，并在“行类型”字段中放入先前创建的结构（参见 [图 5-10](#assigning_the_structure_to_the_table_typ)）。
- en: Click on the Activate button. You will be asked again for a package and will
    get the confirmation “Object saved and activated” once finished.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“激活”按钮。系统会再次询问您选择一个包，并在完成后显示“对象已保存并激活”的确认信息。
- en: '![Assigning the structure to the table type](assets/pdss_0510.png)'
  id: totrans-73
  prefs: []
  type: TYPE_IMG
  zh: '![将结构分配给表类型](assets/pdss_0510.png)'
- en: Figure 5-10\. Assigning the structure to the table type
  id: totrans-74
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-10\. 将结构分配给表类型
- en: The next step is to create a function module for reading the data. Enter transaction
    code `**SE37**` into the command line and hit Enter. Give the function module
    a meaningful name and then click on the Create button ([#sap_function_builder](#sap_function_builder)).
    Enter a “Function group” and a “Short text” description and then click on the
    Save button. If you don’t know a function group, you can get one from your Basis
    administrator or ABAP developer.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 下一步是为数据读取创建一个函数模块。在命令行输入事务码 `**SE37**` 并按 Enter 键。为函数模块命名，并点击“创建”按钮（参见 [#sap_function_builder](#sap_function_builder)）。输入“函数组”和“简短文本”描述，然后点击“保存”按钮。如果您不知道函数组，可以向您的
    Basis 管理员或 ABAP 开发人员获取。
- en: '![SAP Function Builder](assets/pdss_0511.png)'
  id: totrans-76
  prefs: []
  type: TYPE_IMG
  zh: '![SAP 功能生成器](assets/pdss_0511.png)'
- en: Figure 5-11\. SAP Function Builder
  id: totrans-77
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-11\. SAP 功能生成器
- en: You will get an information message ([#sap_function_module_warning](#sap_function_module_warning)).
    Click Enter to move past it.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 您将收到一条信息提示（[#sap_function_module_warning](#sap_function_module_warning)）。点击
    Enter 键继续。
- en: '![SAP Function Module warning](assets/pdss_0512.png)'
  id: totrans-79
  prefs: []
  type: TYPE_IMG
  zh: '![SAP 函数模块警告](assets/pdss_0512.png)'
- en: Figure 5-12\. SAP function module warning
  id: totrans-80
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-12\. SAP 函数模块警告
- en: Click on the Attributes tab and ensure that the function module is remote-enabled
    ([Figure 5-13](#sap_remote_enabled_function_selection)). Without this, the NetWeaver
    Gateway will not be able to call this.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“属性”选项卡，确保函数模块是远程可用的（参见 [图 5-13](#sap_remote_enabled_function_selection)）。如果没有这个选项，NetWeaver
    Gateway 将无法调用此函数。
- en: '![SAP Remote Enabled Function Selection](assets/pdss_0513.png)'
  id: totrans-82
  prefs: []
  type: TYPE_IMG
  zh: '![SAP 远程启用函数选择](assets/pdss_0513.png)'
- en: Figure 5-13\. SAP remote enabled function selection
  id: totrans-83
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-13\. SAP 远程启用函数选择
- en: Click on the Export tab and enter a Parameter Name and the Associated Type,
    which is the table type created earlier. Click on the Pass Value checkbox to ensure
    data is passed to this export parameter ([Figure 5-14](#parameters_for_function_module)).
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“导出”选项卡，输入参数名称和关联类型，即先前创建的表类型。选中“传递数值”复选框，确保数据传递到此导出参数（参见 [图 5-14](#parameters_for_function_module)）。
- en: '![Parameters for Function Module](assets/pdss_0514.png)'
  id: totrans-85
  prefs: []
  type: TYPE_IMG
  zh: '![函数模块的参数](assets/pdss_0514.png)'
- en: Figure 5-14\. Parameters for function module
  id: totrans-86
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-14\. 函数模块的参数
- en: 'Click on the “Source code” tab. Enter the following code. It is going to read
    all sales order line items greater than 01/01/2014\. Generally, it would be a
    good idea to add an import date parameter so it is more dynamic. However, for
    the purposes of illustration, we will keep this super simple:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“源代码”选项卡。输入以下代码。它将读取所有大于 2014 年 01 月 01 日的销售订单行项目。一般来说，添加一个导入日期参数会更加动态化。但是，为了说明的目的，我们会保持这个超级简单：
- en: '[PRE0]'
  id: totrans-88
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Click on the Activate button, then click on the Test button to make sure it
    works and doesn’t run too terribly long. Click on the Execute button. The function
    will return a table of data. If the table is large, like the one we have, do not
    click on the table button to view it. SAP will try to render the entire table
    and run into paging problems and simply quit.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 点击激活按钮，然后点击测试按钮确保它正常运行且不运行时间过长。点击执行按钮。函数将返回一张数据表。如果表很大，例如我们所拥有的这张表，不要点击查看表按钮。SAP将尝试渲染整个表格并遇到分页问题，然后会简单退出。
- en: '![Results of Function Module Test](assets/pdss_0515.png)'
  id: totrans-90
  prefs: []
  type: TYPE_IMG
  zh: '![功能模块测试结果](assets/pdss_0515.png)'
- en: Figure 5-15\. Results of function module test
  id: totrans-91
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-15\. 功能模块测试结果
- en: SAP NetWeaver Gateway
  id: totrans-92
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: SAP NetWeaver 网关
- en: Now for the SAP NetWeaver Gateway. As pointed out earlier, the great function
    of this utility is to expose our newly found data in an OData feed (either XML
    or JSON). If your SAP environment has a separate NetWeaver Gateway server, log
    in and enter the transaction code `**SEGW**`. Click on the Create button to create
    a new project. Enter a name for the Project, a Description, and a Package. Then
    click on the Enter button ([Figure 5-16](#creating_a_new_gateway_project_in_sap)).
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 现在是关于SAP NetWeaver 网关的说明。正如前面指出的，该实用程序的主要功能是通过OData feed（XML或JSON）公开我们新发现的数据。如果您的SAP环境有单独的NetWeaver
    网关服务器，请登录并输入事务码`**SEGW**`。点击创建按钮以创建新项目。输入项目名称、描述和包名称。然后点击输入按钮（[图 5-16](#creating_a_new_gateway_project_in_sap)）。
- en: '![Creating a new Gateway project in SAP](assets/pdss_0516.png)'
  id: totrans-94
  prefs: []
  type: TYPE_IMG
  zh: '![在SAP中创建新的网关项目](assets/pdss_0516.png)'
- en: Figure 5-16\. Creating a new NetWeaver Gateway project in SAP
  id: totrans-95
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-16\. 在SAP中创建新的NetWeaver 网关项目
- en: Your new project will appear below ([Figure 5-17](#project_in_transaction_segw)).
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 您的新项目将显示在下方（[图 5-17](#project_in_transaction_segw)）。
- en: '![Project in transaction SEGW](assets/pdss_0517.png)'
  id: totrans-97
  prefs: []
  type: TYPE_IMG
  zh: '![在事务SEGW中的项目](assets/pdss_0517.png)'
- en: Figure 5-17\. Project in transaction SEGW
  id: totrans-98
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-17\. 事务SEGW中的项目
- en: Right-click on the Data Model node and select Import → RFC/BOR Interface from
    the context menu to read in the function definition we just created ([Figure 5-18](#importing_the_rfc_into_the_model)).
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 右键单击数据模型节点，并从上下文菜单中选择导入 → RFC/BOR 接口来读取我们刚刚创建的函数定义（[图 5-18](#importing_the_rfc_into_the_model)）。
- en: '![Importing the RFC into the model](assets/pdss_0518.png)'
  id: totrans-100
  prefs: []
  type: TYPE_IMG
  zh: '![从功能模块导入RFC到模型中](assets/pdss_0518.png)'
- en: Figure 5-18\. Importing the RFC into the model
  id: totrans-101
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-18\. 将RFC导入模型
- en: Enter an Entity Type Name, select your target system, and enter the Name of
    the function module. In this example, since our gateway is embedded within SAP
    ERP, we use Local. Then click on the Next button ([Figure 5-19](#defining_the_rfc_for_the_gateway_model)).
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 输入实体类型名称，选择目标系统，并输入函数模块的名称。在此示例中，由于我们的网关嵌入在SAP ERP中，我们使用本地选项。然后点击下一步按钮（[图 5-19](#defining_the_rfc_for_the_gateway_model)）。
- en: '![Defining the RFC for the gateway model](assets/pdss_0519.png)'
  id: totrans-103
  prefs: []
  type: TYPE_IMG
  zh: '![定义网关模型的RFC](assets/pdss_0519.png)'
- en: Figure 5-19\. Defining the RFC for the gateway model
  id: totrans-104
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-19\. 定义网关模型的RFC
- en: Select all the checkboxes for the elements to be used in the service. We want
    all of them so only the top node needs to be selected. Click on the Next button
    ([Figure 5-20](#selecting_the_necessary_fields_from_the)).
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 选择所有用于服务的元素的复选框。我们需要所有这些，因此只需选择顶级节点。点击下一步按钮（[图 5-20](#selecting_the_necessary_fields_from_the)）。
- en: '![Selecting the necessary fields from the FM export](assets/pdss_0520.png)'
  id: totrans-106
  prefs: []
  type: TYPE_IMG
  zh: '![从FM导出中选择必要字段](assets/pdss_0520.png)'
- en: Figure 5-20\. Selecting the necessary fields from the FM export
  id: totrans-107
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-20\. 从功能模块导出中选择必要字段
- en: Identify what the key fields are for the structure, then click on the Finish
    button ([Figure 5-21](#identifying_the_keys_for_the_model)). The key fields are
    the unique fields for your structure—in this case, the sales order (VBELN) and
    the sales order item (POSNR). In an SAP system there will never be the same sales
    order number for the same sales order item.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 确定结构的关键字段，然后点击完成按钮（[图 5-21](#identifying_the_keys_for_the_model)）。关键字段是结构的唯一字段，在这种情况下是销售订单（VBELN）和销售订单项目（POSNR）。在SAP系统中，同一销售订单项目永远不会有相同的销售订单号。
- en: '![Identifying the keys for the model](assets/pdss_0521.png)'
  id: totrans-109
  prefs: []
  type: TYPE_IMG
  zh: '![确定模型的关键字段](assets/pdss_0521.png)'
- en: Figure 5-21\. Identifying the keys for the model
  id: totrans-110
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-21\. 确定模型的关键字段
- en: Open the project folders Data Model → Entity Types → SalesOrder and click on
    the Properties folder. Add some meaningful names (as shown in [Figure 5-22](#giving_the_entity_meaningful_names)
    to the service in the Name column and identify any values that can be Null by
    clicking in the checkbox in the Nullable column. When finished click on the Generate
    Runtime Objects button.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 打开项目文件夹 数据模型 → 实体类型 → 销售订单，并单击属性文件夹。在名称列中为服务添加一些有意义的名称（如 [图 5-22](#giving_the_entity_meaningful_names)
    所示），并通过点击复选框确定可以为空的任何值。完成后，点击生成运行时对象按钮。
- en: '![Giving the Entity meaningful names](assets/pdss_0522.png)'
  id: totrans-112
  prefs: []
  type: TYPE_IMG
  zh: '![为实体命名](assets/pdss_0522.png)'
- en: Figure 5-22\. Giving the entity meaningful names
  id: totrans-113
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-22\. 给实体赋予有意义的名称
- en: Accept the default values for the objects about to be generated. Click on the
    Enter button ([Figure 5-23](#generating_the_model_and_service_definit)).
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 接受即将生成的对象的默认值。点击 Enter 按钮 ([图 5-23](#generating_the_model_and_service_definit))。
- en: '![Generating the model and service definition](assets/pdss_0523.png)'
  id: totrans-115
  prefs: []
  type: TYPE_IMG
  zh: '![生成模型和服务定义](assets/pdss_0523.png)'
- en: Figure 5-23\. Generating the model and service definition
  id: totrans-116
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-23\. 生成模型和服务定义
- en: Again, assign this to a transport if necessary in pop-up dialog. Click on the
    Save button ([Figure 5-24](#selecting_a_package_for_the_gateway_proj)).
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 在弹出对话框中，如有必要，再次分配到传输。点击保存按钮 ([图 5-24](#selecting_a_package_for_the_gateway_proj))。
- en: '![Selecting a package for the gateway project](assets/pdss_0524.png)'
  id: totrans-118
  prefs: []
  type: TYPE_IMG
  zh: '![为网关项目选择一个包](assets/pdss_0524.png)'
- en: Figure 5-24\. Selecting a package for the gateway project
  id: totrans-119
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-24\. 选择网关项目包
- en: Open the project folders Service Implementation → SalesorderSet and right-click
    on the GetEntitySet (Query) line ([Figure 5-25](#mapping_the_gateway_to_the_data_source)).
    Select the Map to Data Source option, as shown in [Figure 5-26](#selecting_the_map_to_source_option).
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 打开项目文件夹 服务实现 → SalesorderSet，并右键单击 GetEntitySet（查询）行 ([图 5-25](#mapping_the_gateway_to_the_data_source))。选择映射到数据源选项，如图 5-26
    ([图 5-26](#selecting_the_map_to_source_option)) 所示。
- en: '![Mapping the gateway to the data source](assets/pdss_0525.png)'
  id: totrans-121
  prefs: []
  type: TYPE_IMG
  zh: '![映射网关到数据源](assets/pdss_0525.png)'
- en: Figure 5-25\. Mapping the gateway to the data source
  id: totrans-122
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-25\. 将网关映射到数据源
- en: '![Selecting the map to source option](assets/pdss_0526.png)'
  id: totrans-123
  prefs: []
  type: TYPE_IMG
  zh: '![选择映射到源选项](assets/pdss_0526.png)'
- en: Figure 5-26\. Selecting the Map to Data Source option
  id: totrans-124
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-26\. 选择映射到数据源选项
- en: This will give the mapping option for our service and the backend function.
    Identify the Target System of the function module, the Type, and the Name. Press
    the Enter button ([Figure 5-27](#identifying_the_source_function_module)).
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 这将为我们的服务和后端函数提供映射选项。确定函数模块的目标系统、类型和名称。按下 Enter 键 ([图 5-27](#identifying_the_source_function_module))。
- en: '![Identifying the source function module](assets/pdss_0527.png)'
  id: totrans-126
  prefs: []
  type: TYPE_IMG
  zh: '![标识源函数模块](assets/pdss_0527.png)'
- en: Figure 5-27\. Identifying the source function module
  id: totrans-127
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-27\. 标识源函数模块
- en: Map each field from the function module to the field in the service. If you’ve
    defined the function with common parameter types, you can make your life easier
    and click Propose Mapping ([Figure 5-28](#mapping_using_the_propose_mapping_option)).
    In this example, that works well.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 将每个函数模块字段映射到服务字段。如果您使用常见的参数类型定义函数，您可以更轻松地点击建议映射 ([图 5-28](#mapping_using_the_propose_mapping_option))。在这个示例中，效果很好。
- en: '![Mapping using the propose mapping option](assets/pdss_0528.png)'
  id: totrans-129
  prefs: []
  type: TYPE_IMG
  zh: '![使用建议映射选项进行映射](assets/pdss_0528.png)'
- en: Figure 5-28\. Mapping using the propose mapping option
  id: totrans-130
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-28\. 使用建议映射选项进行映射
- en: When finished click on the Generate Runtime Objects button ([Figure 5-29](#node_for_the_service_maintenance)).
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 完成后，点击生成运行时对象按钮 ([图 5-29](#node_for_the_service_maintenance))。
- en: Open the Service Maintenance folder, right-click on the hub to be used, and
    select Register ([Figure 5-30](#selecting_to_register_the_gateway_compon)).
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 打开服务维护文件夹，右键单击要使用的中心，并选择注册 ([图 5-30](#selecting_to_register_the_gateway_compon))。
- en: '![Node for the service maintenance](assets/pdss_0529.png)'
  id: totrans-133
  prefs: []
  type: TYPE_IMG
  zh: '![服务维护的节点](assets/pdss_0529.png)'
- en: Figure 5-29\. Node for the service maintenance
  id: totrans-134
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-29\. 服务维护的节点
- en: '![Selecting to register the gateway components](assets/pdss_0530.png)'
  id: totrans-135
  prefs: []
  type: TYPE_IMG
  zh: '![选择注册网关组件](assets/pdss_0530.png)'
- en: Figure 5-30\. Selecting to register the gateway components
  id: totrans-136
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-30\. 选择注册网关组件
- en: Select the system alias and then click on the Enter button ([Figure 5-31](#identifying_a_system_alias_for_the_gatew)).
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 选择系统别名，然后点击 Enter 按钮 ([图 5-31](#identifying_a_system_alias_for_the_gatew))。
- en: '![Identifying a system alias for the gateway service](assets/pdss_0531.png)'
  id: totrans-138
  prefs: []
  type: TYPE_IMG
  zh: '![为网关服务标识系统别名](assets/pdss_0531.png)'
- en: Figure 5-31\. Identifying a system alias for the gateway service
  id: totrans-139
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-31\. 为网关服务标识系统别名
- en: The system will now register the service. Accept the default entries, assign
    a package, and then click on the Enter button ([Figure 5-32](#generating_and_activating_gateway_servic)).
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 系统现在将注册服务。接受默认条目，分配一个包，并点击“输入”按钮（[图 5-32](#generating_and_activating_gateway_servic)）。
- en: '![Generating and activating gateway services and components](assets/pdss_0532.png)'
  id: totrans-141
  prefs: []
  type: TYPE_IMG
  zh: '![生成和激活网关服务和组件](assets/pdss_0532.png)'
- en: Figure 5-32\. Generating and activating gateway services and components
  id: totrans-142
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-32\. 生成和激活网关服务和组件
- en: Note
  id: totrans-143
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 注意
- en: If you do not have a hub under the Service Maintenance folder then your system
    is not properly configured. Refer to your Basis Administration for help doing
    this. There are some excellent blogs at [blogs.sap.com](http://blogs.sap.com)
    that walk through this very well.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在服务维护文件夹下没有中心，则系统配置不正确。请参考您的基础管理部门以获取帮助。在[blogs.sap.com](http://blogs.sap.com)有一些非常好的博客可供参考。
- en: Let’s test this and see if it works. Right-click on the hub again but this time
    select Maintain ([Figure 5-33](#maintaining_the_gateway_service)).
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们测试一下，看看是否有效。再次右键单击中心，但这次选择维护（[图 5-33](#maintaining_the_gateway_service)）。
- en: '![Maintaining the gateway service](assets/pdss_0533.png)'
  id: totrans-146
  prefs: []
  type: TYPE_IMG
  zh: '![维护网关服务](assets/pdss_0533.png)'
- en: Figure 5-33\. Maintaining the gateway service
  id: totrans-147
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-33\. 维护网关服务
- en: The service is displayed with some additional functionality. It is easiest to
    call the service in a browser so click on the Call Browser button ([Figure 5-34](#testing_the_gateway_service_in_the_brows)).
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 显示了带有一些额外功能的服务。最简单的方式是在浏览器中调用服务，所以点击“调用浏览器”按钮（[图 5-34](#testing_the_gateway_service_in_the_brows)）。
- en: '![Testing the gateway service in the browser](assets/pdss_0534.png)'
  id: totrans-149
  prefs: []
  type: TYPE_IMG
  zh: '![在浏览器中测试网关服务](assets/pdss_0534.png)'
- en: Figure 5-34\. Testing the gateway service in the browser
  id: totrans-150
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-34\. 在浏览器中测试网关服务
- en: 'The default browser opens with the service and entity sets displayed:'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 默认浏览器打开服务和实体集：
- en: '[PRE1]'
  id: totrans-152
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'To try the actual entityset and function module, copy out the entityset name
    (in our case, `SalesOrderSet`) and put it at the end of the URL between the `/`
    and `?`. For our example, this URL would work:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 要尝试实际的实体集和功能模块，请复制实体集名称（在我们的情况下为`SalesOrderSet`），并将其放在 URL 的`/`和`?`之间。对于我们的示例，此
    URL 将起作用：
- en: '[PRE2]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'And would produce an output like this:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 并将生成如下输出：
- en: '[PRE3]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Now that we know our data feed is working, we can move onto reading with SSIS
    and putting it into SQL. For high volume and frequently accessed analytical data,
    storing it in an intermediate SQL database can save the SAP system from memory
    errors. At lower volumes or occasionally accessed frequencies, this could work
    just fine as an OData service read directly from PowerBI. The right answer for
    your environment will vary.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们知道我们的数据源正在工作，我们可以继续使用 SSIS 进行读取并将其放入 SQL 中。对于高容量和频繁访问的分析数据，将其存储在中间 SQL 数据库中可以避免
    SAP 系统的内存错误。对于低容量或偶尔访问频率，直接从 PowerBI 读取作为 OData 服务可能效果也不错。您的环境的正确答案将有所不同。
- en: The first step is to define a database structure. This is easy since we can
    query the metadata of our service by adding `**/$metadata/**` to the end of the
    service URL. Like this…
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 第一步是定义数据库结构。这很容易，因为我们可以通过在服务网址末尾添加`**/$metadata/**`来查询我们服务的元数据。就像这样…
- en: '[PRE4]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'The <entitytype> tag will have all the data definitions necessary for us to
    create the SQL database:'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: '`<entitytype>` 标签将包含我们创建 SQL 数据库所需的所有数据定义：'
- en: '[PRE5]'
  id: totrans-161
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Note
  id: totrans-162
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 注意
- en: To do the next steps you will need SQL, SQL Server Management Studio, and Microsoft
    Visual Studio Community. If you don’t currently have a SQL Server we recommend
    playing with SQL Express^([4](ch05.html#ch05fn4)) first. There are many good tutorials
    on the installation process.^([5](ch05.html#ch05fn5)) If you haven’t had fun with
    SQL Server Management Studio, you’re about to. Install SQL Server Management Studio^([6](ch05.html#ch05fn6))
    and connect it to your SQL Express.^([7](ch05.html#ch05fn7)) Finally, if you have
    not used Visual Studio Community, we envy you. It’s like telling a friend about
    a wonderful movie that you wish you could watch again for the first time. Download
    Visual Studio Community^([8](ch05.html#ch05fn8)) and install it. If you haven’t
    used any of these tools it may seem at first daunting, but trust us, these are
    powerful and fun tools that will change how you look at data and analytics. Dive
    in, don’t look back, have fun.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 要执行接下来的步骤，您需要 SQL、SQL Server Management Studio 和 Microsoft Visual Studio Community。如果您还没有
    SQL Server，建议先使用 SQL Express^([4](ch05.html#ch05fn4))。安装过程有很多好的教程^([5](ch05.html#ch05fn5))。如果您还没有使用过
    SQL Server Management Studio，现在就开始吧。安装 SQL Server Management Studio^([6](ch05.html#ch05fn6))
    并连接到您的 SQL Express^([7](ch05.html#ch05fn7))。最后，如果您还没有使用过 Visual Studio Community，我们羡慕您。这就像告诉朋友一部精彩电影，希望自己能够再次第一次观看。下载
    Visual Studio Community^([8](ch05.html#ch05fn8)) 并安装它。如果您还没有使用这些工具，起初可能会感到有些困难，但请相信，这些是强大且有趣的工具，将改变您对数据和分析的看法。勇敢地去探索，不要回头，享受其中的乐趣。
- en: SQL Server
  id: totrans-164
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: SQL Server
- en: Before we build our database, let’s talk about what we intend to do. We want
    to load from our backend system in the simplest and easiest way possible. To do
    this we will load all data first into a Repository table. The data types of this
    repository will be simple Unicode strings. Then the data moves to a staging table
    where the data definitions are more precise. Upon successful completion of this,
    the data will be then loaded into the final mart table using an Upsert command.
    This will insert any new records and overwrite any existing records based on the
    keys we define (which will be Sales Order and Line Item).
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们建立数据库之前，让我们谈谈我们的意图。我们希望以最简单和最轻松的方式从我们的后端系统加载数据。为此，我们首先将所有数据加载到一个仓库表中。该仓库的数据类型将是简单的
    Unicode 字符串。然后数据移动到一个分段表中，其中数据定义更加精确。成功完成后，数据将使用 Upsert 命令加载到最终的市场表中。这将根据我们定义的键（销售订单和行项目）插入任何新记录，并覆盖任何现有记录。
- en: '![Data flow for storing data in SQL](assets/pdss_0535.png)'
  id: totrans-166
  prefs: []
  type: TYPE_IMG
  zh: '![存储数据在 SQL 中的数据流](assets/pdss_0535.png)'
- en: Figure 5-35\. Data flow for storing data in SQL
  id: totrans-167
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-35\. 数据流程用于在 SQL 中存储数据
- en: Open SQL Server Management Studio, enter your Server Name and your credentials,
    and click on the Connect button ([Figure 5-36](#connecting_to_your_server)).
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 打开 SQL Server Management Studio，输入服务器名称和您的凭据，然后单击“连接”按钮（[图5-36](#connecting_to_your_server)）。
- en: '![Connecting to your server](assets/pdss_0536.png)'
  id: totrans-169
  prefs: []
  type: TYPE_IMG
  zh: '![连接到您的服务器](assets/pdss_0536.png)'
- en: Figure 5-36\. Connecting to your server
  id: totrans-170
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-36\. 连接到您的服务器
- en: Right-click on the Databases folder ([Figure 5-37](#sql_hierarchy)) and select
    New Database ([Figure 5-38](#creating_a_new_database)).
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 右键单击“数据库”文件夹（[图5-37](#sql_hierarchy)）并选择“新建数据库”（[图5-38](#creating_a_new_database)）。
- en: '![SQL hierarchy](assets/pdss_0537.png)'
  id: totrans-172
  prefs: []
  type: TYPE_IMG
  zh: '![SQL 层次结构](assets/pdss_0537.png)'
- en: Figure 5-37\. SQL hierarchy
  id: totrans-173
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-37\. SQL 层次结构
- en: '![Creating a new database](assets/pdss_0538.png)'
  id: totrans-174
  prefs: []
  type: TYPE_IMG
  zh: '![创建新数据库](assets/pdss_0538.png)'
- en: Figure 5-38\. Creating a new database
  id: totrans-175
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-38\. 创建新数据库
- en: Enter a Database name and click on the OK button ([Figure 5-39](#entering_a_sql_database_name)).
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 输入数据库名称并单击“确定”按钮（[图5-39](#entering_a_sql_database_name)）。
- en: '![Entering a SQL database name](assets/pdss_0539.png)'
  id: totrans-177
  prefs: []
  type: TYPE_IMG
  zh: '![输入 SQL 数据库名称](assets/pdss_0539.png)'
- en: Figure 5-39\. Entering a SQL database name
  id: totrans-178
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-39\. 输入 SQL 数据库名称
- en: Click on the newly created database and then right-click on the Tables folder.
    Select New → Table ([Figure 5-40](#creating_a_new_sql_table)).
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 点击新创建的数据库，然后右键单击“表”文件夹。选择“新建 → 表”（[图5-40](#creating_a_new_sql_table)）。
- en: '![Creating a new SQL table](assets/pdss_0540.png)'
  id: totrans-180
  prefs: []
  type: TYPE_IMG
  zh: '![创建新的 SQL 表](assets/pdss_0540.png)'
- en: Figure 5-40\. Creating a new SQL table
  id: totrans-181
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-40\. 创建新的 SQL 表
- en: Enter the details of the table using Unicode Data Types with an ample length
    ([Figure 5-41](#entering_the_sql_table_variables)).
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Unicode 数据类型和充足长度输入表的详细信息（[图5-41](#entering_the_sql_table_variables)）。
- en: '![Entering the SQL table variables](assets/pdss_0541.png)'
  id: totrans-183
  prefs: []
  type: TYPE_IMG
  zh: '![输入 SQL 表变量](assets/pdss_0541.png)'
- en: Figure 5-41\. Entering the SQL table variables
  id: totrans-184
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-41\. 输入 SQL 表变量
- en: Click on the Save button.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“保存”按钮。
- en: Enter the name of the table denoting in some way that it is the repository table.
    Click on the OK button ([Figure 5-42](#naming_the_sql_table_for_repo)).
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 输入表的名称，表示它是存储库表。点击“OK”按钮（[图 5-42](#naming_the_sql_table_for_repo)）。
- en: '![Naming the SQL table for repo](assets/pdss_0542.png)'
  id: totrans-187
  prefs: []
  type: TYPE_IMG
  zh: '![为repo命名SQL表](assets/pdss_0542.png)'
- en: Figure 5-42\. Naming the SQL table for repo
  id: totrans-188
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-42\. 为repo命名SQL表
- en: Repeat the process and create another table but this time with the types accurately
    defined, as shown in [Figure 5-43](#identifying_the_sql_variables_for_stage).
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 重复此过程，创建另一个表，但这次确保类型准确定义，如[图 5-43](#identifying_the_sql_variables_for_stage)所示。
- en: '![Identifying the SQL variables for stage](assets/pdss_0543.png)'
  id: totrans-190
  prefs: []
  type: TYPE_IMG
  zh: '![为阶段标识SQL变量](assets/pdss_0543.png)'
- en: Figure 5-43\. Identifying the SQL variables for stage
  id: totrans-191
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-43\. 为阶段标识SQL变量
- en: Click on the Save button.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“保存”按钮。
- en: Enter the name of the table denoting in some way that it is the stage table.
    Click on the OK button ([Figure 5-44](#naming_the_sql_table_for_stage)).
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 输入表的名称，表示它是阶段表。点击“OK”按钮（[图 5-44](#naming_the_sql_table_for_stage)）。
- en: '![Naming the SQL table for stage](assets/pdss_0544.png)'
  id: totrans-194
  prefs: []
  type: TYPE_IMG
  zh: '![为阶段命名SQL表](assets/pdss_0544.png)'
- en: Figure 5-44\. Naming the SQL table for stage
  id: totrans-195
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-44\. 为阶段命名SQL表
- en: Repeat the process again exactly as was done for the stage table but denote
    this one as the mart table ([Figure 5-45](#entering_the_sql_table_name_for_mart)).
    This will be the location from which we read into PowerBI.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 重复与阶段表相同的过程，但将其标记为mart表（[图 5-45](#entering_the_sql_table_name_for_mart)）。这将是我们从中读取数据进入PowerBI的位置。
- en: '![Entering the SQL table name for mart](assets/pdss_0545.png)'
  id: totrans-197
  prefs: []
  type: TYPE_IMG
  zh: '![输入mart的SQL表名](assets/pdss_0545.png)'
- en: Figure 5-45\. Entering the SQL table name for mart
  id: totrans-198
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-45\. 输入mart的SQL表名
- en: Now that our database is ready, we need to create the operation that will load
    the data from SAP into it.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们的数据库已经准备好，我们需要创建操作，从SAP加载数据到其中。
- en: SQL Server Integration Services (SSIS)
  id: totrans-200
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: SQL Server Integration Services（SSIS）
- en: First, let’s open Visual Studio Community.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，让我们打开Visual Studio Community。
- en: Follow the menu path File → New → Project ([Figure 5-46](#creating_a_new_ssis_project)).
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 按照菜单路径“文件 → 新建 → 项目”（[图 5-46](#creating_a_new_ssis_project)）。
- en: '![Creating a new SSIS project](assets/pdss_0546.png)'
  id: totrans-203
  prefs: []
  type: TYPE_IMG
  zh: '![创建新的SSIS项目](assets/pdss_0546.png)'
- en: Figure 5-46\. Creating a new SSIS project
  id: totrans-204
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-46\. 创建新的SSIS项目
- en: 'Here are the steps you’ll need to follow ([Figure 5-47](#steps_for_starting_an_integration_servic)):'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是您需要按照的步骤（[图 5-47](#steps_for_starting_an_integration_servic)）：
- en: Open the folder Business Intelligence.
  id: totrans-206
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开“Business Intelligence”文件夹。
- en: Click on Integration Services.
  id: totrans-207
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击“Integration Services”。
- en: In the righthand panel, right-click on Integration Services Project.
  id: totrans-208
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在右侧面板上，右键单击“Integration Services Project”。
- en: Enter a Name for the project.
  id: totrans-209
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 输入项目名称。
- en: Click on the OK button.
  id: totrans-210
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击“OK”按钮。
- en: '![Steps for starting an Integration Services project](assets/pdss_0547.png)'
  id: totrans-211
  prefs: []
  type: TYPE_IMG
  zh: '![启动Integration Services项目的步骤](assets/pdss_0547.png)'
- en: Figure 5-47\. Steps for starting an Integration Services project
  id: totrans-212
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-47\. 启动Integration Services项目的步骤
- en: In the Solution Manager panel, right-click on Connection Manager and select
    New Connection. This is where we will define our connection to the OData model
    we have from SAP. The connection manager has by default an OData option ([Figure 5-48](#adding_a_new_connection_in_ssis)).
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 在“Solution Manager”面板中，右键单击“Connection Manager”，然后选择“New Connection”。这是我们将定义到SAP的OData模型的连接位置。连接管理器默认具有一个ODATA选项（[图
    5-48](#adding_a_new_connection_in_ssis)）。
- en: '![Adding a new connection in SSIS](assets/pdss_0548.png)'
  id: totrans-214
  prefs: []
  type: TYPE_IMG
  zh: '![在SSIS中添加新连接](assets/pdss_0548.png)'
- en: Figure 5-48\. Adding a new connection in SSIS
  id: totrans-215
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-48\. 在SSIS中添加新连接
- en: 'Select the type of connection we will be reading from the NWG (NetWeaver Gateway).
    This is an OData connection; therefore, click on ODATA and then click the Add
    button. Then follow these steps ([Figure 5-49](#connection_settings_in_ssis_for_sap_gate)):'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 选择我们将从NWG（NetWeaver Gateway）读取的连接类型。这是一个OData连接；因此，点击ODATA，然后点击“添加”按钮。然后按照以下步骤操作（[图
    5-49](#connection_settings_in_ssis_for_sap_gate)）：
- en: Enter a meaningful Connection manager name.
  id: totrans-217
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 输入一个有意义的连接管理器名称。
- en: Enter the Service document location, which is the URL to our NWG data feed.
    Make sure to use the service and not the collection.
  id: totrans-218
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 输入服务文档位置，即我们从SAP获取的NWG数据源的URL。确保使用服务而不是集合。
- en: Change the Authentication Type to Basic Authentication.
  id: totrans-219
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将身份验证类型更改为基本身份验证。
- en: Enter an authorized User name.
  id: totrans-220
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 输入授权用户名。
- en: Enter the Password.
  id: totrans-221
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 输入密码。
- en: '![Connection settings in SSIS for SAP Gateway service](assets/pdss_0549.png)'
  id: totrans-222
  prefs: []
  type: TYPE_IMG
  zh: '![在SSIS中的SAP网关服务连接设置](assets/pdss_0549.png)'
- en: Figure 5-49\. Connection settings in SSIS for SAP Gateway service
  id: totrans-223
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-49 图。SAP 网关服务的 SSIS 连接设置
- en: Click on the Test Connection button to make sure the settings are all correct.
    You should then see the dialog box shown in [Figure 5-50](#testing_the_connection_from_ssis_to_sap).
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“测试连接”按钮以确保所有设置都正确。然后您应该会看到显示在 [图 5-50](#testing_the_connection_from_ssis_to_sap)
    中的对话框。
- en: '![Testing the connection from SSIS to SAP](assets/pdss_0550.png)'
  id: totrans-225
  prefs: []
  type: TYPE_IMG
  zh: '![从 SSIS 到 SAP 的连接测试](assets/pdss_0550.png)'
- en: Figure 5-50\. Testing the connection from SSIS to SAP
  id: totrans-226
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-50 图。从 SSIS 到 SAP 的连接测试
- en: Click on the OK button and then click on OK again to save the connection. Next
    we need to define the workflow for the reading process. Click on the Data Flow
    Task in the SSIS Toolbox and drag it to the Control Flow panel ([Figure 5-51](#creating_a_data_flow_task)).
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“确定”按钮，然后再次点击“确定”以保存连接。接下来，我们需要定义读取过程的工作流程。在 SSIS 工具箱中点击“数据流任务”，并将其拖到控制流面板上（[图 5-51](#creating_a_data_flow_task)）。
- en: '![Creating a data flow task](assets/pdss_0551.png)'
  id: totrans-228
  prefs: []
  type: TYPE_IMG
  zh: '![创建数据流任务](assets/pdss_0551.png)'
- en: Figure 5-51\. Creating a data flow task
  id: totrans-229
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-51 图。创建数据流任务
- en: Rename the data flow task ([Figure 5-52](#rename_the_data_flow_task)).
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 重命名数据流任务（[图 5-52](#rename_the_data_flow_task)）。
- en: '![Rename the data flow task](assets/pdss_0552.png)'
  id: totrans-231
  prefs: []
  type: TYPE_IMG
  zh: '![重命名数据流任务](assets/pdss_0552.png)'
- en: Figure 5-52\. Rename the data flow task
  id: totrans-232
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-52 图。重命名数据流任务
- en: Double-click on the data flow task to navigate to the Control Flow or click
    on the Control Flow tab. Drag a OData Source component from the Common section.
    Rename it something meaningful ([Figure 5-53](#creating_an_odata_source_connection_with)).
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 双击数据流任务以导航到控制流或点击控制流选项卡。从公共部分拖动一个 OData 源组件。将其重命名为有意义的名称（[图 5-53](#creating_an_odata_source_connection_with)）。
- en: '![Creating an OData source connection within the data flow](assets/pdss_0553.png)'
  id: totrans-234
  prefs: []
  type: TYPE_IMG
  zh: '![在数据流中创建 OData 源连接](assets/pdss_0553.png)'
- en: Figure 5-53\. Creating an OData source connection within the data flow
  id: totrans-235
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-53 图。在数据流中创建 OData 源连接
- en: Double-click on the OData Component.
  id: totrans-236
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 双击 OData 组件。
- en: Select the connection created earlier.
  id: totrans-237
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择之前创建的连接。
- en: The collections or entity sets from the NWG service will display.
  id: totrans-238
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: NWG 服务的集合或实体集将显示。
- en: Click on the Preview button ([Figure 5-54](#odata_source_settings_for_the_sap_connec)).
  id: totrans-239
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击“预览”按钮（[图 5-54](#odata_source_settings_for_the_sap_connec)）。
- en: '![OData source settings for the SAP connection](assets/pdss_0554.png)'
  id: totrans-240
  prefs: []
  type: TYPE_IMG
  zh: '![SAP 连接的 OData 源设置](assets/pdss_0554.png)'
- en: Figure 5-54\. OData source settings for the SAP connection
  id: totrans-241
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-54 图。SAP 连接的 OData 源设置
- en: A small preview will display ([Figure 5-55](#previewing_the_data_coming_from_sap_in_s)).
    If things look good, close the preview window and click on the OK button.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 将显示一个小预览（[图 5-55](#previewing_the_data_coming_from_sap_in_s)）。如果一切正常，关闭预览窗口并点击“确定”按钮。
- en: '![Previewing the data coming from SAP in SSIS](assets/pdss_0555.png)'
  id: totrans-243
  prefs: []
  type: TYPE_IMG
  zh: '![在 SSIS 中预览来自 SAP 的数据](assets/pdss_0555.png)'
- en: Figure 5-55\. Previewing the data coming from SAP in SSIS
  id: totrans-244
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-55 图。在 SSIS 中预览来自 SAP 的数据
- en: We can read the data from SAP, and now we need to put it in the SQL database
    we created earlier.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以从 SAP 读取数据，现在我们需要将其放入我们之前创建的 SQL 数据库中。
- en: In the Solution Manager panel, right-click on Connection Managers and select
    New Connection Manager ([Figure 5-56](#adding_a_connection_to_sql_from_ssis)).
    This is where we will define our connection to SQL Database.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 在解决方案管理器面板中，右键单击连接管理器，选择“新建连接管理器”（[图 5-56](#adding_a_connection_to_sql_from_ssis)）。这是我们将定义到
    SQL 数据库的连接的地方。
- en: '![Adding a connection to SQL from SSIS](assets/pdss_0556.png)'
  id: totrans-247
  prefs: []
  type: TYPE_IMG
  zh: '![从 SSIS 添加到 SQL 的连接](assets/pdss_0556.png)'
- en: Figure 5-56\. Adding a connection to SQL from SSIS
  id: totrans-248
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-56 图。从 SSIS 添加到 SQL 的连接
- en: Select OLEDB from the list and then click the Add button ([Figure 5-57](#selecting_the_oledb_connection_type_for)).
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: 从列表中选择 OLEDB，然后点击“添加”按钮（[图 5-57](#selecting_the_oledb_connection_type_for)）。
- en: '![Selecting the OLEDB connection type for SQL](assets/pdss_0557.png)'
  id: totrans-250
  prefs: []
  type: TYPE_IMG
  zh: '![选择 SQL 的 OLEDB 连接类型](assets/pdss_0557.png)'
- en: Figure 5-57\. Selecting the OLEDB connection type for SQL
  id: totrans-251
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-57 图。选择 SQL 的 OLEDB 连接类型
- en: Click on the New button. Enter the SQL Server name, Authentication, and Database
    name. Then click on the Test Connection button ([Figure 5-58](#sql_database_connection_settings_in_ssis)).
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“新建”按钮。输入 SQL Server 名称、认证和数据库名称。然后点击“测试连接”按钮（[图 5-58](#sql_database_connection_settings_in_ssis)）。
- en: '![SQL database connection settings in SSIS](assets/pdss_0558.png)'
  id: totrans-253
  prefs: []
  type: TYPE_IMG
  zh: '![SSIS 中的 SQL 数据库连接设置](assets/pdss_0558.png)'
- en: Figure 5-58\. SQL database connection settings in SSIS
  id: totrans-254
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-58 图。SSIS 中的 SQL 数据库连接设置
- en: If all is successful a positive test will result ([Figure 5-59](#testing_the_connection_to_sql)).
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一切顺利，测试结果将是积极的（[图 5-59](#testing_the_connection_to_sql)）。
- en: '![Testing the connection to SQL](assets/pdss_0559.png)'
  id: totrans-256
  prefs: []
  type: TYPE_IMG
  zh: '![测试连接到 SQL](assets/pdss_0559.png)'
- en: Figure 5-59\. Testing the connection to SQL
  id: totrans-257
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-59 图。测试连接到 SQL
- en: Click on the OK button three times to save.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 点击三次确定按钮以保存。
- en: The Connection Managers pane now shows both of the connections we created ([Figure 5-60](#the_connections_to_the_different_systems)).
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 连接管理器窗格现在显示我们创建的两个连接（[图 5-60](#the_connections_to_the_different_systems)）。
- en: '![The connections to the different systems in SSIS](assets/pdss_0560.png)'
  id: totrans-260
  prefs: []
  type: TYPE_IMG
  zh: '![连接到不同系统的连接](assets/pdss_0560.png)'
- en: Figure 5-60\. The connections to the different systems in SSIS
  id: totrans-261
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-60 图。连接到不同系统的连接
- en: The next step is to connect the SAP connection to the SQL connection. Select
    the OLE DB Destination component and drag it into the Data Flow tab. Give it a
    meaningful name ([Figure 5-61](#creating_a_ole_db_destination_in_ssis)).
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 下一步是将 SAP 连接到 SQL 连接。选择 OLE DB 目标组件并将其拖入数据流选项卡中。给它起一个有意义的名称（[图 5-61](#creating_a_ole_db_destination_in_ssis)）。
- en: '![Creating a OLE DB Destination in SSIS](assets/pdss_0561.png)'
  id: totrans-263
  prefs: []
  type: TYPE_IMG
  zh: '![在 SSIS 中创建 OLE DB 目标](assets/pdss_0561.png)'
- en: Figure 5-61\. Creating a OLE DB Destination in SSIS
  id: totrans-264
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-61 图。在 SSIS 中创建 OLE DB 目标
- en: Connect the SAP component to the SQL component with the blue arrow ([Figure 5-62](#connecting_sap_and_sql_in_ssis)).
    The red arrow is for errors.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 用蓝色箭头将 SAP 组件连接到 SQL 组件（[图 5-62](#connecting_sap_and_sql_in_ssis)）。红色箭头表示错误。
- en: '![Connecting SAP and SQL in SSIS](assets/pdss_0562.png)'
  id: totrans-266
  prefs: []
  type: TYPE_IMG
  zh: '![在 SSIS 中连接 SAP 和 SQL](assets/pdss_0562.png)'
- en: Figure 5-62\. Connecting SAP and SQL in SSIS
  id: totrans-267
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-62 图。在 SSIS 中连接 SAP 和 SQL
- en: Double-click on the SQL component. It will automatically connect to the SQL
    connection as there is only one. If there is more than one option select the appropriate
    one from the OLE DB connection manager. Select the repository table from the SQL
    database ([Figure 5-63](#connecting_to_a_specific_sql_database_ta)).
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 双击 SQL 组件。它会自动连接到 SQL 连接，因为只有一个选项。如果有多个选项，请从 OLE DB 连接管理器中选择适当的选项。从 SQL 数据库中选择存储库表（[图
    5-63](#connecting_to_a_specific_sql_database_ta)）。
- en: '![Connecting to a specific SQL database table](assets/pdss_0563.png)'
  id: totrans-269
  prefs: []
  type: TYPE_IMG
  zh: '![连接到特定的 SQL 数据库表](assets/pdss_0563.png)'
- en: Figure 5-63\. Connecting to a specific SQL database table
  id: totrans-270
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-63 图。连接到特定的 SQL 数据库表
- en: Click on the Mappings option on the left. If the names are the same in the database
    as they are in the SAP feed then the entries will map automatically. If they are
    not, map them manually. Then click on the OK button ([Figure 5-64](#mapping_from_sap_source_to_sql_database)).
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 点击左侧的映射选项。如果数据库中的名称与 SAP 提供的名称相同，则条目将自动映射。如果不同，请手动映射。然后点击确定按钮（[图 5-64](#mapping_from_sap_source_to_sql_database)）。
- en: '![Mapping from SAP source to SQL database destination](assets/pdss_0564.png)'
  id: totrans-272
  prefs: []
  type: TYPE_IMG
  zh: '![从 SAP 源映射到 SQL 数据库目标](assets/pdss_0564.png)'
- en: Figure 5-64\. Mapping from SAP source to SQL database destination
  id: totrans-273
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-64 图。从 SAP 源映射到 SQL 数据库目标
- en: The data flow should now show no errors ([Figure 5-65](#no_errors_present_in_current_mapping)).
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 数据流现在应该不显示任何错误（[图 5-65](#no_errors_present_in_current_mapping)）。
- en: '![No errors present in current mapping](assets/pdss_0565.png)'
  id: totrans-275
  prefs: []
  type: TYPE_IMG
  zh: '![当前映射中没有错误](assets/pdss_0565.png)'
- en: Figure 5-65\. No errors present in current mapping
  id: totrans-276
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-65 图。当前映射中没有错误
- en: Click on the Save button and then click on the Start button to test the process.
    When it is complete there will be two green checkmarks (one for the successful
    reading from SAP and one for the successful writing to the SQL repository table),
    as shown in [Figure 5-66](#executing_the_sap_to_sql_database_flow_i).
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 点击保存按钮，然后点击开始按钮来测试流程。当完成时，会有两个绿色勾号（一个表示从 SAP 成功读取，一个表示成功写入 SQL 存储库表），如 [图 5-66](#executing_the_sap_to_sql_database_flow_i)
    所示。
- en: '![Executing the SAP to SQL Database flow in SSIS](assets/pdss_0566.png)'
  id: totrans-278
  prefs: []
  type: TYPE_IMG
  zh: '![在 SSIS 中执行 SAP 到 SQL 数据库流](assets/pdss_0566.png)'
- en: Figure 5-66\. Executing the SAP to SQL Database flow in SSIS
  id: totrans-279
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-66 图。在 SSIS 中执行 SAP 到 SQL 数据库流
- en: Let’s make sure that the data is in our database. Open SQL Server Management
    Studio and navigate to the repository table. Right-click on the table and select
    Select Top 1000 Rows from the context menu ([Figure 5-67](#checking_sql_database)).
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: 确保数据存在于我们的数据库中。打开 SQL Server Management Studio 并导航到存储库表。右键单击表并从上下文菜单中选择“选择前
    1000 行”（[图 5-67](#checking_sql_database)）。
- en: '![Checking SQL Database](assets/pdss_0567.png)'
  id: totrans-281
  prefs: []
  type: TYPE_IMG
  zh: '![检查 SQL 数据库](assets/pdss_0567.png)'
- en: Figure 5-67\. Checking SQL Database
  id: totrans-282
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 第 5-67 图。检查 SQL 数据库
- en: The results from SAP are now in the database repository table ([Figure 5-68](#sap_data_is_now_in_sql_via_ssis)).
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，来自 SAP 的结果已经在数据库资源库表中（[图 5-68](#sap_data_is_now_in_sql_via_ssis)）。
- en: '![SAP data is now in SQL via SSIS](assets/pdss_0568.png)'
  id: totrans-284
  prefs: []
  type: TYPE_IMG
  zh: '![通过 SSIS，SAP 数据现在在 SQL 中](assets/pdss_0568.png)'
- en: Figure 5-68\. SAP data is now in SQL via SSIS
  id: totrans-285
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-68\. 通过 SSIS，SAP 数据现在在 SQL 中
- en: Why did we create two more tables? Well, we load simply without rules to the
    repository table. What that means is we will not check if integers are integers,
    dates are dates, or any other validation. Remember our flow from [Figure 5-35](#data_flow_for_storing_data_in_sql).
    If there are data errors, they will be caught when we move to Stage. There is
    little risk of error because we are using large Unicode character strings. Now
    we will move the data from the repository to the stage table.
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么我们要创建另外两个表？我们只是简单地将数据加载到资源库表中而已，不进行任何规则检查。这意味着我们不会检查整数是否为整数，日期是否为日期，或任何其他验证。回想我们在
    [图 5-35](#data_flow_for_storing_data_in_sql) 中的流程。如果有数据错误，它们将在移至阶段时被捕捉到。由于我们使用了大型
    Unicode 字符串，错误风险很小。现在我们将数据从资源库移至阶段表。
- en: In Visual Studio, click on the Stop button to end the test. In the SSIS Toolbox
    drag the Execute SQL Task to the Control Flow tab and give it a meaningful name
    ([Figure 5-69](#creating_an_execute_sql_task_in_ssis)).
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Visual Studio 中，点击“停止”按钮结束测试。在 SSIS 工具箱中，将执行 SQL 任务拖到控制流程选项卡，并为其取一个有意义的名称（[图
    5-69](#creating_an_execute_sql_task_in_ssis)）。
- en: '![Creating an Execute SQL Task in SSIS](assets/pdss_0569.png)'
  id: totrans-288
  prefs: []
  type: TYPE_IMG
  zh: '![在 SSIS 中创建一个执行 SQL 任务](assets/pdss_0569.png)'
- en: Figure 5-69\. Creating an Execute SQL Task in SSIS
  id: totrans-289
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-69\. 在 SSIS 中创建一个执行 SQL 任务
- en: Double-click on the SQL task to bring up the properties. Ensure that the Connection
    is pointed at the SQL Server. Click on the ellipsis button to bring up the SQL
    editor ([Figure 5-70](#opening_the_sql_editor_in_ssis_task)).
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 双击 SQL 任务以打开其属性。确保连接指向 SQL Server。点击省略号按钮以打开 SQL 编辑器（[图 5-70](#opening_the_sql_editor_in_ssis_task)）。
- en: '![Opening the SQL editor in SSIS task](assets/pdss_0570.png)'
  id: totrans-291
  prefs: []
  type: TYPE_IMG
  zh: '![在 SSIS 任务中打开 SQL 编辑器](assets/pdss_0570.png)'
- en: Figure 5-70\. Opening the SQL editor in an SSIS task
  id: totrans-292
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-70\. 在 SSIS 任务中打开 SQL 编辑器
- en: Enter the SQL statement to move all data from the repository table into the
    stage table. Then click on the OK button twice ([Figure 5-71](#sql_code_to_move_data_from_the_repo_tabl)).
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 输入 SQL 语句，将所有数据从资源库表移动到阶段表。然后连续点击两次 OK 按钮（[图 5-71](#sql_code_to_move_data_from_the_repo_tabl)）。
- en: '![SQL code to move data from the repo table to the stage table](assets/pdss_0571.png)'
  id: totrans-294
  prefs: []
  type: TYPE_IMG
  zh: '![从资源库表移动数据到阶段表的 SQL 代码](assets/pdss_0571.png)'
- en: Figure 5-71\. SQL code to move data from the repo table to the stage table
  id: totrans-295
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-71\. 从资源库表移动数据到阶段表的 SQL 代码
- en: Right-click on Execute SQL Task and select Execute Task to test. Upon successful
    completion of this task there will be data in the stage table in the SQL database
    ([Figure 5-72](#executing_the_single_task_in_ssis)).
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 右键单击“执行 SQL 任务”，选择“执行任务”进行测试。任务成功完成后，SQL 数据库的阶段表将包含数据（[图 5-72](#executing_the_single_task_in_ssis)）。
- en: '![Executing the single task in SSIS](assets/pdss_0572.png)'
  id: totrans-297
  prefs: []
  type: TYPE_IMG
  zh: '![在 SSIS 中执行单个任务](assets/pdss_0572.png)'
- en: Figure 5-72\. Executing the single task in SSIS
  id: totrans-298
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-72\. 在 SSIS 中执行单个任务
- en: Finally, we will move the data from stage to mart. Drag another Execute SQL
    Task to the Control Flow tab. Give it a meaningful name ([Figure 5-73](#adding_another_execute_sql_task_to_the_w)).
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们将数据从阶段移至数据仓库。在控制流程选项卡中再次拖动另一个执行 SQL 任务。给它一个有意义的名称（[图 5-73](#adding_another_execute_sql_task_to_the_w)）。
- en: '![Adding another Execute SQL Task to the workflow](assets/pdss_0573.png)'
  id: totrans-300
  prefs: []
  type: TYPE_IMG
  zh: '![在工作流程中添加另一个执行 SQL 任务](assets/pdss_0573.png)'
- en: Figure 5-73\. Adding another Execute SQL Task to the workflow
  id: totrans-301
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-73\. 在工作流程中添加另一个执行 SQL 任务
- en: As we had done for the move from the repository to stage, double-click on the
    SQL task to bring up the properties. Ensure that the Connection is pointed at
    the SQL Server. Click on the ellipsis button to bring up the SQL editor.
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: 就像我们之前从资源库移至阶段的操作一样，双击 SQL 任务以打开其属性。确保连接指向 SQL Server。点击省略号按钮以打开 SQL 编辑器。
- en: The SQL code here is a bit different. It uses a MERGE statement based on the
    sales order and item. If the mart table already has this sales order and item
    it will update it, otherwise it will insert it. Once finished, click on the OK
    button twice ([Figure 5-74](#sql_code_to_move_data_from_the_stage_tab)).
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: 这里的 SQL 代码有些不同。它使用基于销售订单和项目的 MERGE 语句。如果数据仓库表中已有这个销售订单和项目，它将进行更新；否则将进行插入。完成后，连续点击两次
    OK 按钮（[图 5-74](#sql_code_to_move_data_from_the_stage_tab)）。
- en: '![SQL code to move data from the stage table to the mart table](assets/pdss_0574.png)'
  id: totrans-304
  prefs: []
  type: TYPE_IMG
  zh: '![从阶段表移动数据到数据仓库表的 SQL 代码](assets/pdss_0574.png)'
- en: Figure 5-74\. SQL code to move data from the stage table to the mart table
  id: totrans-305
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-74\. 从阶段表移动数据到 MART 表的 SQL 代码
- en: As we had done before, right-click on the Execute SQL Task and select Execute
    Task to test. Upon successful completion of this task there will be data in the
    mart table in the SQL database.
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 正如之前所做的那样，右键单击执行 SQL 任务，然后选择执行任务进行测试。成功完成此任务后，SQL 数据库中的 MART 表中将有数据。
- en: The concept here is to dump to the repository table, insert to the stage table,
    and merge to the mart table. For this flow to work, we must clean up the repo
    table upon successful completion of the load to stage and clean up the stage table
    upon successful load to the mart table. By not writing directly to the mart table
    we have a safe process and reduce the risk of accidentally corrupting our mart
    table.
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: 这里的概念是将数据倒入存储库表，插入到阶段表，然后合并到 MART 表中。为了使此流程正常工作，我们必须在成功加载到阶段表后清理存储库表，在成功加载到
    MART 表后清理阶段表。通过不直接写入 MART 表，我们确保了安全的过程，并减少了意外损坏 MART 表的风险。
- en: Copy two new Execute SQL Tasks to the Control Flow panel. Give them names indicating
    what they are going to do. We are going to *truncate* or drop the repo and stage
    tables once the data has successfully moved on ([Figure 5-75](#adding_sql_tasks_to_truncate_the_previou)).
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: 将两个新的执行 SQL 任务复制到控制流面板。给它们指示它们要执行的操作名称。我们将在数据成功移动后*截断*或删除存储库和阶段表（[图 5-75](#adding_sql_tasks_to_truncate_the_previou)）。
- en: '![Adding SQL Tasks to truncate the previous tables](assets/pdss_0575.png)'
  id: totrans-309
  prefs: []
  type: TYPE_IMG
  zh: '![向 SQL 任务添加删除以前表的代码](assets/pdss_0575.png)'
- en: Figure 5-75\. Adding SQL Tasks to truncate the previous tables
  id: totrans-310
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-75\. 向 SQL 任务添加删除以前表的代码
- en: 'As we had done earlier, assign the proper connection to the SQL database and
    open the SQL editor. For the Truncate Repo task, put in the simple code:'
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: 就像之前做过的那样，将正确的连接分配给 SQL 数据库并打开 SQL 编辑器。对于 Truncate Repo 任务，输入以下简单的代码：
- en: '[PRE6]'
  id: totrans-312
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'For the Truncate Stage task put in:'
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 Truncate Stage 任务，输入以下内容：
- en: '[PRE7]'
  id: totrans-314
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Test them and then check in SQL Server Management Studio to ensure that the
    repo and stage tables are empty.
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: 测试它们，然后在 SQL Server Management Studio 中检查确保存储库和阶段表为空。
- en: Each of these components are standalone, for the moment. Connect them to create
    a workflow [Figure 5-76](#connecting_the_tasks_into_a_single_workf). If any of
    these steps fail, the process will stop there and not continue—which is what we
    want! Refer back to [Figure 5-35](#data_flow_for_storing_data_in_sql) again. We
    want to protect our MART such that errors anywhere in the process will stop the
    overall process before data is moved to mart.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 每个组件目前都是独立的。将它们连接起来以创建工作流程（[图 5-76](#connecting_the_tasks_into_a_single_workf)）。如果其中任何步骤失败，流程将在那里停止，而不会继续——这正是我们想要的！再次参考
    [图 5-35](#data_flow_for_storing_data_in_sql)。我们希望保护我们的 MART，以便在任何过程中的错误发生时停止整个流程，以免数据转移到
    MART 之前。
- en: Note
  id: totrans-317
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 注意
- en: Some may assume that the whole repo → stage → mart process adds an unnecessary
    level of complexity. If you wisely monitor your data and are cautious on data
    loads you can directly load to mart. However, recently when updating a more than
    70 million row database for pharmaceutical analytics our process failed at the
    INSERT to stage. The source data structure had unknowingly changed. The repo →
    stage → mart design saved us a major rebuild, tons of time, and perhaps most importantly,
    avoided any system downtime.
  id: totrans-318
  prefs: []
  type: TYPE_NORMAL
  zh: 有些人可能认为整个存储库 → 阶段 → MART 过程增加了不必要的复杂性。如果您明智地监控数据并在数据加载时谨慎，您可以直接加载到 MART。然而，最近在更新一个超过
    7000 万行的制药分析数据库时，我们的流程在插入到阶段时失败了。源数据结构已经不知不觉地发生了变化。存储库 → 阶段 → MART 设计为我们节省了一次重建，大量时间，也许更重要的是，避免了任何系统停机。
- en: '![Connecting the tasks into a single workflow](assets/pdss_0576.png)'
  id: totrans-319
  prefs: []
  type: TYPE_IMG
  zh: '![将任务连接到单个工作流程](assets/pdss_0576.png)'
- en: Figure 5-76\. Connecting the tasks into a single workflow
  id: totrans-320
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-76\. 将任务连接到单个工作流程
- en: Click on the Save button and then click on the Start button to test the process.
    All the components will show a green check if they have successfully completed
    ([Figure 5-77](#executing_the_entire_workflow_and_checki)).
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
  zh: 点击保存按钮，然后点击开始按钮来测试该流程。如果所有组件成功完成，它们都将显示绿色勾号（[图 5-77](#executing_the_entire_workflow_and_checki)）。
- en: '![Executing the entire workflow and checking the status](assets/pdss_0577.png)'
  id: totrans-322
  prefs: []
  type: TYPE_IMG
  zh: '![执行整个工作流程并检查状态](assets/pdss_0577.png)'
- en: Figure 5-77\. Executing the entire workflow and checking the status
  id: totrans-323
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-77\. 执行整个工作流程并检查状态
- en: We have completed the process of extracting the data from SAP via the NetWeaver
    Gateway. We have used an extraction tool SSIS to automate the process and pull
    the data into a SQL Database. Now the data is available for advanced analytics
    and machine learning!
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经通过 NetWeaver Gateway 从 SAP 中提取数据的过程已经完成。我们使用了一个名为 SSIS 的提取工具自动化这一过程，并将数据拉入
    SQL 数据库。现在这些数据已经可以用于高级分析和机器学习！
- en: Finding Anomalies
  id: totrans-325
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 寻找异常
- en: For the advanced analytics and machine learning work, we will use PowerBI and
    R with the `anomalize` package introduced earlier. For nerdy fun, we’ll also do
    the same thing with PowerBI and Python—illustrating some key capabilities of both
    languages and the PowerBI tool itself. Greg’s an R addict, while Paul hacks around
    in Python. PowerBI is the perfect place to meld those preferences.
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
  zh: 为了进行高级分析和机器学习工作，我们将使用 PowerBI 和 R，之前介绍过的 `anomalize` 包。为了获得技术上的乐趣，我们也将使用 PowerBI
    和 Python 来做同样的事情——展示这两种语言及 PowerBI 工具本身的一些关键能力。Greg 是 R 的爱好者，而 Paul 则在 Python
    上“胡来”。PowerBI 是将这些喜好融合起来的完美场所。
- en: PowerBI and R
  id: totrans-327
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PowerBI 和 R
- en: Let’s learn about yet another powerful tool in our data scientist’s toolbox...PowerBI.
    What exactly is PowerBI? In technical terms, PowerBI is an abstraction layer between
    the data and the presentation. You can model and transform your data before presenting
    it to the user. Furthermore, you can merge and modify disparate data sources into
    one report using PowerBI. How about an example for our SAP users. You know that
    ALV (ABAP List Viewer) report that is so ubiquitous? That is an abstraction between
    the data and the reporting. PowerBI is hundreds of times more powerful than that.
    For those familiar with Business Intelligence models, PowerBI provides an ETL
    (Extract-Transform-Load) layer before the actual reporting.^([9](ch05.html#ch05fn9))
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们了解数据科学家工具箱中另一个强大的工具……PowerBI。那么 PowerBI 到底是什么呢？从技术角度来看，PowerBI 是数据与展示之间的抽象层。您可以在向用户呈现数据之前对其进行建模和转换。此外，您可以使用
    PowerBI 将不同的数据源合并和修改为一个报告。我们来为我们的 SAP 用户举个例子。您知道那个无处不在的 ALV（ABAP List Viewer）报告吗？那是数据和报告之间的抽象。PowerBI
    比那个强大数百倍。对于熟悉商业智能模型的人来说，PowerBI 在实际报告之前提供了一个 ETL（提取-转换-加载）层。
- en: First, download and install PowerBI.^([10](ch05.html#ch05fn10)) To use R together
    with PowerBI, we need to set up the connection to our SQL mart. Open up PowerBI
    and click on the Get Data button. Then select the Database option and highlight
    SQL Server database. Click on the Connect button ([Figure 5-78](#connecting_powerbi_to_a_sql_database)).
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，下载并安装 PowerBI。^([10](ch05.html#ch05fn10)) 要在 PowerBI 中使用 R，我们需要设置连接到我们的 SQL
    mart。打开 PowerBI 并点击“获取数据”按钮。然后选择“数据库”选项并突出显示 SQL Server 数据库。点击“连接”按钮（[图 5-78](#connecting_powerbi_to_a_sql_database)）。
- en: '![Connecting PowerBI to a SQL database](assets/pdss_0578.png)'
  id: totrans-330
  prefs: []
  type: TYPE_IMG
  zh: '![连接 PowerBI 到 SQL 数据库](assets/pdss_0578.png)'
- en: Figure 5-78\. Connecting PowerBI to a SQL database
  id: totrans-331
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-78\. 连接 PowerBI 到 SQL 数据库
- en: Enter the Server and the Database name and click the OK button ([Figure 5-79](#naming_the_sql_database_connection_in_po)).
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
  zh: 输入服务器和数据库名称，然后点击“确定”按钮（[图 5-79](#naming_the_sql_database_connection_in_po)）。
- en: '![Naming the SQL database connection in PowerBI](assets/pdss_0579.png)'
  id: totrans-333
  prefs: []
  type: TYPE_IMG
  zh: '![在 PowerBI 中命名 SQL 数据库连接](assets/pdss_0579.png)'
- en: Figure 5-79\. Naming the SQL database connection in PowerBI
  id: totrans-334
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-79\. 在 PowerBI 中命名 SQL 数据库连接
- en: Accept the authorization settings or change them if not using Windows credentials.
    Click on the Connect button ([Figure 5-80](#authorization_for_connecting_to_a_sql_da)).
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
  zh: 接受授权设置或根据需要更改它们（如果不使用 Windows 凭据）。点击“连接”按钮（[图 5-80](#authorization_for_connecting_to_a_sql_da)）。
- en: '![Authorization for connecting to a SQL database in PowerBI](assets/pdss_0580.png)'
  id: totrans-336
  prefs: []
  type: TYPE_IMG
  zh: '![连接到 PowerBI 中 SQL 数据库的授权](assets/pdss_0580.png)'
- en: Figure 5-80\. Authorization for connecting to a SQL database in PowerBI
  id: totrans-337
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-80\. 连接到 PowerBI 中 SQL 数据库的授权
- en: PowerBI will notify you that it tried an encrypted connection first unsuccessfully
    and now it is going to use an unencrypted connection. Click on the OK button ([Figure 5-81](#warning_message_in_powerbi_for_encryptio)).
  id: totrans-338
  prefs: []
  type: TYPE_NORMAL
  zh: PowerBI 将通知您，它首先尝试了加密连接但未成功，现在将使用非加密连接。点击“确定”按钮（[图 5-81](#warning_message_in_powerbi_for_encryptio)）。
- en: '![Warning message in PowerBI for encryption support](assets/pdss_0581.png)'
  id: totrans-339
  prefs: []
  type: TYPE_IMG
  zh: '![PowerBI 中用于加密支持的警告消息](assets/pdss_0581.png)'
- en: Figure 5-81\. Warning message in PowerBI for encryption support
  id: totrans-340
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-81\. PowerBI 中用于加密支持的警告消息
- en: Select the mart table from the SQL database. A preview will show in the right
    panel. Click on the Load button ([Figure 5-82](#previewing_the_sql_data_in_powerbi)).
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
  zh: 从 SQL 数据库中选择 mart 表。预览将显示在右侧面板中。点击“加载”按钮（[图 5-82](#previewing_the_sql_data_in_powerbi)）。
- en: '![Previewing the SQL data in PowerBI](assets/pdss_0582.png)'
  id: totrans-342
  prefs: []
  type: TYPE_IMG
  zh: '![在PowerBI中预览SQL数据](assets/pdss_0582.png)'
- en: Figure 5-82\. Previewing the SQL data in PowerBI
  id: totrans-343
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-82\. 预览在PowerBI中的SQL数据
- en: While PowerBI loads the data, it will display the dialog box shown in [Figure 5-83](#powerbi_loading_indicator).
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
  zh: 当PowerBI加载数据时，它将显示如下对话框（见图 5-83 [#powerbi_loading_indicator](#powerbi_loading_indicator)）。
- en: '![PowerBI loading indicator](assets/pdss_0583.png)'
  id: totrans-345
  prefs: []
  type: TYPE_IMG
  zh: '![PowerBI加载指示器](assets/pdss_0583.png)'
- en: Figure 5-83\. PowerBI loading indicator
  id: totrans-346
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-83\. PowerBI加载指示器
- en: Once the data is finished loading PowerBI will display a blank canvas with tools
    for visualizations and the fields from our SQL database. Click on the Slicer button
    first ([Figure 5-84](#selecting_the_slicer_visualization_in_po)). This allows
    us to filter our data dynamically in the PowerBI report.
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
  zh: 数据加载完成后，PowerBI将显示一个空白画布，包含用于可视化的工具和来自SQL数据库的字段。首先点击切片器按钮（见图 5-84 [#selecting_the_slicer_visualization_in_po](#selecting_the_slicer_visualization_in_po)）。这使我们能够在PowerBI报告中动态过滤数据。
- en: '![Selecting the slicer visualization in PowerBI](assets/pdss_0584.png)'
  id: totrans-348
  prefs: []
  type: TYPE_IMG
  zh: '![选择切片器可视化在PowerBI中](assets/pdss_0584.png)'
- en: Figure 5-84\. Selecting the slicer visualization in PowerBI
  id: totrans-349
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-84\. 在PowerBI中选择切片器可视化
- en: Then click on the field for Customer to assign it to the slicer. The slicer
    on the canvas shows the assignment. If you want there to be a “searchable” capability
    in the slicer, click on the ellipsis in the upper-right corner and select Search,
    as in Figures [5-85](#using_the_searchable_option_for_the_slic) and [5-86](#the_searchable_option_in_the_slicer_visu).
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
  zh: 然后点击客户字段以将其分配给切片器。画布上的切片器显示了分配情况。如果希望切片器具有“可搜索”功能，请点击右上角的省略号并选择“搜索”，如图 5-85 [#using_the_searchable_option_for_the_slic](#using_the_searchable_option_for_the_slic)和 5-86 [#the_searchable_option_in_the_slicer_visu](#the_searchable_option_in_the_slicer_visu)所示。
- en: '![Using the searchable option for the slicer visual in PowerBI](assets/pdss_0585.png)'
  id: totrans-351
  prefs: []
  type: TYPE_IMG
  zh: '![在PowerBI中使用可搜索选项的切片器可视化](assets/pdss_0585.png)'
- en: Figure 5-85\. Using the searchable option for the slicer visual in PowerBI
  id: totrans-352
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-85\. 在PowerBI中使用可搜索选项的切片器可视化
- en: '![The searchable option in the slicer visual](assets/pdss_0586.png)'
  id: totrans-353
  prefs: []
  type: TYPE_IMG
  zh: '![在切片器可视化中使用可搜索选项](assets/pdss_0586.png)'
- en: Figure 5-86\. The searchable option in the slicer visual
  id: totrans-354
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-86\. 切片器可视化中的可搜索选项
- en: Repeat the process for Material and Date ([Figure 5-87](#adding_other_slicer_visuals_in_powerbi)).
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
  zh: 重复此过程以处理材料和日期（见图 5-87 [#adding_other_slicer_visuals_in_powerbi](#adding_other_slicer_visuals_in_powerbi)）。
- en: '![Adding other slicer visuals in PowerBI](assets/pdss_0587.png)'
  id: totrans-356
  prefs: []
  type: TYPE_IMG
  zh: '![在PowerBI中添加其他切片器可视化](assets/pdss_0587.png)'
- en: Figure 5-87\. Adding other slicer visuals in PowerBI
  id: totrans-357
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-87\. 在PowerBI中添加其他切片器可视化
- en: Our first visualization is a simple line chart showing sales of material by
    date. Click on the Line chart button and place it on the canvas. As shown in [Figure 5-88](#adding_variables_to_the_line_chart_visua),
    assign Date to the axis, Quantity to the values, and Material to the legend. Then
    add whatever tooltips you’d like.
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的第一个可视化是一个简单的线图，显示按日期销售的材料。点击线图按钮并将其放置在画布上。如图 5-88 [#adding_variables_to_the_line_chart_visua](#adding_variables_to_the_line_chart_visua)所示，将日期分配到轴上，数量分配到值上，并将材料分配到图例中。然后添加所需的工具提示。
- en: '![Adding variables to the line chart visual in PowerBI](assets/pdss_0588.png)'
  id: totrans-359
  prefs: []
  type: TYPE_IMG
  zh: '![向线图可视化中添加变量](assets/pdss_0588.png)'
- en: Figure 5-88\. Adding variables to the line chart visual in PowerBI
  id: totrans-360
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-88\. 向线图可视化中添加变量
- en: The line chart is very busy because it has not been filtered yet. We’ve created
    a slicer for the report, but we haven’t put any filter criteria into it yet ([Figure 5-89](#preview_of_the_line_chart_visual_in_powe)).
  id: totrans-361
  prefs: []
  type: TYPE_NORMAL
  zh: 由于尚未进行过滤，线图非常繁忙。我们已为报表创建了一个切片器，但尚未为其添加任何过滤条件（见图 5-89 [#preview_of_the_line_chart_visual_in_powe](#preview_of_the_line_chart_visual_in_powe)）。
- en: '![Preview of the line chart visual in PowerBI](assets/pdss_0589.png)'
  id: totrans-362
  prefs: []
  type: TYPE_IMG
  zh: '![在PowerBI中线图可视化的预览](assets/pdss_0589.png)'
- en: Figure 5-89\. Preview of the line chart visual in PowerBI
  id: totrans-363
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-89\. 在PowerBI中线图可视化的预览
- en: The next step is to add an R visualization. Click on the R button and place
    it on the canvas under the line chart. Drag the variables we are going to use
    to the R visualization. These are Date and Quantity ([Figure 5-90](#using_the_r_visual_in_powerbi)).
  id: totrans-364
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来的步骤是添加一个R可视化。点击R按钮，并将其放置在线图下的画布上。将要使用的变量拖放到R可视化中。这些变量是日期和数量（见图 5-90 [#using_the_r_visual_in_powerbi](#using_the_r_visual_in_powerbi)）。
- en: '![Using the R visual in PowerBI](assets/pdss_0590.png)'
  id: totrans-365
  prefs: []
  type: TYPE_IMG
  zh: '![在PowerBI中使用R可视化](assets/pdss_0590.png)'
- en: Figure 5-90\. Using the R visual in PowerBI
  id: totrans-366
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-90\. 在PowerBI中使用R可视化
- en: In the script editor the fields selected will be shown as part of the dataset
    ([Figure 5-91](#selecting_variables_for_the_dataset_in_r)).
  id: totrans-367
  prefs: []
  type: TYPE_NORMAL
  zh: 在脚本编辑器中，所选字段将显示为数据集的一部分（见图 5-91 [#selecting_variables_for_the_dataset_in_r](#selecting_variables_for_the_dataset_in_r)）。
- en: '![Selecting variables for the dataset in R in PowerBI](assets/pdss_0591.png)'
  id: totrans-368
  prefs: []
  type: TYPE_IMG
  zh: '![在PowerBI中选择R中数据集的变量](assets/pdss_0591.png)'
- en: Figure 5-91\. Selecting variables for the dataset in R in PowerBI
  id: totrans-369
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-91\. 在 PowerBI 中选择数据集中的变量
- en: 'Place the following R code in the script editor (the comments in the code are
    preceded by a hash mark (#) and will describe what the next line of code is doing):'
  id: totrans-370
  prefs: []
  type: TYPE_NORMAL
  zh: 将以下 R 代码放入脚本编辑器中（代码中的注释以井号（#）开头，描述下一行代码的功能）：
- en: '[PRE8]'
  id: totrans-371
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Then press the Play button to see it work.
  id: totrans-372
  prefs: []
  type: TYPE_NORMAL
  zh: 然后按播放按钮查看其工作效果。
- en: It doesn’t make a lot of sense at first since it is evaluating anomalies across
    all available materials for all customers. It hasn’t been filtered yet ([Figure 5-92](#unfiltered_view_of_r_and_line_visual_in)).
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
  zh: 起初并不太有意义，因为它正在评估所有客户和所有可用材料的异常。它尚未进行过滤（图 [5-92](#unfiltered_view_of_r_and_line_visual_in)）。
- en: '![Unfiltered view of R and line visual in PowerBI](assets/pdss_0592.png)'
  id: totrans-374
  prefs: []
  type: TYPE_IMG
  zh: '![PowerBI 中 R 和线性视图的未过滤视图](assets/pdss_0592.png)'
- en: Figure 5-92\. Unfiltered view of R and line visual in PowerBI
  id: totrans-375
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-92\. PowerBI 中 R 和线性视图的未过滤视图
- en: Select one material to see anomalies across all customers for that particular
    material ([Figure 5-93](#filtering_the_line_and_r_visual_via_the)).
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
  zh: 选择一个材料，以查看该特定材料下所有客户的异常情况（图 [5-93](#filtering_the_line_and_r_visual_via_the)）。
- en: '![Filtering the line and R visual via the slicer](assets/pdss_0593.png)'
  id: totrans-377
  prefs: []
  type: TYPE_IMG
  zh: '![通过切片器过滤线性和 R 视图](assets/pdss_0593.png)'
- en: Figure 5-93\. Filtering the line and R visual via the slicer
  id: totrans-378
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-93\. 通过切片器过滤线性和 R 视图
- en: The first thing to notice is that the line chart does not intuitively show anomalies.
    One would guess that spikes are anomalies, but the `anomalize` package did not
    always classify them as such. Now click on a customer to subset the values further
    to display anomalies for a particular customer and material combination (Figures
    [5-94](#subsetting_the_visual_by_material_and_cu) and [5-95](#closer_view_of_just_the_charts_in_the_po)).
  id: totrans-379
  prefs: []
  type: TYPE_NORMAL
  zh: 首先要注意的是，线性图并不直观地显示异常。人们可能会认为峰值是异常，但 `anomalize` 包并不总是将它们分类为异常。现在点击一个客户以进一步细分值，显示特定客户和材料组合的异常（图
    [5-94](#subsetting_the_visual_by_material_and_cu) 和 [5-95](#closer_view_of_just_the_charts_in_the_po)）。
- en: '![Subsetting the visual by material and customer for accurate anomaly detection](assets/pdss_0594.png)'
  id: totrans-380
  prefs: []
  type: TYPE_IMG
  zh: '![按材料和客户子集化视图以进行准确的异常检测](assets/pdss_0594.png)'
- en: Figure 5-94\. Subsetting the visual by material and customer for accurate anomaly
    detection
  id: totrans-381
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-94\. 按材料和客户子集化视图以进行准确的异常检测
- en: Anomalies are now more in line with the line chart and large spikes do show
    as anomalies, but not all of them.
  id: totrans-382
  prefs: []
  type: TYPE_NORMAL
  zh: 异常现在更符合线性图，并且大的峰值确实显示为异常，但不是所有的异常。
- en: '![Closer view of just the charts in the PowerBI report](assets/pdss_0595.png)'
  id: totrans-383
  prefs: []
  type: TYPE_IMG
  zh: '![仅查看 PowerBI 报告中图表的近距离视图](assets/pdss_0595.png)'
- en: Figure 5-95\. Closer view of just the charts in the PowerBI report
  id: totrans-384
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-95\. 仅查看 PowerBI 报告中图表的近距离视图
- en: PowerBI and Python
  id: totrans-385
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PowerBI 和 Python
- en: 'Whether you’re a SAP analyst or a data scientist, everyone who wrangles code
    has their own preferences for language, syntax, style, and platform. Microsoft
    took this to heart when designing PowerBI. The preceding section set up and analyzed
    sales order data looking for anomalies in R—but let’s make the jump to Python.
    A couple of packages help us make this an efficient process:'
  id: totrans-386
  prefs: []
  type: TYPE_NORMAL
  zh: 无论您是 SAP 分析师还是数据科学家，每个处理代码的人都有自己偏好的语言、语法、样式和平台。在设计 PowerBI 时，微软深知这一点。前文设置并分析了销售订单数据，寻找
    R 中的异常情况，但让我们跳到 Python。一些包帮助我们使这个过程更加高效：
- en: luminol
  id: totrans-387
  prefs: []
  type: TYPE_NORMAL
  zh: luminol
- en: A package designed for time series data analysis. It’s open sourced from the
    folks at LinkedIn. Considering the sheer amount of data being handled at LinkedIn,
    as well as its relative worth in the value of that product, it’s easy to imagine
    that their data science team is top-notch. And this package proves it, by providing
    an easy-to-use API for detecting anomalies as well as fine-tuning how the detection
    works.
  id: totrans-388
  prefs: []
  type: TYPE_NORMAL
  zh: 一个设计用于时间序列数据分析的包。这是 LinkedIn 团队开源的。考虑到 LinkedIn 处理的大量数据以及其在产品价值中的相对重要性，可以想象他们的数据科学团队非常出色。这个包通过提供易于使用的
    API 来检测异常，并调整检测的工作方式，证明了这一点。
- en: Matplotlib
  id: totrans-389
  prefs: []
  type: TYPE_NORMAL
  zh: Matplotlib
- en: A package designed for 2D plotting. Very powerful, feature-packed, and common
    across the Python world. We’ll visualize our results using this library.
  id: totrans-390
  prefs: []
  type: TYPE_NORMAL
  zh: 一个专为二维绘图设计的包。非常强大、功能丰富，在 Python 社区中很常见。我们将使用这个库来可视化我们的结果。
- en: We can even keep our language preference in the same tool, because PowerBI has
    built-in support for using Python to output charts and graphs, allowing us to
    use these libraries. This support is currently available in preview, so let’s
    set it up. After all, a huge part of data science is daring to try something new!
  id: totrans-391
  prefs: []
  type: TYPE_NORMAL
  zh: 我们甚至可以在同一工具中保留我们的语言偏好，因为PowerBI内置支持使用Python输出图表和图形，允许我们使用这些库。这种支持目前处于预览状态，所以让我们来设置一下。毕竟，数据科学的一个重要部分就是敢于尝试新事物！
- en: To make sure your computer can run the new Python feature, install the latest
    version of Python and then use the following three `pip` commands to install the
    packages we’ll use:^([11](ch05.html#ch05fn11))
  id: totrans-392
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确保您的计算机可以运行新的Python功能，请安装最新版本的Python，并使用以下三个`pip`命令安装我们将使用的包：^([11](ch05.html#ch05fn11))
- en: '[PRE9]'
  id: totrans-393
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Next, open PowerBI and use the same file we created earlier for R analysis.
    Navigate to the settings menu, and in the Global section, the Preview Features
    menu allows you to add upcoming features that are not part of the full current
    release ([Figure 5-96](#turning_on_the_python_support_in_powerbi)).
  id: totrans-394
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，打开PowerBI，并使用之前用于R分析的同一文件。导航至设置菜单，在全局部分的预览功能菜单中，您可以添加尚未包含在当前完整发布版中的即将推出的功能（[图5-96](#turning_on_the_python_support_in_powerbi)）。
- en: '![Turning on the Python support in PowerBI](assets/pdss_0596.png)'
  id: totrans-395
  prefs: []
  type: TYPE_IMG
  zh: '![启用PowerBI中的Python支持](assets/pdss_0596.png)'
- en: Figure 5-96\. Turning on the Python support in PowerBI
  id: totrans-396
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-96. 启用PowerBI中的Python支持
- en: Check the box next to Python support and close the options menu. You’re set
    to use Python in this document. We’ll add a Python graph right below the R graph
    we created. In the Visualizations menu, choose Py to add another analysis section
    to the dashboard ([Figure 5-97](#the_python_visual_in_powerbi)).
  id: totrans-397
  prefs: []
  type: TYPE_NORMAL
  zh: 选中Python支持旁边的复选框，并关闭选项菜单。您现在可以在此文档中使用Python了。我们将在我们之前创建的R图形的下方添加一个Python图形。在可视化菜单中，选择Py以向仪表板添加另一个分析部分（[图5-97](#the_python_visual_in_powerbi)）。
- en: '![The Python visual in PowerBI](assets/pdss_0597.png)'
  id: totrans-398
  prefs: []
  type: TYPE_IMG
  zh: '![PowerBI中的Python可视化](assets/pdss_0597.png)'
- en: Figure 5-97\. The Python visual in PowerBI
  id: totrans-399
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-97. PowerBI中的Python可视化
- en: For the last bit of PowerBI setup, make sure the Fields properties for this
    visualization match the properties of the R visualization we set up earlier ([Figure 5-98](#selection_fields_for_the_python_visual_i)).
  id: totrans-400
  prefs: []
  type: TYPE_NORMAL
  zh: 对于PowerBI的最后一点设置，请确保此可视化的字段属性与我们之前设置的R可视化的属性匹配（[图5-98](#selection_fields_for_the_python_visual_i)）。
- en: '![Selection fields for the Python visual in PowerBI](assets/pdss_0598.png)'
  id: totrans-401
  prefs: []
  type: TYPE_IMG
  zh: '![PowerBI中Python可视化的选择字段](assets/pdss_0598.png)'
- en: Figure 5-98\. Selection fields for the Python visual in PowerBI
  id: totrans-402
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-98. Python可视化的选择字段
- en: 'With PowerBI set up and packages installed, we’re ready. Click on the Python
    analysis section and enter the following code:'
  id: totrans-403
  prefs: []
  type: TYPE_NORMAL
  zh: 当PowerBI设置好并安装好所需的包后，我们准备好了。点击Python分析部分，并输入以下代码：
- en: '[PRE10]'
  id: totrans-404
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Click the Play button in the code console, and watch as the graph is generated
    ([Figure 5-99](#anomalies_identified_in_python_visual_in)).
  id: totrans-405
  prefs: []
  type: TYPE_NORMAL
  zh: 在代码控制台中点击播放按钮，观看图表生成（[图5-99](#anomalies_identified_in_python_visual_in)）。
- en: If you compare this graph to the one generated from the R code, you’ll see that
    the two packages agree on the late January 2017 spike as an anomaly, as well as
    a July 2016 spike. The R graph captured a couple of other points later in 2017
    as suspect that weren’t flagged by the `luminol` library.
  id: totrans-406
  prefs: []
  type: TYPE_NORMAL
  zh: 如果将此图与从R代码生成的图进行比较，您会发现两个软件包都同意将2017年1月底的突发事件以及2016年7月的突发事件标记为异常。R图捕获了2017年晚些时候的几个未被`luminol`库标记为可疑的点。
- en: There are two great things about running your questions through two analyses.
    First, you get the chance to learn new approaches and tools. SAP analysts and
    data scientists alike can surely see the value in expanding their toolsets. Today’s
    technology professionals can’t afford not to do that.
  id: totrans-407
  prefs: []
  type: TYPE_NORMAL
  zh: 通过两次分析提出您的问题有两个显著优点。首先，您有机会学习新的方法和工具。SAP分析师和数据科学家都可以肯定地看到扩展其工具集的价值。如今的技术专业人员不容忽视这一点。
- en: '![Anomalies identified in Python visual in PowerBI](assets/pdss_0599.png)'
  id: totrans-408
  prefs: []
  type: TYPE_IMG
  zh: '![PowerBI中Python可视化中的异常](assets/pdss_0599.png)'
- en: Figure 5-99\. Anomalies identified in Python visual in PowerBI
  id: totrans-409
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图5-99. PowerBI中Python可视化中的异常
- en: Second, and most important for our data analysis purposes, is that you get to
    use multiple approaches to fine-tune your answers to the questions you ask of
    the data. For example, note that in the Python code the `AnomalyDetector` constructor
    takes a `score_threshold` parameter. By using a `score_threshold` value of 2,
    we set the algorithm to only unpack certain anomalies. While experimenting with
    that parameter, note that in this case setting the parameter to a lower or higher
    number will start to uncover anomalies that exist in the lower bounds of the data
    as well.
  id: totrans-410
  prefs: []
  type: TYPE_NORMAL
  zh: 第二，对于我们的数据分析目的来说最重要的是，你可以使用多种方法来调整你对数据提出的问题的答案。例如，注意Python代码中`AnomalyDetector`构造函数接受`score_threshold`参数。通过将`score_threshold`值设置为2，我们将算法设置为仅解析某些异常。在调整该参数时，请注意在这种情况下将参数设置为较低或较高的数字将开始揭示数据下限存在的异常。
- en: 'Janine in the regulatory department and Duane the SAP analyst need to ask themselves:
    for the purposes of the analysis and meeting the regulatory requirements, are
    suspiciously low orders something to watch out for? Conversely for high number
    thresholds, what do I know about this customer? Are they ordering more product
    than they can fit in their warehouse? Is that suspicious? Many ERP and EDI systems
    can store information about customer facilities.'
  id: totrans-411
  prefs: []
  type: TYPE_NORMAL
  zh: 在监管部门的Janine和SAP分析师Duane需要问自己：对于分析目的和满足监管要求来说，异常低订单是否值得关注？相反，对于高数值阈值，我对这位客户了解多少？他们是否订购了超过仓库容量的产品？这是否可疑？许多ERP和EDI系统可以存储有关客户设施的信息。
- en: Summary
  id: totrans-412
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter the data science team completed a process of extracting sales
    data from SAP, storing it in SQL, and displaying the results in a PowerBI dashboard
    with the help of either R or Python. It may have seemed like a lot of steps to
    get this to work, but one could follow these steps and in a single day create
    a sales order anomaly dashboard from SAP. With large data warehouse teams trying
    to stay ahead of hundreds of similar requests from departments all over the business,
    the same process would take weeks if not months. We have been able to prototype
    an anomaly detection system for SAP sales orders in a single day. This is illustrative
    of the speed and power of data science when applied to business data with modern
    tools.
  id: totrans-413
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，数据科学团队完成了从SAP提取销售数据，存储到SQL，并借助R或Python在PowerBI仪表板中显示结果的过程。也许看起来需要很多步骤才能使其工作，但一个人可以跟随这些步骤，在一天之内从SAP创建一个销售订单异常仪表板。对于试图赶上业务各部门数百个类似请求的大型数据仓库团队来说，同样的过程可能需要数周甚至数月的时间。我们已经能够在一天内为SAP销售订单原型化一个异常检测系统。这展示了在现代工具应用于业务数据时，数据科学的速度和能力。
- en: We discovered through readily available libraries in R (`anomalize`) and Python
    (`luminol`) that we can quickly and easily detect anomalies in our data. We have
    only scratched the surface of anomaly detection, but we’ve exposed ourselves to
    the possibility of doing this with business data from SAP. The processes we’ve
    learned in this chapter encompass much more than just anomaly detection. Extracting
    data from SAP through NetWeaver Gateway and storing it in SQL via SSIS is a common
    useful process for all types of data science endeavors. In our example, it is
    not truly necessary to store the data outside of SAP; however, if you find yourself
    working with financials in SAP this technique will likely help. Financial data
    in SAP is nearly always voluminous and often requires extraction before analysis.
  id: totrans-414
  prefs: []
  type: TYPE_NORMAL
  zh: 通过在R（`anomalize`）和Python（`luminol`）中使用现成的库，我们发现可以快速轻松地检测数据中的异常。我们仅仅触及到了异常检测的表面，但已经暴露出了利用SAP业务数据进行此操作的可能性。本章学到的过程远不止异常检测。通过NetWeaver
    Gateway从SAP提取数据，再通过SSIS存储到SQL中，这是所有类型数据科学工作中常见且实用的过程。在我们的例子中，并不一定要将数据存储在SAP之外；然而，如果你发现自己在处理SAP财务数据时，这种技术可能会有所帮助。SAP中的财务数据通常数量庞大，常常需要在分析之前提取出来。
- en: Despite our good start, this is likely not the end of our journey in detecting
    sales order anomalies. We have provided the business with a proof-of-concept and
    a prototype. Janine from the regulatory department has always known what the regulations
    state about remaining compliant. Now, however, she understands what type of analytics
    and data science the IT department can provide. This prototype will go through
    some iterations and refinement before being the robust dashboard that will protect
    Janine and her company from noncompliance with government standards. This project
    would have served other companies well—companies that came under government scrutiny
    and ended up with hefty fines.
  id: totrans-415
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然我们有一个良好的开始，这可能并非是我们在检测销售订单异常方面的终点。我们已向业务提供了概念验证和原型。监管部门的珍妮已经知道规定要求保持符合。然而，现在她了解到IT部门可以提供何种类型的分析和数据科学。这个原型将经过几次迭代和完善，最终成为一个强大的仪表盘，将保护珍妮及其公司免受不符合政府标准的处罚。这个项目本可以为其他公司服务得很好——那些遭到政府审查并最终被罚款的公司。
- en: ^([1](ch05.html#ch05fn1-marker)) See [Chapter 2](ch02.html#ch02) for a refresher
    on supervised and unsupervised learning.
  id: totrans-416
  prefs: []
  type: TYPE_NORMAL
  zh: ^([1](ch05.html#ch05fn1-marker)) 请参阅[Chapter 2](ch02.html#ch02)以了解监督学习和无监督学习的复习。
- en: ^([2](ch05.html#ch05fn2-marker)) More details on the mechanics of how a generalized
    ESD works can be found at [*https://www.itl.nist.gov/div898/handbook/eda/section3/eda35h3.htm*](https://www.itl.nist.gov/div898/handbook/eda/section3/eda35h3.htm).
  id: totrans-417
  prefs: []
  type: TYPE_NORMAL
  zh: ^([2](ch05.html#ch05fn2-marker)) 更多关于通用ESD如何运作的详细机制可以在[*https://www.itl.nist.gov/div898/handbook/eda/section3/eda35h3.htm*](https://www.itl.nist.gov/div898/handbook/eda/section3/eda35h3.htm)找到。
- en: '^([3](ch05.html#ch05fn3-marker)) A wonderful presentation of this package can
    be found on *Business Science*’s website: [*https://www.business-science.io/code-tools/2018/04/08/introducing-anomalize.html*](https://www.business-science.io/code-tools/2018/04/08/introducing-anomalize.html).'
  id: totrans-418
  prefs: []
  type: TYPE_NORMAL
  zh: ^([3](ch05.html#ch05fn3-marker)) 可以在*Business Science*网站上找到关于这个包的精彩介绍：[*https://www.business-science.io/code-tools/2018/04/08/introducing-anomalize.html*](https://www.business-science.io/code-tools/2018/04/08/introducing-anomalize.html)。
- en: ^([4](ch05.html#ch05fn4-marker)) Download SQL Server Express [here](https://www.microsoft.com/en-us/sql-server/sql-server-editions-express).
  id: totrans-419
  prefs: []
  type: TYPE_NORMAL
  zh: ^([4](ch05.html#ch05fn4-marker)) 可以在这里下载SQL Server Express：[https://www.microsoft.com/en-us/sql-server/sql-server-editions-express](https://www.microsoft.com/en-us/sql-server/sql-server-editions-express)。
- en: ^([5](ch05.html#ch05fn5-marker)) Installation tutorial for SQL Express at [*https://www.sqlshack.com/install-microsoft-sql-server-express-localdb/*](https://www.sqlshack.com/install-microsoft-sql-server-express-localdb/).
  id: totrans-420
  prefs: []
  type: TYPE_NORMAL
  zh: ^([5](ch05.html#ch05fn5-marker)) SQL Express的安装教程请参考[*https://www.sqlshack.com/install-microsoft-sql-server-express-localdb/*](https://www.sqlshack.com/install-microsoft-sql-server-express-localdb/)。
- en: ^([6](ch05.html#ch05fn6-marker)) Download SQL Server Management Studio at [*https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017*](https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017).
  id: totrans-421
  prefs: []
  type: TYPE_NORMAL
  zh: ^([6](ch05.html#ch05fn6-marker)) SQL Server Management Studio下载地址：[*https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017*](https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017)。
- en: ^([7](ch05.html#ch05fn7-marker)) Connect SSMS to SQL at [*https://docs.microsoft.com/en-us/sql/relational-databases/lesson-1-connecting-to-the-database-engine?view=sql-server-2017*](https://docs.microsoft.com/en-us/sql/relational-databases/lesson-1-connecting-to-the-database-engine?view=sql-server-2017).
  id: totrans-422
  prefs: []
  type: TYPE_NORMAL
  zh: ^([7](ch05.html#ch05fn7-marker)) 请参阅 [*https://docs.microsoft.com/en-us/sql/relational-databases/lesson-1-connecting-to-the-database-engine?view=sql-server-2017*](https://docs.microsoft.com/en-us/sql/relational-databases/lesson-1-connecting-to-the-database-engine?view=sql-server-2017)
    将SSMS连接到SQL。
- en: ^([8](ch05.html#ch05fn8-marker)) Visual Studio Community at [*https://visualstudio.microsoft.com/downloads/*](https://visualstudio.microsoft.com/downloads/).
  id: totrans-423
  prefs: []
  type: TYPE_NORMAL
  zh: ^([8](ch05.html#ch05fn8-marker)) Visual Studio Community下载地址：[*https://visualstudio.microsoft.com/downloads/*](https://visualstudio.microsoft.com/downloads/)。
- en: ^([9](ch05.html#ch05fn9-marker)) In our humble opinion, tools like PowerBI and
    Tableau with their ETL layers are the death knell of traditional data warehouse
    models.
  id: totrans-424
  prefs: []
  type: TYPE_NORMAL
  zh: ^([9](ch05.html#ch05fn9-marker)) 依我们的谦虚意见，像PowerBI和Tableau这样具有ETL层的工具是传统数据仓库模型的丧钟。
- en: ^([10](ch05.html#ch05fn10-marker)) PowerBI can be downloaded from [*https://powerbi.microsoft.com/en-us/downloads/*](https://powerbi.microsoft.com/en-us/downloads/).
  id: totrans-425
  prefs: []
  type: TYPE_NORMAL
  zh: ^([10](ch05.html#ch05fn10-marker)) PowerBI可从[*https://powerbi.microsoft.com/en-us/downloads/*](https://powerbi.microsoft.com/en-us/downloads/)下载。
- en: ^([11](ch05.html#ch05fn11-marker)) There are many ways to install new packages
    in Python. In our example, we are using a basic command line.
  id: totrans-426
  prefs: []
  type: TYPE_NORMAL
  zh: ^([11](ch05.html#ch05fn11-marker)) Python中安装新包的方式有很多。在我们的例子中，我们使用了基本的命令行。
