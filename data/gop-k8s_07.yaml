- en: 5 Deployment strategies
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5 部署策略
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Understanding why ReplicaSet is not a good fit for GitOps
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 理解为什么 ReplicaSet 不适合 GitOps
- en: Understanding why Deployment is declarative and a good fit for GitOps
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 理解为什么 Deployment 是声明式的，并且适合 GitOps
- en: Implementing blue-green deployment using native Kubernetes resources and Argo
    Rollouts
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用原生 Kubernetes 资源和 Argo Rollouts 实现蓝绿部署
- en: Implementing canary deployment using native Kubernetes resources and Argo Rollouts
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用原生 Kubernetes 资源和 Argo Rollouts 实现金丝雀部署
- en: Implementing progressive delivery using Argo Rollouts
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 Argo Rollouts 实现渐进式交付
- en: In the previous chapters, we have focused on the initial deployment of Kubernetes
    resources. Launching a new application can be as simple as deploying a ReplicaSet
    with the desired number of Pod replicas and creating a Service to route the incoming
    traffic to the desired Pods. But now imagine you have hundreds (or thousands)
    of customers sending thousands of requests per second to your application. How
    do you safely deploy new versions of your application? How can you limit the damage
    if the latest version of your application contains a critical bug? In this chapter,
    you will learn about the mechanisms and techniques that can be used with Kubernetes
    to implement multiple different deployment strategies that are critical to running
    applications at enterprise or internet scale.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 在前几章中，我们专注于 Kubernetes 资源的初始部署。启动一个新应用可能就像部署一个具有所需 Pod 副本数的 ReplicaSet，并创建一个
    Service 将传入流量路由到所需的 Pod。但现在想象一下，你有数百（或数千）客户每秒向你的应用发送数千个请求。你如何安全地部署应用的新版本？如果应用最新版本包含一个关键错误，你如何限制损害？在本章中，你将了解可以使用
    Kubernetes 实现的机制和技术，这些机制和技术对于在企业或互联网规模上运行应用至关重要。
- en: We recommend you read chapters 1, 2, and 3 before reading this chapter.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 我们建议你在阅读本章之前阅读第 1、2 和 3 章。
- en: 5.1 Deployment basics
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 5.1 部署基础
- en: In Kubernetes, you can deploy a single Pod using a manifest with PodSpec only.
    Suppose you want to deploy a set of identical Pods with guaranteed availability.
    In that case, you can define a manifest with a ReplicaSet^([1](#pgfId-1076494))
    to maintain a stable set of replica Pods running at any given time. A ReplicaSet
    is defined with the selector that specifies how to identify Pods, the number of
    replicas to be maintained, and a PodSpec. A ReplicaSet maintains the desired number
    of replicas by creating and deleting Pods as needed (figure 5.1).
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Kubernetes 中，你可以使用仅包含 PodSpec 的清单来部署单个 Pod。假设你想部署一组具有保证可用性的相同 Pod。在这种情况下，你可以定义一个包含
    ReplicaSet^([1](#pgfId-1076494)) 的清单来维护在任何给定时间运行的稳定副本 Pod 集合。ReplicaSet 使用选择器定义，该选择器指定如何识别
    Pod、要维护的副本数和 PodSpec。ReplicaSet 通过根据需要创建和删除 Pod 来维护所需的副本数（图 5.1）。
- en: ReplicaSet is not declarative ReplicaSet is not declarative and hence not suitable
    for GitOps. Section 5.1.1 will explain how ReplicaSet works and why it is not
    declarative in detail. Even though ReplicaSet is not declarative, it is still
    an important concept because the Deployment resource uses ReplicaSet objects to
    manage Pods.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: ReplicaSet 不是声明式的 ReplicaSet 不是声明式的，因此不适合 GitOps。第 5.1.1 节将详细解释 ReplicaSet 的工作原理以及为什么它不是声明式的。尽管
    ReplicaSet 不是声明式的，但它仍然是一个重要的概念，因为 Deployment 资源使用 ReplicaSet 对象来管理 Pod。
- en: Deployment^([2](#pgfId-1076501)) is a higher-level concept that leverages multiple
    ReplicaSets (figure 5.1) to provide declarative updates to Pods along with a lot
    of other useful features (section 5.1.2). Once you define the desired state in
    a Deployment manifest, the Deployment controller will continue to observe the
    actual states and update the existing state to the desired state if they are different.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: Deployment^([2](#pgfId-1076501)) 是一个更高级的概念，它利用多个 ReplicaSet（图 5.1）为 Pod 提供声明式更新，以及许多其他有用的功能（第
    5.1.2 节）。一旦你在 Deployment 清单中定义了所需状态，Deployment 控制器将持续观察实际状态，并在它们不同的情况下将现有状态更新到所需状态。
- en: '![](Images/CH05_F01_Yuen.png)'
  id: totrans-13
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F01_Yuen.png)'
- en: Figure 5.1 Deployments leverage one or more ReplicaSets to provide a declarative
    update of the application. Each ReplicaSet manages the actual number of Pods based
    on PodSpec and the number of replicas.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.1 部署利用一个或多个 ReplicaSet 为应用提供声明式更新。每个 ReplicaSet 根据 PodSpec 和副本数管理实际的 Pod
    数量。
- en: 5.1.1 Why ReplicaSet is not a good fit for GitOps
  id: totrans-15
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.1.1 为什么 ReplicaSet 不适合 GitOps
- en: 'The ReplicaSet manifest includes a selector that specifies how to identify
    Pods it manages, the number of replicas of Pods to maintain, and a Pod template
    defining how new Pods should be created to meet the desired number of replicas.
    A ReplicaSet controller will then create and delete Pods as needed to match the
    desired number specified in the manifest. As we mentioned early, ReplicaSet is
    not declarative, and we will use a tutorial to give you an in-depth understanding
    of how ReplicaSet works and why it is not declarative:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: ReplicaSet清单包括一个选择器，指定如何识别它管理的Pod，要维护的Pod副本数，以及一个Pod模板，定义如何创建新的Pod以满足所需的副本数。然后ReplicaSet控制器将根据清单中指定的所需数量创建和删除Pod。正如我们之前提到的，ReplicaSet不是声明式的，我们将通过教程深入理解ReplicaSet是如何工作的以及为什么它不是声明式的：
- en: Deploy a ReplicaSet with two Pods.
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 部署具有两个Pod的ReplicaSet。
- en: Update the image id in the manifest.
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在清单中更新镜像ID。
- en: Apply the updated manifest and observe the ReplicaSet.
  id: totrans-19
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 应用更新的清单并观察ReplicaSet。
- en: Update `replicas` to 3 in the manifest.
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在清单中更新`replicas`为3。
- en: Apply the updated manifest and observe the ReplicaSet.
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 应用更新的清单并观察ReplicaSet。
- en: If ReplicaSet is declarative, you should see three Pods with the updated image
    id.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 如果ReplicaSet是声明式的，你应该看到三个具有更新后的镜像ID的Pod。
- en: 'First, we will apply the ReplicaSet.yaml, which will create two Pods with image
    id `argoproj/rollouts-demo:blue` and a service:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们将应用ReplicaSet.yaml，这将创建两个具有镜像ID `argoproj/rollouts-demo:blue`的Pod和一个服务：
- en: '[PRE0]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '![](Images/CH05_F02_Yuen.png)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F02_Yuen.png)'
- en: Figure 5.2 Applying the ReplicaSet.yaml will create two Pods with image `argoproj/rollouts-demo:blue`.
    It also will create a `demo` service to direct traffic to the Pods.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.2 应用ReplicaSet.yaml将创建两个具有镜像`argoproj/rollouts-demo:blue`的Pod。它还将创建一个`demo`服务，将流量导向Pod。
- en: Listing 5.1  ReplicaSet.yaml
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 列表5.1  ReplicaSet.yaml
- en: '[PRE1]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: ❶ Updates replicas from 2 to 3
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将副本数量从2更新到3
- en: ❷ Updates image tag from blue to green
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 将镜像标签从blue更新到green
- en: 'After the deployment is completed, we will update the image id from `blue`
    to `green` and apply the changes:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 部署完成后，我们将更新镜像ID从`blue`更新到`green`并应用更改：
- en: '[PRE2]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Next, we can use the `kubectl` `diff` command to verify the manifest has been
    updated in Kubernetes. Then we can run `kubectl` `get` `Pods` and expect to see
    the image tag `green` instead of `blue`:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们可以使用`kubectl` `diff`命令来验证清单已在Kubernetes中更新。然后我们可以运行`kubectl` `get` `Pods`并期望看到镜像标签`green`而不是`blue`：
- en: '[PRE3]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Even though the updated manifest has been applied, the existing Pods did not
    get updated to `green`. Let’s update the `replicas` number from 2 to 3 and apply
    the manifest:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管已应用更新的清单，但现有的Pod并没有更新到`green`。让我们将`replicas`数量从2更新到3并应用清单：
- en: '[PRE4]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '![](Images/CH05_F03_Yuen.png)'
  id: totrans-37
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F03_Yuen.png)'
- en: Figure 5.3 After applying the changes, you will see that only two Pods are running
    the blue image. If ReplicaSet is declarative, all three Pods should be green.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.3 应用更改后，你会看到只有两个Pod正在运行蓝色镜像。如果ReplicaSet是声明式的，所有三个Pod都应该是绿色的。
- en: Surprisingly, the third Pod’s image tag is green, but the first two Pods remain
    blue because the ReplicaSet controller’s job is only to guarantee the number of
    running Pods. If ReplicaSet were truly declarative, the ReplicaSet controller
    should detect the changes with image tag/replicas and update all three Pods to
    green. In the next section, you will see how Deployment works and why it is declarative.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 意想不到的是，第三个Pod的镜像标签是绿色，但前两个Pod仍然是蓝色，因为ReplicaSet控制器的工作只是确保运行Pod的数量。如果ReplicaSet确实是声明式的，那么ReplicaSet控制器应该检测到镜像标签/副本数的变化，并将所有三个Pod更新为绿色。在下一节中，你将看到Deployment是如何工作的以及为什么它是声明式的。
- en: 5.1.2 How Deployment works with ReplicaSets
  id: totrans-40
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.1.2 Deployment与ReplicaSet的工作方式
- en: Deployment is fully declarative and perfectly complements GitOps. Deployment
    performs rolling updates to deploy services with zero downtime. Let’s go through
    a tutorial to examine how Deployment achieves rolling updates using multiple ReplicaSets.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: Deployment是完全声明式的，并且完美地补充了GitOps。Deployment通过滚动更新以零停机时间部署服务。让我们通过一个教程来检查Deployment是如何使用多个ReplicaSet实现滚动更新的。
- en: Rolling Updates Rolling updates allow Deployments to update with zero downtime
    by incrementally updating Pod instances with new ones. Rolling updates work great
    if your service is stateless and backward compatible. Otherwise, you will have
    to look into other deployment strategies, like blue-green, which will be covered
    in section 5.1.3.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 滚动更新 滚动更新允许Deployments通过增量更新Pod实例来无停机地更新。如果您的服务是无状态的且向后兼容，滚动更新效果很好。否则，您将不得不考虑其他部署策略，如蓝绿部署，这将在5.1.3节中介绍。
- en: 'Let’s imagine a real-life scenario of how this would be applicable. Suppose
    you run a payments service for small businesses to process credit cards. The service
    needs to be available 24/7, and you have been running two Pods (blue) to handle
    the current volume. You notice the two Pods are maxing out, so you decide to scale
    up to three Pods (blue) to support the increased traffic. Next, your product manager
    wants to add debit card support, so you need to deploy a version with three Pods
    (green) with zero downtime:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们想象一个现实生活中的场景，看看这将如何适用。假设你为小企业运行一个支付服务来处理信用卡。该服务需要 24/7 可用，你一直在运行两个 Pod（蓝色）来处理当前流量。你注意到这两个
    Pod 正在达到最大容量，因此你决定将容量扩展到三个 Pod（蓝色）以支持增加的流量。接下来，你的产品经理想要添加借记卡支持，因此你需要部署一个包含三个 Pod（绿色）的版本，且无需停机：
- en: Deploy two credit card (blue) Pods using Deployment.
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 Deployment 部署两个信用卡（蓝色）Pod。
- en: Review Deployment and ReplicaSet.
  id: totrans-45
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 查看Deployment 和 ReplicaSet。
- en: Update `replicas` from 2 to 3 and apply the manifest.
  id: totrans-46
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将 `replicas` 从 2 更改为 3 并应用清单。
- en: Review Deployment and ReplicaSet.
  id: totrans-47
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 查看Deployment 和 ReplicaSet。
- en: Update the manifest with three credit and debit card (green) Pods.
  id: totrans-48
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新清单以包含三个信用和借记卡（绿色）Pod。
- en: Review Deployment and ReplicaSet while the three Pods become green.
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在三个 Pod 变为绿色时，查看 Deployment 和 ReplicaSet。
- en: '![](Images/CH05_F04_Yuen.png)'
  id: totrans-50
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F04_Yuen.png)'
- en: Figure 5.4 In this tutorial, you will initially deploy two blue Pods. Then you
    will update/apply the manifest to three replicas. Finally, you will update/apply
    the manifest to three green Pods.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.4 在本教程中，你将最初部署两个蓝色 Pod。然后你将更新/应用清单以包含三个副本。最后，你将更新/应用清单以包含三个绿色 Pod。
- en: 'Let’s start with creating the initial Deployment. As you can see from listing
    5.2, the YAML is practically the same as listing 5.1, with changes only to line
    2 to use Deployment instead of ReplicaSet:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从创建初始 Deployment 开始。正如你从列表 5.2 中可以看到，YAML 实际上与列表 5.1 几乎相同，只是第 2 行将 ReplicaSet
    更改为 Deployment：
- en: '[PRE5]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Listing 5.2  deployment.yaml
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.2  deployment.yaml
- en: '[PRE6]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: ❶ replicas initially set to 2
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 初始副本数设置为 2
- en: ❷ Image tag initially set to blue
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 初始镜像标签设置为 blue
- en: ❸ Service demo initially set to send traffic only to Pods with label app:demo
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 服务 demo 初始设置为仅将流量发送到带有标签 app:demo 的 Pod
- en: 'Let’s review what was created after we applied the Deployment manifest:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们回顾一下应用 Deployment 清单后创建的内容：
- en: '[PRE7]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: ❶ Two running Pods
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 两个正在运行的 Pod
- en: ❷ One demo Deployment
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 一个名为 demo 的 demo Deployment
- en: ❸ One ReplicaSet demo-8656dbfdc5
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 一个名为 demo-8656dbfdc5 的 ReplicaSet
- en: ❹ The demo Deployment creates the ReplicaSet demo-8656dbfdc5.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ demo Deployment 创建了名为 demo-8656dbfdc5 的 ReplicaSet。
- en: ❺ ReplicaSet demo-8656dbfdc5 uses image id argoproj/rollouts-demo:blue.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ ReplicaSet demo-8656dbfdc5 使用镜像 id argoproj/rollouts-demo:blue。
- en: 'As expected, we have one Deployment and one ReplicaSet demo-8656dbfdc5 created
    and controlled by the `demo` deployment. ReplicaSet demo-8656dbfdc5 manages two
    replicas of Pods with the `blue` image. Next, we will update the manifest with
    three replicas and review the changes:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 如预期，我们创建并控制了一个名为 `demo` 的部署和一个名为 demo-8656dbfdc5 的 ReplicaSet。ReplicaSet demo-8656dbfdc5
    管理着两个带有 `blue` 图像的 Pod 副本。接下来，我们将更新清单以包含三个副本并查看更改：
- en: '[PRE8]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: After the update, we should see the same Deployment and ReplicaSet that now
    manages the three blue Pods. At this point, the Deployment looks precisely as
    is depicted in figure 5.5\. Next, we will update the manifest to image green and
    apply the changes. Since the image id has changed, Deployment will then create
    a second ReplicaSet to deploy the green image.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 更新后，我们应该看到相同的 Deployment 和 ReplicaSet，现在管理着三个蓝色 Pod。此时，Deployment 的外观与图 5.5
    中描述的完全一致。接下来，我们将更新清单以使用绿色镜像并应用更改。由于镜像 id 已更改，Deployment 将创建第二个 ReplicaSet 来部署绿色镜像。
- en: Deployment and ReplicaSets A Deployment will create one ReplicaSet per image
    id and set the number of replicas to the desired value in the ReplicaSet with
    the matching image id. For all other ReplicaSets, Deployment will set those ReplicaSets’
    replica numbers to 0 to terminate all nonmatching image id Pods.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: Deployment 和 ReplicaSets Deployment 会为每个镜像 id 创建一个 ReplicaSet，并将副本数设置为 ReplicaSet
    中匹配的镜像 id 的期望值。对于所有其他 ReplicaSet，Deployment 将将这些 ReplicaSet 的副本数设置为 0 以终止所有不匹配的镜像
    id 的 Pod。
- en: '![](Images/CH05_F05_Yuen.png)'
  id: totrans-70
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F05_Yuen.png)'
- en: Figure 5.5 Deployment uses ReplicaSet V1 to maintain the blue deployment. If
    there is a change to the nonblue image, Deployment will create ReplicaSet V2 for
    the new deployment.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.5 Deployment 使用 ReplicaSet V1 来维护蓝色部署。如果非蓝色镜像发生更改，Deployment 将为新的部署创建 ReplicaSet
    V2。
- en: 'Before you apply the change, you can open up a new terminal with the following
    command to monitor the status of ReplicaSets. You should see one ReplicaSet (blue)
    with three Pods:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 在应用更改之前，您可以使用以下命令打开一个新的终端来监控ReplicaSet的状态。您应该看到一个包含三个Pod的ReplicaSet（蓝色）：
- en: '[PRE9]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Go back to the original terminal, update the deployment, and apply the changes:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 返回原始终端，更新部署并应用更改：
- en: '[PRE10]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Now switch to the terminal, and you should see the ReplicaSet demo-8656dbfdc5
    (blue) scaled down to 0 and a new ReplicaSet demo-6b574cb9dd (green) scaled up
    to 3:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 现在切换到终端，您应该看到ReplicaSet demo-8656dbfdc5（蓝色）缩小到0，一个新的ReplicaSet demo-6b574cb9dd（绿色）扩大到3：
- en: '[PRE11]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: ❶ Blue ReplicaSet began with three Pods
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 蓝色ReplicaSet开始时包含三个Pod
- en: ❷ Green ReplicaSet scaled up with one Pod
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 绿色ReplicaSet增加一个Pod
- en: ❸ Green ReplicaSet completed with three Pods
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 绿色ReplicaSet完成，包含三个Pod
- en: ❹ Blue ReplicaSet completed with zero Pods
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 蓝色ReplicaSet完成，没有Pod。
- en: Let’s review what is happening here. Deployment uses the second ReplicaSet,
    demo-6b574cb9dd, to bring up one green Pod and uses the first ReplicaSet, demo-8656dbfdc5,
    to terminate one of the blue Pods, as depicted in figure 5.6\. This process will
    repeat until all three green Pods are created while all blue Pods are terminated.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们回顾一下这里发生了什么。Deployment使用第二个ReplicaSet，demo-6b574cb9dd，来启动一个绿色的Pod，并使用第一个ReplicaSet，demo-8656dbfdc5，来终止一个蓝色的Pod，如图5.6所示。这个过程将重复进行，直到创建所有三个绿色的Pod，同时终止所有蓝色的Pod。
- en: '![](Images/CH05_F06_Yuen.png)'
  id: totrans-83
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F06_Yuen.png)'
- en: Figure 5.6 Deployment scales down ReplicaSet V1 and scales up ReplicaSet V2\.
    ReplicaSet V1 will have zero Pods, and ReplicaSet V2 will have three green Pods
    when the process is complete.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.6 部署缩小ReplicaSet V1并扩大ReplicaSet V2。当过程完成后，ReplicaSet V1将没有Pod，而ReplicaSet
    V2将包含三个绿色的Pod。
- en: 'While we are discussing Deployment, we should also cover two important configuration
    parameters with the rolling-update strategy in Deployment: `max` `unavailable`
    and `max` `surge`. Let’s review the default settings and what they mean according
    to the Kubernetes documentation:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们在讨论Deployment时，我们还应该介绍Deployment中滚动更新策略的两个重要配置参数：`max unavailable`和`max surge`。让我们回顾默认设置以及根据Kubernetes文档它们的意义：
- en: '[PRE12]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Deployment ensures that only a certain number of Pods are down while they are
    being updated. By default, it ensures that at least 75% of the desired number
    of Pods are up (25% max unavailable).
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: Deployment确保在更新期间只有一定数量的Pod处于关闭状态。默认情况下，它确保至少75%的期望Pod数量处于运行状态（最大不可用25%）。
- en: Deployment also ensures that only a certain number of Pods are created above
    the desired number of Pods. By default, it ensures that at most 125% of the desired
    number of Pods are up (25% max surge).
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: Deployment还确保创建的Pod数量不超过期望的数量。默认情况下，它确保最多有125%的期望Pod数量处于运行状态（最大激增25%）。
- en: 'Let’s see how it works in action. We will change the image id back to blue
    and configure `max` `unavailable` to 3 and `max` `surge` to 3:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看它是如何实际工作的。我们将将镜像ID改回蓝色，并将`max unavailable`配置为3，`max surge`也配置为3：
- en: '[PRE13]'
  id: totrans-90
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Now you can switch back to the terminal with ReplicaSet monitoring:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您可以切换回带有ReplicaSet监控的终端：
- en: '[PRE14]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: ❶ Green ReplicaSet immediately went to zero Pods.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 绿色ReplicaSet立即变为零Pod。
- en: ❷ Blue ReplicaSet scaled up three Pods at once.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 蓝色ReplicaSet一次扩大三个Pod。
- en: As you can see from the ReplicaSet change status, ReplicaSet demo-8656dbfdc5
    (green) immediately went to zero Pods and ReplicaSet demo-6b574cb9dd (blue) immediately
    went to three instead of one at a time.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 如您从ReplicaSet更改状态中看到的，ReplicaSet demo-8656dbfdc5（绿色）立即变为零Pod，而ReplicaSet demo-6b574cb9dd（蓝色）立即变为三个，而不是一个一个地。
- en: Listing 5.3  deployment2.yaml
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 列表5.3 deployment2.yaml
- en: '[PRE15]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: ❶ Creates up to three Pods at once
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 一次创建最多三个Pod
- en: ❷ Terminates up to three Pods at once
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 一次终止最多三个Pod。
- en: ❸ Service demo will send traffic to all Pods with label app:demo.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 服务demo将流量发送到所有带有标签app:demo的Pod。
- en: By now, you can see that Deployment achieves deployment with zero downtime by
    leveraging one ReplicaSet for blue and another ReplicaSet for green. As you learn
    about other deployment strategies in the rest of the chapter, you will discover
    that they are all implemented similarly using two different ReplicaSets to achieve
    the desired motivation.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，您可以看到Deployment通过利用一个ReplicaSet用于蓝色，另一个ReplicaSet用于绿色，实现了零停机时间部署。当您在本章的其余部分了解其他部署策略时，您会发现它们都是通过使用两个不同的ReplicaSet以类似的方式实现的，以达到预期的目标。
- en: 5.1.3 Traffic routing
  id: totrans-102
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.1.3 流量路由
- en: In Kubernetes, a Service is an abstraction that defines a logical set of Pods
    and a policy to access them. The set of Pods targeted by a Service is determined
    by a selector that is a field within the Service manifest. Service will then forward
    traffic to Pods with the matching labels as specified by the selector (also see
    listings 5.2 and 5.3). Service does round-robin load balancing and works great
    for rolling updates if the underlying Pods are stateless and backward compatible.
    If you need to customize load balancing for your deployment, you will need to
    explore other routing alternatives.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Kubernetes 中，服务是一个抽象，它定义了一组 Pods 和访问它们的策略。服务针对的 Pods 集合由服务清单中的一个选择器字段确定。然后，服务将流量转发到与选择器指定的标签匹配的
    Pods（也参见列表 5.2 和 5.3）。服务执行轮询负载均衡，如果底层 Pods 无状态且向后兼容，则效果很好。如果您需要为您的部署自定义负载均衡，您将需要探索其他路由替代方案。
- en: '![](Images/CH05_F07_Yuen.png)'
  id: totrans-104
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F07_Yuen.png)'
- en: Figure 5.7 A service will only route traffic to Pods with matching labels. In
    this example, Service blue will only route traffic to Pods with the label blue.
    Service green will only route traffic to Pods with the label green.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.7 服务只会将流量路由到具有匹配标签的 Pods。在这个例子中，服务蓝只会将流量路由到带有标签 blue 的 Pods。服务绿只会将流量路由到带有标签
    green 的 Pods。
- en: NGINX Ingress Controller^([3](#pgfId-1076934)) can be used for many use cases
    and supports various balancing and routing rules. Ingress Controller can be configured
    as the front load balancer to perform custom routing such as TLS termination,
    URL rewrite, or routing traffic to any number of services by defining the custom
    rules. Figure 5.8 illustrates the NGINX controller configured with rules to send
    40% of incoming traffic to service blue and 60% of incoming traffic to service
    green.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: NGINX 入口控制器^([3](#pgfId-1076934)) 可以用于许多用例，并支持各种平衡和路由规则。入口控制器可以被配置为前端负载均衡器，执行自定义路由，例如
    TLS 终止、URL 重写或通过定义自定义规则将流量路由到任意数量的服务。图 5.8 展示了配置了规则的 NGINX 控制器，将 40% 的入站流量发送到服务蓝，60%
    的入站流量发送到服务绿。
- en: '![](Images/CH05_F08_Yuen.png)'
  id: totrans-107
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F08_Yuen.png)'
- en: Figure 5.8 NGINX Ingress Controller can provide advanced traffic control. In
    this example, NGINX Ingress Controller is configured with one rule to send 40%
    of traffic to service blue and a second rule to send 60% of traffic to service
    green.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.8 NGINX 入口控制器可以提供高级流量控制。在这个例子中，NGINX 入口控制器配置了一条规则，将 40% 的流量发送到服务蓝，以及另一条规则将
    60% 的流量发送到服务绿。
- en: Istio Gateway^([4](#pgfId-1076947)) is a load balancer operating at the Kubernetes
    cluster’s edge, receiving incoming or outgoing HTTP/TCP connections. The specification
    describes a set of ports that should be exposed, the type of protocol to use,
    and custom routing configuration. Istio Gateway will direct the incoming traffic
    to the back services (40% to service blue, 60% to service green) based on the
    custom configuration (figure 5.9).
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: Istio 网关^([4](#pgfId-1076947)) 是在 Kubernetes 集群边缘运行的负载均衡器，接收传入或传出的 HTTP/TCP
    连接。规范描述了一组应公开的端口、要使用的协议类型以及自定义路由配置。根据自定义配置（图 5.9），Istio 网关将传入流量定向到后端服务（40% 到服务蓝，60%
    到服务绿）。
- en: '![](Images/CH05_F09_Yuen.png)'
  id: totrans-110
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F09_Yuen.png)'
- en: Figure 5.9 Istio Gateway is another load balancer that supports rich configuration
    for traffic routing. A custom configuration is defined to send 40% of traffic
    to the blue service and 60% of traffic to the green service in this example.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.9 Istio 网关是另一个支持丰富流量路由配置的负载均衡器。在这个例子中，定义了一个自定义配置，将 40% 的流量发送到蓝服务，60% 的流量发送到绿服务。
- en: Note Both NGINX Ingress Controller and Istio Gateway are advanced topics and
    beyond the scope of this book. Please refer to the links in the footnotes for
    additional information.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：NGINX 入口控制器和 Istio 网关都是高级主题，超出了本书的范围。请参阅脚注中的链接以获取更多信息。
- en: 5.1.4 Configuring minikube for other strategies
  id: totrans-113
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.1.4 为其他策略配置 minikube
- en: For the rest of the tutorial, you will need to enable NGINX ingress and Argo
    Rollouts^([5](#pgfId-1076965)) support in your Kubernetes cluster.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 在本教程的剩余部分，您需要在您的 Kubernetes 集群中启用 NGINX 入口和 Argo Rollouts^([5](#pgfId-1076965))
    支持。
- en: Argo Rollouts The Argo Rollouts controller uses the Rollout custom resource
    to provide additional deployment strategies such as blue-green and canary to Kubernetes.
    The Rollout custom resource provides feature parity with the deployment resource
    but with additional deployment strategies.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: Argo Rollouts Argo Rollouts 控制器使用 Rollout 自定义资源来为 Kubernetes 提供额外的部署策略，例如蓝绿和金丝雀部署。Rollout
    自定义资源提供了与部署资源相同的功能，但增加了额外的部署策略。
- en: 'With minikube,^([6](#pgfId-1076972)) you can enable NGINX ingress support simply
    by running the following command:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 minikube，^([6](#pgfId-1076972)) 你可以通过运行以下命令来启用 NGINX 入口支持：
- en: '[PRE16]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: To install Argo Rollouts in your cluster, you need to create an `argo-rollouts`
    Namespace and run install.yaml. For other environments, please refer to the Argo
    Rollouts Getting Started guide:^([7](#pgfId-1076982))
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 要在您的集群中安装 Argo Rollouts，您需要创建一个 `argo-rollouts` 命名空间并运行 install.yaml。对于其他环境，请参阅
    Argo Rollouts 入门指南:^([7](#pgfId-1076982))
- en: '[PRE17]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 5.2 Blue-green
  id: totrans-120
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 5.2 蓝绿
- en: As you learned in section 5.1, Deployment’s Rolling Update is a great way to
    update applications because your app will use about the same amount of resources
    during a deployment with zero downtime and minimal impact on performance. However,
    there are many legacy applications out there that don't work well with rolling
    updates due to backward incompatibility or statefulness. Some applications may
    also require deploying a new version and cutting over to it right away or fast
    rollback in case of issues.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 正如你在 5.1 节中学到的，部署的滚动更新是一种很好的更新应用程序的方法，因为你的应用程序在部署期间将使用大约相同数量的资源，实现零停机时间和对性能的最小影响。然而，由于向后不兼容或状态性，许多遗留应用程序与滚动更新不兼容。一些应用程序可能还需要立即部署新版本或快速回滚以解决可能出现的问题。
- en: For these use cases, a blue-green deployment will be the appropriate deployment
    strategy. Blue-green deployment accomplishes these motivations by having two deployments
    fully scale at the same time, but only direct incoming traffic to one of the two
    deployments.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这些用例，蓝绿部署将是适当的部署策略。蓝绿部署通过同时完全扩展两个部署来实现这些动机，但只将入站流量定向到这两个部署中的一个。
- en: Note In this tutorial, we will use NGINX Ingress Controller to route 100% of
    traffic to either the blue or green deployment since the built-in Kubernetes Service^([8](#pgfId-1077010))
    only manipulates the iptables^([9](#pgfId-1077014)) and does not reset the existing
    connection to the Pods and therefore is not suitable for blue-green deployment.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 注意 在本教程中，我们将使用 NGINX Ingress Controller 将 100% 的流量路由到蓝色或绿色部署，因为内置的 Kubernetes
    服务^([8](#pgfId-1077010)) 只操作 iptables^([9](#pgfId-1077014)) 并不会重置到 Pods 的现有连接，因此不适合蓝绿部署。
- en: '![](Images/CH05_F10_Yuen.png)'
  id: totrans-124
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F10_Yuen.png)'
- en: Figure 5.10 The initial deployment will configure NGINX Controller to send all
    traffic to the blue service. The blue service will in turn send traffic to the
    blue Pods.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.10 初始部署将配置 NGINX Controller 以将所有流量发送到蓝色服务。蓝色服务将反过来将流量发送到蓝色 Pods。
- en: '![](Images/CH05_F11_Yuen.png)'
  id: totrans-126
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F11_Yuen.png)'
- en: Figure 5.11 After the configuration update in the NGINX controller, all traffic
    will be sent to the green service. The green service will in turn send traffic
    to the green Pods.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.11 在 NGINX 控制器配置更新后，所有流量都将发送到绿色服务。绿色服务将反过来将流量发送到绿色 Pods。
- en: 5.2.1 Blue-green with Deployment
  id: totrans-128
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.2.1 使用 Deployment 的蓝绿部署
- en: In this tutorial, we will perform a blue-green deployment using native Kubernetes
    Deployment and Service.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 在本教程中，我们将使用原生的 Kubernetes Deployment 和 Service 执行蓝绿部署。
- en: Note Please refer to section 5.1.4 on how to enable ingress and install Argo
    Rollouts in your Kubernetes cluster prior to this tutorial.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 注意 请参考本教程之前 5.1.4 节中如何启用入口和在您的 Kubernetes 集群中安装 Argo Rollouts 的说明。
- en: Create a blue deployment and service.
  id: totrans-131
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建蓝色部署和服务。
- en: Create ingress to direct traffic to the blue service.
  id: totrans-132
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建入口以将流量定向到蓝色服务。
- en: View the application in the browser (blue).
  id: totrans-133
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在浏览器中查看应用程序（蓝色）。
- en: Deploy a green deployment and service, and wait for all Pods to be ready.
  id: totrans-134
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 部署绿色部署和服务，并等待所有 Pods 准备就绪。
- en: Update ingress to direct traffic to the green service.
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新入口以将流量定向到绿色服务。
- en: View the web page again in the browser (green).
  id: totrans-136
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 再次在浏览器中查看网页（绿色）。
- en: 'We will first create the blue deployment by applying the blue_deployment.yaml:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将首先通过应用 blue_deployment.yaml 创建蓝色部署：
- en: '[PRE18]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: '![](Images/CH05_F12_Yuen.png)'
  id: totrans-139
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F12_Yuen.png)'
- en: Figure 5.12 Create the initial state with a blue service and deployment along
    with NGINX Ingress Controller directing traffic to the blue service. Then create
    the green service and deployment with the configuration change to NGINX Ingress
    Controller to direct traffic to the green service.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.12 使用蓝色服务和部署以及 NGINX Ingress Controller 将流量定向到蓝色服务创建初始状态。然后创建绿色服务和部署，并通过更改
    NGINX Ingress Controller 的配置将流量定向到绿色服务。
- en: Listing 5.4  blue_deployment.yaml
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.4  blue_deployment.yaml
- en: '[PRE19]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Now we can expose an ingress controller, so the `blue` service is accessible
    from your browser by applying blue_ingress.yaml. The `kubectl` `get` `ingress`
    command will return the ingress controller hostname and IP address:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们可以公开一个入口控制器，通过应用 blue_ingress.yaml，`blue` 服务可以通过你的浏览器访问。`kubectl get ingress`
    命令将返回入口控制器的主机名和 IP 地址：
- en: '[PRE20]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: Note NGINX Ingress Controller will only intercept traffic with the hostname
    defined in the custom rule. Please make sure you add demo.info and its IP address
    to your /etc/hosts.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 注意 NGINX Ingress Controller 将仅拦截自定义规则中定义的主机名的流量。请确保你将 demo.info 及其 IP 地址添加到你的
    /etc/hosts。
- en: Listing 5.5  blue_ingress.yaml
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.5  blue_ingress.yaml
- en: '[PRE21]'
  id: totrans-147
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: ❶ Assigns the hostname demo.info for the ingress controller
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 为入口控制器分配主机名 demo.info
- en: ❷ Routes all traffic
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 路由所有流量
- en: ❸ Routes traffic to blue-service at port 80
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 将流量路由到 80 端口的蓝色服务
- en: ❹ ConfigMap for customizing the headers control in NGINX
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 用于自定义 NGINX 中头部控制的 ConfigMap
- en: ❺ Enables the return of the header server from the backend instead of the generic
    NGINX string
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 启用从后端返回头部服务器而不是通用的 NGINX 字符串
- en: ❻ Passes the incoming X-Forwarded-* headers to upstreams
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 将传入的 X-Forwarded-* 头部传递给上游
- en: Once you have the ingress controller, blue service, and deployment created and
    have updated /etc/hosts with demo.info and the correct IP address, you can enter
    the URL demo.info and see the blue service running.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你创建了入口控制器、蓝色服务和部署，并更新了 /etc/hosts 中的 demo.info 和正确的 IP 地址，你就可以输入 URL demo.info
    并看到蓝色服务正在运行。
- en: Note The demo app will continue to call the active service in the background
    and show the latest results on the right side. Blue (darker gray in print) is
    the running version, and green (lighter gray in print) is the new version.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：演示应用程序将继续在后台调用活动服务并显示右侧的最新结果。蓝色（打印中的较深灰色）是运行版本，绿色（打印中的较浅灰色）是新版本。
- en: '![](Images/CH05_F13_Yuen.png)'
  id: totrans-156
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F13_Yuen.png)'
- en: Figure 5.13 The HTML page will refresh every two seconds in the bar chart and
    every 100 milliseconds in the bubble chart to show either the blue or green service
    responding. Initially, the HTML page will show all blue because all traffic goes
    to the blue deployment.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.13 HTML 页面将在柱状图中每两秒刷新一次，在气泡图中每 100 毫秒刷新一次，以显示蓝色或绿色服务响应。最初，HTML 页面将显示所有蓝色，因为所有流量都流向蓝色部署。
- en: 'Now we are ready to deploy the new green version. Let’s apply green_deployment
    .yaml to create the green service and deployment:'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们准备部署新的绿色版本。让我们应用 green_deployment.yaml 来创建绿色服务和部署：
- en: '[PRE22]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Listing 5.6  green_deployment.yaml
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.6  green_deployment.yaml
- en: '[PRE23]'
  id: totrans-161
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'With the green service and deployment ready, we can now update the ingress
    controller to route traffic to the green service:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 绿色服务和部署准备就绪后，我们现在可以更新入口控制器以将流量路由到绿色服务：
- en: '[PRE24]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Listing 5.7  green_ingress.yaml
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.7  green_ingress.yaml
- en: '[PRE25]'
  id: totrans-165
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: ❶ Routes traffic to green-service instead of blue-service
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将流量路由到绿色服务而不是蓝色服务
- en: If you go back to your browser, you should see the service turning green!
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你回到你的浏览器，你应该看到服务正在变绿！
- en: '![](Images/CH05_F14_Yuen.png)'
  id: totrans-168
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F14_Yuen.png)'
- en: Figure 5.14 After the green deployment is complete and NGINX Ingress Controller
    is updated to direct traffic to the green deployment, the HTML page will start
    showing both the bubble and bar charts in green.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.14 绿色部署完成后，将 NGINX Ingress Controller 更新为指向绿色部署后，HTML 页面将开始显示绿色气泡和柱状图。
- en: If you are happy with the deployment, you can either delete the blue service
    and deployment or scale down the blue deployment to 0.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你满意部署，你可以删除蓝色服务及其部署，或者将蓝色部署缩放到 0。
- en: Exercise 5.1
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 练习 5.1
- en: How would you scale down the blue deployment in a declarative way?
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 你会如何以声明式的方式缩小蓝色部署？
- en: Exercise 5.2
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 练习 5.2
- en: If you want a fast rollback, should you delete the deployment or scale it down
    to 0?
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想快速回滚，你应该删除部署还是将其缩放到 0？
- en: 5.2.2 Blue-green with Argo Rollouts
  id: totrans-175
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.2.2 使用 Argo Rollouts 的蓝绿部署
- en: Blue-green deployment is definitely doable in production using the native Kubernetes
    Deployment with additional process and automation. A better approach is to make
    the entire blue-green deployment process fully automated and declarative; hence,
    Argo Rollouts is born.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 蓝绿部署肯定可以在生产中使用本地的 Kubernetes Deployment 通过额外的流程和自动化来实现。更好的方法是使整个蓝绿部署过程完全自动化和声明式；因此，Argo
    Rollouts 应运而生。
- en: Argo Rollouts introduces a new custom resource called `Rollout` to provide additional
    deployment strategies such as blue-green, canary (section 5.3), and progressive
    delivery (section 5.4) to Kubernetes. The `Rollout` custom resource provides feature
    parity with the Deployment resource with additional deployment strategies. In
    the next tutorial, you will see how simple it is to deploy blue-green with Argo
    Rollouts.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: Argo Rollouts 引入了一个名为 `Rollout` 的新自定义资源，为 Kubernetes 提供了额外的部署策略，如蓝绿、金丝雀（第 5.3
    节）和渐进式交付（第 5.4 节）。`Rollout` 自定义资源提供了与 Deployment 资源相同的功能，并增加了额外的部署策略。在下一教程中，你将看到使用
    Argo Rollouts 部署蓝绿是多么简单。
- en: Note Please refer to section 5.1.4 on how to enable ingress and install Argo
    Rollouts in your Kubernetes cluster prior to this tutorial.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：请参考本教程之前的 5.1.4 节，了解如何启用入口并在你的 Kubernetes 集群中安装 Argo Rollouts。
- en: Deploy the NGINX Ingress Controller.
  id: totrans-179
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 部署 NGINX 入口控制器。
- en: Deploy the production service and (blue) deployment using Argo Rollouts.
  id: totrans-180
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 Argo Rollouts 部署生产服务和（蓝色）部署。
- en: Update the manifest to use the green image.
  id: totrans-181
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新清单以使用绿色镜像。
- en: Apply the updated manifest to deploy the new green version.
  id: totrans-182
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 应用更新的清单以部署新的绿色版本。
- en: 'First, we will create the ingress controller, `demo-service`, and blue deployment:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们将创建入口控制器、`demo-service` 和蓝色部署：
- en: '[PRE26]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Listing 5.8  ingress.yaml
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.8  ingress.yaml
- en: '[PRE27]'
  id: totrans-186
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Listing 5.9  bluegreen_rollout.yaml
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.9  bluegreen_rollout.yaml
- en: '[PRE28]'
  id: totrans-188
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: ❶ Specifies the kind to be Rollout instead of Deployment
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 指定类型为 Rollout 而不是 Deployment
- en: ❷ Sets initial deployment with blue image
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 使用蓝色镜像设置初始部署
- en: ❸ Uses blue-green instead of rolling updates as deployment strategy
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 使用蓝绿部署策略而不是滚动更新
- en: ❹ Automatically updates the selector in the demo-service to send all traffic
    to green Pods
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 自动更新 demo-service 中的选择器，将所有流量发送到绿色 Pods
- en: ❺ Specifies the demo-service to front traffic for this rollout object
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 指定 demo-service 为此滚动对象的前端流量
- en: Note Argo Rollouts internally will maintain one ReplicaSet for blue and one
    ReplicaSet for green. It will also ensure that the green deployment is fully scaled
    before updating the service selector to send all traffic over to green. (Hence,
    only one service is required in this case.) In addition, Argo Rollouts will also
    wait 30 seconds for all blue traffic to complete and scale down the blue deployment.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：Argo Rollouts 内部将维护一个用于蓝色和一个用于绿色的 ReplicaSet。它还将确保在更新服务选择器以将所有流量发送到绿色之前，绿色部署已完全扩展。（因此，在这种情况下只需要一个服务。）此外，Argo
    Rollouts 还将等待 30 秒，以确保所有蓝色流量完成并缩小蓝色部署。
- en: '![](Images/CH05_F15_Yuen.png)'
  id: totrans-195
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F15_Yuen.png)'
- en: Figure 5.15 Argo Rollouts is similar to a Deployment that uses one or more ReplicaSets
    to fulfill deployment requests. In the initial state, Argo Rollouts creates ReplicaSet
    V1 for blue Pods.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.15 Argo Rollouts 与使用一个或多个 ReplicaSet 来满足部署请求的 Deployment 类似。在初始状态下，Argo
    Rollouts 为蓝色 Pods 创建 ReplicaSet V1。
- en: Once you have the ingress controller, service, and deployment created and updated
    /etc/hosts, you can enter the URL demo.info and see the blue service running.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦创建了入口控制器、服务以及更新了 /etc/hosts，你就可以输入 URL demo.info 来查看正在运行的蓝色服务。
- en: Note NGINX Ingress Controller will only intercept traffic with the hostname
    defined in the custom rule. Please make sure you add demo.info and its IP address
    to your /etc/hosts.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：NGINX 入口控制器只会拦截自定义规则中定义的主机名的流量。请确保你将 demo.info 及其 IP 地址添加到你的 /etc/hosts 中。
- en: '![](Images/CH05_F16_Yuen.png)'
  id: totrans-199
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F16_Yuen.png)'
- en: Figure 5.16 Argo Rollouts creates ReplicaSet V2 for green Pods. Once all green
    Pods are up and running, Argo Rollouts automatically scales down all blue Pods.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.16 Argo Rollouts 为绿色 Pods 创建 ReplicaSet V2。一旦所有绿色 Pods 都启动并运行，Argo Rollouts
    将自动缩小所有蓝色 Pods。
- en: 'Now we will update the manifest to deploy the new version, green. Once you
    have applied the updated manifest, you can go back to your browser and see all
    bars and dots turning green (figure 5.16):'
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们将更新清单以部署新版本，绿色。一旦你应用了更新的清单，你就可以回到浏览器中，看到所有条形和点都变成了绿色（图 5.16）：
- en: '[PRE29]'
  id: totrans-202
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 5.3 Canary
  id: totrans-203
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 5.3 金丝雀
- en: Canary deployment is a technique to reduce the risk of introducing a new software
    version in production by rolling out the change to a small subset of users for
    a short period before making it available to everybody. Canary acts as an early
    indicator for failures to avoid problematic deployments having a full impact on
    all customers at once. If one canary deployment fails, the rest of your servers
    aren’t affected, and you can simply terminate the canary and triage the problems.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 金丝雀部署是一种技术，通过在将新软件版本提供给所有用户之前，先对一小部分用户进行短期部署来降低在生产环境中引入新软件版本的风险。金丝雀作为故障的早期指标，可以避免有问题的部署一次性对所有客户造成全面影响。如果一个金丝雀部署失败，其他服务器不会受到影响，你可以简单地终止金丝雀并对问题进行分类。
- en: Note Based on our experience, most production incidents are due to a change
    in the system, such as a new deployment. Canary deployment is another opportunity
    to test your new release before the new release reaches all user populations.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：根据我们的经验，大多数生产事件都是由于系统中的更改，例如新的部署。金丝雀部署是在新版本达到所有用户群体之前测试新发布的另一个机会。
- en: Our canary example is similar to the blue-green example.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的金丝雀示例与蓝绿示例类似。
- en: '![](Images/CH05_F17_Yuen.png)'
  id: totrans-207
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F17_Yuen.png)'
- en: Figure 5.17 The ingress controller will front both blue and green services,
    but in this case, 90% of traffic will go to the blue (production) service, and
    10% will go to the green (canary) service. Since green is only getting 10% of
    the traffic, we will only scale up one green Pod to minimize resource usage.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.17 入口控制器将同时面向蓝色和绿色服务，但在此情况下，90% 的流量将流向蓝色（生产）服务，10% 将流向绿色（金丝雀）服务。由于绿色服务只获得
    10% 的流量，因此我们只扩容一个绿色 Pod 以最小化资源使用。
- en: With Canary running and getting production traffic, we can then monitor the
    canary health (latency, error, and so on) for a fixed period (such as one hour)
    to determine whether to scale up green deployment and route all traffic to the
    green service or route all traffic back to the blue service and terminate the
    green Pod in case of issues.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 当金丝雀运行并获取生产流量时，我们可以在固定时间段（例如一小时）内监控金丝雀的健康状况（延迟、错误等），以确定是否扩容绿色部署并将所有流量路由到绿色服务，或者在没有问题的情况下将所有流量路由回蓝色服务并终止绿色
    Pod。
- en: '![](Images/CH05_F18_Yuen.png)'
  id: totrans-210
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F18_Yuen.png)'
- en: Figure 5.18 If there is no error with the canary Pod, green deployment will
    scale up to three Pods and receive 100% of the production traffic.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.18 如果金丝雀 Pod 没有错误，绿色部署将扩容到三个 Pod 并接收 100% 的生产流量。
- en: 5.3.1 Canary with Deployment
  id: totrans-212
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.3.1 使用 Deployment 的金丝雀
- en: In this tutorial, we will perform a canary deployment using native Kubernetes
    Deployment and Service.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 在本教程中，我们将使用原生的 Kubernetes Deployment 和 Service 执行金丝雀部署。
- en: Note Please refer to section 5.1.4 on how to enable ingress and install Argo
    Rollouts in your Kubernetes cluster prior to this tutorial.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：请在本教程之前参考 5.1.4 节了解如何启用入口并在您的 Kubernetes 集群中安装 Argo Rollouts。
- en: Create the blue deployment and service (Production).
  id: totrans-215
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建蓝色部署和服务（生产）。
- en: Create ingress to direct traffic to the blue service.
  id: totrans-216
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建入口以将流量导向蓝色服务。
- en: View the application in the browser (blue).
  id: totrans-217
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在浏览器中查看应用程序（蓝色）。
- en: Deploy the green deployment (one Pod) and service, and wait for all Pods to
    be ready.
  id: totrans-218
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 部署绿色部署（一个 Pod）和服务，并等待所有 Pod 准备就绪。
- en: Create the canary ingress to direct 10% of traffic to the green service.
  id: totrans-219
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建金丝雀入口，将 10% 的流量导向绿色服务。
- en: View the web page again in the browser (10% green with no error).
  id: totrans-220
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 再次在浏览器中查看网页（10% 绿色且无错误）。
- en: Scale up the green deployment to three Pods.
  id: totrans-221
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将绿色部署扩容到三个 Pod。
- en: Update the canary ingress to send 100% of traffic to the green service.
  id: totrans-222
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新金丝雀入口以将 100% 的流量发送到绿色服务。
- en: Scale down the blue deployment to 0.
  id: totrans-223
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将蓝色部署缩放到 0。
- en: 'We can create the production deployment by applying blue_deployment.yaml (listing
    5.4):'
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过应用 blue_deployment.yaml（列表 5.4）来创建生产部署：
- en: '[PRE30]'
  id: totrans-225
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Now we can expose an ingress controller so the blue service is accessible from
    our browser by applying the blue_ingress.yaml (listing 5.5). The `kubectl` `get`
    `ingress` command will return the ingress controller hostname and IP address:'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们可以通过应用 blue_ingress.yaml（列表 5.5）来公开入口控制器，这样我们就可以通过浏览器访问蓝色服务：`kubectl get
    ingress` 命令将返回入口控制器的主机名和 IP 地址：
- en: '[PRE31]'
  id: totrans-227
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: Note NGINX Ingress Controller will only intercept traffic with the hostname
    defined in the custom rule. Please make sure you add demo.info and its IP address
    to your /etc/hosts.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：NGINX 入口控制器只会拦截自定义规则中定义的主机名的流量。请确保您已将 demo.info 及其 IP 地址添加到您的 /etc/hosts。
- en: Once you have the ingress controller, blue service, and deployment created and
    have updated /etc/hosts with demo.info and the correct IP address, you can enter
    the URL demo.info and see the blue service running.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦创建了入口控制器、蓝色服务和部署，并已更新 /etc/hosts 中的 demo.info 和正确的 IP 地址，你就可以输入 URL demo.info
    并看到蓝色服务正在运行。
- en: 'Now we are ready to deploy the new green version. Let’s apply green_deployment.yaml
    to create the green service and deployment:'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经准备好部署新的绿色版本。让我们应用 green_deployment.yaml 来创建绿色服务和部署：
- en: '[PRE32]'
  id: totrans-231
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: Listing 5.10  green_deployment.yaml
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.10  green_deployment.yaml
- en: '[PRE33]'
  id: totrans-233
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: ❶ ReplicaSet is set to 1 for the initial green deployment.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 初始绿色部署的 ReplicaSet 设置为 1。
- en: 'Next, we will create the `canary_ingress` so 10% of the traffic is routed to
    the canary (green) service:'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将创建 `canary_ingress` 以将 10% 的流量路由到金丝雀（绿色）服务：
- en: '[PRE34]'
  id: totrans-236
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: Listing 5.11  canary_ingress.yaml
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.11  canary_ingress.yaml
- en: '[PRE35]'
  id: totrans-238
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: ❶ Tells NGINX Ingress Controller to mark this one as canary and associates this
    ingress with the main ingress by matching host and path
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 告诉 NGINX 入口控制器将其标记为金丝雀，并通过匹配主机和路径将此入口与主入口关联
- en: ❷ Routes 10% of traffic to green-service
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 将 10% 的流量路由到 green-service
- en: Now you can go back to the browser and monitor the green service.
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你可以回到浏览器并监控绿色服务。
- en: '![](Images/CH05_F19_Yuen.png)'
  id: totrans-242
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F19_Yuen.png)'
- en: Figure 5.19 The HTML page will show a mix of blue and green in both the bubble
    and bar charts because 10% of the traffic is going to green Pods.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.19 HTML 页面将在气泡图和柱状图中显示蓝色和绿色的混合，因为 10% 的流量将流向绿色 Pod。
- en: 'If you are able to see the correct result (healthy canary), you are ready to
    complete the canary deployment (green service). We will then scale up the green
    deployment, send all traffic to the green service, and scale down the blue deployment:'
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你能够看到正确的结果（健康的金丝雀），你就可以完成金丝雀部署（绿色服务）。然后我们将扩展绿色部署，将所有流量发送到绿色服务，并缩减蓝色部署：
- en: '[PRE36]'
  id: totrans-245
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: Now you should be able to see all green bars and dots as 100% of the traffic
    is routed to the green service.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你应该能够看到所有绿色柱子和点，因为 100% 的流量被路由到绿色服务。
- en: Note In true production, we will need to ensure all green Pods are up before
    we can send 100% of the traffic to the canary service. Optionally, we can incrementally
    increase the percentage of traffic to the green service while the green deployment
    is scaling up.
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：在真正的生产环境中，我们将在将 100% 的流量发送到金丝雀服务之前，需要确保所有绿色 Pod 都处于运行状态。可选地，我们可以在绿色部署扩展的同时，逐步增加发送到绿色服务的流量百分比。
- en: '![](Images/CH05_F20_Yuen.png)'
  id: totrans-248
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F20_Yuen.png)'
- en: Figure 5.20 If there is no error with the canary, the green deployment will
    scale up, and the blue deployment will scale down. After the blue deployment fully
    scales down, both the bubble and bar charts will show 100% green.
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: 图 5.20 如果金丝雀没有错误，绿色部署将扩展，蓝色部署将缩减。在蓝色部署完全缩减后，气泡图和柱状图将显示 100% 绿色。
- en: 5.3.2 Canary with Argo Rollouts
  id: totrans-250
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.3.2 使用 Argo Rollouts 进行金丝雀部署
- en: As you can see in section 5.3.1, using a canary deployment can help detect issues
    early to prevent problematic deployment but will involve many additional steps
    in the deployment process. In the next tutorial, we will use Argo Rollouts to
    simplify the process of canary deployment.
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: 如 5.3.1 节中所示，使用金丝雀部署可以帮助早期检测问题，以防止有问题的部署，但将在部署过程中涉及许多额外的步骤。在下一教程中，我们将使用 Argo
    Rollouts 简化金丝雀部署的过程。
- en: Note Please refer to section 5.1.4 on how to enable ingress and install Argo
    Rollouts in your Kubernetes cluster prior to this tutorial.
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：请参考本教程之前的 5.1.4 节，了解如何在 Kubernetes 集群中启用入口并安装 Argo Rollouts。
- en: Create the ingress, production deployment, and service (blue).
  id: totrans-253
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建入口、生产部署和服务（蓝色）。
- en: View the application in the browser (blue).
  id: totrans-254
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在浏览器中查看应用程序（蓝色）。
- en: Apply the manifest with the green image with 10% of the canary traffic for 60
    seconds.
  id: totrans-255
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用带有 10% 金丝雀流量的绿色镜像应用清单 60 秒。
- en: Create the canary ingress to direct 10% of the traffic to the green service.
  id: totrans-256
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建将 10% 的流量引导到绿色服务的金丝雀入口。
- en: View the web page again in the browser (10% green with no error).
  id: totrans-257
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在浏览器中再次查看网页（10% 绿色，无错误）。
- en: Wait 60 seconds.
  id: totrans-258
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 等待 60 秒。
- en: View the application again in the browser (all green).
  id: totrans-259
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 再次在浏览器中查看应用程序（全部绿色）。
- en: 'First, we will create the ingress controller (listing 5.8), `demo-service`,
    and blue deployment (listing 5.12):'
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们将创建入口控制器（列表 5.8）、`demo-service` 和蓝部署（列表 5.12）：
- en: '[PRE37]'
  id: totrans-261
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: Listing 5.12  canary_rollout.yaml
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 5.12  canary_rollout.yaml
- en: '[PRE38]'
  id: totrans-263
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: ❶ When a Rollout is first deployed, the strategy is ignored, and a regular deployment
    is performed.
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 当 Rollout 首次部署时，策略被忽略，并执行常规部署。
- en: ❷ Deploys with canary strategy
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 使用金丝雀策略部署
- en: ❸ Scales out enough Pods to service 10% of the traffic. In this example, Rollout
    will scale up one green Pod along with the three blue Pods resulting in the green
    Pod getting 25% of the traffic. Argo Rollouts can work with service mesh or NGINX
    Ingress Controller for fine-grain traffic routing.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 将Pod数量扩展到足以服务10%的流量。在本例中，Rollout将扩展一个绿色Pod以及三个蓝色Pod，使得绿色Pod获得25%的流量。Argo Rollouts可以与服务网格或NGINX
    Ingress Controller配合进行细粒度流量路由。
- en: ❹ Waits 60 seconds. If no error or user interruption happens, scales up green
    to 100%.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 等待60秒。如果没有错误或用户中断发生，将绿色Pod扩展到100%。
- en: Note For the initial deployment (blue), `Rollout` will ignore the canary setting
    and perform a regular deployment.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 注意对于初始部署（蓝色），`Rollout`将忽略金丝雀设置并执行常规部署。
- en: Once you have the ingress controller, service, and deployment created and updated
    /etc/hosts with the demo.info and the correct IP address, you can enter the URL
    demo.info and see the blue service running.
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦创建了ingress控制器、服务以及更新了包含demo.info和正确IP地址的/etc/hosts文件，您就可以输入URL demo.info并看到蓝色服务正在运行。
- en: Note NGINX Ingress Controller will only intercept traffic with the hostname
    defined in the custom rule. Please make sure you add demo.info and its IP address
    to your /etc/hosts.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 注意NGINX Ingress Controller只会拦截自定义规则中定义的主机名的流量。请确保您已将demo.info及其IP地址添加到您的/etc/hosts文件中。
- en: 'Once the blue service is fully up and running, we can now update the manifest
    with the green image and apply the manifest:'
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦蓝色服务完全启动并运行，我们现在可以更新清单，使用绿色镜像并应用清单：
- en: '[PRE39]'
  id: totrans-272
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: Once the canary starts, you should see something similar to figure 5.19 in section
    5.3.1\. After one minute, the green ReplicaSet will scale up while the blue deployment
    scales down with all bars and dots going green (figure 5.20 in section 5.3.1).
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦金丝雀启动，你应该会看到与第5.3.1节中的图5.19类似的内容。经过一分钟，绿色ReplicaSet将扩展，而蓝色部署将缩减，所有条形和点都将变为绿色（第5.3.1节中的图5.20）。
- en: 5.4 Progressive delivery
  id: totrans-274
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 5.4 渐进式交付
- en: Progressive delivery can also be viewed as a fully automated version of canary
    deployment. Instead of monitoring for a fixed period (such as one hour) before
    scaling up the canary deployment, progressive delivery will continuously monitor
    the Pods’ health and scale up until fully scaled.
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 渐进式交付也可以被视为金丝雀部署的完全自动化版本。与在扩展金丝雀部署之前监控固定时间段（例如一小时）不同，渐进式交付将连续监控Pod的健康状况，直到完全扩展。
- en: 5.4.1 Progressive delivery with Argo Rollouts
  id: totrans-276
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 5.4.1 使用Argo Rollouts进行渐进式交付
- en: Kubernetes does not provide an analysis tool to determine the correctness of
    the new deployment. In this tutorial, we will use Argo Rollouts to implement progressive
    delivery. Argo Rollouts uses the canary strategy along with `AnalysisTemplate`
    to achieve progressive delivery.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes不提供分析工具来确定新部署的正确性。在本教程中，我们将使用Argo Rollouts来实现渐进式交付。Argo Rollouts使用金丝雀策略以及`AnalysisTemplate`来实现渐进式交付。
- en: '![](Images/CH05_F21_Yuen.png)'
  id: totrans-278
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F21_Yuen.png)'
- en: Figure 5.21 Progressive delivery continuously collects and analyzes the health
    of the new Pods; scales up the progressive deployment (green); and scales down
    the production deployment (blue), as long as the analysis is determined to be
    successful.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.21 渐进式交付持续收集和分析新Pod的健康状况；扩展渐进式部署（绿色）；缩减生产部署（蓝色），只要分析确定成功。
- en: Note Please refer to section 5.1.4 on how to enable ingress and install Argo
    Rollouts in your Kubernetes cluster prior to this tutorial.
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: 注意请参考第5.1.4节了解如何在本次教程之前在Kubernetes集群中启用ingress并安装Argo Rollouts。
- en: '![](Images/CH05_F22_Yuen.png)'
  id: totrans-281
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH05_F22_Yuen.png)'
- en: Figure 5.22 This figure depicts a completed progressive delivery with fully
    scaled-up green deployment and scaled-down blue deployment.
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.22 此图展示了完成的渐进式交付，绿色部署完全扩展，蓝色部署缩减。
- en: Create the `AnalysisTemplate`.
  id: totrans-283
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建`AnalysisTemplate`。
- en: Create the ingress, production deployment, and service (blue).
  id: totrans-284
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建ingress、生产部署和服务（蓝色）。
- en: Create ingress to direct traffic to the production service.
  id: totrans-285
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建ingress以将流量导向生产服务。
- en: View the application in the browser (blue).
  id: totrans-286
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 再次在浏览器中查看应用程序（蓝色）。
- en: Update and apply the manifest with the green image with the Pass template.
  id: totrans-287
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用Pass模板更新并应用包含绿色镜像的清单。
- en: View the web page again in the browser (green).
  id: totrans-288
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在浏览器中再次查看网页（绿色）。
- en: Update and apply the manifest with the green image with the Fail template.
  id: totrans-289
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用Fail模板更新并应用包含绿色镜像的清单。
- en: View the application again in the browser. Still blue!
  id: totrans-290
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 再次在浏览器中查看应用程序。仍然是蓝色！
- en: 'First, we will create the `AnalysisTemplate` (listing 5.13) for `Rollout` to
    collect metrics and determine the health of the Pods. For simplicity, we will
    create one `AnalysisTemplate` `pass`, which will always return 0 (healthy), and
    an `AnalysisTemplate` `fail`, which will always return 1 (unhealthy). In addition,
    Argo Rollouts internally maintains multiple ReplicaSets, so there is no need for
    multiple services. Next, we will create the ingress controller (listing 5.8),
    `demo-service`, and blue deployment (listing 5.14):'
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们将为`Rollout`创建用于收集指标并确定Pod健康状况的`AnalysisTemplate`（列表5.13）。为了简单起见，我们将创建一个总是返回0（健康）的`AnalysisTemplate`
    `pass`，以及一个总是返回1（不健康）的`AnalysisTemplate` `fail`。此外，Argo Rollouts内部维护多个ReplicaSet，因此不需要多个服务。接下来，我们将创建入口控制器（列表5.8）、`demo-service`和蓝色部署（列表5.14）：
- en: '[PRE40]'
  id: totrans-292
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: Note For production, `AnalysisTemplate` has support for Prometheus, Wavefront,
    and Netflix Kayenta or can be extended for other metric stores.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：对于生产环境，`AnalysisTemplate`支持Prometheus、Wavefront和Netflix Kayenta，或者可以扩展以支持其他指标存储。
- en: Listing 5.13  analysis-templates.yaml
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 列表5.13  analysis-templates.yaml
- en: '[PRE41]'
  id: totrans-295
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: ❶ Runs for 15 seconds
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 运行15秒
- en: ❷ Returns 0 (always pass)
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 返回0（总是通过）
- en: ❸ Runs for 15 seconds
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 运行15秒
- en: ❹ Returns 1 (always fail)
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 返回1（总是失败）
- en: Listing 5.14  rollout-with-analysis.yaml
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 列表5.14  rollout-with-analysis.yaml
- en: '[PRE42]'
  id: totrans-301
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: ❶ Deploys with strategy Canary
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 使用Canary策略部署
- en: ❷ Specifies the AnalysisTemplate pass
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 指定AnalysisTemplate通过
- en: ❸ Scales out enough Pods to service 10% of the traffic. In this example, Rollout
    will scale up one green Pod along with the three blue Pods resulting in the green
    Pod getting 25% of the traffic. Argo Rollouts can work with Service Mesh or NGINX
    Ingress Controller for fine-grain traffic routing.
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 扩展足够的Pods以服务10%的流量。在这个例子中，Rollout将扩展一个绿色Pod以及三个蓝色Pod，导致绿色Pod获得25%的流量。Argo
    Rollouts可以与Service Mesh或NGINX Ingress Controller一起工作，以进行细粒度流量路由。
- en: ❹ Waits 20 seconds before full scale-up
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 在全规模扩展前等待20秒
- en: Note For the initial deployment (blue), `Rollout` will ignore the `Canary` setting
    and perform a regular deployment.
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：对于初始部署（蓝色），`Rollout`将忽略`Canary`设置并执行常规部署。
- en: Once you have the ingress controller, service, and deployment created and updated
    /etc/hosts with the demo.info and the correct IP address, you can enter the URL
    demo.info and see the blue service running.
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦您创建了入口控制器、服务以及更新了`/etc/hosts`文件中的demo.info和正确的IP地址，您就可以输入URL demo.info并看到蓝色服务正在运行。
- en: 'Once the blue service is fully up and running, we can now update the manifest
    with the green image and apply the manifest. You should see the blue progressively
    turning green and completely green after 20 seconds:'
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦蓝色服务完全启动并运行，我们现在可以更新清单以使用绿色镜像并应用清单。您应该看到蓝色逐步变为绿色，并在20秒后完全变为绿色：
- en: '[PRE43]'
  id: totrans-309
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: '![](Images/CH05_F23_Yuen.png)'
  id: totrans-310
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F23_Yuen.png)'
- en: Figure 5.23 As the green deployment progressively scales up, both the bubble
    and bar charts will gradually become all green if there is no error.
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.23 当绿色部署逐步扩展时，如果没有任何错误，气泡图和柱状图都将逐渐变为全绿色。
- en: 'Now let’s deploy again and go back to the blue image. This time we will also
    switch to the “Fail” `AnalysisTemplate` that will return a failure status after
    15 seconds. We should see the blue progressively appear in the browser but turn
    back to green after 15 seconds:'
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们再次部署并回到蓝色图像。这次我们还将切换到“Fail”`AnalysisTemplate`，该模板将在15秒后返回失败状态。我们应该看到蓝色在浏览器中逐步出现，但在15秒后变回绿色：
- en: '[PRE44]'
  id: totrans-313
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: '![](Images/CH05_F24_Yuen.png)'
  id: totrans-314
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH05_F24_Yuen.png)'
- en: Figure 5.24 The blue deployment progressively scales up but returns errors.
    The blue deployment will get scaled down during failure, and both the bubble and
    bar charts return to green.
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.24 蓝色部署逐步扩展但返回错误。在失败期间，蓝色部署将被缩减规模，并且气泡图和柱状图都将返回绿色。
- en: Note The demo rollout will be marked as aborted after the failure and will not
    deploy again until the abort state is set to `false`.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：演示部署在失败后将标记为已中止，并且只有在中止状态设置为`false`之后才会再次部署。
- en: From this tutorial, you can see that Argo Rollouts uses the canary strategy
    to progressively scale up the green deployment if the `AnalysisTemplate` continues
    to report success based on the metrics collected. If `AnalysisTemplate` reports
    failures, Argo Rollouts will roll back by scaling down the green deployment and
    scaling up the blue deployment back to its original state. See table 5.1 for a
    deployment comparison.
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 从本教程中，你可以看到，如果 `AnalysisTemplate` 继续根据收集的指标报告成功，Argo Rollouts 会使用金丝雀策略逐步扩展绿色部署。如果
    `AnalysisTemplate` 报告失败，Argo Rollouts 将通过缩小绿色部署和扩大蓝色部署回其原始状态来回滚。参见表 5.1 进行部署比较。
- en: Table 5.1 Deployment strategy comparison
  id: totrans-318
  prefs: []
  type: TYPE_NORMAL
  zh: 表 5.1 部署策略比较
- en: '|  | Pros | Cons |'
  id: totrans-319
  prefs: []
  type: TYPE_TB
  zh: '|  | 优点 | 缺点 |'
- en: '| Deployment | Built into KubernetesRolling updatesMinimal hardware required
    | Backward-compatible and stateless application only |'
  id: totrans-320
  prefs: []
  type: TYPE_TB
  zh: '| 部署 | 内置于 Kubernetes，滚动更新，所需硬件最少 | 仅适用于向后兼容和无状态的应用程序 |'
- en: '| Blue-green | Works with stateful application and non-backward-compatible
    deploymentFast rollback | Requires additional automationRequires twice the hardware
    during the deployment |'
  id: totrans-321
  prefs: []
  type: TYPE_TB
  zh: '| 蓝绿 | 与有状态应用程序和非向后兼容的部署一起工作，快速回滚 | 需要额外的自动化，部署期间需要两倍的硬件 |'
- en: '| Canary | Verifies new releases using production traffic and dependencies
    with a subset of users | Requires additional automationLonger deployment processBackward-compatible
    and stateless application only |'
  id: totrans-322
  prefs: []
  type: TYPE_TB
  zh: '| 金丝雀 | 使用生产流量和依赖关系的一部分用户验证新版本 | 需要额外的自动化，部署过程更长，仅适用于向后兼容和无状态的应用程序 |'
- en: '| Progressive | Gradually deploys new releases to a subset of users and continuously
    scales out to all users if metrics are good;automatic rollback if metrics are
    bad | Requires additional automationRequires metrics collection and analysisLonger
    deployment processBackward-compatible and stateless application only |'
  id: totrans-323
  prefs: []
  type: TYPE_TB
  zh: '| 持续交付 | 逐步将新版本部署到一部分用户，如果指标良好则持续扩展到所有用户；如果指标不佳则自动回滚 | 需要额外的自动化，需要收集和分析指标，部署过程更长，仅适用于向后兼容和无状态的应用程序
    |'
- en: Summary
  id: totrans-324
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: ReplicaSet is not declarative and not suited for GitOps.
  id: totrans-325
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ReplicaSet 不是声明式的，也不适合 GitOps。
- en: Deployment is fully declarative and complementary to GitOps.
  id: totrans-326
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Deployment 完全声明式，与 GitOps 相辅相成。
- en: Deployment performs rolling updates and is best for stateless and backward-compatible
    deployment.
  id: totrans-327
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Deployment 执行滚动更新，最适合无状态和向后兼容的部署。
- en: Deployment can be customized with `max` `surge` to specify the number of new
    Pods and `max` `unavailable` to limit the number of Pods being terminated.
  id: totrans-328
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Deployment 可以通过 `max` `surge` 来指定新 Pod 的数量，并通过 `max` `unavailable` 来限制正在终止的
    Pod 的数量。
- en: Blue-green deployment is suitable for non-backward-compatible deployment or
    sticky session service.
  id: totrans-329
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 蓝绿部署适合不兼容回滚的部署或粘性会话服务。
- en: Blue-green deployment can be implemented natively by leveraging two Deployments
    (each with a custom label) and updating `selector` in the Service to route 100%
    of the traffic to the active deployment.
  id: totrans-330
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 蓝绿部署可以通过利用两个 Deployment（每个都有自定义标签）和更新 Service 中的 `selector` 来路由 100% 的流量到活动部署来实现。
- en: Canary acts as an early indicator for failures to avoid problematic deployments
    having a full impact on all customers at once.
  id: totrans-331
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 金丝雀作为故障的早期指标，可以避免有问题的部署一次性对所有客户造成全面影响。
- en: Canary deployment can be implemented natively by leveraging two Deployments
    and NGINX Ingress Controller to dial the traffic gradually.
  id: totrans-332
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 金丝雀部署可以通过利用两个 Deployment 和 NGINX Ingress Controller 逐步调整流量来实现。
- en: Progressive delivery is an advanced version of canary deployment using real-time
    metrics to continue or abort the deployment.
  id: totrans-333
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 持续交付是金丝雀部署的高级版本，使用实时指标来继续或中止部署。
- en: Argo Rollouts is an open source project that can simplify blue-green, canary,
    and progressive deployment.
  id: totrans-334
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Argo Rollouts 是一个开源项目，可以简化蓝绿、金丝雀和持续部署。
- en: Each deployment strategy has its pros/cons, and it is important to select the
    right strategy for your application.
  id: totrans-335
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每种部署策略都有其优缺点，选择适合你应用程序的正确策略非常重要。
- en: '* * *'
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: 1.[https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/).
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
  zh: 1.[https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/).
- en: 2.[https://kubernetes.io/docs/concepts/workloads/controllers/deployment/](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/).
  id: totrans-338
  prefs: []
  type: TYPE_NORMAL
  zh: 2.[https://kubernetes.io/docs/concepts/workloads/controllers/deployment/](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/).
- en: 3.[https://kubernetes.github.io/ingress-nginx/user-guide/basic-usage/](https://kubernetes.github.io/ingress-nginx/user-guide/basic-usage/).
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
  zh: 3.[https://kubernetes.github.io/ingress-nginx/user-guide/basic-usage/](https://kubernetes.io/ingress-nginx/user-guide/basic-usage/).
- en: 4.[https://istio.io/latest/docs/reference/config/networking/gateway/](https://istio.io/latest/docs/reference/config/networking/gateway/).
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
  zh: 4.[https://istio.io/latest/docs/reference/config/networking/gateway/](https://istio.io/latest/docs/reference/config/networking/gateway/).
- en: 5.[https://github.com/argoproj/argo-rollouts](https://github.com/argoproj/argo-rollouts).
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
  zh: 5.[https://github.com/argoproj/argo-rollouts](https://github.com/argoproj/argo-rollouts).
- en: 6.[https://kubernetes.io/docs/tasks/access-application-cluster/ingress-minikube/](https://kubernetes.io/docs/tasks/access-application-cluster/ingress-minikube/).
  id: totrans-342
  prefs: []
  type: TYPE_NORMAL
  zh: 6.[https://kubernetes.io/docs/tasks/access-application-cluster/ingress-minikube/](https://kubernetes.io/docs/tasks/access-application-cluster/ingress-minikube/).
- en: 7.[https://argoproj.github.io/argo-rollouts/getting-started/](https://argoproj.github.io/argo-rollouts/getting-started/).
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
  zh: 7.[https://argoproj.github.io/argo-rollouts/getting-started/](https://argoproj.github.io/argo-rollouts/getting-started/).
- en: 8.[https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/).
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
  zh: 8.[https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/).
- en: 9.[https://en.wikipedia.org/wiki/Iptables](https://en.wikipedia.org/wiki/Iptables).
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
  zh: 9.[https://en.wikipedia.org/wiki/Iptables](https://en.wikipedia.org/wiki/Iptables).
