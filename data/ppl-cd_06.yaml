- en: 3 Defining Jenkins architecture
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 3 定义Jenkins架构
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Understanding how Jenkins distributed builds work
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 理解Jenkins分布式构建的工作原理
- en: Understanding the roles of Jenkins master and worker nodes
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 理解Jenkins主节点和工作节点的角色
- en: Architecting Jenkins in the cloud for scale
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在云中架构Jenkins以实现可扩展性
- en: Configuring multiple Jenkins masters
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 配置多个Jenkins主节点
- en: Preparing an AWS environment and CLI configuration
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 准备AWS环境和CLI配置
- en: In a distributed microservices architecture, you may have multiple services
    to build, test, and deploy regularly. Hence, having multiple build machines makes
    sense. While you can always run Jenkins in a standalone mode, running all builds
    on a central machine may not be the best option and will result in having a single
    point of failure (a single Jenkins server cannot handle the entire load for larger
    and heavier projects). Fortunately, Jenkins can also be configured to run distributed
    builds across a fleet of machines/nodes by setting up a master/worker cluster,
    as shown in figure 3.1.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 在分布式微服务架构中，你可能需要定期构建、测试和部署多个服务。因此，拥有多个构建机器是有意义的。虽然你始终可以在独立模式下运行Jenkins，但将所有构建都运行在中央机器上可能不是最佳选择，并且会导致单点故障（单个Jenkins服务器无法处理更大和更重的项目整个负载）。幸运的是，Jenkins也可以配置为通过设置主/工作节点集群在机器/节点群上运行分布式构建，如图3.1所示。
- en: '![](Images/CH03_F01_Labouardy.png)'
  id: totrans-8
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH03_F01_Labouardy.png)'
- en: Figure 3.1 Distributed master-worker architecture
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.1 分布式主-工作节点架构
- en: 'Jenkins uses a master-worker architecture to manage distributed builds. Each
    component has a specific role:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: Jenkins使用主-工作节点架构来管理分布式构建。每个组件都有特定的角色：
- en: '*Jenkins master*—Responsible for scheduling build jobs and distributing builds
    to the workers for the actual execution. It also monitors the workers’ states,
    and collects and aggregates the build results in the web dashboard.'
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*Jenkins主节点*——负责调度构建作业并将构建作业分配给工作节点以进行实际执行。它还监控工作节点的状态，并在Web仪表板上收集和汇总构建结果。'
- en: '*Jenkins worker*—Also known as a *slave* or *build agent*, this is a Java executable
    that runs on a remote machine, listens for requests coming from the Jenkins master,
    and executes build jobs. You can have as many workers as you want (up to 100+
    nodes). Workers can be added and removed on the fly. Therefore, the workload will
    be distributed to them automatically, and the workers will take the load off the
    master Jenkins server.'
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*Jenkins工作节点*——也称为*slave*或*build agent*，这是一个在远程机器上运行的Java可执行程序，它监听来自Jenkins主节点的请求，并执行构建作业。你可以拥有任意数量的工作节点（多达100+个节点）。工作节点可以动态添加和移除。因此，工作负载将自动分配给它们，并且工作节点将减轻主Jenkins服务器的负载。'
- en: Note In 2016, the Jenkins community decided to start removing offensive terminology
    within the project. The *slave* term was deprecated in Jenkins 2.0 and replaced
    by *agent*.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：在2016年，Jenkins社区决定开始从项目中移除冒犯性的术语。在Jenkins 2.0中，*slave*这个术语已被弃用，并由*agent*替代。
- en: To sum up, Jenkins can be deployed in a standalone mode. However, when you want
    to run multiple build jobs regularly in different environments to meet the requirements
    of the build environment for different projects, then a single Jenkins server
    cannot simply handle the workload. That’s why in this book, we will be focusing
    on *master-worker architecture*.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 总结来说，Jenkins可以以独立模式部署。然而，当你想在不同的环境中定期运行多个构建作业以满足不同项目的构建环境需求时，单个Jenkins服务器就不能简单地处理工作负载了。这就是为什么在这本书中，我们将重点关注*主-工作节点架构*。
- en: 3.1 Understanding master-worker architecture
  id: totrans-15
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 3.1 理解主-工作节点架构
- en: In a master-worker architecture, the web dashboard is running on the Jenkins
    master instance. The master’s role is to handle scheduling build jobs, dispatching
    and delegating builds to the workers for the actual execution, monitoring the
    workers’ state (online or offline), and recording and presenting the build results.
    Even in a distributed architecture, a master instance of Jenkins can also execute
    build jobs directly.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 在主-工作节点架构中，Web仪表板运行在Jenkins主实例上。主节点的角色是处理构建作业的调度，将构建作业派遣和委派给工作节点以进行实际执行，监控工作节点的状态（在线或离线），以及记录和展示构建结果。即使在分布式架构中，Jenkins的一个主实例也可以直接执行构建作业。
- en: Jenkins workers can be added and configured on the Jenkins dashboard or through
    a Jenkins RESTful API. The worker’s role is to execute build jobs assigned by
    the master. You can configure a project to always run on a particular node by
    assigning labels to nodes. Labels are a powerful feature; they are virtual group
    names. You can assign multiple labels to a worker node while configuring it. Labels
    can also be used to restrict the build job to run on a worker node associated
    with a specific label name—for instance, to restrict a job to be built on a CPU-optimized
    instance.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: Jenkins 工作节点可以在 Jenkins 仪表板或通过 Jenkins RESTful API 进行添加和配置。工作节点的角色是执行由主节点分配的构建作业。您可以通过给节点分配标签来配置一个项目始终在特定的节点上运行。标签是一个强大的功能；它们是虚拟的组名。在配置时，您可以给工作节点分配多个标签。标签还可以用来限制构建作业仅在具有特定标签名称的工作节点上运行——例如，限制作业仅在
    CPU 优化的实例上构建。
- en: To add a worker, you can click Manage Jenkins in the admin page menu, and then
    click Manage Nodes and Add New Node. Fill in the configuration information, including
    a name for the node, the workspace name, and the IP address of the node. Then,
    enter a label like `workers` (you can assign multiple labels in the Labels entry
    box by separating them with spaces). Figure 3.2 shows how to add a new worker
    to Jenkins.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 要添加一个工作节点，您可以在管理员页面菜单中点击“管理 Jenkins”，然后点击“管理节点”并选择“添加新节点”。填写配置信息，包括节点名称、工作区名称和节点的
    IP 地址。然后，输入一个标签，例如 `workers`（您可以在“标签”输入框中通过空格分隔来分配多个标签）。图 3.2 展示了如何将新的工作节点添加到
    Jenkins 中。
- en: '![](Images/CH03_F02_Labouardy.png)'
  id: totrans-19
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.2 使用标签进行 Jenkins 作业分配](Images/CH03_F02_Labouardy.png)'
- en: Figure 3.2 Using labels for Jenkins jobs assignments
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.2 使用标签进行 Jenkins 作业分配
- en: 'By assigning the `workers` label to the node, you can reference it easily in
    your Jenkinsfile. In a declarative pipeline, you can restrict the pipeline to
    run on nodes with the `workers` label by setting up the `agent` directive as follows:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 通过将 `workers` 标签分配给节点，您可以在 Jenkinsfile 中轻松引用它。在声明式管道中，您可以通过设置以下 `agent` 指令来限制管道仅在带有
    `workers` 标签的节点上运行：
- en: '[PRE0]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'The scripted pipeline, however, uses the `node` block wrapper with the label
    name as a parameter to define the execution environment for the pipeline:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，脚本化的管道使用带有标签名称的 `node` 块包装器作为参数来定义管道的执行环境：
- en: '[PRE1]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'If more build jobs are requested for the same node, Jenkins will automatically
    create a job queue. By default, each node can execute one job; however, you can
    increase the node’s capacity for running jobs by setting the field labeled # of
    Executors. In the previous example, the node is configured with three executors,
    which means up to three jobs can be executed at once. If four jobs are started,
    the first three will execute, and the fourth will be added to the build queue.
    Once nodes become available, Jenkins will execute the remaining jobs in the order
    they were requested.'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 如果对同一节点请求更多的构建作业，Jenkins 将自动创建一个作业队列。默认情况下，每个节点可以执行一个作业；然而，您可以通过设置标记为“执行器数量”的字段来增加节点运行作业的容量。在先前的例子中，节点配置了三个执行器，这意味着一次最多可以执行三个作业。如果启动了四个作业，前三个将执行，第四个将被添加到构建队列中。一旦节点可用，Jenkins
    将按照请求的顺序执行剩余的作业。
- en: To be able to add a worker to the Jenkins cluster, the workers and master need
    to establish bidirectional communication through TCP/IP. Another requirement is
    that Java should be installed on the worker machine. Because Java is a platform-agnostic
    programming language, a Jenkins cluster might consist of workers that run on a
    variety of OS platforms such as Windows, Linux, or macOS. This architecture comes
    with multiple benefits, such as having a heterogeneous build farm that supports
    all of the environments that you might need to run builds/tests with a different
    OS or CPU architecture.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 要能够将工作节点添加到 Jenkins 集群，工作节点和主节点需要通过 TCP/IP 建立双向通信。另一个要求是在工作机器上安装 Java。由于 Java
    是一种平台无关的编程语言，一个 Jenkins 集群可能包含运行在多种操作系统平台上的工作节点，如 Windows、Linux 或 macOS。这种架构带来了多个好处，例如拥有一个异构的构建农场，支持您可能需要使用不同操作系统或
    CPU 架构运行构建/测试的所有环境。
- en: In the example in figure 3.3, using a worker to represent each of your required
    environments results in having several environments and configurations to test,
    build, and deploy your projects. The delegation behavior of build jobs depends
    on the configuration of each project; some projects may choose to “stick” to a
    particular machine for a build using labels, while others may choose to roam freely
    among available workers.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 在图3.3的示例中，使用工作节点代表您所需的环境中的每一个，会导致您拥有多个环境和配置来测试、构建和部署您的项目。构建作业的委托行为取决于每个项目的配置；一些项目可能选择使用标签“粘附”到特定机器上进行构建，而其他项目可能选择在可用的节点之间自由漫游。
- en: '![](Images/CH03_F03_Labouardy.png)'
  id: totrans-28
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F03_Labouardy.png)'
- en: Figure 3.3 You can set up multiple workers running different operating systems
    by using SSH or Java Network Launch Protocol (JNLP)
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.3 您可以通过使用SSH或Java网络启动协议（JNLP）来设置运行不同操作系统的多个工作节点
- en: 3.2 Managing Jenkins workers
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 3.2 管理Jenkins工作节点
- en: Several strategies are available when it comes to managing Jenkins workers,
    depending on your target operating systems and other architectural considerations.
    These strategies affect the way you configure your workers, so we need to consider
    each separately.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 在管理Jenkins工作节点时，根据目标操作系统和其他架构考虑因素，有多种策略可供选择。这些策略会影响您配置工作节点的方式，因此我们需要分别考虑每个策略。
- en: 3.2.1 SSH
  id: totrans-32
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 3.2.1 SSH
- en: If you are working in a UNIX environment, the most convenient way to start a
    Jenkins worker is undoubtedly to use Secure Shell (SSH). Jenkins has its own built-in
    SSH client, and almost all UNIX environments support SSH (usually `sshd`) out
    of the box.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您在UNIX环境中工作，无疑最方便启动Jenkins工作节点的方式是使用安全外壳（SSH）。Jenkins具有自己的内置SSH客户端，几乎所有UNIX环境都支持SSH（通常为`sshd`）。
- en: The worker needs to be reachable from the master server, and you will have to
    supply the hostname, login, and password. You can also provide a path to the SSH
    private key file on the master instance to use public/private key authentication,
    as shown in figure 3.4.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 工作节点需要从主服务器可达，您将需要提供主机名、登录名和密码。您还可以为主实例上的SSH私钥文件提供路径，以使用公私钥认证，如图3.4所示。
- en: '![](Images/CH03_F04_Labouardy.png)'
  id: totrans-35
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F04_Labouardy.png)'
- en: Figure 3.4 Launching a Jenkins worker via SSH
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.4 通过SSH启动Jenkins工作节点
- en: Note In chapter 5, we will use the SSH launch method to set up a Jenkins cluster.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：在第5章中，我们将使用SSH启动方法来设置Jenkins集群。
- en: 3.2.2 Command line
  id: totrans-38
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 3.2.2 命令行
- en: You can add a worker by having Jenkins execute a command from the master, as
    shown in figure 3.5\. Use this approach when the master is capable of remotely
    executing a process on another machine. However, the remoting mode has been deprecated
    since Jenkins 2.54 (so it might not a valid option in the newest version of Jenkins).
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过Jenkins从主服务器执行命令来添加工作节点，如图3.5所示。当主服务器能够远程在其他机器上执行进程时，使用此方法。然而，远程模式自Jenkins
    2.54以来已被弃用（因此在最新版本的Jenkins中可能不是一个有效的选项）。
- en: '![](Images/CH03_F05_Labouardy.png)'
  id: totrans-40
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F05_Labouardy.png)'
- en: Figure 3.5 Launching a Jenkins worker via the command line
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.5 通过命令行启动Jenkins工作节点
- en: 3.2.3 JNLP
  id: totrans-42
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 3.2.3 JNLP
- en: Another option is to start an agent from the worker machine itself by using
    Java Web Start (JWS). This approach is useful if the master cannot reach the worker—for
    example, if the worker machine is running on the other side of a firewall. It
    works no matter what operating system your worker is running on. However, it is
    more suitable for managing Windows workers.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 另一种选项是使用Java Web Start（JWS）从工作节点本身启动代理。如果主服务器无法到达工作节点，例如，如果工作节点运行在防火墙的另一侧，这种方法很有用。它适用于您的节点运行在任何操作系统上。然而，它更适合管理Windows工作节点。
- en: 'This approach does suffer from a few major drawbacks: the worker machine cannot
    be started or restarted automatically by Jenkins. If the worker goes down, the
    master instance cannot restart it. When you do this on a Windows machine, you
    need to start the Jenkins worker manually at least once. This requires opening
    a browser on the machine, opening the worker node page on the Jenkins master,
    and launching the worker using a very visible JNLP icon. However, once you have
    launched the worker, you can install it as a Windows service.'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 这种方法确实存在一些主要缺点：Jenkins无法自动启动或重启工作节点。如果工作节点出现故障，主实例无法重启它。在Windows机器上执行此操作时，您至少需要手动启动Jenkins工作节点一次。这需要在该机器上打开浏览器，在Jenkins主服务器上打开工作节点页面，并使用非常显眼的JNLP图标启动工作节点。然而，一旦启动了工作节点，您就可以将其安装为Windows服务。
- en: 3.2.4 Windows service
  id: totrans-45
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 3.2.4 Windows服务
- en: Jenkins can also manage a remote Windows worker as a Windows service, using
    the Windows DCOM Server Process Launcher service, which is installed out of the
    box on Windows. When you choose this option, you need to provide a Windows hostname,
    username, and password, as you can see in figure 3.6.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: Jenkins还可以通过Windows DCOM服务器进程启动器服务（该服务在Windows上默认安装）将远程Windows工作节点作为Windows服务管理。选择此选项时，您需要提供Windows主机名、用户名和密码，如图3.6所示。
- en: '![](Images/CH03_F06_Labouardy.png)'
  id: totrans-47
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH03_F06_Labouardy.png)'
- en: Figure 3.6 Starting a Windows worker
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.6 启动Windows工作节点
- en: This launching mode is convenient, as it does not require you to physically
    connect to the Windows machine to set it up. However, it does have limitations—in
    particular, you cannot run any applications requiring a graphical interface.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 这种启动模式很方便，因为它不需要您物理连接到Windows机器来设置。然而，它也有局限性——特别是，您不能运行任何需要图形界面的应用程序。
- en: Once the workers are added to the Jenkins cluster, the master will proactively
    monitor their statuses and take a worker offline if it considers the worker incapable
    of safely executing a build job. You can fine-tune exactly what Jenkins monitors
    on the Manage Nodes page, shown in figure 3.7.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦将工作节点添加到Jenkins集群中，主节点将主动监控其状态，如果认为某个工作节点无法安全执行构建作业，则会将其下线。您可以在“管理节点”页面中精细调整Jenkins要监控的内容，如图3.7所示。
- en: '![](Images/CH03_F07_Labouardy.png)'
  id: totrans-51
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH03_F07_Labouardy.png)'
- en: Figure 3.7 Defining node-monitoring thresholds
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.7 定义节点监控阈值
- en: Jenkins monitors the available disk space of $JENKINS_HOME on each worker, as
    well as the disk space of the temporary directory and swap space. It also keeps
    tabs on the system clock difference between the master and workers. Finally, it
    monitors the round-trip network response time from the master to the worker. If
    any of these criteria is below a certain threshold, the worker will be marked
    offline.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: Jenkins监控每个工作节点上$JENKINS_HOME的可用磁盘空间，以及临时目录和交换空间的磁盘空间。它还跟踪主节点和工作节点之间的系统时钟差异。最后，它监控从主节点到工作节点的往返网络响应时间。如果这些标准中的任何一个低于某个阈值，则工作节点将被标记为离线。
- en: Finally, it’s worth mentioning that by default Jenkins uses the workers as much
    as possible. Whenever a build can be executed by a specific worker, Jenkins will
    use it.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，值得一提的是，默认情况下，Jenkins尽可能多地使用工作节点。只要某个工作节点可以执行构建，Jenkins就会使用它。
- en: 'To control how Jenkins is scheduling builds on available workers, you can configure
    the Usage field, shown in figure 3.8, to use the Only Build Jobs with Label Expressions
    Matching This Node option to restrict jobs to a worker that matches its name and/or
    label. This can become handy if you want to reserve a worker for a certain kind
    of Jenkins job. Furthermore, if you set the # of Executors field’s value to 1,
    you can ensure that only one job will be executed at any given time. As a result,
    no other builds will interfere.'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 要控制Jenkins如何在可用工作节点上调度构建，您可以在图3.8所示的“使用”字段中进行配置，使用“仅构建与此节点匹配标签表达式的作业”选项来限制作业只能在工作节点名称和/或标签匹配的情况下执行。如果您想为某种特定的Jenkins作业保留工作节点，这将非常有用。此外，如果将“执行器数量”字段的值设置为1，您可以确保在任何给定时间只执行一个作业。因此，不会有其他构建干扰。
- en: '![](Images/CH03_F08_Labouardy.png)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH03_F08_Labouardy.png)'
- en: Figure 3.8 Configuring Jenkins worker usage
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.8 配置Jenkins工作节点使用
- en: 3.3 Architecting Jenkins for scale in AWS
  id: totrans-58
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 3.3 在AWS中为Jenkins进行扩展架构设计
- en: So far, we have covered how Jenkins distributed builds work. This section covers
    how to architect Jenkins for scale on AWS. Therefore, you will need an AWS account
    to follow the examples. With a new AWS account, the Free Tiers should cover all
    the examples at no cost to you. For more information on the AWS Free Tier, and
    a step-by-step guide on how to create a new AWS account, visit [https://aws.amazon.com/free/](https://aws.amazon.com/free/).
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们已经介绍了Jenkins分布式构建的工作方式。本节将介绍如何在AWS上对Jenkins进行扩展架构设计。因此，您需要AWS账户来跟随示例。使用新的AWS账户，免费层应该可以覆盖所有示例，无需您支付任何费用。有关AWS免费层的更多信息以及如何创建新AWS账户的逐步指南，请访问[https://aws.amazon.com/free/](https://aws.amazon.com/free/)。
- en: Note Although this section focuses on AWS, this content can also be used to
    help set up a Jenkins cluster in other cloud providers. Chapter 6 provides a step-by-step
    guide.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：尽管本节侧重于AWS，但此内容同样可用于帮助在其他云服务提供商上设置Jenkins集群。第6章提供了逐步指南。
- en: The simple architecture you can deploy is a standalone or single-node setup.
    You simply need to deploy a Jenkins server on an Amazon Elastic Compute Cloud
    (EC2) instance from the AWS Marketplace ([https://aws.amazon.com/marketplace](https://aws.amazon.com/marketplace)),
    shown in figure 3.9.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以部署的简单架构是一个独立或单节点设置。你只需从 AWS Marketplace（[https://aws.amazon.com/marketplace](https://aws.amazon.com/marketplace)）部署一个
    Jenkins 服务器到 Amazon 弹性计算云（EC2）实例，如图 3.9 所示。
- en: '![](Images/CH03_F09_Labouardy.png)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F09_Labouardy.png)'
- en: Figure 3.9 Jenkins Amazon Machine Image available on AWS Marketplace
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.9 AWS Marketplace 上可用的 Jenkins 机器镜像
- en: The AWS Marketplace contains preconfigured Amazon Machine Images (AMIs) from
    popular categories such as security, networking, storage, machine learning, business
    intelligence, database, and DevOps. You can quickly launch a Jenkins server with
    just a few clicks, by selecting the Jenkins Long-Term Support (LTS) release and
    the machine instance type (based on resource requirements).
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: AWS Marketplace 包含来自安全、网络、存储、机器学习、商业智能、数据库和 DevOps 等流行类别的预配置的 Amazon 机器镜像（AMIs）。你可以通过选择
    Jenkins 长期支持（LTS）版本和机器实例类型（基于资源需求）来快速通过几个点击启动 Jenkins 服务器。
- en: You can also install Jenkins on a base machine image by using a package manager
    (for example, APT or Yum). Jenkins installers are available for several Linux
    distributions as well as Windows and macOS. Otherwise, you can set up a Jenkins
    playground with a Jenkins official Docker image.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以通过使用包管理器（例如，APT 或 Yum）在基础机器镜像上安装 Jenkins。Jenkins 安装程序适用于多个 Linux 发行版以及 Windows
    和 macOS。否则，你可以使用 Jenkins 官方 Docker 镜像设置一个 Jenkins 操场。
- en: Note Chapter 4 covers how to create your own Jenkins machine image from scratch
    with HashiCorp Packer.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：第 4 章介绍了如何使用 HashiCorp Packer 从头开始创建自己的 Jenkins 机器镜像。
- en: Once you have installed Jenkins on an EC2 instance, you will need to configure
    the security group attached to the instance to allow traffic on port 8080\. This
    is the port where the Jenkins dashboard is exposed to.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你在 EC2 实例上安装了 Jenkins，你需要配置实例关联的安全组，以允许 8080 端口的流量。这是 Jenkins 仪表板暴露的端口。
- en: A *security group* acts as a firewall that controls the traffic allowed to reach
    the EC2 instances (figure 3.10). To control traffic, we create rules in the security
    group. For this case, the following security rules need to be added.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: '*安全组*充当防火墙，控制允许到达 EC2 实例的流量（图 3.10）。为了控制流量，我们在安全组中创建规则。对于这种情况，需要添加以下安全规则。'
- en: Allow inbound (ingress) traffic on port 8080 (Jenkins dashboard port number).
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 允许入站（ingress）流量在端口 8080（Jenkins 仪表板端口号）。
- en: (Optional) Allow inbound SSH traffic from your computer’s public address so
    that you can connect to your Jenkins instance for debugging or maintenance.
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: （可选）允许从你的计算机的公网地址入站 SSH 流量，以便你可以连接到你的 Jenkins 实例进行调试或维护。
- en: By default, a security group includes an outbound rule that allows all outbound
    (egress) traffic.
  id: totrans-71
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 默认情况下，安全组包含一个出站规则，允许所有出站（egress）流量。
- en: '![](Images/CH03_F10_Labouardy.png)'
  id: totrans-72
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F10_Labouardy.png)'
- en: Figure 3.10 The Jenkins standalone architecture on AWS consists of an EC2 instance
    behind a security group.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.10 AWS 上的 Jenkins 独立架构由一个位于安全组后的 EC2 实例组成。
- en: You might set up a network access-control list (ACL) with rules similar to your
    security group to add an additional layer of security to your instance. The security
    group acts as a firewall for your Amazon EC2 instance, controlling both inbound
    and outbound traffic at the instance level. ACL acts as a firewall for associated
    subnets, controlling both inbound and outbound traffic at the subnet level.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能需要设置一个与安全组规则类似的网络访问控制列表（ACL），以在你的实例上添加额外的安全层。安全组充当你的 Amazon EC2 实例的防火墙，在实例级别控制入站和出站流量。ACL
    充当相关子网的防火墙，在子网级别控制入站和出站流量。
- en: Note While you can scale the Jenkins master vertically to absorb the loading
    pike of build jobs, there is a limit to how much an instance can be scaled.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：虽然你可以通过垂直扩展 Jenkins 主机来吸收构建作业的负载峰值，但实例可扩展的程度是有限的。
- en: While this architecture works for smaller projects, it can’t scale for larger
    and complex projects. Therefore, we will deploy a Jenkins cluster to share the
    load across multiple workers. Instead of scheduling builds jobs on a Jenkins master
    instance, they will be assigned to Jenkins workers. As a result, additional EC2
    instances (figure 3.11) will be deployed as build servers or Jenkins agents.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然这种架构适用于较小的项目，但它无法扩展到更大和更复杂的项目。因此，我们将部署一个Jenkins集群，以在多个工人之间共享负载。而不是在Jenkins主实例上调度构建作业，它们将被分配给Jenkins工人。结果，将部署额外的EC2实例（图3.11）作为构建服务器或Jenkins代理。
- en: '![](Images/CH03_F11_Labouardy.png)'
  id: totrans-77
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F11_Labouardy.png)'
- en: Figure 3.11 Jenkins distributed architecture on AWS
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.11 AWS上的Jenkins分布式架构
- en: This architecture is much better. However, distributed builds are generally
    used to absorb extra load (for example, in build activity) by dynamically adding
    extra machines as required. Hence, the number of workers shouldn’t be fixed in
    advance. We want to add or remove workers based on the number of jobs waiting
    in the queue or the CPU utilization of the worker’s cluster. That’s why, instead
    of deploying workers independently, we will deploy them inside an AWS Auto Scaling
    group (ASG); see [https://aws.amazon.com/autoscaling/](https://aws.amazon.com/autoscaling/)
    [.](https://aws.amazon.com/autoscaling/.)
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 这种架构要好得多。然而，分布式构建通常用于通过动态添加额外机器来吸收额外负载（例如，在构建活动中），因此工人的数量不应该预先固定。我们希望根据队列中等待作业的数量或工人集群的CPU利用率来添加或删除工人。这就是为什么，我们不会独立部署工人，而是将它们部署在AWS自动缩放组（ASG）内部；请参阅[https://aws.amazon.com/autoscaling/](https://aws.amazon.com/autoscaling/)
    [.](https://aws.amazon.com/autoscaling/.)
- en: The ASG feature comes with EC2 and allows you to deploy a group of EC2 instances
    that are treated as a logical grouping for the purpose of automatic scaling. In
    addition, Amazon EC2 Auto Scaling helps to ensure that you have the correct number
    of instances by specifying the minimum and maximum number of instances at any
    given time.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: ASG功能随EC2提供，允许您部署一组EC2实例，这些实例被视为自动缩放目的的逻辑分组。此外，Amazon EC2自动缩放通过指定任何给定时间的最小和最大实例数量，帮助确保您拥有正确的实例数量。
- en: To create and terminate Jenkins workers on demand based on build jobs, we can
    create scaling policies. A *scaling policy* is a set of instructions for adjusting
    the size of instances in the ASG in response to an Amazon CloudWatch alarm ([docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html)).
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 为了根据构建作业按需创建和终止Jenkins工人，我们可以创建缩放策略。*缩放策略*是一组指令，用于根据Amazon CloudWatch警报调整ASG中实例的大小（[docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html)）。
- en: An Amazon CloudWatch alarm will monitor the CPU usage of the EC2 instances,
    for example. Then it will trigger a scale-out or scale-in event to add or remove
    a worker to the Jenkins cluster automatically. For instance, if the average CPU
    utilization of the Jenkins workers is over 80%, a scale-out event will be triggered,
    and a new worker will be deployed and added to the Jenkins cluster. Similarly,
    if the average CPU utilization of the Jenkins workers is less than 20%, a scale-in
    event will be triggered, and unused workers will be removed (providing infrastructure
    cost optimization).
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: Amazon CloudWatch警报将监控EC2实例的CPU使用情况，例如。然后它将触发一个扩展或缩放事件，以自动向Jenkins集群添加或删除一个工人。例如，如果Jenkins工人的平均CPU利用率超过80%，将触发一个扩展事件，并部署一个新的工人并将其添加到Jenkins集群中。同样，如果Jenkins工人的平均CPU利用率低于20%，将触发一个缩放事件，并删除未使用的工人（提供基础设施成本优化）。
- en: Note When creating an alarm on the Auto Scaling group, the alarm uses aggregated
    metrics across all Jenkins worker instances (average CPU utilization). This way,
    it won’t add instances just because one worker is too busy.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：在自动缩放组上创建警报时，警报使用所有Jenkins工人实例的聚合指标（平均CPU利用率）。这样，它不会仅仅因为一个工人太忙就添加实例。
- en: 'When the CPU utilization is less than 20%, the scale-in policy takes effect,
    and the ASG terminates on the available instances. If you did not assign a specific
    termination policy to the ASG, it uses the default termination policy. This means
    the ASG selects the instance to terminate based on the following factors:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 当CPU利用率低于20%时，缩放策略生效，ASG将在可用实例上终止。如果您没有为ASG分配特定的终止策略，它将使用默认的终止策略。这意味着ASG将根据以下因素选择要终止的实例：
- en: The instance that is closed to the next billing hour.
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 接近下一个计费小时的实例。
- en: Longest/oldest running EC2 instance.
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 运行时间最长/最老的EC2实例。
- en: Oldest launch configuration. The *launch configuration* is the blueprint or
    template that describes what a Jenkins worker instance should look like.
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最老的启动配置。*启动配置*是描述Jenkins工作节点实例应如何样子的蓝图或模板。
- en: 'However, you can use Amazon EC2 termination protection to protect a Jenkins
    worker from being accidentally terminated. Refer to the official guide for instructions:
    [http://mng.bz/ePwz](https://shortener.manning.com/ePwz).'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，您可以使用Amazon EC2终止保护来防止Jenkins工作节点意外终止。请参阅官方指南以获取说明：[http://mng.bz/ePwz](https://shortener.manning.com/ePwz)。
- en: We can also configure the scaling policies based on memory utilization. However,
    memory utilization is one of the metrics not available by default in CloudWatch.
    Since AWS does not have access to the instance at the OS level, only metrics that
    can be monitored through the hypervisor layer (such as CPU and network utilization)
    are recorded.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还可以根据内存利用率来配置扩展策略。然而，内存利用率是CloudWatch默认不可用的指标之一。由于AWS在OS级别无法访问实例，因此只能记录通过虚拟化层（如CPU和网络利用率）可监控的指标。
- en: We have various ways to solve this problem. The most used one is to install
    a metrics collector agent on the EC2 instances. For more details on how to fetch
    the memory utilization, check out chapter 13.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 我们有多种方法可以解决这个问题。最常用的方法是安装一个指标收集代理在EC2实例上。有关如何获取内存利用率的更多详细信息，请参阅第13章。
- en: Note To be able to add workers automatically, the worker machine will run a
    shell script at boot time and use the Jenkins RESTful API to autoregister to the
    cluster with the machine’s private IP address (known as *cluster discovery*).
    Chapters 4 and 5 explain this part in depth.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：为了能够自动添加工作节点，工作节点机器在启动时会运行一个shell脚本，并使用Jenkins RESTful API通过机器的私有IP地址（称为*集群发现*）自动注册到集群中。第4章和第5章将深入解释这一部分。
- en: Figure 3.12 illustrates how to dynamically scale Jenkins workers by using CloudWatch
    scaling policies.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.12说明了如何通过使用CloudWatch扩展策略动态扩展Jenkins工作节点。
- en: '![](Images/CH03_F12_Labouardy.png)'
  id: totrans-93
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH03_F12_Labouardy.png)'
- en: Figure 3.12 Jenkins workers belong to an AWS autoscaling group and will be scaled
    dynamically based on the average CPU utilization of the group.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.12显示Jenkins工作节点属于一个AWS自动扩展组，并将根据组的平均CPU利用率动态扩展。
- en: We can also use custom metrics such as the number of jobs waiting in the build
    queue to trigger scaling policies. To get this information, you can use an open
    source solution such as Prometheus ([https://prometheus.io/docs/introduction/overview/](https://prometheus.io/docs/introduction/overview/))
    to export Jenkins cluster metrics and make a Lambda function to consume/scrape
    those metrics. From the Lambda function, you can trigger scale-out or scale-in
    events on the Jenkins worker autoscaling group by using the AWS API/SDK.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还可以使用自定义指标，如构建队列中等待作业的数量来触发扩展策略。要获取此信息，您可以使用开源解决方案（如Prometheus [https://prometheus.io/docs/introduction/overview/](https://prometheus.io/docs/introduction/overview/)）来导出Jenkins集群指标，并创建一个Lambda函数来消费/抓取这些指标。从Lambda函数中，您可以使用AWS
    API/SDK在Jenkins工作节点自动扩展组上触发扩展或缩减事件。
- en: Note Chapter 13 covers how to monitor a Jenkins cluster’s health and how to
    use the Prometheus exporter plugin on Jenkins to expose server-side metrics.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 注意第13章介绍了如何监控Jenkins集群的健康状况以及如何在Jenkins上使用Prometheus导出器插件来公开服务器端指标。
- en: Figure 3.13 demonstrates how to scale Jenkins workers dynamically based on a
    custom metric.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.13演示了如何根据自定义指标动态扩展Jenkins工作节点。
- en: '![](Images/CH03_F13_Labouardy.png)'
  id: totrans-98
  prefs: []
  type: TYPE_IMG
  zh: '![图片](Images/CH03_F13_Labouardy.png)'
- en: Figure 3.13 You can scale Jenkins workers dynamically based on the number of
    jobs waiting in the build queue by integrating Prometheus and AWS Lambda.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.13您可以通过集成Prometheus和AWS Lambda根据构建队列中等待作业的数量动态扩展Jenkins工作节点。
- en: So far, the architecture is promising. However, it’s not secure and resilient.
    To secure our Jenkins cluster, we will deploy the architecture inside a virtual
    private cloud (VPC) and within a private subnet precisely. In reality, by default,
    any EC2 instance is deployed in the AWS default VPC. But we will create a nondefault
    VPC that suits our specific requirements, using specific Classless Inter-Domain
    Routing (CIDR) block range and subnet sizes.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，该架构很有前景。然而，它并不安全且弹性不足。为了确保我们的Jenkins集群安全，我们将在虚拟私有云（VPC）和私有子网中精确部署该架构。实际上，默认情况下，任何EC2实例都部署在AWS默认VPC中。但我们将创建一个非默认VPC，以满足我们的特定需求，并使用特定的无类别域间路由（CIDR）块范围和子网大小。
- en: Amazon VPC ([https://aws.amazon.com/vpc](https://aws.amazon.com/vpc)) lets you
    provision a logically isolated section of the AWS cloud where you can launch AWS
    resources in a virtual network that you can define. You have complete control
    over your virtual networking environment, including a selection of your own IP
    address range, creation of subnets, and configuration of route tables and network
    gateways.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 亚马逊VPC ([https://aws.amazon.com/vpc](https://aws.amazon.com/vpc)) 允许您在AWS云中配置一个逻辑上隔离的部分，您可以在其中定义一个虚拟网络来启动AWS资源。您对虚拟网络环境拥有完全的控制权，包括选择自己的IP地址范围、创建子网以及配置路由表和网络网关。
- en: An important point to note here is that a VPC is still a part of the AWS cloud.
    It is not physically separate hosting provided by AWS; it is a logically isolated
    part of the EC2 infrastructure. This isolation is done at the network layer and
    is similar to a traditional datacenter’s network isolation; it’s just that we,
    as end users, are shielded from the complexities of it. Figure 3.14 shows the
    network topology of AWS VPC.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 这里需要注意的一个重要点是，VPC仍然是AWS云的一部分。它不是AWS提供的物理上分离的托管服务；它是EC2基础设施的逻辑隔离部分。这种隔离是在网络层完成的，类似于传统数据中心网络的隔离；只是我们作为最终用户，被屏蔽了其复杂性。图3.14显示了AWS
    VPC的网络拓扑。
- en: '![](Images/CH03_F14_Labouardy.png)'
  id: totrans-103
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F14_Labouardy.png)'
- en: Figure 3.14 The virtual private cloud consists of private and public subnets.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.14虚拟私有云由私有和公共子网组成。
- en: We will create an AWS VPC with multiple subnets. A *subnet* is nothing more
    than a range of valid IP addresses. For resiliency, these subnets will be deployed
    in different availability zones in the selected AWS region.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将创建一个包含多个子网的AWS VPC。子网不过是有效IP地址的一个范围。为了提高弹性，这些子网将在所选AWS区域的不同可用区中部署。
- en: Next, we deploy an internet gateway (IGW) and attach it to the VPC. The IGW
    will be used primarily to provide internet connectivity to Jenkins instances (this
    might be needed if your build jobs running in Jenkins workers require downloading
    external packages from the internet). Plus, the IGW maps the instance’s private
    IP address with an associated public or Elastic IP address ([http://mng.bz/p9QG](https://shortener.manning.com/p9QG))
    and then routes traffic outside the subnet to the internet. Finally, we create
    a public route table with rules to direct network traffic from public subnets
    to the IGW, as shown in table 3.1.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将部署一个互联网网关（IGW）并将其连接到VPC。IGW主要用于为Jenkins实例提供互联网连接（如果您的Jenkins工作节点中的构建作业需要从互联网下载外部包，这可能是必需的）。此外，IGW将实例的私有IP地址映射到相关的公共或弹性IP地址
    ([http://mng.bz/p9QG](https://shortener.manning.com/p9QG))，然后将子网外的流量路由到互联网。最后，我们创建一个公共路由表，其中包含将网络流量从公共子网路由到IGW的规则，如表3.1所示。
- en: Table 3.1 Public route table
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 表3.1公共路由表
- en: '| Destination | Target | Remark |'
  id: totrans-108
  prefs: []
  type: TYPE_TB
  zh: '| 目标地址 | 目标 | 备注 |'
- en: '| 10.0.0.0/16 | local | Allow traffic to flow with this particular subnet (10.0.0.0/16)
    |'
  id: totrans-109
  prefs: []
  type: TYPE_TB
  zh: '| 10.0.0.0/16 | local | 允许流量与特定的子网（10.0.0.0/16）流动 |'
- en: '| 0.0.0.0/0 | IGW ID | Allow subnet traffic to flow through the internet. |'
  id: totrans-110
  prefs: []
  type: TYPE_TB
  zh: '| 0.0.0.0/0 | IGW ID | 允许子网流量通过互联网。 |'
- en: But what about instances in the private subnets? That’s where a Network Address
    Translation (NAT) instance or gateway comes into play. The NAT gateway/instance
    will be created inside a public subnet and will forward the outbound traffic and
    not allow any traffic from the internet to reach the private subnets. This means
    instances will have access to the internet without being exposed to the public
    (no public IP address is given). Once the NAT gateway is deployed, we need to
    add an entry to the private subnets route table to point to the NAT gateway; see
    table 3.2.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 但是私有子网中的实例怎么办？这就是网络地址转换（NAT）实例或网关发挥作用的地方。NAT网关/实例将在公共子网内部创建，并将转发出站流量，不允许任何来自互联网的流量到达私有子网。这意味着实例可以访问互联网，而不会暴露在公共网络中（不会分配公共IP地址）。一旦NAT网关部署完成，我们需要在私有子网的路由表中添加一个条目，指向NAT网关；请参阅表3.2。
- en: Table 3.2 Private route table
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 表3.2私有路由表
- en: '| Destination | Target | Remark |'
  id: totrans-113
  prefs: []
  type: TYPE_TB
  zh: '| 目标地址 | 目标 | 备注 |'
- en: '| 10.0.0.0/16 | local | Allow traffic to flow with this particular subnet (10.0.0.0/16)
    |'
  id: totrans-114
  prefs: []
  type: TYPE_TB
  zh: '| 10.0.0.0/16 | local | 允许流量与特定的子网（10.0.0.0/16）流动 |'
- en: '| 0.0.0.0/0 | NAT ID | Allow subnet traffic to flow through the NAT gateway/instance
    |'
  id: totrans-115
  prefs: []
  type: TYPE_TB
  zh: '| 0.0.0.0/0 | NAT ID | 允许子网流量通过NAT网关/实例 |'
- en: Because Jenkins instances will be deployed into private subnets that are isolated
    from the internet, we cannot SSH directly to them from local desktops. A basic
    solution is to deploy a special instance that acts as a proxy you can use to SSH
    into your Jenkins instances. This special instance is called a *bastion host*,
    or *jump box*. This instance will be deployed in your public subnet and will basically
    route only SSH traffic from your local network over the Jenkins instances by setting
    up a secure SSH tunnel/bridge.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 由于Jenkins实例将被部署到与互联网隔离的私有子网中，我们无法从本地桌面直接SSH到它们。一个基本的解决方案是部署一个特殊的实例，该实例充当代理，您可以使用它来SSH到您的Jenkins实例。这个特殊的实例被称为*堡垒主机*或*跳板机*。这个实例将部署在您的公共子网上，并且基本上只通过设置安全的SSH隧道/桥接路由来自本地网络的SSH流量。
- en: Note An advanced solution is to deploy OpenVPN to establish a secure TLS VPN
    session to securely access your private Jenkins instances. Refer to “Setting Up
    OpenVPN Access Server in Amazon VPC” at [http://mng.bz/OQVn](http://mng.bz/OQVn)
    for instructions.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：一个高级的解决方案是部署OpenVPN来建立安全的TLS VPN会话，以便安全地访问您的私有Jenkins实例。请参考“在Amazon VPC中设置OpenVPN访问服务器”的说明，链接为[http://mng.bz/OQVn](http://mng.bz/OQVn)。
- en: Once the VPC is configured, we can go ahead and deploy a dedicated EC2 instance
    running the Jenkins server on a private subnet. Alongside, an ASG of Jenkins workers
    will be deployed across multiple private subnets. We configure scaling policies
    with CloudWatch alarms to dynamically scale Jenkins workers based on the build
    activity. Figure 3.15 summarizes the current deployment architecture.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦配置了VPC，我们就可以继续部署一个在私有子网上运行的Jenkins服务器的专用EC2实例。同时，Jenkins工作节点自动扩展组将在多个私有子网上部署。我们使用CloudWatch警报配置扩展策略，以根据构建活动动态扩展Jenkins工作节点。图3.15总结了当前的部署架构。
- en: '![](Images/CH03_F15_Labouardy.png)'
  id: totrans-119
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F15_Labouardy.png)'
- en: Figure 3.15 This Jenkins cluster deployed in private subnets consists of an
    ASG of workers and an EC2 instance holding the Jenkins dashboard.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.15 这个部署在私有子网中的Jenkins集群由一个工作节点自动扩展组（ASG）和一个持有Jenkins仪表板的EC2实例组成。
- en: We can take this architecture further, and configure a public-facing Elastic
    load balancer in front of the Jenkins instance to access the Jenkins web dashboard.
    This way, your Jenkins instance does not have to be directly exposed to the internet.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以将这种架构进一步扩展，并在Jenkins实例前面配置一个面向公众的弹性负载均衡器，以便访问Jenkins网络仪表板。这样，您的Jenkins实例就不必直接暴露在互联网上。
- en: Note It’s possible to have multiple Jenkins instances even though Jenkins core
    doesn’t support multiple masters by default. Then, use the load balancer to fetch
    requests and distribute them among multiple Jenkins masters.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：即使Jenkins核心默认不支持多个主节点，也可以有多个Jenkins实例。然后，使用负载均衡器来获取请求并将它们分配给多个Jenkins主节点。
- en: The load balancer will listen on both the HTTP (80) and HTTPS (443) ports and
    send incoming requests to the instance on port 8080\. That way, it uses an encrypted
    connection to communicate with the Jenkins instance. Table 3.3 summarizes the
    port configurations.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 负载均衡器将监听HTTP（80）和HTTPS（443）端口，并将传入请求发送到端口号为8080的实例。这样，它使用加密连接与Jenkins实例通信。表3.3总结了端口配置。
- en: Table 3.3 Load balancer listener configuration
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 表3.3 负载均衡器监听器配置
- en: '| Load balancer protocol | Load balancer port | Instance protocol | Instance
    port |'
  id: totrans-125
  prefs: []
  type: TYPE_TB
  zh: '| 负载均衡器协议 | 负载均衡器端口 | 实例协议 | 实例端口 |'
- en: '| HTTP | 80 | HTTP | 8080 |'
  id: totrans-126
  prefs: []
  type: TYPE_TB
  zh: '| HTTP | 80 | HTTP | 8080 |'
- en: '| HTTPS | 443 | HTTP | 8080 |'
  id: totrans-127
  prefs: []
  type: TYPE_TB
  zh: '| HTTPS | 443 | HTTP | 8080 |'
- en: If you specify the HTTPS listener, you will need to select a private Secure
    Sockets Layer (SSL) certificate. The load balancer uses the certificate to terminate
    the connection and then decrypt requests from clients before sending them to the
    Jenkins instance. You can get a free SSL certificate with AWS Certificate Manager
    (ACM); you can also import your own certificate.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您指定了HTTPS监听器，您将需要选择一个私有的安全套接字层（SSL）证书。负载均衡器使用证书来终止连接，然后在将请求发送到Jenkins实例之前解密来自客户端的请求。您可以使用AWS证书管理器（ACM）获取免费的SSL证书；您也可以导入自己的证书。
- en: The load balancer has a publicly resolvable DNS name, so it can route requests
    from clients over the internet to a Jenkins instance that is registered with the
    load balancer. Also, it will be useful while setting up a GitHub webhook for continuously
    triggering Jenkins builds upon push events.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 负载均衡器有一个公开可解析的DNS名称，因此它可以路由来自互联网的客户端请求到已注册到负载均衡器的Jenkins实例。此外，在设置GitHub webhook以在推送事件上持续触发Jenkins构建时，它也将非常有用。
- en: Note If you plan to stick with a private Jenkins instance, chapter 7 explains
    how to set up a GitHub webhook for a Jenkins instance running behind a firewall.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：如果您计划坚持使用私有Jenkins实例，第7章解释了如何在防火墙后面的Jenkins实例上设置GitHub webhook。
- en: Finally, if you would like to use a friendly DNS name to access your load balancer,
    instead of the default DNS name automatically assigned to your load balancer,
    you can create a custom domain name and associate it with the DNS name for your
    load balancer. The DNS configuration can be done on Amazon Route 53 ([https://aws.amazon
    .com/route53/](https://aws.amazon.com/route53/)). Figure 3.16 shows the final
    architecture diagram.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，如果您想使用友好的DNS名称来访问您的负载均衡器，而不是自动分配给负载均衡器的默认DNS名称，您可以为负载均衡器创建一个自定义域名并将其与负载均衡器的DNS名称关联。DNS配置可以在Amazon
    Route 53上完成（[https://aws.amazon.com/route53/](https://aws.amazon.com/route53/))）。图3.16显示了最终的架构图。
- en: '![](Images/CH03_F16_Labouardy.png)'
  id: totrans-132
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F16_Labouardy.png)'
- en: Figure 3.16 Jenkins cluster deployment on a custom VPC
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.16 自定义VPC上的Jenkins集群部署
- en: Adding workers to a Jenkins cluster is the typical way to scale Jenkins. However,
    you can set up multiple Jenkins masters with a proxy (typically, HAProxy or NGINX)
    to actively monitor the primary master and reroute requests to backup masters
    if the active master goes down. The Jenkins architecture for master instances
    will look like figure 3.17.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 向Jenkins集群添加工作节点是扩展Jenkins的典型方式。然而，您可以使用带有代理（通常是HAProxy或NGINX）的多个Jenkins主实例来主动监控主实例，并在活动主实例下线时将请求重定向到备份主实例。主实例的Jenkins架构将类似于图3.17。
- en: '![](Images/CH03_F17_Labouardy.png)'
  id: totrans-135
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F17_Labouardy.png)'
- en: Figure 3.17 The Jenkins master HA setup uses Amazon Elastic File System to persist
    the Jenkins home directory.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.17 Jenkins主实例高可用设置使用Amazon Elastic File System持久化Jenkins主目录。
- en: As you can see, the first tier is the reverse proxy. Whenever an incoming request
    for the build occurs, it will first reach the proxy. Then, the proxy will decide
    the instance to which the request can be routed. Here, one of the masters will
    be in the active state to serve requests, and the other one will be passive. Whenever
    a problem exists with the active master and it goes down, the other master will
    become active, and requests will resume. (We also can deploy Jenkins masters inside
    an ASG to ensure that a minimum number of masters is always available for backup).
    These requests will then be served by the master that has become active.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 如您所见，第一层是反向代理。每当有构建请求到来时，它将首先到达代理。然后，代理将决定请求可以路由到的实例。在这里，一个主实例将处于活动状态以处理请求，而另一个将处于被动状态。每当活动主实例出现问题并下线时，另一个主实例将变为活动状态，请求将恢复。（我们还可以在ASG内部部署Jenkins主实例以确保始终有足够的主实例用于备份）。这些请求将由变为活动状态的主实例处理。
- en: The second tier is Amazon Elastic File System, or EFS ([https://aws.amazon.com/efs/](https://aws.amazon.com/efs/)),
    which is used as a storage solution to persist the Jenkins home directory $JENKINS_HOME
    so both Jenkins masters can access and store Jenkins jobs. This storage solution
    can be mounted on multiple Jenkins instances concurrently. Amazon EFS, like any
    Network File System (NFS) server, supports full filesystem access semantics such
    as strong consistency and file locking.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 第二层是Amazon Elastic File System，或EFS（[https://aws.amazon.com/efs/](https://aws.amazon.com/efs/))，它用作存储解决方案以持久化Jenkins主目录$JENKINS_HOME，以便两个Jenkins主实例都可以访问和存储Jenkins作业。此存储解决方案可以同时挂载到多个Jenkins实例。Amazon
    EFS，就像任何网络文件系统（NFS）服务器一样，支持完整的文件系统访问语义，例如强一致性和文件锁定。
- en: EFS can also be used if you plan to deploy Jenkins on a Kubernetes cluster or
    Docker-based orchestration platforms like AWS ECS or Fargate. As the Jenkins master
    container can be launched on any node in the cluster, EFS can be used to persist
    the Jenkins data directory to preserve its state.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您计划在Kubernetes集群或基于Docker的编排平台（如AWS ECS或Fargate）上部署Jenkins，也可以使用EFS。由于Jenkins主容器可以在集群中的任何节点上启动，因此可以使用EFS将Jenkins数据目录持久化以保留其状态。
- en: Note Chapter 14 covers how to mount EFS in the $JENKINS_HOME directory to ensure
    that 100% of data is shared and can’t be lost in case of failure.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：第14章介绍了如何在$JENKINS_HOME目录中挂载EFS以确保100%的数据共享，并且在发生故障的情况下数据不会丢失。
- en: Now that the Jenkins architecture is clear, next we will prepare our AWS environment,
    and then install and configure the tools needed for upcoming chapters.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 现在Jenkins架构已经明确，接下来我们将准备我们的AWS环境，然后安装和配置后续章节所需的工具。
- en: 3.3.1 Preparing the AWS environment
  id: totrans-142
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 3.3.1 准备AWS环境
- en: This section will walk you through installing and configuring the AWS command
    line. The command-line interface (CLI) is a solid and mandatory tool that we’ll
    use in upcoming chapters. It will save us substantial time by automating the deployment
    and configuration of a Jenkins cluster on AWS with HashiCorp Terraform and Packer
    as well as defining CI/CD steps for cloud-native applications.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 本节将指导您安装和配置 AWS 命令行。命令行界面（CLI）是一个强大且必需的工具，我们将在后续章节中使用它。它将通过自动化 AWS 上 Jenkins
    集群的部署和配置以及定义云原生应用的 CI/CD 步骤来为我们节省大量时间。
- en: 3.3.2 Configuring the AWS CLI
  id: totrans-144
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 3.3.2 配置 AWS CLI
- en: The AWS CLI ([https://aws.amazon.com/cli/](https://aws.amazon.com/cli/)) is
    a powerful tool for managing your AWS services and resources from a terminal session.
    It was built on top of the AWS API, and hence everything that can be done through
    the AWS Management Console ([https://console.aws.amazon.com/console/home](https://console.aws.amazon.com/console/home))
    can be done with the CLI; this makes it a handy tool that can be used to automate
    and control your AWS infrastructure through scripts. Later chapters provide information
    on the use of the CLI with Jenkins to manage cloud-native applications in AWS.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: AWS CLI ([https://aws.amazon.com/cli/](https://aws.amazon.com/cli/)) 是一个强大的工具，可以从终端会话中管理您的
    AWS 服务和资源。它是建立在 AWS API 之上的，因此可以通过 CLI 完成通过 AWS 管理控制台 ([https://console.aws.amazon.com/console/home](https://console.aws.amazon.com/console/home))
    可以完成的所有操作；这使得它成为一个方便的工具，可以通过脚本自动化和控制您的 AWS 基础设施。后续章节将提供有关使用 CLI 与 Jenkins 管理 AWS
    中的云原生应用的信息。
- en: Let’s go through the installation process for the AWS CLI; you can find information
    on its configuration and testing in the AWS Management Console section. To get
    started, refer to the official documentation and follow the instructions to install
    the AWS CLI based on your operating system ([http://mng.bz/Yw8N](http://mng.bz/Yw8N)).
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们通过 AWS CLI 的安装过程；您可以在 AWS 管理控制台部分找到有关其配置和测试的信息。要开始，请参考官方文档，并根据您的操作系统说明安装
    AWS CLI ([http://mng.bz/Yw8N](http://mng.bz/Yw8N))。
- en: Once the AWS CLI is installed, you need to add the AWS CLI binary path to the
    `PATH` environment variable as follows.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦安装了 AWS CLI，您需要将 AWS CLI 二进制文件路径添加到 `PATH` 环境变量中，如下所示。
- en: For Windows, press the Windows key and type `Environment Variables`. In the
    Environment Variables window, highlight the `PATH` variable in the System Variables
    section. Edit it and add a path by placing a semicolon right after the last path,
    and then enter the complete path to the folder where the CLI binary is installed.
  id: totrans-148
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于 Windows，按 Windows 键并输入 `环境变量`。在环境变量窗口中，在系统变量部分突出显示 `PATH` 变量。编辑它，并在最后一个路径后放置一个分号，然后输入
    CLI 二进制文件安装的文件夹的完整路径。
- en: 'For Linux, Mac, or any UNIX system, open your shell’s profile script (.bash_profile,
    .profile, or .bash_login) and add the following line to the end of the file:'
  id: totrans-149
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于 Linux、Mac 或任何 UNIX 系统，打开您的 shell 配置文件（.bash_profile、.profile 或 .bash_login）并在文件末尾添加以下行：
- en: '[PRE2]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Finally, load the profile into your current session.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，将配置文件加载到当前会话中。
- en: '[PRE3]'
  id: totrans-152
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Verify that the CLI is correctly installed by opening a new terminal session
    and typing the following command:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 通过打开新的终端会话并输入以下命令来验证 CLI 是否正确安装：
- en: '[PRE4]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: You should be able to see the AWS CLI version; in my case, 2.0.0 is installed.
    Let’s test it out and list Amazon S3 buckets in the Frankfurt region as an example.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该能够看到 AWS CLI 版本；在我的情况下，已安装 2.0.0 版本。让我们测试一下，并以法兰克福地区为例列出 Amazon S3 存储桶。
- en: '[PRE5]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The previous command displays the following output.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 之前的命令显示以下输出。
- en: '![](Images/CH03_F17_UN_code.png)'
  id: totrans-158
  prefs: []
  type: TYPE_IMG
  zh: '![Images/CH03_F17_UN_code.png]'
- en: When using the CLI, you’ll generally need your AWS credentials to authenticate
    with AWS services. You can configure AWS credentials in multiple ways.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 当使用 CLI 时，您通常需要 AWS 凭据来验证 AWS 服务。您可以通过多种方式配置 AWS 凭据。
- en: '*Environment credentials*—Use the `AWS_ACCESS_KEY_ID` and `AWS_SECRET_KEY`
    variables. They can be useful for scripting or temporarily setting a named profile
    as the default.'
  id: totrans-160
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*环境凭证*—使用 `AWS_ACCESS_KEY_ID` 和 `AWS_SECRET_KEY` 变量。它们对于脚本编写或临时设置一个命名的配置文件为默认值非常有用。'
- en: Note If you set the environment variables at the terminal prompt, the values
    are saved for only the duration of the current session. To make the environment
    variable settings persistent across all terminal sessions, store them under /etc/profile
    or in ~/.bash_profile for the current user.
  id: totrans-161
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 注意：如果您在终端提示符下设置环境变量，则这些值仅保存为当前会话的持续时间。为了使环境变量设置在所有终端会话中持久，请将它们存储在 /etc/profile
    或当前用户的 ~/.bash_profile 中。
- en: '*Shared Credentials file*—The AWS CLI stores the credentials in a local file
    named *credentials* under the .aws folder in your home directory. You can specify
    a nondefault location for the credentials file by setting the `AWS_SHARED_CREDENTIALS_FILE`
    environment variable to another local path.'
  id: totrans-162
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*共享凭证文件*——AWS CLI 将凭证存储在您主目录下 .aws 文件夹中的名为 *credentials* 的本地文件中。您可以通过将 `AWS_SHARED_CREDENTIALS_FILE`
    环境变量设置为另一个本地路径来指定凭证文件的默认位置。'
- en: '*IAM roles*—If you’re using the CLI in an EC2 instance, this removes the need
    to manage credential files in production. Each Amazon EC2 instance contains metadata
    that the AWS CLI can directly query for temporary credentials.'
  id: totrans-163
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*IAM 角色*——如果您在 EC2 实例中使用 CLI，这可以消除在生产环境中管理凭证文件的需求。每个 Amazon EC2 实例都包含 AWS CLI
    可以直接查询以获取临时凭证的元数据。'
- en: In the next section, I will show you how to create a new user for the AWS CLI
    with the AWS Identity and Access Management (IAM) service.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，我将向您展示如何使用 AWS 身份和访问管理（IAM）服务为 AWS CLI 创建新用户。
- en: 3.3.3 Creating and managing the IAM user
  id: totrans-165
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 3.3.3 创建和管理 IAM 用户
- en: IAM ([https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)) is a service
    that allows you to manage users, groups, and their level of access to AWS services.
    It’s strongly recommended that you do not use the AWS root account for any task
    except billing tasks, as it has the ultimate authority to create and delete IAM
    users, change billing, close the account, and perform all other actions on your
    AWS account. Therefore, we will create a new IAM user and grant it the permissions
    it needs to access the right AWS resources following the principle of least privilege.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: IAM ([https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)) 是一项服务，允许您管理用户、组和他们对
    AWS 服务的访问级别。强烈建议您不要使用 AWS 根账户执行任何除计费任务以外的任务，因为它具有创建和删除 IAM 用户、更改计费、关闭账户以及执行您 AWS
    账户上所有其他操作的最终权限。因此，我们将创建一个新的 IAM 用户，并按照最小权限原则授予它访问正确 AWS 资源所需的权限。
- en: Note The *principle of least privilege* (PoLP) works by giving a given user
    only the minimum levels of access—or permissions—needed to perform the required
    task.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：*最小权限原则*（PoLP）通过仅授予用户执行所需任务所需的最小访问级别或权限来实现。
- en: Sign in to AWS Management Console by using your AWS email address and password.
    Then, open the IAM console from the Security, Identity & Compliance section or
    type `IAM` in the search bar; figure 3.18 shows the console.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 使用您的 AWS 电子邮件地址和密码登录 AWS 管理控制台。然后，从安全、身份与合规部分打开 IAM 控制台或直接在搜索栏中输入 `IAM`；图 3.18
    展示了控制台界面。
- en: '![](Images/CH03_F18_Labouardy.png)'
  id: totrans-169
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F18_Labouardy.png)'
- en: Figure 3.18 AWS Management Console
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.18 AWS 管理控制台
- en: From the navigation pane, choose Users. Click the Add User button. Then set
    a name for the user and select Programmatic Access (also select AWS Management
    Console access if you want the same user to have access to the console), as shown
    in figure 3.19.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 从导航面板中选择用户。点击添加用户按钮。然后为用户设置一个名称，并选择程序访问（如果您希望同一用户能够访问控制台，也可以选择 AWS 管理控制台访问），如图
    3.19 所示。
- en: '![](Images/CH03_F19_Labouardy.png)'
  id: totrans-172
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F19_Labouardy.png)'
- en: Figure 3.19 Creating a new IAM user
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.19 创建新的 IAM 用户
- en: In the Set Permissions section, assign the AmazonS3FullAccess policy to the
    user, as shown in figure 3.20.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 在设置权限部分，将 AmazonS3FullAccess 策略分配给用户，如图 3.20 所示。
- en: '![](Images/CH03_F20_Labouardy.png)'
  id: totrans-175
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F20_Labouardy.png)'
- en: Figure 3.20 Attaching IAM policies to the user
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.20 将 IAM 策略附加到用户
- en: Note It’s better to be granular and specify only permissions that are needed
    to get the job done (leave privilege access). Start with a minimum set of permissions
    and add more permissions only if necessary.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：最好细化权限，仅指定完成任务所需的权限（保留特权访问）。从最小权限集开始，仅在必要时添加更多权限。
- en: On the final page, you should see the user’s AWS credentials (figure 3.21).
    Make sure you save the access keys in a safe location, as you won’t be able to
    see them again.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 在最后一页，您应该能看到用户的 AWS 凭证（图 3.21）。请确保将访问密钥保存在安全的位置，因为您将无法再次看到它们。
- en: '![](Images/CH03_F21_Labouardy.png)'
  id: totrans-179
  prefs: []
  type: TYPE_IMG
  zh: '![](Images/CH03_F21_Labouardy.png)'
- en: Figure 3.21 AWS credentials generation
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.21 AWS 凭证生成
- en: Note You can create IAM users to represent users, applications, or services.
    In the next chapter, we will create dedicated IAM users for HashiCorp Terraform
    and Packer tools.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：您可以使用 IAM 用户来代表用户、应用程序或服务。在下一章中，我们将为 HashiCorp Terraform 和 Packer 工具创建专门的
    IAM 用户。
- en: 'Next, configure the AWS CLI by using the `aws configure` command. The CLI will
    store credentials specified in the preceding command in a local file under ~/.aws/
    credentials (or in %UserProfile%\.aws\credentials on Windows) with the following
    content (substitute `eu-central-1` with your AWS region):'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，使用`aws configure`命令配置AWS CLI。CLI会将前一个命令中指定的凭证存储在本地文件`~/.aws/credentials`下（或在Windows上的`%UserProfile%\.aws\credentials`），内容如下（将`eu-central-1`替换为您的AWS区域）：
- en: '[PRE6]'
  id: totrans-183
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Note You can override the region in which your AWS resources are located by
    using the `AWS_DEFAULT_REGION` environment variable of the `--region` command-line
    option.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：您可以通过使用`--region`命令行选项的`AWS_DEFAULT_REGION`环境变量来覆盖您的AWS资源所在区域。
- en: 'That should be it; try out the following command and, if you have an S3 bucket,
    you should be able to see the credentials listed. Otherwise, the command will
    return no results:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 应该就是这样；尝试以下命令，如果您有一个S3存储桶，您应该能够看到列出的凭证。否则，命令将返回无结果：
- en: '[PRE7]'
  id: totrans-186
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Now that the AWS environment is set up, let’s get down to business and deploy
    a Jenkins cluster on AWS.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 现在AWS环境已经设置好了，让我们开始部署AWS上的Jenkins集群。
- en: Summary
  id: totrans-188
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: Deploying Jenkins in distributed builds mode allows for decoupling orchestration,
    build executions, and better performance.
  id: totrans-189
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在分布式构建模式下部署Jenkins允许解耦编排、构建执行，并提高性能。
- en: Jenkins is a crucial component of the DevOps chain, and its downtime may have
    adverse effects on the DevOps environment. To overcome these, you need a high-availability
    setup for Jenkins.
  id: totrans-190
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Jenkins是DevOps链中的关键组件，其停机可能会对DevOps环境产生不利影响。为了克服这些，您需要一个高可用性的Jenkins设置。
- en: AWS CloudWatch provides a rich set of metrics to monitor the health of EC2 instances.
    The metrics collected can be used to set up alarms and trigger scaling policies
    upon alarm firing such as scaling Jenkins workers.
  id: totrans-191
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: AWS CloudWatch提供了一套丰富的指标来监控EC2实例的健康状况。收集的指标可以用于设置警报，并在警报触发时触发扩展策略，例如扩展Jenkins工作节点。
- en: Delegating the workload of building projects to worker nodes is referred to
    as distributed builds.
  id: totrans-192
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将构建项目的负载委托给工作节点被称为分布式构建。
- en: You can configure a build to run on a particular worker machine by using Jenkins
    labels.
  id: totrans-193
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以通过使用Jenkins标签来配置构建在特定的工作机器上运行。
- en: It’s highly recommended to launch your Jenkins deployment within a private subnet
    in a VPC for security purposes.
  id: totrans-194
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 非常推荐在VPC的私有子网中启动您的Jenkins部署，出于安全考虑。
- en: By assigning labels to nodes, you can specify the resources you want to use
    for specific jobs, and set up graceful queuing for your tests.
  id: totrans-195
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过给节点分配标签，您可以指定用于特定作业的资源，并为您的测试设置优雅的排队。
