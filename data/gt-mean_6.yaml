- en: Appendix C. Dealing with all the views
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 附录C. 处理所有视图
- en: '*This appendix covers*'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: '*本附录涵盖*'
- en: Removing the data from all views except the homepage
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从所有视图（除了主页）中移除数据
- en: Moving the data into the controllers
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将数据移动到控制器中
- en: '[Chapter 4](kindle_split_015.xhtml#ch04) covers setting up the controllers
    and the views for the static, clickable prototype. The “how” and “why” are covered
    in that chapter in more detail, so this appendix focuses on the results.'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: '[第4章](kindle_split_015.xhtml#ch04) 讨论了设置控制器和视图以创建静态、可点击的原型。该章节更详细地介绍了“如何”和“为什么”，因此本附录专注于结果。'
- en: Moving the data from the views to the controllers
  id: totrans-5
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 将数据从视图移动到控制器
- en: Part of this process includes moving the data back down the MVC flow, from the
    views into the controllers. The example in [chapter 4](kindle_split_015.xhtml#ch04)
    deals with this task in the Loc8r homepage, but it needs to be done for the other
    pages too. Start with the Details page.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 此过程的一部分包括将数据从视图移动回MVC流程，即从视图移动到控制器。第4章中的示例处理了Loc8r主页中的此任务，但还需要对其他页面执行此操作。从详情页面开始。
- en: Details page
  id: totrans-7
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 详情页面
- en: The Details page is the largest and most complex of the pages, with the most
    data requirements. The first step is setting up the controller.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 详情页面是页面中最大、最复杂的，数据需求也最多。第一步是设置控制器。
- en: Setting up the controller
  id: totrans-9
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 设置控制器
- en: The controller for this page is called `locationInfo` and is in the locations.js
    file in app_server/controllers. When you’ve analyzed the data in the view and
    collated it into a JavaScript object, your controller will look something like
    the following listing.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 此页面的控制器称为 `locationInfo`，位于 `app_server/controllers` 中的 `locations.js` 文件。当您在视图中分析数据并将其整理成JavaScript对象时，您的控制器将类似于以下列表。
- en: Listing C.1\. `locationInfo` controller
  id: totrans-11
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表C.1\. `locationInfo` 控制器
- en: '[PRE0]'
  id: totrans-12
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '***1* Includes latitude and longitude coordinates to use in Google Map image**'
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***1* 包含用于在Google地图图像中使用的纬度和经度坐标**'
- en: '***2* Adds array of open times, allowing for different data on different days**'
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***2* 添加了开放时间数组，允许不同日期有不同的数据**'
- en: '***3* Array for reviews left by other users**'
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***3* 存储其他用户留下的评论的数组**'
- en: Note the latitude and longitude being sent through. You can get your current
    latitude and longitude from [https://www.where-am-i.net](https://www.where-am-i.net).
    You can geocode an address—that is, get the latitude and longitude of it—from
    [https://www.latlong.net/convert-address-to-lat-long.html](https://www.latlong.net/convert-address-to-lat-long.html).
    Your views will be using the `lat` and `lng` to display a Google Map image of
    the correct location, so it’s worthwhile doing this for the prototype stage.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 注意发送的纬度和经度。您可以从 [https://www.where-am-i.net](https://www.where-am-i.net) 获取您的当前纬度和经度。您可以从
    [https://www.latlong.net/convert-address-to-lat-long.html](https://www.latlong.net/convert-address-to-lat-long.html)
    将地址地理编码——即获取其纬度和经度。您的视图将使用 `lat` 和 `lng` 来显示正确位置的Google地图图像，因此在原型阶段这样做是值得的。
- en: Updating the view
  id: totrans-17
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 更新视图
- en: As this page is the most complex, data-rich page, it stands to reason that it
    will have the largest view template. You’ve already seen most of the technicalities
    in the homepage layout, such as looping through arrays, bringing in includes,
    and defining and calling mixins. You have a couple of extra things to look out
    for in this template, though, both of which are annotated and highlighted in bold.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 由于这个页面是最复杂、数据最丰富的页面，因此可以合理地推断它将拥有最大的视图模板。您已经看到了主页布局中的大多数技术细节，例如循环数组、引入包含文件以及定义和调用混入。不过，在这个模板中还有几样额外的东西需要注意，这两者都已被注释并用粗体突出显示。
- en: First, this template uses an `if`-`else` conditional statement. This statement
    looks like JavaScript without the braces. Second, the template uses a JavaScript
    `replace` function to replace all line breaks in the text of reviews with `<br/>`
    tags. You do this by using a simple regular expression, looking for all occurrences
    of the characters `\n` in the text. The following listing shows the `location-info.pug`
    view template in full.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，此模板使用了一个 `if`-`else` 条件语句。这个语句看起来像是没有花括号的JavaScript。其次，模板使用JavaScript `replace`
    函数将评论文本中的所有换行符替换为 `<br/>` 标签。您通过使用简单的正则表达式，查找文本中所有 `\n` 字符的出现来完成此操作。以下列表显示了 `location-info.pug`
    视图模板的完整内容。
- en: Listing C.2\. `location-info.pug` view template in app_server/views
  id: totrans-20
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表C.2\. `location-info.pug` 视图模板位于 `app_server/views`
- en: '[PRE1]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '***1* Brings in sharedHTMLfunctions include, which contains outputRating mixin**'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***1* 引入了包含 `sharedHTMLfunctions` 的文件，其中包含 `outputRating` 混入**'
- en: '***2* Calls outputRating mixin, sending it the rating of the current location**'
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***2* 调用`outputRating`混合，传递当前位置的评分**'
- en: '***3* Loops through the array of open times, checking whether the location
    is closed by using an inline if-else statement**'
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***3* 遍历开放时间数组，使用内联if-else语句检查位置是否关闭**'
- en: '***4* Builds the URL for the Google Maps static image, inserting lat and lng
    by using an ES2015 template literal. Remember that you’ll need your Google Maps
    API Key.**'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***4* 构建Google Maps静态图像的URL，使用ES2015模板字面量插入lat和lng。请记住，你需要你的Google Maps API密钥。**'
- en: '***5* Loops through each review, calling the outputRating mixin again to generate
    markup for stars**'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***5* 遍历每个评论，再次调用`outputRating`混合以生成星级标记**'
- en: '***6* Replaces any line breaks in review text with the <br/> tag so it renders
    as intended by the author**'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***6* 将评论文本中的任何换行符替换为<br/>标签，以便按作者的意图渲染**'
- en: A question that may arise is, why replace line breaks with `<br/>` tags every
    time? Why don’t you save the data with `<br/>` tags in? That way, you have to
    run the `replace` function only once, when the data is saved. The answer is that
    HTML is only one method of rendering text; it happens to be the one you’re using
    here. Down the line, you may want to pull this information into a native mobile
    application. You don’t want the source data tainted with HTML markup that you
    don’t use in that environment. The way to handle that is to keep the data clean.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 可能会出现的疑问是，为什么每次都要将换行符替换为`<br/>`标签？为什么不直接在保存数据时使用`<br/>`标签呢？那样的话，你只需要在数据保存时运行一次`replace`函数。答案是，HTML只是渲染文本的一种方法；碰巧你在这里使用的是这种方法。将来，你可能希望将此信息拉入原生移动应用程序。你不想源数据被在该环境中不使用的HTML标记污染。处理这种情况的方法是保持数据干净。
- en: Add Review page
  id: totrans-29
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 添加评论页面
- en: 'The Add Review page is simple at the moment, with only one piece of data in
    it: the title in the page header. Updating the controller shouldn’t pose much
    of a problem. See the following listing for the full code of the `addReview` controller,
    in locations.js in the app_server/controllers folder.'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 目前“添加评论”页面很简单，其中只包含一条数据：页面标题中的标题。更新控制器不应该引起太多问题。请参阅以下列表，以获取`addReview`控制器在`app_server/controllers`文件夹中`locations.js`的完整代码。
- en: Listing C.3\. `addReview` controller
  id: totrans-31
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表C.3\. `addReview` 控制器
- en: '[PRE2]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: There’s not much to talk about here; you’ve updated the text inside the titles.
    The following listing shows the corresponding view, `location-review-form.pug`,
    in app_server/views.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 这里没有太多可说的；你已经更新了标题内的文本。以下列表显示了相应的视图，`location-review-form.pug`，在`app_server/views`。
- en: Listing C.4\. `location-review-form.pug` template
  id: totrans-34
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表C.4\. `location-review-form.pug` 模板
- en: '[PRE3]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Again, there’s nothing complicated or new here, so you can move on to the About
    page.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 再次强调，这里没有复杂或新的内容，所以你可以继续到“关于”页面。
- en: About page
  id: totrans-37
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 关于页面
- en: The About page doesn’t contain a huge amount of data, either, only a title and
    some content. Pull it out of the view and into the controller. Note that the content
    in the view currently has some `<br/>` tags in it, so replace each `<br/>` tag
    with `\n` when you put it into the controller. These tags are highlighted in bold
    in the following listing. The `about` controller is in app_server/controllers/others.js.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: “关于”页面也不包含大量的数据，只有标题和一些内容。将其从视图中提取到控制器中。请注意，视图中的内容目前包含一些`<br/>`标签，所以在将其放入控制器时，需要将每个`<br/>`标签替换为`\n`。这些标签在以下列表中用粗体突出显示。`about`控制器位于`app_server/controllers/others.js`。
- en: Listing C.5\. `about` controller
  id: totrans-39
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表C.5\. `about` 控制器
- en: '[PRE4]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Aside from removing the HTML from the content, not much is going on here. Take
    a quick look at the view, and you’ll be done. The following listing shows the
    final generic-text view used for the About page in app_server/views. The view
    has to use the same piece of code as the reviews section to replace the `\n` line
    breaks with HTML `<br/>` tags.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 除了从内容中移除HTML之外，这里没有太多的事情发生。快速查看视图，你就可以完成了。以下列表显示了用于`app_server/views`中“关于”页面的最终通用文本视图。视图必须使用与评论部分相同的代码来替换`\n`换行符为HTML
    `<br/>`标签。
- en: Listing C.6\. `generic-text.pug` template
  id: totrans-42
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表C.6\. `generic-text.pug` 模板
- en: '[PRE5]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '***1* Replaces all line breaks with <br/> tags when rendering HTML**'
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***1* 在渲染HTML时将所有换行符替换为<br/>标签**'
- en: This template is a simple, small, reusable one to use whenever you want to output
    some text on a page.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 这个模板是一个简单、小巧、可重复使用的模板，用于在页面上输出文本时使用。
- en: Switching from Promises to Observables
  id: totrans-46
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 从Promise切换到Observables
- en: In [chapter 8](kindle_split_020.xhtml#ch08), we briefly discuss Observables
    and Promises and then proceed to use Promises in the application. Changing the
    application to use Observables isn’t difficult, though, and this brief section
    covers the basics to give you a complete picture of how this task might be achieved.
    Typically, an SPA uses both Observables and Promises, depending on the problem
    that’s being solved.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 在 [第 8 章](kindle_split_020.xhtml#ch08) 中，我们简要讨论了 Observables 和 Promises，然后继续在应用程序中使用
    Promises。不过，将应用程序更改为使用 Observables 并不难，本节简要介绍了基础知识，以给你一个完整的了解，了解这项任务可能如何完成。通常，SPA
    会根据要解决的问题使用 Observables 和 Promises。
- en: Take a look at the `getLocations()` method in loc8r-data.service.ts.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 查看位于 loc8r-data.service.ts 中的 `getLocations()` 方法。
- en: Listing C.7\. loc8r-data.servce.ts
  id: totrans-49
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 C.7\. loc8r-data.service.ts
- en: '[PRE6]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: '***1* Conversion of Observable to Promise**'
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***1* 将 Observable 转换为 Promise**'
- en: As you can see, you’re taking the Observable returned by the `HttpClient get()`
    method and converting it to a Promise.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，你正在将 `HttpClient get()` 方法返回的 Observable 转换为 Promise。
- en: To switch this method to return an Observable, you first need to import Observable
    from `rxjs`, and then have the function return the result of the `get()` method
    directly.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 要将此方法切换为返回 Observable，你首先需要从 `rxjs` 中导入 Observable，然后让函数直接返回 `get()` 方法的结果。
- en: Listing C.8\. Changes to loc8r-data.service.ts required to return Observables
  id: totrans-54
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 C.8\. 修改 loc8r-data.service.ts 以返回 Observables
- en: '[PRE7]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '***1* Returns a Observable type cast to Location[]**'
  id: totrans-56
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***1* 返回 Observable 类型转换为 Location[]**'
- en: At this point, you’re not capturing the response (Observable); to do that, you
    need a subscriber. This function is used in the home-list component.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一点上，你没有捕获响应（Observable）；为了做到这一点，你需要一个订阅者。这个函数用于 home-list 组件中。
- en: Listing C.9\. `getLocations()` from home-list.component.ts
  id: totrans-58
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 C.9\. `getLocations()` 来自 home-list.component.ts
- en: '[PRE8]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '***1* Responds to the Promise**'
  id: totrans-60
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***1* 响应 Promise**'
- en: To use the Observable, you need to alter the previous listing.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用 Observable，你需要修改之前的列表。
- en: Listing C.10\. Changes to subscribe to Observables
  id: totrans-62
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 C.10\. 订阅 Observables 的更改
- en: '[PRE9]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '***1* Observable subscriber**'
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***1* Observable 订阅者**'
- en: '***2* Error handler**'
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '***2* 错误处理程序**'
- en: As you can see, switching between methods isn’t difficult. The choice of method
    depends on the situation at hand. For reference, however, using Observables is
    becoming standard practice.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，切换方法并不困难。方法的选择取决于具体情况。不过，为了参考，使用 Observables 正在成为标准做法。
