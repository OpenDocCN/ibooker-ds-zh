- en: C
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: C
- en: Interoperability between an F# asynchronous workflow and .NET Task
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: F# 异步工作流与 .NET Task 之间的互操作性
- en: Despite the similarities between the asynchronous programming models exposed
    by C# and F# programming languages, their interoperability isn’t a trivial accomplishment.
    F# programs tend to use more asynchronous computation expressions than .NET Task.
    Both types are similar, but they do have semantic differences, as shown in chapters
    7 and 8\. For example, tasks start immediately after their creation, while F#
    `Async` must be explicitly started.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管 C# 和 F# 编程语言公开的异步编程模型之间存在相似之处，但它们的互操作性并非易事。F# 程序倾向于使用比 .NET Task 更多的异步计算表达式。这两种类型相似，但它们确实存在语义差异，如第
    7 章和第 8 章所示。例如，任务在其创建后立即开始，而 F# 的 `Async` 必须显式启动。
- en: How can you interop between F# asynchronous computation expressions and .NET
    Task? It’s possible to use F# functions such as `Async.StartAsTask<T>` and `Async.AwaitTask<T>`
    to interop with a C# library that returns or awaits a `Task` type.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 你如何实现 F# 异步计算表达式与 .NET Task 之间的互操作性？可以使用 F# 函数，如 `Async.StartAsTask<T>` 和 `Async.AwaitTask<T>`，与返回或等待
    `Task` 类型的 C# 库进行互操作。
- en: Conversely, there are no equivalent methods for converting an F# `Async` to
    a `Task` type. It would be helpful to use the built-in F# `Async.Parallel` computation
    in C#. In this listing, repeated from chapter 9, the F# `downloadMediaAsyncParallel`
    function downloads asynchronously in parallel images from Azure Blob storage.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 相反，没有将 F# 的 `Async` 转换为 `Task` 类型的等效方法。在 C# 中使用内置的 F# `Async.Parallel` 计算会很有帮助。在此列表中，重复第
    9 章的内容，F# 的 `downloadMediaAsyncParallel` 函数异步并行地从 Azure Blob 存储下载图像。
- en: Listing C.1 `Async` parallel function to download images from Azure Blob storage
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 C.1 `Async` 并行函数，用于从 Azure Blob 存储下载图像
- en: '[PRE0]'
  id: totrans-6
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'The return type from `downloadMediaAsyncParallel` is an `Async<Image[]>`. As
    mentioned, an F# `Async` type is in general difficult to interop with and acts
    as a task (`async/await`) from the C# code. In the following code snippet, the
    C# code runs the F# `download­MediaAsyncParallel` function as a `Task` using the
    `Async.Parallel` operator:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: '`downloadMediaAsyncParallel` 的返回类型是 `Async<Image[]>`。如前所述，F# 的 `Async` 类型通常难以互操作，并从
    C# 代码中作为任务（`async/await`）执行。在下面的代码片段中，C# 代码使用 `Async.Parallel` 操作符将 F# 的 `downloadMediaAsyncParallel`
    函数作为 `Task` 运行：'
- en: '[PRE1]'
  id: totrans-8
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: The code interoperability becomes effortless with the help of the `AsTask` extensions
    method. The interoperability solution is to implement a utilities F# module that
    exposes a set of extension methods that can be consumed by other .NET languages.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 在 `AsTask` 扩展方法的帮助下，代码互操作性变得毫不费力。互操作性解决方案是实现一个工具 F# 模块，该模块公开了一组扩展方法，这些方法可以被其他
    .NET 语言消费。
- en: Listing C.2 Helper extension methods to interop `Task` and an async workflow
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 C.2 用于互操作 `Task` 和异步工作流的辅助扩展方法
- en: '[PRE2]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: The `AsyncInterop` module is private, but the core functions that allow interoperability
    between the F# `Async` and the C# `Task` are exposed through the `AsyncInteropExtensions`
    type. The attribute `Extension` upgrades the methods as an extension, making it
    accessible by other .NET programming languages.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: '`AsyncInterop` 模块是私有的，但允许 F# 的 `Async` 和 C# 的 `Task` 之间互操作的核心函数通过 `AsyncInteropExtensions`
    类型公开。属性 `Extension` 将方法升级为扩展，使其可由其他 .NET 编程语言访问。'
- en: The `asTask` method converts an F# `Async` type to a `Task`, starting the asynchronous
    operation with the `Async.StartWithContinuations` function. Internally, this function
    uses the `TaskCompletionSource` to return an instance of a `Task`, which maintains
    the state of the operation. When the operation completes, the returned state can
    be a cancellation, an exception, or the actual result if successful.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '`asTask` 方法将 F# 的 `Async` 类型转换为 `Task` 类型，并通过 `Async.StartWithContinuations`
    函数启动异步操作。内部，此函数使用 `TaskCompletionSource` 返回一个 `Task` 实例，该实例维护操作的状态。当操作完成时，返回的状态可以是取消、异常，或者如果成功，则是实际的结果。'
- en: The function `asAsync` aims to convert a `Task` into an F# `Async` type. This
    function uses `Async.FromContinuations` to create an asynchronous computation,
    which provides the callback that will execute one of the given continuations for
    success, exception, or cancellation.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 函数 `asAsync` 的目的是将 `Task` 转换为 F# 的 `Async` 类型。此函数使用 `Async.FromContinuations`
    创建异步计算，该计算提供回调，该回调将执行给定的成功、异常或取消的其中一个后续操作。
- en: All these functions take as a second argument an optional `CancellationToken`,
    which can be used to stop the current operation. If no token is provided, then
    the `DefaultCancellationToken` in the context will be assigned by default.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 所有这些函数都将一个可选的 `CancellationToken` 作为第二个参数，该参数可用于停止当前操作。如果没有提供令牌，则默认情况下将分配上下文中的
    `DefaultCancellationToken`。
- en: These functions provide interoperability between the Task-based Asynchronous
    Pattern (TAP) of .NET TPL and the F# asynchronous programming model.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 这些函数提供了 .NET TPL 的基于任务的异步模式 (TAP) 与 F# 异步编程模型之间的互操作性。
