- en: '20 Capstone: Forecasting the monthly average retail price of steak in Canada'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 20 综合项目：预测加拿大牛肉的月平均零售价格
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Developing a forecasting model to predict the monthly average retail price of
    steak in Canada
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 开发预测模型以预测加拿大牛肉的月平均零售价格
- en: Using Prophet’s cross-validation functionality
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Prophet的交叉验证功能
- en: Developing a SARIMA model and comparing its performance to Prophet to determine
    the champion model
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 开发SARIMA模型，并将其性能与Prophet进行比较，以确定冠军模型
- en: 'Again, congratulations on making it this far! We have come a long way since
    the beginning of this book. We first defined time series and learned how to forecast
    them using statistical models that generalize as the SARIMAX model. Then we turned
    to large, high-dimensional datasets and used deep learning for time series forecasting.
    In the previous chapter, we covered one of the most popular libraries for automating
    the entire forecasting process: Prophet. We developed two forecasting models using
    Prophet and saw how quick and easy it is to generate accurate predictions with
    few manual steps.'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 再次，恭喜你走到这一步！自从本书开始以来，我们已经走了很长的路。我们首先定义了时间序列，并学习了如何使用SARIMAX模型这类统计模型来预测它们。然后我们转向大型、高维数据集，并使用深度学习进行时间序列预测。在前一章中，我们介绍了一个用于自动化整个预测过程的流行库：Prophet。我们使用Prophet开发了两个预测模型，并看到了如何通过少量手动步骤快速轻松地生成准确的预测。
- en: In this last capstone project, we’ll use everything you have learned in this
    book to forecast the monthly average retail price of steak in Canada. At this
    point, we have a robust methodology and a wide array of tools to develop a performant
    forecasting model.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个最后的综合项目中，我们将利用本书中学到的所有知识来预测加拿大牛肉的月平均零售价格。到目前为止，我们拥有一个稳健的方法论和一系列广泛的工具来开发一个性能良好的预测模型。
- en: 20.1 Understanding the capstone project
  id: totrans-7
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 20.1 理解综合项目
- en: 'For this project, we’ll use the historical monthly average retail price of
    food in Canada, from 1995 to today. Note that at the time of writing, the data
    for December 2021 and onward was not available. The dataset, titled “Monthly average
    retail prices for food and other selected products,” is available for download
    from Statistics Canada here: [www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810000201](http://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810000201).'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个项目，我们将使用从1995年到今天的加拿大食品历史月平均零售价格。请注意，在撰写本文时，2021年12月及以后的数据尚未可用。数据集名为“食品和其他选定产品的月平均零售价格”，可以从加拿大统计局下载：[www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810000201](http://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810000201)。
- en: The price of a basket of goods is an important macroeconomic indicator. This
    is what composes the consumer price index (CPI), which is used to determine if
    there is an inflationary or deflationary period. This in turn allows analysts
    to assess the effectiveness of the economic policy, and it can of course impact
    programs of government assistance, such as social security. If the price of goods
    is expected to rise, the amount reserved for social security should technically
    increase.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 一篮子商品的价格是一个重要的宏观经济指标。这是消费者价格指数（CPI）的组成部分，用于确定是否存在通货膨胀或通货紧缩时期。这反过来又允许分析师评估经济政策的有效性，当然，它还可以影响政府援助计划，如社会保障。如果预计商品价格将上涨，社会保障的预留金额在技术上应该增加。
- en: The original dataset contains the monthly average retail price of 52 goods,
    from 1 kilogram of round steak to a dozen eggs, 60 grams of deodorant, and gasoline,
    to name a few. The price is reported in Canadian dollars for every month starting
    in 1995 to November 2021\. For this project, we’ll focus specifically on forecasting
    the price of 1 kg of round steak.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 原始数据集包含52种商品的月平均零售价格，从1公斤圆牛肉到一打鸡蛋，60克除臭剂，以及汽油等。价格以加拿大元为单位，从1995年开始到2021年11月。对于这个项目，我们将专注于预测1公斤圆牛肉的价格。
- en: 20.1.1 Objective of the capstone project
  id: totrans-11
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 20.1.1 综合项目的目标
- en: The objective of this capstone project is to create a model that can forecast
    the monthly average retail price of 1 kg of round steak over the next 36 months.
    If you feel confident, you can download the dataset and develop a forecasting
    model. Feel free to use Prophet.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 这个综合项目的目标是创建一个模型，可以预测未来36个月内1公斤圆牛肉的月平均零售价格。如果你有信心，可以下载数据集并开发一个预测模型。请随意使用Prophet。
- en: 'If you feel you need a little more guidance, here are the steps that need to
    be completed:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你觉得自己需要更多指导，以下是需要完成的步骤：
- en: Clean the data so you only have information regarding 1 kg of round steak.
  id: totrans-14
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 清洗数据，以便您只有关于1公斤圆牛排的信息。
- en: Rename the columns according to Prophet’s convention.
  id: totrans-15
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 根据Prophet的约定重命名列。
- en: Format the date correctly. The datestamp only has the year and month, so the
    day must be added. Recall that we are working with monthly averages, so does it
    make sense to add the first day of the month, or the last day of the month?
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 正确格式化日期。日期戳只有年和月，所以必须添加日。回想一下，我们正在处理月平均数，那么添加月初还是月末更有意义呢？
- en: Use cross-validation for hyperparameter tuning with Prophet.
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用Prophet进行超参数调整的交叉验证。
- en: Fit a Prophet model with the optimal parameters.
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用最佳参数拟合Prophet模型。
- en: Forecast over the test set.
  id: totrans-19
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在测试集上进行预测。
- en: Evaluate your model using the mean absolute error (MAE).
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用平均绝对误差（MAE）评估您的模型。
- en: Compare your model to a baseline.
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将您的模型与基线进行比较。
- en: 'There is one more optional, but highly recommended, step:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 还有另一个可选但强烈推荐的步骤：
- en: Develop a SARIMA model and compare its performance to Prophet. Did it do better?
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 开发一个SARIMA模型，并将其性能与Prophet进行比较。它做得更好吗？
- en: 'You now have all the steps required to successfully complete this project.
    I highly recommend that you try it on your own first. At any point, you can refer
    to the following sections for a detailed walkthrough. Also, the entire solution
    is available on GitHub: [https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH20](https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH20).
    Good luck!'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 您现在拥有了成功完成此项目所需的所有步骤。我强烈建议您先自己尝试。在任何时候，您都可以参考以下部分以获取详细说明。此外，整个解决方案在GitHub上可用：[https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH20](https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH20)。祝您好运！
- en: 20.2 Data preprocessing and visualization
  id: totrans-25
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 20.2 数据预处理和可视化
- en: We’ll start by preprocessing the data in order to train a Prophet model. At
    the same time, we’ll visualize our time series to deduce some of its properties.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将首先预处理数据以训练Prophet模型。同时，我们将可视化我们的时间序列以推断其一些属性。
- en: First we’ll import the required libraries.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们将导入所需的库。
- en: '[PRE0]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: I also like to set some general parameters for the figures. Here we’ll specify
    the size and remove the grid from the plots.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 我还喜欢为图形设置一些通用参数。在这里，我们将指定大小并从图中移除网格。
- en: '[PRE1]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Next, we’ll read the data. You can download it from this Statistics Canada ([www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810000201](http://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810000201)),
    although you are likely to get a more up-to-date version of the dataset since
    I only had data up to November 2021 when writing this book. If you wish to recreate
    the results shown here, I suggest you use the CSV file in the GitHub repository
    for this chapter ([https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH20](https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH20)).
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将读取数据。您可以从这里下载它（[www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810000201](http://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810000201)），尽管您很可能会得到一个更新版本的数据库，因为我在写这本书时只有到2021年11月的数据。如果您想重现这里显示的结果，我建议您使用GitHub仓库中该章节的CSV文件（[https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH20](https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH20)）。
- en: '[PRE2]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: In its original form, the dataset contains the monthly average retail price
    of 52 products, from January 1995 to November 2021\. We wish to specifically forecast
    the retail price of 1 kg of round steak, so we can filter the data accordingly.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 在其原始形式中，该数据库包含从1995年1月到2021年11月的52种产品的月平均零售价。我们希望特别预测1公斤圆牛排的零售价，因此我们可以相应地筛选数据。
- en: '[PRE3]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The next step is to remove unnecessary columns and only keep the REF_DATE column,
    which contains the month and year for the data point, and the VALUE column, which
    contains the average retail price for that month.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 下一步是删除不必要的列，只保留包含数据点的月份和年份的REF_DATE列，以及包含该月平均零售价的VALUE列。
- en: '[PRE4]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: We now have a dataset with 2 columns and 323 rows. This is a good time to visualize
    our time series. The result is shown in figure 20.1.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们有一个2列和323行的数据集。这是可视化我们的时间序列的好时机。结果如图20.1所示。
- en: '[PRE5]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '![](../../OEBPS/Images/20-01.png)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/20-01.png)'
- en: Figure 20.1 Monthly average retail price of 1 kg of round steak in Canada from
    January 1995 to November 2021\. There is a clear trend in the data as it increases
    over time. However, there does not seem to be any seasonality here. This might
    be a sign that Prophet is not the best tool for this problem.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 图20.1展示了从1995年1月到2021年11月加拿大1公斤圆牛排的月度平均零售价格。数据随时间增加呈现出明显的趋势。然而，这里似乎没有季节性。这可能表明Prophet不是解决这个问题的最佳工具。
- en: Figure 20.1 shows a clear trend in our data but there is no visible seasonality
    in this time series. Thus, Prophet might not be the best tool for this type of
    problem. However, this is pure intuition, so we’ll test it against a baseline
    to see if we can successfully forecast our target.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 图20.1显示了我们的数据中的明显趋势，但在这个时间序列中没有明显的季节性。因此，Prophet可能不是解决这类问题的最佳工具。然而，这纯粹是直觉，所以我们将对其进行基准测试，看看我们是否可以成功预测我们的目标。
- en: 20.3 Modeling with Prophet
  id: totrans-42
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 20.3 使用Prophet进行建模
- en: We have preprocessed our data and visualized it. The next step is to rename
    the columns according to Prophet’s naming convention. The time column must be
    named ds and the value column must be named y.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经预处理了数据并对其进行了可视化。下一步是根据Prophet的命名约定重命名列。时间列必须命名为ds，值列必须命名为y。
- en: '[PRE6]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Next, we must format the date correctly. Right now our datestamp only has the
    year and month, but Prophet also expects a day in the format YYYY-MM-DD. Since
    we are working with monthly averages, we must add the last day of the month to
    the datestamp, since we cannot report the average retail price of January until
    the very last day of January.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们必须正确地格式化日期。目前我们的日期戳只有年份和月份，但Prophet还期望日期以YYYY-MM-DD的格式包含一天。由于我们处理的是月度平均值，我们必须将月份的最后一天添加到日期戳中，因为我们不能在1月的最后一天之前报告1月的平均零售价格。
- en: '[PRE7]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Our data is now correctly formatted, so we’ll split our dataset into train and
    test sets. Our objective is forecasting the future 36 months, so we’ll allocate
    the last 36 data points to the test set. The rest is for training.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的数据现在格式正确，因此我们将数据集分为训练集和测试集。我们的目标是预测未来的36个月，因此我们将最后36个数据点分配给测试集。其余的用于训练。
- en: '[PRE8]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: We can now address hyperparameter tuning. We’ll start by defining a list of
    possible values for `changepoint_prior_scale` and `seasonality_prior_scale`. We
    won’t include any holiday effects, as they likely will not impact the price of
    goods. Then we’ll create a list of all unique combinations. Here we’ll use the
    mean squared error (MSE) as a selection criterion, because it penalizes large
    errors, and we want the best-fitted model.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们可以处理超参数调整。我们首先定义一个可能的`changepoint_prior_scale`和`seasonality_prior_scale`值的列表。我们不会包括任何假日效应，因为它们可能不会影响商品的价格。然后我们将创建一个包含所有唯一组合的列表。在这里，我们将使用均方误差（MSE）作为选择标准，因为它惩罚大误差，我们希望得到最佳拟合模型。
- en: '[PRE9]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Now we must define a list of cutoff dates. Recall that this is a workaround
    for using Prophet with monthly data. The cutoff dates specify the initial training
    set and the length of the testing period during cross-validation.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们必须定义一个截止日期列表。回想一下，这是使用Prophet处理月度数据的一个解决方案。截止日期指定了初始训练集和交叉验证期间测试期的长度。
- en: In this case, we’ll allow for the first 5 years of data to be used as an initial
    training set. Then each testing period must have a length of 36 months, since
    this is our horizon in the objective statement. Our cutoff dates thus start in
    2001-01-31 and end at the end of the training set, which is 2018-11-30, and each
    cutoff date is separated by 36 months.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，我们将允许使用前5年的数据作为初始训练集。然后每个测试周期必须长度为36个月，因为这是我们的目标陈述中的范围。因此，我们的截止日期从2001-01-31开始，到训练集的结束，即2018-11-30，每个截止日期之间相隔36个月。
- en: '[PRE10]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: We can now test each parameter combination, fit a model, and use cross-validation
    to measure its performance. The parameter combination with the lowest MSE will
    be selected to generate predictions over our test set.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们可以测试每个参数组合，拟合一个模型，并使用交叉验证来衡量其性能。具有最低均方误差（MSE）的参数组合将被选中，以生成测试集上的预测。
- en: '[PRE11]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: This indicates that both `changepoint_prior_scale` and `seasonality_prior_scale`
    should be set to 1.0\. We’ll thus define a Prophet model using `best_params` and
    fit it on the training set.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 这表明`changepoint_prior_scale`和`seasonality_prior_scale`都应该设置为1.0。因此，我们将使用`best_params`定义一个Prophet模型，并在训练集上拟合它。
- en: '[PRE12]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Next, we’ll use `make_future_dataframe` to define the forecast horizon. In this
    case, it is 36 months.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将使用`make_future_dataframe`来定义预测范围。在这种情况下，它是36个月。
- en: '[PRE13]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: We can now generate predictions.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们可以生成预测。
- en: '[PRE14]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Let’s append them to our test set, so it’s easier to evaluate the performance
    and plot the forecast against the observed values.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们将它们添加到我们的测试集中，这样更容易评估性能并将预测值与观测值进行对比。
- en: '[PRE15]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Of course, our model must be evaluated against a benchmark. For this example,
    we’ll simply use the last known value of the training set as a prediction for
    the next 36 months. We could alternatively use the mean value method, but I would
    consider the mean in recent years only, since there is a clear trend in the data,
    which means the mean changes over time. Using the naive seasonal method here is
    not valid, since there is no clear seasonality in the data.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，我们的模型必须与基准进行比较。在这个例子中，我们将简单地使用训练集的最后一个已知值作为对未来36个月的预测。我们也可以使用平均值方法，但我会考虑最近几年的平均值，因为数据中存在明显的趋势，这意味着平均值会随时间变化。在这里使用简单的季节性方法是不合适的，因为数据中不存在明显的季节性。
- en: '[PRE16]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Everything is set for evaluation. We’ll use the MAE to select the best model.
    This metric is chosen for its ease of interpretation.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 所有的评估准备工作都已就绪。我们将使用平均绝对误差（MAE）来选择最佳模型。这个指标被选中是因为它易于解释。
- en: '[PRE17]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: From this, we obtain an MAE of 0.681 with our baseline, while Prophet achieves
    an MAE of 1.163\. Therefore, Prophet performs worse than the baseline, which simply
    uses the last known value as a forecast.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们使用基线模型获得了0.681的平均绝对误差，而Prophet达到了1.163。因此，Prophet的表现不如基线模型，后者简单地使用最后一个已知值作为预测。
- en: We can visualize the predictions in figure 20.2.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以在图20.2中可视化预测结果。
- en: '[PRE18]'
  id: totrans-70
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: '![](../../OEBPS/Images/20-02.png)'
  id: totrans-71
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/20-02.png)'
- en: Figure 20.2 Forecasting the monthly average retail price of 1 kg of round steak
    in Canada. We can see that Prophet (shown as a dashed line) tends to overshoot
    the observed values.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 图20.2 预测加拿大1公斤圆牛肉的月平均零售价格。我们可以看到，Prophet（以虚线表示）往往超过观测值。
- en: We can also visualize the components of the model in figure 20.3.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还可以在图20.3中可视化模型的组成部分。
- en: '[PRE19]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: '![](../../OEBPS/Images/20-03.png)'
  id: totrans-75
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/20-03.png)'
- en: Figure 20.3 Components of the Prophet model. The top plot shows the trend component,
    with many changepoints, as we set `changepoint_prior_scale` to a high value, allowing
    the trend to be more flexible. The bottom plot shows the yearly seasonal component.
    Again, this component likely improves the fit of the model, but I doubt there
    is tangible reason to reduce the price of goods near September, for example.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 图20.3 Prophet模型的组成部分。顶部图显示了趋势成分，有许多转折点，因为我们把`changepoint_prior_scale`设置得较高，允许趋势更加灵活。底部图显示了年度季节性成分。同样，这个成分可能有助于提高模型的拟合度，但我怀疑没有明显的理由要在9月份附近降低商品价格。
- en: Figure 20.3 shows the components of the Prophet model. The top plot shows the
    trend component, which has many changepoints. This is because we allowed the trend
    to be very flexible by setting `changepoint_prior_scale` to 1.0, as it resulted
    in the best fit during cross-validation.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 图20.3显示了Prophet模型的组成部分。顶部图显示了趋势成分，具有许多转折点。这是因为我们通过将`changepoint_prior_scale`设置为1.0，允许趋势非常灵活，从而在交叉验证期间得到了最佳拟合。
- en: The bottom plot shows the yearly seasonal component. This component is likely
    helping Prophet achieve a better fit, but I doubt there is a tangible reason for
    price of goods to decrease toward September. This highlights the curve-fitting
    procedure of Prophet. It’s also a great example of a case where domain knowledge
    could probably help us better fine-tune this parameter.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 底部图显示了年度季节性成分。这个成分可能有助于Prophet实现更好的拟合，但我怀疑没有明显的理由会导致商品价格在9月份附近下降。这突出了Prophet的曲线拟合过程。它也是一个很好的例子，说明领域知识可能有助于我们更好地微调这个参数。
- en: We have thus found a situation where Prophet is not the ideal solution. In fact,
    it performed worse than our naive forecasting method. We could have anticipated
    that, since we know that Prophet performs best on strongly seasonal data, but
    we could not be sure until we actually tested it.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们发现了一个Prophet不是理想解决方案的情况。实际上，它的表现比我们的简单预测方法还要差。我们知道Prophet在强烈季节性数据上表现最佳，但我们直到实际测试之前无法确定。
- en: The next portion of the project is optional, but I highly recommend that you
    complete it, as it shows a complete solution to a time series forecasting problem.
    We have tested Prophet and did not obtain satisfying results, but that does not
    mean we must give up. Instead, we must search for another solution and test it.
    Since we do not have a large dataset, deep learning is not a suitable tool for
    this problem. Therefore, let’s try using a SARIMA model.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 项目的下一部分是可选的，但我强烈建议您完成它，因为它展示了一个时间序列预测问题的完整解决方案。我们已经测试了 Prophet，但没有获得令人满意的结果，但这并不意味着我们必须放弃。相反，我们必须寻找另一种解决方案并对其进行测试。由于我们没有大量数据集，深度学习不是解决这个问题的一个合适工具。因此，让我们尝试使用
    SARIMA 模型。
- en: '20.4 Optional: Develop a SARIMA model'
  id: totrans-81
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 20.4 可选：开发 SARIMA 模型
- en: In the previous section, we used Prophet to forecast the monthly average retail
    price of 1 kg of round steak in Canada, but Prophet performed worse than our baseline
    model. We’ll now develop a SARIMA model to see if it can achieve better performance
    than our baseline.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一节中，我们使用了 Prophet 来预测加拿大 1 公斤圆牛排的月平均零售价格，但 Prophet 的表现不如我们的基线模型。现在我们将开发一个
    SARIMA 模型，看看它是否能比我们的基线模型有更好的性能。
- en: The first step is to import the required libraries.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 第一步是导入所需的库。
- en: '[PRE20]'
  id: totrans-84
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: Next, we’ll test for stationarity. This will determine the values of the integration
    order *d* and the seasonal integration order *D*. Recall that we are using the
    ADF test to test for stationarity.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将测试平稳性。这将确定积分阶数 *d* 和季节积分阶数 *D* 的值。回想一下，我们正在使用 ADF 测试来测试平稳性。
- en: '[PRE21]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Here we get an ADF statistic of 0.31 and a p-value of 0.98\. Since the p-value
    is greater than 0.05, we conclude that the series is not stationary. This is expected,
    since we can clearly see a trend in the data.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 这里我们得到一个 ADF 统计量为 0.31 和一个 p 值为 0.98。由于 p 值大于 0.05，我们得出结论，该序列不是平稳的。这是预期的，因为我们可以在数据中清楚地看到趋势。
- en: We’ll difference the series once and test again for stationarity.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将序列差分一次，然后再次测试平稳性。
- en: '[PRE22]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Now we have an ADF-statistic of –16.78 and a p-value much smaller than 0.05.
    We thus conclude that we have a stationary time series. Therefore, *d* = 1 and
    *D* = 0. Recall that SARIMA also requires the frequency *m* to be set. Since we
    have monthly data, the frequency is *m* = 12.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们有一个 ADF 统计量为 –16.78，p 值远小于 0.05。因此，我们得出结论，我们有一个平稳的时间序列。因此，*d* = 1 和 *D*
    = 0。回想一下，SARIMA 还需要设置频率 *m*。由于我们有月度数据，频率是 *m* = 12。
- en: Next, we’ll use the `optimize_SARIMAX` function shown in listing 20.1 to find
    the parameters (*p*,*q*,*P*,*Q*) that minimize the Akaike information criterion
    (AIC).
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将使用列表 20.1 中所示的 `optimize_SARIMAX` 函数来找到使赤池信息准则（AIC）最小化的参数 (*p*, *q*,
    *P*, *Q*)。
- en: Listing 20.1 Function to select the parameters that minimize the AIC
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 20.1 选择使 AIC 最小的参数的函数
- en: '[PRE23]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: We’ll define the range of possible values for *p*, *q*, *P*, and *Q*, generate
    a list of all unique combinations, and run the `optimize_SARIMAX` function. Note
    that we do not have exogenous variables.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将定义 *p*, *q*, *P*, 和 *Q* 的可能值范围，生成所有唯一组合的列表，并运行 `optimize_SARIMAX` 函数。请注意，我们没有外生变量。
- en: '[PRE24]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Once the search is complete, we’ll find that *p* = 2, *q* = 3, *P* = 1, and
    *Q* = 1 is the combination that results in the lowest AIC. We can now fit a model
    using this parameter combination and study its residuals in figure 20.4, which
    turn out to be completely random.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦搜索完成，我们会发现 *p* = 2, *q* = 3, *P* = 1, 和 *Q* = 1 是导致最低 AIC 的组合。现在我们可以使用这个参数组合来拟合模型，并在图
    20.4 中研究其残差，结果证明这些残差是完全随机的。
- en: '[PRE25]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: '![](../../OEBPS/Images/20-04.png)'
  id: totrans-98
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/20-04.png)'
- en: Figure 20.4 Residuals of the SARIMA(2,1,3)(1,0,1)[12] model. The top-left plot
    shows the residuals over time, which are completely random with no trend and a
    fairly constant variance, just like white noise. The top-right plot shows the
    distribution of the residuals, which is very close to a normal distribution. This
    is further supported by the Q-Q plot at the bottom left. We see a straight line
    that lies on *y* = *x*, so we can conclude that the residuals are normally distributed,
    like white noise. Finally, the correlogram at the bottom right shows no significant
    coefficients after lag 0, which is the same behavior as white noise. We can conclude
    that the residuals are completely random.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 图20.4 SARIMA(2,1,3)(1,0,1)[12]模型的残差。左上角的图显示了随时间变化的残差，它们是完全随机的，没有趋势，方差相当恒定，就像白噪声。右上角的图显示了残差的分布，非常接近正态分布。这一点在左下角的Q-Q图中得到了进一步的支持。我们看到一条直线位于*y*
    = *x*上，因此我们可以得出结论，残差是正态分布的，就像白噪声。最后，右下角的 correlogram在滞后0之后没有显示显著的系数，这与白噪声的行为相同。我们可以得出结论，残差是完全随机的。
- en: We can further support our conclusion by using the Ljung-Box test. Recall that
    the null hypothesis of the Ljung-Box test is that the data is uncorrelated and
    independent.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用Ljung-Box测试进一步支持我们的结论。回想一下，Ljung-Box测试的零假设是数据是不相关的且独立的。
- en: '[PRE26]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: The returned p-values are all greater than 0.05, so we cannot reject the null
    hypothesis and instead conclude that the residuals are indeed random and independent.
    Our SARIMA model can thus be used for forecasting.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 返回的p值都大于0.05，因此我们不能拒绝零假设，反而可以得出结论，残差确实是随机的且相互独立的。因此，我们的SARIMA模型可以用于预测。
- en: We’ll generate predictions over the horizon of our test set.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在测试集的范围内生成预测。
- en: '[PRE27]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Then we’ll evaluate the SARIMA model using the MAE.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们将使用MAE来评估SARIMA模型。
- en: '[PRE28]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: Here we obtain an MAE of 0.678, which is just slightly better than our baseline,
    which achieved an MAE of 0.681\. We can visualize the forecasts of the SARIMA
    model in figure 20.5.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 我们得到了一个MAE为0.678，这略好于我们的基线，基线实现了MAE为0.681。我们可以在图20.5中可视化SARIMA模型的预测。
- en: '[PRE29]'
  id: totrans-108
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: '![](../../OEBPS/Images/20-05.png)'
  id: totrans-109
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/20-05.png)'
- en: Figure 20.5 Forecasting the monthly average retail price of 1 kg of round steak
    in Canada. The SARIMA model, shown as a dashed and dotted line, achieves the lowest
    MAE (0.678), but it is only slightly better than our baseline (0.681), which is
    shown as a dotted line.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 图20.5 预测加拿大1公斤圆牛肉的月平均零售价格。SARIMA模型（以虚线和点线表示）实现了最低的MAE（0.678），但仅略好于我们的基线（0.681），基线以点线表示。
- en: While SARIMA performed better than Prophet, the difference in performance against
    the benchmark is negligible. This is a situation where we must ask ourselves if
    it is worth using the more complex SARIMA model for such a small difference. We
    can also investigate further to determine if there are external variables that
    could help us forecast our target, as it seems that using past values only is
    not enough to generate accurate predictions.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然SARIMA的表现优于Prophet，但与基准之间的性能差异是可以忽略不计的。这是一个我们必须问自己是否值得使用更复杂的SARIMA模型来获得如此小的差异的情况。我们还可以进一步调查，以确定是否存在可能帮助我们预测目标的外部变量，因为似乎仅使用过去值不足以生成准确的预测。
- en: 20.5 Next steps
  id: totrans-112
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 20.5 下一步
- en: Congratulations on completing this capstone project! This was special and different
    from what we have seen, as it turned out that we were addressing a fairly complex
    problem, and we could not come up with a very performant solution. This situation
    will happen as you tackle different time series forecasting problems, and it’s
    where domain knowledge, gathering more data, and using your creativity to find
    external factors that can impact your target come into play.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 恭喜你完成了这个顶点项目！这很特别，与我们之前看到的不同，因为结果证明我们解决了一个相当复杂的问题，我们无法提出一个非常有效的解决方案。当你解决不同的时间序列预测问题时，这种情况会发生，这就是领域知识、收集更多数据以及使用你的创造力来寻找可能影响你的目标的外部因素发挥作用的地方。
- en: Take this opportunity to make this capstone project yours. We studied only one
    target, but there are 52 goods to choose from. Pick another target and see if
    you can generate predictions that perform much better than a baseline model. Feel
    free to also change the forecast horizon.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 利用这个机会，让这个顶点项目成为你的。我们只研究了一个目标，但可以选择52种商品中的另一种。选择另一个目标，看看你是否能生成比基线模型表现更好的预测。你也可以自由地改变预测范围。
- en: 'If you want to go above and beyond, many government websites have open data,
    making them a gold mine for time series datasets. Here are the links to NYC Open
    Data and Statistics Canada:'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想要做得更多，许多政府网站都有开放数据，这使得它们成为时间序列数据集的宝库。以下是纽约市开放数据和加拿大统计局的链接：
- en: NYC Open Data—[https://opendata.cityofnewyork.us/data/](https://opendata.cityofnewyork.us/data/)
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 纽约市开放数据—[https://opendata.cityofnewyork.us/data/](https://opendata.cityofnewyork.us/data/)
- en: Statistics Canada—[www150.statcan.gc.ca/n1/en/type/data](http://www150.statcan.gc.ca/n1/en/type/data)
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 加拿大统计局—[www150.statcan.gc.ca/n1/en/type/data](http://www150.statcan.gc.ca/n1/en/type/data)
- en: Explore these websites and find a time series dataset you can use to practice
    your forecasting skills. You will likely encounter a challenging problem, forcing
    you to search for solutions, and ultimately making you better at time series forecasting.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 探索这些网站，并找到一个你可以用来练习预测技能的时间序列数据集。你可能会遇到一个具有挑战性的问题，迫使你寻找解决方案，最终使你在时间序列预测方面变得更加出色。
