- en: appendix E. Serverless Framework under the hood
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 附录 E. Serverless Framework 内部机制
- en: In this appendix we will look in more detail at serverless technology on AWS,
    and in particular at the Serverless Framework, which is used for many of the example
    systems in this book.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在本附录中，我们将更详细地探讨 AWS 上的无服务器技术，特别是 Serverless Framework，它是本书中许多示例系统所使用的框架。
- en: As alluded to in chapter 1, the term *serverless* doesn’t mean a system without
    servers; it means that we can construct systems without the need to concern ourselves
    with the underlying server infrastructure. By using serverless technologies, we
    are able to move up a level of abstraction and focus more on our application logic
    and less on the technical “heavy lifting.”
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 如第 1 章所述，术语 *serverless* 并非指没有服务器的系统；它的意思是我们可以构建不需要关注底层服务器基础设施的系统。通过使用无服务器技术，我们能够提升抽象层次，更多地关注应用程序逻辑，而不是技术上的“重活”。
- en: A key concept underpinning serverless is Infrastructure as Code (IaC). IaC allows
    us to treat the entire infrastructure for a system as source code. This means
    that we can store it in a revision control system such as Git, and apply software
    development best practices to its creation and maintenance.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 无服务器架构的一个关键概念是基础设施即代码（IaC）。IaC 允许我们将系统的整个基础设施视为源代码。这意味着我们可以将其存储在版本控制系统（如 Git）中，并对其创建和维护应用软件开发的最佳实践。
- en: All of the major cloud providers support some mechanism for IaC. On AWS, the
    service that supports IaC is called CloudFormation.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 所有主要的云服务提供商都支持某种基础设施即代码（IaC）机制。在 AWS 上，支持 IaC 的服务称为 CloudFormation。
- en: CloudFormation can be configured by creating a template file in either JSON
    or YAML format. Though it is possible to write templates directly using a text
    editor, this can quickly become unwieldy for systems of an appreciable size, as
    the templates are quite verbose. A number of tools are available to help developers
    work with CloudFormation, such as SAM, the AWS CDK, and the Serverless Framework.
    There are also other tools such as HashiCorp’s Terraform that target multiple
    clouds, which we won’t cover here.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: CloudFormation 可以通过创建 JSON 或 YAML 格式的模板文件进行配置。虽然可以直接使用文本编辑器编写模板，但随着系统规模的扩大，模板可能会变得难以管理，因为模板相当冗长。有许多工具可以帮助开发者与
    CloudFormation 一起工作，例如 SAM、AWS CDK 和 Serverless Framework。还有其他一些工具，如 HashiCorp
    的 Terraform，它们针对多个云服务，这里不会进行介绍。
- en: Though the Serverless Framework can be used to deploy any AWS resources, it
    is oriented toward managing and deploying serverless web applications. Typically
    this means API Gateway, Lambda functions, and database resources such as DynamoDB
    tables. The Serverless configuration file can be thought of as a lightweight domain-specific
    language (DSL) that describes these types of applications.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然Serverless Framework可以用于部署任何AWS资源，但它主要面向管理和部署无服务器Web应用程序。通常这意味着 API Gateway、Lambda
    函数以及像 DynamoDB 表这样的数据库资源。Serverless 配置文件可以被视为一种轻量级的领域特定语言（DSL），用于描述这些类型的应用程序。
- en: Figure E.1 depicts how the Serverless Framework cooperates with CloudFormation.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 图 E.1 展示了 Serverless Framework 如何与 CloudFormation 协作。
- en: '![](../Images/APPE_F01_Elger.png)'
  id: totrans-8
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/APPE_F01_Elger.png)'
- en: Figure E.1 CloudFormation workflow
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 图 E.1 CloudFormation 工作流程
- en: On deployment, the Serverless configuration file (serverless.yml) is “compiled”
    into a CloudFormation template. A deployment bucket is created, and code artifacts
    for each of the defined Lambda functions are uploaded. Hashes are computed for
    each of the Lambda functions and included in the template. Serverless then calls
    the CloudFormation `UpdateStack` method to delegate the deployment work to CloudFormation.
    CloudFormation then proceeds to query the existing infrastructure. Where differences
    are found--for example, if a new API Gateway route has been defined--CloudFormation
    will make the required infrastructure updates to align the deployment with the
    new compiled template.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 在部署时，Serverless 配置文件（serverless.yml）被“编译”成 CloudFormation 模板。创建一个部署存储桶，并将定义的每个
    Lambda 函数的代码工件上传。为每个 Lambda 函数计算哈希值并将其包含在模板中。然后 Serverless 调用 CloudFormation 的
    `UpdateStack` 方法，将部署工作委托给 CloudFormation。CloudFormation 然后继续查询现有基础设施。如果发现差异（例如，如果定义了新的
    API Gateway 路由），CloudFormation 将进行必要的基础设施更新，以使部署与新的编译模板保持一致。
- en: E.1 Walkthrough
  id: totrans-11
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: E.1 演示
- en: Let’s take a simple Serverless configuration file and walk through the deployment
    process in detail. First create a new empty directory called `hello`. `cd` into
    this directory and create a file `serverless.yml`. Add the code shown in the next
    listing to this file.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们通过一个简单的 Serverless 配置文件详细说明部署过程。首先创建一个名为 `hello` 的新空目录。`cd` 到这个目录并创建一个文件
    `serverless.yml`。将下一列表中显示的代码添加到该文件中。
- en: Listing E.1 Simple `serverless.yml`
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 E.1 简单的 `serverless.yml`
- en: '[PRE0]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Next create a file `handler.js` in the same directory and add the code in the
    following listing to it.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，在同一个目录中创建一个名为 `handler.js` 的文件，并将下一列表中的代码添加到其中。
- en: Listing E.2 Simple handler function
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 E.2 简单的处理程序函数
- en: '[PRE1]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Let’s now deploy this handler into AWS. You will need to set up an AWS account
    and also configure your command line before deployment. If you haven’t already
    done this, please refer to appendix A, which walks through the setup process.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们将此处理程序部署到 AWS。在部署之前，你需要设置一个 AWS 账户并配置你的命令行。如果你还没有这样做，请参阅附录 A，其中介绍了设置过程。
- en: To deploy this simple application, run
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 要部署此简单应用程序，请运行
- en: '[PRE2]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Let’s take a look at the artifacts that were created during the deployment process.
    When deploying this application, the framework created a local working directory
    named `.serverless` in the application directory. If you look in this directory,
    you should see the files listed in the next listing.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看在部署过程中创建的组件。在部署此应用程序时，框架在应用程序目录中创建了一个名为 `.serverless` 的本地工作目录。如果你查看这个目录，你应该会看到下一列表中列出的文件。
- en: Listing E.3 Serverless working directory
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 E.3 Serverless 工作目录
- en: '[PRE3]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'These files serve the following purposes:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 这些文件具有以下用途：
- en: '`cloudformation-template-create-stack.json` is used to create an S3 deployment
    bucket for code artifacts, if one doesn’t exist already.'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果尚未存在，`cloudformation-template-create-stack.json` 用于创建用于代码组件的 S3 部署存储桶。
- en: '`cloudformation-template-update-stack.json` contains the compiled CloudFormation
    template to deploy.'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`cloudformation-template-update-stack.json` 包含用于部署的编译后的 CloudFormation 模板。'
- en: '`hello-service.zip` holds the code bundle for our Lambda function.'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`hello-service.zip` 包含我们 Lambda 函数的代码包。'
- en: '`serverless-state.json` holds a local copy of the current deployed state.'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`serverless-state.json` 存储当前已部署状态的本地副本。'
- en: Log in to the AWS web console to see exactly what was deployed by the framework.
    First go to `S3` and search for a bucket containing the string `'hello'`; you
    should find a bucket named something like `hello-service-dev-serverlessdeploymentbucket-zpeochtywl7m`.
    This is the deployment bucket that the framework used to push code to AWS. If
    you look inside this bucket, you will see a structure similar to the following
    listing.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 登录 AWS 网络控制台以查看框架实际部署了什么。首先转到 `S3` 并搜索包含字符串 `'hello'` 的存储桶；你应该会找到一个名为类似 `hello-service-dev-serverlessdeploymentbucket-zpeochtywl7m`
    的存储桶。这是框架用于将代码推送到 AWS 的部署存储桶。如果你查看这个存储桶，你会看到类似于以下列表的结构。
- en: Listing E.4 Serverless deployment bucket
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 E.4 Serverless 部署存储桶
- en: '[PRE4]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '`<timestamp>` is replaced with the time when you ran the deployment. As updates
    are made to the service, the framework will push the updated templates and code
    to this bucket for deployment.'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: '`<timestamp>` 被替换为你运行部署的时间。随着对服务的更新，框架会将更新的模板和代码推送到此存储桶以进行部署。'
- en: Next, use the AWS console to navigate to the API Gateway and Lambda web consoles.
    Click on the Services link in the top right, and search for `lambda` and then
    `api gateway`, as illustrated in figure E.2.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，使用 AWS 控制台导航到 API Gateway 和 Lambda 网络控制台。点击右上角的“服务”链接，然后搜索“lambda”和“api
    gateway”，如图 E.2 所示。
- en: '![](../Images/APPE_F02_Elger.png)'
  id: totrans-34
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../Images/APPE_F02_Elger.png)'
- en: Figure E.2 Searching for services in the AWS web console.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 图 E.2 在 AWS 网络控制台中搜索服务。
- en: On the Lambda and Api Gateway consoles, you will see the deployed instances
    of the service, as shown in figures E.3 and E.4.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Lambda 和 Api Gateway 控制台中，你会看到服务的已部署实例，如图 E.3 和 E.4 所示。
- en: '![](../Images/APPE_F03_Elger.png)'
  id: totrans-37
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../Images/APPE_F03_Elger.png)'
- en: Figure E.3 Deployed Lambda function
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 图 E.3 已部署的 Lambda 函数
- en: '![](../Images/APPE_F04_Elger.png)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../Images/APPE_F04_Elger.png)'
- en: Figure E.4 Deployed API Gateway
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 图 E.4 已部署的 API Gateway
- en: Finally if you open the CloudFormation web console, you will see the deployed
    template for the service. This should look similar to figure E.5.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，如果你打开 CloudFormation 网络控制台，你会看到服务的已部署模板。这应该看起来与图 E.5 类似。
- en: Understanding the deployment process for the framework can help to diagnose
    issues when things go wrong. The key thing to bear in mind is that `serverless
    deploy` delegates deployment to CloudFormation `UpdateStack`, and that we can
    use the AWS Console to look at the stack update history and current state if issues
    occur.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 理解框架的部署流程有助于在出现问题时进行问题诊断。关键是要记住，`serverless deploy` 将部署委托给 CloudFormation 的
    `UpdateStack`，并且如果出现问题，我们可以使用 AWS 控制台查看堆栈更新历史和当前状态。
- en: '![](../Images/APPE_F05_Elger.png)'
  id: totrans-43
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/APPE_F05_Elger.png)'
- en: Figure E.5 Deployed CloudFormation stack
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 图 E.5 已部署的 CloudFormation 堆栈
- en: E.2 Cleanup
  id: totrans-45
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: E.2 清理
- en: Once you have finished with the example stack, be sure to remove it by running
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦完成示例堆栈，请确保通过运行
- en: '[PRE5]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Make sure that the framework has removed all of the related artifacts described
    here.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 确保框架已移除此处描述的所有相关工件。
