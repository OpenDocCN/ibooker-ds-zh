- en: 12 Introducing deep learning for time series forecasting
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 12 介绍时间序列预测的深度学习
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章节涵盖
- en: Using deep learning for forecasting
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用深度学习进行预测
- en: Exploring different types of deep learning models
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 探索不同的深度学习模型类型
- en: Getting ready to apply deep learning to time series forecasting
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 准备将深度学习应用于时间序列预测
- en: In the last chapter, we concluded the part of the book on time series forecasting
    using statistical models. Those models work particularly well when you have small
    datasets (usually less than 10,000 data points), and when the seasonal period
    is monthly, quarterly, or yearly. In situations where you have daily seasonality
    or where the dataset is very large (more than 10,000 data points), those statistical
    models become very slow, and their performance degrades.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，我们使用统计模型完成了关于时间序列预测的书籍部分。这些模型在您拥有小型数据集（通常少于10,000个数据点）时表现尤其出色，当季节周期为月度、季度或年度时也是如此。在您拥有每日季节性或数据集非常大的情况下（超过10,000个数据点），这些统计模型变得非常慢，其性能下降。
- en: Thus, we turn to deep learning. *Deep learning* is a subset of machine learning
    that focuses on building models on the neural network architecture. Deep learning
    has the advantage that it tends to perform better as more data is available, making
    it a great choice for forecasting high-dimensional time series.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们转向深度学习。*深度学习*是机器学习的一个子集，它专注于在神经网络架构上构建模型。深度学习的优势在于，随着数据的增加，其性能往往更好，这使得它成为预测高维时间序列的绝佳选择。
- en: In this part of the book, we’ll explore various model architectures so you’ll
    have a set of tools for tackling virtually any time series forecasting problem.
    Note that I’ll assume you have some familiarity with deep learning, so topics
    such as activation functions, loss functions, batches, layers, and epochs should
    be known. This part of the book will not serve as an introduction to deep learning,
    but rather focuses on applying deep learning to time series forecasting. Of course,
    each model architecture will be thoroughly explained, and you will gain an intuition
    as to why a particular architecture might work better than another in particular
    situations. Throughout these chapters, we will use TensorFlow, or more specifically
    Keras, to build different deep learning models.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书的这一部分，我们将探讨各种模型架构，以便您拥有一套工具来应对几乎任何时间序列预测问题。请注意，我将假设您对深度学习有一定了解，因此激活函数、损失函数、批次、层和周期等主题应该是已知的。本书的这一部分不会作为深度学习的介绍，而是专注于将深度学习应用于时间序列预测。当然，每种模型架构都将得到详细解释，您将获得关于为什么在特定情况下某种架构可能比另一种架构表现更好的直觉。在这些章节中，我们将使用TensorFlow，或更具体地说Keras，来构建不同的深度学习模型。
- en: In this chapter specifically, we identify the conditions that justify the use
    of deep learning and explore the different types of models that can be built,
    such as single-step, multi-step, and multi-output models. We’ll conclude the chapter
    with the initial setup that will get us ready to apply deep learning models in
    the following chapters. Finally, we’ll explore the data, perform feature engineering,
    and split the data into training, validation, and testing sets.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们确定了使用深度学习的条件，并探讨了可以构建的不同类型的模型，例如单步、多步和多输出模型。我们将以以下章节中应用深度学习模型所需的初始设置来结束本章。最后，我们将探索数据，执行特征工程，并将数据分为训练集、验证集和测试集。
- en: 12.1 When to use deep learning for time series forecasting
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.1 何时使用深度学习进行时间序列预测
- en: Deep learning shines when we have large complex datasets. In those situations,
    deep learning can leverage all the available data to infer relationships between
    each feature and the target, usually resulting in good forecasts.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们拥有大型复杂数据集时，深度学习表现出色。在这些情况下，深度学习可以利用所有可用数据来推断每个特征与目标之间的关系，通常导致良好的预测。
- en: In the context of time series, a dataset is considered to be large when we have
    more than 10,000 data points. Of course, this is an approximation rather than
    a hard-set limit, so if you have 8,000 data points, deep learning could be a viable
    option. When the size of the dataset is large, any declination of the SARIMAX
    model will take a long time to fit, which is not ideal for model selection, as
    we usually fit many models during that step.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 在时间序列的背景下，当数据点超过10,000个时，数据集被认为是大的。当然，这是一个近似值而不是一个硬性限制，所以如果您有8,000个数据点，深度学习可能是一个可行的选择。当数据集很大时，任何SARIMAX模型的下降都会花费很长时间来拟合，这对模型选择来说并不理想，因为我们通常会在这一步骤中拟合许多模型。
- en: If your data has multiple seasonal periods, the SARIMAX model cannot be used.
    For example, suppose you must forecast the hourly temperature. It is reasonable
    to assume that there will be daily seasonality, as temperature tends to be lower
    at night and higher during the day, but there is also yearly seasonality, due
    to temperatures being lower in winter and higher during summer. In such a case,
    deep learning can be used to leverage the information from both seasonal periods
    to make forecasts. In fact, from experience, fitting a SARIMA model in such a
    case will usually result in residuals that are not normally distributed and still
    correlated, meaning that the model cannot be used at all.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的数据有多个季节周期，则不能使用SARIMAX模型。例如，假设你必须预测每小时的温度。可以合理地假设会有日季节性，因为温度在夜间较低，白天较高，但也有年季节性，因为冬季温度较低，夏季较高。在这种情况下，深度学习可以用来利用这两个季节周期的信息进行预测。实际上，在这种情况下拟合SARIMA模型通常会导致残差不服从正态分布且仍然相关，这意味着模型根本无法使用。
- en: Ultimately, deep learning is used either when statistical models take too much
    time to fit or when they result in correlated residuals that do not approximate
    white noise. This can be due to the fact that there is another seasonal period
    that cannot be considered in the model, or simply because there is a nonlinear
    relationship between the features and the target. In those cases, deep learning
    models can be used to capture this nonlinear relationship, and they have the added
    advantage of being very fast to train.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 最终，深度学习被用于统计模型拟合时间过长或它们导致的相关残差不近似为白噪声的情况。这可能是因为模型中无法考虑另一个季节周期，或者简单地因为特征与目标之间存在非线性关系。在这些情况下，深度学习模型可以用来捕捉这种非线性关系，并且它们还有一个额外的优势，那就是训练速度非常快。
- en: 12.2 Exploring the different types of deep learning models
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.2 探索不同的深度学习模型类型
- en: 'There are three main types of deep learning models that we can build for time
    series forecasting: single-step models, multi-step models, and multi-output models.'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以构建三种主要的深度学习模型用于时间序列预测：单步模型、多步模型和多输出模型。
- en: The single-step model is the simplest of the three. Its output is a single value
    representing the forecast of one variable one step into the future. The model
    therefore simply returns a scalar, as shown in figure 12.1.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 单步模型是三种中最简单的。它的输出是一个值，代表一个变量未来一步的预测。因此，模型简单地返回一个标量，如图12.1所示。
- en: '![](../../OEBPS/Images/12-01.png)'
  id: totrans-17
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/12-01.png)'
- en: Figure 12.1 The single-step model outputs the value of one target one timestep
    into the future. The output is therefore a scalar.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.1 单步模型输出一个目标值在未来的一个时间步长。因此，输出是一个标量。
- en: Single-step model
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 单步模型
- en: The single-step model outputs a single value representing the prediction for
    the next timestep. The input can be of any length, but the output remains a single
    prediction for the next timestep.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 单步模型输出一个值，代表下一个时间步长的预测值。输入可以是任何长度，但输出始终是下一个时间步长的单个预测值。
- en: Next we can have a multi-step model, meaning that we output the value for one
    target, but for many timesteps into the future. For example, given hourly data,
    we may want to forecast the next 24 hours. In that case, we have a multi-step
    model, since we are forecasting 24 timesteps into the future. The output is a
    24 × 1 matrix, as shown in figure 12.2.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来我们可以有一个多步模型，这意味着我们输出一个目标值，但针对未来的多个时间步长。例如，给定每小时的数据，我们可能想要预测接下来的24小时。在这种情况下，我们有一个多步模型，因为我们正在预测未来的24个时间步长。输出是一个24
    × 1的矩阵，如图12.2所示。
- en: '![](../../OEBPS/Images/12-02.png)'
  id: totrans-22
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/12-02.png)'
- en: Figure 12.2 A multi-step model outputs the predictions for 1 variable multiple
    timesteps into the future. This example predicts 24 timesteps, resulting in a
    24 x 1 output matrix.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.2 多步模型输出一个变量在多个未来时间步长的预测值。本例预测了24个时间步长，结果是一个24 x 1的输出矩阵。
- en: Multi-step model
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 多步模型
- en: In a multi-step model, the output of the model is a sequence of values representing
    predictions for many timesteps into the future. For example, if the model predicts
    the next 6 hours, 24 hours, or 12 months, it is a multi-step model.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 在一个多步模型中，模型的输出是一个表示未来多个时间步长预测值的序列。例如，如果模型预测接下来的6小时、24小时或12个月，它就是一个多步模型。
- en: Finally, the multi-output model generates predictions for more than one target.
    For example, if we were to predict both the temperature and humidity, we would
    use a multi-output model. This model can output as many timesteps as desired.
    In figure 12.3, a multi-output model returning predictions for two features for
    the next 24 timesteps is shown. In that particular case, the output is a 24 x
    2 matrix.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，多输出模型为多个目标生成预测。例如，如果我们预测温度和湿度，我们将使用多输出模型。此模型可以输出所需的时间步长数。在图 12.3 中，一个多输出模型返回了接下来
    24 个时间步长的两个特征的预测。在这种情况下，输出是一个 24 x 2 的矩阵。
- en: '![](../../OEBPS/Images/12-03.png)'
  id: totrans-27
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/12-03.png)'
- en: Figure 12.3 A multi-output model makes predictions for more than one target
    for one or more timesteps in the future. Here the model outputs predictions for
    two targets for the next 24 timesteps.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.3 一个多输出模型为未来一个或多个时间步长内的多个目标进行预测。在此，模型为接下来的 24 个时间步长内的两个目标输出预测。
- en: Multi-output model
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 多输出模型
- en: A multi-output model generates predictions for more than one target. For example,
    if we forecast the temperature and wind speed, it is a multi-output model.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 多输出模型为多个目标生成预测。例如，如果我们预测温度和风速，它就是一个多输出模型。
- en: Each of these models can have different architectures. For example, a convolutional
    neural network can be used as a single-step model, a multi-step model, or a multi-output
    model. In the following chapters, we will implement different model architectures
    and apply them for all three model types.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 这些模型可以有不同的架构。例如，卷积神经网络可以用作单步模型、多步模型或多输出模型。在接下来的章节中，我们将实现不同的模型架构，并将它们应用于所有三种模型类型。
- en: This brings us to the stage where we’ll do the initial setup for the different
    deep learning models we’ll implement in the next five chapters.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 这将我们带到这样一个阶段，我们将为接下来五章节中将要实现的不同的深度学习模型进行初始设置。
- en: 12.3 Getting ready to apply deep learning for forecasting
  id: totrans-33
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.3 准备应用深度学习进行预测
- en: From here through chapter 17, we will use the metro interstate traffic volume
    dataset available on the UCI machine learning repository. The original dataset
    recorded the hourly westbound traffic on I-94 between Minneapolis and St. Paul
    in Minnesota, from 2012 to 2018\. For the purpose of learning how to apply deep
    learning for time series forecasting, the dataset has been shortened and cleaned
    to get rid of missing values. While the cleaning steps are not covered in this
    chapter, you can still consult the preprocessing code in the GitHub repository
    for this chapter. Our main forecasting goal is to predict the hourly traffic volume.
    In the case of multi-output models, we will also forecast the hourly temperature.
    In this initial setup for the next several chapters, we’ll load the data, perform
    feature engineering, and split it into training, validation, and testing sets.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 从这里到第 17 章，我们将使用 UCI 机器学习仓库中可用的地铁州际交通量数据集。原始数据集记录了 2012 年至 2018 年间明尼苏达州明尼阿波利斯和圣保罗之间
    I-94 西行方向的每小时交通流量。为了学习如何应用深度学习进行时间序列预测，该数据集已被缩短并清理，以去除缺失值。虽然清理步骤在本章中未涉及，但您仍然可以参考
    GitHub 仓库中本章的预处理代码。我们的主要预测目标是预测每小时交通量。在多输出模型的情况下，我们还将预测每小时温度。在接下来的几个章节的初始设置中，我们将加载数据，执行特征工程，并将其分为训练集、验证集和测试集。
- en: We will use TensorFlow, or more specifically Keras, in this part of the book.
    At the time of writing, the latest stable version of TensorFlow was 2.6.0, which
    is what I’ll use in this and the following chapters.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书的这一部分，我们将使用 TensorFlow，或者更具体地说，使用 Keras。在撰写本文时，TensorFlow 的最新稳定版本是 2.6.0，这就是我在本章和以下章节中将使用的版本。
- en: 'Note The full source code for this chapter is available on GitHub: [https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH12](https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH12).'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：本章的完整源代码可在 GitHub 上找到：[https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH12](https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH12)。
- en: 12.3.1 Performing data exploration
  id: totrans-37
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.3.1 执行数据探索
- en: We will first load the data using `pandas`.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将首先使用 `pandas` 加载数据。
- en: '[PRE0]'
  id: totrans-39
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: As mentioned, this dataset is a shortened and cleaned version of the original
    dataset available on the UCI machine learning repository. In this case, the dataset
    starts on September 29, 2016, at 5 p.m. and ends on September 30, 2018, at 11
    p.m. Using `df.shape`, we can see that we have a total of six features and 17,551
    rows.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，此数据集是UCI机器学习仓库中原始数据集的简化和清洗版本。在这种情况下，数据集从2016年9月29日下午5点开始，到2018年9月30日晚上11点结束。使用`df.shape`，我们可以看到我们总共有六个特征和17,551行。
- en: The features include the date and time, the temperature, the amount of rain
    and snow, the cloud coverage, as well as the traffic volume. Table 12.1 describes
    each column in more detail.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 特征包括日期和时间、温度、雨雪量、云量和交通流量。表12.1更详细地描述了每一列。
- en: Table 12.1 The variables in the metro interstate traffic volume dataset
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 表12.1 机场间交通流量数据集中的变量
- en: '| Feature | Description |'
  id: totrans-43
  prefs: []
  type: TYPE_TB
  zh: '| 特征 | 描述 |'
- en: '| `date_time` | Date and time of the data, recorded in the CST time zone. The
    format is YYYY-MM-DD HH:MM:SS. |'
  id: totrans-44
  prefs: []
  type: TYPE_TB
  zh: '| `date_time` | 数据的日期和时间，记录在CST时区。格式为YYYY-MM-DD HH:MM:SS。|'
- en: '| `temp` | Average temperature recorded in the hour, expressed in Kelvin. |'
  id: totrans-45
  prefs: []
  type: TYPE_TB
  zh: '| `temp` | 每小时记录的平均温度，以开尔文为单位。|'
- en: '| `rain_1h` | Amount of rain that occurred in the hour, expressed in millimeters.
    |'
  id: totrans-46
  prefs: []
  type: TYPE_TB
  zh: '| `rain_1h` | 每小时发生的雨量，以毫米为单位。|'
- en: '| `snow_1h` | Amount of snow that occurred in the hour, expressed in millimeters.
    |'
  id: totrans-47
  prefs: []
  type: TYPE_TB
  zh: '| `snow_1h` | 每小时发生的雪量，以毫米为单位。|'
- en: '| `clouds_all` | Percentage of cloud cover during the hour. |'
  id: totrans-48
  prefs: []
  type: TYPE_TB
  zh: '| `clouds_all` | 每小时云量的百分比。|'
- en: '| `traffic_volume` | Volume of traffic reported westbound on I-94 during the
    hour. |'
  id: totrans-49
  prefs: []
  type: TYPE_TB
  zh: '| `traffic_volume` | 每小时在I-94西行报告的交通流量。|'
- en: Now, let’s visualize the evolution of the traffic volume over time. Since our
    dataset is very large, with more than 17,000 records, we’ll plot only the first
    400 data points, which is roughly equivalent to two weeks of data. The result
    is shown in figure 12.4.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们可视化交通流量随时间的变化。由于我们的数据集非常大，有超过17,000条记录，我们将只绘制前400个数据点，这大约相当于两周的数据。结果如图12.4所示。
- en: '[PRE1]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: In figure 12.4 you’ll notice clear daily seasonality, since the traffic volume
    is lower at the start and end of each day. You’ll also see a smaller traffic volume
    during the weekends. As for the trend, two weeks of data is likely insufficient
    to draw a reasonable conclusion, but it seems that the volume is neither increasing
    nor decreasing over time in the figure.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 在图12.4中，您会注意到明显的每日季节性，因为每天的早晚交通量较低。您还会看到周末的交通量较小。至于趋势，两周的数据可能不足以得出合理的结论，但从图中看，流量似乎没有随时间增加或减少。
- en: '![](../../OEBPS/Images/12-04.png)'
  id: totrans-53
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/12-04.png)'
- en: Figure 12.4 Westbound traffic volume on I-94 between Minneapolis and St. Paul
    in Minnesota, starting on September 29, 2016, at 5 p.m. You’ll notice clear daily
    seasonality, with traffic being lower at the start and end of each day.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.4 2016年9月29日下午5点开始，在明尼苏达州明尼阿波利斯和圣保罗之间I-94西行交通流量。您会注意到明显的每日季节性，每天的早晚交通量较低。
- en: We can also plot the hourly temperature, as it will be a target for our multi-output
    models. Here, we’ll expect to see both yearly and daily seasonality. The yearly
    seasonality should be due to the seasons in the year, while the daily seasonality
    will be due to the fact that temperatures tend to be lower at night and higher
    during the day.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还可以绘制每小时温度，因为这将是我们多输出模型的目标。在这里，我们预计会看到年度和每日季节性。年度季节性应归因于一年中的季节，而每日季节性将归因于温度在夜间较低，在白天较高的现象。
- en: Let’s first visualize the hourly temperature over the entire dataset to see
    if we can identify any yearly seasonality. The result is shown in figure 12.5.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们先可视化整个数据集中的每小时温度，看看我们是否可以识别出任何年度季节性。结果如图12.5所示。
- en: '[PRE2]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '![](../../OEBPS/Images/12-05.png)'
  id: totrans-58
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/12-05.png)'
- en: Figure 12.5 Hourly temperature (in Kelvin) from September 29, 2016, to September
    30, 2018\. Although there is noise, we can see a yearly seasonal pattern.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.5 2016年9月29日至2018年9月30日的每小时温度（开尔文）。尽管存在噪声，但我们可以看到年度季节性模式。
- en: In figure 12.5 you’ll see a yearly seasonal pattern in the hourly temperature,
    since temperatures are lower at the end and beginning of the year (winter in Minnesota),
    and higher in the middle of the year (summer). Thus, as expected, the temperature
    has yearly seasonality.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 在图12.5中，您会在每小时温度中看到年度季节性模式，因为温度在年初和年末（明尼苏达州的冬季）较低，而在年中（夏季）较高。因此，正如预期的那样，温度具有年度季节性。
- en: Now let’s verify whether we can observe daily seasonality in temperature. The
    result is shown in figure 12.6.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们来验证我们是否可以在温度中观察到每日的季节性。结果如图12.6所示。
- en: '[PRE3]'
  id: totrans-62
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '![](../../OEBPS/Images/12-06.png)'
  id: totrans-63
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/12-06.png)'
- en: Figure 12.6 Hourly temperature (in Kelvin) starting on September 29, 2016, at
    5 p.m. CST. Although it is a bit noisy, we can see that temperatures are indeed
    lower at the start and end of each day and peak during midday, suggesting daily
    seasonality.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.6 显示了从2016年9月29日下午5点开始的小时温度（开尔文）。尽管有点嘈杂，但我们确实可以看到温度在每天的开始和结束时较低，并在中午达到峰值，这表明存在每日的季节性。
- en: In figure 12.6 you’ll notice that the temperature is indeed lower at the start
    and end of each day and peaks toward the middle of each day. This suggests daily
    seasonality, just as we observed for traffic volume in figure 12.4.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 在图12.6中，你会注意到温度确实在每天的开始和结束时较低，并在每天的中午达到峰值。这表明存在每日的季节性，正如我们在图12.4中观察到的交通量一样。
- en: 12.3.2 Feature engineering and data splitting
  id: totrans-66
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 12.3.2 特征工程和数据拆分
- en: With our data exploration done, we’ll move on to feature engineering and data
    splitting. In this section, we will study each feature and create new ones that
    will help our models forecast the traffic volume and hourly temperature. Finally,
    we’ll split the data and save each set as a CSV file for later use.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 在完成数据探索后，我们将继续进行特征工程和数据拆分。在本节中，我们将研究每个特征，并创建新的特征，这些特征将帮助我们的模型预测交通量和每小时温度。最后，我们将拆分数据，并将每个集合保存为CSV文件以供以后使用。
- en: A great way to study the features of a dataset is to use the `describe` method
    from `pandas`. This method returns the number of records for each feature, allowing
    us to quickly identify missing values, the mean, standard deviation, quartiles,
    and maximum and minimum values for each feature.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 研究数据集特征的一个好方法是使用`pandas`中的`describe`方法。此方法返回每个特征的记录数，使我们能够快速识别每个特征的缺失值、平均值、标准差、四分位数以及最大和最小值。
- en: '[PRE4]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: ❶ The transpose method puts each feature on its own row.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 转置方法将每个特征放在它自己的行上。
- en: From the output, you’ll notice that `rain_1h` is mostly 0 throughout the dataset,
    as its third quartile is still at 0\. Since at least 75% of the values for `rain_1h`
    are 0, it is unlikely that it is a strong predictor of traffic volume. Thus, this
    feature will be removed.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 从输出中，你会注意到`rain_1h`在整个数据集中大部分为0，因为它的第三四分位数仍然在0。由于至少75%的`rain_1h`的值是0，它不太可能是一个强大的交通量预测因子。因此，这个特征将被删除。
- en: Looking at `snow_1h`, you’ll notice that this variable is at 0 through the entire
    dataset. This is easily observable, since its minimum and maximum values are both
    0\. Thus, this is not predictive of the variation in traffic volume over time.
    This feature will also be removed from the dataset.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 观察到`snow_1h`，你会注意到这个变量在整个数据集中都是0。这是很容易观察到的，因为它的最小值和最大值都是0。因此，这不是预测交通量随时间变化的变量。这个特征也将从数据集中删除。
- en: '[PRE5]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Now we reach the interesting problem of encoding time as a usable feature for
    our deep learning models. Right now, the `date_time` feature is not usable by
    our models, since it is a `datetime` string. We will thus convert it into a numerical
    value.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们遇到了一个有趣的问题，那就是如何将时间编码为可用于我们深度学习模型的可用特征。目前，`date_time`特征无法被我们的模型使用，因为它是一个`datetime`字符串。因此，我们将将其转换为数值。
- en: A simple way to do that is to express the date as a number of seconds. This
    is achieved through the use of the `timestamp` method from the `datetime` library.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 做这件事的一个简单方法是将日期表示为秒数。这是通过使用`datetime`库中的`timestamp`方法实现的。
- en: '[PRE6]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Unfortunately, we are not done, as this simply expresses each date in seconds,
    as shown in figure 12.7\. This leads us to losing the cyclical nature of time,
    because the number of seconds simply increases linearly with time.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 不幸的是，我们还没有完成，因为这仅仅是将每个日期表示为秒，如图12.7所示。这导致我们失去了时间的周期性，因为秒数只是随时间线性增加。
- en: '![](../../OEBPS/Images/12-07.png)'
  id: totrans-78
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/12-07.png)'
- en: Figure 12.7 Number of seconds expressing each date in the dataset. The number
    of seconds linearly increases with time, meaning that we lose the cyclical property
    of time.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.7 显示了数据集中每个日期表示的秒数。秒数随时间线性增加，这意味着我们失去了时间的周期性。
- en: Therefore, we must apply a transformation to recover the cyclical behavior of
    time. A simple way to do that is to apply a sine transformation. We know that
    the sine function is cyclical, bounded between –1 and 1\. This will help us regain
    part of the cyclical property of time.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们必须应用一个变换来恢复时间的循环行为。一个简单的方法是应用正弦变换。我们知道正弦函数是循环的，介于-1和1之间。这将帮助我们恢复时间的部分循环属性。
- en: '[PRE7]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: ❶ The timestamp is in seconds, so we must calculate the number of seconds in
    a day before applying the sine transformation.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 时间戳是以秒为单位的，所以在应用正弦变换之前，我们必须计算一天中的秒数。
- en: ❷ Application of the sine transformation. Notice that we use radians in the
    sine function.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 应用正弦变换。注意我们在正弦函数中使用弧度。
- en: With a single sine transformation, we regain some of the cyclical property that
    was lost when converting to seconds. However, at this point, 12 p.m. is equivalent
    to 12 a.m., and 5 p.m. is equivalent to 5 a.m. This is undesired, as we want to
    distinguish between morning and afternoon. Thus, we’ll apply a cosine transformation.
    We know that cosine is out of phase with the sine function. This allows us to
    distinguish between 5 a.m. and 5 p.m., expressing the cyclical nature of time
    in a day. At this point, we can remove the `date_time` column from the `DataFrame`.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 通过单次正弦变换，我们恢复了一些在转换为秒时丢失的循环属性。然而，此时，中午12点等同于凌晨12点，下午5点等同于凌晨5点。这是我们不希望的，因为我们想区分上午和下午。因此，我们将应用余弦变换。我们知道余弦函数与正弦函数不同步。这允许我们区分上午5点和下午5点，表达一天时间的循环性质。在这个时候，我们可以从`DataFrame`中删除`date_time`列。
- en: '[PRE8]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: ❶ Apply the cosine transformation to the timestamp in seconds.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将余下的时间戳应用余弦变换。
- en: ❷ Remove the date_time column.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 删除`date_time`列。
- en: We can quickly convince ourselves that these transformations worked by plotting
    a sample of `day_sin` and `day_cos`. The result is shown in figure 12.8.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过绘制`day_sin`和`day_cos`的样本来快速说服自己这些变换是有效的。结果如图12.8所示。
- en: '[PRE9]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '![](../../OEBPS/Images/12-08.png)'
  id: totrans-90
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/12-08.png)'
- en: Figure 12.8 Plot of a sample of the `day_sin` and `day_cos` encoding. We have
    successfully encoded the time as a numerical value while keeping the daily cycle.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.8展示了`day_sin`和`day_cos`编码的样本。我们已经成功地将时间编码为数值，同时保留了每日循环。
- en: In figure 12.8 you’ll notice that the points form a circle, just like a clock.
    Therefore, we have successfully expressed each timestamp as a point on the clock,
    meaning that we now have numerical values that retain the cyclical nature of time
    in a day, and this can be used in our deep learning models. This will be useful
    since we observed daily seasonality for both the temperature and the volume of
    traffic.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在图12.8中，你会注意到点形成了一个圆圈，就像一个时钟。因此，我们已经成功地将每个时间戳表达为时钟上的一个点，这意味着我们现在有了保留一天时间循环性质的数值，这可以在我们的深度学习模型中使用。这将会很有用，因为我们观察到温度和交通量的日季节性。
- en: With the feature engineering complete, we can now split our data train, validation,
    and test sets. The train set is the sample of data used to fit the model. The
    validation set is a bit like a test set that the model can peek at to tune its
    hyperparameters and improve its performance during the model’s training. The test
    set is completely separate from the model’s training procedure and is used for
    an unbiased evaluation of the model’s performance.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 在特征工程完成后，我们现在可以划分我们的数据为训练集、验证集和测试集。训练集是用于拟合模型的样本数据。验证集有点像测试集，模型可以查看它来调整超参数并在模型训练期间提高其性能。测试集完全独立于模型的训练过程，用于对模型性能进行无偏评估。
- en: Here we’ll use a simple 70:20:10 split for the train, validation, and test sets.
    While 10% of the data seems like a small portion for the test set, remember that
    we have more than 17,000 records, meaning that we will evaluate the model on more
    than 1,000 data points, which is more than enough.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们将使用简单的70:20:10分割来划分训练集、验证集和测试集。虽然10%的数据对于测试集来说似乎是一个小部分，但请记住，我们有超过17,000条记录，这意味着我们将评估超过1,000个数据点，这已经足够多了。
- en: '[PRE10]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: ❶ First 70% goes to the train set.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 前70%分配给训练集。
- en: ❷ Next 20% goes to the validation set.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 接下来的20%分配给验证集。
- en: ❸ The remaining 10% goes to the test set.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 剩余的10%分配给测试集。
- en: Before saving the data, we must scale it so all values are between 0 and 1\.
    This decreases the time required for training deep learning models, and it improves
    their performance. We’ll use `MinMaxScaler` from `sklearn` to scale our data.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 在保存数据之前，我们必须将其缩放到所有值都在0到1之间。这减少了训练深度学习模型所需的时间，并提高了它们的性能。我们将使用`MinMaxScaler`从`sklearn`中缩放我们的数据。
- en: Note that we will fit the `scaler` on the training set to avoid data leakage.
    That way, we are simulating the fact that we only have the training data available
    when we’re using the model, and no future information is known by the model. The
    evaluation of the model remains unbiased.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，我们将对训练集上的`scaler`进行拟合，以避免数据泄露。这样，我们正在模拟当我们使用模型时，我们只有训练数据可用，模型不知道任何未来的信息。模型的评估保持无偏。
- en: '[PRE11]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: ❶ Fit only on the training set.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 仅在训练集上拟合。
- en: It is worth mentioning why the data is scaled and not normalized. Scaling and
    normalization can be confusing terms for data scientists, as they are often used
    interchangeably. In short, scaling the data affects only its *scale* and not its
    *distribution*. Thus, it simply forces the values into a certain range. In our
    case, we force the values to be between 0 and 1.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 值得注意的是，为什么数据是缩放而不是归一化。对于数据科学家来说，缩放和归一化可能是令人困惑的术语，因为它们经常被互换使用。简而言之，缩放数据只会影响其*尺度*，而不会影响其*分布*。因此，它只是将值强制到某个范围内。在我们的情况下，我们将值强制在0到1之间。
- en: Normalizing the data, on the other hand, affects its *distribution* and its
    *scale*. Thus, normalizing the data would force it to have a normal distribution
    or a Gaussian distribution. The original range would also change, and plotting
    the frequency of each value would generate a classic bell curve.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 数据归一化，另一方面，会影响其*分布*和其*尺度*。因此，归一化数据将迫使它具有正态分布或高斯分布。原始范围也会改变，绘制每个值的频率将生成一个经典的钟形曲线。
- en: Normalizing the data is only useful when the models we use require the data
    to be normal. For example, linear discriminant analysis (LDA) is derived from
    the assumption of a normal distribution, so it is better to normalize data before
    using LDA. However, in the case of deep learning, no assumptions are made, so
    normalizing is not required.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们使用的模型需要数据为正态分布时，归一化数据才有用。例如，线性判别分析（LDA）是从正态分布的假设中推导出来的，因此在使用LDA之前最好归一化数据。然而，在深度学习的情况下，没有做出任何假设，因此归一化不是必需的。
- en: Finally, we’ll save each set as a CSV file for use in the following chapters.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们将每个集合保存为CSV文件，以便在后续章节中使用。
- en: '[PRE12]'
  id: totrans-107
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 12.4 Next steps
  id: totrans-108
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.4 下一步
- en: In this chapter, we looked at the use of deep learning for forecasting and covered
    the three main types of deep learning models. We then explored the data we’ll
    be using and performed feature engineering so the data is ready to be used in
    the next chapter, where we’ll apply deep learning models to forecast traffic volume.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们探讨了深度学习在预测中的应用，并介绍了三种主要的深度学习模型。然后我们探讨了我们将使用的数据，并进行了特征工程，以便数据准备好在下一章中使用，在下一章中，我们将应用深度学习模型来预测交通量。
- en: In the next chapter, we will start by implementing baseline models that will
    serve as benchmarks for more complex deep learning architectures. We will also
    implement linear models, the simplest models that can be built, followed by deep
    neural networks, which have at least one hidden layer. Baselines, linear models,
    and deep neural networks will be implemented as single-step models, multi-step
    models, and multi-output models. You should be excited for the next chapter, as
    we’ll start modeling and forecasting using deep learning.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将首先实现基线模型，这些模型将作为更复杂深度学习架构的基准。我们还将实现线性模型，这是可以构建的最简单模型，然后是至少包含一个隐藏层的深度神经网络。基线、线性模型和深度神经网络将被实现为单步模型、多步模型和多输出模型。你应该对下一章感到兴奋，因为我们将开始使用深度学习进行建模和预测。
- en: 12.5 Exercise
  id: totrans-111
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.5 练习
- en: As an exercise, we will prepare some data for use in deep learning exercises
    in chapters 12 through 18\. This data will be used to develop a deep learning
    model to forecast the air quality in Beijing at the Aotizhongxin station.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 作为练习，我们将为第12章至第18章中的深度学习练习准备一些数据。这些数据将用于开发一个深度学习模型，以预测北京奥体中心站的空气质量。
- en: Specifically, for univariate modeling, we will ultimately predict the concentration
    of nitrogen dioxide (NO[2]). For the multivariate problem, we will predict the
    concentration of nitrogen dioxide and temperature.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 具体来说，对于单变量建模，我们最终将预测二氧化氮（NO2）的浓度。对于多变量问题，我们将预测二氧化氮和温度的浓度。
- en: Note Predicting the concentration of air pollutants is an important problem,
    as they can have negative health effects on a population, such as coughing, wheezing,
    inflammation, and reduced lung function. Temperature also plays an important role,
    because hot air tends to rise, creating a convection effect and moving pollutants
    from the ground to higher altitudes. With accurate models, we can better manage
    air pollution and better inform the population to take the right precautions.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 注意预测空气污染物的浓度是一个重要问题，因为它们可以对人群产生负面影响，例如咳嗽、喘息、炎症和降低肺功能。温度也起着重要作用，因为热空气倾向于上升，产生对流效应，并将污染物从地面移动到更高的海拔。有了准确的模型，我们可以更好地管理空气污染，并更好地向公众提供采取适当预防措施的指导。
- en: 'The original dataset is available in the UCI Machine Learning Repository: [https://archive.ics.uci.edu/ml/datasets/Beijing+Multi-Site+Air-Quality+Data](https://archive.ics.uci.edu/ml/datasets/Beijing+Multi-Site+Air-Quality+Data).
    It has been preprocessed and cleaned to treat missing data and make it easy to
    work with (the preprocessing steps are available on GitHub). You will find the
    data in a CSV file on GitHub: [https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH12](https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH12).'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 原始数据集可在UCI机器学习仓库中找到：[https://archive.ics.uci.edu/ml/datasets/Beijing+Multi-Site+Air-Quality+Data](https://archive.ics.uci.edu/ml/datasets/Beijing+Multi-Site+Air-Quality+Data)。它已经过预处理和清理，以处理缺失数据并使其易于处理（预处理步骤可在GitHub上找到）。您将在GitHub上的CSV文件中找到数据：[https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH12](https://github.com/marcopeix/TimeSeriesForecastingInPython/tree/master/CH12)。
- en: 'The objective of this exercise is to prepare the data for deep learning. Follow
    these steps:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 本练习的目标是为深度学习准备数据。按照以下步骤操作：
- en: Read the data.
  id: totrans-117
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 读取数据。
- en: Plot the target.
  id: totrans-118
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 绘制目标变量图。
- en: Remove unnecessary columns.
  id: totrans-119
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 删除不必要的列。
- en: Identify whether there is daily seasonality and encode the time accordingly.
  id: totrans-120
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确定是否存在每日季节性，并相应地编码时间。
- en: Split your data into training, validation, and testing sets.
  id: totrans-121
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将数据分为训练集、验证集和测试集。
- en: Scale the data using `MinMaxScaler`.
  id: totrans-122
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`MinMaxScaler`缩放数据。
- en: Save the train, validation, and test sets to be used later.
  id: totrans-123
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将训练集、验证集和测试集保存以供以后使用。
- en: Summary
  id: totrans-124
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: 'Deep learning for forecasting is used when:'
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当使用深度学习进行预测时：
- en: The dataset is large (more than 10,000 data points).
  id: totrans-126
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 数据集很大（超过10,000个数据点）。
- en: Declination of the SARIMAX model takes a long time to fit.
  id: totrans-127
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: SARIMAX模型的下降拟合需要很长时间。
- en: The residuals of the statistical model still show some correlation.
  id: totrans-128
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 统计模型的残差仍然显示出一些相关性。
- en: There is more than one seasonal period.
  id: totrans-129
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 季节周期不止一个。
- en: 'There are three types of models for forecasting:'
  id: totrans-130
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 预测模型有三种类型：
- en: 'Single-step model: Predicts one step into the future for one variable.'
  id: totrans-131
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 单步模型：预测一个变量的一个步骤的未来值。
- en: 'Multi-step model: Predicts many steps into the future for one variable.'
  id: totrans-132
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 多步模型：预测一个变量的多个步骤的未来值。
- en: 'Multi-output model: Predicts many variables one or more steps into the future.'
  id: totrans-133
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 多输出模型：预测一个或多个步骤的未来多个变量。
