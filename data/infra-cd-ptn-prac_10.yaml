- en: 8 Security and compliance
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 8 安全和合规
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Choosing protections for credentials and secrets in IaC
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 IaC 中选择凭证和秘密的保护措施
- en: Implementing policies to enforce compliant and secure infrastructure
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实施政策以确保合规和安全的架构
- en: Preparing end-to-end tests for security and compliance
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 准备端到端测试以确保安全和合规
- en: In previous chapters, I alluded to the importance of securing infrastructure
    as code and checking its conformance with your organization’s security and compliance
    requirements. Oftentimes, you don’t address these requirements until later in
    your engineering process. By that point, you may have already deployed an insecure
    configuration or violated a compliance requirement about data privacy!
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的章节中，我提到了确保基础设施代码的安全以及检查其是否符合你组织的安全和合规要求的重要性。通常，你不会处理这些要求直到你的工程过程后期。到那时，你可能已经部署了一个不安全的配置或违反了关于数据隐私的合规要求！
- en: For example, imagine you work for a retail company called uDress. Your team
    has six months to build a new frontend application on GCP. The company needs it
    available by the holiday season. Your team works very hard and develops enough
    functionality to go live. However, a month before you deploy and test the new
    application, the compliance and security team performs an audit—and you fail.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，想象一下你为一家名为 uDress 的零售公司工作。你的团队有六个月的时间在 GCP 上构建一个新的前端应用程序。公司需要在假日季节前使其可用。你的团队非常努力地工作，开发出足够的功能以便上线。然而，在你部署和测试新应用程序的一个月前，合规和安全团队进行了一次审计——你失败了。
- en: Now, you have new items in your backlog to fix the security and compliance issues
    and adhere to company policy. Unfortunately, these fixes delay your delivery timeline
    or, at worst, break functionality. You might wish that you knew about these from
    the very beginning, at least so you could plan for them!
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你需要在你的待办事项中添加新的项目来解决安全和合规问题，并遵守公司政策。不幸的是，这些修复延迟了你的交付时间表，在最坏的情况下，破坏了功能。你可能希望从一开始就知道这些，至少这样你可以为它们做出计划！
- en: Your company’s *policy* ensures that systems comply with security, audit, and
    organizational requirements. In addition, your security or compliance teams often
    define policies based on industry, country, and more.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 你的公司的*政策*确保系统符合安全、审计和组织要求。此外，你的安全或合规团队通常根据行业、国家等因素定义政策。
- en: Definition A *policy* is a set of rules and standards in your organization to
    ensure compliance to security, industry, or regulatory requirements.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 A *政策* 是你组织中的一套规则和标准，以确保符合安全、行业或监管要求。
- en: This chapter will teach you to protect credentials and secrets and write tests
    to enforce policies for security and compliance. If you think about these practices
    before you write IaC, you can build secure, compliant infrastructure and avoid
    delays in your delivery timeline. Inspired by a manager I used to work with, “We’re
    baking security into the infrastructure instead of icing it later.”
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将教你如何保护凭证和秘密，并编写测试以强制执行安全和合规政策。如果你在编写 IaC 之前考虑这些实践，你可以构建安全、合规的基础设施，并避免交付时间表上的延误。受一位我以前共事过的经理的启发，“我们正在将安全烘焙到基础设施中，而不是在之后添加糖霜。”
- en: 8.1 Managing access and secrets
  id: totrans-11
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.1 管理访问和秘密
- en: I already introduced the idea of “baking” security into IaC in chapter 2\. IaC
    uses two sets of secrets. You use API credentials to automate infrastructure and
    sensitive variables such as passwords to pass to resources. You can store both
    secrets in secrets managers to handle their protection and rotation.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 我已经在第二章中介绍了将“烘焙”安全理念融入 IaC 的想法。IaC 使用两套秘密。你使用 API 凭证来自动化基础设施，并将敏感变量（如密码）传递给资源。你可以在秘密管理器中存储这两个秘密以处理其保护和轮换。
- en: In this section, I focus on securing IaC delivery pipelines. IaC expresses the
    expected state of the infrastructure, which often includes root passwords, usernames,
    private keys, and other sensitive information. Infrastructure delivery pipelines
    control the deployment and release of infrastructure that needs this information.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我专注于确保 IaC 交付管道的安全。IaC 表达了基础设施的预期状态，这通常包括根密码、用户名、私钥和其他敏感信息。基础设施交付管道控制需要这些信息的基础设施的部署和发布。
- en: Let’s imagine you build delivery pipelines for the new uDress system to deploy
    infrastructure. The pipelines use a set of infrastructure provider credentials
    to create and update resources. Each pipeline also reads a database password from
    a secrets manager and passes it as an attribute to create the database.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们设想你为新的 uDress 系统构建交付管道以部署基础设施。这些管道使用一组基础设施提供者凭证来创建和更新资源。每个管道还从密钥管理器中读取数据库密码，并将其作为属性传递以创建数据库。
- en: Your security team points out two problems with your approach. First, the infrastructure
    delivery pipeline uses full administrative credentials to configure GCP. Second,
    your team’s delivery pipeline accidentally prints out the root database password
    in its logs!
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 你的安全团队指出你方法中的两个问题。首先，基础设施交付管道使用完整的管理凭证来配置 GCP。其次，你的团队的交付管道意外地在日志中打印出了根数据库密码！
- en: Your delivery pipeline just increased the *attack surface* (sum of the different
    points of attack) of your system.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 你的交付管道增加了你系统**攻击面**（不同攻击点的总和）。
- en: Definition The *attack surface* describes the sum of different points of attack
    where an unauthorized user can compromise a system.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 **攻击面** 描述了未经授权的用户可以损害系统的不同攻击点的总和。
- en: Anyone can use the administrative credentials or root database password to gain
    information and compromise your system. You need a solution to better secure the
    credentials and the database password. The solution should hopefully minimize
    the attack surface.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 任何人都可以使用管理凭证或根数据库密码来获取信息并损害你的系统。你需要一个解决方案来更好地保护凭证和数据库密码。该解决方案应有望最小化攻击面。
- en: 8.1.1 Principle of least privilege
  id: totrans-19
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.1.1 最小权限原则
- en: IaC delivery pipelines have points of attack that allow unauthorized users to
    use credentials with elevated access. For example, you used chapter 7 to build
    a pipeline that continuously delivers infrastructure changes to production. The
    pipeline needs some permissions to change infrastructure in GCP.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: IaC 交付管道存在攻击点，允许未经授权的用户使用具有提升访问权限的凭证。例如，你使用第 7 章构建了一个管道，该管道持续将基础设施更改交付到生产环境中。该管道需要一些权限来更改
    GCP 中的基础设施。
- en: Initially, your team gives the pipeline full administrative credentials so it
    can create all of the resources in GCP. If someone accesses those credentials,
    they could create and update anything in the uDress system. Someone could exploit
    your team’s pipeline to run machine learning models or access other customer data!
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 初始时，你的团队授予管道完整的管理凭证，以便它可以创建 GCP 中的所有资源。如果有人访问这些凭证，他们可以在 uDress 系统中创建和更新任何内容！有人可能会利用你团队的管道来运行机器学习模型或访问其他客户数据！
- en: The pipeline does not *need* access to every resource. You decide to update
    the credentials so it uses only the minimal set of permissions it needs to update
    specific resources. You determine that the IaC creates only network, Google App
    Engine, and Cloud SQL resources. You remove administrative access from the credentials
    and replace them with write access to the three resources.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 管道不需要访问每个资源。你决定更新凭证，使其仅使用更新特定资源所需的最小权限集。你确定 IaC 仅创建网络、Google App Engine 和 Cloud
    SQL 资源。你从凭证中移除了管理访问权限，并用对三个资源的写入访问权限替换它们。
- en: When the pipeline runs, as shown in figure 8.1, the new credentials have just
    enough access to update the three sets of resources. It also retrieves the database
    password from the secrets manager before deploying updates to the network, application,
    and database. After deploying the changes to a testing environment, you add a
    unit test to verify that the credentials no longer have administrative access.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 当管道运行时，如图 8.1 所示，新的凭证恰好有足够的访问权限来更新三组资源。它还在部署网络、应用程序和数据库更新之前从密钥管理器中检索数据库密码。在将更改部署到测试环境后，你添加了一个单元测试来验证凭证不再具有管理访问权限。
- en: '![](../../OEBPS/Images/CH08_F01_Wang.png)'
  id: totrans-24
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH08_F01_Wang.png)'
- en: Figure 8.1 Remove administrative credentials from the uDress frontend delivery
    pipeline and limit them to network, application, and database access.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.1 从 uDress 前端交付管道中移除管理凭证，并限制其访问网络、应用程序和数据库。
- en: You remediated the security concern of pipeline credentials by using the *principle
    of least privilege*. This principle ensures that a user or service account gets
    only the minimum access they require to complete their task.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 你通过使用**最小权限原则**解决了管道凭证的安全问题。这个原则确保用户或服务帐户只能获得完成其任务所需的最小访问权限。
- en: Definition The *principle of least privilege* indicates that users or service
    accounts should have minimum access requirements to a system. They should have
    only enough to complete their tasks.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *最小权限原则* 指出，用户或服务帐户应具有对系统的最低访问要求。他们应该只有完成其任务所需的最少权限。
- en: Maintaining the principle of least privilege takes time and effort. You usually
    change access as you add new resources to IaC. In general, attach roles to delivery
    pipeline credentials. Grouping access permissions into roles helps promote composability
    so you can add and remove access as needed.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 维护最小权限原则需要时间和精力。您通常在向IaC添加新资源时更改访问权限。通常，将角色附加到交付管道凭证。将访问权限分组到角色中有助于提高可组合性，因此您可以按需添加和删除访问权限。
- en: Apply the module practices from chapter 3 to offer modules of permission sets.
    For example, you may offer a factory module for uDress’s web applications to customize
    network, application, and database write access. Any web application can use the
    module and properly reproduce the minimum set of privileges it needs.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 将第3章中的模块实践应用于提供权限集模块。例如，您可以为uDress的Web应用程序提供一个工厂模块来自定义网络、应用程序和数据库的写入访问权限。任何Web应用程序都可以使用该模块，并正确地复制它所需的最低权限集。
- en: Let’s use the access management module to implement least privilege access management
    for uDress’s frontend delivery pipeline in listing 8.1\. You limit the pipeline
    to network, application, and Cloud SQL administrative credentials. These credentials
    allow the pipeline to create, delete, and update the network, application, and
    database, but not update any other resource types.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们使用访问管理模块在列表8.1中实现uDress前端交付管道的最小权限访问管理。您将管道限制为网络、应用程序和Cloud SQL管理凭证。这些凭证允许管道创建、删除和更新网络、应用程序和数据库，但不能更新其他资源类型。
- en: Listing 8.1 Least privilege access management policy for the frontend
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.1 前端最小权限访问管理策略
- en: '[PRE0]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: ❶ Creates the role configuration based on a list of roles for a service account,
    including networking, App Engine, and Cloud SQL
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 根据服务帐户的角色列表创建角色配置，包括网络、App Engine和Cloud SQL
- en: ❷ Imports the application access management factory module to create access
    management roles for the frontend application
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 导入应用程序访问管理工厂模块以创建前端应用程序的访问管理角色
- en: ❸ Uses the method to create the JSON configuration for the pipeline’s access
    permissions
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 使用该方法创建管道访问权限的JSON配置
- en: ❹ Writes the Python dictionary out to a JSON file to be executed by Terraform
    later
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 将Python字典写入JSON文件，以便稍后由Terraform执行
- en: AWS and Azure equivalents
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure的等效功能
- en: Google App Engine is similar to AWS Elastic Beanstalk or Azure App Service,
    which deploy web applications and services to provider-managed infrastructure.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: Google App Engine类似于AWS Elastic Beanstalk或Azure App Service，它们将Web应用程序和服务部署到提供商管理的环境中。
- en: Google Cloud SQL is similar to Amazon Relational Database Service (RDS), which
    deploys different managed databases. Azure has different services for specific
    databases, such as Azure Database for PostgreSQL or Azure SQL Database offerings.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: Google Cloud SQL类似于Amazon关系数据库服务（RDS），它部署不同的托管数据库。Azure为特定数据库提供不同的服务，例如Azure
    Database for PostgreSQL或Azure SQL Database服务。
- en: As you adhere to the principle of least privilege, take care when you remove
    permissions. Sometimes a pipeline needs more specific permissions to read or update
    dependencies. You can break infrastructure or applications if they do not have
    sufficient permissions.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 在遵循最小权限原则的同时，移除权限时要小心。有时，管道需要更具体的权限来读取或更新依赖项。如果没有足够的权限，可能会破坏基础设施或应用程序。
- en: Some infrastructure providers, including GCP, analyze the permissions used for
    a service account or user and output a set of excess permissions. You can also
    run other third-party tools to analyze access and identify unused permissions.
    I recommend using these tools to check and update your access control each time
    you add a new infrastructure resource.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 一些基础设施提供商，包括GCP，分析服务帐户或用户使用的权限，并输出一组多余的权限。您还可以运行其他第三方工具来分析访问并识别未使用的权限。我建议在每次添加新的基础设施资源时，使用这些工具检查和更新您的访问控制。
- en: 8.1.2 Protecting secrets in configuration
  id: totrans-42
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.1.2 配置中的保密性保护
- en: Besides using administrative credentials from a pipeline to access an infrastructure
    provider, someone could alter the pipeline to print out sensitive information
    about infrastructure. For example, the frontend delivery pipeline outputs the
    root database password in the logs. Anyone accessing the logs from the pipeline
    can use the root password to log into the database!
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 除了使用来自管道的管理凭证访问基础设施提供商外，有人可能会更改管道以打印有关基础设施的敏感信息。例如，前端交付管道在日志中输出根数据库密码。任何从管道访问日志的人都可以使用根密码登录数据库！
- en: To address this security concern, you decide to mark the password as a *sensitive
    variable* by using your IaC tool. The tool redacts the password in the logs. You
    also *install a plugin* in your pipeline tool to identify and redact any sensitive
    information, such as the password. You add these two configurations to your pipeline
    in figure 8.2 to avoid compromising the database password in the pipeline logs.
    As a safety precaution, you rotate the database password in the secrets manager
    and directly change the password in the database, rather than using IaC.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 为了解决这个安全问题，你决定通过使用你的IaC工具将密码标记为*敏感变量*。该工具在日志中删除密码。你还在管道工具中*安装了一个插件*，用于识别和删除任何敏感信息，例如密码。你将这些两个配置添加到图8.2中的管道中，以避免在管道日志中泄露数据库密码。作为安全预防措施，你在密钥管理器中轮换数据库密码，并直接更改数据库中的密码，而不是使用IaC。
- en: You can use tools to *mask* the password in the delivery pipeline by either
    suppressing or redacting the plaintext information.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过抑制或删除明文信息来使用工具在交付管道中掩码密码。
- en: Definition *Masking* your sensitive information means suppressing or redacting
    its plaintext format to prevent someone from reading the information.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 定义*掩码*你的敏感信息意味着抑制或删除其明文格式，以防止某人读取信息。
- en: Using one or both mechanisms will prevent the sensitive information from appearing
    in the pipeline logs. Sensitive information can include passwords, encryption
    keys, or infrastructure identifiers like IP addresses. If you think someone can
    use the information to gain access to your system, consider masking the value
    in your pipeline.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 使用一种或两种机制可以防止敏感信息出现在管道日志中。敏感信息可能包括密码、加密密钥或像IP地址这样的基础设施标识符。如果你认为有人可以利用这些信息访问你的系统，考虑在管道中掩码这些值。
- en: However, masking sensitive information doesn’t guarantee protection from unauthorized
    access. You still need a workflow to *remediate* the exposed credentials as quickly
    as possible. As a solution, store and rotate the credentials with a secrets manager
    after you use them to configure your IaC.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，掩码敏感信息并不能保证防止未授权访问。你仍然需要一个工作流程，以尽可能快地*修复*暴露的凭证。作为一个解决方案，在使用它们配置IaC之后，使用密钥管理器存储和轮换凭证。
- en: '![](../../OEBPS/Images/CH08_F02_Wang.png)'
  id: totrans-49
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH08_F02_Wang.png)'
- en: Figure 8.2 You can protect the root database password by using tools to mask
    the value and rotating the credential after applying changes to IaC.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.2 你可以通过使用工具掩码值并在应用IaC更改后轮换凭证来保护根数据库密码。
- en: Separately managing secrets introduces mutability, or in-place changes, to your
    IaC. While it introduces drift between the actual root database password and the
    one expressed in IaC, managing the password mutably prevents someone from exploiting
    the IaC pipeline and using the credentials.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 分别管理密钥会在你的基础设施即代码（IaC）中引入可变性，或者说是在原地更改。虽然这会在实际根数据库密码和IaC中表达的密码之间引入漂移，但以可变方式管理密码可以防止某人利用IaC管道并使用凭证。
- en: 'As you build IaC, think about this checklist of security requirements in your
    delivery pipeline to minimize its attack surface:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 当你构建IaC时，考虑以下安全要求清单，以最小化你的交付管道的攻击面：
- en: Check for *least privilege access* for infrastructure provider credentials from
    the beginning. You should provide enough permissions to apply and secure your
    IaC.
  id: totrans-53
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从一开始就检查基础设施提供商凭证的*最小权限访问*。你应该提供足够的权限来应用和确保你的IaC。
- en: Generate a secret by *using a function* to generate a random string or read
    the secret from a secrets manager. Avoid passing secrets as static variables to
    your configuration.
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过使用一个函数来生成随机字符串或从密钥管理器中读取密钥来生成一个密钥。避免将密钥作为静态变量传递到你的配置中。
- en: Check that your pipeline *masks sensitive configuration data* in its dry-run
    capability or command outputs.
  id: totrans-55
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 检查你的管道在模拟运行能力或命令输出中是否*掩码敏感配置数据*。
- en: Provide a mechanism to *revoke and rotate compromised credentials* or data quickly.
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 提供一种机制，以便快速*撤销和旋转受损的凭证*或数据。
- en: You can solve many of the requirements in the checklist with a secrets manager.
    The secrets manager can omit the need for statically defining secrets in configuration.
    While some requirements serve as general security practices for delivery pipelines,
    they also apply to secure IaC. You can review chapter 2 for the pattern of securing
    secrets with a secrets manager.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以用秘密管理器解决清单中的许多要求。秘密管理器可以省略在配置中静态定义秘密的需要。虽然一些要求作为交付管道的一般安全实践，但它们也适用于安全的IaC。你可以查看第2章以了解使用秘密管理器保护秘密的模式。
- en: 8.2 Tagging infrastructure
  id: totrans-58
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.2 标签化基础设施
- en: After securing your infrastructure, you have the challenge of running and supporting
    it. Operating infrastructure requires a set of troubleshooting and auditing patterns
    and practices. As you continue to add infrastructure to your system, you need
    a way to identify the purpose and life cycle of resources.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 在确保你的基础设施安全之后，你面临运行和支持它的挑战。操作基础设施需要一组故障排除和审计模式和惯例。随着你继续向系统中添加基础设施，你需要一种方法来识别资源的目的和生命周期。
- en: Imagine the uDress frontend application goes live. However, your team gets a
    message from the finance team. Your infrastructure provider billing has exceeded
    the expected budget for the past two or three months. You search in the provider’s
    interface to determine which resources have contributed most to the cost. How
    do you know the owner and environment of each resource?
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 想象一下，uDress前端应用程序上线了。然而，你的团队收到了来自财务团队的消息。你的基础设施提供商在过去两三个月的账单已经超过了预期的预算。你搜索提供商的界面以确定哪些资源对成本贡献最大。你如何知道每个资源的所有者和环境？
- en: GCP offers the use of labels, which allows you to add metadata to your resources
    for identification and audit purposes. You update these labels to include owner
    and environment. In figure 8.3, uDress includes identification of owner and environment,
    standards for tag format, and automation metadata. You decide to dash-delimit
    tag names and values so the tags work with GCP.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: GCP提供了使用标签的功能，这允许你为你的资源添加元数据以用于标识和审计目的。你更新这些标签以包括所有者和环境。在图8.3中，uDress包括所有者和环境的标识、标签格式的标准以及自动化元数据。你决定使用短横线分隔标签名称和值，以便标签与GCP兼容。
- en: '![](../../OEBPS/Images/CH08_F03_Wang.png)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH08_F03_Wang.png)'
- en: Figure 8.3 Tags should include identification of owner, environment, and automation
    for easy troubleshooting.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.3 标签应包括所有者、环境和自动化标识，以便于故障排除。
- en: Outside of GCP, other infrastructure providers allow you to add metadata to
    identify resources. In your organization, you’ll develop a *tagging strategy*
    to define a standard set of metadata used for auditing your infrastructure system.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 在GCP之外，其他基础设施提供商允许你添加元数据以标识资源。在你的组织中，你将制定一个*标签策略*来定义一组用于审计基础设施系统的标准元数据。
- en: Definition A *tagging strategy* defines a set of metadata (also known as *tags*)
    used for auditing, managing, and securing infrastructure resources in your organization.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 定义*标签策略*定义了一组用于审计、管理和保护组织中基础设施资源的元数据（也称为*标签*）。
- en: Why use metadata in the form of tags? Tags help you search and audit resources,
    actions necessary for billing and compliance. You can also use tags to do bulk
    automation of infrastructure resources. Bulk automation includes cleanup or break-glass
    (manual changes to stabilize or fix system failures) updates to a subset of resources.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么使用标签形式的元数据？标签可以帮助你搜索和审计资源，这对于计费和合规性是必要的。你还可以使用标签来对基础设施资源进行批量自动化。批量自动化包括清理或破窗（手动更改以稳定或修复系统故障）对资源子集的更新。
- en: Let’s implement standard tags for uDress in the following listing. From chapter
    3, you apply the prototype pattern to define a list of standard tags for your
    uDress. You reference the uDress tag module to create a list of labels for a GCP
    server in your code.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们在以下列表中为uDress实现标准标签。从第3章开始，你应用原型模式来定义一组标准标签。你参考uDress标签模块来在你的代码中创建GCP服务器的标签列表。
- en: Listing 8.2 Using the tags module to set standard tags for the server
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.2 使用标签模块为服务器设置标准标签
- en: '[PRE1]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: ❶ The tag module uses the prototype pattern to define a standard set of tags.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 标签模块使用原型模式定义一组标准的标签。
- en: ❷ Sets tags to identify owner, department, business unit for billing, and repository
    for the resource
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 设置标签以标识所有者、部门、业务单元用于计费，以及资源存储库
- en: ❸ Passes the required parameters to set tags for the frontend application
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 将必需的参数传递给前端应用程序设置标签
- en: ❹ Uses the module to create the JSON configuration for the server
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 使用模块创建服务器的JSON配置
- en: ❺ Creates the Google compute instance (server) by using a Terraform resource
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 通过Terraform资源创建Google计算实例（服务器）
- en: ❻ Add the tags from the tag module as labels to the Google compute instance
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 将标签模块中的标签添加为Google计算实例的标签
- en: AWS and Azure equivalents
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure等效项
- en: To convert listing 8.2 to another cloud provider, change the resource to an
    Amazon EC2 instance or Azure Linux virtual machine. Then, pass `self.tags` to
    the `tags` attribute for the AWS or Azure resource.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 要将列表8.2转换为另一个云服务提供商，将资源更改为Amazon EC2实例或Azure Linux虚拟机。然后，将`self.tags`传递给AWS或Azure资源的`tags`属性。
- en: 'How do you know which tags to add? Recall from chapter 2 that you must standardize
    the naming *and* tagging of your infrastructure resources. Discuss these considerations
    with compliance, security, and finance teams. That will help determine which tags
    you need and how to use them. At a minimum, I *always* have a tag for the following:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 你如何知道要添加哪些标签？回想第2章，你必须标准化你的基础设施资源的命名*和*标签。与合规性、安全和财务团队讨论这些考虑因素。这将有助于确定你需要哪些标签以及如何使用它们。至少，我*总是*为以下内容添加一个标签：
- en: Service or team
  id: totrans-79
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 服务或团队
- en: Team email or communication channel
  id: totrans-80
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 团队电子邮件或通讯渠道
- en: Environment (development or production)
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 环境（开发或生产）
- en: For example, let’s say the uDress security team audits the frontend resources
    and discovers some misconfigured infrastructure. The team members can check the
    tags, identify the service and environment with the problem, and reach out to
    the team that created the resource.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，假设uDress安全团队审计前端资源并发现一些配置错误的基础设施。团队成员可以检查标签，识别有问题的服务和环境，并联系创建该资源的团队。
- en: 'You may also include tags for the following:'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以包括以下标签：
- en: Automation, which helps you identify manually created resources from automated
    ones
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自动化，帮助你识别手动创建的资源与自动化资源
- en: Repository, which allows you to correlate the resource with its original configuration
    in version control
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 仓库，允许你将资源与其在版本控制中的原始配置相关联
- en: The business unit, which identifies the billing or charge-back identifier for
    accounting
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 业务单元，用于识别会计的计费或冲销标识符
- en: Compliance, which identifies whether the resource has compliance or policy requirements
    for handling personal information
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 合规性，用于识别资源是否具有处理个人信息的合规性或策略要求
- en: As you decide on your tagging, make sure it conforms to a general set of constraints
    so you can apply the same tags across any infrastructure provider. Most infrastructure
    providers have character restrictions on tags. I usually prefer *dash-case*, which
    uses lowercase tag names and values split with hyphens. While you can use camel
    case (stylistically, camelCase), not all providers have case-sensitive tagging.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 在你决定标签时，确保它符合一组通用的约束条件，这样你就可以在任何基础设施提供商上应用相同的标签。大多数基础设施提供商对标签有字符限制。我通常更喜欢*短横线命名法*，它使用小写标签名称，值由短横线分隔。虽然你可以使用驼峰命名法（从风格上讲，camelCase），但并非所有提供商都有大小写敏感的标签。
- en: Tag character limits also vary depending on the infrastructure provider. Most
    providers support a *maximum length* of 128 characters for the tag key and 256
    characters for the tag value. You will have to balance the verbosity of descriptive
    names (described in chapter 2) with the provider’s tag limits!
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 标签字符限制也因基础设施提供商而异。大多数提供商支持标签键的最大长度为128个字符，标签值的最大长度为256个字符。你必须平衡描述性名称的冗长性（在第2章中描述）与提供商的标签限制！
- en: Another part of your tagging strategy involves deciding whether you *delete
    untagged resources*. Consider enforcing tags for all resources in the production
    environment. The testing environment can support untagged resources for manual
    testing. In general, I do not recommend immediately deleting untagged resources
    without careful examination. You don’t want to delete an essential resource by
    accident.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 你的标签策略的另一部分涉及决定是否*删除未标记的资源*。考虑在生产环境中强制对所有资源进行标记。测试环境可以支持未标记的资源进行手动测试。一般来说，我不建议在没有仔细检查的情况下立即删除未标记的资源。你不希望意外删除一个重要的资源。
- en: 8.3 Policy as code
  id: totrans-91
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.3 编码策略
- en: Securing access and secrets in infrastructure delivery pipelines and managing
    tags in infrastructure providers can improve security and compliance practices.
    However, you might wish to identify insecure or noncompliant infrastructure configuration
    *before* it goes to production. You’d like to catch a problem before someone finds
    it in your production system.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在基础设施交付管道中保护访问和秘密以及管理基础设施提供者中的标签可以提高安全和合规实践。然而，你可能希望在配置进入生产之前就识别不安全或不合规的基础设施配置。你希望在有人在你生产系统中发现问题之前就捕捉到问题。
- en: Imagine connecting the uDress frontend application to another database. You
    open a firewall rule to allow all traffic inbound to a managed database for testing.
    After testing, you expect to remove the database, so you do not tag it.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 想象一下将 uDress 前端应用程序连接到另一个数据库。你打开防火墙规则以允许所有流量进入用于测试的管理数据库。测试完成后，你预计会删除数据库，因此你没有对其进行标记。
- en: You forget about the firewall and tag configuration and send it off for review.
    Unfortunately, your teammate misses them in code review and pushes the changes
    to production. Two weeks later, you discover that an unknown entity has accessed
    some data! However, you have no tags to identify the compromised database.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 你忘记了防火墙和标签配置，并将其发送进行审查。不幸的是，你的队友在代码审查中错过了它们，并将更改推送到生产环境。两周后，你发现一个未知实体访问了一些数据！然而，你没有标签来识别受损害的数据库。
- en: What could you have done differently? Recall the importance of unit tests or
    static analysis of infrastructure configuration in chapter 6\. You can apply the
    *same* techniques to write tests specifically for security and policy.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 你本可以做什么不同？回想一下第6章中提到的单元测试或基础设施配置的静态分析的重要性。你可以应用 *相同* 的技术来编写专门针对安全和策略的测试。
- en: Rather than depend on a teammate to catch the problem, you can express policy
    as code to statically analyze the configuration for the permissive firewall rule
    or lack of tags. *Policy as code* tests infrastructure metadata and verifies that
    it complies with security or compliance requirements.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 而不是依赖队友来发现问题，你可以将策略表达为代码以静态分析配置中的宽松防火墙规则或缺少标签。*策略即代码* 测试基础设施元数据，并验证其是否符合安全或合规要求。
- en: Definition *Policy as code* (also known as *shift-left security testing**,*
    or *static analysis of IaC*) tests infrastructure metadata and verifies that values
    comply with security or compliance requirements before pushing changes to production.
    Policy as code includes the rules you write for dynamic analysis tools or vulnerability
    scanning.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *策略即代码*（也称为 *左移安全测试* 或 *基础设施即代码的静态分析*）在推送更改到生产之前测试基础设施元数据，并验证其值是否符合安全或合规要求。策略即代码包括你为动态分析工具或漏洞扫描编写的规则。
- en: I discussed the long-term benefit of automating and testing IaC in chapters
    1 and 6\. You similarly have an initial short-term time investment for writing
    policy as code. The policy checks continuously verify the compliance of each change
    you want to make to production. You minimize the surprises after the compliance
    and security teams audit your system. Over time, you decrease the long-term time
    investment with a shorter time to production.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 我在第1章和第6章中讨论了自动化和测试基础设施的长期好处。你同样需要初始的短期时间投资来编写策略即代码。策略检查会持续验证你想要对生产环境进行的每个更改的合规性。你最小化了合规性和安全团队审计你的系统后的惊喜。随着时间的推移，你通过缩短生产时间来减少长期的时间投资。
- en: 8.3.1 Policy engines and standards
  id: totrans-99
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.3.1 策略引擎和标准
- en: Tools can help run policy as code by evaluating metadata based on a set of rules.
    Most testing tools in this space use a policy engine. A *policy engine* takes
    policies as input and evaluates infrastructure resources for compliance.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 工具可以通过根据一组规则评估元数据来帮助运行策略即代码。这个领域的大多数测试工具都使用策略引擎。*策略引擎* 以策略作为输入，并评估基础设施资源以验证其合规性。
- en: Definition A *policy engine* takes policies as the input and evaluates resource
    metadata for compliance to policies.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 A *策略引擎* 以策略作为输入，并评估资源元数据是否符合策略。
- en: Many policy engines parse and check fields in infrastructure configuration or
    state. In figure 8.4, a policy engine extracts JSON or other metadata from the
    IaC or system state. Then it passes the metadata to a security or policy test.
    The engine runs the test to parse fields, check their values, and fail if the
    actual values do not match the expected values.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 许多策略引擎会解析和检查基础设施配置或状态中的字段。在图8.4中，策略引擎从基础设施即代码(IaC)或系统状态中提取JSON或其他元数据。然后，它将这些元数据传递给安全或策略测试。引擎运行测试以解析字段，检查它们的值，如果实际值与预期值不匹配，则失败。
- en: '![](../../OEBPS/Images/CH08_F04_Wang.png)'
  id: totrans-103
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH08_F04_Wang.png)'
- en: Figure 8.4 Tests for security and policy parse the configuration or state of
    the system for the correct field values and fail if they do not match an expected
    value.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.4 安全和策略测试解析系统的配置或状态以获取正确的字段值，如果它们与预期值不匹配则失败。
- en: This workflow applies to policy as code tools *and* any tests you write yourself.
    Policy as code tools make testing for values more straightforward because the
    tools abstract the complexity of parsing for fields and checking the values. However,
    tools don’t cover every value or use case you want to test.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 此工作流程适用于策略代码工具以及您自己编写的任何测试。策略代码工具使得测试值更加直接，因为这些工具抽象了解析字段和检查值的复杂性。然而，工具并不涵盖您想要测试的所有值或用例。
- en: As a result, you usually write your own policy engine to suit your purposes.
    In the examples for this chapter, I use pytest, a Python testing framework, as
    a primitive “policy engine” to check for a secure and compliant configuration.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，您通常需要编写自己的策略引擎以满足您的需求。在本章的示例中，我使用pytest，一个Python测试框架，作为原始的“策略引擎”来检查安全且合规的配置。
- en: Policy engines
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 策略引擎
- en: 'The policy as a code ecosystem has different tools for different purposes.
    Most tools fall into one of three use cases, all of which address very different
    functions and vary widely in behavior:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 策略代码生态系统为不同的目的提供了不同的工具。大多数工具都分为三个用例之一，所有这些用例都解决非常不同的功能，并且行为差异很大：
- en: Security tests for specific platforms
  id: totrans-109
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 特定平台的网络安全测试
- en: Policy tests for industry or regulatory standards
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 行业或监管标准的策略测试
- en: Custom policies
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 自定义策略
- en: Table 8.1 includes a non-exhaustive list of policy engines for *provisioning*
    tools, both vendor and open source. I’ve outlined a few of the technology integrations
    and the use case category for each tool.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 表8.1包含了一个非详尽的策略引擎列表，用于*配置*工具，包括供应商和开源。我概述了每个工具的一些技术集成和用例类别。
- en: Table 8.1 Examples of policy engines for provisioning tools
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 表8.1 配置工具的策略引擎示例
- en: '| Tool | Use case(s) | Technology integration(s) |'
  id: totrans-114
  prefs: []
  type: TYPE_TB
  zh: '| 工具 | 用例 | 技术集成 |'
- en: '| AWS CloudFormation Guard | Security tests for specific platformsCustom policies
    | AWS CloudFormation |'
  id: totrans-115
  prefs: []
  type: TYPE_TB
  zh: '| AWS CloudFormation Guard | 特定平台的网络安全测试自定义策略 | AWS CloudFormation |'
- en: '| HashiCorp Sentinel | Security tests for specific platformsCustom policies
    | HashiCorp Terraform |'
  id: totrans-116
  prefs: []
  type: TYPE_TB
  zh: '| HashiCorp Sentinel | 特定平台的网络安全测试自定义策略 | HashiCorp Terraform |'
- en: '| Pulumi CrossGuard | Security tests for specific platformsCustom policies
    | Pulumi SDK |'
  id: totrans-117
  prefs: []
  type: TYPE_TB
  zh: '| Pulumi CrossGuard | 特定平台的网络安全测试自定义策略 | Pulumi SDK |'
- en: '| Open Policy Agent(Underlying technology for Fugue, Conftest, Kubernetes Gatekeeper,
    and more) | Security tests for specific platforms (tool-dependent)Policy tests
    for industry or regulatory standards (tool-dependent)Custom policies | Various
    (for a complete list, see [www.openpolicyagent.org/docs/latest/ecosystem/](http://www.openpolicyagent.org/docs/latest/ecosystem/))
    |'
  id: totrans-118
  prefs: []
  type: TYPE_TB
  zh: '| Open Policy Agent（Fugue、Conftest、Kubernetes Gatekeeper等底层技术） | 特定平台的网络安全测试（工具相关）行业或监管标准的策略测试（工具相关）自定义策略
    | 各种（要获取完整列表，请参阅[www.openpolicyagent.org/docs/latest/ecosystem/](http://www.openpolicyagent.org/docs/latest/ecosystem/)）|'
- en: '| Chef InSpec | Security tests for specific platformsCustom policies | Various
    (for a complete list, search the Chef marketplace at [https://supermarket.chef.io](https://supermarket.chef.io))
    |'
  id: totrans-119
  prefs: []
  type: TYPE_TB
  zh: '| Chef InSpec | 特定平台的网络安全测试自定义策略 | 各种（要获取完整列表，请搜索Chef市场[https://supermarket.chef.io](https://supermarket.chef.io)）|'
- en: '| Kyverno | Security tests for specific platformsCustom policies | Kubernetes
    |'
  id: totrans-120
  prefs: []
  type: TYPE_TB
  zh: '| Kyverno | 特定平台的网络安全测试自定义策略 | Kubernetes |'
- en: You often need to *mix and match* tools to cover all use cases. No single tool
    covers all use cases. Some tools offer customization, which you can use to build
    policies of your own. In general, consider extending an existing tool with custom
    policies so you can establish opinionated patterns and defaults with your security,
    compliance, and engineering teams. In reality, you’ll probably adopt five or six
    policy engines to cover the tools, platforms, and policies you need.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 您通常需要*混合搭配*工具以覆盖所有用例。没有单个工具可以覆盖所有用例。一些工具提供定制化，您可以使用它来构建自己的策略。通常，考虑通过自定义策略扩展现有工具，以便您可以与您的安全、合规和工程团队建立有见地的模式和默认值。实际上，您可能需要采用五到六个策略引擎来覆盖所需的工具、平台和政策。
- en: Note that I do not include any security or policy tooling specific to data center
    appliances, which often depend on your organization’s procurement requirements.
    You may also find some community projects outside of the examples listed in table
    8.1\. I often find these tools and their integrations replaced by newer ones since
    the ecosystem changes rapidly.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，我没有包括任何特定于数据中心设备的特定安全或策略工具，这些工具通常依赖于你组织的采购要求。你也许还会在表8.1中列出的示例之外找到一些社区项目。我经常发现这些工具及其集成被更新的工具所取代，因为生态系统变化迅速。
- en: Image building and configuration management
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 镜像构建和配置管理
- en: Image building tools do not have too many security or policy tools, as you tend
    to write your tests for them. Configuration management tools follow a similar
    approach to provisioning tools. You will need to find community or built-in tools
    that verify security and policy configuration.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 镜像构建工具没有太多安全或策略工具，因为你倾向于为他们编写测试。配置管理工具遵循与配置工具类似的方法。你需要找到社区或内置工具来验证安全和策略配置。
- en: Industry or regulatory standards
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 行业或监管标准
- en: You might examine table 8.1 and discover that few tools include policy tests
    for industry or regulatory standards. Most of these policies exist in documentation
    form, and you often have to write them yourself. On occasion, you can find policy
    test suites created by the community that you’ll need to augment with your own.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会查看表8.1并发现，很少有工具包括针对行业或监管标准的策略测试。大多数这些策略以文档形式存在，你通常需要自己编写它们。有时，你可以找到社区创建的策略测试套件，你需要用你自己的内容来补充。
- en: For example, the National Institute of Standards and Technology (NIST) in the
    United States publishes a list of security benchmarks as part of the National
    Checklist Program ([https://ncp.nist.gov/repository](https://ncp.nist.gov/repository)).
    A reviewer for this book also recommended Security Technical Implementation Guides
    (STIGs) from the US Department of Defense, including technical testing and configuration
    standards.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，美国国家标准与技术研究院（NIST）作为国家清单计划的一部分发布了安全基准列表（[https://ncp.nist.gov/repository](https://ncp.nist.gov/repository)）。这本书的审稿人也推荐了美国国防部发布的《安全技术实施指南》（STIGs），包括技术测试和配置标准。
- en: Note Yes, I am missing many tools or standards in this section. The standards
    I included apply to the United States and not necessarily worldwide. By the time
    you read this, policy engines will have changed features, integrations, or open
    source status, and the industry or regulatory standards will have updated drafts.
    If you’d like to recommend one, please let me know at [https://github.com/joatmon08/tdd-infrastructure](https://github.com/joatmon08/tdd-infrastructure).
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：是的，我在这一节中遗漏了许多工具或标准。我包括的标准适用于美国，但不一定适用于全球。在你阅读这段文字的时候，策略引擎可能已经改变了功能、集成或开源状态，行业或监管标准也可能已经更新了草案。如果你想推荐一个，请通过[https://github.com/joatmon08/tdd-infrastructure](https://github.com/joatmon08/tdd-infrastructure)告诉我。
- en: 8.3.2 Security tests
  id: totrans-129
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.3.2 安全测试
- en: What should you test to secure your infrastructure? Some policy as code tools
    offer opinionated defaults that capture best practices for a secure system. However,
    you might need to write your own for your company’s specific platforms and infrastructure.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该测试什么来确保你的基础设施安全？一些策略即代码工具提供了有见地的默认设置，这些设置捕获了安全系统的最佳实践。然而，你可能需要为你公司的特定平台和基础设施编写自己的设置。
- en: Let’s start fixing your database security breach. Fortunately, the testing data
    did not have anything important. However, in the future, you don’t want your teammate
    copying and deploying the configuration to production. To prevent the testing
    environment’s IaC from deploying to production, you write a test to secure a network
    for a database.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从修复你的数据库安全漏洞开始。幸运的是，测试数据中没有重要信息。然而，在未来，你不想你的队友复制并部署配置到生产环境中。为了防止测试环境的IaC（基础设施即代码）部署到生产环境，你编写了一个测试来为数据库安全网络。
- en: The database needs a very restrictive, least-privilege (minimum access) firewall
    rule. Figure 8.5 shows how you implement a test to retrieve the firewall configuration
    from IaC. The configuration goes to a test, which parses the source range from
    the firewall rule. If the range contains a permissive rule, `0.0.0.0/0`, the test
    fails.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 数据库需要一个非常严格的、最小权限（最小访问）防火墙规则。图8.5展示了如何实现一个测试来从IaC中检索防火墙配置。配置传递给一个测试，该测试解析防火墙规则中的源范围。如果该范围包含一个允许规则，`0.0.0.0/0`，则测试失败。
- en: '![](../../OEBPS/Images/CH08_F05_Wang.png)'
  id: totrans-133
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH08_F05_Wang.png)'
- en: Figure 8.5 Retrieve the source range value from the firewall rule configuration
    and determine if it contains an overly permissive range.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.5 从防火墙规则配置中检索源地址范围值并确定是否包含过于宽泛的范围。
- en: GCP uses `0.0.0.0/0` to denote that any IP address can access the database.
    If someone gains access to your network, they can access your database if they
    have the username and password. Your new test fails before an overly permissive
    rule like `0.0.0.0/0` goes to production.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: GCP 使用 `0.0.0.0/0` 来表示任何 IP 地址都可以访问数据库。如果有人访问了你的网络，并且他们有用户名和密码，他们就可以访问你的数据库。你的新测试在过于宽泛的规则
    `0.0.0.0/0` 进入生产之前就会失败。
- en: Listing 8.3 implements the test for the firewall rule in Python. In your test,
    you implement code to open the JSON configuration file, retrieve the `source_ranges`
    list, and check if the list contains `0.0.0.0/0`.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.3 使用 Python 实现了防火墙规则的测试。在你的测试中，你实现代码以打开 JSON 配置文件，检索 `source_ranges` 列表，并检查列表中是否包含
    `0.0.0.0/0`。
- en: Listing 8.3 Using a test to parse the firewall rule for `0.0.0.0`
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 8.3 使用测试解析 `0.0.0.0` 的防火墙规则
- en: '[PRE2]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: ❶ Loads the infrastructure configuration from a JSON file
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 从 JSON 文件加载基础设施配置
- en: ❷ Parses the resource block out of the JSON configuration file
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 从 JSON 配置文件中解析资源块
- en: ❸ Parses the Google compute firewall resource defined by Terraform from the
    JSON configuration
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 从 JSON 配置中解析 Terraform 定义的 Google 计算防火墙资源
- en: ❹ Uses a descriptive test name explaining the policy for the firewall rule,
    which should not allow all traffic
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 使用描述性的测试名称解释防火墙规则的政策，该规则不应允许所有流量
- en: ❺ Checks that 0.0.0.0/0, or allow all, is not defined in the rule’s source ranges
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 检查规则源地址范围中是否定义了 `0.0.0.0/0` 或允许所有流量
- en: ❻ Uses a descriptive error message describing how to correct the firewall rule,
    such as removing 0.0.0.0/0 from source ranges
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 使用描述性的错误消息描述如何更正防火墙规则，例如从源地址范围中删除 0.0.0.0/0
- en: AWS and Azure equivalents
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 的等效选项
- en: A firewall rule in GCP is equivalent to an AWS security group ([http://mng.bz/Qvvm](http://mng.bz/Qvvm))
    or Azure network security group ([http://mng.bz/XZZY](http://mng.bz/XZZY)). To
    update the code, create a security group resource in the cloud provider of your
    choice. Then, edit the test to switch GCP’s `source_ranges` with the `security_rule.source_port_range`
    attribute for Azure or `ingress.cidr_blocks` attribute for AWS.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: GCP 中的防火墙规则相当于 AWS 安全组 ([http://mng.bz/Qvvm](http://mng.bz/Qvvm)) 或 Azure 网络安全组
    ([http://mng.bz/XZZY](http://mng.bz/XZZY))。要更新代码，在您选择的云服务提供商中创建安全组资源。然后，编辑测试以将
    GCP 的 `source_ranges` 与 Azure 的 `security_rule.source_port_range` 属性或 AWS 的 `ingress.cidr_blocks`
    属性进行切换。
- en: 'Imagine your new teammate wants to run some tests on the database from their
    laptop. They make a change to open the firewall rule to `0.0.0.0/0` in IaC. The
    pipeline runs the Python code to generate JSON:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 想象一下你的新队友想要从他们的笔记本电脑上对数据库进行一些测试。他们在 IaC 中更改了防火墙规则，将其设置为 `0.0.0.0/0`。管道运行 Python
    代码以生成 JSON：
- en: '[PRE3]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'The pipeline runs unit tests checking the JSON file with the configuration.
    It recognizes the firewall rule contains `0.0.0.0/0` in the list of allowed source
    ranges and throws an error:'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 管道运行单元测试，检查配置的 JSON 文件。它识别到防火墙规则在允许的源地址范围列表中包含 `0.0.0.0/0` 并抛出错误：
- en: '[PRE4]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Your teammate reads the error description and realizes that the firewall rule
    should not allow all traffic. They can correct their configuration to add their
    laptop IP address to source ranges.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 你的队友阅读了错误描述，并意识到防火墙规则不应该允许所有流量。他们可以更正他们的配置，将他们的笔记本电脑 IP 地址添加到源地址范围中。
- en: Just like functional tests in chapter 6, security tests *educate* the rest of
    your team on ideal secure practices for infrastructure. While the tests do not
    necessarily catch all security violations, they communicate important information
    about security expectations. Moving the *unknown knowns* of security best practices
    to *known knowns* eliminates a repeated mistake.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 就像第 6 章中的功能测试一样，安全测试 *教育* 你的团队了解基础设施的理想安全实践。虽然测试不一定能够捕获所有安全违规，但它们传达了关于安全期望的重要信息。将安全最佳实践的
    *未知已知* 转变为 *已知已知* 消除了重复的错误。
- en: These tests also help scale security practices in your organization. Your teammate
    feels empowered to correct the configuration. Furthermore, your security team
    has fewer investigations and follow-ups for security violations. Making security
    part of everyone’s responsibility reduces the time and effort for future remediation.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 这些测试也有助于扩大你组织中的安全实践。你的队友感到有力量更正配置。此外，你的安全团队对安全违规的调查和跟进更少。将安全作为每个人的责任可以减少未来补救的时间和精力。
- en: Positive versus negative testing
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 正测试与负测试对比
- en: In the example of the database IP address range, you checked that an IP address
    range does not match every IP address (0.0.0.0/0). Called negative testing, this
    process asserts that the value does not match. You can also use positive testing
    to assert that attributes do match an expected value.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 在数据库IP地址范围的示例中，您检查了一个IP地址范围不匹配每个IP地址（0.0.0.0/0）。这被称为负测试，这个过程断言该值不匹配。您还可以使用正测试来断言属性确实与预期值匹配。
- en: Some references suggest that you express all security or policy tests with one
    type. However, I usually write tests with both positive and negative testing assertions.
    The combination better expresses the intent of the security and policy requirement.
    For example, you can use the negative test to check for any IP address range against
    *any* infrastructure configuration written by any team. On the other hand, if
    you have an IP address range that every firewall rule must include, such as a
    VPN connection, you can use a positive test.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 一些参考资料建议您使用一种类型来表达所有安全或策略测试。然而，我通常使用正负测试断言来编写测试。这种组合更好地表达了安全和策略要求的目的。例如，您可以使用负测试来检查任何IP地址范围是否与任何团队编写的任何基础设施配置匹配。另一方面，如果您有一个每个防火墙规则都必须包含的IP地址范围，例如VPN连接，您可以使用正测试。
- en: 'You can write tests to check other secure configurations, including these:'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以编写测试来检查其他安全配置，包括以下内容：
- en: Ports, IP ranges, or protocols on other network policies
  id: totrans-158
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 其他网络策略上的端口、IP范围或协议
- en: Access control for no administrative or root access of infrastructure resources,
    servers, or containers
  id: totrans-159
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对基础设施资源、服务器或容器无管理或root访问的访问控制
- en: Metadata configuration to mitigate exploitation of instance metadata
  id: totrans-160
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 缓解实例元数据被滥用的元数据配置
- en: Access and audit logging configuration for security information and event management
    (SIEM), such as for load balancers, IAM, or storage buckets
  id: totrans-161
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安全信息和事件管理（SIEM）的访问和审计日志配置，例如用于负载均衡器、IAM或存储桶
- en: Package or configuration versions for fixed vulnerabilities
  id: totrans-162
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用于修复漏洞的软件包或配置版本
- en: This non-exhaustive list covers some general configurations. However, you should
    consult with your security team or other industry benchmarks for additional information
    and tests.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 这个非详尽的列表涵盖了某些一般配置。然而，您应咨询您的安全团队或其他行业标准以获取更多信息并进行测试。
- en: 8.3.3 Policy tests
  id: totrans-164
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.3.3 策略测试
- en: Security tests verify that you minimize the attack surface of misconfiguration
    in your IaC. However, you need other tests for auditing, reporting, billing, and
    troubleshooting. For example, your testing database should have a tag on it so
    someone can identify its owner and report the security breach.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 安全测试验证您最小化了IaC中配置错误的攻击面。然而，您还需要其他测试来进行审计、报告、计费和故障排除。例如，您的测试数据库应该有一个标签，以便有人可以识别其所有者并报告安全漏洞。
- en: The uDress compliance team reminds you to add tags to your GCP database so they
    can identify the database owner. They also notify you that the security breach
    caused the database resources to scale, which increased your cloud computing bill.
    Without tags, the compliance team had a difficult time identifying who to contact
    about the security problem and the increased bill.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: uDress合规团队提醒您为您的GCP数据库添加标签，以便他们可以识别数据库所有者。他们还通知您，安全漏洞导致数据库资源扩展，这增加了您的云计算账单。没有标签，合规团队很难确定联系谁以解决安全问题以及增加的账单。
- en: You add tags to the database configuration. To remind yourself of tagging in
    the future, you use the workflow shown in figure 8.6 to implement a unit test
    to check for tags. As with the security test for the firewall rule configuration,
    you parse a JSON file with the database configuration to check that you correctly
    filled the labels with tags. If the test has empty labels, the test fails.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 您将标签添加到数据库配置中。为了在将来提醒自己进行标签操作，您使用图8.6所示的流程来实现一个单元测试来检查标签。与防火墙规则配置的安全测试一样，您解析包含数据库配置的JSON文件，以检查您是否正确地用标签填充了标签。如果测试中有空标签，则测试失败。
- en: '![](../../OEBPS/Images/CH08_F06_Wang.png)'
  id: totrans-168
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH08_F06_Wang.png)'
- en: Figure 8.6 You implement a test that parses the database configuration and checks
    for a list of tags in the database’s user labels.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.6 您实现了一个测试，用于解析数据库配置并检查数据库用户标签中的标签列表。
- en: The policy test behaves similarly to the security test. However, it tests the
    tags instead of the IP source ranges. While the policy does not better secure
    the infrastructure, it improves your ability to troubleshoot and identify resources.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 策略测试的行为与安全测试相似。然而，它测试的是标签而不是IP源范围。虽然策略并不能更好地保护基础设施，但它提高了你排查问题和识别资源的能力。
- en: Let’s implement the test workflow. In the following listing, you write a test
    to check that you have more than zero tags under the GCP `user_labels` parameter.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们实现测试工作流程。在下面的列表中，你编写一个测试来检查GCP `user_labels`参数下是否有超过零个标签。
- en: Listing 8.4 Using a test to parse the database configuration for tags
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 列表8.4 使用测试解析数据库配置以获取标签
- en: '[PRE5]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: ❶ Loads the infrastructure configuration from a JSON file
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 从JSON文件加载基础设施配置
- en: ❷ Parses the resource block out of the JSON configuration file
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 从JSON配置文件中解析资源块
- en: ❸ Parses user labels in the Google SQL database instance defined by Terraform
    from the JSON configurations
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 从Terraform定义的JSON配置中解析Google SQL数据库实例中的用户标签
- en: ❹ Uses a descriptive test name explaining the policy for tagging the database
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 使用描述性的测试名称解释数据库标签策略
- en: ❺ Checks that the user labels on the database do not have an empty list or null
    value
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 检查数据库上的用户标签列表不为空或为null值
- en: ❻ Uses a descriptive error message describing the addition of tags to GCP user
    labels
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 使用描述性的错误信息描述向GCP用户标签添加标签
- en: AWS and Azure equivalents
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure的等效项
- en: To convert listing 8.4 to AWS or Azure, change the Google SQL database instance
    to a PostgreSQL offering from either cloud. You can use AWS RDS ([http://mng.bz/yvvJ](http://mng.bz/yvvJ))
    or Azure Database for PostgreSQL ([http://mng.bz/M552](http://mng.bz/M552)). Then,
    parse the database instance resource for the `tags` attribute. Both Azure and
    AWS use tags.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 要将列表8.4转换为AWS或Azure，将Google SQL数据库实例更改为来自任一云的PostgreSQL服务。你可以使用AWS RDS ([http://mng.bz/yvvJ](http://mng.bz/yvvJ))
    或Azure Database for PostgreSQL ([http://mng.bz/M552](http://mng.bz/M552))。然后，解析数据库实例资源中的`tags`属性。Azure和AWS都使用标签。
- en: 'You add the test to your security tests. The next time your teammate makes
    a change and forgets tags, the test fails. Your teammate reads the error message
    and corrects their IaC to include the tags. You can implement tests for other
    organizational policies, including these:'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 你将测试添加到你的安全测试中。下次你的队友进行更改并忘记添加标签时，测试将失败。你的队友阅读错误信息并纠正他们的IaC以包含标签。你可以为其他组织策略实施测试，包括以下这些：
- en: Required tags for all resources
  id: totrans-183
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 所有资源所需标签
- en: Number of approvers for a change
  id: totrans-184
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 变更的审批人数
- en: The geographic location of an infrastructure resource
  id: totrans-185
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 基础设施资源的地理位置
- en: Log outputs and target servers for auditing
  id: totrans-186
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 审计日志输出和目标服务器
- en: Separate development data from production data
  id: totrans-187
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将开发数据与生产数据分开
- en: This non-exhaustive list covers some general configurations. However, you should
    consult with your compliance team or other industry benchmarks for additional
    information and tests. As you write your tests, ensure that you include clear
    error messages outlining which policies the test checks.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 这个非详尽的列表涵盖了某些通用配置。然而，你应该咨询你的合规团队或其他行业标准以获取更多信息并进行测试。在你编写测试时，确保你包括清晰的错误信息，说明测试检查了哪些策略。
- en: 8.3.4 Practices and patterns
  id: totrans-189
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 8.3.4 实践和模式
- en: As you write more security and policy tests, you gain confidence that your configuration
    remains secure and compliant. How can you teach this across your team and company?
    You can apply some of the practices and patterns for testing to checking infrastructure
    security and compliance. Next, I’ll cover the practices and patterns for writing
    security and policy tests in greater detail.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 随着你编写更多的安全和策略测试，你将更有信心你的配置保持安全和合规。你如何在整个团队和公司中传授这些知识？你可以将一些测试的实践和模式应用于检查基础设施安全和合规性。接下来，我将更详细地介绍编写安全和策略测试的实践和模式。
- en: Use detailed test names and error messages
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 使用详细的测试名称和错误信息
- en: You’ll notice *detailed* *test names and error messages* for the uDress policy
    and security tests. These names and messages seem verbose but communicate to teammates
    precisely what the policy looks for and how they should correct it! I introduced
    a technique in chapter 2 to verify the quality of your naming and code. Try asking
    someone else to read the test. If they can understand its purpose, they can update
    their configuration to conform to the policy as code.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 你会注意到uDress策略和安全测试的*详细*测试名称和错误消息。这些名称和消息看起来冗长，但精确地传达给队友策略寻找的内容以及他们应该如何纠正它！我在第二章介绍了一种技术来验证你的命名和代码的质量。试着让其他人阅读测试。如果他们能理解其目的，他们就可以更新他们的配置以符合策略作为代码。
- en: Modularize tests
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 模块化测试
- en: You can apply some of the *module patterns* from chapter 3 to policy as code.
    For example, the uDress payments team asks to borrow your security and policy
    tests for their infrastructure. You divide your database policies into `database-tests`,
    and firewall policies into `firewall-tests`.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以将第三章中的一些*模块模式*应用到策略作为代码中。例如，uDress支付团队要求借用你的安全和策略测试来测试他们的基础设施。你将你的数据库策略划分为`database-tests`，并将防火墙策略划分为`firewall-tests`。
- en: The security team also asks you to add a Center for Internet Security (CIS)
    benchmark. This industry benchmark includes tests to verify the best practices
    for secure configuration on GCP. After adding the security benchmark, you realize
    that you have too many tests to track in multiple repositories.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 安全团队还要求你添加一个互联网安全中心（CIS）基准。这个行业标准基准包括验证GCP上安全配置最佳实践的测试。在添加安全基准后，你意识到你在多个仓库中有太多测试需要跟踪。
- en: Figure 8.7 moves all of these tests into a repository named `gcp-security-test`.
    The repository organizes all tests for uDress’s GCP infrastructure. The uDress
    frontend and payments teams can reference a shared repository, import the tests,
    and run them against their configuration. Meanwhile, the security team can update
    the security benchmarks in one place in the `gcp-security-tests` repository.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.7 将所有这些测试移动到一个名为`gcp-security-test`的仓库中。该仓库组织了uDress的GCP基础设施的所有测试。uDress的前端和支付团队可以参考共享仓库，导入测试，并针对他们的配置运行它们。同时，安全团队可以在`gcp-security-tests`仓库的一个地方更新安全基准。
- en: '![](../../OEBPS/Images/CH08_F07_Wang.png)'
  id: totrans-197
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH08_F07_Wang.png)'
- en: Figure 8.7 Add policy as code to a shared repository for distribution across
    all teams creating infrastructure.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.7 将策略作为代码添加到共享仓库，以便所有创建基础设施的团队进行分发。
- en: As with your infrastructure approach to code repository structures, you can
    choose to put your organization’s policy as code in a single repository or divide
    it across multiple repositories based on the environment. In either structure,
    make sure all teams have visibility into security and policy tests for the organization
    to learn how to deploy compliant infrastructure.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 就像你的基础设施方法到代码仓库结构一样，你可以选择将组织的策略作为代码放在单个仓库中，或者根据环境将其分散到多个仓库中。在任何结构中，确保所有团队都能看到组织的安全和策略测试，以便学习如何部署符合规定的基础设施。
- en: Furthermore, divide the tests based on business unit, function, environment,
    infrastructure provider, infrastructure resource, stack, or benchmark. You want
    to evolve the types of tests individually as your business changes. Some business
    units may need one type of test, while another may not. Dividing the tests and
    running them selectively helps.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，根据业务单元、功能、环境、基础设施提供商、基础设施资源、堆栈或基准来划分测试。你希望随着业务的变化单独发展测试类型。某些业务单元可能需要一种类型的测试，而另一种则不需要。划分测试并选择性运行有助于。
- en: Add policy as code to delivery pipelines
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 将策略作为代码添加到交付管道中
- en: Your team wants to make sure to run the security and policy tests before pushing
    to production, so they add them as a *stage of their delivery pipeline*. Policy
    as code runs *after* deploying the changes to a testing environment but *before*
    releasing to production. You get fast feedback on infrastructure changes, prioritizing
    functionality but checking policy before production.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 你的团队想要确保在推送到生产之前运行安全和策略测试，因此他们将它们添加为交付管道的*一个阶段*。策略作为代码在将更改部署到测试环境后运行，但在发布到生产之前。你可以快速获得关于基础设施更改的反馈，优先考虑功能，但在生产之前检查策略。
- en: The security team also adds policy as code to scan the *running* production
    environment. This dynamic analysis continuously verifies the security and compliance
    of any emergency or break-glass changes to infrastructure.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 安全团队还将策略作为代码添加到扫描*运行中*的生产环境。这种动态分析持续验证对基础设施的任何紧急或破窗更改的安全性和合规性。
- en: Figure 8.8 shows the workflow of static analysis in a delivery pipeline and
    dynamic analysis of running infrastructure to check configuration changes and
    address issues in resources proactively. After deploying the changes to a testing
    environment, you run the security and policy tests. They should pass before releasing
    the changes to production. When the resources get the changes, you scan the running
    infrastructure with similar tests for runtime security and policy checks.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.8显示了交付管道中静态分析的工作流程和运行基础设施的动态分析，以检查配置更改并主动解决资源问题。在将更改部署到测试环境后，你运行安全和策略测试。在将更改发布到生产之前，它们应该通过测试。当资源获得更改时，你使用类似的测试扫描运行中的基础设施，以进行运行时安全和策略检查。
- en: '![](../../OEBPS/Images/CH08_F08_Wang.png)'
  id: totrans-205
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH08_F08_Wang.png)'
- en: Figure 8.8 Tests for security and policy check for improper infrastructure configuration
    and prevent the changes from going to production.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.8 对安全和策略检查进行测试，以防止不正确的基础设施配置更改并阻止更改进入生产。
- en: You may have different tests for static and dynamic analysis. Some tests, such
    as live verification of endpoint access, can work on only running infrastructure.
    As a result, you want to run some tests *before* and *after* you push to production.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能需要对静态分析和动态分析进行不同的测试。一些测试，例如端点访问的实时验证，只能在运行的基础设施上工作。因此，你希望在推送到生产之前和之后运行一些测试。
- en: If your static analysis tests take too long, you could run a subset of tests
    after you push the change to production. However, you will have to quickly remediate
    any security or compliance violations. As a result, I recommend running the most
    critical security and policy tests as part of your pipeline.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的静态分析测试花费时间过长，你可以在将更改推送到生产后运行测试子集。然而，你必须迅速解决任何安全和合规违规问题。因此，我建议将最关键的安全和策略测试作为你管道的一部分运行。
- en: Image building
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 图像构建
- en: You might encounter the practice of building immutable server or container images.
    By baking the packages you want into a server or container image, you can create
    new servers with updates without the problems of in-place updates.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会遇到构建不可变服务器或容器镜像的做法。通过将你想要的软件包烘焙到服务器或容器镜像中，你可以创建带有更新的新服务器，而不会遇到就地更新的问题。
- en: Use the same workflow of the infrastructure pipeline with policy as code to
    build the immutable images. The workflow includes unit tests to check the scripts
    for specific installation requirements, such as a company package registry, and
    integration tests against a test server to verify that the package versions comply
    with policy and security.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 使用策略代码的基础设施管道的相同工作流程来构建不可变镜像。该工作流程包括单元测试，用于检查特定安装要求（如公司软件包注册表）的脚本，以及针对测试服务器的集成测试，以验证软件包版本符合策略和安全要求。
- en: You can always use dynamic analysis in the form of an agent to scan a server
    and make sure its configuration complies with rules. For example, Sysdig offers
    Falco, a runtime security tool that runs on a server and checks for rule compliance.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 你始终可以使用动态分析的形式，例如代理，扫描服务器并确保其配置符合规则。例如，Sysdig提供Falco，这是一个在服务器上运行的运行时安全工具，用于检查规则合规性。
- en: Most teams *do not* want their security or policy tests to block all changes
    from going to production. For example, what if customers need to access public
    endpoints for infrastructure? The test to check for a private network only may
    not apply. Sometimes you find exceptions in your security policy.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数团队*不*希望他们的安全或策略测试阻止所有更改进入生产环境。例如，如果客户需要访问基础设施的公共端点怎么办？仅检查私有网络的测试可能不适用。有时你会在你的安全策略中找到例外。
- en: Define enforcement levels
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 定义执行级别
- en: As you build more policy as code, you must identify the most important ones
    and make exceptions for others. For example, the uDress security team identifies
    the database tagging policy to be hard mandatory. The delivery pipeline *must
    fail* if it does not find tags, and someone must add the tags.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 随着你构建越来越多的策略代码，你必须确定最重要的那些，并对其他策略进行例外处理。例如，uDress安全团队将数据库标记策略确定为强制执行。如果交付管道找不到标记，它必须*失败*，并且有人必须添加标记。
- en: You define three categories of policy, as shown in figure 8.9\. The security
    team mandates that you fix the database tags before pushing to production. However,
    the team makes an exception for your firewall rule because customers need access
    to your endpoint. The team also includes some advice on more secure infrastructure
    configurations.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 您定义了如图8.9所示的三个政策类别。安全团队要求您在生产之前修复数据库标签。然而，团队对您的防火墙规则做了例外，因为客户需要访问您的端点。团队还包括一些关于更安全的基础设施配置的建议。
- en: '![](../../OEBPS/Images/CH08_F09_Wang.png)'
  id: totrans-217
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH08_F09_Wang.png)'
- en: Figure 8.9 You can divide policy as code into three enforcement categories that
    gate changes before production.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.9 您可以将政策作为代码分为三个强制执行类别，以在生产之前阻止更改。
- en: 'I classify policy as code into three categories of enforcement (borrowed from
    HashiCorp Sentinel’s terminology):'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 我将政策作为代码分为三个强制执行类别（借鉴自HashiCorp Sentinel的术语）：
- en: '*Hard mandatory* for required policies'
  id: totrans-220
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*强制执行* 对于必需的政策'
- en: '*Soft mandatory* for policies that may require manual analysis for an exception'
  id: totrans-221
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*软强制* 对于可能需要手动分析以处理例外的政策'
- en: '*Advisory* for knowledge-sharing of best practices'
  id: totrans-222
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*建议* 用于最佳实践的知识共享'
- en: The security team classifies the firewall rule as a soft mandatory. Some public
    load balancers must allow access from 0.0.0.0/0\. If the firewall rule test fails,
    someone from the security team must review the rule and manually approve the change
    to production in the pipeline.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 安全团队将防火墙规则归类为*软强制*。一些公共负载均衡器必须允许从0.0.0.0/0访问。如果防火墙规则测试失败，安全团队中的人必须审查该规则，并手动批准更改进入生产流程。
- en: The security team sets the CIS benchmarks as `advisory` for knowledge sharing
    and best practices. They ask you to correct the configuration, if possible, but
    they do not require enforcement before production.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 安全团队将CIS基准作为知识共享和最佳实践的*建议*。他们要求您尽可能纠正配置，但他们在生产之前不要求强制执行。
- en: Do you have to run security tests before changes go to production? They take
    a while to run, after all! If you worry that security and policy tests will gate
    the changes too long, run the *hard mandatory* tests before deploying to production.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 在更改进入生产之前，您必须运行安全测试吗？毕竟，它们需要一段时间才能运行！如果您担心安全和政策测试会阻碍更改太长时间，请在部署到生产之前运行*强制执行*测试。
- en: You can run the soft mandatory or advisory tests asynchronously, so only the
    necessary tests block your pipeline. I *do not* recommend running *all* security
    and policy tests asynchronously because you may temporarily introduce a noncompliant
    configuration to production, even if you fix it quickly after running asynchronous
    tests!
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以异步运行软强制或建议测试，因此只有必要的测试会阻塞您的管道。我不建议异步运行*所有*安全和政策测试，因为您可能会在生产中临时引入一个不符合规定的配置，即使您在异步测试后快速修复它！
- en: Figure 8.10 summarizes testing patterns and practices, such as writing detailed
    test names and error messages. Similar to infrastructure, you can modularize tests
    based on function and add tests to delivery pipelines for production.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.10总结了测试模式和最佳实践，例如编写详细的测试名称和错误消息。类似于基础设施，您可以根据功能模块化测试，并将测试添加到生产交付管道中。
- en: '![](../../OEBPS/Images/CH08_F10_Wang.png)'
  id: totrans-228
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH08_F10_Wang.png)'
- en: Figure 8.10 Tests for security and policy check for improper infrastructure
    configuration and prevent the changes from going to production.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.10 测试安全性和检查不恰当的基础设施配置，以防止更改进入生产环境。
- en: No matter the tool, security benchmark, or policy rules, you should express
    and communicate the practices in the form of tests. Following these patterns and
    practices will help you and your teammates improve your security and compliance
    knowledge.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 无论工具、安全基准或政策规则如何，您都应该以测试的形式表达和传达实践。遵循这些模式和最佳实践将帮助您和您的队友提高安全和合规知识。
- en: As your organization grows and sets more policies, you expand your security
    and policy tests with it. Early adoption of policy as code sets a foundation for
    baking security and compliance practices into your IaC. If you cannot find a tool
    to run the tests you need, consider writing your own tests to parse IaC.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 随着您的组织成长并制定更多政策，您也会相应地扩展您的安全和政策测试。早期采用政策作为代码为将安全和合规实践融入您的IaC奠定基础。如果您找不到运行所需测试的工具，可以考虑编写自己的测试来解析IaC。
- en: Summary
  id: totrans-232
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: A company policy ensures that systems comply with security, audit, and organizational
    requirements. Your company defines policies based on industry, country, and other
    factors.
  id: totrans-233
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 公司政策确保系统符合安全、审计和组织要求。您的公司根据行业、国家和其他因素制定政策。
- en: The principle of least privilege gives a user or service account only the minimum
    access they require.
  id: totrans-234
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最小权限原则只授予用户或服务账户他们所需的最小访问权限。
- en: Ensure that your IaC uses credentials with least privilege access to the infrastructure
    provider. Least privilege prevents someone from exploiting the credentials and
    creating unauthorized resources in your environment.
  id: totrans-235
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 确保你的基础设施即代码（IaC）使用具有最小权限访问基础设施提供者的凭证。最小权限可以防止有人利用凭证在你的环境中创建未经授权的资源。
- en: Use a tool to suppress or redact plaintext, sensitive information in a delivery
    pipeline.
  id: totrans-236
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用工具来抑制或编辑交付管道中的明文、敏感信息。
- en: Rotate any usernames or passwords generated by IaC after applying it in the
    pipeline.
  id: totrans-237
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在管道中应用基础设施即代码后，旋转任何由基础设施即代码生成的用户名或密码。
- en: Tagging infrastructure with service, owner, email, accounting information, environment,
    and automation details makes it easier to identify and audit security and billing.
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用服务、所有者、电子邮件、会计信息、环境和自动化细节对基础设施进行标记，使其更容易识别和审计安全和计费。
- en: Policy as code tests some infrastructure metadata and verifies that it complies
    with a secure or compliant configuration.
  id: totrans-239
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 策略即代码测试一些基础设施元数据，并验证其是否符合安全或合规的配置。
- en: Use policy as code to test the security and compliance of your infrastructure
    before pushing to production but after functional testing of your system.
  id: totrans-240
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在将系统功能测试后但推送至生产之前，使用策略即代码来测试你基础设施的安全性和合规性。
- en: Apply clean IaC and module patterns to managing and scaling policy as code.
  id: totrans-241
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 应用清洁的基础设施即代码和模块模式来管理和扩展策略即代码。
- en: Classify each security and policy test into one of three enforcement categories,
    such as hard mandatory (must fix), soft mandatory (manual review), and advisory
    (best practice, but not blocking production).
  id: totrans-242
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将每个安全和策略测试分类到三个执行类别之一，例如强制性的（必须修复）、软性强制性的（手动审查）和咨询性的（最佳实践，但不会阻止生产）。
