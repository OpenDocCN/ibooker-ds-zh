- en: Chapter 11\. Django revisited!
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第11章。再次回顾Django！
- en: '|  |'
  id: totrans-1
  prefs: []
  type: TYPE_TB
  zh: '|  |'
- en: '**This chapter covers**'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: '**本章涵盖**'
- en: '*Adding authentication*'
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*添加认证*'
- en: '*Unit-testing and functional-testing applications*'
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*单元测试和功能测试应用程序*'
- en: '*Updating the database when models change*'
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*更新模型更改时的数据库*'
- en: '*Serving static images and CSS style sheets*'
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*服务静态图像和CSS样式表*'
- en: '|  |'
  id: totrans-7
  prefs: []
  type: TYPE_TB
  zh: '|  |'
- en: In [Chapter 8](kindle_split_016.html#ch08), you built a simple todo list with
    Django, which allowed you to keep track of tasks you needed to do. Although useful
    for you, it’s not helpful to other people. In this chapter, we’ll look at some
    of the polishing steps you need to take to make your Django application useful
    to others. Let’s get started!
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 在 [第8章](kindle_split_016.html#ch08) 中，您使用Django构建了一个简单的待办事项列表，这允许您跟踪您需要完成的任务。虽然这对您很有用，但对其他人来说并不有帮助。在本章中，我们将探讨您需要采取的一些润色步骤，以使您的Django应用程序对其他人有用。让我们开始吧！
- en: Authentication
  id: totrans-9
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 认证
- en: 'Your application was pretty much finished from a functionality point of view—you
    can delete and change any of your todos, and add as many as you like. Here’s the
    problem: so can anyone else, if that person has access to your web interface.
    If that person is malicious, then all your todos might be deleted, or your important
    ones could be tampered with.'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 从功能角度来看，您的应用程序几乎已经完成——您可以删除和更改任何待办事项，并且可以添加尽可能多的待办事项。问题是：如果那个人有权访问您的网络界面，那么任何人都可以这样做。如果那个人是恶意的，那么您的所有待办事项都可能被删除，或者您的重要待办事项可能会被篡改。
- en: 'In order for your application to be safe, you’ll need to restrict who can access
    your application, and you shouldn’t be able to tamper with anyone else’s todos.
    In practice, this means you’ll introduce the following checks:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确保您的应用程序安全，您需要限制谁可以访问您的应用程序，并且您不应该能够篡改任何人的待办事项。在实践中，这意味着您将引入以下检查：
- en: You should need to log in to the application.
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您需要登录到应用程序。
- en: Once logged in, you should only see your own todo items.
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 登录后，您应该只能看到您自己的待办事项。
- en: Whenever you try to add, change, or delete a todo, it should only work if it’s
    your todo.
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 无论何时您尝试添加、更改或删除待办事项，它都应该仅当它是您的待办事项时才有效。
- en: Once these three constraints are in place, you should be safe against anyone
    trying to fiddle with anyone else’s todo list.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦这三个约束条件就位，您应该能够抵御任何试图篡改他人待办事项的人。
- en: '![](f0359-01.jpg)'
  id: totrans-16
  prefs: []
  type: TYPE_IMG
  zh: '![](f0359-01.jpg)'
- en: Logging in
  id: totrans-17
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 登录
- en: Let’s start with logging in to your application. Django provides a built-in
    application called *auth*, along with middleware to handle sessions and store
    user data. It makes user-based applications such as yours much more straightforward,
    and it’s a lot more robust and secure than creating your own from scratch.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从登录您的应用程序开始。Django提供了一个名为 *auth* 的内置应用程序，以及中间件来处理会话和存储用户数据。这使得像您这样的基于用户的应用程序变得更加简单直接，而且它比从头开始创建自己的要更加健壮和安全。
- en: Listing 11.1\. Django authentication and login views
  id: totrans-19
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表11.1。Django认证和登录视图
- en: '![](ch011list1-0.jpg)'
  id: totrans-20
  prefs: []
  type: TYPE_IMG
  zh: '![](ch011list1-0.jpg)'
- en: '![](ch011list1-1.jpg)'
  id: totrans-21
  prefs: []
  type: TYPE_IMG
  zh: '![](ch011list1-1.jpg)'
- en: You start with the three functions you need to import to use Django’s authentication
    ![](two.jpg).
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 您需要导入Django的认证功能所需的三个函数 ![two.jpg]。
- en: '![](f0360-01.jpg)'
  id: totrans-23
  prefs: []
  type: TYPE_IMG
  zh: '![](f0360-01.jpg)'
- en: 'This view is used in a few different ways: as the initial display of the login
    form and for checking a user-name and password. So that you don’t run into *Key-Error*
    exceptions, you’re setting up the username and password variables ![](three.jpg)
    from the *request.post* dictionary’s *get* method; this way, if those values aren’t
    set in the request, they’ll default to being blank. You also set *error_msg* to
    a blank string.'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 此视图以几种不同的方式使用：作为登录表单的初始显示以及检查用户名和密码。为了防止出现 *Key-Error* 异常，您正在从 *request.post*
    字典的 *get* 方法设置用户名和密码变量 ![three.jpg]；这样，如果这些值在请求中没有设置，它们将默认为空白。您还将 *error_msg*
    设置为空字符串。
- en: If you have a username and password, then someone is trying to log in, and you
    use Django’s *authenticate* function ![](four.jpg) to check them against your
    list of users.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您有用户名和密码，那么有人在尝试登录，您使用Django的 *authenticate* 函数 ![four.jpg] 来检查它们与您的用户列表。
- en: If the username and password check out OK, then *authenticate* will return a
    *User* object. If not, it will return *None*. That’s easy to test for, but the
    other thing you need to look for is where a user has been deactivated. If both
    of those tests pass, then you can log in the user with *login* and redirect to
    the todo index ![](five.jpg).
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 如果用户名和密码检查无误，则 *authenticate* 将返回一个 *User* 对象。如果不正确，它将返回 *None*。这很容易测试，但您还需要查找用户已被停用的情况。如果这两个测试都通过，则可以使用
    *login* 登录用户并重定向到待办事项索引 ![five.jpg]。
- en: If you haven’t been redirected to the index page, you’ll pass through to this
    section, where you redisplay the login page ![](one.jpg). So that you can repopulate
    the form if there’s an error, you pass back the username and password, along with
    any error messages you’ve generated. You’re also using one of Django’s convenience
    functions, *render_to_response*, which will find and render a template directly
    when given the template name and a dictionary of variables.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你没有被重定向到首页，你会通过这个部分，在这里你将重新显示登录页面 ![one.jpg]。这样你就可以在出错时重新填充表单，你将回传用户名和密码，以及你生成的任何错误信息。你还在使用
    Django 的便利函数之一，*render_to_response*，它会在给定模板名称和变量字典时直接查找并渲染模板。
- en: Logging out is even easier—call the *logout* function with the request, and
    it will remove any session data and cookies the user’s been using ![](six.jpg).
    Once you’ve done that, you redirect back to the login page.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 注销甚至更简单——使用请求调用 *logout* 函数，它将删除用户使用过的任何会话数据和cookies ![six.jpg]。一旦这样做，你将重定向回登录页面。
- en: Great—now you only need a template to display the login form. That’s not too
    hard to do. The following listing shows my version, which I put in todos/templates/todo_login.tmpl.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 太好了——现在你只需要一个模板来显示登录表单。这并不难做。以下列表显示了我的版本，我将它放在 todos/templates/todo_login.tmpl
    中。
- en: Listing 11.2\. Login template
  id: totrans-30
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.2\. 登录模板
- en: '![](11list02.jpg)'
  id: totrans-31
  prefs: []
  type: TYPE_IMG
  zh: '![11list02.jpg]'
- en: If you get an error back from the view, you’d like to display it, so ![](one.jpg)
    is a section of template code that does just that. You’ve also added an *error*
    class, which displays the error in red.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你从视图中收到错误，你想显示它，所以 ![one.jpg] 是模板代码的一部分，它正是这样做的。你还添加了一个 *error* 类，它以红色显示错误。
- en: '![](f0362-01.jpg)'
  id: totrans-33
  prefs: []
  type: TYPE_IMG
  zh: '![f0362-01.jpg]'
- en: Other than including the username and password as values, the form is a standard
    username and password login ![](two.jpg). You’re including the username and password
    that are fed in, so if there’s an error, the user doesn’t have to retype everything.
    Little touches like this go a long way toward making your application look professional.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 除了将用户名和密码作为值包含在内，该表单是一个标准的用户名和密码登录 ![two.jpg]。你包含了输入的用户名和密码，所以如果出错，用户不需要重新输入所有内容。这样的小细节可以让你的应用程序看起来更专业。
- en: 'Last but not least, you’ll tell Django about the views so it can display them.
    Here’s the plumbing from urls.py to link everything up—*login* and *logout* go
    straight to the relevant views:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 最后但同样重要的是，你需要告诉 Django 关于视图的信息，以便它可以显示它们。以下是 urls.py 中的管道，用于将一切连接起来——*登录*和*注销*直接跳转到相关视图：
- en: '[PRE0]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Now, if you go to http://localhost:8000/todos/login in your browser, you should
    be able to type in your username and password and have it redirect you to the
    index page. It should also give you a nice red error message if you mistype your
    password or username.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，如果你在浏览器中访问 http://localhost:8000/todos/login，你应该能够输入你的用户名和密码，然后重定向到首页。如果你输入的用户名或密码错误，它也应该给你一个漂亮的红色错误信息。
- en: '|  |'
  id: totrans-38
  prefs: []
  type: TYPE_TB
  zh: '|'
- en: Note
  id: totrans-39
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 注意
- en: If you’d rather not enter users by hand, there’s a Django application called
    django-registration that will let people add their own accounts via email.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你不想手动输入用户，有一个名为 django-registration 的 Django 应用程序可以让人们通过电子邮件添加自己的账户。
- en: '|  |'
  id: totrans-41
  prefs: []
  type: TYPE_TB
  zh: '|'
- en: Adding users
  id: totrans-42
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 添加用户
- en: The other thing you’re probably wondering at this point is how to add new users.
    It’s easy—use Django’s admin screen (http://localhost:8000/admin/) to create some.
    I’m not sure what your friends’ names are; I’ll call my friend “Bruce,” to save
    confusion.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 你此时可能还在想如何添加新用户。这很简单——使用 Django 的管理界面 (http://localhost:8000/admin/) 创建一些。我不确定你朋友的名字是什么；我将我的朋友称为“布鲁斯”，以避免混淆。
- en: Click Users in the admin screen, and you should see something like the first
    screen in [figure 11.1](#ch11fig01). Fill in the username and password, and your
    user will be created. Then, edit the relevant fields. If you look carefully at
    the permissions list, you’ll see that there are permissions for adding, editing,
    and deleting todos. You won’t use them in this application, because they apply
    to every todo, but they’re available if you need them.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 在管理界面中点击“用户”，你应该会看到类似于 [图 11.1](#ch11fig01) 中的第一个屏幕。填写用户名和密码，你的用户将被创建。然后，编辑相关字段。如果你仔细查看权限列表，你会看到有添加、编辑和删除待办事项的权限。你在这个应用程序中不会使用它们，因为它们适用于每个待办事项，但如果你需要，它们是可用的。
- en: Figure 11.1\. Adding a user through Django’s admin screen
  id: totrans-45
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 图 11.1\. 通过 Django 的管理界面添加用户
- en: '![](11fig01_alt.jpg)'
  id: totrans-46
  prefs: []
  type: TYPE_IMG
  zh: '![11fig01_alt.jpg]'
- en: What’s next? Now that you have to log in to your application, let’s make the
    todos a bit more secure.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来是什么？现在你需要在应用程序中登录，让我们让待办事项更加安全。
- en: Listing only your own todos
  id: totrans-48
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 只列出你自己的 todos
- en: Now that your users can log in, you can start making changes to how your application
    displays. Currently, your index page still lists every todo in the database, but
    you’d like it to only show the todos that have been created by the current user.
    Come to think of it, you don’t have any way to tell which todos belong to which
    user. You’d better fix that part before you do anything fancy.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 现在用户可以登录了，你可以开始修改应用程序的显示方式了。目前，你的索引页面仍然列出数据库中的每个 todo，但你希望它只显示由当前用户创建的 todos。再想想，你没有任何方法来确定哪些
    todos 属于哪个用户。你最好在做一些花哨的事情之前先解决这个问题。
- en: To add a link to the owner of a todo, you add a foreign key to the *Todo*
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 要添加一个指向 todo 所有者的链接，你需要在 *Todo* 表中添加一个外键。
- en: '[PRE1]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Don’t forget to import the *User* model from Django as well:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 不要忘记从 Django 导入 *User* 模型：
- en: '[PRE2]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: The problem, though, is that now you can no longer use *python manage.py syncdb*
    to update your database. For safety reasons, Django will only add new tables,
    not tamper with your existing ones. But you have to do something, because Django
    will give you an error if you try to use the todo model, as shown in [figure 11.2](#ch11fig02).
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，问题在于你现在不能再使用 *python manage.py syncdb* 来更新你的数据库了。出于安全考虑，Django 只会添加新表，而不会篡改你现有的表。但你必须做些什么，因为如果你尝试使用
    todo 模型，Django 会给你一个错误，就像[图 11.2](#ch11fig02) 所示。
- en: Figure 11.2\. Your database is broken!
  id: totrans-55
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 图 11.2\. 你的数据库坏了！
- en: '![](11fig02.jpg)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
  zh: '![11fig02.jpg](11fig02.jpg)'
- en: 'Your database and your model are out of sync! You have two choices at this
    point: either remove the todo.db database file and start from scratch, or install
    SQLite and use it to update the existing database.'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 你的数据库和你的模型不同步了！此时你有两个选择：要么删除 todo.db 数据库文件并从头开始，要么安装 SQLite 并使用它来更新现有数据库。
- en: Fixing your database
  id: totrans-58
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 修复你的数据库
- en: You’ll take the second option—although it’s somewhat harder, you’ll need to
    be able to update the database like this once you start working on applications
    where you have existing data. Don’t worry, it’s not too difficult to do once you
    know a few simple commands. If you don’t already have the sqlite3 program installed,
    SQLite is available from [www.sqlite.org](http://www.sqlite.org), and all you
    need to do is put the executable somewhere where your operating system can find
    it. The following listing shows how I updated my database.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 你会选择第二个选项——虽然它有些困难，但一旦你开始处理有现有数据的应用程序，你将需要能够这样更新数据库。别担心，一旦你掌握了几个简单的命令，这并不太难。如果你还没有安装
    sqlite3 程序，SQLite 可以从 [www.sqlite.org](http://www.sqlite.org) 获取，你只需要将可执行文件放在操作系统可以找到的地方。下面的列表显示了我是如何更新我的数据库的。
- en: '![](f0365-01.jpg)'
  id: totrans-60
  prefs: []
  type: TYPE_IMG
  zh: '![f0365-01.jpg](f0365-01.jpg)'
- en: Listing 11.3\. Adding a field to the database backend
  id: totrans-61
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.3\. 向数据库后端添加字段
- en: '![](ch011list3-0.jpg)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
  zh: '![ch011list3-0.jpg](ch011list3-0.jpg)'
- en: '![](ch011list3-1.jpg)'
  id: totrans-63
  prefs: []
  type: TYPE_IMG
  zh: '![ch011list3-1.jpg](ch011list3-1.jpg)'
- en: First, you need to figure out what to add ![](one.jpg).manage.py won’t make
    any changes for you, but it still knows what should be there. *python manage.py
    sql todo* will tell you the exact SQL needed for the database you’re using, which
    beats having to rack your brain trying to create the right SQL command.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，你需要弄清楚要添加什么![one.jpg](one.jpg)。manage.py 不会为你做任何改变，但它仍然知道应该有什么。*python manage.py
    sql todo* 会告诉你使用数据库的确切 SQL 命令，这比试图在脑海中构建正确的 SQL 命令要好。
- en: It pays to know common SQLite commands ![](two.jpg). If you need to find your
    way around the database, *.help*, *.tables*, and *.schema* are three useful commands
    to know.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 了解常见的 SQLite 命令是有好处的![two.jpg](two.jpg)。如果你需要绕过数据库，*.help*、*.tables* 和 *.schema*
    是三个有用的命令。
- en: Next, you issue an *alter table* command, with the SQL syntax cribbed from manage.py
    ![](three.jpg). Unfortunately, SQLite won’t accept it—you’ve told it that the
    field shouldn’t be *NULL*, but you haven’t given it a default either, so SQLite
    won’t know what to do with that field for all your existing todos. To fix the
    *alter* command, you can either drop the *NOT NULL* clause or add a reasonable
    default.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，你发出一个 *alter table* 命令，SQL 语法是从 manage.py 中借鉴的![three.jpg](three.jpg)。不幸的是，SQLite
    不会接受它——你已经告诉它该字段不应该为 *NULL*，但你没有提供默认值，所以 SQLite 不会知道如何处理你现有 todos 的该字段。要修复 *alter*
    命令，你可以要么删除 *NOT NULL* 子句，要么添加一个合理的默认值。
- en: In this case, you make the default be that the existing todos are owned by the
    admin user (with id=1) ![](four.jpg).
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，你让默认情况是现有的 todos 归属于管理员用户（id=1）![four.jpg](four.jpg)。
- en: '|  |'
  id: totrans-68
  prefs: []
  type: TYPE_TB
  zh: '|  |'
- en: Tip
  id: totrans-69
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 小贴士
- en: A Django application called South can automatically alter your database for
    you based on your models.py file. It doesn’t get everything (such as field renames),
    but it can be a lifesaver if you have a complex application.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 一个名为 South 的 Django 应用程序可以根据你的 models.py 文件自动更改你的数据库。它不会得到所有东西（例如字段重命名），但如果你的应用程序复杂，它可能是一个救星。
- en: '|  |'
  id: totrans-71
  prefs: []
  type: TYPE_TB
  zh: '|  |'
- en: Now that you’ve added your owner column and Django knows about it, your application
    is a lot more useful, and you can use the owner field to do all sorts of cool
    stuff. For example, the Django admin system will now let you change the owner
    of a todo with a convenient drop-down menu, as shown in [figure 11.3](#ch11fig03).
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经添加了所有者列，并且 Django 已经知道了它，你的应用程序就更有用了，你可以使用所有者字段来做各种酷的事情。例如，Django 管理系统现在将允许你通过方便的下拉菜单更改待办事项的所有者，如图
    11.3 所示 [图](#ch11fig03)。
- en: Figure 11.3\. Changing the owner of a todo
  id: totrans-73
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 图 11.3\. 更改待办事项的所有者
- en: '![](11fig03_alt.jpg)'
  id: totrans-74
  prefs: []
  type: TYPE_IMG
  zh: '![](11fig03_alt.jpg)'
- en: The Django admin application is good at reading your models and making appropriate
    choices about how to display your data. All it needs is for the right relationships
    to be defined.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: Django 管理应用程序擅长读取你的模型并做出适当的选择来显示你的数据。它只需要定义正确的关系。
- en: Back on track...
  id: totrans-76
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 回到正轨...
- en: Your original plan was to only show todos owned by the person who’s logged in.
    That’s now easy to do—the following listing shows updated *todo_index* and *add_todo*
    views that will filter the todo list you’re shown when you log in.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 你最初计划只显示登录用户的待办事项。现在这很容易做到——下面的列表展示了更新的 *todo_index* 和 *add_todo* 视图，这些视图将过滤你在登录时显示的待办事项列表。
- en: Listing 11.4\. Showing only your todos
  id: totrans-78
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.4\. 只显示你的待办事项
- en: '![](11list04_alt.jpg)'
  id: totrans-79
  prefs: []
  type: TYPE_IMG
  zh: '![](11list04_alt.jpg)'
- en: '![](f0368-01.jpg)'
  id: totrans-80
  prefs: []
  type: TYPE_IMG
  zh: '![](f0368-01.jpg)'
- en: If someone hasn’t logged in, they could still manually type in the index URL,
    or bookmark the index page and forget to log in. That will mess up your application,
    so if they’re anonymous, you redirect them to the login page ![](one.jpg).
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 如果有人没有登录，他们仍然可以手动输入索引 URL，或者将索引页面添加到书签并忘记登录。这将搞乱你的应用程序，所以如果他们是匿名用户，你会将他们重定向到登录页面
    ![](one.jpg)。
- en: Instead of returning all the todos, this database query ![](two.jpg) will return
    those where the user is the same as the one currently logged in.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 而不是返回所有待办事项，这个数据库查询 ![](two.jpg) 将返回那些用户与当前登录的用户相同的待办事项。
- en: In general, once you’ve found a clever new way to do things, it’s a good idea
    to go back and clean up the code you’ve already written. Here’s your old template-calling
    code from [chapter 8](kindle_split_016.html#ch08), but now it uses the new *render_to_response*
    function ![](three.jpg).
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，一旦你找到了一个巧妙的新方法来做事情，回到过去清理你已经编写的代码是个好主意。这是你的旧模板调用代码来自 [第 8 章](kindle_split_016.html#ch08)，但现在它使用了新的
    *render_to_response* 函数 ![](three.jpg)。
- en: The only thing left is to add the owner to all your new todos ![](four.jpg).
    Easy peasy!
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 剩下的唯一事情就是将所有者添加到你的所有新待办事项中 ![](four.jpg)。简单得很！
- en: Now you can view only your todos, and nobody else can see what you’re up to.
    When you create a new todo, it’s linked to your user ID. All you need to do is
    perform the same checking when editing or deleting your todos. They won’t appear
    in the list of todos, but that won’t stop evil people from noticing that your
    todos are referenced by IDs and seeing what happens when they put in a different
    ID. Oops! Just deleted someone else’s todo!
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你可以只查看你的待办事项，其他人无法看到你在忙什么。当你创建一个新的待办事项时，它会链接到你的用户 ID。你所需要做的就是编辑或删除你的待办事项时执行相同的检查。它们不会出现在待办事项列表中，但这不会阻止邪恶的人注意到你的待办事项是通过
    ID 引用的，并看到他们输入不同 ID 时会发生什么。哎呀！刚刚删除了别人的待办事项！
- en: Covering all your bases
  id: totrans-86
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 覆盖所有基础
- en: Here’s where Django’s simplicity comes into play. Your views are just functions
    that are fed certain things depending on the request that comes in, and you can
    use that simplicity to your advantage. Rather than rewrite the entire view—and
    throw away all your work—you can wrap the view with some of your own code to check
    the request, and then pass your values to the generic view if the request is OK.
    The following listing shows you how.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 这就是 Django 简单性的体现。你的视图只是根据传入的请求提供某些东西的函数，你可以利用这种简单性来发挥优势。而不是重写整个视图——丢弃所有你的工作——你可以用一些自己的代码包装视图来检查请求，如果请求是正常的，然后将你的值传递给通用视图。下面的列表展示了如何做到这一点。
- en: Listing 11.5\. Wrapping the update and delete views
  id: totrans-88
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.5\. 包装更新和删除视图
- en: '![](ch011list5-0.jpg)'
  id: totrans-89
  prefs: []
  type: TYPE_IMG
  zh: '![](ch011list5-0.jpg)'
- en: '![](ch011list5-1.jpg)'
  id: totrans-90
  prefs: []
  type: TYPE_IMG
  zh: '![](ch011list5-1.jpg)'
- en: '![](f0369-01.jpg)'
  id: totrans-91
  prefs: []
  type: TYPE_IMG
  zh: '![](f0369-01.jpg)'
- en: '![](one.jpg) are the generic views, but you’re importing them in views.py rather
    than urls.py.'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '![](one.jpg) 是通用视图，但你是在 views.py 而不是 urls.py 中导入它们的。'
- en: You may notice the stub view we looked at earlier in the chapter ![](three.jpg),
    but you’re expanding it. You only need the request and the ID of the todo you’re
    editing.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会注意到我们在本章前面看到的占位符视图 ![three.jpg](#)，但你正在扩展它。你只需要请求和你要编辑的待办事项的 ID。
- en: '*get_object_or_404* is another Django shortcut ![](two.jpg). It tries to access
    the model with that ID, and, if it can’t, it triggers a 404 error.'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: '*get_object_or_404* 是另一个 Django 快捷方式 ![two.jpg](#)。它尝试访问具有该 ID 的模型，如果无法访问，则触发
    404 错误。'
- en: Before you get to the generic view, you want to check that the todo is owned
    by the person trying to edit it ![](four.jpg). If the ID of *todo.owner* doesn’t
    match the one in the request, then you redirect to the index page with an error.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 在你看到通用视图之前，你需要检查待办事项是否由试图编辑它的人拥有 ![four.jpg](#)。如果 *todo.owner* 的 ID 与请求中的 ID
    不匹配，那么你会带着错误信息重定向到索引页面。
- en: If you get here, then the user owns the todo, and you can pass control through
    to the generic view ![](five.jpg). All the same arguments that were in urls.py
    previously are here, but they’re specified as function arguments rather than keys
    and values in a dictionary.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你到了这里，那么用户拥有待办事项，你可以将控制权传递给通用视图 ![five.jpg](#)。这里包含了之前 urls.py 中所有的相同参数，但它们被指定为函数参数，而不是字典中的键值对。
- en: Deleting a todo follows exactly the same steps as updating a todo ![](six.jpg),
    except that the variables passed to the generic view are slightly different.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 删除待办事项的步骤与更新待办事项的步骤完全相同 ![six.jpg](#)，除了传递给通用视图的变量略有不同。
- en: Now you need new URLs to point to your new views. The following listing shows
    a much cleaner version of the previous urls.py.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你需要新的 URL 来指向你的新视图。以下列表显示了之前 urls.py 的一个更简洁版本。
- en: Listing 11.6\. New urls.py
  id: totrans-99
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.6\. 新的 urls.py
- en: '![](11list06_alt.jpg)'
  id: totrans-100
  prefs: []
  type: TYPE_IMG
  zh: '![11list06_alt.jpg](#)'
- en: You should be able to follow these updated URLs easily by now ![](one.jpg).
    *(?P<todo_id>\d+)* matches an ID and feeds it to the view as an argument.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你应该能够轻松地遵循这些更新的 URL ![one.jpg](#)。 *(?P<todo_id>\d+)* 匹配一个 ID，并将其作为参数传递给视图。
- en: You also add an optional forward slash to the editing URL, in case someone adds
    one by hand.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 你还应该在编辑 URL 中添加一个可选的正斜杠，以防有人手动添加。
- en: Updating your interface
  id: totrans-103
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 更新你的界面
- en: The last thing you need to do is update your index page so it can take an optional
    error argument. That’s easy to do, and you’ve already done this for the login
    form, so you can cut and paste it into the relevant sections here.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 你需要做的最后一件事是更新你的索引页面，使其能够接受可选的错误参数。这很容易做到，而且你已经为登录表单做了这件事，所以你可以将其复制粘贴到相关部分。
- en: Listing 11.7\. Error messages on the index page
  id: totrans-105
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.7\. 索引页面上的错误信息
- en: '![](11list07_alt.jpg)'
  id: totrans-106
  prefs: []
  type: TYPE_IMG
  zh: '![11list07_alt.jpg](#)'
- en: The first step is to pass in any error messages from the request into the template
    ![](one.jpg). You’re using a one-liner here that is similar to the way you handle
    usernames and passwords in the login script.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 第一步是将请求中的任何错误信息传递给模板 ![one.jpg](#)。这里你使用的是一行代码，其方式与你在登录脚本中处理用户名和密码的方式类似。
- en: '![](f0371-01.jpg)'
  id: totrans-108
  prefs: []
  type: TYPE_IMG
  zh: '![f0371-01.jpg](#)'
- en: Now you can update the template to show a nice red error message if one is set
    in the URL ![](two.jpg).
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你可以更新模板以显示在 URL 中设置的红色错误信息 ![two.jpg](#)。
- en: With that, your application is done! You can look at, add, edit, and delete
    todos from your todo list. Your interface is also limited to only those people
    whom you choose to give a username and password. Additionally, if you go back
    and look through the code you’ve written, you’ll notice it’s nicely broken up—everything
    to do with display is in your templates, your models contain all the data and
    data-formatting functions, and your views handle logins, data extraction, and
    redirecting when something happens.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 有了这些，你的应用程序就完成了！你可以查看、添加、编辑和删除待办事项。你的界面也仅限于你选择给予用户名和密码的人。此外，如果你回顾一下你编写的代码，你会注意到它被很好地分割——与显示相关的一切都在你的模板中，你的模型包含所有数据和数据格式化函数，而你的视图处理登录、数据提取和发生某些情况时的重定向。
- en: Testing!
  id: totrans-111
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 测试！
- en: In your original todo application, you developed it with unit testing, but so
    far you haven’t seen any testing code. You can get away without having any testing
    code while your project is small, but as it grows, it will need some sort of testing
    to keep it in check. Also, Django’s testing infrastructure is cool. Let’s take
    a quick look at how you can test your Django applications.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 在你的原始待办事项应用程序中，你通过单元测试来开发它，但到目前为止，你还没有看到任何测试代码。当你的项目很小的时候，你可以没有测试代码，但随着项目的增长，它将需要某种测试来保持其可控性。此外，Django
    的测试基础设施很酷。让我们快速看一下你如何测试你的 Django 应用程序。
- en: Unit testing
  id: totrans-113
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 单元测试
- en: The first thing you need to know how to do is how to create unit tests to test
    your model. You can also use unit tests for other functions and classes that are
    independent and don’t depend on any other infrastructure. The following listing
    shows how to create unit tests for your application. You should put it in a file
    called tests.py in your application folder.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 你需要知道的第一件事是如何创建单元测试来测试你的模型。你也可以使用单元测试来测试其他独立且不依赖于任何其他基础设施的函数和类。以下列表展示了如何为你的应用程序创建单元测试。你应该将它放在应用程序文件夹中名为
    tests.py 的文件中。
- en: Listing 11.8\. Unit testing (tests.py)
  id: totrans-115
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.8\. 单元测试 (tests.py)
- en: '![](11list08_alt.jpg)'
  id: totrans-116
  prefs: []
  type: TYPE_IMG
  zh: '![图片](11list08_alt.jpg)'
- en: You’re using Django’s *TestCase* class to organize your testing code. It’s mainly
    modeled on the xUnit style of testing, although it’s possible to use doctests
    with Django, too. Your *Todo* class needs to link to a user, so you’re importing
    that as well as the *Todo* class ![](one.jpg).
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 你正在使用 Django 的 *TestCase* 类来组织你的测试代码。它主要基于 xUnit 测试风格，尽管也可以使用 Django 的 doctests。你的
    *Todo* 类需要链接到一个用户，所以你也在导入 *Todo* 类 ![图片](one.jpg)。
- en: '![](f0373-01.jpg)'
  id: totrans-118
  prefs: []
  type: TYPE_IMG
  zh: '![图片](f0373-01.jpg)'
- en: xUnit tests are structured with a parent class and multiple *test_* methods
    within it ![](two.jpg). The parent class gives you lots of convenience methods
    to test for equality, truth, exceptions being raised, and so on.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: xUnit 测试通过一个父类和其中多个 *test_* 方法进行结构化 ![图片](two.jpg)。父类为你提供了许多方便的方法来测试相等性、真值、抛出异常等。
- en: xUnit also has the concept of a *setUp* method, which is called before each
    test method and is used to do things like set up common data structures. Here
    you’re setting up a user and a todo you need for your tests ![](three.jpg). There’s
    also a corresponding *tearDown*, which is called after each test.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: xUnit 还有一个 *setUp* 方法的概念，它在每个测试方法之前被调用，用于设置常见的数据结构。在这里，你正在设置一个用户和一个 todo，你需要为测试
    ![图片](three.jpg)。还有一个相应的 *tearDown*，它在每个测试之后被调用。
- en: '![](four.jpg) is one example of what a unit test might look like. You’re testing
    the *short_description* method of the *Todo* class, so you’re setting up your
    test todo with different descriptions and making sure the method returns the right
    value using *TestCase*’s *assertEqual* method.'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](four.jpg) 是一个单元测试可能的样子。你正在测试 *Todo* 类的 *short_description* 方法，所以你设置了不同的测试
    todo 描述，并确保使用 *TestCase* 的 *assertEqual* 方法返回正确的值。'
- en: You’ll typically have a number of unit tests for each of your models, to test
    all of their functionality, but what about the views? They’re even more important
    to test, because they typically define most of your application and link everything
    together.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 你通常会对每个模型进行多个单元测试，以测试它们的所有功能，但视图怎么办？它们甚至更重要进行测试，因为它们通常定义了你的应用程序的大部分内容，并将所有内容连接在一起。
- en: Functional testing
  id: totrans-123
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 功能测试
- en: For views.py and urls.py, you’ll need to use functional tests to make sure everything’s
    working. For functional testing, Django lets you submit “pretend” forms with the
    *Client* class, which mimics a browser and the entire web request/response process.
    The following listing shows a few simple functional tests.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 views.py 和 urls.py，你需要使用功能测试来确保一切正常工作。对于功能测试，Django 允许你使用 *Client* 类提交“假装”表单，该类模拟浏览器和整个请求/响应过程。以下列表展示了几个简单的功能测试。
- en: Listing 11.9\. Functional testing
  id: totrans-125
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.9\. 功能测试
- en: '![](ch011list9-0.jpg)'
  id: totrans-126
  prefs: []
  type: TYPE_IMG
  zh: '![图片](ch011list9-0.jpg)'
- en: '![](ch011list9-1.jpg)'
  id: totrans-127
  prefs: []
  type: TYPE_IMG
  zh: '![图片](ch011list9-1.jpg)'
- en: Because you’re testing views, the imports ![](one.jpg) will be the same as the
    ones you set up in your views.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 因为你在测试视图，所以导入 ![图片](one.jpg) 将与你在视图中设置的相同。
- en: Creating an instance of the *Client* class is easy ![](two.jpg)—it doesn’t require
    any arguments.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 创建 *Client* 类的实例很简单 ![图片](two.jpg)——它不需要任何参数。
- en: Once you have a *Client* class, you can use its *.post* method to send data
    to your application ![](three.jpg). *.post* takes a URL and a dictionary of POST
    arguments and returns a response object. Notice that you’re using *reverse* here—as
    with views, it’s important to keep your unit tests independent of where you happen
    to store your code. There’s also a corresponding *.get* method, which doesn’t
    need the argument dictionary.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你有了 *Client* 类，你可以使用它的 *.post* 方法向你的应用程序发送数据 ![图片](three.jpg)。*.post* 接受一个
    URL 和一个 POST 参数的字典，并返回一个响应对象。注意，你在这里使用 *reverse*，就像在视图一样，保持你的单元测试独立于你存储代码的位置是很重要的。还有一个相应的
    *.get* 方法，它不需要参数字典。
- en: 'The response object ![](four.jpg) contains everything that’s returned from
    the POST request you’ve just run, such as status code, content, headers, cookies,
    and so on. Here you’re interested in two things: that the response is a redirect,
    and that the redirect is to the index page (because you’ve logged in successfully).'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 响应对象 ![four.jpg](https://example.org/four.jpg) 包含了你刚刚运行的 POST 请求返回的所有内容，例如状态码、内容、头部、Cookies
    等。这里你感兴趣的是两点：响应是一个重定向，并且重定向到索引页面（因为你已成功登录）。
- en: '![](f0375-01.jpg)'
  id: totrans-132
  prefs: []
  type: TYPE_IMG
  zh: '![f0375-01.jpg](https://example.org/f0375-01.jpg)'
- en: You don’t want to have to send in a login request every time you test something
    in your application, so Django provides the *login* method for the client ![](five.jpg).
    It creates all the cookies and session variables needed to simulate an actual
    login.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 你不希望在每次测试应用程序中的某个功能时都发送一个登录请求，因此 Django 为客户端提供了 *login* 方法 ![five.jpg](https://example.org/five.jpg)。它创建所有必要的
    Cookies 和会话变量来模拟实际的登录。
- en: If you’re testing a more normal request and you need to test what it returns,
    you can access it through *response.content*—it’s a string containing the HTML,
    as if you were viewing the source of a page in your browser ![](six.jpg).
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你正在测试一个更正常的请求，并且需要测试它返回的内容，你可以通过 *response.content* 访问它——它是一个包含 HTML 的字符串，就像你在浏览器中查看页面的源代码一样
    ![six.jpg](https://example.org/six.jpg)。
- en: Now you have your tests, but that’s not much good—you need to be able to run
    them and make sure your code tests OK. The beauty is that finding your test code
    and running your tests is done automatically.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你有了测试，但这并不算什么——你需要能够运行它们并确保你的代码测试通过。美妙之处在于，找到你的测试代码和运行测试是自动完成的。
- en: Running your tests
  id: totrans-136
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 运行你的测试
- en: Django’s manage.py contains a *test* command that will collect your test code
    and run it, as well as set up all the associated database infrastructure, and
    so on. The following listing shows a sample test run against the todo application.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: Django 的 manage.py 包含一个 *test* 命令，它将收集你的测试代码并运行它，以及设置所有相关的数据库基础设施等。以下列表显示了针对
    todo 应用程序的示例测试运行。
- en: Listing 11.10\. Test run
  id: totrans-138
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.10\. 测试运行
- en: '![](11list10.jpg)'
  id: totrans-139
  prefs: []
  type: TYPE_IMG
  zh: '![11list10.jpg](https://example.org/11list10.jpg)'
- en: If you only want to run your tests against one application, then include the
    application’s name after the *test* command ![](one.jpg). Otherwise, Django will
    test all of your installed applications, including applications like the admin
    interface, which might not be what you want.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你只想针对一个应用程序运行测试，那么在 *test* 命令后包含应用程序的名称 ![one.jpg](https://example.org/one.jpg)。否则，Django
    将测试所有已安装的应用程序，包括可能不是你想要的如管理界面等应用程序。
- en: For each test run, Django will create a test database and connect to that instead
    of your live database ![](two.jpg). This makes your testing independent of the
    data you have stored in your application—you can even run tests against a live
    server if you need to.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 对于每个测试运行，Django 将创建一个测试数据库并将其连接到该数据库而不是你的实时数据库 ![two.jpg](https://example.org/two.jpg)。这使得你的测试独立于你在应用程序中存储的数据——如果你需要，甚至可以针对实时服务器运行测试。
- en: Output from the tests is much like what you would have for a standard unit-test
    style test run ![](three.jpg). Each test will get a dot (pass), an *E* (error),
    or an *F* (failure). Once the tests have run, you’ll get a report on how many
    failed, and tracebacks for any errors or failures.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 测试输出的结果与标准单元测试风格的测试运行结果非常相似 ![three.jpg](https://example.org/three.jpg)。每个测试都会得到一个点（通过），一个
    *E*（错误），或者一个 *F*（失败）。一旦测试运行完成，你将得到一个报告，显示有多少失败，以及任何错误或失败的跟踪信息。
- en: When the testing is complete, Django will delete the test database ![](four.jpg).
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 当测试完成后，Django 将删除测试数据库 ![four.jpg](https://example.org/four.jpg)。
- en: Now you know how to make sure your applications run according to plan, even
    if you need to pull them apart and refactor them completely. You can make sure
    your releases don’t have any known bugs and that your code doesn’t regress when
    you’re developing—all you need for a robust, healthy, stress-free project.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经知道如何确保你的应用程序按计划运行，即使你需要将其拆分并完全重构。你可以确保你的发布版本没有已知的错误，并且在开发过程中你的代码不会回退——所有这些只需要一个健壮、健康、无压力的项目。
- en: Images and styles
  id: totrans-145
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 图片和样式
- en: One of the last things you need to do is to configure serving images and style
    sheets. Up to this point, you’ve been hard-coding style sheets into the HTML;
    but if you want to make a change later, you’ll need to edit every template. Django
    refers to images, style sheets, JavaScript, and other bits and pieces like that
    as *media*.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 你需要做的最后一件事是配置服务图片和样式表。到目前为止，你一直是在 HTML 中硬编码样式表；但如果你稍后想进行更改，你需要编辑每个模板。Django
    将图片、样式表、JavaScript 以及其他类似的东西称为 *media*。
- en: '![](f0377-01.jpg)'
  id: totrans-147
  prefs: []
  type: TYPE_IMG
  zh: '![f0377-01.jpg](https://example.org/f0377-01.jpg)'
- en: First, let’s look at a simple way to serve media directly from Django, and then
    a more robust method where your media is delivered with a server such as Apache
    or Nginx.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，让我们看看一种直接从 Django 提供媒体的方法，然后是一种更健壮的方法，其中你的媒体由 Apache 或 Nginx 等服务器提供。
- en: Serving media from Django
  id: totrans-149
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 从 Django 提供媒体
- en: 'First, a warning: this method is only really suitable for a development server.
    Django is written in Python and is slow at serving flat files such as images when
    compared to a server written in C. If you get any significant traffic on your
    server, it won’t be able to handle the load.'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，一个警告：这种方法仅适用于开发服务器。与用 C 语言编写的服务器相比，Django 用 Python 编写，在提供平面文件（如图片）时速度较慢。如果你的服务器上有任何显著的流量，它将无法处理负载。
- en: '|  |'
  id: totrans-151
  prefs: []
  type: TYPE_TB
  zh: '|  |'
- en: Tip
  id: totrans-152
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 小贴士
- en: Do one thing, and do it well. Django’s built more for returning HTML populated
    with results from a database, so it’s best to use it for that, and use something
    else to serve images.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 做一件事，做好这件事。Django 更适合返回包含数据库结果的 HTML，因此最好用它来做这件事，而用其他东西来提供图片。
- en: '|  |'
  id: totrans-154
  prefs: []
  type: TYPE_TB
  zh: '|  |'
- en: That said, let’s look at how to configure Django to serve static media files
    using one of Django’s built-in views, *django.views.static.serve*. You’ll need
    to make changes to both settings.py and urls.py.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 话虽如此，让我们看看如何配置 Django 使用内置视图 *django.views.static.serve* 来提供静态媒体文件。你需要对 settings.py
    和 urls.py 进行更改。
- en: Listing 11.11\. Serving static files with Django
  id: totrans-156
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 11.11\. 使用 Django 提供静态文件
- en: '![](11list11.jpg)'
  id: totrans-157
  prefs: []
  type: TYPE_IMG
  zh: '![11list11.jpg](11list11.jpg)'
- en: '![](f0378-01.jpg)'
  id: totrans-158
  prefs: []
  type: TYPE_IMG
  zh: '![f0378-01.jpg](f0378-01.jpg)'
- en: First, pick a directory to store your media ![](one.jpg). To make it easy, I
    normally call it “media” and put it in the root of my project. I’ve included versions
    for both Windows and Linux—note that the second and third lines are one line,
    and that Django uses forward slashes, even under Windows.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，选择一个目录来存储你的媒体 ![one.jpg](one.jpg)。为了方便，我通常将其命名为“media”，并将其放在项目的根目录下。我包括了
    Windows 和 Linux 的版本——请注意，第二行和第三行是一行，并且即使在 Windows 下，Django 也使用正斜杠。
- en: You’ll also want to pick a URL from which to serve your files ![](two.jpg).
    You’re free to pick any URL you like, but be aware that if you choose /media/
    you’ll interfere with the admin application’s media setting. /site_media/ is the
    convention for most Django applications.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 你还想要选择一个 URL 来提供你的文件 ![two.jpg](two.jpg)。你可以选择任何你喜欢的 URL，但请注意，如果你选择 /media/，你将干扰管理应用程序的媒体设置。/site_media/
    是大多数 Django 应用程序的惯例。
- en: To be absolutely certain you’re not going to use Django to serve up images when
    your site goes live, you check the value of *DEBUG* from settings.py ![](three.jpg).
    If it’s set to *True*, then you’re in development and should be safe.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 要确保你的网站上线后不会使用 Django 来提供图片服务，你需要检查 settings.py 文件中 *DEBUG* 的值 ![three.jpg](three.jpg)。如果它设置为
    *True*，那么你处于开发模式，应该是安全的。
- en: Finally, you set up the *django.views.static.serve* view ![](four.jpg). The
    two variables it needs are the path and the document root; other than that, it
    can take care of itself. To save duplicating your setup, you’re also including
    the *MEDIA_ROOT* from settings.py.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你设置 *django.views.static.serve* 视图 ![four.jpg](four.jpg)。它需要的两个变量是路径和文档根；除此之外，它可以自己处理。为了避免重复设置，你还会包含
    settings.py 中的 *MEDIA_ROOT*。
- en: Once you’ve made those changes, you can restart the server and begin adding
    images and style sheets. [Figure 11.4](#ch11fig04) shows the Django logo displayed
    on my development server.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你做了这些更改，你可以重新启动服务器，并开始添加图片和样式表。[图 11.4](#ch11fig04) 展示了在我的开发服务器上显示的 Django
    标志。
- en: Figure 11.4\. Serving up images with Django
  id: totrans-164
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 图 11.4\. 使用 Django 提供图片
- en: '![](11fig04_alt.jpg)'
  id: totrans-165
  prefs: []
  type: TYPE_IMG
  zh: '![11fig04_alt.jpg](11fig04_alt.jpg)'
- en: 'Now you can include images, CSS files, and JavaScript in your application templates
    by referencing /site_media/ like this:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你可以通过引用 /site_media/ 来在你的应用程序模板中包含图片、CSS 文件和 JavaScript，如下所示：
- en: '[PRE3]'
  id: totrans-167
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Actually creating a logo for your todo list is left as an exercise for the reader!
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上为待办事项列表创建一个标志留作读者的练习！
- en: Serving media from another server
  id: totrans-169
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 从另一个服务器提供媒体
- en: A better way to serve media, though, is to use a program expressly designed
    to serve static content, such as images and style sheets, and save Django for
    dynamic pages. This is relatively easy to do with most web servers, and there
    are a number of ways to achieve the same end. The following listing gives an example
    of how you might configure Apache with *mod_python* to serve requests for media
    and images, but pass other page requests on to Django.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，提供媒体的一个更好的方法是使用专门设计来提供静态内容（如图片和样式表）的程序，并保留 Django 用于动态页面。这在大多数 Web 服务器上相对容易实现，并且有几种方法可以达到相同的效果。以下列表提供了一个示例，说明如何配置
    Apache 使用 *mod_python* 来提供媒体和图片请求，但将其他页面请求传递给 Django。
- en: Listing 11.12\. A sample Apache `mod_python` configuration
  id: totrans-171
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表11.12。一个示例Apache `mod_python`配置
- en: '![](11list12_alt.jpg)'
  id: totrans-172
  prefs: []
  type: TYPE_IMG
  zh: '![图片2](11list12_alt.jpg)'
- en: '![](f0380-01.jpg)'
  id: totrans-173
  prefs: []
  type: TYPE_IMG
  zh: '![图片1](f0380-01.jpg)'
- en: '![](one.jpg) is pretty much a stock Django-with-*mod_python* configuration
    section. You use Django’s *mod_python* handler, use your *todos.settings* as the
    settings module, and switch on debugging—at least, while you’re setting up and
    testing everything.'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片5](one.jpg)基本上是一个标准的Django-with-*mod_python*配置部分。你使用Django的*mod_python*处理程序，使用你的*todos.settings*作为设置模块，并开启调试——至少，在你设置和测试一切的时候。'
- en: For /media, though, you’d like Apache to serve files normally, which means it
    will fall back to the normal document root for the server and display the media
    you’ve stored in /var/www/www.example.com/media ![](two.jpg).
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 对于/media，你希望Apache正常提供文件，这意味着它将回退到服务器的正常文档根目录，并显示你存储在/var/www/www.example.com/media中的媒体![图片4](two.jpg)。
- en: You can do much the same thing with a *Location-Match* directive, so URLs like
    [http://www.example.com/not_a_media_folder/logo.gif](http://www.example.com/not_a_media_folder/logo.gif)
    will fall back to the image stored at /var/www/www.example.com/not_a_ media_folder/logo.gif
    ![](three.jpg).
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用*Location-Match*指令做类似的事情，所以像[http://www.example.com/not_a_media_folder/logo.gif](http://www.example.com/not_a_media_folder/logo.gif)这样的URL将回退到存储在/var/www/www.example.com/not_a_media_folder/logo.gif的图片![图片3](three.jpg)。
- en: Note also that you’re not limited to using subfolders like this—you can use
    completely separate domains. For example, if you had www.exam-ple.com serving
    Django pages, then it’s possible to serve media from media.example.com or images.example.com.
    If your application model supports it, arranging your URLs like this can save
    a lot of configuration.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，你不仅限于使用这样的子文件夹——你可以使用完全独立的域名。例如，如果你有www.exam-ple.com提供Django页面，那么从media.example.com或images.example.com提供媒体也是可能的。如果你的应用程序模型支持这样做，按照这种方式安排你的URL可以节省大量的配置。
- en: Last but not least
  id: totrans-178
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 最后但同样重要的是
- en: The final thing you need to do is to edit your settings.py file and find the
    *DEBUG*setting. With this set to *True*, Django will give you detailed information
    whenever something goes wrong. It’s useful while developing, but this information
    can be dangerous in the wrong hands. Once you’ve switched it to *False*, Django
    will return a standard 500 error if your site breaks and will keep your application’s
    innards safe.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 你需要做的最后一件事是编辑你的settings.py文件，找到*DEBUG*设置。将此设置为*True*，当出现问题时Django会提供详细的错误信息。在开发过程中这很有用，但错误信息落入错误之手可能会造成危险。一旦你将其设置为*False*，如果你的网站出现故障，Django将返回标准的500错误，并保护你的应用程序内部安全。
- en: Where to from here?
  id: totrans-180
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 接下来该做什么？
- en: 'Your application is now fully functioning, plus you can install it on a server
    on an intranet or the internet and give out accounts to all your friends. It’s
    still somewhat bare-bones, though, so here are some ideas for extending it to
    make it more useful:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 你的应用程序现在完全功能正常，你还可以将它安装在内部网络或互联网上的服务器上，并将账户分发给所有你的朋友。尽管如此，它仍然相当简陋，所以这里有一些扩展它的想法，使其更有用：
- en: Now that you can use separate style sheets, you can pretty up your application,
    add logos and icons to your main page, and put your forms in tables. A little
    beautification can make a big difference to how seriously people take your application.
  id: totrans-182
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 现在你可以使用单独的样式表了，你可以让你的应用程序看起来更美观，在你的主页上添加标志和图标，并将表单放入表格中。一点美化可以大大改变人们对你的应用程序的重视程度。
- en: Your todos are fairly basic. What about adding some extra data to them, such
    as deadlines? If you recorded email addresses, the system could also email people
    when their deadlines are a week or a day away.
  id: totrans-183
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你的待办事项相当基础。关于添加一些额外数据到它们，比如截止日期呢？如果你记录了电子邮件地址，当他们的截止日期还有一周或一天时，系统也可以给人们发电子邮件。
- en: Once you have a few users, you could consider making the application more collaborative.
    Perhaps you could add a field to mark todo items as public. Other people’s public
    todo items would be included in your list, and you’d be able to view but not edit
    them. A list of users in the system and what people are working on might also
    be useful.
  id: totrans-184
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当你拥有一些用户后，你可以考虑使应用程序更具协作性。也许你可以添加一个字段来标记待办事项为公开。其他人的公开待办事项将包含在你的列表中，你可以查看但不能编辑它们。系统中的用户列表以及人们正在做什么也可能很有用。
- en: Or, the ability to add notes to your todos might be useful; you might even allow
    other people to add comments.
  id: totrans-185
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 或者，添加注释到你的待办事项中可能很有用；你甚至可能允许其他人添加评论。
- en: A wealth of information is available on advanced aspects of Django. The Django
    documentation, for example, is excellent and freely available from the Django
    website.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 关于Django的高级方面有大量的信息可供参考。例如，Django文档非常出色，并且可以从Django网站免费获取。
- en: You can also download some of the many Django-based applications and read through
    them. It’s a good way to learn how to structure your project and about new libraries
    to make development even easier. A good place to start is the Pinax website ([http://pinaxproject.com/](http://pinaxproject.com/)),
    which provides a number of reusable modules such as user registration and pagination
    (breaking a big list into smaller pages of 10 or 20). There are also modules for
    integrating external services like PayPal or Face-book, and entire applications
    such as content-management systems.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以下载许多基于Django的应用程序，并阅读它们。这是一种学习如何构建你的项目以及关于如何使开发更加容易的新库的好方法。一个不错的起点是Pinax网站([http://pinaxproject.com/](http://pinaxproject.com/))，它提供了一些可重用的模块，例如用户注册和分页（将大列表拆分为10或20页的小页面）。还有用于集成外部服务如PayPal或Facebook的模块，以及内容管理系统等完整的应用程序。
- en: Summary
  id: totrans-188
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, you learned about some of the issues associated with hosting
    and maintaining Django. You started with adding users and logins to your system
    and saw how to update the database when you made changes to your model. Then,
    you took a look through your system so far and secured all your pages and forms
    so different users (or even external attackers) couldn’t access todo lists that
    were supposed to be private. In the process, you got a lot more hands-on with
    your views and saw how to wrap some of Django’s built-in views so you could add
    extra features without having to reimplement the views from scratch.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你了解了一些与托管和维护Django相关的问题。你从向你的系统中添加用户和登录开始，并看到了当你更改模型时如何更新数据库。然后，你检查了到目前为止的系统，并确保了所有页面和表单的安全性，以便不同的用户（甚至外部攻击者）无法访问那些应该私有的待办事项列表。在这个过程中，你与视图有了更多的实际操作，并看到了如何包装Django的一些内置视图，以便在不从头实现视图的情况下添加额外功能。
- en: You then saw how to add tests to your Django application, and how Django allows
    you to easily add functional tests by providing a *Client* class that acts like
    a web browser.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 你已经看到了如何向你的Django应用程序添加测试，以及Django如何通过提供一个类似网页浏览器的*Client*类来轻松添加功能测试。
- en: Finally, we looked at how you can serve your static content, such as images
    and style sheets—both with a built-in view in Django and through a more efficient
    mechanism like Apache.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们探讨了如何为你提供静态内容，例如图片和样式表——无论是通过Django内置的视图，还是通过像Apache这样的更高效机制。
- en: That’s all the Python programming you’ll learn in this book. In the next chapter,
    you’ll find out what your next steps should be to improve your Python skills even
    further, and you’ll learn about several sources of assistance if you get stuck
    on your journey.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 这本书中你将学到的就是所有的Python编程。在下一章中，你将了解到为了进一步提高你的Python技能，你应该采取的下一步行动，以及如果你在旅途中遇到困难，你将了解一些求助的来源。
