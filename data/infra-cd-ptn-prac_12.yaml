- en: 9 Making changes
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 9 进行变更
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Determining when to use patterns like blue-green deployments to update infrastructure
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 确定何时使用如蓝绿部署等模式来更新基础设施
- en: Establishing immutability to create environments across multiple regions with
    IaC
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用IaC在多个区域创建环境以建立不可变性
- en: Determining change strategies for updating stateful infrastructure
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 确定更新有状态基础设施的变更策略
- en: In previous chapters, we started with helpful practices and patterns for modularizing,
    decoupling, testing, and deploying infrastructure changes. However, you also need
    to manage changes to infrastructure with infrastructure as code techniques. In
    this chapter, you’ll learn how to change IaC with strategies that apply immutability
    to minimize the impact of potential failure.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的章节中，我们介绍了模块化、解耦、测试和部署基础设施变更的有用实践和模式。然而，您还需要使用基础设施即代码技术来管理基础设施的变更。在本章中，您将学习如何通过应用不可变性策略来最小化潜在失败的影响，从而改变IaC。
- en: Let’s return to Datacenter for Veggies and its struggles to modularize IaC from
    chapter 5\. The company acquires Datacenter for Carnivorous Plants as a subsidiary.
    Its carnivorous plants, like Venus flytraps, require particular growing conditions.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们回到第5章中提到的“蔬菜数据中心”及其模块化IaC的挑战。该公司收购了“肉食植物数据中心”作为子公司。其肉食植物，如捕蝇草，需要特定的生长条件。
- en: As a result, Datacenter for Carnivorous Plants needs global networking and network-optimized
    servers and components. Most teams configure their IaC but realize that their
    code can’t handle such a widespread change. They ask you, a Datacenter for Veggies
    engineer with some experience in IaC, to help them.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，肉食植物数据中心需要全球网络和网络优化的服务器和组件。大多数团队配置了他们的IaC，但意识到他们的代码无法处理如此广泛的变化。他们向您，一位在IaC方面有一定经验的“蔬菜数据中心”工程师，寻求帮助。
- en: The engineering team directs you to the Cape sundew team to update its infrastructure
    first. As a hardy carnivorous plant, the Cape sundew can best handle any system
    downtime that causes fluctuations in temperature and watering. All of the infrastructure
    resources for the Cape sundew infrastructure exist in a single repository with
    a few configuration files.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 工程团队指导您先更新“开普敦捕蝇草”团队的基础设施。作为一种耐寒的肉食植物，开普敦捕蝇草最能处理由温度和浇水波动引起的任何系统停机时间。开普敦捕蝇草基础设施的所有基础设施资源都存在于一个单一存储库中，只有几个配置文件。
- en: You investigate and diagram the architecture of the sundew system. Figure 9.1
    shows a regional forwarding rule (load balancer) that sends traffic to a regional
    network with a container cluster and three servers. All traffic circulates in
    the same region and not globally.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 您调查并绘制了捕蝇草系统的架构。图9.1显示了一个区域转发规则（负载均衡器），它将流量发送到具有容器集群和三个服务器的区域网络。所有流量都在同一区域内循环，而不是全球范围内。
- en: '![](../../OEBPS/Images/CH09_F01_Wang.png)'
  id: totrans-10
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH09_F01_Wang.png)'
- en: Figure 9.1 The Cape sundew applications use an infrastructure system with shared
    load balancing resources, three servers, and one container cluster.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.1 开普敦捕蝇草应用程序使用了一个具有共享负载均衡资源、三个服务器和一个容器集群的基础设施系统。
- en: You want to change all resources to send traffic globally instead of routing
    in a single region. However, the sundew team defined all of these resources in
    the same IaC, also known as the singleton pattern (refer to chapter 3). The resources
    also share infrastructure state.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 您希望将所有资源更改为将流量发送到全球，而不是在单个区域内路由。然而，捕蝇草团队在同一个IaC中定义了所有这些资源，也称为单例模式（参见第3章）。这些资源还共享基础设施状态。
- en: How do you roll out the network changes to the system and minimize their impact?
    You worry about disrupting the watering application if you treat the infrastructure
    mutably by making the change in place. For example, changing your network to use
    global routing may affect the servers supporting the watering application.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 您如何将网络变更部署到系统中并最小化其影响？如果您通过就地更改来以可变的方式处理基础设施，您会担心会干扰到浇水应用程序。例如，将您的网络更改为使用全局路由可能会影响支持浇水应用程序的服务器。
- en: You remember from chapter 2 that you can use the idea of immutability to build
    new infrastructure with new changes. If you can apply these techniques to the
    system, you can isolate and test the changes in a new environment without affecting
    the old one. In this chapter, you’ll learn how to isolate and make changes to
    IaC.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以从第2章中回忆起，您可以使用不可变性的概念来构建带有新变更的新基础设施。如果您可以将这些技术应用于系统，您可以在不影响旧环境的情况下，在一个新环境中隔离和测试变更。在本章中，您将学习如何隔离和更改IaC。
- en: Note Demonstrating change strategies requires a sufficiently large (and complex)
    example. If you run the complete example, you will incur a cost that exceeds the
    GCP free tier. This book includes only the relevant lines of code and omits the
    rest for readability. For the listing in its entirety, refer to the book’s code
    repository at [https://github.com/joatmon08/manning-book/tree/main/ch09](https://github.com/joatmon08/manning-book/tree/main/ch09).
    If you convert these examples for AWS and Azure, you will also incur a cost. When
    possible, I offer notations on converting the examples to the cloud provider of
    your choice.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 注意 展示更改策略需要足够大（且复杂）的示例。如果你运行完整的示例，你将产生超过GCP免费层的成本。本书仅包括相关的代码行，为了可读性省略了其余部分。对于完整的代码列表，请参阅本书的代码仓库[https://github.com/joatmon08/manning-book/tree/main/ch09](https://github.com/joatmon08/manning-book/tree/main/ch09)。如果你将这些示例转换为AWS和Azure，你也将产生成本。在可能的情况下，我提供将示例转换为所选云提供商的注释。
- en: 9.1 Pre-change practices
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 9.1 更改前的实践
- en: You jump right into changing the sundew system. Unfortunately, you accidentally
    delete a configuration attribute that tags a server with `blue`, which allows
    traffic between all blue instances in the network. You push your change to your
    delivery pipeline to test the configuration and apply it to production.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 你直接开始改变捕蝇草系统。不幸的是，你意外删除了一个配置属性，该属性用`blue`标记了一个服务器，这允许网络中所有蓝色实例之间的流量。你将你的更改推送到交付管道以测试配置并将其应用到生产中。
- en: Testing misses the deleted tag. Fortunately, your monitoring system sends you
    an alert that the watering application cannot communicate with your new server!
    You divert all requests to a duplicate server instance to ensure that the sundews
    still get watered while you debug.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 测试遗漏了已删除的标签。幸运的是，你的监控系统向你发送了警报，表示浇水应用程序无法与你的新服务器通信！你将所有请求重定向到副本服务器实例，以确保在调试过程中捕蝇草仍然得到浇水。
- en: You realize that you should *not* start changing the system. The sundew system
    has existing architecture and tools you need to understand before you start. You
    also need to know if the system has backups or alternative environments ready
    for use if you break something. What should you do *before* you make a change?
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 你意识到你*不应该*开始改变系统。捕蝇草系统有现有的架构和工具，在你开始之前你需要了解。你还需要知道，如果系统有备份或备选环境可供使用，以防你破坏了某些东西。在你进行更改之前，你应该做什么？
- en: 9.1.1 Following a checklist
  id: totrans-20
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.1.1 遵循检查清单
- en: You always run the risk of introducing bugs and other problems when changing
    IaC. You need testing, monitoring, and observability (the ability to infer a system’s
    internal state from its outputs) to ensure that you haven’t affected the system
    during your change. If you do not have some visibility into your system, you cannot
    quickly troubleshoot problems from broken changes.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 在更改IaC时，你总是存在引入错误和其他问题的风险。你需要测试、监控和可观察性（从系统的输出推断系统内部状态的能力）来确保你在更改过程中没有影响系统。如果你对你的系统没有一定的可见性，你就不能快速从破坏性更改中排除问题。
- en: Before you change the sundew system, you decide to review a few things about
    your system. Figure 9.2 shows what you review. You first add a test to check for
    your deleted tag. Next, you examine your monitoring system for both system and
    application health checks and metrics. Finally, you create duplicate servers as
    backup, just in case you break the existing servers. You can send traffic to the
    backup server if you accidentally affect the updated server.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 在你改变捕蝇草系统之前，你决定回顾一下你的系统。图9.2显示了你要回顾的内容。你首先添加一个测试来检查你的已删除标签。接下来，你检查你的监控系统，进行系统和应用程序的健康检查和指标。最后，你创建副本服务器作为备份，以防你破坏现有的服务器。如果你意外影响了更新的服务器，你可以将流量发送到备份服务器。
- en: '![](../../OEBPS/Images/CH09_F02_Wang.png)'
  id: totrans-23
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH09_F02_Wang.png)'
- en: Figure 9.2 Before updating the network, you need to verify test coverage, systems
    and application monitoring, and redundancy.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 在更新网络之前，你需要验证测试覆盖率、系统和应用程序监控以及冗余。
- en: Why did you create the duplicate servers as backup? It helps to have extra resources
    that duplicate the previous configuration that you use only if the primary resources
    fail. This *redundancy* keeps your system running.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 你为什么创建副本服务器作为备份？当主要资源失败时，拥有额外资源来复制你之前使用的配置是有帮助的。这种*冗余*使你的系统保持运行。
- en: Definition *Redundancy* is the duplication of resources to improve the system’s
    performance. If updated components fail, the system can use working resources
    with a previous configuration.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *冗余* 是指复制资源以提高系统的性能。如果更新的组件失败，系统可以使用具有先前配置的工作资源。
- en: 'In general, review the following checklist before you make a change:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，在您进行更改之前，请审查以下清单：
- en: Can you preview each change and *test* the changes in an isolated environment?
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您能否在每个更改之前预览并**测试**在隔离环境中进行的更改？
- en: Does the system have *monitoring and alerts* configured to identify any anomalies?
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 系统是否配置了**监控和警报**以识别任何异常？
- en: Does the application track error responses with *health checks, logging, observability,
    or metrics*?
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 应用程序是否通过**健康检查、日志记录、可观察性或指标**跟踪错误响应？
- en: Do the applications and their systems have any *redundancy*?
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 应用程序及其系统是否有任何**冗余**？
- en: The items on the list focus on visibility and awareness. Without monitoring
    systems or tests to help identify problems, you may have trouble identifying or
    resolving broken changes. I once pushed a change that broke an application and
    did not find out until *two weeks* after release. It took so long to realize the
    problem because we did not have alerts on the application!
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 列表中的项目侧重于可见性和意识。如果没有监控系统或测试来帮助识别问题，您可能难以识别或解决损坏的更改。我曾经推送了一个破坏应用程序的更改，直到**两周**后才得知。由于我们没有在应用程序上设置警报，所以花了这么长时间才意识到问题！
- en: A pre-change checklist sets the foundation for debugging any problems and establishing
    any backup plans should the change fail. You can even use the practices from chapters
    6 and 8 to build this checklist into delivery pipelines as quality gates.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 在更改之前，检查清单为调试任何问题以及如果更改失败建立任何备份计划奠定了基础。您甚至可以使用第6章和第8章中的实践，将此检查清单构建到交付管道中作为质量门。
- en: 9.1.2 Adding reliability
  id: totrans-34
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.1.2 添加可靠性
- en: After reviewing the pre-change checklist, you realize that you need a better
    backup environment in your system. To ensure that you don’t bring down the entire
    sundew system in your continued refactoring efforts, you need additional redundancy.
    When you finally deploy a change to the sundew team’s modules, you do not need
    to worry about disrupting the system.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 在审查更改前的检查清单后，您意识到您需要在系统中有一个更好的备份环境。为了确保您在持续的重构工作中不会使整个捕蝇草系统崩溃，您需要额外的冗余。当您最终将更改部署到捕蝇草团队的模块时，您不需要担心会破坏系统。
- en: Unfortunately, the sundew system exists only in `us-central1`. The sundews don’t
    get watered if the region fails! You decide to build an idle production sundew
    system in another region (`us-west1`) so you can restart the watering application.
    You use IaC to *reproduce* the active region in `us-central1` to the passive (idle)
    region in `us-west1`.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 不幸的是，捕蝇草系统仅存在于`us-central1`。如果该区域失败，捕蝇草不会得到浇水！您决定在另一个区域（`us-west1`）构建一个闲置的生产捕蝇草系统，这样您就可以重新启动浇水应用程序。您使用IaC将`us-central1`中的主动区域**复制**到`us-west1`中的被动（闲置）区域。
- en: You can now use the environment in the passive region as a backup. In figure
    9.3, you update the sundew team’s configuration to use a server module and push
    the change to the active environment. If it does not work, you temporarily send
    all traffic to the passive environment while you debug the problem. Otherwise,
    you run tests and update the passive environment with the module changes.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 您现在可以使用被动区域中的环境作为备份。在图9.3中，您更新捕蝇草团队的配置以使用服务器模块，并将更改推送到主动环境。如果它不起作用，您在调试问题时暂时将所有流量发送到被动环境。否则，您运行测试并使用模块更改更新被动环境。
- en: '![](../../OEBPS/Images/CH09_F03_Wang.png)'
  id: totrans-38
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH09_F03_Wang.png)'
- en: Figure 9.3 You use IaC to implement an active-passive configuration for the
    sundew system to improve its reliability during changes.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.3 您使用IaC为捕蝇草系统实现主动-被动配置，以在更改期间提高其可靠性。
- en: The sundew system now uses an *active-passive configuration*, in which one environment
    sits idle and serves as a backup.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 现在的捕蝇草系统采用了一种**主动-被动配置**，其中一个环境处于闲置状态，作为备份。
- en: Definition In an *active-passive configuration*, one system is the active environment
    for completing user requests, and the other is the backup environment.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 定义在**主动-被动配置**中，一个系统是用于完成用户请求的主动环境，另一个是备份环境。
- en: If the environment in `us-central1` stops working, you can always send traffic
    to the other passive environment in `us-west1`. Switching from a failed active
    environment to the working passive one follows the process of *failover*.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 如果`us-central1`中的环境停止工作，您始终可以将流量发送到`us-west1`中的另一个被动环境。从失败的主动环境切换到工作的被动环境遵循**故障转移**的过程。
- en: Definition *Failover* is the practice of using passive (or standby) resources
    to take over when the primary resources fail.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 定义**故障转移**是在主要资源失败时使用被动（或备用）资源接管的做法。
- en: Why would you want an active-passive configuration? Building a passive environment
    in a second region improves the overall reliability of the system. *Reliability*
    measures how long a system performs correctly within a time period.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 你为什么想要一个活动-被动配置？在第二个区域构建一个被动环境可以提高系统的整体可靠性。*可靠性*衡量的是系统在一段时间内正确运行的时间。
- en: Definition *Reliability* measures how long a system performs correctly within
    a time period.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *可靠性*衡量的是系统在一段时间内正确运行的时间。
- en: You want to keep your system reliable as you make IaC changes. Improving reliability
    minimizes disruption to business-critical applications and, ultimately, end users.
    You reduce your blast radius to the active environment with the option to cut
    over traffic to a working passive environment.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 你希望在执行IaC更改时保持系统的可靠性。提高可靠性可以最小化对业务关键应用的干扰，并最终减少对最终用户的影响。你可以通过将流量切换到一个工作状态下的被动环境来减少对活动环境的破坏范围。
- en: 'Let’s create the active-passive configuration in code. In your terminal, you
    copy the file named blue.py containing the sundew’s infrastructure resources to
    a new file named passive.py:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们在代码中创建一个活动-被动配置。在你的终端中，你将名为blue.py的文件（包含sundew的基础设施资源）复制到一个名为passive.py的新文件中：
- en: '[PRE0]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: For passive.py in listing 9.1, you update a few variables to create the passive
    sundew environment, including region and name.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在列表9.1中的passive.py中，你更新了一些变量以创建被动sundew环境，包括区域和名称。
- en: Listing 9.1 Updating the passive sundew environment for `us-west1`
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 列表9.1更新`us-west1`的被动sundew环境
- en: '[PRE1]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: ❶ Sets the version to identify the passive environment
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 设置版本以识别被动环境。
- en: ❷ Changes the region from us-central1 to us-west1 for the passive environment
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 将被动环境的区域从us-central1更改为us-west1。
- en: ❸ Updates a different IP address range for the passive environment to avoid
    sending requests
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 更新被动环境的不同IP地址范围，以避免发送请求。
- en: ❹ Remaining variables and functions reference the constants for the passive
    environment, including region.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 剩余的变量和函数引用被动环境的常量，包括区域。
- en: ❺ Defines labels for resources so you can identify the production environment
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 为资源定义标签，以便你可以识别生产环境。
- en: AWS and Azure equivalents
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure等效项
- en: GCP labels are similar to AWS and Azure tags. You can take the object defined
    in the `labels` variable and pass it to AWS and Azure resource tags.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: GCP标签类似于AWS和Azure标签。你可以将`labels`变量中定义的对象传递给AWS和Azure资源标签。
- en: You now have a backup environment in case your module change goes wrong. Imagine
    you push the change and break the active environment in `us-central1`. You can
    update and push the configuration for a production global load balancer to failover
    and send everything to the passive environment. In the following listing, you
    change the weight on your global load balancer to send 100% of traffic to the
    passive environment.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你有一个备份环境，以防你的模块更改出错。想象一下，你推送更改并破坏了`us-central1`中的活动环境。你可以更新并推送配置，以便生产全局负载均衡器故障切换并将所有流量发送到被动环境。在下面的列表中，你更改全局负载均衡器的权重，以便将100%的流量发送到被动环境。
- en: Listing 9.2 Failover to passive sundew environment in `us-west1`
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 列表9.2在`us-west1`中故障切换到被动sundew环境
- en: '[PRE2]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: ❶ Imports IaC for both blue (active environment) and passive environment
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 导入蓝色（活动环境）和被动环境的IaC。
- en: ❷ Defines a list of versions for each environment to attach to the load balancer,
    blue and passive
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 为每个环境定义一个版本列表，以便将其附加到负载均衡器，蓝色和被动。
- en: ❸ Configures the load balancer with a weight to send 0% of traffic to the blue
    version
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 配置负载均衡器，将0%的流量发送到蓝色版本。
- en: ❹ Configures the load balancer with a weight to send 100% of traffic to the
    passive version
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 配置负载均衡器，将100%的流量发送到被动版本。
- en: ❺ Adds the two versions to the load balancer with their weights as routes to
    the load-balancing rule
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 将两个版本及其权重作为路由添加到负载均衡器的负载均衡规则中。
- en: ❻ Defines backend services for the blue and passive environments with a weight
    to direct traffic to each one
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 定义了蓝色和被动环境的后端服务，并为每个环境分配权重以引导流量。
- en: ❼ Creates the Google compute URL map (load-balancing rule) using a Terraform
    resource based on the path, blue (active) and passive servers, and weight
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: ❼ 使用基于路径、蓝色（活动）和被动服务器以及权重的Terraform资源创建Google计算URL映射（负载均衡规则）。
- en: ❽ Sets up a path rule that directs all paths to the active or passive servers
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: ❽ 设置路径规则，将所有路径导向活动或被动服务器。
- en: ❾ Adds the two versions to the load balancer with their weights as routes to
    the load-balancing rule
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: ❾ 将两个版本及其权重作为路由添加到负载均衡器的负载均衡规则中。
- en: AWS and Azure equivalents
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: AWS和Azure等效项
- en: The Google Cloud URL map is similar to AWS Application Load Balancer (ALB) or
    Azure Traffic Manager and Application Gateway. To convert listing 9.2 to AWS,
    you will need to update the resource to create an AWS ALB and listener rule. Then,
    add path routing and weight attributes to the ALB listener rule.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: Google Cloud URL 映射类似于 AWS 应用负载均衡器（ALB）或 Azure 流量管理器和应用程序网关。要将列表 9.2 转换为 AWS，您需要更新资源以创建
    AWS ALB 和监听器规则。然后，向 ALB 监听器规则添加路径路由和权重属性。
- en: For Azure, you will need to link an Azure Traffic Manager profile and endpoint
    to an Azure Application Gateway. Update the Azure Traffic Manager with weights
    and route them to the correct backend address pool attached to an Azure Application
    Gateway.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 Azure，您需要将 Azure 流量管理器配置文件和端点链接到 Azure 应用程序网关。更新 Azure 流量管理器，设置权重并将它们路由到连接到
    Azure 应用程序网关的正确后端地址池。
- en: After you fail over the system to the passive environment, the sundew team reports
    the return of the watering application. You have a chance to debug problems with
    your module in the blue (active) environment. The active-passive configuration
    will protect from failures in individual regions in the future.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 在将系统故障转移到被动环境后，Sundew 团队报告了浇水应用程序的回归。您有机会在蓝色（主动）环境中调试模块的问题。主动-被动配置将保护未来单个区域中的故障。
- en: The sundew team members tell you that, eventually, they want to send traffic
    to both regions. Both environments in each region process requests. Figure 9.4
    shows their dream configuration. The next time, they want to update the module
    and push it out to one region. If a region breaks, *most* requests will still
    get processed by the system. You water the sundews less frequently but have an
    opportunity to fix the broken region.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: Sundew 团队成员告诉您，最终，他们希望将流量发送到两个区域。每个区域中的两个环境都处理请求。图 9.4 显示了他们的理想配置。下次，他们想更新模块并将其推送到一个区域。如果某个区域出现故障，*大多数*请求仍然会由系统处理。您减少对
    Sundews 的浇水频率，但有机会修复损坏的区域。
- en: '![](../../OEBPS/Images/CH09_F04_Wang.png)'
  id: totrans-76
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH09_F04_Wang.png)'
- en: Figure 9.4 In the future, the sundew team will further refactor the system configuration
    to support an active-active configuration and send requests to both regions.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 图 9.4 在未来，Sundew 团队将进一步重构系统配置以支持活动-活动配置并向两个区域发送请求。
- en: Why aspire to run two active environments? Many distributed systems run in *an
    active-active configuration*, which means both systems process and accept requests
    and replicate data between them. Public cloud architectures recommend using a
    multiregion, active-active configuration to improve the system’s reliability.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么要追求运行两个活跃环境？许多分布式系统都在 *活动-活动配置* 下运行，这意味着两个系统都处理和接受请求，并在它们之间复制数据。公共云架构建议使用多区域、活动-活动配置来提高系统的可靠性。
- en: Definition In an *active-active configuration*, multiple systems are the active
    environments for completing user requests and replicating data between them.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 在 *活动-活动配置* 中，多个系统是完成用户请求和它们之间数据复制的活跃环境。
- en: Your changes to IaC will differ depending on active-passive or active-active
    configuration. The sundew team’s active-active configuration must refactor the
    IaC into more modular components and support data replication between environments.
    Assuming the sundew team refactors its applications to support an active-active
    configuration, you will need to implement some form of global load balancing in
    your IaC and connect it to each region.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 您对 IaC 的更改将取决于主动-被动或主动-活动配置。Sundew 团队的主动-活动配置必须将 IaC 重构为更模块化的组件，并支持环境之间的数据复制。假设
    Sundew 团队重构其应用程序以支持主动-活动配置，您需要在 IaC 中实现某种形式的全局负载均衡并将其连接到每个区域。
- en: IaC conforms to *reproducibility*, which we covered in chapter 1\. Thanks to
    this principle, we can create a new environment in a new region with a few updates
    to attributes. You do not have to painstakingly rebuild an environment resource
    by resource as we did in chapter 2.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: IaC 符合 *可重复性*，我们在第 1 章中讨论了这一点。多亏了这个原则，我们只需对属性进行少量更新，就可以在新的区域中创建一个新环境。您不必像我们在第
    2 章中所做的那样，逐个资源地痛苦地重建环境资源。
- en: However, you may find yourself copying and pasting a lot of the same configuration.
    Try to pass regions as inputs and modularize your IaC to reduce copying and pasting.
    Separate shared resources configuration, like global load balancer definitions,
    away from the environment configurations.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，您可能会发现自己正在大量复制粘贴相同的配置。尝试将区域作为输入传递，并将您的 IaC 模块化以减少复制粘贴。将共享资源配置，如全局负载均衡器定义，从环境配置中分离出来。
- en: Multiregion environments always incur a cost in terms of money and time but
    can help improve system reliability. IaC expedites creating copies of new environments
    in other regions and enforces consistent configurations across regions. Inconsistencies
    between regions can introduce significant system failures and increase maintenance
    effort! Chapter 12 discusses cost management and its considerations.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 多区域环境在金钱和时间上都会产生成本，但可以帮助提高系统可靠性。IaC加速在其他区域创建新环境的副本，并强制跨区域保持一致配置。区域之间的不一致性可能导致重大的系统故障并增加维护工作量！第12章讨论了成本管理和其考虑因素。
- en: 9.2 Blue-green deployment
  id: totrans-84
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 9.2 蓝绿部署
- en: Now that you have another environment to fall back on if you accidentally corrupt
    the active one, you can start updating the sundew system to use global networking
    and premium tier network access for servers. The sundew system uses an active-passive
    configuration, which means duplicating a whole new environment in a new region
    just to make changes.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您有另一个环境可以作为备选，以防您意外损坏活动环境，您可以从更新sundew系统以使用全局网络和高级别网络访问服务器开始。sundew系统使用主动-被动配置，这意味着在新的区域中复制整个新环境只是为了进行更改。
- en: You realize that some changes don’t require duplicating entire environments
    across multiple regions. Why have an entire passive environment just to update
    a server? Can’t you just update one server? After all, we want to minimize the
    blast radius of failures and optimize our resource efficiency. Instead of using
    active- passive configuration, you can apply the pattern to fewer resources on
    a much smaller scale.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 您意识到某些更改不需要在多个区域复制整个环境。为什么要有整个被动环境只是为了更新服务器？难道不能只更新一台服务器吗？毕竟，我们希望最小化故障的爆炸半径并优化资源效率。除了使用主动-被动配置外，您还可以将此模式应用于规模更小的少量资源。
- en: In figure 9.5, you reproduce a new *network* with global networking instead
    of the entire environment. You label the new network `green` and deploy a set
    of three servers and one cluster on it. After testing the new resources, you use
    your global load balancer to send a small percentage of traffic to the new resources.
    The requests succeed, indicating that the update to global routing worked.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 在图9.5中，您使用全局网络而不是整个环境重新创建了一个新的*网络*。您将新的网络标记为`绿色`，并在其上部署了一组三台服务器和一个集群。在测试新资源后，您使用全局负载均衡器将一小部分流量发送到新资源。请求成功，表明全局路由的更新工作正常。
- en: '![](../../OEBPS/Images/CH09_F05_Wang.png)'
  id: totrans-88
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH09_F05_Wang.png)'
- en: Figure 9.5 Use blue-green deployment to create a green environment for the global
    network, send some traffic to the new resources, and remove the old resources.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.5 使用蓝绿部署为全球网络创建绿色环境，将部分流量发送到新资源，并移除旧资源。
- en: The pattern of creating a new set of resources and gradually cutting over to
    them applies the principles of composability and evolvability of your system.
    You add a new `green` set of resources to your environment and allow them to evolve
    independently of the old resources. If you want to make changes to infrastructure,
    repeat this workflow to reduce your blast radius of changes and test new resources
    before sending traffic to them.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一组新资源并逐渐切换到它们的模式，应用了您系统的可组合性和可进化性原则。您向环境中添加一组新的`绿色`资源，并允许它们独立于旧资源独立进化。如果您想更改基础设施，重复此工作流程以减少更改的爆炸半径，并在将流量发送到它们之前测试新资源。
- en: This pattern, called a *blue-green deployment*, creates a new subset of infrastructure
    resources that stages the changes you want to make, labeled `green`. You then
    direct a few requests to the green staging infrastructure resources and ensure
    that everything works. Over time, you send all requests to the green infrastructure
    resources and remove the old production resources, labeled `blue`.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 这种称为*蓝绿部署*的模式创建了一个新的基础设施资源子集，用于阶段化您想要进行的更改，标记为`绿色`。然后，您将一些请求定向到绿色阶段化基础设施资源，并确保一切正常。随着时间的推移，您将所有请求发送到绿色基础设施资源，并移除标记为`蓝色`的旧生产资源。
- en: Definition *Blue-green deployment* is a pattern that creates a new subset of
    infrastructure resources with the changes you want to make. You gradually shift
    traffic from the old set of resources (blue) to the new set of resources (green)
    and eventually remove the old ones.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 定义*蓝绿部署*是一种创建包含您想要进行更改的新子集基础设施资源的模式。您逐渐将流量从旧资源集（蓝色）转移到新资源集（绿色），并最终移除旧资源。
- en: Blue-green deployment allows you to isolate and test changes in a (temporarily)
    new staging environment before sending requests to it. After validating the green
    environment, you can switch the new environment to the production one and delete
    the old one. You temporarily pay for two environments for a few weeks but minimize
    the overall cost of maintaining persistent environments.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 蓝绿部署允许您在发送请求之前在（暂时性）新的预发布环境中隔离和测试更改。在验证绿色环境后，您可以将新环境切换到生产环境并删除旧环境。您暂时为两个环境支付几周的费用，但最大限度地减少维护持久环境的总体成本。
- en: Note Blue-green deployment has a few different labels, occasionally with subtle
    nuances depending on the context. It doesn’t matter what color or names you label
    the environments, as long as you can identify which environment serves as the
    existing production one or the new staging one. I have also used production/staging
    and version numbering (v1/v2) to identify old and new resources during blue-green
    deployment.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：蓝绿部署有几个不同的标签，有时根据上下文会有细微的差别。无论您将环境标记为哪种颜色或名称，只要您能识别出哪个环境作为现有的生产环境或新的预发布环境即可。我还在蓝绿部署期间使用了生产/预发布和版本编号（v1/v2）来识别旧资源和新资源。
- en: You should use a blue-green deployment pattern to refactor or update your IaC
    beyond a few minimal configurations. Blue-green deployment depends on the principle
    of immutability to create new resources, cut over traffic or functionality to
    them, and remove old resources. Most of the patterns for refactoring (chapter
    10) and changing IaC often involve the principle of reproducibility.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该使用蓝绿部署模式来重构或更新您的 IaC 超过一些最小配置。蓝绿部署依赖于不可变性原则来创建新资源，将流量或功能切换到它们，并删除旧资源。大多数重构（第
    10 章）和更改 IaC 的模式通常涉及可重复性原则。
- en: Image building and configuration management
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 镜像构建和配置管理
- en: You can similarly mitigate the risk of a failed machine image or configuration
    by applying a blue-green deployment pattern. Isolate machine image or configuration
    management updates to a new server (green), send traffic to it, and test its functionality
    before removing the old server (blue).
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过应用蓝绿部署模式类似地减轻失败机器镜像或配置的风险。将机器镜像或配置管理更新隔离到新的服务器（绿色），将其发送流量，并在删除旧服务器（蓝色）之前测试其功能。
- en: You already have a global load balancer for the existing `blue` network that
    you can use later to connect the new `green` network. In the following sections,
    let’s implement each step of a blue-green deployment for the sundew system.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 您已经有一个用于现有 `blue` 网络的全局负载均衡器，您可以在以后用它来连接新的 `green` 网络。在接下来的章节中，我们将实现 sundew
    系统的蓝绿部署的每个步骤。
- en: 9.2.1 Deploying the green infrastructure
  id: totrans-99
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.2.1 部署绿色基础设施
- en: To start a blue-green deployment for the sundew system’s global networking and
    premium tier servers, you copy the configuration for the existing blue network.
    You create the file named green.py and paste the blue network configuration. In
    the following listing, you make changes to the network definition so it uses a
    global routing mode.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 要为 sundew 系统的全局网络和高级服务器启动蓝绿部署，您复制现有蓝色网络的配置。您创建名为 green.py 的文件并将蓝色网络配置粘贴进去。在下面的列表中，您对网络定义进行修改，使其使用全局路由模式。
- en: Listing 9.3 Creating the green network
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 9.3 创建绿色网络
- en: '[PRE3]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: ❶ Sets the name of the new network version to “green”
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将新网络版本的名称设置为“绿色”
- en: ❷ Keeps the IP address range for green the same as the blue network. GCP allows
    the two networks to have the same CIDR block if you have not set up peering.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 保持绿色网络的 IP 地址范围与蓝色网络相同。如果您没有设置对等连接，GCP 允许两个网络具有相同的 CIDR 块。
- en: ❸ Uses the module to create the JSON configuration for the network and subnetwork
    for the green network
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 使用模块为绿色网络和子网络创建 JSON 配置
- en: ❹ Creates the Google network by using a Terraform resource based on the name
    and a global routing mode
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 使用基于名称和全局路由模式的 Terraform 资源创建 Google 网络
- en: ❺ Updates the green network’s routing mode to global to expose routes globally
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 将绿色网络的路由模式更新为全局，以在全球范围内暴露路由
- en: ❻ Creates the Google subnetwork by using a Terraform resource based on the name,
    region, network, and IP address range
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 使用基于名称、区域、网络和 IP 地址范围的 Terraform 资源创建 Google 子网络
- en: AWS and Azure equivalents
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 的等效方案
- en: If you convert listing 9.3 to AWS or Azure, the global routing mode does not
    apply. You can still update the code listing to AWS or Azure by changing Google’s
    network and subnetwork to a VPC or virtual network, and changing the subnets and
    routing tables.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你将列表9.3转换为AWS或Azure，全局路由模式不适用。你仍然可以通过更改Google的网络和子网络为VPC或虚拟网络，以及更改子网和路由表来更新代码列表以适用于AWS或Azure。
- en: You want to keep the same configuration for blue and green resources when possible.
    They should differ only in the changes you want to make to the green sources.
    However, you might have some differences!
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 当可能时，你希望保持蓝色和绿色资源的相同配置。它们应该只在你想对绿色资源进行的更改上有所不同。然而，你可能有某些差异！
- en: For example, if I had some specific peering configuration for my networks, I
    *could not* use the blue network’s IP address range for the green network. Instead,
    I would need a different IP address range, like 10.0.1.0/24, and update any dependencies
    to communicate to another IP address range.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果我为我的一些网络有特定的对等配置，我*不能*使用蓝网络的IP地址范围用于绿色网络。相反，我需要一个不同的IP地址范围，如10.0.1.0/24，并更新任何依赖以与另一个IP地址范围通信。
- en: Blue-green deployment favors immutability, creating new, updated resources and
    isolating the changes away from the old resources. However, deploying a new version
    of a low-level resource like networking does not mean you can immediately send
    live traffic to it. You always start by changing and testing the infrastructure
    resource you want to update. Then, you must change and test *other* resources
    that depend on it.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 蓝绿部署倾向于不可变性，创建新的、更新的资源并将更改与旧资源隔离。然而，部署低级资源如网络的新版本并不意味着你可以立即向其发送实时流量。你总是从更改和测试你想要更新的基础设施资源开始。然后，你必须更改和测试*其他*依赖于它的资源。
- en: 9.2.2 Deploying high-level dependencies to the green infrastructure
  id: totrans-114
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.2.2 将高级依赖部署到绿色基础设施
- en: When you use the blue-green deployment pattern, you always need to deploy a
    new infrastructure resource with the changes *and* a new set of high-level resources
    that depend on it. You finished updating the network but cannot use it unless
    you have servers and applications on it. The new network needs high-level infrastructure
    that depends on it.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 当你使用蓝绿部署模式时，你总是需要部署一个新的基础设施资源及其依赖的新一组高级资源。你完成了网络的更新，但除非你有服务器和应用程序在上面，否则你不能使用它。新的网络需要依赖于它的高级基础设施。
- en: You communicate to the sundew teams to deploy new clusters and servers onto
    the green network, as shown in figure 9.6\. The servers must use premium networking
    on the global network. The sundew team also deploys its applications onto the
    cluster and servers.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 你向露珠团队传达部署新集群和服务器到绿色网络的指示，如图9.6所示。服务器必须在全局网络上使用高级网络。露珠团队还将其应用程序部署到集群和服务器上。
- en: '![](../../OEBPS/Images/CH09_F06_Wang.png)'
  id: totrans-117
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH09_F06_Wang.png)'
- en: Figure 9.6 After creating the network, a low-level infrastructure resource,
    you also need to create new high-level resources like the server and container
    cluster that depend on it.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.6 在创建网络，一个低级基础设施资源之后，你还需要创建新的高级资源，如依赖于它的服务器和容器集群。
- en: In this example, changing a low-level infrastructure resource like the network
    affects the high-level resources. The servers must run with premium networking.
    Updating the original `blue` network in-place from regional to global routing
    would likely have affected the servers and cluster. With a blue-green deployment,
    you *evolve* the network attributes for the servers without affecting the live
    environment.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，更改低级基础设施资源如网络会影响高级资源。服务器必须使用高级网络运行。将原始`blue`网络就地从区域路由更新为全局路由可能会影响服务器和集群。使用蓝绿部署，你*演进*服务器的网络属性，而不影响实时环境。
- en: Let’s review a sample of the IaC that the sundew team members added to deploy
    the cluster onto the `green` network in the following listing. They copied the
    cluster configuration from the `blue` resource and updated its attributes to run
    on the `green` network.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们回顾一下露珠团队成员添加到以下列表中的IaC样本，用于将集群部署到`green`网络。他们从`blue`资源复制了集群配置，并更新了其属性以在`green`网络上运行。
- en: Listing 9.4 Adding a new cluster to the green network
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 列表9.4 向绿色网络添加新的集群
- en: '[PRE4]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: ❶ Labels the new version of the cluster “green”
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将集群的新版本标记为“green”
- en: ❷ Uses the module to create the JSON configuration for the network, subnetwork,
    and cluster for the green network
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 使用模块创建绿色网络的网络、子网络和集群的JSON配置
- en: ❸ Builds the cluster on the green network and subnetwork
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 在绿色网络和子网络上构建集群
- en: ❹ Passes required attributes to the cluster, including name, node names, service
    accounts for automation, and region
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 将所需的属性传递给集群，包括名称、节点名称、自动化服务账户和区域
- en: ❺ Creates the Google container cluster by using a Terraform resource with one
    node and on the green network
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 使用具有一个节点和绿色网络的 Terraform 资源创建 Google 容器集群
- en: ❻ Builds the cluster on the green network and subnetwork
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 在绿色网络和子网络上构建集群
- en: AWS and Azure equivalents
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 等效
- en: You can update the code by changing the Google container cluster to an Amazon
    EKS cluster or Azure Kubernetes Service (AKS) cluster. You will need an Amazon
    VPC and Azure virtual network for the Kubernetes node pools (also called groups).
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过将 Google 容器集群更改为 Amazon EKS 集群或 Azure Kubernetes 服务 (AKS) 集群来更新代码。您将需要一个
    Amazon VPC 和 Azure 虚拟网络用于 Kubernetes 节点池（也称为组）。
- en: The cluster does not require any changes to adapt to the global networking configuration.
    However, the servers need premium networking. You copy the server configuration
    from `blue` and change it to use premium networking attributes in green.py.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 集群不需要任何更改即可适应全局网络配置。然而，服务器需要高级网络。您从 `blue` 复制服务器配置，并将其更改为在 green.py 中使用高级网络属性。
- en: Listing 9.5 Adding premium networking to servers on the green network
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 9.5 向绿色网络上的服务器添加高级网络
- en: '[PRE5]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: ❶ Labels the new version of the network “green”
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 将新版本的“绿色”网络进行标记
- en: ❷ Creates a template for the server name, which includes the team, environment,
    and version (blue or green)
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 创建服务器名称模板，包括团队、环境和版本（蓝色或绿色）
- en: ❸ Uses the module to create the JSON configuration for the network, subnetwork,
    cluster, and server for the green network
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 使用模块创建网络、子网络、集群和绿色网络的 JSON 配置
- en: ❹ Builds the three servers on the green network with the cluster
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 在绿色网络上构建与集群相关的三个服务器
- en: ❺ Copies and pastes each server configuration. This code snippet features the
    first server, server0\. Other server configurations are omitted for clarity.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 复制并粘贴每个服务器配置。此代码片段展示了第一个服务器，server0。为了清晰起见，省略了其他服务器配置。
- en: ❻ Creates a small Google compute instance (server) by using a Terraform resource
    on the green network
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 使用绿色网络上的 Terraform 资源创建一个小型 Google 计算实例（服务器）
- en: ❼ Sets the network tier to use premium networking. This enables compatibility
    with the underlying subnet, which uses global routing.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: ❼ 设置网络层以使用高级网络。这使它与使用全局路由的底层子网兼容。
- en: AWS and Azure equivalents
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 等效
- en: If you convert listing 9.5 to AWS or Azure, the network tier does not apply.
    You can still update the code by changing the Google compute instance to an Amazon
    EC2 instance or Azure Linux virtual machine with an Ubuntu 18.04 image. You will
    need an Amazon VPC and Azure virtual network first.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 如果将列表 9.5 转换为 AWS 或 Azure，则网络层不适用。您仍然可以通过将 Google 计算实例更改为 Amazon EC2 实例或带有 Ubuntu
    18.04 映像的 Azure Linux 虚拟机来更新代码。首先您需要一个 Amazon VPC 和 Azure 虚拟网络。
- en: Updating the network tier to premium *should* not affect the functionality of
    the applications, although you don’t quite know! The green environment allows
    you to identify and mitigate any problems before affecting sundew growth. After
    the sundew team makes the updates, it pushes the changes and checks the test results
    in the delivery pipeline.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 将网络层更新为高级 *不应* 影响应用程序的功能，尽管您并不完全确定！绿色环境允许您在影响太阳草生长之前识别和缓解任何问题。在太阳草团队进行更新后，它将更改推送到交付管道并检查测试结果。
- en: The tests include unit, integration, and end-to-end testing to ensure that you
    can run the applications on the new container cluster and send requests to the
    new green servers. Fortunately, the tests pass, and you feel ready to send live
    traffic to the green resources.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 测试包括单元测试、集成测试和端到端测试，以确保您可以在新的容器集群上运行应用程序并向新的绿色服务器发送请求。幸运的是，测试通过了，您感觉准备好将实时流量发送到绿色资源。
- en: 9.2.3 Using a canary deployment to the green infrastructure
  id: totrans-145
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.2.3 使用金丝雀部署到绿色基础设施
- en: You could immediately send all traffic to the green network, servers, and cluster.
    However, you don’t want to bring down the sundew system! Ideally, you want to
    switch all traffic back to blue when you find a problem with your system. In figure
    9.7, you adjust the global load balancer to send 90% of traffic to the blue network
    and 10% of traffic to the services on the green network.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以立即将所有流量发送到绿色网络、服务器和集群。然而，您不希望关闭 sundew 系统！理想情况下，当您发现系统有问题时，您希望将所有流量切换回蓝色。在图
    9.7 中，您调整全局负载均衡器，将 90% 的流量发送到蓝色网络，并将 10% 的流量发送到绿色网络上的服务。
- en: '![](../../OEBPS/Images/CH09_F07_Wang.png)'
  id: totrans-147
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH09_F07_Wang.png)'
- en: Figure 9.7 Configure the global load balancer to run a canary test and send
    a small percentage of traffic to green resources.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 图 9.7 配置全局负载均衡器以运行金丝雀测试并向绿色资源发送少量流量。
- en: If this small amount of traffic sent to your system, known as a *canary deployment*,
    results in errors in requests, you need to debug and fix your changes.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 如果发送到您系统的少量流量（称为 *金丝雀部署*）导致请求错误，您需要调试和修复您的更改。
- en: Definition *Canary deployment* is a pattern that sends a small percentage of
    traffic to the updated resources in the system. If the requests complete successfully,
    you increase the percentage of traffic over time.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *金丝雀部署* 是一种模式，它将少量流量发送到系统中的更新资源。如果请求成功完成，您将随着时间的推移逐渐增加流量的百分比。
- en: Why send a small amount of traffic first? You do not want all of your requests
    failing. Sending a few requests to the updated resources helps identify critical
    problems before you affect your entire system.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么首先发送少量流量？您不希望所有请求都失败。向更新的资源发送少量请求有助于在影响整个系统之前识别关键问题。
- en: Canary in a coal mine
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 矿井中的金丝雀
- en: A *canary* in software or infrastructure serves as a first indicator of whether
    your new system, feature, or application will work. The term comes from the expression
    “canary in a coal mine.” Miners would bring caged birds with them into mines.
    If the mine had dangerous gas, the birds would serve as the first indicator.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 在软件或基础设施中，*金丝雀* 作为新系统、功能或应用程序是否工作的第一个指标。这个术语来自表达“矿井中的金丝雀”。
- en: You’ll often find references to canary testing in software development, which
    measures user experience for a new version of an application or feature. I highly
    recommend canary deployment, the technique of sending a small percentage of traffic
    to new resources, anytime you make significant infrastructure changes.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 您在软件开发中经常会发现对金丝雀测试的引用，它衡量应用程序或功能新版本的用户体验。我强烈推荐金丝雀部署，这是一种将少量流量发送到新资源的技术，您在做出重大基础设施更改时应该使用它。
- en: Note that you *do not* have to use load balancers to achieve a canary deployment.
    You can use any method to send a few requests to updated infrastructure resources.
    For example, you could add one updated application instance to an existing pool
    of three application instances. A round-robin load-balancing scheme sends about
    25% of your requests to the new, updated instance and 75% to old, existing application
    instances.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，您**不必**使用负载均衡器来实现金丝雀部署。您可以使用任何方法向更新的基础设施资源发送少量请求。例如，您可以将一个更新的应用程序实例添加到现有的三个应用程序实例池中。轮询负载均衡方案会将大约
    25% 的请求发送到新的、更新的实例，并将 75% 的请求发送到旧的、现有的应用程序实例。
- en: For the sundew team, you separate the global load balancer configuration away
    from the green and blue environments in your configuration. This improves the
    load balancer’s evolvability. You add the green servers as a separate backend
    service to the load balancer and control requests between green and blue environments.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 sundew 团队，您将全局负载均衡器配置与绿色和蓝色环境分开。这提高了负载均衡器的可扩展性。您将绿色服务器作为单独的后端服务添加到负载均衡器中，并控制绿色和蓝色环境之间的请求。
- en: You define the load balancer in a file named shared.py in the following listing.
    Let’s add the green version of the network (servers and cluster, too!) to the
    list of versioned environments with a weight of 10.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 您在以下列表中定义了名为 shared.py 的文件中的负载均衡器。让我们将网络的绿色版本（包括服务器和集群）添加到具有 10 个权重的版本化环境列表中。
- en: Listing 9.6 Adding a green version to the list of load-balancing services
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 9.6 将绿色版本添加到负载均衡服务列表中
- en: '[PRE6]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: ❶ Imports IaC for both blue and green environments
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 导入蓝色和绿色环境的 IaC
- en: ❷ Creates the name for the shared global load balancer based on the team and
    environment
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 根据团队和环境创建共享全局负载均衡器的名称
- en: ❸ Defines a list of versions for each environment to attach to the load balancer,
    blue and green environments
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 定义每个环境的版本列表，以便附加到负载均衡器，包括蓝色和绿色环境
- en: ❹ Adds the blue network, servers, and cluster to the load balancer list. Retrieves
    the availability zone of the blue environment from its IaC.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 将蓝色网络、服务器和集群添加到负载均衡器列表中。从其 IaC 中检索蓝色环境的可用区。
- en: ❺ Sets the weight of traffic to the blue server instances to 90, representing
    90% of requests
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 将流量权重设置为蓝色服务器实例的 90%，代表 90% 的请求
- en: ❻ Adds the green network, servers, and cluster to the load balancer list. Retrieves
    the availability zone of the green environment from its IaC.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: ❻ 将绿色网络、服务器和集群添加到负载均衡器列表中。从其 IaC 中检索绿色环境的可用区。
- en: ❼ Sets the weight of traffic to the green server instances to 10, representing
    10% of requests
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 将流量权重设置为绿色服务器实例的 10%，代表 10% 的请求
- en: ❽ Creates a function to generate a list of backend services for a load balancer
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: ❽ 创建一个函数以生成负载均衡器的后端服务列表
- en: ❾ For each environment, defines a Google load-balancing backend service with
    a version and weight
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: ❾ 对于每个环境，定义一个具有版本和权重的 Google 负载均衡后端服务
- en: AWS and Azure equivalents
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 的等效功能
- en: The backend services in listing 9.6 are similar to an AWS target group for an
    AWS ALB. However, Azure requires additional resources. You will need to create
    an Azure Traffic Manager profile and endpoint to the backend address pool attached
    to the Azure Application Gateway.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 9.6 中的后端服务类似于 AWS ALB 的 AWS 目标组。然而，Azure 需要额外的资源。您需要创建 Azure Traffic Manager
    配置文件和端点，并将其链接到附加到 Azure Application Gateway 的后端地址池。
- en: The load balancer in shared.py already accepts a list of backend services with
    differing weights. Once you deploy the list of weights and services in the following
    listing, the load balancer configuration starts sending 10% of traffic to the
    green network.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: shared.py 中的负载均衡器已经可以接受具有不同权重的后端服务列表。一旦您在以下列表中部署了权重和服务列表，负载均衡器配置开始将 10% 的流量发送到绿色网络。
- en: Listing 9.7 Updating the load balancer to send traffic to green
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 9.7 更新负载均衡器以将流量发送到绿色环境
- en: '[PRE7]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: ❶ Sends all traffic from the load balancer to the blue environment by default
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 默认将所有流量从负载均衡器发送到蓝色环境
- en: ❷ Uses the module to create the JSON configuration for the load balancer to
    send 10% of traffic to green and 90% of traffic to blue
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 使用该模块创建负载均衡器的 JSON 配置，以将 10% 的流量发送到绿色，90% 的流量发送到蓝色
- en: ❸ Creates the Google compute URL map (load-balancing rule) by using a Terraform
    resource based on the path, blue and green environments, and weight
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 使用基于路径、蓝色和绿色环境以及权重的 Terraform 资源创建 Google 计算URL映射（负载均衡规则）
- en: ❹ Sets routing rules on the load balancer to send 10% of traffic to green and
    90% of traffic to blue.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 在负载均衡器上设置路由规则，将 10% 的流量发送到绿色，90% 的流量发送到蓝色。
- en: AWS and Azure equivalents
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 的等效功能
- en: The Google Cloud URL map is similar to an AWS ALB or Azure Traffic Manager and
    Application Gateway. To convert listing 9.7 to AWS, you will need to update the
    resource to create an AWS ALB and listener rule. Then, add path routing and weight
    attributes to the ALB listener rule.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: Google Cloud URL 映射类似于 AWS ALB 或 Azure Traffic Manager 和 Application Gateway。要将列表
    9.7 转换为 AWS，您需要更新资源以创建 AWS ALB 和监听器规则。然后，向 ALB 监听器规则添加路径路由和权重属性。
- en: For Azure, you will need to link an Azure Traffic Manager profile and endpoint
    to an Azure Application Gateway. Update the Azure Traffic Manager with weights
    and route them to the correct backend address pool attached to an Azure Application
    Gateway.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 Azure，您需要将 Azure Traffic Manager 配置文件和端点链接到 Azure Application Gateway。更新
    Azure Traffic Manager，使用权重并将它们路由到附加到 Azure Application Gateway 的正确后端地址池。
- en: You run Python in listing 9.8 to build the Terraform JSON configuration for
    review. The JSON configuration for the load balancer includes the instance groups
    that organize the blue servers and green servers, backend services to target the
    blue and green instances’ groups, and the weighted routing actions.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 您在列表 9.8 中运行 Python 以构建用于审查的 Terraform JSON 配置。负载均衡器的 JSON 配置包括组织蓝色服务器和绿色服务器的实例组、针对蓝色和绿色实例组的后端服务以及加权路由操作。
- en: Listing 9.8 JSON configuration for the load balancer
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 9.8 负载均衡器的 JSON 配置
- en: '[PRE8]'
  id: totrans-183
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: ❶ Defines the Google compute URL map (load-balancing rule) using a Terraform
    resource based on the path, blue and green environments, and weight
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 使用基于路径、蓝色和绿色环境以及权重的 Terraform 资源定义 Google 计算URL映射（负载均衡规则）
- en: ❷ Defines the default service for the Google compute URL map (load-balancing
    rule) to the blue environment
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 为Google计算URL映射（负载均衡规则）定义默认服务为蓝色环境
- en: ❸ Sends all requests to the blue or green environments based on weight
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 根据权重将所有请求发送到蓝色或绿色环境
- en: ❹ Sends 90% of traffic to blue backend services, which use the blue network
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 将90%的流量发送到使用蓝色网络的蓝色后端服务
- en: ❺ Sends 10% of traffic to green backend services, which use the green network
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: ❺ 将10%的流量发送到使用绿色网络的绿色后端服务
- en: Why send all traffic by default to the blue environment? You know the blue environment
    processes requests successfully. If your green environment breaks, you can quickly
    switch the load balancer to send traffic to the default blue environment.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么默认将所有流量发送到蓝色环境？你知道蓝色环境可以成功处理请求。如果你的绿色环境出现问题，你可以快速切换负载均衡器，将流量发送到默认的蓝色环境。
- en: In general, copy, paste, and update the `green` resources. If you express the
    `blue` resources in a module, you need to change only the attributes passed to
    the module. I separate the green and blue environment definitions in separate
    folders or files, when possible. This makes it easier to identify the environments
    later.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，复制、粘贴并更新`green`资源。如果您在模块中表达`blue`资源，您只需更改传递给模块的属性。在可能的情况下，我将绿色和蓝色环境定义分开在单独的文件夹或文件中，这使得以后更容易识别环境。
- en: You may notice some Python code in shared.py that makes it easier to evolve
    the list of environments and the default environment attached to the load balancer.
    I usually define a list of environments and a variable for the default environment.
    Then, I iterate over the list of environments and attach the attributes to a load
    balancer. This ensures that the high-level load balancer can evolve to accommodate
    the different resources and environments.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 您可能会注意到在shared.py中的一些Python代码，这些代码使得更容易进化环境列表和附加到负载均衡器的默认环境。我通常定义一个环境列表和一个默认环境变量。然后，我遍历环境列表，并将属性附加到一个负载均衡器上。这确保了高级负载均衡器可以进化以适应不同的资源和环境。
- en: As you add new resources, you can adjust your load balancer to send traffic
    to additional environments. You may find yourself updating your load balancer’s
    IaC each time you want to run a blue-green deployment. Taking the time and effort
    to configure the load balancer helps mitigate any problems from changes and controls
    the rollout of potentially disruptive updates.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 当您添加新资源时，您可以调整您的负载均衡器以将流量发送到额外的环境。您可能会发现自己每次想要运行蓝绿部署时都要更新负载均衡器的IaC。花时间和精力配置负载均衡器有助于减轻更改带来的任何问题，并控制可能具有破坏性的更新的发布。
- en: 9.2.4 Performing regression testing
  id: totrans-193
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.2.4 执行回归测试
- en: If you immediately send all traffic to the green network and it fails, you could
    disrupt the watering system for the Cape sundews. As a result, you start with
    a canary deployment and increase the ratio of traffic to the green network by
    10% each day. The process takes about two weeks, but you feel confident that you
    updated the network correctly! If you find a problem, you reduce traffic to the
    green network and debug.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您立即将所有流量发送到绿色网络并且它失败了，您可能会破坏开普敦捕蝇草的灌溉系统。因此，您从金丝雀部署开始，每天将发送到绿色网络的流量比例增加10%。这个过程大约需要两周时间，但您对自己更新网络的正确性感到自信！如果您发现问题，您会减少发送到绿色网络的流量并调试。
- en: Figure 9.8 shows your gradual process of increasing traffic and testing the
    green environment over time. You gradually decrease traffic to the blue environment
    until it reaches 0%. You inversely increase traffic to the green environment until
    it reaches 100%. You run the green environment for a week or two before disabling
    the blue network just in case the change broke the system in the green environment.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.8显示了您逐渐增加流量并在一段时间内测试绿色环境的过程。您逐渐减少发送到蓝色环境的流量，直到达到0%。然后，您反向增加发送到绿色环境的流量，直到达到100%。在禁用蓝色网络之前，您运行绿色环境一周或两周，以防更改破坏了绿色环境中的系统。
- en: '![](../../OEBPS/Images/CH09_F08_Wang.png)'
  id: totrans-196
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH09_F08_Wang.png)'
- en: Figure 9.8 Allow a week for a regression test before cutting all traffic to
    the new network and removing the old one, which allows for time to verify functionality.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.8在切断所有流量到新网络并移除旧网络之前，允许一周时间进行回归测试，这为验证功能提供了时间。
- en: The process of gradually increasing traffic and waiting a week before proceeding
    seems so painful! However, you need to allow the system to run enough traffic
    through the green environment to determine if you can proceed. Some failures appear
    with only enough traffic through the system, while others take time to detect.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 逐渐增加流量并在一周前进行的过程似乎很痛苦！然而，您需要让系统通过绿色环境运行足够的流量以确定是否可以继续。一些故障仅在系统通过足够的流量时出现，而其他故障则需要时间来检测。
- en: The window of time you spend testing, observing, and monitoring the system for
    errors becomes part of a regression test for the system. *Regression testing*
    checks whether changes to the system affect existing or new functionality. Gradually
    increasing the traffic over time allows you to assess the system’s functionality
    while mitigating the potential failure impact.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 您花费在测试、观察和监控系统错误的时间窗口成为系统回归测试的一部分。*回归测试* 检查系统更改是否影响现有或新功能。随着时间的推移逐渐增加流量允许您评估系统的功能，同时减轻潜在的失败影响。
- en: Definition *Regression testing* checks whether changes to the system affect
    existing or new functionality.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *回归测试* 检查系统更改是否影响现有或新功能。
- en: How much should you increase traffic to the green environment? Increasing traffic
    by 1% each day does not provide much information unless your system serves millions
    of requests. *Gradual* doesn’t offer clear criteria on which increments you should
    use. I recommend assessing the number of requests your system serves daily and
    the cost of failure (such as errors on user requests).
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该增加多少流量到绿色环境？每天增加1%的流量不会提供太多信息，除非您的系统每天处理数百万个请求。*逐渐增加*并没有提供明确的增量标准。我建议评估您系统每天处理的请求数量和失败的成本（例如用户请求上的错误）。
- en: I usually start with increments of 10% and check how many requests that means
    for the system. If I do not get a sufficient sample size of requests to identify
    failures, I increase the increment. You want to insert a regression-testing window
    between each percentage increase to identify system failures.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 我通常从10%的增量开始，并检查这对系统意味着多少请求。如果我没有获得足够的请求样本量来识别失败，我会增加增量。您希望在每次百分比增加之间插入一个回归测试窗口以识别系统故障。
- en: Even after increasing the load balancer to send all the traffic to the green
    network, you still want to keep running tests and monitor system functionality
    for a week or two. Why run regression tests for a few weeks? Sometimes you might
    encounter edge cases from application requests that break functionality. By allowing
    a period for regression tests, you can observe whether the system can handle unexpected
    or uncommon payloads or requests.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 即使将负载均衡器增加到将所有流量发送到绿色网络，您仍然希望运行测试并监控系统功能一周或两周。为什么运行几周的回归测试？有时您可能会遇到来自应用程序请求的边缘情况，这会破坏功能。通过允许进行回归测试的期间，您可以观察系统是否可以处理意外或不常见的负载或请求。
- en: 9.2.5 Deleting the blue infrastructure
  id: totrans-204
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.2.5 删除蓝色基础设施
- en: You observe the sundew system for two weeks and resolve any errors. You know
    that the blue network has not processed any requests or data for about two weeks,
    which means you can remove it without additional migration steps. You confirm
    the inactivity with a peer or change advisory board review. Figure 9.9 updates
    the default service to the green environment before deleting the blue environment
    from IaC.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 您观察捕蝇草系统两周并解决任何错误。您知道蓝色网络大约两周内没有处理任何请求或数据，这意味着您可以在不进行额外迁移步骤的情况下将其删除。您通过与同伴或变更咨询委员会审查来确认其不活跃状态。在从IaC中删除蓝色环境之前，图9.9更新了默认服务到绿色环境。
- en: '![](../../OEBPS/Images/CH09_F09_Wang.png)'
  id: totrans-206
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH09_F09_Wang.png)'
- en: Figure 9.9 Decommission the old network by deleting it from IaC and removing
    all references.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.9 通过从IaC中删除它并移除所有引用来退役旧网络。
- en: I consider deleting the blue environment with the network a major change that
    requires additional peer review. You may not know who uses the network. Other
    resources that you do not share with other teams, like servers, may not need additional
    peer review or change approval. Assess the potential impact of deleting an environment
    and categorize the change based on patterns in chapter 7\. Let’s adjust the load
    balancer in shared.py by setting the default service to the green network and
    removing the blue network from its backend services, as shown in the following
    listing.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 我认为删除带有网络的蓝色环境是一个重大的变更，需要额外的同行审查。你可能不知道谁在使用该网络。其他你不会与其他团队共享的资源，如服务器，可能不需要额外的同行审查或变更批准。评估删除环境的潜在影响，并根据第
    7 章中的模式对变更进行分类。让我们通过将默认服务设置为绿色网络并从其后端服务中删除蓝色网络来调整 shared.py 中的负载均衡器，如下所示。
- en: Listing 9.9 Removing the blue environment load balancer
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 9.9 删除蓝色环境负载均衡器
- en: '[PRE9]'
  id: totrans-210
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: ❶ Imports IaC for both blue and green environments
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 导入蓝色和绿色环境的 IaC
- en: ❷ Changes the default version of the network for the load balancer to green
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 将负载均衡器的网络默认版本更改为绿色
- en: ❸ Removes the blue network and instances from the list of backend services to
    generate
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 从要生成的后端服务列表中删除蓝色网络和实例
- en: ❹ Sends all traffic to the green network
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: ❹ 将所有流量发送到绿色网络
- en: AWS and Azure equivalents
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: AWS 和 Azure 等效物
- en: Listing 9.9 stays the same for AWS and Azure. You will want to map the version,
    availability zone, name, and weight to the AWS ALB or Azure Traffic Manager.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 9.9 在 AWS 和 Azure 中保持不变。你将需要将版本、可用区、名称和权重映射到 AWS ALB 或 Azure Traffic Manager。
- en: You apply the changes to the load balancer. However, you do *not* delete the
    blue resources immediately because you must ensure that the load balancer does
    not reference any blue resources. After testing the changes, you remove the code
    to build the blue environment from main.py and leave the green environment, as
    follows.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 你将更改应用到负载均衡器。然而，你**不**立即删除蓝色资源，因为你必须确保负载均衡器不引用任何蓝色资源。在测试更改后，你从 main.py 中删除构建蓝色环境的代码，并保留绿色环境，如下所示。
- en: Listing 9.10 Removing the blue environment from main.py
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 9.10 从 main.py 中删除蓝色环境
- en: '[PRE10]'
  id: totrans-219
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: ❶ Uses the shared module to create the JSON configuration for the global load
    balancer
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: ❶ 使用共享模块创建全局负载均衡器的 JSON 配置
- en: ❷ Uses the green module to create the JSON configuration for the network with
    global routing, servers with premium networking, and the cluster
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: ❷ 使用绿色模块创建具有全局路由、带高级网络的服务器和集群的网络的 JSON 配置
- en: ❸ Writes the Python dictionary out to a JSON file to be executed by Terraform
    later
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: ❸ 将 Python 字典写入 JSON 文件，供 Terraform 后续执行
- en: You apply the changes, and your IaC tool deletes all blue resources. You decide
    to delete the blue.py file to prevent anyone from creating new blue resources.
    I recommend removing any files you do not use to reduce confusion for your teammates
    in the future. Otherwise, you may have a system with more resources than you need.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 你应用了更改，你的 IaC 工具删除了所有蓝色资源。你决定删除 blue.py 文件，以防止任何人创建新的蓝色资源。我建议删除你不再使用的任何文件，以减少未来队友的困惑。否则，你可能会拥有比你需要的更多资源的系统。
- en: Exercise 9.1
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 练习 9.1
- en: 'Consider the following code:'
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑以下代码：
- en: '[PRE11]'
  id: totrans-226
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: The queue depends on the network. The server depends on the network and queue.
    How would you run a blue-green deployment to upgrade the queue with SSL?
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 队列依赖于网络。服务器依赖于网络和队列。你将如何运行蓝绿部署以升级带有 SSL 的队列？
- en: See appendix B for answers to exercises.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 请参阅附录 B 以获取练习答案。
- en: 9.2.6 Additional considerations
  id: totrans-229
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.2.6 其他考虑事项
- en: Imagine the sundew team needs to change the network again. Instead of creating
    a new green network, the team can create a new blue network and repeat the deployment,
    regression test, and deletion process! Since the old blue network no longer exists,
    this update does not conflict with an existing environment.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 假设 sundew 团队需要再次更改网络。而不是创建一个新的绿色网络，团队可以创建一个新的蓝色网络并重复部署、回归测试和删除过程！由于旧的蓝色网络不再存在，这次更新不会与现有环境冲突。
- en: What you name your versions or iterations of changes does not matter, as long
    as you differentiate between old and new resources. For networking specifically,
    you consider allocating two sets of IP address ranges. You should permanently
    reserve one for the blue network and the other for the green network. The allocation
    will allow you the flexibility to make changes by using blue-green deployment
    without the need to search for open network space.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 您为更改的版本或迭代命名的内容并不重要，只要您能够区分新旧资源即可。对于网络而言，您可以考虑分配两组 IP 地址范围。您应该永久保留一组用于蓝色网络，另一组用于绿色网络。这种分配将允许您通过使用蓝绿部署来灵活地做出更改，而无需寻找开放的网络安全空间。
- en: 'In general, I decide to use a blue-green deployment strategy when I encounter
    the following:'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，当我遇到以下情况时，我会决定使用蓝绿部署策略：
- en: Reverting changes to the resource takes a long time.
  id: totrans-233
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 回滚资源更改需要很长时间。
- en: I am not confident that I can revert changes to the resource after deployment.
  id: totrans-234
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我不确定我能否在部署后回滚资源更改。
- en: The resource has many high-level dependencies that I cannot easily identify.
  id: totrans-235
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 资源有许多我难以轻易识别的高级依赖项。
- en: The resource change affects critical applications that cannot have downtime.
  id: totrans-236
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 资源更改会影响不能停机的时间关键应用程序。
- en: Not all infrastructure resources should use blue-green deployment. For example,
    you can update IAM policies in place and quickly revert them if you identify a
    problem. You’ll learn more about reverting changes in chapter 11.
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 并非所有基础设施资源都应该使用蓝绿部署。例如，您可以就地更新 IAM 策略，并在发现问题时快速回滚。您将在第 11 章中了解更多关于回滚更改的内容。
- en: A blue-green deployment strategy costs less in time and money than maintaining
    multiple environments. However, this strategy will cost *more* when you have to
    deploy low-level infrastructure resources like networks, projects, or accounts!
    I usually consider the pattern worth the cost. It isolates the change to specific
    resources and provides a lower-risk methodology for deploying changes and minimizing
    disruption to systems.
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 蓝绿部署策略在时间和金钱上比维护多个环境成本更低。然而，当您必须部署像网络、项目或账户这样的低级基础设施资源时，这种策略将**更贵**！我通常认为这种模式值得成本。它将更改隔离到特定资源，并为部署更改和最小化系统中断提供一种风险较低的方法。
- en: 9.3 Stateful infrastructure
  id: totrans-239
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 9.3 有状态基础设施
- en: Throughout this chapter, the example omitted an essential class of infrastructure
    resources. However, the sundew system includes numerous resources that process,
    manage, and store data. For example, the sundew system includes a Google SQL database
    running on a network with regional routing.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，示例省略了一个重要的基础设施资源类别。然而，捕蝇草系统包括许多处理、管理和存储数据的资源。例如，捕蝇草系统包括一个在具有区域路由的网络上运行的
    Google SQL 数据库。
- en: 9.3.1 Blue-green deployment
  id: totrans-241
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.3.1 蓝绿部署
- en: The sundew application team members remind you that they need to update their
    database to use the new network with global routing. You update the private network
    ID in IaC and push the changes to your repository. Your deployment pipeline fails
    on a compliance test (something you learned about in chapter 8).
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 捕蝇草应用程序团队成员提醒您，他们需要更新数据库以使用具有全局路由的新网络。您在 IaC 中更新私有网络 ID 并将更改推送到您的仓库。您的部署管道在合规性测试（您在第
    8 章中学到的）中失败。
- en: 'You notice that the test checks the dry run (plan) for whether the database
    deletions have failed:'
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 您注意到测试检查了干运行（计划）是否失败，以确定数据库删除操作：
- en: '[PRE12]'
  id: totrans-244
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: The compliance test prevents you from deleting a critical database! If you applied
    the change without the test, you would delete *all* of the sundew data! The sundew
    team raises concerns about updating the database’s network in place, so you need
    to do a blue-green deployment.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 合规性测试阻止您删除关键数据库！如果您在没有测试的情况下应用更改，您将删除**所有**的捕蝇草数据！捕蝇草团队对在原地更新数据库的网络表示担忧，因此您需要进行蓝绿部署。
- en: In figure 9.10, you manually verify that you can migrate the database to the
    green network. However, you discover you cannot migrate the database. The sundew
    system can accommodate for missing data, so you copy the IaC for the blue database
    and create a new green database instance in the premium network. After migrating
    the data from the blue to the green database, you switch applications to use the
    new database and remove the old one.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 在图 9.10 中，您手动验证是否可以将数据库迁移到绿色网络。然而，您发现无法迁移数据库。捕蝇草系统可以处理缺失的数据，因此您复制蓝色数据库的 IaC
    并在高级网络中创建一个新的绿色数据库实例。在将数据从蓝色数据库迁移到绿色数据库后，您切换应用程序以使用新的数据库，并删除旧的数据库。
- en: '![](../../OEBPS/Images/CH09_F10_Wang.png)'
  id: totrans-247
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH09_F10_Wang.png)'
- en: Figure 9.10 If you can’t update the database in place, you must deploy a new
    green database, migrate and reconcile the data, and change the database endpoint
    from blue to green.
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.10 如果你无法就地更新数据库，你必须部署一个新的绿色数据库，迁移和协调数据，并将数据库端点从蓝色更改为绿色。
- en: The blue-green deployment strategy applies to the database, a class of infrastructure
    resource that focuses on state. *Stateful* infrastructure resources like the database
    store and manage data. In reality, all applications process and store some amount
    of data. However, stateful infrastructure requires additional care because changes
    can directly affect data. This type of infrastructure includes databases, queues,
    caches, or stream-processing tools.
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: 蓝绿部署策略适用于数据库，这是一类关注状态的底层基础设施资源。*有状态的*基础设施资源，如数据库，存储和管理数据。实际上，所有应用程序都会处理和存储一定量的数据。然而，有状态的基础设施需要额外的关注，因为变化可能会直接影响到数据。这类基础设施包括数据库、队列、缓存或流处理工具。
- en: Definition *Stateful* infrastructure describes infrastructure resources that
    store and manage data.
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 定义 *有状态的* 基础设施描述的是存储和管理数据的底层基础设施资源。
- en: Why use a blue-green deployment for infrastructure resources with data? Sometimes
    you cannot update the resource in place with IaC. Replacing the resource may corrupt
    or lose data, which affects your applications. A blue-green deployment helps you
    test the functionality of your new database before your applications use it.
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么要在具有数据的底层基础设施上使用蓝绿部署？有时你无法使用IaC就地更新资源。替换资源可能会损坏或丢失数据，这会影响你的应用程序。蓝绿部署可以帮助你在应用程序使用之前测试新数据库的功能。
- en: 9.3.2 Update delivery pipeline
  id: totrans-252
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.3.2 更新交付管道
- en: Let’s return to the sundew team. You must fix the delivery pipeline to automate
    the update for the database. In figure 9.11, you update your delivery pipeline
    with a step that automatically migrates data from the blue to the green database.
    When you add the green database and deploy it, your pipeline deploys the new database,
    runs integration tests, automatically migrates data from the blue to the green
    database, and completes the pipeline with end-to-end tests.
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们回到捕蝇草团队。你必须修复交付管道以自动化数据库的更新。在图9.11中，你通过添加一个步骤来更新你的交付管道，该步骤会自动将数据从蓝色数据库迁移到绿色数据库。当你添加绿色数据库并部署它时，你的管道会部署新的数据库，运行集成测试，自动将数据从蓝色迁移到绿色数据库，并通过端到端测试完成管道。
- en: Preserve *idempotency* with the automation for your migration step. Your script
    or automation for migration should result in the same database state each time.
    It should avoid duplicating data each time you run the automation. The data migration
    process differs depending on the kind of stateful infrastructure you have (database,
    queue, cache, or stream-processing tools).
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: 在自动化迁移步骤时保持*幂等性*。你的迁移脚本或自动化工具应该每次都产生相同的数据库状态。它应该避免在每次运行自动化时重复数据。数据迁移过程取决于你所拥有的有状态基础设施的类型（数据库、队列、缓存或流处理工具）。
- en: '![](../../OEBPS/Images/CH09_F11_Wang.png)'
  id: totrans-255
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH09_F11_Wang.png)'
- en: Figure 9.11 The infrastructure deployment pipeline should add the green database
    and copy data from blue to green.
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.11 基础设施部署管道应该添加绿色数据库并将数据从蓝色复制到绿色。
- en: Note You can dedicate entire books to migrating and managing stateful infrastructure
    with minimal (or zero) downtime. I recommend *Database Reliability Engineering*
    by Laine Campbell and Charity Majors (O’Reilly, 2017) for other patterns and practices
    on managing databases. You can refer to specific documentation on migration, upgrading,
    and availability for other stateful infrastructure resources.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: 注意 你可以写整本书来介绍如何迁移和管理有状态的基础设施，同时尽量减少（或零）停机时间。我推荐Laine Campbell和Charity Majors的《数据库可靠性工程》（O’Reilly，2017），其中包含其他关于管理数据库的模式和实践。你可以参考其他有状态基础设施资源迁移、升级和可用性的具体文档。
- en: Depending on how often you update your stateful infrastructure, you should capture
    the automated data migration to your deployment pipelines and *not* within your
    IaC. Separating data migration allows you to change any steps and debug problems
    with the migration independent of creating and removing the stateful resources.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 根据你更新有状态基础设施的频率，你应该将自动化的数据迁移捕获到你的部署管道中，而不是在IaC中。分离数据迁移允许你更改任何步骤并独立于创建和删除有状态资源来调试迁移问题。
- en: 9.3.3 Canary deployment
  id: totrans-259
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 9.3.3 金丝雀部署
- en: To complete the database update for the sundew team, you make changes to application
    configuration to use the green database. As high-level resources, the applications
    depend on the database like a load balancer sends traffic to servers. You can
    use a modified form of canary deployment to cut over to the new database.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 要完成捕蝇草团队的数据库更新，你需要更改应用配置以使用绿色数据库。作为高级资源，应用依赖于数据库，就像负载均衡器将流量发送到服务器一样。你可以使用修改后的金丝雀部署形式切换到新数据库。
- en: Figure 9.12 shows the pattern of regression testing and configuring the application
    to use the database. After a period of regression testing (to ensure that functionality
    still works), you update the application to *write* data exclusively to the green
    database. After another period of regression testing, you update the application
    to *read* data from the green database.
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.12显示了回归测试的模式以及配置应用以使用数据库。经过一段时间的回归测试（以确保功能仍然正常），你更新应用以*写入*数据到绿色数据库。经过另一段时间的回归测试后，你更新应用以从绿色数据库*读取*数据。
- en: '![](../../OEBPS/Images/CH09_F12_Wang.png)'
  id: totrans-262
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH09_F12_Wang.png)'
- en: Figure 9.12 You incrementally update the application deployment pipeline to
    write to both databases, write to the green database, and then read from the green
    database.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.12 你逐步更新应用部署管道以写入两个数据库，写入绿色数据库，然后从绿色数据库读取。
- en: You incrementally roll out the changes to the application to revert to the blue
    database if you encounter an issue. Since the application writes to two databases,
    you may have to write additional automation to reconcile data. However, writing
    to new stateful infrastructure ensures that you test any critical functionality
    related to storing and updating data. Only then can applications properly read
    and process data.
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你在应用中遇到问题，可以逐步推出更改以恢复到蓝色数据库。由于应用写入两个数据库，你可能需要编写额外的自动化脚本来协调数据。然而，写入新的有状态基础设施确保你可以测试与存储和更新数据相关的任何关键功能。只有在这种情况下，应用才能正确读取和处理数据。
- en: '![](../../OEBPS/Images/CH09_F13_Wang.png)'
  id: totrans-265
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH09_F13_Wang.png)'
- en: Figure 9.13 Delete the blue database by removing it from IaC and pushing the
    changes into your deployment pipeline.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.13 通过从IaC中删除蓝色数据库并将其推送到部署管道中来删除蓝色数据库。
- en: Now that the sundew applications use the green database, figure 9.13 removes
    the blue database by deleting it from the IaC. Note that the compliance tests
    will fail when you remove the database because you deleted a database! You update
    the test to fail if you plan on deleting a green database and not a blue one.
    The manual override allows you to remove the blue database since applications
    no longer use it.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，由于捕蝇草应用使用绿色数据库，图9.13通过从IaC中删除它来删除蓝色数据库。请注意，当你删除数据库时，合规性测试将失败，因为你删除了一个数据库！如果你计划删除绿色数据库而不是蓝色数据库，请更新测试以失败。手动覆盖允许你删除蓝色数据库，因为应用不再使用它。
- en: Techniques like canary deployment provide rapid feedback to mitigate the impact
    of failure, especially in a situation involving data processing. It can mean the
    difference between fixing a few wrong entries in a database versus restoring it
    entirely from backup! I get a sense of comfort knowing that I am making changes
    to stateful infrastructure in an isolated green environment instead of the live
    production system.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 像金丝雀部署这样的技术可以提供快速反馈以减轻失败的影响，尤其是在涉及数据处理的情况中。它可能意味着在数据库中修复几个错误条目与从备份中完全恢复数据库之间的区别！我知道我在一个隔离的绿色环境中对有状态基础设施进行更改，而不是在实时生产系统中，这让我感到安心。
- en: Strategies using immutability like blue-green deployment offer a structured
    process to make changes and minimize the blast radius of potential failures. Thanks
    to the principle of reproducibility, you can typically use an immutable approach
    for changing IaC by duplicating and editing configuration. The principle also
    allows you to improve the redundancy of your infrastructure system with a similar
    process of duplication.
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 使用不可变性（如蓝绿部署）的策略提供了一个结构化的过程来做出更改并最小化潜在失败的影响范围。多亏了可重复性原则，你通常可以通过复制和编辑配置来使用不可变方法更改IaC。该原则还允许你通过类似的过程提高基础设施系统的冗余性。
- en: Summary
  id: totrans-270
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: Ensure that your system has testing, monitoring, and observability for infrastructure
    and applications before starting any infrastructure updates.
  id: totrans-271
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在开始任何基础设施更新之前，确保你的系统具有基础设施和应用的测试、监控和可观察性。
- en: Redundancy in IaC means adding extra, idle resources to the configuration so
    you can fail over in case of component failure.
  id: totrans-272
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在IaC中的冗余意味着向配置中添加额外的空闲资源，以便在组件故障时进行故障转移。
- en: Adding redundant configuration to IaC can improve system reliability, measuring
    how long a system performs correctly over a certain period of time.
  id: totrans-273
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 向基础设施即代码（IaC）中添加冗余配置可以提高系统可靠性，衡量系统在一定时期内正确运行的时间。
- en: An active-passive configuration includes an active environment serving requests
    and a duplicate idle environment for when the active environment fails.
  id: totrans-274
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 主动-被动配置包括一个主动环境处理请求，以及当主动环境失败时用于替换的重复空闲环境。
- en: Failover switches traffic from a failing active environment to an idle passive
    environment.
  id: totrans-275
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 故障转移将流量从失败的主动环境切换到空闲的被动环境。
- en: An active-active configuration sets two active environments serving requests,
    both of which you can duplicate and manage with IaC.
  id: totrans-276
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 主动-主动配置设置两个主动环境来处理请求，这两个环境都可以使用IaC进行复制和管理。
- en: Blue-green deployment creates a new subset of infrastructure resources that
    stages the changes you want to make and gradually switches requests to the new
    subset. You can then remove the old set of resources.
  id: totrans-277
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 蓝绿部署创建了一个新的基础设施资源子集，用于阶段性地实施您想要进行的更改，并逐渐将请求切换到新的子集。然后您可以删除旧的资源集。
- en: In a blue-green deployment, deploy the resource you want to change and the high-level
    resources that depend on it.
  id: totrans-278
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在蓝绿部署中，部署您想要更改的资源以及依赖于它的顶级资源。
- en: Canary deployment sends a small percentage of traffic to the new infrastructure
    resources to verify whether the system works correctly. Over time, you increase
    the percentage of traffic.
  id: totrans-279
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 金丝雀部署将一小部分流量发送到新的基础设施资源，以验证系统是否正确工作。随着时间的推移，您会增加流量的百分比。
- en: Allow a few weeks for regression testing to check whether changes to the system
    affect existing or new functionality.
  id: totrans-280
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 给出几周的时间进行回归测试，以检查系统更改是否影响现有或新的功能。
- en: Stateful infrastructure resources—like databases, caches, queues, and stream-processing
    tools—store and manage data.
  id: totrans-281
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 有状态基础设施资源——如数据库、缓存、队列和流处理工具——存储和管理数据。
- en: Add a migration step to the blue-green deployment of stateful infrastructure
    resources. You must copy data between blue and green stateful infrastructure.
  id: totrans-282
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将迁移步骤添加到有状态基础设施资源的蓝绿部署中。您必须在蓝色和绿色有状态基础设施之间复制数据。
