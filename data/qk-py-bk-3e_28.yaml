- en: Case study
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 案例研究
- en: In this case study, you walk through using Python to fetch some data, clean
    it, and then graph it. This project may be a short one, but it combines several
    features of the language I’ve discussed, and it gives you a chance to a see a
    project worked through from beginning to end. At almost every step, I briefly
    call out alternatives and enhancements that you can make.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个案例研究中，你将使用Python获取一些数据，清理它，然后绘制图表。这个项目可能是一个短项目，但它结合了我所讨论的语言的几个特性，并给你一个从头到尾完成项目的机会。在几乎每一个步骤中，我都会简要指出你可以做出的替代方案和改进。
- en: Global temperature change is the topic of much discussion, but those discussions
    are based on a global scale. Suppose that you want to know what the temperatures
    have been doing near where you are. One way of finding out is to get historical
    data for your location, process that data, and plot it to see exactly what’s been
    happening.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 全球温度变化是许多讨论的主题，但这些讨论都是基于全球规模的。假设你想知道你所在地区的温度变化情况。一种了解的方法是获取你所在位置的历史数据，处理这些数据，并绘制图表以查看确切发生了什么。
- en: '|  |'
  id: totrans-3
  prefs: []
  type: TYPE_TB
  zh: '|'
- en: '**Getting the case study code**'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: '**获取案例研究代码**'
- en: The following case study was done by using a Jupyter notebook, as explained
    in [chapter 24](kindle_split_037.html#ch24). If you’re using Jupyter, you can
    find the notebook I used (with this text and code) in the source code downloads
    as `Case Study.ipynb`. You can also execute the code in a standard Python shell,
    and a version that supports that shell is in the source code as `Case Study.py`.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 以下案例研究是通过使用Jupyter笔记本完成的，如第24章所述。[第24章](kindle_split_037.html#ch24)。如果你使用Jupyter，你可以在源代码下载中找到我使用的笔记本（包含此文本和代码），作为`Case
    Study.ipynb`。你还可以在标准的Python shell中执行代码，支持该shell的版本在源代码中作为`Case Study.py`。
- en: '|  |'
  id: totrans-6
  prefs: []
  type: TYPE_TB
  zh: '|  |'
- en: Fortunately, several sources of historical weather data are freely available.
    I’m going to walk you through using data from the Global Historical Climatology
    Network, which has data from around the world. You may find other sources, which
    may have different data formats, but the steps and the processes I discuss here
    should be generally applicable to any data set.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 幸运的是，有几个历史天气数据来源是免费提供的。我将带你通过使用全球历史气候网络的数据，这个网络拥有来自世界各地的数据。你可能还会找到其他来源，它们可能具有不同的数据格式，但我在这里讨论的步骤和过程应该适用于任何数据集。
- en: Downloading the data
  id: totrans-8
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 下载数据
- en: The first step will be to get the data. An archive of daily historical weather
    data at [https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/](https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/)
    has a wide array of data. The first step is to figure out which files you want
    and exactly where they are; then you download them. When you have the data, you
    can move on to processing and ultimately displaying your results.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 第一步将是获取数据。在[https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/](https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/)的存档中有大量的每日历史天气数据。第一步是确定你想要哪些文件以及它们的确切位置；然后下载它们。当你有了数据后，你可以继续处理，最终显示你的结果。
- en: 'To download the files, which are accessible via HTTPS, you need the `requests`
    library. You can get `requests` with `pip install requests` at the command prompt.
    When you have `requests`, your first step is to fetch the readme.txt file, which
    can guide you as to the formats and location of the data files you want:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 要下载这些文件，这些文件可以通过HTTPS访问，你需要`requests`库。你可以在命令提示符下使用`pip install requests`来获取`requests`。当你有了`requests`后，你的第一步是获取readme.txt文件，它可以指导你了解所需数据文件的格式和位置：
- en: '[PRE0]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'When you look at the readme file, you should see something like this:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 当你查看readme文件时，你应该会看到类似以下内容：
- en: '[PRE1]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'In particular, you’re interested in section II, which lists the contents:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 尤其是你对第II部分感兴趣，其中列出了内容：
- en: '[PRE2]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'As you look at the files available, you see that ghcnd-inventory.txt has a
    listing of the recording periods for each station, which will help you find a
    good data set; and ghcnd-stations.txt lists the stations, which should help you
    find the station closest to your location, so you’ll grab those two files first:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 当你查看可用的文件时，你会看到ghcnd-inventory.txt列出了每个站点的记录周期，这将帮助你找到一个好的数据集；而ghcnd-stations.txt列出了站点，这将帮助你找到离你位置最近的站点，所以你首先会获取这两个文件：
- en: '[PRE3]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'When you have those files, you can save them to your local disk so that you
    won’t need to download them again if you need to go back to the original data:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 当你有了这些文件后，你可以将它们保存到本地磁盘上，这样你就不需要再次下载它们，如果你需要回到原始数据：
- en: '[PRE4]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Start by looking at the inventory file. Here’s what the first 137 characters
    show you:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，查看库存文件。以下是你前137个字符所显示的内容：
- en: '[PRE5]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'These variables have the following definitions:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 这些变量有以下定义：
- en: '[PRE6]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: From this description, you can tell that the inventory list has most of the
    information you need to find the station you want to look at. You can use the
    latitude and longitude to find the stations closest to you; then you can use the
    FIRSTYEAR and LASTYEAR fields to find a station with records covering a long span
    of time.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 从这个描述中，你可以看出库存列表包含了你寻找所需站点所需的大部分信息。你可以使用纬度和经度找到离你最近的站点；然后你可以使用FIRSTYEAR和LASTYEAR字段找到记录跨度较长的站点。
- en: 'The only question remaining is what the ELEMENT field is; for that, the file
    suggests that you look at section III. In section III (which I look at in more
    detail later), you find the following description of the main elements:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 剩下的唯一问题是ELEMENT字段是什么；为此，文件建议你查看第III部分。在第III部分（我稍后会更详细地查看），你可以找到以下主要元素的描述：
- en: '[PRE7]'
  id: totrans-26
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: For purposes of this example, you’re interested in the TMAX and TMIN elements,
    which are maximum and minimum temperatures in tenths of degrees Celsius.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 为了这个示例的目的，你感兴趣的是TMAX和TMIN元素，它们是以十分之一摄氏度为单位的最高和最低温度。
- en: Parsing the inventory data
  id: totrans-28
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解析库存数据
- en: 'The readme.txt file tells you what you’ve got in the inventory file so that
    you can parse the data into a more usable format. You could just store the parsed
    inventory data as a list of lists or list of tuples, but it takes only a little
    more effort to use `namedtuple` from the collections library to create a custom
    class with the attributes named:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: readme.txt文件告诉你库存文件中有哪些内容，以便你可以将数据解析成更易用的格式。你可以只是将解析后的库存数据存储为列表的列表或列表的元组，但只需多花一点力气，就可以使用collections库中的`namedtuple`创建一个具有以下属性命名的自定义类：
- en: '[PRE8]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Using the `Inventory` class you created is very straightforward; you simply
    create each instance from the appropriate values, which in this case are a parsed
    row of inventory data.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 使用你创建的`Inventory`类非常简单；你只需从适当的值创建每个实例，在这种情况下，是解析后的库存数据行。
- en: The parsing involves two steps. First, you need to pick out slices of a line
    according to the field sizes specified. As you look at the field descriptions
    in the readme file, it’s also clear that there’s an extra space between files,
    which you need to consider in coming up with any approach to parsing. In this
    case, because you’re specifying each slice, the extra spaces are ignored. In addition,
    because the sizes of the STATION and ELEMENT fields exactly correspond to the
    values stored in them, you shouldn’t need to worry about stripping excess spaces
    from them.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 解析涉及两个步骤。首先，你需要根据指定的字段大小挑选出行的片段。当你查看readme文件中的字段描述时，也很清楚文件之间有一个额外的空格，这在制定任何解析方法时需要考虑。在这种情况下，因为你指定了每个片段，所以额外的空格被忽略。此外，因为STATION和ELEMENT字段的大小与其中存储的值完全对应，所以你不需要担心从它们中去除多余的空格。
- en: 'The second thing that would be nice to do is convert the latitude and longitude
    values to floats and the start and end years to ints. You could do this at a later
    stage of data cleaning, and in fact, if the data is inconsistent and doesn’t have
    values that convert correctly in every row, you might want to wait. But in this
    case, the data lets you handle these conversions in the parsing step, so do it
    now:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 第二件好事是将纬度和经度值转换为浮点数，将起始和结束年份转换为整数。你可以在数据清理的后期阶段做这件事，实际上，如果数据不一致且不是每一行都能正确转换的值，你可能需要等待。但在这个案例中，数据允许你在解析步骤中处理这些转换，所以现在就做吧：
- en: '[PRE9]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Selecting a station based on latitude and longitude
  id: totrans-35
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 根据纬度和经度选择站点
- en: 'Now that the inventory is loaded, you can use the latitude and longitude to
    find the stations closest to your location and then pick the one with the longest
    run of temperatures based on start and end years. At even the first line of the
    data, you can see two things to worry about:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 现在库存已加载，你可以使用纬度和经度找到离你位置最近的站点，然后根据起始和结束年份选择温度记录最长的站点。即使在数据的第一行，你也能看到两个需要注意的地方：
- en: There are various element types, but you’re concerned only with TMIN and TMAX,
    for minimum and maximum temperature.
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 有各种元素类型，但你只需关注TMIN和TMAX，分别代表最低和最高温度。
- en: None of the first inventory entries you see covers more than a few years. If
    you’re going to be looking for an historical perspective, you want to find a much
    longer run of temperature data.
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你看到的第一个库存条目没有覆盖超过几年。如果你要寻找历史视角，你想要找到更长时间的温度数据序列。
- en: 'To pick out what you need quickly, we can use a list comprehension to make
    a sublist of only the station inventory items in which the element is TMIN or
    TMAX. The other thing that you care about is getting a station with a long run
    of data, so while you’re creating this sublist, also make sure that the start
    year is before 1920 and that the end year is at least 2015\. That way, you’re
    looking only at stations with at least 95 years’ worth of data:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 为了快速挑选出你需要的内容，我们可以使用列表推导来创建一个子列表，其中只包含元素为TMIN或TMAX的站点清单项。你关心的另一件事是获取一个数据序列较长的站点，所以在创建这个子列表的同时，也要确保起始年份在1920年之前，结束年份至少在2015年。这样，你只查看至少有95年数据的站点：
- en: '[PRE10]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Looking at the first five records in your new list, you see that you’re in better
    shape. Now you have only temperature records, and the start and end years show
    that you have longer runs.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 查看你新列表的前五条记录，你会发现你的情况更好。现在你只有温度记录，起始年和结束年显示你有更长的记录序列。
- en: That leaves the problem of selecting the station nearest your location. To do
    that, compare the latitude and longitude of the station inventories with those
    of your location. There are various ways to get the latitude and longitude of
    any place, but probably the easiest way is to use an online mapping application
    or online search. (When I do that for the Chicago Loop, I get a latitude of 41.882
    and a longitude of -87.629.)
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 这就留下了选择离你位置最近的站点的问题。为了做到这一点，比较站点清单的纬度和经度与你的位置的纬度和经度。获取任何地方的纬度和经度有多种方法，但可能最简单的方法是使用在线地图应用或在线搜索。（当我为芝加哥Loop做这件事时，我得到了纬度41.882和经度-87.629。）
- en: Because you’re interested in the stations closest to your location, that interest
    implies sorting based on how close the latitude and longitude of the stations
    are to those of your location. Sorting a list is easy enough, and sorting by latitude
    and longitude isn’t too hard. But how do you sort by the distance from your latitude
    and longitude?
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 由于你对离你位置最近的站点感兴趣，这种兴趣意味着根据站点的纬度和经度与你的位置的接近程度进行排序。排序列表并不难，按纬度和经度排序也不太困难。但你是如何按纬度和经度之间的距离进行排序的呢？
- en: 'The answer is to define a key function for your sort that gets the difference
    between your latitude and the station’s latitude, and the difference between your
    longitude and the station’s longitude, and combines them into one number. The
    only other thing to remember is that you’ll want to add the absolute value of
    the differences before you combine them to avoid having a high negative difference
    combined with an equally high positive difference that would fool your sort:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 答案是为你的排序定义一个键函数，该函数获取你的纬度与站点的纬度之间的差异，以及你的经度与站点的经度之间的差异，并将它们合并成一个数字。唯一要记住的另一件事是，在合并之前，你想要添加差异的绝对值，以避免将一个高负差异与一个同样高的正差异结合起来，这可能会欺骗你的排序：
- en: '[PRE11]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Selecting a station and getting the station metadata
  id: totrans-46
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 选择站点并获取站点元数据
- en: As you look at the top 20 entries in your newly sorted list, it seems that the
    first station, USC00110338, is a good fit. It’s got both TMIN and TMAX and one
    of the longer series, starting in 1893 and running up through 2017, for more than
    120 years’ worth of data. So save that station into your station variable and
    quickly parse the station data you’ve already grabbed to pick up a little more
    information about the station.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 当你查看新排序列表的前20个条目时，似乎第一个站点USC00110338是一个很好的选择。它既有TMIN也有TMAX，并且是较长的序列之一，从1893年开始，一直持续到2017年，超过120年的数据。所以将这个站点保存到你的站点变量中，并快速解析你已经获取的站点数据，以获取更多关于站点的信息。
- en: 'Back in the readme file, you find the following information about the station
    data:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 在readme文件中，你可以找到以下关于站点的数据信息：
- en: '[PRE12]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Although you might care more about the metadata fields for more serious research,
    right now you want to match the start and end year from the inventory records
    to the rest of the station metadata in the station file.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管你可能更关心更严肃研究中的元数据字段，但现在你想要将清单记录中的起始年和结束年与站点文件中的其余站点元数据进行匹配。
- en: 'You have several ways to sift through the stations file to find the one station
    that matches the station ID you selected. You could create a `for` loop to go
    through each line and break out when you find it; you could split the data into
    lines and then sort and use a binary search, and so on. Depending on the nature
    and amount of data you have, one approach or another might be appropriate. In
    this case, because you have the data loaded already, and it’s not too large, use
    a list comprehension to return a list with its single element being the station
    you’re looking for:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 你有几种方法可以筛选出文件中的某个气象站，以匹配你选择的气象站ID。你可以创建一个`for`循环遍历每一行，找到匹配的行后跳出循环；你也可以将数据拆分成行，然后排序并使用二分搜索，等等。根据你拥有的数据性质和数量，可能有一种或多种方法适合。在这种情况下，因为你已经加载了数据，而且数据量不是很大，可以使用列表推导式来返回一个包含单个元素的列表，该元素是你正在寻找的气象站：
- en: '[PRE13]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: At this point, you’ve identified that you want weather data from the station
    at Aurora, Illinois, which is the nearest station to downtown Chicago with more
    than a century’s worth of temperature data.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，你已经确定你需要从伊利诺伊州的奥罗拉气象站获取天气数据，这是距离芝加哥市中心最近且拥有一个多世纪温度数据的气象站。
- en: Fetching and parsing the actual weather data
  id: totrans-54
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 获取并解析实际天气数据
- en: With the station identified, the next step is fetching the actual weather data
    for that station and parsing it. The process is quite similar to what you did
    in the preceding section.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 确定了气象站后，下一步是获取该站的实际天气数据并进行解析。这个过程与上一节你所做的是非常相似的。
- en: Fetching the data
  id: totrans-56
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 获取数据
- en: 'First, fetch the data file and save it, in case you need to go back to it:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，获取数据文件并保存它，以防你需要回溯：
- en: '[PRE14]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Parsing the weather data
  id: totrans-59
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解析天气数据
- en: 'Again, now that you have the data, you can see it’s quite a bit more complex
    than the station and inventory data. Clearly, it’s time to head back to the readme.txt
    file and section III, which is the description of a weather data file. You have
    a lot of options, so filter them down to the ones that concern you, and leave
    out the other element types as well as the whole system of flags specifying the
    source, quality, and type of the values:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 再次，现在你有了数据，你可以看到它比气象站和库存数据要复杂得多。显然，是时候回到`readme.txt`文件和第三部分了，这部分是关于天气数据文件的描述。你有许多选项，所以筛选出与你相关的选项，并排除其他元素类型以及指定值来源、质量和类型的整个标志系统：
- en: '[PRE15]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: The key points you care about right now are that the station ID is the 11 characters
    of a row, the year is the next 4, the month the next 2, and the element the next
    4 after that. After that, there are 31 slots for daily data, with each slot consisting
    of 5 characters for the temperature, expressed in tenths of a degree Celsius,
    and 3 characters of flags. As I mentioned earlier, you can disregard the flags
    for this exercise. You can also see that missing values for the temperatures are
    coded with -9999 if that day isn’t in the month, so for a typical February, for
    example, the 29th, 30th, and 31st values would be -9999.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 目前你关心的关键点是气象站ID是行中的11个字符，年份是下一个4个字符，月份是下一个2个字符，元素是之后的下一个4个字符。之后，有31个用于每日数据的槽位，每个槽位由表示温度的5个字符组成，温度以摄氏十分之一度表示，以及3个字符的标志。如我之前提到的，你可以忽略这个练习中的标志。你也可以看到，如果某一天不在该月，温度的缺失值用-9999表示，例如，对于一个典型的二月，29日、30日和31日的值将是-9999。
- en: As you process your data in this exercise, you’re looking to get overall trends,
    so you don’t need to worry much about individual days. Instead, find average values
    for the month. You can save the maximum, minimum, and mean values for the entire
    month and use those.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个练习中处理你的数据时，你希望得到整体趋势，所以你不必过多担心个别日子。相反，找到每个月的平均值。你可以保存整个月的最大值、最小值和平均值，并使用这些值。
- en: 'This means that to process each line of weather data, you need to:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 这意味着处理每行天气数据时，你需要：
- en: Split the line into its separate fields, and ignore or discard the flags for
    each daily value.
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将行拆分成其各自的字段，并忽略或丢弃每个每日值的标志。
- en: Remove the values with -9999, and convert the year and month into ints and the
    temperature values into floats, keeping in mind that the temperature readings
    are in tenths of degrees centigrade.
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 移除值为-9999的值，并将年份和月份转换为整数，将温度值转换为浮点数，同时考虑到温度读数是以摄氏十分之一度表示的。
- en: Calculate the average value, and pick out the high and low values.
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 计算平均值，并挑选出最高和最低值。
- en: 'To accomplish all these tasks, you can take a couple of approaches. You could
    do several passes over the data, splitting into fields, discarding the placeholders,
    converting strings to numbers, and finally calculating the summary values. Or
    you can write a function that performs all of these operations on a single line
    and do everything in one pass. Both approaches can be valid. In this case, take
    the latter approach and create a `parse_line` function to perform all of your
    data transformations:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 为了完成所有这些任务，你可以采取几种方法。你可以对数据进行多次遍历，分割字段，丢弃占位符，将字符串转换为数字，最后计算汇总值。或者，你可以编写一个函数，在单行中执行所有这些操作，并在一次遍历中完成所有操作。两种方法都可以是有效的。在这种情况下，采取后一种方法，创建一个`parse_line`函数来执行所有数据转换：
- en: '[PRE16]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'If you test this function with the first line of your raw weather data, you
    get the following result:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你用你的原始天气数据的第一个行测试这个函数，你会得到以下结果：
- en: '[PRE17]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'So it looks like you have a function that will work to parse your data. If
    that function works, you can parse the weather data and either store it or continue
    with your processing:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 所以看起来你有一个可以用来解析你数据的函数。如果这个函数能正常工作，你就可以解析天气数据，要么存储它，要么继续你的处理：
- en: '[PRE18]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Now you have all the weather records, not just the temperature records, parsed
    and in your list.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你有了所有天气记录，不仅仅是温度记录，解析并保存在你的列表中。
- en: Saving the weather data in a database (optional)
  id: totrans-75
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 将天气数据保存在数据库中（可选）
- en: At this point, you can save all of the weather records (and the station records
    and inventory records as well, if you want) in a database. Doing so lets you come
    back in later sessions and use the same data without having to go to the hassle
    of fetching and parsing the data again.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，你可以将所有天气记录（如果你愿意，还包括站点记录和库存记录）保存在数据库中。这样做可以让你在以后的会话中返回并使用相同的数据，而无需再次麻烦地获取和解析数据。
- en: 'As an example, the following code is how you could save the weather data in
    a sqlite3 database:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，以下代码是如何将天气数据保存在sqlite3数据库中的：
- en: '[PRE19]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'When you have the data stored, you could retrieve it from the database with
    code like the following, which fetches only the TMAX records:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 当你将数据存储后，你可以使用如下代码从数据库中检索它，该代码仅获取TMAX记录：
- en: '[PRE20]'
  id: totrans-80
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: Selecting and graphing data
  id: totrans-81
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 选择和绘图数据
- en: 'Because you’re concerned only with temperature, you need to select just the
    temperature records. You can do that quickly enough by using a couple of list
    comprehensions to pick out a list for TMAX and one for TMIN. Or you could use
    the features of pandas, which you’ll be using for graphing the date, to filter
    out the records you don’t want. Because you’re more concerned with pure Python
    than with pandas, take the first approach:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 因为你只关心温度，你需要选择仅包含温度记录。你可以通过使用几个列表推导式来快速选择TMAX和TMIN的列表来完成这个任务。或者，你可以使用pandas的特性，你将使用它来绘图日期，来过滤掉你不需要的记录。因为你更关心纯Python而不是pandas，所以采取第一种方法：
- en: '[PRE21]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Using pandas to graph your data
  id: totrans-84
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用pandas绘图你的数据
- en: 'At this point, you have your data cleaned and ready to graph. To make the graphing
    easier, you can use pandas and matplotlib, as described in [chapter 24](kindle_split_037.html#ch24).
    To do this, you need to have a Jupyter server running and have pandas and matplotlib
    installed. To make sure that they’re installed from within your Jupyter notebook,
    use the following command:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，你的数据已经清理完毕，准备绘图。为了使绘图更简单，你可以使用pandas和matplotlib，如第24章所述。为此，你需要有一个运行的Jupyter服务器，并且已经安装了pandas和matplotlib。为了确保它们是在你的Jupyter笔记本中安装的，请使用以下命令：
- en: '[PRE22]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'When pandas and matplotlib are installed, you can load pandas and create data
    frames for your TMAX and TMIN data:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 当pandas和matplotlib安装好后，你可以加载pandas并为你的TMAX和TMIN数据创建数据框：
- en: '[PRE23]'
  id: totrans-88
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: You could plot the monthly values, but 123 years times 12 months of data is
    almost 1,500 data points, and the cycle of seasons also makes picking out patterns
    difficult.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以绘制月度值，但123年的12个月数据几乎有1,500个数据点，季节循环也使得找出模式变得困难。
- en: 'Instead, it probably makes more sense to average the high, low, and mean monthly
    values into yearly values and plot those values. You could do this in Python,
    but because you already have your data loaded in a pandas data frame, you can
    use that to group by year and get the mean values:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 相反，可能将最高、最低和平均月值平均到年值并绘制这些值更有意义。你可以在Python中这样做，但由于你的数据已经加载到pandas数据框中，你可以使用它按年分组并获取平均值：
- en: '[PRE24]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: This result has a fair amount of variation, but it does seem to indicate that
    the minimum temperature has been on the rise for the past 20 years.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 这个结果变化幅度相当大，但似乎确实表明过去20年来最低温度一直在上升。
- en: Note that if you wanted to get the same graph without using Jupyter notebook
    and matplotlib, you could use still use pandas, but you’d write to a CSV or Microsoft
    Excel file, using the data frame’s `to_csv` or `to_excel` method. Then you could
    load the resulting file into a spreadsheet and graph from there.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，如果你想要在不使用Jupyter笔记本和matplotlib的情况下获得相同的图表，你仍然可以使用pandas，但你需要将数据写入CSV或Microsoft
    Excel文件，使用数据框的`to_csv`或`to_excel`方法。然后你可以将生成的文件加载到电子表格中，并从那里进行绘图。
