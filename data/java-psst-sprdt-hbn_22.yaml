- en: 17 Working with Spring Data MongoDB
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 17 使用Spring Data MongoDB
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Introducing MongoDB
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 介绍MongoDB
- en: Examining Spring Data MongoDB
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 检查Spring Data MongoDB
- en: Accessing a database with MongoRepository
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用MongoRepository访问数据库
- en: Accessing a database with MongoTemplate
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用MongoTemplate访问数据库
- en: Document-oriented databases are one type of NoSQL database, where the information
    is kept as a key/value store. MongoDB is such a database program. Spring Data
    MongoDB, as part of the larger Spring Data umbrella project, facilitates the interaction
    of Java programs with MongoDB document databases.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 文档型数据库是NoSQL数据库的一种类型，其中信息以键/值存储。MongoDB就是这样一种数据库程序。Spring Data MongoDB作为更大的Spring
    Data项目的一部分，简化了Java程序与MongoDB文档数据库的交互。
- en: 17.1 Introducing MongoDB
  id: totrans-7
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 17.1 介绍MongoDB
- en: MongoDB is an open source, document-oriented NoSQL database. MongoDB uses JSON-like
    documents to store the information, and it uses the concepts of databases, collections,
    and documents.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: MongoDB是一个开源的文档型NoSQL数据库。MongoDB使用类似JSON的文档来存储信息，并使用数据库、集合和文档的概念。
- en: '*Database*—A database represents a container for collections. After installing
    MongoDB, you will generally get a set of databases.'
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*数据库*—数据库代表集合的容器。安装MongoDB后，您通常会获得一组数据库。'
- en: '*Collection* —A collection is similar to a table in the world of relational
    database management systems (RDBMSs). A collection may contain a set of documents.'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*集合* —在关系数据库管理系统（RDBMS）的世界中，集合类似于表。一个集合可能包含一组文档。'
- en: '*Document*—A document represents a set of key/value pairs, equivalent to rows
    in RDBMSs. Documents belonging to the same collection may have different sets
    of fields. Fields that are common to multiple documents in a collection may contain
    data of different types—such situations are known as dynamic schemas.'
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*文档*—一个文档代表一组键/值对，相当于RDBMS中的行。属于同一集合的文档可能具有不同的字段集。集合中多个文档共有的字段可能包含不同类型的数据—这种情况下称为动态模式。'
- en: Table 17.1 summarizes the terminology equivalences between relational databases
    and the NoSQL database MongoDB.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 表17.1总结了关系数据库和无SQL数据库MongoDB之间的术语等效关系。
- en: 'Table 17.1 Compared terminology: RDBMS vs. MongoDB'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 表17.1 比较术语：RDBMS与MongoDB
- en: '| Relational databases | MongoDB |'
  id: totrans-14
  prefs: []
  type: TYPE_TB
  zh: '| 关系数据库 | MongoDB |'
- en: '| Database | Database |'
  id: totrans-15
  prefs: []
  type: TYPE_TB
  zh: '| 数据库 | 数据库 |'
- en: '| Table | Collection |'
  id: totrans-16
  prefs: []
  type: TYPE_TB
  zh: '| 表 | 集合 |'
- en: '| Row | Document |'
  id: totrans-17
  prefs: []
  type: TYPE_TB
  zh: '| 行 | 文档 |'
- en: '| Column | Field |'
  id: totrans-18
  prefs: []
  type: TYPE_TB
  zh: '| 列 | 字段 |'
- en: 'You can download the MongoDB Community Edition installation kit here: [https://www.mongodb.com/try/download/community](https://www.mongodb.com/try/download/community).
    Installation instructions, depending on your operating system, can be found here:
    [https://docs.mongodb.com/manual/administration/install-community/](https://docs.mongodb.com/manual/administration/install-community/).'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在此处下载MongoDB社区版安装包：[https://www.mongodb.com/try/download/community](https://www.mongodb.com/try/download/community)。根据您的操作系统，安装说明可以在此处找到：[https://docs.mongodb.com/manual/administration/install-community/](https://docs.mongodb.com/manual/administration/install-community/).
- en: After installing MongoDB, you can open the MongoDB Compass program, as in figure
    17.1\. MongoDB Compass is a GUI for interacting with and querying MongoDB databases.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 安装MongoDB后，您可以打开MongoDB Compass程序，如图17.1所示。MongoDB Compass是用于与MongoDB数据库交互和查询的图形用户界面。
- en: '![](../../OEBPS/Images/CH17_F01_Tudose2.png)'
  id: totrans-21
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH17_F01_Tudose2.png)'
- en: Listing 17.1 Opening the MongoDB Compass program
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 列表17.1 打开MongoDB Compass程序
- en: Click the Connect button, and you will connect to the local server, as demonstrated
    in figure 17.2.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 点击连接按钮，您将连接到本地服务器，如图17.2所示。
- en: '![](../../OEBPS/Images/CH17_F02_Tudose2.png)'
  id: totrans-24
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH17_F02_Tudose2.png)'
- en: Listing 17.2 The connection to the local MongoDB server
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 列表17.2 连接到本地MongoDB服务器
- en: 'Data in a MongoDB collection is represented in JSON format. A typical MongoDB
    document describing a user of our CaveatEmptor application might look like this:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: MongoDB集合中的数据以JSON格式表示。描述我们CaveatEmptor应用程序用户的典型MongoDB文档可能看起来像这样：
- en: '[PRE0]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: To select documents fulfilling particular conditions, you can use the Filter
    edit box in the MongoDB Compass program to insert a query filter parameter. For
    example, to select documents with the username “john”, you would insert the query
    filter `{"username":"john"}` and click the Find button, as demonstrated in figure
    17.3.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 要选择满足特定条件的文档，您可以在MongoDB Compass程序中使用过滤器编辑框插入查询过滤器参数。例如，要选择用户名为“john”的文档，您需要插入查询过滤器`{"username":"john"}`并点击查找按钮，如图17.3所示。
- en: '![](../../OEBPS/Images/CH17_F03_Tudose2.png)'
  id: totrans-29
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH17_F03_Tudose2.png)'
- en: Listing 17.3 Selecting a document from a MongoDB collection
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.3 从 MongoDB 集合中选择文档
- en: 'For details about MongoDB CRUD operations you may want to execute, refer to
    the official documentation: [https://docs.mongodb.com/manual/crud/](https://docs.mongodb.com/manual/crud/).'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 关于您可能想要执行的 MongoDB CRUD 操作的详细信息，请参阅官方文档：[https://docs.mongodb.com/manual/crud/](https://docs.mongodb.com/manual/crud/)。
- en: 17.2 Introducing Spring Data MongoDB
  id: totrans-32
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 17.2 介绍 Spring Data MongoDB
- en: 'Spring Data MongoDB is part of the umbrella Spring Data project, and it allows
    for MongoDB to be used from Java programs, following the Spring Data approach:
    repositories and custom object-mapping abstractions, annotations, dynamic query
    creation based on repository method names, integration with other Spring projects,
    and Spring Boot.'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: Spring Data MongoDB 是 Spring Data 项目的一部分，它允许 Java 程序使用 MongoDB，遵循 Spring Data
    方法：仓库和自定义对象映射抽象、注解、基于仓库方法名的动态查询创建、与其他 Spring 项目的集成以及 Spring Boot。
- en: 'To demonstrate Spring Data MongoDB, we’ll create an application that will manage
    and persist CaveatEmptor users. We’ll create a Spring Boot application that uses
    Spring Data MongoDB. To do this, go to the Spring Initializr website ([https://start.spring.io/](https://start.spring.io/))
    and create a new Spring Boot project (see figure 17.4), having the following characteristics:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 为了演示 Spring Data MongoDB，我们将创建一个应用程序来管理和持久化 CaveatEmptor 用户。我们将创建一个使用 Spring
    Data MongoDB 的 Spring Boot 应用程序。为此，请访问 Spring Initializr 网站 ([https://start.spring.io/](https://start.spring.io/))
    并创建一个新的 Spring Boot 项目（见图 17.4），具有以下特性：
- en: 'Group: com.manning.javapersistence'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 组：com.manning.javapersistence
- en: 'Artifact: springdatamongodb'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 艺术品：springdatamongodb
- en: 'Description: Spring Data MongoDB'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 描述：Spring Data MongoDB
- en: '![](../../OEBPS/Images/CH17_F04_Tudose2.png)'
  id: totrans-38
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH17_F04_Tudose2.png)'
- en: Listing 17.4 Creating a new Spring Boot project using Spring Data MongoDB
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.4 使用 Spring Data MongoDB 创建新的 Spring Boot 项目
- en: 'We’ll also add the following dependencies:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还将添加以下依赖项：
- en: Spring Data MongoDB (this will add `spring-boot-starter-data-mongodb` in the
    Maven pom.xml file)
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Spring Data MongoDB（这将向 Maven pom.xml 文件中添加 `spring-boot-starter-data-mongodb`）
- en: Lombok (this will add `org.projectlombok,lombok` in the Maven pom.xml file)
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Lombok（这将向 Maven pom.xml 文件中添加 `org.projectlombok,lombok`）
- en: 'The pom.xml file (listing 17.1) includes the dependencies that we previously
    added to start the project: the dependency on the Spring Data MongoDB framework
    and on Lombok. Lombok is a Java library that can be used to automatically create
    constructors, getters, and setters through annotations, thus reducing the boilerplate
    code. Lombok has its shortcomings, including these: you will need a plugin for
    the IDE to understand the annotations and not complain about missing constructors,
    getters, and setters; and you cannot set breakpoints and debug inside the generated
    methods (but debugging inside these methods is pretty rare).'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: '`pom.xml` 文件（列表 17.1）包括我们之前添加到启动项目的依赖项：对 Spring Data MongoDB 框架和 Lombok 的依赖。Lombok
    是一个 Java 库，可以通过注解自动创建构造函数、获取器和设置器，从而减少样板代码。Lombok 有其不足之处，包括以下这些：您需要为 IDE 安装插件以理解注解，并避免对缺失的构造函数、获取器和设置器发出警告；并且您无法在生成的代码中设置断点进行调试（但在这类方法中进行调试的情况很少）。'
- en: Listing 17.1 The pom.xml Maven file
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.1 Maven 的 pom.xml 文件
- en: '[PRE1]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Ⓐ `spring-boot-starter-data-mongodb` is the starter dependency used by Spring
    Boot to connect to a MongoDB database through Spring Data.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `spring-boot-starter-data-mongodb` 是 Spring Boot 用于通过 Spring Data 连接到 MongoDB
    数据库的启动依赖项。
- en: Ⓑ `Lombok` allows us to reduce boilerplate code and instead rely on automatically
    generated constructors, getters, and setters.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ `Lombok` 允许我们减少样板代码，并依赖自动生成的构造函数、获取器和设置器。
- en: Our next step is to fill in the Spring Boot application.properties file, which
    can include various properties that will be used by the application. Spring Boot
    will automatically find and load application.properties from the classpath, and
    the src/main/ resources folder is added by Maven to the classpath. The application.properties
    configuration file is shown in listing 17.2.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 我们下一步是填写 Spring Boot 应用程序的应用程序.properties 文件，该文件可以包含应用程序将使用的各种属性。Spring Boot
    将自动从类路径中查找并加载 application.properties，并且 Maven 将 src/main/resources 文件夹添加到类路径中。应用程序.properties
    配置文件如列表 17.2 所示。
- en: Listing 17.2 The application.properties file
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.2 应用程序.properties 文件
- en: '[PRE2]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Ⓐ Queries are logged by the Spring Data MongoDB application at DEBUG level.
    So, to enable query logging, we have to set the log level to DEBUG.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ Spring Data MongoDB 应用程序以 DEBUG 级别记录查询。因此，要启用查询记录，我们必须将日志级别设置为 DEBUG。
- en: Ⓑ The creation of indexes is disabled by default in Spring Data MongoDB. Enable
    it by setting the `spring.data.mongodb.auto-index-creation` property to `true`.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 在 Spring Data MongoDB 中，索引的创建默认是禁用的。通过将 `spring.data.mongodb.auto-index-creation`
    属性设置为 `true` 来启用它。
- en: The `User` class will now contain annotations that are specific to Spring Data
    MongoDB. Table 17.2 examines a few annotations and classes, and then we’ll look
    at them in action while working with the `User` class.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: '`User` 类现在将包含特定于 Spring Data MongoDB 的注解。表 17.2 检查了几个注解和类，然后我们将通过操作 `User`
    类来观察它们在实际中的应用。'
- en: Table 17.2 Spring Data MongoDB annotations and classes
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 表 17.2 Spring Data MongoDB 注解和类
- en: '| Spring Data MongoDB annotation/class | Meaning |'
  id: totrans-55
  prefs: []
  type: TYPE_TB
  zh: '| Spring Data MongoDB 注解/类 | 含义 |'
- en: '| `@Document` | A domain object to be persisted to MongoDB |'
  id: totrans-56
  prefs: []
  type: TYPE_TB
  zh: '| `@Document` | 一个要持久化到 MongoDB 的域对象 |'
- en: '| `@Indexed` | A field indexed by MongoDB |'
  id: totrans-57
  prefs: []
  type: TYPE_TB
  zh: '| `@Indexed` | 一个由 MongoDB 索引的字段 |'
- en: '| `@CompoundIndexes` | A container annotation for compound indexes; it defines
    a collection of multiple `@CompoundIndex` annotations |'
  id: totrans-58
  prefs: []
  type: TYPE_TB
  zh: '| `@CompoundIndexes` | 一个用于复合索引的容器注解；它定义了一个多个 `@CompoundIndex` 注解的集合 |'
- en: '| `@CompoundIndex` | Annotates a class to use compound indexes on multiple
    fields |'
  id: totrans-59
  prefs: []
  type: TYPE_TB
  zh: '| `@CompoundIndex` | 注解一个类以在多个字段上使用复合索引 |'
- en: '| `IndexDirection` | An enum that determines the index direction: `ASCENDING`
    (the default) or `DESCENDING` |'
  id: totrans-60
  prefs: []
  type: TYPE_TB
  zh: '| `IndexDirection` | 一个枚举，用于确定索引方向：`ASCENDING`（默认）或 `DESCENDING` |'
- en: The `org.springframework.data.mongodb.core.mapping` package includes the `@Document`
    annotation, while the annotations and the enum related to indexes belong to the
    `org.springframework.data.mongodb.core.index` package.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: '`org.springframework.data.mongodb.core.mapping` 包包括 `@Document` 注解，而与索引相关的注解和枚举属于
    `org.springframework.data.mongodb.core.index` 包。'
- en: For the MongoDB application, we’ll also use a series of core Spring Data annotations
    belonging to the `org.springframework.data.annotation` package, as shown in table
    17.3.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 MongoDB 应用程序，我们还将使用一系列属于 `org.springframework.data.annotation` 包的核心 Spring
    Data 注解，如表 17.3 所示。
- en: Table 17.3 Spring Data core annotations
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 表 17.3 Spring Data 核心注解
- en: '| Spring Data annotation | Meaning |'
  id: totrans-64
  prefs: []
  type: TYPE_TB
  zh: '| Spring Data 注解 | 含义 |'
- en: '| `@Id` | Marks the field as an identifier |'
  id: totrans-65
  prefs: []
  type: TYPE_TB
  zh: '| `@Id` | 标记字段为标识符 |'
- en: '| `@Transient` | A transient field that will not be persisted and will not
    be examined by the persistence framework |'
  id: totrans-66
  prefs: []
  type: TYPE_TB
  zh: '| `@Transient` | 一个瞬态字段，它不会被持久化，也不会被持久化框架检查 |'
- en: '| `@PersistenceConstructor` | Marks the constructor to be the primary one used
    by the persistence framework when retrieving information from the database |'
  id: totrans-67
  prefs: []
  type: TYPE_TB
  zh: '| `@PersistenceConstructor` | 标记构造函数为持久化框架在从数据库检索信息时使用的首选构造函数 |'
- en: This chapter uses the Lombok library to automatically create constructors, getters,
    and setters through annotations, thus reducing the boilerplate code. The most
    important Lombok annotations belonging to the `lombok` package are listed in table
    17.4.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 本章使用 Lombok 库通过注解自动创建构造函数、获取器和设置器，从而减少了样板代码。属于 `lombok` 包的最重要 Lombok 注解列于表 17.4
    中。
- en: Table 17.4 Lombok annotations
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 表 17.4 Lombok 注解
- en: '| Lombok annotation | Meaning |'
  id: totrans-70
  prefs: []
  type: TYPE_TB
  zh: '| Lombok 注解 | 含义 |'
- en: '| `@NoArgsConstructor` | Automatically creates a public no arguments constructor
    for the class it annotates |'
  id: totrans-71
  prefs: []
  type: TYPE_TB
  zh: '| `@NoArgsConstructor` | 自动为它注解的类创建一个公共的无参数构造函数 |'
- en: '| `@Getter` | Automatically creates a public getter for the field it annotates
    |'
  id: totrans-72
  prefs: []
  type: TYPE_TB
  zh: '| `@Getter` | 自动为它注解的字段创建一个公共的获取器 |'
- en: '| `@Setter` | Automatically creates a public setter for the field it annotates
    |'
  id: totrans-73
  prefs: []
  type: TYPE_TB
  zh: '| `@Setter` | 自动为它注解的字段创建一个公共的设置器 |'
- en: 'The `User` class used by the Spring Data MongoDB application is presented in
    listing 17.3\. The `password` field annotated with `@Transient` will not be saved
    to the MongoDB database—there are many cases where you would like secret information,
    such as a password, not to be persisted. The constructor annotated with `@PersistenceConstructor`
    will be used by Spring Data MongoDB when retrieving the information from the database.
    The `ip` parameter of the constructor is annotated with `@Value ("#root.ip ?:
    ''192.168.1.100''")`, which means that if the `ip` value is absent when retrieving
    the document from the database, it will automatically take this default value.'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 'Spring Data MongoDB 应用程序使用的 `User` 类在列表 17.3 中展示。注有 `@Transient` 的 `password`
    字段将不会被保存到 MongoDB 数据库中——有许多情况下，您可能希望秘密信息，如密码，不被持久化。注有 `@PersistenceConstructor`
    的构造函数将由 Spring Data MongoDB 在从数据库检索信息时使用。构造函数的 `ip` 参数注有 `@Value ("#root.ip ?:
    ''192.168.1.100''")`，这意味着如果在从数据库检索文档时 `ip` 值不存在，它将自动采用此默认值。'
- en: Listing 17.3 The `User` class
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.3 `User` 类
- en: '[PRE3]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 17.3 Using MongoRepository to access a database
  id: totrans-77
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 17.3 使用 MongoRepository 访问数据库
- en: The `UserRepository` interface extends `MongoRepository<User, String>`, inheriting
    the MongoDB-related methods and managing the `User` document, which has IDs of
    type `String`.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: '`UserRepository` 接口扩展了 `MongoRepository<User, String>`，继承了 MongoDB 相关的方法并管理具有
    `String` 类型 ID 的 `User` 文档。'
- en: Listing 17.4 The `UserRepository` interface
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.4 `UserRepository` 接口
- en: '[PRE4]'
  id: totrans-80
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 17.3.1 Defining query methods with Spring Data MongoDB
  id: totrans-81
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 17.3.1 使用 Spring Data MongoDB 定义查询方法
- en: We’ll add new methods to the `UserRepository` interface so we can query the
    database for some particular documents and use them in tests.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将向 `UserRepository` 接口添加新方法，以便我们可以查询数据库中的某些特定文档并在测试中使用它们。
- en: The purpose of the query methods is to retrieve information from the database.
    Spring Data MongoDB provides a query builder mechanism similar to the one provided
    by Spring Data JPA—it will create the behavior of repository methods based on
    their names. Remember that the query mechanism removes prefixes and suffixes such
    as `find...By`, `get...By`, `query...By`, `read...By`, and `count...By` from the
    name of the method, and it then parses the remainder.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 查询方法的目的在于从数据库中检索信息。Spring Data MongoDB 提供了一个查询构建器机制，类似于 Spring Data JPA 提供的——它将根据方法名称创建仓库方法的操作。请记住，查询机制会从方法名称中移除前缀和后缀，如
    `find...By`、`get...By`、`query...By`、`read...By` 和 `count...By`，然后解析剩余部分。
- en: Just like Spring Data JPA, Spring Data MongoDB will look at the return type
    of the method. If we want to find a `User` and return it in an `Optional` container,
    the method’s return type will be `Optional<User>`.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 与 Spring Data JPA 类似，Spring Data MongoDB 会查看方法的返回类型。如果我们想找到一个 `User` 并将其返回在
    `Optional` 容器中，那么方法的返回类型将是 `Optional<User>`。
- en: Listing 17.5 The `UserRepository` interface with new methods
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.5 新方法的 `UserRepository` 接口
- en: '[PRE5]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The names of the methods need to follow the rules to determine the resulting
    query. If the method naming is wrong (for example, the entity property does not
    match in the query method), we’ll get an error when the application context is
    loaded. Table 17.5 summarizes the usage of the essential keywords in building
    Spring Data MongoDB query methods and the resulting conditions. For a more comprehensive
    list, see appendix D.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 方法的名称需要遵循确定结果查询的规则。如果方法命名错误（例如，查询方法中的实体属性不匹配），则在加载应用程序上下文时将得到错误。表 17.5 总结了构建
    Spring Data MongoDB 查询方法中使用的必要关键字及其产生的条件。对于更完整的列表，请参阅附录 D。
- en: Table 17.5 Keyword usage in Spring Data MongoDB and the resulting conditions
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 表 17.5 Spring Data MongoDB 中关键字的使用及其产生的条件
- en: '| Keyword | Example | Condition |'
  id: totrans-89
  prefs: []
  type: TYPE_TB
  zh: '| 关键字 | 示例 | 条件 |'
- en: '| `Is,` `Equals` | `findByUsername(String` `name)``findByUsernameIs(String`
    `name)``findByUsernameEquals(String` `name)` | `{"username":"name"}` |'
  id: totrans-90
  prefs: []
  type: TYPE_TB
  zh: '| `Is,` `Equals` | `findByUsername(String name)` `findByUsernameIs(String name)`
    `findByUsernameEquals(String name)` | `{"username":"name"}` |'
- en: '| `And` | `findByUsernameAndEmail(String` `username,` `String email)` | `{"username":"username",`
    `"email":"email"}` |'
  id: totrans-91
  prefs: []
  type: TYPE_TB
  zh: '| `And` | `findByUsernameAndEmail(String username, String email)` | `{"username":"username",`
    `"email":"email"}` |'
- en: '| `Or` | `findByUsernameOrEmail` `(String username,` `String email)` | `{`
    `"$or"` `:` `[{ "username"` `:` `"username"},` `{` `"email"` `:` `"email"}]}`
    |'
  id: totrans-92
  prefs: []
  type: TYPE_TB
  zh: '| `Or` | `findByUsernameOrEmail(String username, String email)` | `{` `"$or"`
    `:` `[{ "username"` `:` `"username"},` `{` `"email"` `:` `"email"}]}` |'
- en: '| `LessThan` | `findByRegistrationDateLessThan(LocalDate` `date)` | `{` `"registrationDate"`
    `: {` `"$lt"` `:` `{` `"$date"` `: "date"}}}` |'
  id: totrans-93
  prefs: []
  type: TYPE_TB
  zh: '| `LessThan` | `findByRegistrationDateLessThan(LocalDate date)` | `{` `"registrationDate"`
    `: {` `"$lt"` `:` `{` `"$date"` `: "date"}}}` |'
- en: '| `LessThanEqual` | `findByRegistrationDateLessThanEqual(LocalDate` `date)`
    | `{` `"registrationDate"` `: {` `"$lte"` `:` `{` `"$date"` `: "date"}}}` |'
  id: totrans-94
  prefs: []
  type: TYPE_TB
  zh: '| `LessThanEqual` | `findByRegistrationDateLessThanEqual(LocalDate date)` |
    `{` `"registrationDate"` `: {` `"$lte"` `:` `{` `"$date"` `: "date"}}}` |'
- en: '| `GreaterThan` | `findByRegistrationDateGreaterThan(LocalDate` `date)` | `{`
    `"registrationDate"` `: {` `"$gt"` `:` `{` `"$date"` `: "date"}}}` |'
  id: totrans-95
  prefs: []
  type: TYPE_TB
  zh: '| `GreaterThan` | `findByRegistrationDateGreaterThan(LocalDate date)` | `{`
    `"registrationDate"` `: {` `"$gt"` `:` `{` `"$date"` `: "date"}}}` |'
- en: '| `GreaterThanEqual` | `findByRegistrationDateGreaterThanEqual(LocalDate` `date)`
    | `{` `"registrationDate"` `: {` `"$gte"` `:` `{` `"$date"` `:` `"date"}}}` |'
  id: totrans-96
  prefs: []
  type: TYPE_TB
  zh: '| `GreaterThanEqual` | `findByRegistrationDateGreaterThanEqual(LocalDate date)`
    | `{` `"registrationDate"` `: {` `"$gte"` `:` `{` `"$date"` `: `"date"}}}` |'
- en: '| `Between` | `findByRegistrationDateBetween(LocalDate` `from,` `LocalDate`
    `to)` | `"registrationDate"` `:` `{ "$gte"` `:` `{` `"$date"` `: "from"},` `"$lte"`
    `:` `{ "$date"` `:` `"to"}}}` |'
  id: totrans-97
  prefs: []
  type: TYPE_TB
  zh: '| `Between` | `findByRegistrationDateBetween(LocalDate from, LocalDate to)`
    | `"registrationDate"` `:` `{ "$gte"` `:` `{` `"$date"` `: "from"},` `"$lte"`
    `:` `{ "$date"` `: "to"}}}` |'
- en: '| `OrderBy` | `findByRegistrationDateOrderByUsernameDesc(LocalDate` `date)`
    | `"registrationDate"` `:` `{ "$date"` `:` `"date"}}` |'
  id: totrans-98
  prefs: []
  type: TYPE_TB
  zh: '| `OrderBy` | `findByRegistrationDateOrderByUsernameDesc(LocalDate date)` |
    `"registrationDate": { "$date": "date"}}` |'
- en: '| `Like` | `findByUsernameLike(String` `name)` | `{` `"username"` `:` `{ "$regularExpression"
    : {` `"pattern"` `:` `"name", "options"` `:` `""}}}` |'
  id: totrans-99
  prefs: []
  type: TYPE_TB
  zh: '| `Like` | `findByUsernameLike(String name)` | `{ "username": { "$regularExpression":
    { "pattern": "name", "options": ""}}}` |'
- en: '| `NotLike` | `findByUsernameNotLike(String` `name)` | `{` `"username"` `:`
    `{ "$not"` `:` `{ "$regularExpression"` `: {` `"pattern"` `:` `"name", "options"`
    `:` `""}}}}` |'
  id: totrans-100
  prefs: []
  type: TYPE_TB
  zh: '| `NotLike` | `findByUsernameNotLike(String name)` | `{ "username": { "$not":
    { "$regularExpression": { "pattern": "name", "options": ""}}}}` |'
- en: '| `Before` | `findByRegistrationDateBefore(LocalDate` `date)` | `{ "registrationDate"`
    `:` `{` `"$lt"` `:` `{` `"$date"` `:` `"date"}}}` |'
  id: totrans-101
  prefs: []
  type: TYPE_TB
  zh: '| `Before` | `findByRegistrationDateBefore(LocalDate date)` | `{ "registrationDate":
    { "$lt": { "$date": "date"}}}` |'
- en: '| `After` | `findByRegistrationDateAfter(LocalDate` `date)` | `{ "registrationDate"`
    `:` `{ "$gt"` `:` `{` `"$date"` `:` `"date"}}}` |'
  id: totrans-102
  prefs: []
  type: TYPE_TB
  zh: '| `After` | `findByRegistrationDateAfter(LocalDate date)` | `{ "registrationDate":
    { "$gt": { "$date": "date"}}}` |'
- en: '| `Null, IsNull` | `findByRegistrationDate(Is)Null()` | `{ "registrationDate"`
    `:` `null}` |'
  id: totrans-103
  prefs: []
  type: TYPE_TB
  zh: '| `Null, IsNull` | `findByRegistrationDate(Is)Null()` | `{ "registrationDate":
    null}` |'
- en: '| `NotNull, IsNotNull` | `findByRegistrationDate(Is)NotNull()` | `{ "registrationDate"`
    `:` `{ "$ne"` `:vnull}}` |'
  id: totrans-104
  prefs: []
  type: TYPE_TB
  zh: '| `NotNull, IsNotNull` | `findByRegistrationDate(Is)NotNull()` | `{ "registrationDate":
    { "$ne": null}}` |'
- en: '| `Not` | `findByUsernameNot(String name)` | `{ "username"` `:` `{` `"$ne"`
    `:` `"name"}}` |'
  id: totrans-105
  prefs: []
  type: TYPE_TB
  zh: '| `Not` | `findByUsernameNot(String name)` | `{ "username": { "$ne": "name"}}`
    |'
- en: As a base class for all future tests, we’ll write the `SpringDataJdbcApplicationTests`
    abstract class (listing 17.6).
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 作为所有未来测试的基础类，我们将编写`SpringDataJdbcApplicationTests`抽象类（列表17.6）。
- en: The `@SpringBootTest` annotation is added by Spring Boot to the initially created
    class, and it will tell Spring Boot to search the main configuration class (the
    `@SpringBootApplication` annotated class, for instance) and create the `ApplicationContext`
    to be used in the tests. As you’ll recall, the `@SpringBootApplication` annotation
    added by Spring Boot to the class containing the `main` method will enable the
    Spring Boot autoconfiguration mechanism, enable the scan on the package where
    the application is located, and allow registering extra beans in the context.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: '`@SpringBootTest`注解由Spring Boot添加到最初创建的类中，它将告诉Spring Boot搜索主配置类（例如，被`@SpringBootApplication`注解的类）并创建用于测试的`ApplicationContext`。如您所回忆的，Spring
    Boot添加到包含`main`方法的类上的`@SpringBootApplication`注解将启用Spring Boot自动配置机制，启用对应用程序所在包的扫描，并允许在上下文中注册额外的bean。'
- en: Using the `@TestInstance(TestInstance.Lifecycle.PER_CLASS)` annotation, we’ll
    ask JUnit 5 to create a single instance of the test class and reuse it for all
    test methods. This will allow us to make the `@BeforeAll` and `@AfterAll` annotated
    methods non-static and to directly use the autowired `UserRepository` instance
    field inside them. The `@BeforeAll` annotated non-static method is executed once
    before all tests from any class extending `SpringDataJdbcApplicationTests`, and
    it saves the list of users created inside the `generateUsers` method to the database.
    The `@AfterAll` annotated non-static method is executed once after all tests from
    any class extending `SpringDataJdbcApplicationTests`, and it deletes all users
    from the database.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`@TestInstance(TestInstance.Lifecycle.PER_CLASS)`注解，我们将要求JUnit 5创建一个测试类的单个实例，并为其所有测试方法重用。这将使我们能够将`@BeforeAll`和`@AfterAll`注解的方法设置为非静态，并直接在它们内部使用自动装配的`UserRepository`实例字段。被`@BeforeAll`注解的非静态方法将在所有扩展`SpringDataJdbcApplicationTests`的类的测试之前执行一次，并将`generateUsers`方法内部创建的用户列表保存到数据库中。被`@AfterAll`注解的非静态方法将在所有扩展`SpringDataJdbcApplicationTests`的类的测试之后执行一次，并从数据库中删除所有用户。
- en: Listing 17.6 The `SpringDataJdbcApplicationTests` abstract class
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 列表17.6 `SpringDataJdbcApplicationTests`抽象类
- en: '[PRE6]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Ⓐ Autowire a `UserRepository` instance. This is possible due to the `@SpringBootApplication`
    annotation, which enables the scan on the package where the application is located
    and registers the beans in the context.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ 自动装配一个`UserRepository`实例。这是由于`@SpringBootApplication`注解，它启用了对应用程序所在包的扫描并在上下文中注册了bean。
- en: 'The next tests will extend this class and use the already populated database.
    To test the methods that belong now to `UserRepository`, we’ll create the `FindUsersTest`
    class and follow the same recipe for writing tests: call the repository method
    and verify its results. Recall that, in JUnit 5, it is enough that test classes
    and methods are package private; they are not required to be public.'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个测试将扩展这个类并使用已经填充的数据库。为了测试现在属于 `UserRepository` 的方法，我们将创建 `FindUsersTest` 类并遵循相同的测试编写方法：调用存储库方法并验证其结果。回想一下，在JUnit
    5中，测试类和方法只需要是包私有的就足够了；它们不需要是公共的。
- en: Listing 17.7 The `FindUsersTest` class
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.7 `FindUsersTest` 类
- en: '[PRE7]'
  id: totrans-114
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 17.3.2 Limiting query results, sorting, and paging
  id: totrans-115
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 17.3.2 限制查询结果、排序和分页
- en: As in Spring Data JPA and Spring Data JDBC, the `first` and `top` keywords (used
    equivalently) can limit the results of query methods. The `top` and `first` keywords
    can be followed by an optional numeric value to indicate the maximum result size
    to be returned. If this numeric value is missing, the result size will be 1.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 正如 Spring Data JPA 和 Spring Data JDBC 一样，`first` 和 `top` 关键字（等效使用）可以限制查询方法的结果。`top`
    和 `first` 关键字后面可以跟一个可选的数值，表示要返回的最大结果大小。如果这个数值缺失，结果大小将是1。
- en: '`Pageable` is an interface for pagination information, and in practice we use
    the `PageRequest` class that implements it. This class can specify the page number,
    the page size, and the sorting criterion.'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: '`Pageable` 是一个分页信息的接口，在实践中我们使用实现它的 `PageRequest` 类。这个类可以指定页码、页面大小和排序标准。'
- en: The use cases we’ll solve here will be getting a limited number of users (such
    as the first user by username or by registration date, or the first users with
    a given level, sorted by registration date), or a large bunch of users in pages,
    so we can easily manipulate them.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在这里要解决的问题将是获取一定数量的用户（例如按用户名或注册日期找到第一个用户，或者按给定等级找到第一个用户，并按注册日期排序），或者按页获取大量用户，这样我们就可以轻松地操作它们。
- en: To limit the query results and do sorting and paging, we’ll add the following
    methods to the `UserRepository` interface.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 为了限制查询结果并进行排序和分页，我们将向 `UserRepository` 接口添加以下方法。
- en: Listing 17.8 Limiting query results, sorting, and paging in `UserRepository`
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.8 在 `UserRepository` 中限制查询结果、排序和分页
- en: '[PRE8]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: These methods use the query builder mechanism presented in table 17.5, but this
    time with the purpose of limiting the results of the query, to do sorting and
    paging. For example, the `Optional<User> findFirstByOrderByUsernameAsc()` method
    will get the first user by its username (the result is an `Optional`, so eventually
    it may not exist). The `Page<User> findAll(Pageable pageable)` method will get
    all users but in pages. We’ll write the following tests to verify that these newly
    added methods work.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 这些方法使用表 17.5 中介绍的查询构建器机制，但这次是为了限制查询结果，进行排序和分页。例如，`Optional<User> findFirstByOrderByUsernameAsc()`
    方法将按用户名获取第一个用户（结果是一个 `Optional`，所以最终可能不存在）。`Page<User> findAll(Pageable pageable)`
    方法将按页获取所有用户。我们将编写以下测试来验证这些新添加的方法是否正常工作。
- en: Listing 17.9 Testing limiting query results, sorting, and paging
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.9 测试限制查询结果、排序和分页
- en: '[PRE9]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Ⓐ The first test will find the first user by ascending order of username and
    the first user by descending order of registration date.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ 第一次测试将按用户名升序找到第一个用户，按注册日期降序找到第一个用户。
- en: Ⓑ Find all users, split them into pages, and return page number 1 of size 3
    (the page numbering starts with 0).
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 查找所有用户，将它们分成页面，并返回第1页，大小为3（页码从0开始）。
- en: Ⓒ Find the first 2 users with level 2, ordered by registration date.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 查找前两个等级为2的用户，并按注册日期排序。
- en: Ⓓ The second test will define a sorting criterion on the `User` class. `Sort.TypedSort`
    extends `Sort` and can use method handles to define properties to sort by.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 第二次测试将在 `User` 类上定义一个排序标准。`Sort.TypedSort` 扩展了 `Sort` 并可以使用方法处理程序来定义排序属性。
- en: Ⓔ Find the users of level 3 and sort by registration date, descending.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓔ 查找等级为3的用户，并按注册日期降序排序。
- en: Ⓕ The third test will find active users, sorted by registration date, and will
    split them into pages, and return page number 1 of size 4 (page numbering starts
    with 0).
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓕ 第三次测试将找到活跃用户，按注册日期排序，并将它们分成页面，并返回第1页，大小为4（页码从0开始）。
- en: 17.3.3 Streaming results
  id: totrans-131
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 17.3.3 流式传输结果
- en: Query methods returning more than one result can use standard Java interfaces
    such as `Iterable`, `List`, `Set`. Like Spring Data JPA and Spring Data JDBC,
    Spring Data MongoDB supports `Streamable`, which can be used as an alternative
    to `Iterable` or any collection type. It allows us to concatenate `Streamable`s
    and to directly filter and map over the elements.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 返回多个结果的查询方法可以使用标准的 Java 接口，如 `Iterable`、`List`、`Set`。与 Spring Data JPA 和 Spring
    Data JDBC 类似，Spring Data MongoDB 支持 `Streamable`，它可以作为 `Iterable` 或任何集合类型的替代品。它允许我们连接
    `Streamable`s 并直接过滤和映射元素。
- en: The use case we’ll solve here is getting the results as a stream, without waiting
    for the whole collection of users or a page of users to be obtained. This way
    we’ll be able to quickly start processing the first results as they flow to us.
    Unlike collections, a stream can be consumed only once and is immutable.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在这里要解决的问题是以流的形式获取结果，而不是等待整个用户集合或一页用户被获取。这样我们就能快速开始处理流到我们这里的第一批结果。与集合不同，流只能被消费一次，且是不可变的。
- en: We’ll add the following methods to the `UserRepository` interface.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在 `UserRepository` 接口中添加以下方法。
- en: Listing 17.10 Adding methods that return `Streamable` in `UserRepository` interface
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.10 在 `UserRepository` 接口中添加返回 `Streamable` 的方法
- en: '[PRE10]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: We’ll write the following test to verify how these newly added methods work
    to interact with the database and to provide results as streams. A stream is given
    as a resource of the `try` block to be automatically closed. An alternative is
    to explicitly call the `close()` method. Otherwise the stream would keep the underlying
    connection to the database.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将编写以下测试来验证这些新添加的方法如何与数据库交互，并提供作为流的结果。流作为 `try` 块的资源被自动关闭。另一种选择是显式调用 `close()`
    方法。否则，流将保持与数据库的底层连接。
- en: Listing 17.11 Testing methods that return `Streamable`
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.11 测试返回 `Streamable` 的方法
- en: '[PRE11]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Ⓐ The test will call the `findByEmailContaining` method, searching for emails
    containing the `"someother"` word.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ 测试将调用 `findByEmailContaining` 方法，搜索包含 `"someother"` 单词的电子邮件。
- en: Ⓑ The test will concatenate the resulting `Streamable` with the `Streamable`,
    providing the users of level 2.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 测试将结果 `Streamable` 与 `Streamable` 连接，提供二级用户。
- en: Ⓒ It will transform this into a stream and keep the distinct users.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 它将将其转换为流并保留不同的用户。
- en: Ⓓ Check that the resulting stream contains 7 users.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 检查结果流包含 7 个用户。
- en: 17.3.4 The @Query annotation
  id: totrans-144
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 17.3.4 `@Query` 注解
- en: We can create methods for which a custom query can be specified by using the
    `@org.springframework.data.mongodb.repository.Query` annotation. With this `@Query`
    annotation, the method name does not need to follow any naming convention. The
    custom query will have a MongoDB query filter as an argument, and this query filter
    can be parameterized.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过使用 `@org.springframework.data.mongodb.repository.Query` 注解来创建可以指定自定义查询的方法。使用这个
    `@Query` 注解，方法名不需要遵循任何命名约定。自定义查询将有一个 MongoDB 查询过滤器作为参数，并且这个查询过滤器可以进行参数化。
- en: 'We’ll add new methods to the `UserRepository` interface: they will be annotated
    with the `@Query` annotation, and their generated behavior will depend on the
    definitions of these queries. The `value` parameter will indicate the query filter
    to be executed. The `fields` parameter will indicate the fields to be included
    or excluded from the result. Table 17.6 summarizes the query operations and the
    corresponding `@Query` parameters for the most frequent situations. For a comprehensive
    list, consult the Spring Data MongoDB documentation.'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在 `UserRepository` 接口中添加新方法：它们将被 `@Query` 注解标记，并且它们的生成行为将取决于这些查询的定义。`value`
    参数将指示要执行的查询过滤器。`fields` 参数将指示要包含或排除在结果中的字段。表 17.6 总结了最常见的查询操作和相应的 `@Query` 参数。对于完整的列表，请参阅
    Spring Data MongoDB 文档。
- en: Table 17.6 Query operations and corresponding `@Query` parameters
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 表 17.6 查询操作及相应的 `@Query` 参数
- en: '| Operation | `@Query` parameters |'
  id: totrans-148
  prefs: []
  type: TYPE_TB
  zh: '| 操作 | `@Query` 参数 |'
- en: '| Fetch data for a given field | `value = { ''field'' : ?0}` |'
  id: totrans-149
  prefs: []
  type: TYPE_TB
  zh: '| 获取给定字段的 数据 | `value = { ''field'' : ?0}` |'
- en: '| Fetch data for a given regular expression | `value = { ''lastName'' : { $regex:
    ?0 } }` |'
  id: totrans-150
  prefs: []
  type: TYPE_TB
  zh: '| 获取给定正则表达式的数据 | `value = { ''lastName'' : { $regex: ?0 } }` |'
- en: '| Fetch data having a field greater than a parameter | `value = { ''field''
    : { $gt: ?0 } }` |'
  id: totrans-151
  prefs: []
  type: TYPE_TB
  zh: '| 获取字段大于参数的数据 | `value = { ''field'' : { $gt: ?0 } }` |'
- en: '| Fetch data having a field greater than or equal to a parameter | `value =
    { ''field'' : { $gte: ?0 } }` |'
  id: totrans-152
  prefs: []
  type: TYPE_TB
  zh: '| 获取字段大于或等于参数的数据 | `value = { ''field'' : { $gte: ?0 } }` |'
- en: '| Fetch data having a field less than a parameter | `value = { ''field'' :
    { $lt: ?0 } }` |'
  id: totrans-153
  prefs: []
  type: TYPE_TB
  zh: '| 获取字段小于参数的数据 | `value = { ''field'' : { $lt: ?0 } }` |'
- en: '| Fetch data having a field less than or equal to a parameter | `value = {
    ''field'' : { $lte: ?0 } }` |'
  id: totrans-154
  prefs: []
  type: TYPE_TB
  zh: '| 获取字段小于或等于参数的数据 | `value = { ''field'' : { $lte: ?0 } }` |'
- en: '| Include only one field in the query | `fields = "{field : 1}"` |'
  id: totrans-155
  prefs: []
  type: TYPE_TB
  zh: '| 查询中仅包含一个字段 | `fields = "{field : 1}"` |'
- en: '| Exclude a field from the query | `fields = "{field : 0}"` |'
  id: totrans-156
  prefs: []
  type: TYPE_TB
  zh: '| 从查询中排除一个字段 | `fields = "{field : 0}"` |'
- en: 'The query filter is the argument of the `@Query` annotation: the `?0` placeholder
    will reference the first parameter of the method, the `?1` placeholder will reference
    the second parameter of the method, and so on, as shown in the following listing.'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 查询过滤器是`@Query`注解的参数：`?0`占位符将引用方法的第一个参数，`?1`占位符将引用方法的第二个参数，依此类推，如下所示。
- en: Listing 17.12 Limiting query results, sorting, and paging in `UserRepository`
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 列表17.12 在`UserRepository`中限制查询结果、排序和分页
- en: '[PRE12]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Ⓐ The `findUsersByActive` method will return the users with a given `active`
    status.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `findUsersByActive` 方法将返回具有给定`active`状态的用户。
- en: Ⓑ The `findUsersByLastName` method will return the users with a given `lastName`.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ `findUsersByLastName` 方法将返回具有给定`lastName`的用户。
- en: Ⓒ The `findUsersByRegexpLastName` method will return the users with a `lastName`
    matching the `?0` placeholder, referencing the regular expression that is the
    first parameter of the method.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ `findUsersByRegexpLastName` 方法将返回与`?0`占位符匹配的`lastName`的用户，该占位符引用了方法的第一个参数的正则表达式。
- en: Ⓓ The `findUsersByLevelBetween` method will return the users with a `level`
    greater than or equal to the `?0` placeholder, referencing the first parameter
    of the method, and less than or equal to the `?1` placeholder, referencing the
    second parameter of the method.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ `findUsersByLevelBetween` 方法将返回具有大于或等于`?0`占位符的`level`的用户，该占位符引用了方法的第一个参数，并且小于或等于`?1`占位符，该占位符引用了方法的第二个参数。
- en: 'Ⓔ The `findUsernameAndId` method will select all users (because the `value`
    parameter is `{}`) and will return only the `id` and the `username` fields (because
    the `fields` parameter is `{username : 1}`).'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 'Ⓔ `findUsernameAndId` 方法将选择所有用户（因为`value`参数是`{}`），并且只返回`id`和`username`字段（因为`fields`参数是`{username
    : 1}`）。'
- en: 'Ⓕ The `findUsersExcludeId` method will select all users (because the `value`
    parameter is `{}`) and will exclude the `id` from the returned fields (because
    the `fields` parameter is `{_id : 0}`).'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 'Ⓕ `findUsersExcludeId` 方法将选择所有用户（因为`value`参数是`{}`），并将`id`从返回的字段中排除（因为`fields`参数是`{_id
    : 0}`）。'
- en: Ⓖ The `findUsersByRegexpLastNameExcludeId` method will select users with a `lastName`
    matching a given regular expression and will exclude the `id` from the returned
    fields.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓖ `findUsersByRegexpLastNameExcludeId` 方法将选择与给定正则表达式匹配的`lastName`的用户，并将`id`从返回的字段中排除。
- en: Writing tests for these query methods is pretty straightforward and similar
    to the previous examples. They can be found in the source code for the book.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 为这些查询方法编写测试相当直接，并且与之前的示例相似。它们可以在本书的源代码中找到。
- en: 17.4 Query by Example
  id: totrans-168
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 17.4 示例查询
- en: 'Query by Example (QBE) was discussed in chapter 4 when we examined Spring Data
    JPA. It is a querying technique that does not require writing classical queries
    to include entities and properties. It allows dynamic query creation and consists
    of three pieces: a probe, an `ExampleMatcher,` and an `Example`.'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们检查Spring Data JPA时，第4章讨论了示例查询（QBE）。它是一种不需要编写经典查询来包含实体和属性的查询技术。它允许动态查询创建，并包含三个部分：一个探测器、一个`ExampleMatcher`和一个`Example`。
- en: A probe is a domain object with already set properties. The `ExampleMatcher`
    provides the rules about matching particular properties. The `Example` puts the
    probe and the `ExampleMatcher` together and generates the query. Multiple `Example`s
    can reuse a single `ExampleMatcher`.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 探测器是一个已经设置了属性的域对象。`ExampleMatcher`提供了关于匹配特定属性的规则。`Example`将探测器和`ExampleMatcher`组合在一起并生成查询。多个`Example`可以复用单个`ExampleMatcher`。
- en: 'As discussed before, these are the most appropriate use cases for QBE:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，这些是最适合QBE的使用场景：
- en: When you want to decouple work on the code from the underlying data store API
  id: totrans-172
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当你想要将代码的工作与底层数据存储API解耦时
- en: When you want to make frequent changes to the internal structure of the domain
    objects without propagating them to the existing queries
  id: totrans-173
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当你想要频繁更改域对象的内部结构而不将其传播到现有查询时
- en: When you are building a set of static or dynamic constraints to query a repository
  id: totrans-174
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当你正在构建一组静态或动态约束以查询存储库时
- en: 'QBE has some limitations:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: QBE有一些限制：
- en: It supports only starting/ending/containing/regex matching for `String` properties
    and only exact matching for other types.
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它仅支持对`String`属性进行起始/结束/包含/正则表达式匹配，以及其他类型的精确匹配。
- en: It does not support nested or grouped property constraints, such as `{"$or":[
    {"username":"username"},{{"lastName":"lastName",` `"email":"email"}}]}`.
  id: totrans-177
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它不支持嵌套或分组属性约束，例如`{"$or":[ {"username":"username"},{{"lastName":"lastName", "email":"email"}}]}`。
- en: We won’t add any more methods to the `UserRepository` interface. Instead we’ll
    write tests to build the probe, the `ExampleMatcher`s, and the `Example`s. The
    following listing will create a simple probe and a user having with the `lastName`
    set.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 我们不会向`UserRepository`接口添加更多方法。相反，我们将编写测试来构建探针、`ExampleMatcher`和`Example`。以下列表将创建一个简单的探针和一个设置了`lastName`的用户。
- en: Listing 17.13 Query By Example tests
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 列表17.13 查询示例测试
- en: '[PRE13]'
  id: totrans-180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Ⓐ Initialize a `User` instance and set up a `lastName` for it. This will represent
    the probe.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ 初始化一个`User`实例并为它设置一个`lastName`。这代表探针。
- en: Ⓑ Execute the query to find all users matching the probe.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 执行查询以找到所有与探针匹配的用户。
- en: Ⓒ Verify that the query to find all users matching the probe returned 2 documents,
    and it contains the `username`s `john` and `burk`.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 验证查询所有与探针匹配的用户返回了2个文档，并且包含`username`为`john`和`burk`的文档。
- en: We can now create an `ExampleMatcher` with the help of the builder pattern.
    Any `null` reference property will be ignored by the matcher. However, we’ll need
    to explicitly ignore properties that are primitives. If they are not ignored,
    they will be included in the matcher with their default values, and that would
    change the generated query.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在可以使用构建器模式创建`ExampleMatcher`。任何`null`引用属性都将被匹配器忽略。然而，我们需要明确忽略原始类型的属性。如果它们没有被忽略，它们将带有默认值包含在匹配器中，这将改变生成的查询。
- en: Listing 17.14 Query By Example with matcher tests
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 列表17.14 使用匹配器测试的查询示例
- en: '[PRE14]'
  id: totrans-186
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Ⓐ Create the `ExampleMatcher` with the help of the builder pattern. We explicitly
    ignore the `level` and `active` properties, which are primitives. If they were
    not ignored, they would be included in the matcher with their default values (0
    for `level` and `false` for `active`) and would change the generated query.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ 使用构建器模式创建`ExampleMatcher`。我们明确忽略`level`和`active`属性，它们是原始类型。如果它们没有被忽略，它们将带有默认值（`level`为0和`active`为`false`）包含在匹配器中，并改变生成的查询。
- en: Ⓑ Create and set a `User` probe.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 创建并设置一个`User`探针。
- en: Ⓒ Execute the query to find all users matching the probe.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 执行查询以找到所有与探针匹配的用户。
- en: Ⓓ Verify that the query to find all users matching the probe returned 2 documents,
    and it contains the `username`s `john` and `burk`.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 验证查询所有与探针匹配的用户返回了2个文档，并且包含`username`为`john`和`burk`的文档。
- en: 17.5 Referencing other MongoDB documents
  id: totrans-191
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 17.5 引用其他MongoDB文档
- en: Spring Data MongoDB does not support relationships in the sense of the one-to-one,
    one-to-many, and many-to-many relationships we examined for relational databases.
    The framework does not support embedding a document inside another document. However,
    a document may be referenced from another document using DBRefs. A DBRef will
    include the collection name and the value of the other document’s ID field, and
    optionally another database name.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: Spring Data MongoDB不支持关系数据库中我们考察的一对一、一对多和多对多关系。该框架不支持在另一个文档内嵌入文档。然而，可以使用DBRefs从另一个文档引用文档。DBRef将包括集合名称和另一个文档ID字段的值，以及可选的另一个数据库名称。
- en: To use DBRefs, we’ll create another class annotated with `@Document` and another
    MongoDB repository, and we’ll use the `@DBRef` annotation inside the class referencing
    the newly added document.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用DBRefs，我们将创建另一个带有`@Document`注解的类和另一个MongoDB仓库，并在类内部使用`@DBRef`注解引用新添加的文档。
- en: The new `Address` class we’ll add is shown in the following listing. It is annotated
    with `@Document`, like any class corresponding to a MongoDB document, and the
    fields are annotated with the Lombok `@Getter` annotation, indicating the automatic
    generation of the getters.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将添加的新`Address`类如下所示。它像任何对应MongoDB文档的类一样带有`@Document`注解，字段带有Lombok的`@Getter`注解，表示自动生成getter。
- en: Listing 17.15 The modified `Address` class
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 列表17.15 修改后的`Address`类
- en: '[PRE15]'
  id: totrans-196
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: The new `AddressRepository` interface is shown in the next listing. It extends
    `MongoRepository<Address, String>`, inheriting the MongoDB-related methods and
    managing the `Address` document, having IDs of type `String`.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个列表显示了新的`AddressRepository`接口。它扩展了`MongoRepository<Address, String>`，继承了MongoDB相关方法，并管理`Address`文档，具有`String`类型的ID。
- en: Listing 17.16 The `AddressRepository` interface
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.16 `AddressRepository` 接口
- en: '[PRE16]'
  id: totrans-199
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: We’ll modify the `User` class to include an `address` field that references
    the `Address` document. We’ll use the `@DBRef` annotation, indicating that this
    field will be stored using a DBRef. We’ll also annotate the field with the `@Field`
    annotation, which can provide a custom name inside the document.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将修改 `User` 类以包含一个 `address` 字段，该字段引用 `Address` 文档。我们将使用 `@DBRef` 注解，表示该字段将使用
    DBRef 存储方式。我们还将使用 `@Field` 注解该字段，该注解可以在文档内部提供自定义名称。
- en: Listing 17.17 The modified `User` class
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.17 修改后的 `User` 类
- en: '[PRE17]'
  id: totrans-202
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'A MongoDB document describing a user with an address could look like this:'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 描述具有地址的用户的一个 MongoDB 文档可能看起来像这样：
- en: '[PRE18]'
  id: totrans-204
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'A MongoDB document describing an address could look like this:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 描述地址的一个 MongoDB 文档可能看起来像这样：
- en: '[PRE19]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Note that operations such as save and delete are not cascaded between documents.
    If we save or delete a document, we have to explicitly save or delete the referenced
    documents.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，操作如保存和删除在文档之间不会级联。如果我们保存或删除一个文档，我们必须显式地保存或删除引用的文档。
- en: Writing tests for working with MongoDB documents that reference other documents
    is pretty straightforward and similar to the previous examples. They can be found
    in the source code for the book.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 为引用其他文档的 MongoDB 文档编写测试相对简单，并且与之前的示例类似。它们可以在本书的源代码中找到。
- en: 17.6 Using MongoTemplate to access a database
  id: totrans-209
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 17.6 使用 MongoTemplate 访问数据库
- en: '`MongoTemplate` is a class that provides access to CRUD operations against
    MongoDB databases. `MongoTemplate` implements the `MongoOperations` interface.
    The methods from `MongoOperations` are named similarly to the MongoDB driver `Collection`
    object methods, to facilitate understanding and use of the API.'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: '`MongoTemplate` 是一个提供对 MongoDB 数据库 CRUD 操作访问的类。`MongoTemplate` 实现了 `MongoOperations`
    接口。`MongoOperations` 中的方法命名与 MongoDB 驱动程序 `Collection` 对象的方法类似，以方便理解和使用 API。'
- en: 17.6.1 Configuring access to the database through MongoTemplate
  id: totrans-211
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 17.6.1 通过 MongoTemplate 配置对数据库的访问
- en: To connect our Spring Boot application to MongoDB, we’ll extend the `AbstractMongoClientConfiguration`
    class. This class provides support for the Java configuration of Spring Data MongoDB.
    We can connect to MongoDB through an implementation of the `MongoDatabaseFactory`
    interface and a `MongoTemplate`.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 要将我们的 Spring Boot 应用程序连接到 MongoDB，我们将扩展 `AbstractMongoClientConfiguration` 类。此类为
    Spring Data MongoDB 的 Java 配置提供支持。我们可以通过 `MongoDatabaseFactory` 接口和 `MongoTemplate`
    的实现来连接到 MongoDB。
- en: 'The `AbstractMongoClientConfiguration` class provides two beans that can be
    used in the Spring Boot application:'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: '`AbstractMongoClientConfiguration` 类提供了两个可以在 Spring Boot 应用程序中使用的 Bean：'
- en: '[PRE20]'
  id: totrans-214
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: We’ll create a `MongoDBConfig` class that extends `AbstractMongoClientConfiguration`,
    and we’ll only override the `getDatabaseName()` method to indicate that our Spring
    Boot application connects to the `test` database, as shown in the following listing.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将创建一个 `MongoDBConfig` 类，该类扩展 `AbstractMongoClientConfiguration`，并且我们只重写 `getDatabaseName()`
    方法来指示我们的 Spring Boot 应用程序连接到 `test` 数据库，如下所示。
- en: Listing 17.18 The `MongoDBConfig` class
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 17.18 `MongoDBConfig` 类
- en: '[PRE21]'
  id: totrans-217
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 17.6.2 Executing CRUD operations using MongoTemplate
  id: totrans-218
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 17.6.2 使用 MongoTemplate 执行 CRUD 操作
- en: To insert documents in a database, we can use the `MongoTemplate` `insert` method.
    The method is overloaded, and the following snippet uses the methods that have
    an object as an argument, or a collection of objects and their class.
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 要在数据库中插入文档，我们可以使用 `MongoTemplate` 的 `insert` 方法。该方法被重载，以下代码片段使用了带有对象作为参数的方法，或者一个对象集合及其类。
- en: '[PRE22]'
  id: totrans-220
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'The `save` method has different behavior: if the `id` is already present in
    the database, it executes an update; otherwise, it executes an insert. The method
    is also overloaded; the following snippet uses the methods that have an object
    and the collection name as arguments:'
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: '`save` 方法有不同的行为：如果 `id` 已经存在于数据库中，它执行更新操作；否则，它执行插入操作。该方法也是重载的；以下代码片段使用了带有对象和集合名称作为参数的方法：'
- en: '[PRE23]'
  id: totrans-222
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'We’ll use `org.springframework.data.mongodb.core.query.Query` objects to define
    criteria, projection, and sorting for retrieving MongoDB documents. Such a `Query`
    initiated using the default constructor will correspond to all documents in a
    collection. For example, we can remove all documents from a collection with a
    snippet like this:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用 `org.springframework.data.mongodb.core.query.Query` 对象来定义检索 MongoDB 文档的准则、投影和排序。使用默认构造函数初始化的此类
    `Query` 将对应于集合中的所有文档。例如，我们可以使用如下代码片段从集合中删除所有文档：
- en: '[PRE24]'
  id: totrans-224
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'We can modify `Query` objects using different criteria. Here we’ll build a
    query to look for users having `level` 1:'
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用不同的标准来修改`Query`对象。这里我们将构建一个查询来查找具有`level` 1的用户：
- en: '[PRE25]'
  id: totrans-226
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'We can build a query to look for users with a given `username` *and* `email`:'
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以构建一个查询来查找具有给定`username`和`email`的用户：
- en: '[PRE26]'
  id: totrans-228
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'We can similarly build a query to look for users with a given `username` *or*
    `email`:'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以类似地构建一个查询来查找具有给定`username`或`email`的用户：
- en: '[PRE27]'
  id: totrans-230
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'To update a document, we can use an object belonging to the `org.springframework
    .data.mongodb.core.query.Update` class. Such an object must be set with the new
    values to replace the old ones. `updateFirst` updates the first document found
    that matches the given criteria. The following code will find the first document
    from the `User` class having `level` 1 and will update it to `level` 2\. We can
    then get all the remaining users having `level` 1 using the `find` method:'
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 要更新文档，我们可以使用属于`org.springframework.data.mongodb.core.query.Update`类的对象。这样的对象必须设置为新值以替换旧值。`updateFirst`更新找到的第一个符合给定标准的文档。以下代码将找到`User`类中具有`level`
    1的第一个文档，并将其更新为`level` 2。然后我们可以使用`find`方法获取所有剩余的具有`level` 1的用户：
- en: '[PRE28]'
  id: totrans-232
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: '`updateMulti` updates all the documents found that match the given criteria.
    The following code will find all the documents from the `User` class having `level`
    1 and will update them to `level` 2:'
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: '`updateMulti`更新所有找到的符合给定标准的文档。以下代码将找到`User`类中所有具有`level` 1的文档，并将它们更新为`level`
    2：'
- en: '[PRE29]'
  id: totrans-234
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'The `findAndModify` method is similar to `updateMulti`, but it returns the
    object before it’s modified. In the following snippet, we check that the object
    returned by the `findAndModify` method still has the old `level` value:'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: '`findAndModify`方法与`updateMulti`类似，但它返回修改前的对象。在以下代码片段中，我们检查`findAndModify`方法返回的对象是否仍然具有旧的`level`值：'
- en: '[PRE30]'
  id: totrans-236
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'The `upsert` method will look for a document matching some given criteria.
    If it finds one, it will update it; otherwise, it will create a new document combining
    the query and update object. The name of the method is a combination of `update`
    and `insert`, and MongoDB will decide what to do depending on whether the document
    already exists. The following snippet uses the `getMatchedCount()` method to check
    that one document matched the query and the `getModifiedCount()` method to check
    that one document was modified by the update:'
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: '`upsert`方法将查找符合某些给定标准的文档。如果找到，它将更新它；如果没有找到，它将创建一个新的文档，该文档结合了查询和更新对象。方法名称是`update`和`insert`的组合，MongoDB将根据文档是否已存在来决定要做什么。以下代码片段使用`getMatchedCount()`方法检查是否有一个文档与查询匹配，并使用`getModifiedCount()`方法检查是否有一个文档被更新：'
- en: '[PRE31]'
  id: totrans-238
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: You can find comprehensive tests accessing MongoDB through `MongoTemplate` in
    the source code for the book.
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过访问`MongoTemplate`在书籍的源代码中找到对MongoDB的综合测试。
- en: For a comparison of the two approaches, `MongoRepository` and `MongoTemplate`,
    see table 17.7.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 关于两种方法`MongoRepository`和`MongoTemplate`的比较，请参阅表17.7。
- en: Table 17.7 Comparing `MongoRepository` and `MongoTemplate`
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 表17.7比较`MongoRepository`和`MongoTemplate`
- en: '|  | Strong points | Weak points |'
  id: totrans-242
  prefs: []
  type: TYPE_TB
  zh: '|  | 优点 | 缺点 |'
- en: '| `MongoRepository` |'
  id: totrans-243
  prefs: []
  type: TYPE_TB
  zh: '| `MongoRepository` |'
- en: Follows the approach of Spring Data JPA and Spring Data JDBC repositories.
  id: totrans-244
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 遵循Spring Data JPA和Spring Data JDBC仓库的方法。
- en: Allows us to quickly create methods with the query builder mechanism pattern,
    defining their behavior through their names.
  id: totrans-245
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 允许我们通过查询构建器机制模式快速创建方法，通过它们的名称定义其行为。
- en: '|'
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: Provides methods that perform basic CRUD operations working with all the fields
    of a document.
  id: totrans-247
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提供了执行基本CRUD操作的方法，这些操作与文档的所有字段一起工作。
- en: Updating a document must be executed either in steps (find, modify the relevant
    fields, save) or using methods annotated with `@Query`.
  id: totrans-248
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 更新文档必须在步骤中执行（查找、修改相关字段、保存）或使用带有`@Query`注解的方法。
- en: '|'
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: '| `MongoTemplate` |'
  id: totrans-250
  prefs: []
  type: TYPE_TB
  zh: '| `MongoTemplate` |'
- en: Provides atomic operations such as `updateFirst`, `updateMulti`, `findAndModify`,
    `upsert`.
  id: totrans-251
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提供了如`updateFirst`、`updateMulti`、`findAndModify`、`upsert`等原子操作。
- en: Atomic operations favor the work in concurrent applications.
  id: totrans-252
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 原子操作有利于并发应用程序的工作。
- en: The `Update` object allows us to choose only the fields to be updated.
  id: totrans-253
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Update`对象允许我们选择仅更新字段。'
- en: '|'
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: More verbose and more code to write, especially for simple operations.
  id: totrans-255
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 更冗长，需要编写的代码更多，尤其是对于简单操作。
- en: '|'
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: Summary
  id: totrans-257
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 概述
- en: You can create and configure a Spring Data MongoDB project using Spring Boot.
  id: totrans-258
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以使用Spring Boot创建和配置一个Spring Data MongoDB项目。
- en: You can create document classes and use the Spring Data MongoDB annotations
    to define simple and compound indexes, to mark fields as transient, and to define
    the persistence constructor.
  id: totrans-259
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以创建文档类，并使用Spring Data MongoDB注解来定义简单和复合索引，将字段标记为瞬态，并定义持久化构造函数。
- en: You can build custom interfaces extending `MongoRepository` and create custom
    methods following the query builder mechanism to interact with the MongoDB database.
  id: totrans-260
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以构建扩展`MongoRepository`的自定义接口，并按照查询构建器机制创建自定义方法，以与MongoDB数据库进行交互。
- en: You can use the Spring Data MongoDB capabilities for limiting query results,
    sorting, paging, and streaming the results.
  id: totrans-261
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以使用Spring Data MongoDB的能力来限制查询结果、排序、分页以及流式传输结果。
- en: You can use the `@Query` annotation to define custom queries, and you can work
    with the Query by Example (QBE) querying technique.
  id: totrans-262
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以使用`@Query`注解来定义自定义查询，并且可以使用示例查询（Query by Example，QBE）查询技术来与查询交互。
- en: You can configure an application to use `MongoTemplate` to execute CRUD operations
    against a MongoDB database.
  id: totrans-263
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以配置应用程序以使用`MongoTemplate`来对MongoDB数据库执行CRUD操作。
