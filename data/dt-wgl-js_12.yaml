- en: '13'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '13'
- en: Advanced visualization with D3
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 D3 进行高级可视化
- en: '**This chapter covers**'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: '**本章涵盖**'
- en: Creating vector graphics with SVG
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 SVG 创建矢量图形
- en: Creating out-of-the-ordinary visualizations with D3
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 D3 创建不同寻常的视觉呈现
- en: 'I couldn’t end this book without coverage of D3: the preeminent visualization
    framework for building interactive and animated browser-based visualizations in
    JavaScript.'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 没有介绍 D3：JavaScript 中构建交互式和动画浏览器可视化最杰出的框架，我就无法结束这本书。
- en: D3 (data-driven documents) is a complicated library; that’s why this is called
    the *advanced visualization* chapter. D3 has a large API and sophisticated concepts.
    This is a powerful addition to your toolkit, but unfortunately it comes with a
    steep learning curve! For most routine charts you’re better off using a simpler
    API, such as C3, which we covered in chapter 10\. When you reach the limitations
    of C3, however, or you want to create something completely out of the box, that’s
    when you’ll reach for D3.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: D3（数据驱动文档）是一个复杂的库；这就是为什么这一章被称为*高级可视化*。D3 拥有一个庞大的 API 和复杂的概念。这是你工具箱中的一个强大补充，但遗憾的是，它有一个陡峭的学习曲线！对于大多数常规图表，你最好使用一个更简单的
    API，比如我们在第 10 章中提到的 C3。然而，当你达到 C3 的限制，或者你想创建一些完全不同寻常的东西时，你才会转向 D3。
- en: I can’t hope to fully teach you D3; that would require a whole book. But I do
    hope to teach you fundamental concepts and how they relate. For example, we’ll
    learn one of D3’s core concepts, the *data join* pattern, and how to use it to
    translate our data to a visualization. D3 is a large and complex API, so we’ll
    only scratch the surface.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 我无法完全教你 D3；那需要一本书。但我确实希望教你基本概念以及它们之间的关系。例如，我们将学习 D3 的一个核心概念，即*数据连接*模式，以及如何使用它将我们的数据转换为可视化。D3
    是一个庞大且复杂的 API，所以我们只会触及表面。
- en: Are you ready to create a more advanced visualization? In this chapter, we’ll
    make something out of the ordinary, something that we couldn’t do with C3\. This
    example will give you an inkling of how powerful D3 is, and along the way, we’ll
    learn core D3 skills.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 你准备好创建一个更高级的可视化了么？在本章中，我们将做一些不同寻常的事情，一些我们无法用 C3 做的事情。这个例子将让你对 D3 的强大功能有所了解，在这个过程中，我们将学习核心的
    D3 技能。
- en: 13.1 Advanced visualization
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 13.1 高级可视化
- en: In this chapter, we’ll create a scalable vector graphics (SVG) visualization
    using D3\. We could also use D3 with HTML or Canvas, but it’s common to use it
    with SVG and we can definitely build something visually impressive that way. Don’t
    worry too much if you don’t know SVG, though, because we’ll start with a short
    SVG crash course.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将使用 D3 创建一个可伸缩矢量图形（SVG）可视化。我们也可以使用 D3 与 HTML 或 Canvas 一起使用，但通常与 SVG 一起使用，我们肯定可以通过这种方式构建一些视觉上令人印象深刻的东西。不过，如果你不知道
    SVG，也不要太担心，因为我们将从简短的 SVG 快速入门课程开始。
- en: The visualization we’ll create is shown in [figure 13.1](#figure13.1). This
    is a to-scale rendition of U.S. space junk in orbit around the Earth. By space
    junk, I mean the remnants of rockets, satellites, and other such things that are
    now abandoned but remain in space.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将创建的可视化显示在 [图 13.1](#figure13.1) 中。这是环绕地球的美国太空垃圾的按比例呈现。我所说的太空垃圾是指火箭、卫星和其他此类现在被遗弃但仍然在太空中的东西。
- en: '![c13_01.tif](Images/c13_01.png)'
  id: totrans-12
  prefs: []
  type: TYPE_IMG
  zh: '![c13_01.tif](Images/c13_01.png)'
- en: '[Figure 13.1](#figureanchor13.1) The finished product for this chapter: an
    animated, year-by-year, 2D visualization of US space junk orbiting the Earth'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.1](#figureanchor13.1) 本章的最终成果：一个逐年动画的、二维可视化，展示环绕地球的美国太空垃圾'
- en: 'In [figure 13.1](#figure13.1) the Earth is colored blue and surrounded by yellow,
    orange, and red objects: the space junk visuals have been color-coded according
    to their size. This coloration was applied by CSS styles, as you’ll see later.
    (To see figures in this chapter in color, please refer to the electronic versions
    of the book.)'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 在 [图 13.1](#figure13.1) 中，地球被涂成蓝色，周围环绕着黄色、橙色和红色的物体：太空垃圾的视觉呈现根据其大小进行了着色。这种着色是通过
    CSS 样式实现的，你将在后面看到。（要查看本章中的彩色图示，请参阅本书的电子版。）
- en: 'This visualization is interactive: as you hover your mouse pointer over an
    object of space junk, explanatory text will appear, as shown in [figure 13.2](#figure13.2).'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 这个可视化是交互式的：当你将鼠标指针悬停在太空垃圾对象上时，会显示解释性文本，如图 13.2 所示。
- en: '![c13_02.tif](Images/c13_02.png)'
  id: totrans-16
  prefs: []
  type: TYPE_IMG
  zh: '![c13_02.tif](Images/c13_02.png)'
- en: '[Figure 13.2](#figureanchor13.2) Explanatory text appears when you hover the
    mouse over a space junk object.'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.2](#figureanchor13.2) 当鼠标悬停在太空垃圾对象上时，会显示解释性文本。'
- en: 'This visualization is also animated: notice in [figure 13.1](#figure13.1) that
    the year is displayed at the top. Our animation will drive this visualization
    forward in time one year after the other. At each iteration of the animation,
    it will show the objects that were launched in that year and how much space junk
    has accumulated over the decades.'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 这个可视化也是动态的：注意在 [图 13.1](#figure13.1) 中，年份显示在顶部。我们的动画将使这个可视化随着时间的推移每年向前推进。在动画的每次迭代中，它将显示那一年发射的物体以及数十年来积累的太空垃圾量。
- en: 13.2 Getting the code and data
  id: totrans-19
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 13.2 获取代码和数据
- en: The code and data for this chapter are available in the Data Wrangling with
    JavaScript Chapter-13 repository in GitHub at [https://github.com/data-wrangling-with-javascript/chapter-13](https://github.com/data-wrangling-with-javascript/chapter-13)[.](http://.)
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 本章的代码和数据可在 GitHub 上的 Data Wrangling with JavaScript Chapter-13 仓库中找到，网址为 [https://github.com/data-wrangling-with-javascript/chapter-13](https://github.com/data-wrangling-with-javascript/chapter-13)。[.](http://.)
- en: Each subdirectory in the respository contains a complete working example, and
    each corresponds to various listings throughout this chapter. Before attempting
    to run the code in each subdirectory, please be sure to install Bower dependencies.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 仓库中的每个子目录都包含一个完整的工作示例，并且每个示例都与本章中的各种列表相对应。在尝试运行每个子目录中的代码之前，请确保已安装 Bower 依赖项。
- en: 'You can run each listing using live-server:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用 live-server 运行每个列表：
- en: '[PRE0]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This will open your browser and navigate to the web page. Refer to “Getting
    the code and data” in chapter 2 for help on getting the code and data.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 这将打开您的浏览器并导航到网页。有关获取代码和数据的帮助，请参阅第 2 章的“获取代码和数据”部分。
- en: 13.3 Visualizing space junk
  id: totrans-25
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 13.3 可视化太空垃圾
- en: Why space junk? I was looking for a visualization that would show off the power
    of D3, and I was inspired after attending a lecture on the proliferation of space
    junk at the World Science Festival. I did my own research after the lecture and
    found an amazing and accurate 3D visualization of space junk at [http://stuffin.space/](http://stuffin.space/)[.](http://.)
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么是太空垃圾？我正在寻找一个可以展示 D3 力量的可视化效果，在参加世界科学节关于太空垃圾扩散的讲座后，我受到了启发。讲座结束后，我进行了自己的研究，并在
    [http://stuffin.space/](http://stuffin.space/) 找到了一个令人惊叹且准确的太空垃圾 3D 可视化。[.](http://.)
- en: I decided to reproduce something similar to this for the book, but in 2D and
    using D3\. I’ve prefiltered the data to only U.S. space junk; otherwise, we’d
    have too much data and that would make for a cluttered visualization.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 我决定为这本书重现类似的内容，但使用 2D 和 D3 技术。我已经预先过滤了数据，只保留了美国太空垃圾的数据；否则，我们会拥有太多数据，这会使可视化变得杂乱无章。
- en: The data we’ll be using is in the JSON file us-space-junk.json that you can
    find in the Chapter-13 GitHub repository. As you can see in [figure 13.3](#figure13.3),
    each data record represents one object of space junk and is described by its name,
    size, launch date, and perigee.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用的数据存储在名为 us-space-junk.json 的 JSON 文件中，您可以在 Chapter-13 GitHub 仓库中找到它。如图
    13.3 所示，每条数据记录代表一个太空垃圾物体，并描述了其名称、大小、发射日期和近地点。
- en: Perigee is the nearest approach of the object to the Earth. We’ll use this in
    our visualization to approximate the object’s distance from the Earth.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 近地点是物体距离地球最近的位置。在我们的可视化中，我们将使用这个值来近似物体的地球距离。
- en: '![c13_03.eps](Images/c13_03.png)'
  id: totrans-30
  prefs: []
  type: TYPE_IMG
  zh: '![c13_03.eps](Images/c13_03.png)'
- en: '[Figure 13.3](#figureanchor13.3) JSON data that describes each object of space
    junk (an extract from us-space-junk.json)'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.3](#figureanchor13.3) 描述太空垃圾每个物体的 JSON 数据（us-space-junk.json 的摘录）'
- en: 13.4 What is D3?
  id: totrans-32
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 13.4 什么是 D3？
- en: D3, data-driven documents, is a JavaScript API for producing visualizations.
    People often call it a general-purpose visualization toolkit, by which they mean
    we aren’t limited or restricted in the types of visualizations that we can create
    with it. If you can imagine a visualization—well, a visualization that could be
    created in HTML, SVG, or Canvas—then you can most certainly create it using D3.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: D3，数据驱动文档，是一个用于生成可视化的 JavaScript API。人们经常称它为通用可视化工具包，这意味着我们使用它时不受限制或约束，可以创建各种类型的可视化。如果您能想象出一个可视化——好吧，一个可以用
    HTML、SVG 或 Canvas 创建的可视化——那么您肯定可以使用 D3 创建它。
- en: D3 isn’t specifically for building charts or any particular type of visualization;
    it’s powerful enough to express anything, and you only have to do an image search
    for D3 examples to see what I mean. I continue to be amazed by the range of visualizations
    that have been produced with D3.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: D3 并非专门用于构建图表或任何特定类型的可视化；它足够强大，可以表达任何内容，您只需进行一次 D3 示例的图片搜索，就能看到我的意思。我继续对使用 D3
    制作的各种可视化效果的广泛性感到惊讶。
- en: D3 was born out of the *New York Times* visualization department at the hands
    of Michael Bostock, Vadim Ogievetsky, and Jeffrey Heer. It’s the latest and greatest
    in a lineage of visualization APIs and has maturity and experience behind it.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: D3是由迈克尔·博斯特克、瓦迪姆·奥吉维茨基和杰弗里·希尔在《纽约时报》可视化部门创建的。它是可视化API家族中的最新和最强大的成员，拥有成熟的经验。
- en: We’ll use D3 to create a recipe for our space junk visualization. Adding our
    data to this recipe produces the visualization. No set process exists for turning
    data into a visualization with D3\. We must explicitly write the code that transforms
    our data into the visualization. We’re building a custom translation from data
    to visualization. As you can imagine, this is a powerful way to build a unique
    or custom visualization, but it quickly becomes tedious when you want a standard
    line or bar chart.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用D3为我们的太空垃圾可视化创建配方。将我们的数据添加到这个配方中会产生可视化。使用D3将数据转换为可视化的过程没有固定的流程。我们必须明确编写将我们的数据转换为可视化的代码。我们正在构建从数据到可视化的自定义转换。正如你可以想象的那样，这是一种构建独特或定制可视化的强大方式，但当你想要一个标准的线图或柱状图时，这会很快变得繁琐。
- en: 'D3 has overlap with jQuery: it allows us to select and create DOM nodes and
    then set values for their attributes in a way that may feel familiar if you’re
    already comfortable with jQuery. We can also add event handlers to DOM nodes to
    create interactivity; for example, in response to mouse hover and mouse clicks.'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: D3与jQuery有重叠：它允许我们选择和创建DOM节点，然后以可能让你感到熟悉的方式设置它们的属性值。我们还可以向DOM节点添加事件处理器以创建交互性；例如，对鼠标悬停和鼠标点击做出响应。
- en: D3 is likely to stretch you, though. Its power is built on abstract concepts,
    and this is what makes D3 hard to learn. D3 also requires advanced knowledge of
    JavaScript, but I’ll endeavor to keep things easy to understand, and we’ll build
    up from simple beginnings to a more complex visualization.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管如此，D3可能会让你感到挑战。它的强大之处在于抽象概念，这也是D3难以学习的原因。D3还要求具备高级的JavaScript知识，但我将努力使内容易于理解，并且我们会从简单的开始逐步构建到更复杂的数据可视化。
- en: D3 might be useful to you for creating visualizations from scratch, and we can
    also use our D3 skills to extend our C3 charts. It’s easy to hit the limits of
    C3—say, when you want to add extra graphics, interactivity, or animation to your
    C3 chart. But because C3 is built on D3, we can use the D3 API to extend C3 and
    add extra functionality to our C3 charts.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: D3对于从头开始创建可视化可能对你很有用，我们还可以使用我们的D3技能来扩展我们的C3图表。很容易达到C3的限制——比如说，当你想在C3图表中添加额外的图形、交互性或动画时。但由于C3建立在D3之上，我们可以使用D3
    API来扩展C3，并为我们的C3图表添加额外的功能。
- en: I’ve extolled the virtues of D3, but also hopefully I’ve convinced you not to
    take this lightly. The only reason to use D3 is to create an advanced visualization
    that you couldn’t otherwise create with a simpler API (such as C3). For example,
    you wouldn’t use D3 to create a bar chart of your company’s weekly sales. It’s
    not worthwhile—kind of like using a power hammer to apply a thumbtack, that would
    be overkill.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 我一直赞扬D3的优点，但同时也希望我已经说服了你们不要轻视它。使用D3的唯一原因是为了创建一个高级可视化，这是用更简单的API（如C3）无法实现的。例如，你不会用D3来创建公司每周销售额的柱状图。这样做不值得——有点像用一把大锤子来钉一个图钉，那将是过度杀鸡用牛刀。
- en: 13.5 The D3 data pipeline
  id: totrans-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 13.5 D3数据管道
- en: I’ve said that we’ll use D3 to create a recipe for our data visualization. Thinking
    of it as a recipe is one way to picture how D3 works.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 我说过，我们将使用D3来创建我们的数据可视化配方。将其视为配方是一种理解D3工作方式的方法。
- en: Another analogy I like is to think of our D3 recipe as a data pipeline. As you
    can see in [figure 13.4](#figure13.4), our data set goes through the pipeline
    and comes out the other side as a visualization.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 我还喜欢的一个类比是将我们的D3配方视为一个数据管道。如图13.4所示，我们的数据集通过管道传输，并在另一端以可视化的形式出现。
- en: '![c13_04.eps](Images/c13_04.png)'
  id: totrans-44
  prefs: []
  type: TYPE_IMG
  zh: '![c13_04.eps](Images/c13_04.png)'
- en: '[Figure 13.4](#figureanchor13.4) D3 creates a pipeline that converts our data
    set to a visualization.'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: '[图13.4](#figureanchor13.4) D3创建了一个将我们的数据集转换为可视化的管道。'
- en: However, D3 isn’t only for creating a new visualization in an empty DOM. Our
    D3 recipe can also describe how to add data to an existing visualization. This
    is what makes D3 so powerful; we can use it to update a live visualization as
    new data becomes available (see [figure 13.5](#figure13.5)).
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，D3不仅仅是为了在空DOM中创建新的可视化。我们的D3配方还可以描述如何将数据添加到现有的可视化中。这就是D3如此强大的原因；我们可以使用它来更新实时可视化，当新数据可用时（见图13.5）。
- en: The D3 pipeline that we’ll build will operate on a set of data records, as shown
    in [figure 13.6](#figure13.6). The pipeline visits each data record in turn and
    produces a DOM node to represent each object of space junk. This process results
    in a collection of new DOM nodes that collectively make up our visualization.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将要构建的 D3 管道将在一组数据记录上操作，如图 13.6 所示。管道依次访问每个数据记录，并为每个太空垃圾对象生成一个 DOM 节点。这个过程产生了一组新的
    DOM 节点，这些节点共同构成了我们的可视化。
- en: Are you ready to start coding up the space junk visualization?
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 你准备好开始编写太空垃圾可视化代码了吗？
- en: '![c13_05.eps](Images/c13_05.png)'
  id: totrans-49
  prefs: []
  type: TYPE_IMG
  zh: '![c13_05.eps](Images/c13_05.png)'
- en: '[Figure 13.5](#figureanchor13.5) A D3 data pipeline can update an existing
    visualization with new data.'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.5](#figureanchor13.5) D3 数据管道可以用新数据更新现有的可视化。'
- en: '![c13_06.eps](Images/c13_06.png)'
  id: totrans-51
  prefs: []
  type: TYPE_IMG
  zh: '![c13_06.eps](Images/c13_06.png)'
- en: '[Figure 13.6](#figureanchor13.6) D3 produces “bound DOM nodes” for each data
    record.'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.6](#figureanchor13.6) D3 为每个数据记录生成“边界 DOM 节点”。'
- en: 13.6 Basic setup
  id: totrans-53
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 13.6 基本设置
- en: First, let’s lay down the basic setup. [Listing 13.1](#listing13.1) show an
    HTML template for our D3 visualization. Eventually, we’ll use D3 to generate all
    our visuals, so this empty HTML template mostly suffices for our purposes in this
    chapter.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，让我们确定基本设置。[列表 13.1](#listing13.1) 展示了我们 D3 可视化的 HTML 模板。最终，我们将使用 D3 生成所有我们的视觉元素，所以这个空白的
    HTML 模板在本章中主要满足我们的需求。
- en: Listing 13.1 The HTML file for the D3 visualization (listing-13.1/index.html)
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.1 D3 可视化的 HTML 文件（listing-13.1/index.html）
- en: '[PRE1]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Note that the HTML file includes CSS and JavaScript files: app.css and app.js.
    As we start this chapter, both files are effectively empty. Soon, though, we’ll
    start adding D3 code to app.js, and we’ll style our visualization through app.css.'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，HTML 文件包括 CSS 和 JavaScript 文件：app.css 和 app.js。在我们开始本章时，这两个文件实际上都是空的。不过，很快我们就会开始向
    app.js 中添加 D3 代码，并通过 app.css 来设计我们的可视化。
- en: This is a blank canvas into which we’ll create our visualization. We’ll use
    D3 to procedurally generate the visuals, but before we do that, let’s manually
    add some SVG primitives directly to the HTML file so that we can get a handle
    on how SVG works.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个空白画布，我们将在这里创建我们的可视化。我们将使用 D3 逐步生成视觉元素，但在我们这样做之前，让我们直接将一些 SVG 基本元素手动添加到 HTML
    文件中，这样我们就可以了解 SVG 的工作原理。
- en: 13.7 SVG crash course
  id: totrans-59
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 13.7 SVG 快速入门
- en: SVG is an XML format, not unlike HTML, that’s used to render 2D vector graphics.
    Like HTML, SVG can be interactive and animated—something we’ll use in our visualization.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: SVG 是一种 XML 格式，类似于 HTML，用于渲染 2D 向量图形。像 HTML 一样，SVG 可以是交互式的和动画的——这是我们将在我们的可视化中使用的东西。
- en: SVG is an open standard that has been around for a significant amount of time.
    It was developed in 1999, but in more recent history has received support in all
    modern browsers and can thus be directly embedded in an HTML document.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: SVG 是一个存在了相当长一段时间的开放标准。它于 1999 年开发，但在最近的历史中，它已经得到了所有现代浏览器的支持，因此可以直接嵌入到 HTML
    文档中。
- en: This section serves as a quick primer for the SVG primitives we’ll use in our
    space junk visualization. If you already understand SVG primitives, attributes,
    element nesting, and translation, please skip this section and jump directly to
    “Building visualizations with D3.”
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 本节作为我们将在太空垃圾可视化中使用到的 SVG 基本元素的快速入门。如果你已经理解了 SVG 基本元素、属性、元素嵌套和转换，请跳过本节，直接跳到“使用
    D3 构建可视化”。
- en: 13.7.1 SVG circle
  id: totrans-63
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.7.1 SVG 圆形
- en: Let’s start with an `svg` element and set its width and height. This creates
    a space in which we can paint with vector graphics.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从设置 `svg` 元素的宽度和高度开始。这创建了一个我们可以用向量图形绘制的空间。
- en: 'The main primitive we’ll use is the `circle` element. [Figure 13.7](#figure13.7)
    shows an SVG circle (on the left), what the DOM looks like in Chrome’s DevTools
    (in the middle), and a schematic diagram (on the right) that relates the `circle`
    element to the `svg` element: the `circle` element is a child of the `svg` element.'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用的主要基本元素是 `circle` 元素。[图 13.7](#figure13.7) 显示了一个 SVG 圆形（在左侧），Chrome 的 DevTools
    中的 DOM 看起来如何（在中间），以及一个与 `circle` 元素和 `svg` 元素相关联的示意图（在右侧）：`circle` 元素是 `svg` 元素的子元素。
- en: '[Listing 13.2](#listing13.2) is the code for this simplest of visualizations.
    Note how attributes are used to set the position (cx and cy), radius (r), and
    color (fill) of the circle. You can also inspect the values of these attributes
    in Chrome’s DevTools (as shown in the middle of [figure 13.7](#figure13.7)).'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: '[列表 13.2](#listing13.2) 是这个最简单可视化的代码。注意属性是如何用来设置位置（cx 和 cy）、半径（r）和颜色（fill）的。你还可以在
    Chrome 的 DevTools 中检查这些属性的值（如图 13.7 中间所示）。'
- en: '![c13_07.eps](Images/c13_07.png)'
  id: totrans-67
  prefs: []
  type: TYPE_IMG
  zh: '![c13_07.eps](Images/c13_07.png)'
- en: '[Figure 13.7](#figureanchor13.7) An SVG circle element manually added to our
    SVG (with DOM viewed in Chrome DevTools)'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.7](#figureanchor13.7) 手动添加到我们的 SVG 中的 SVG 圆形元素（在 Chrome 开发者工具中查看 DOM）'
- en: Listing 13.2 Adding a `circle` element to the SVG (listing-13.2/index.html)
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.2 将 `circle` 元素添加到 SVG 中（在 listing-13.2/index.html 中）
- en: '[PRE2]'
  id: totrans-70
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: With this simple example, we probably don’t need to use the DevTools to inspect
    the DOM and the attribute values. We already know what they’re going to look like
    because that’s what we entered into the HTML file. But soon we’ll procedurally
    generate these circles using D3, so we won’t simply *know* how this looks. We
    need to inspect the actual results so that when things go wrong, we can troubleshoot
    and solve problems.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个简单的例子中，我们可能不需要使用开发者工具来检查 DOM 和属性值。因为我们已经知道它们将是什么样子，因为这是我们输入到 HTML 文件中的内容。但很快我们将使用
    D3 生成这些圆形，所以我们不会简单地“知道”它们看起来是什么样子。我们需要检查实际的结果，这样当事情出错时，我们可以进行故障排除和解决问题。
- en: Please take a moment now to run this simple visualization in the browser and
    use your browser’s DevTools to inspect the DOM structure and the circle’s attributes.
    It’s good practice to embed this kind of behavior early so that later when things
    get complicated and messed up, you’ll be better positioned to figure it out.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 请现在花点时间在浏览器中运行这个简单的可视化，并使用浏览器开发者工具检查 DOM 结构和圆的属性。在早期嵌入这种行为是很好的实践，这样当事情变得复杂和混乱时，你会处于更好的位置来解决问题。
- en: 13.7.2 Styling
  id: totrans-73
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.7.2 样式
- en: 'We can style SVG elements in the same way that we style HTML elements: using
    CSS styling. For example, in our simple circle visualization, we can move the
    circle’s fill color to CSS and separate our style from our structure. The following
    listing shows the modified `circle` element with the `fill` attribute removed;
    then [listing 13.3b](#listing13.3b) shows how we have moved the fill color to
    a CSS style.'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以像样式 HTML 元素一样样式化 SVG 元素：使用 CSS 样式。例如，在我们的简单圆形可视化中，我们可以将圆的填充颜色移动到 CSS 中，并将样式与结构分离。以下列表显示了修改后的
    `circle` 元素，其中移除了 `fill` 属性；然后 [列表 13.3b](#listing13.3b) 展示了我们将填充颜色移动到 CSS 样式中的方法。
- en: Listing 13.3a The circle’s fill attribute has been moved to CSS (extract from
    listing-13.3/index.html)
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.3a 圆的填充属性已移动到 CSS 中（从 listing-13.3/index.html 中提取）
- en: '[PRE3]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Listing 13.3b The circle’s fill color is now specified in CSS (listing-13.3/app.css)
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.3b 圆的填充颜色现在由 CSS 指定（在 listing-13.3/app.css 中）
- en: '[PRE4]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: We’ll use more CSS styling later in our visualization.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在可视化中稍后使用更多的 CSS 样式。
- en: 13.7.3 SVG text
  id: totrans-80
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.7.3 SVG 文本
- en: Let’s now add a `text` element as a title to accompany our circle, naming the
    circle as the Earth. [Figure 13.8](#figure13.8) shows our updated visualization
    (on the left) and a schematic diagram (on the right) that illustrates how the
    circle and text relate to the `svg` in the DOM.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们将添加一个 `text` 元素作为标题，与我们的圆一起，将圆命名为地球。[图 13.8](#figure13.8) 展示了我们的更新后的可视化（左侧）和示意图（右侧），它说明了圆形和文本如何与
    DOM 中的 `svg` 相关。
- en: '![c13_08.eps](Images/c13_08.png)'
  id: totrans-82
  prefs: []
  type: TYPE_IMG
  zh: '![c13_08.eps](Images/c13_08.png)'
- en: '[Figure 13.8](#figureanchor13.8) Using a `text` element to add a title to our
    Earth visual'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.8](#figureanchor13.8) 使用 `text` 元素为我们的地球可视化添加标题'
- en: '[Listing 13.4a](#listing13.4a) shows the addition of the `text` element, and
    we now have a simple visualization of the Earth*.* Feel free to load this up in
    your browser, open the DevTools, and inspect the DOM to see how it looks now.'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: '[列表 13.4a](#listing13.4a) 展示了添加 `text` 元素，现在我们有了地球的简单可视化。请随意在浏览器中打开它，打开开发者工具，检查
    DOM 看看现在的样子。'
- en: Listing 13.4a Adding a title to our Earth visual (extract from listing-13.4/index.html)
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.4a 为我们的地球可视化添加标题（从 listing-13.4/index.html 中提取）
- en: '[PRE5]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: To accompany our text, we’ll add a new CSS style. As shown in the following
    listing, we set `text-anchor` to `middle` and this centers our text around its
    position—a nice touch for its use as a title.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 为了配合我们的文本，我们将添加一个新的 CSS 样式。如下所示，我们将 `text-anchor` 设置为 `middle`，这样我们的文本就围绕其位置居中——这是一个用作标题的不错的小技巧。
- en: Listing 13.4b CSS styling for the new `text` element (extract from listing-13.4/app.css)
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.4b 新 `text` 元素的 CSS 样式（从 listing-13.4/app.css 中提取）
- en: '[PRE6]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 13.7.4 SVG group
  id: totrans-90
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.7.4 SVG 组
- en: It’s been simple so far, but let’s get more serious. We need a way to position
    our space junk around our Earth. We’ll use the SVG `g` element to assemble a *group*
    of SVG primitives and position them as a single entity. The schematic diagram
    in [figure 13.9](#figure13.9) shows how our circle and text relate to the group
    that’s now nested under the `svg`.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，这很简单，但让我们更加严肃。我们需要一种方法来定位我们围绕地球的空间垃圾。我们将使用SVG `g`元素来组装一个*组* SVG原语，并将它们作为一个单一实体定位。图13.9中的示意图显示了我们的圆圈和文本如何与现在嵌套在`svg`下的组相关。
- en: '[Listing 13.5](#listing13.5) shows how we enclose the `circle` and `text` in
    the `g` element. Note the `transform` attribute on the group, along with a `translate`
    command that work together to set the group’s position. This allows us to position
    both the circle and the text at any location within the SVG element. Try loading
    the following listing into your browser and then modify the `translate` coordinates
    to move the group to various other locations.'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '[列表13.5](#listing13.5) 展示了如何将`circle`和`text`元素包含在`g`元素中。注意组上的`transform`属性以及一个`translate`命令，它们共同设置组的位置。这允许我们在SVG元素内的任何位置定位圆圈和文本。尝试将以下列表加载到您的浏览器中，然后修改`translate`坐标以将组移动到其他位置。'
- en: Listing 13.5 Grouping the visuals in a *g* element to treat them as a single
    entity (extract from listing-13.5/index.html)
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 列表13.5 在`g`元素中分组视觉元素以将它们视为单一实体（来自列表-13.5/index.html）
- en: '[PRE7]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: We’re now armed with enough SVG basics to build our D3 visualization. We know
    how to use `circle`, `text`, and `g` elements to create an SVG visualization.
    Now let’s learn D3.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经掌握了足够的SVG基础知识来构建我们的D3可视化。我们知道如何使用`circle`、`text`和`g`元素来创建SVG可视化。现在让我们学习D3。
- en: '![c13_09.eps](Images/c13_09.png)'
  id: totrans-96
  prefs: []
  type: TYPE_IMG
  zh: '![c13_09.eps](Images/c13_09.png)'
- en: '[Figure 13.9](#figureanchor13.9) Schematic diagram showing our DOM with circle
    and text grouped together under a g element'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: '[图13.9](#figureanchor13.9) 展示了我们的DOM结构，其中圆圈和文本被分组在g元素下'
- en: 13.8 Building visualizations with D3
  id: totrans-98
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 13.8 使用D3构建可视化
- en: To build a D3 visualization, we must select, create, configure, and modify our
    SVG elements. Let’s start with configuring element state.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 要构建D3可视化，我们必须选择、创建、配置和修改我们的SVG元素。让我们从配置元素状态开始。
- en: 13.8.1 Element state
  id: totrans-100
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.8.1 元素状态
- en: Each element has an associated state that’s specified through its attributes.
    We’ve already seen how to manually set various SVG attributes—for example, the
    circle’s `cx`, `cy`, `r,` and `fill` attributes. [Table 13.1](#table13.1) is a
    summary of the attributes and the values we’ve already assigned.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 每个元素都有一个与之关联的状态，该状态通过其属性指定。我们已经看到了如何手动设置各种SVG属性——例如，圆圈的`cx`、`cy`、`r`和`fill`属性。[表13.1](#table13.1)
    是我们已分配的属性和值的总结。
- en: Table 13.1 Element state for the circle from [listing 13.2](#listing13.2)
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 表13.1 来自[列表13.2](#listing13.2) 的圆元素的元素状态
- en: '| **Attribute** | **Value** | **Purpose** |'
  id: totrans-103
  prefs: []
  type: TYPE_TB
  zh: '| **属性** | **值** | **目的** |'
- en: '| --- | --- | --- |'
  id: totrans-104
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| `cx` | 250 | X position of the circle |'
  id: totrans-105
  prefs: []
  type: TYPE_TB
  zh: '| `cx` | 250 | 圆圈的X位置 |'
- en: '| `cy` | 250 | Y position of the circle |'
  id: totrans-106
  prefs: []
  type: TYPE_TB
  zh: '| `cy` | 250 | 圆圈的Y位置 |'
- en: '| `r` | 50 | Radius of the circle |'
  id: totrans-107
  prefs: []
  type: TYPE_TB
  zh: '| `r` | 50 | 圆的半径 |'
- en: '| `fill` | #01499D | Fill color for the circle (earth blue) |'
  id: totrans-108
  prefs: []
  type: TYPE_TB
  zh: '| `fill` | #01499D | 圆圈的填充颜色（地球蓝） |'
- en: '[Figure 13.10](#figure13.10) highlights how these attributes look when viewed
    in Chrome’s DevTools. This looks the same regardless of whether the attributes
    were set manually in SVG or if we use the D3 API to set their values.'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: '[图13.10](#figure13.10) 突出了这些属性在Chrome的开发者工具中的外观。无论这些属性是在SVG中手动设置还是在使用D3 API设置其值时，外观都是相同的。'
- en: 'To set attribute values using D3, we’ll use the `attr` function. Assuming we
    already have a reference to our `circle` element, we can set attributes in code
    as follows:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用D3设置属性值，我们将使用`attr`函数。假设我们已经有了一个对`circle`元素的引用，我们可以在代码中设置属性如下：
- en: '[PRE8]'
  id: totrans-111
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: We can’t set attributes on an element unless we have a reference to it, so let’s
    now look at how to select an element so that we can work on it.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 除非我们有元素的引用，否则我们无法设置其属性，因此现在让我们看看如何选择一个元素，以便我们可以对其进行操作。
- en: 13.8.2 Selecting elements
  id: totrans-113
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.8.2 选择元素
- en: With D3 we have three basic ways to reference an element. We can select a single
    existing element. We can select multiple elements at once. Or we can procedurally
    create elements and add them to the DOM. Ultimately, we need all three of these
    methods, but it’s the last one that we’ll use to generate our initial visualization.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 使用D3，我们有三种基本的方式来引用一个元素。我们可以选择一个现有的单个元素。我们可以一次性选择多个元素。或者我们可以按程序创建元素并将它们添加到DOM中。最终，我们需要这三种方法，但我们将使用最后一种方法来生成我们的初始可视化。
- en: Single element
  id: totrans-115
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 单个元素
- en: We can select a single element with D3’s `select` function. You can see in [figure
    13.11](#figure13.11) that I’m representing the current D3 selection with a dotted
    box that has selected our `circle` element.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用 D3 的 `select` 函数选择单个元素。您可以在 [图 13.11](#figure13.11) 中看到，我用一个虚线框表示当前的
    D3 选择，该虚线框选择了我们的 `circle` 元素。
- en: '![c13_11.eps](Images/c13_11.png)'
  id: totrans-117
  prefs: []
  type: TYPE_IMG
  zh: '![c13_11.eps](Images/c13_11.png)'
- en: '[Figure 13.11](#figureanchor13.11) Use the D3 `select` function to operate
    on a single existing DOM node.'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.11](#figureanchor13.11) 使用 D3 的 `select` 函数操作单个现有 DOM 节点。'
- en: 'Assuming we already have an existing element, say our `circle` element, we
    can use the D3 `select` function to select our circle using a CSS-style selector:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 假设我们已经有了一个现有的元素，比如说我们的 `circle` 元素，我们可以使用 D3 的 `select` 函数通过 CSS 风格的选择器来选择我们的圆圈：
- en: '![c13_10.eps](Images/c13_10.png)'
  id: totrans-120
  prefs: []
  type: TYPE_IMG
  zh: '![c13_10.eps](Images/c13_10.png)'
- en: '[Figure 13.10](#figureanchor13.10) Viewing the attributes of the circle element
    in Chrome DevTools'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.10](#figureanchor13.10) 在 Chrome DevTools 中查看圆形元素的属性'
- en: '[PRE9]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '[Listing 13.6a](#listing13.6a) shows a real example. Here we’re selecting the
    `svg` element and setting its width and height based on the dimensions of the
    document. This sizes our visualization to make full use of the space available
    in the browser window.'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: '[列表 13.6a](#listing13.6a) 展示了一个真实示例。在这里，我们选择了 `svg` 元素，并根据文档的尺寸设置其宽度和高度。这样，我们的可视化就可以充分利用浏览器窗口中可用的空间。'
- en: Listing 13.6a Selecting the svg element and setting its dimensions (extract
    from listing-13.6/app.js)
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.6a 选择 svg 元素并设置其尺寸（来自列表-13.6/app.js）
- en: '[PRE10]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Note that we’re also referencing the `svg` element by its CSS class name. This
    makes our selection a bit more specific, in case we have multiple visualizations
    in the same page.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，我们还在通过其 CSS 类名引用 `svg` 元素。这使得我们的选择更加具体，以防我们在同一页面上有多个可视化。
- en: The `svg.chart` that we see here is like a CSS selector. If you’re familiar
    with jQuery, you’ll be comfortable with this code because jQuery selection by
    CSS selector and setting attribute values are similar to this.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 我们看到的 `svg.chart` 类似于 CSS 选择器。如果您熟悉 jQuery，您会对这段代码感到舒适，因为 jQuery 通过 CSS 选择器和设置属性值与这类似。
- en: Multiple elements
  id: totrans-128
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 多个元素
- en: We can also use D3 to select and operate on multiple elements simultaneously.
    You can see in [figure 13.12](#figure13.12) that the dotted box representing the
    D3 selection now encloses multiple existing `circle` elements.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 我们也可以使用 D3 同时选择和操作多个元素。您可以在 [图 13.12](#figure13.12) 中看到，代表 D3 选择的虚线框现在包围了多个现有的
    `circle` 元素。
- en: '![c13_12.eps](Images/c13_12.png)'
  id: totrans-130
  prefs: []
  type: TYPE_IMG
  zh: '![c13_12.eps](Images/c13_12.png)'
- en: '[Figure 13.12](#figureanchor13.12) Using D3 to select and operate on multiple
    DOM nodes at once'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.12](#figureanchor13.12) 使用 D3 同时选择和操作多个 DOM 节点'
- en: 'We can use D3’s `selectAll` function to select multiple existing elements as
    follows:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用 D3 的 `selectAll` 函数如下选择多个现有元素：
- en: '[PRE11]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Note that when we call `attr` on a selection with multiple elements, the value
    of the attribute will be updated for all those elements. This allows us to configure
    a set of elements at once, something that will be useful when we want to configure
    the visuals for our full set of space junk objects.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，当我们对一个包含多个元素的选取调用 `attr` 时，该属性的值将更新所有这些元素。这允许我们一次性配置一组元素，这在我们要配置我们全部空间垃圾对象的可视化时将非常有用。
- en: Adding a new element
  id: totrans-135
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 添加新元素
- en: The last way to select an element is to add a new element. When we add a new
    element, it’s automatically selected so that we can set its initial state. Pay
    attention now, because this is how we’ll procedurally create visuals for our space
    junk. We have many pieces of space junk to represent in our visualization, and
    we need to programmatically add DOM elements. If we added them manually, that
    would be tedious work, not to mention that we couldn’t easily animate a manually
    prepared visualization.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 选择元素的最后一种方式是添加新元素。当我们添加新元素时，它会自动被选中，这样我们就可以设置其初始状态。请注意，因为这是我们创建空间垃圾可视化的程序化方法。在我们的可视化中，我们需要表示许多空间垃圾，并且需要以编程方式添加
    DOM 元素。如果我们手动添加它们，那将是一项繁琐的工作，更不用说我们无法轻松地动画化手动准备的可视化了。
- en: '[Listing 13.6b](#listing13.6b) shows how we’ll add a procedurally generated
    Earth to our visualization using D3’s `append` function. Appending an element
    results in a selection, although in this case it’s a selection that contains a
    single DOM node. We can still set attributes on the element, and we use that here
    to set the class, position, and radius for the Earth.'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: '[列表 13.6b](#listing13.6b) 展示了我们将如何使用 D3 的 `append` 函数将程序生成的地球添加到我们的可视化中。添加一个元素会产生一个选择，尽管在这种情况下，它是一个包含单个
    DOM 节点的选择。我们仍然可以设置元素的属性，我们在这里使用它来设置地球的类、位置和半径。'
- en: Listing 13.6b Adding the “earth” to our visualization (extract from listing-13.6/app.js)
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.6b 将“地球”添加到我们的可视化中（摘自 listing-13.6/app.js）
- en: '[PRE12]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 13.8.3 Manually adding elements to our visualization
  id: totrans-140
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.8.3 手动添加元素到我们的可视化中
- en: The right way to use the D3 API is to map over our data and procedurally create
    visuals for each of our space junk data records. That’s a bit of a leap to make
    right now and might be difficult to understand. Let’s first look at this in a
    more straightforward way.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 正确使用 D3 API 的方法是遍历我们的数据，并为我们的每个太空垃圾数据记录程序化地创建视觉效果。这现在可能是一个很大的跳跃，可能难以理解。让我们首先以更直接的方式来看这个问题。
- en: What’s the simplest way that we might add visuals for each of our data records?
    Well, we could loop over our array of data and call the `append` function to add
    a new visual for each object of space junk.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可能以什么最简单的方式为我们的每个数据记录添加视觉效果呢？嗯，我们可以遍历我们的数据数组，并调用 `append` 函数为每个太空垃圾对象添加一个新的视觉效果。
- en: Anyone who knows anything about D3 will tell you that this isn’t the right way
    to use D3, and they’re correct, but I’d like us to first take a simpler approach
    so that later we might better appreciate the magic that D3 will do on our behalf.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 任何了解 D3 的人都会告诉你这不是正确使用 D3 的方法，他们是对的，但我希望我们首先采取一种更简单的方法，这样我们以后才能更好地欣赏 D3 为我们带来的魔法。
- en: If we instantiate DOM elements to correspond to our space junk data, we’ll end
    up with something like [figure 13.13](#figure13.13). It won’t look exactly the
    same, though, because we’re using randomized coordinates for our space junk. It
    will choose different positions each time we run it. The DOM is displayed on the
    right so that you can see the DOM node for each space junk object.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们实例化 DOM 元素以对应我们的太空垃圾数据，我们最终会得到类似于 [图 13.13](#figure13.13) 的东西。不过，它看起来不会完全一样，因为我们正在使用随机坐标来表示太空垃圾。每次运行它时，它都会选择不同的位置。DOM
    显示在右侧，这样你可以看到每个太空垃圾对象的 DOM 节点。
- en: '![c13_13.eps](Images/c13_13.png)'
  id: totrans-145
  prefs: []
  type: TYPE_IMG
  zh: '![c13_13.eps](Images/c13_13.png)'
- en: '[Figure 13.13](#figureanchor13.13) Viewing the DOM hierarchy for our manually
    added DOM nodes in Chrome DevTools: our visualization is starting to take shape.'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.13](#figureanchor13.13) 在 Chrome DevTools 中查看我们手动添加的 DOM 节点的 DOM 层级：我们的可视化开始成形。'
- en: To the right of [figure 13.13](#figure13.13), you can see how I’ve hovered the
    mouse pointer over the DOM node in Chrome’s DevTools. This is a useful debugging
    technique because it highlights the corresponding element in the visualization.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 在 [图 13.13](#figure13.13) 的右侧，你可以看到我在 Chrome 的 DevTools 中将鼠标指针悬停在 DOM 节点上。这是一个有用的调试技术，因为它会在可视化中突出显示相应的元素。
- en: The following listing shows the code for looping over your data and adding a
    visual for each data record. You can see that for each data record we call D3’s
    `append` function to flesh out our visualization.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 下面的列表显示了循环遍历数据并为每个数据记录添加视觉效果的代码。你可以看到，对于每个数据记录，我们调用 D3 的 `append` 函数来完善我们的可视化。
- en: Listing 13.7 Manually adding space junk elements to our D3 visualization (extract
    from listing-13.7/app.js)
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.7 手动添加太空垃圾元素到我们的 D3 可视化中（摘自 listing-13.7/app.js）
- en: '[PRE13]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Looping over our data manually like this and calling `append` multiple times
    isn’t the right way to use D3, but I’m hoping that taking this stepping stone
    has made it easier for you to understand how D3 works. In a moment, we’ll look
    at how to do this the right way. First, though, we should get our scaling in order.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 以这种方式手动遍历我们的数据并多次调用 `append` 并不是正确使用 D3 的方法，但我希望这个垫脚石已经使你更容易理解 D3 的工作原理。稍后，我们将看看如何正确地做这件事。不过，首先，我们应该把我们的缩放顺序整理好。
- en: 13.8.4 Scaling to fit
  id: totrans-152
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.8.4 缩放以适应
- en: Up to now, with our visualization we’ve used a bunch of hard-coded coordinates
    and measurements. For example, we set the radius of the Earth to 50 pixels in
    [listing 13.6b](#listing13.6b), and although you can’t see it in [listing 13.7](#listing13.7),
    the orbit distance of the space junk is also a hard-coded value. We’d like to
    replace these values with to-scale versions that do represent the actual size
    of the Earth and the real orbit distance for each object of space junk.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们使用可视化时已经使用了一系列硬编码的坐标和测量值。例如，我们在[代码列表13.6b](#listing13.6b)中将地球的半径设置为50像素，尽管你在[代码列表13.7](#listing13.7)中看不到，但太空垃圾的轨道距离也是一个硬编码的值。我们希望用按比例缩放的版本来替换这些值，这些值确实代表了地球的实际大小和每个太空垃圾对象的实际轨道距离。
- en: Also, we haven’t made effective use of the space within our visualization, as
    you can see on the left side of [figure 13.14](#figure13.14). What we want is
    for our visualization to take up all the available space and be more like the
    right side of [figure 13.14](#figure13.14).
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，我们还没有有效地利用可视化中的空间，正如你在[图13.14](#figure13.14)的左侧所看到的。我们希望我们的可视化占据所有可用空间，更像[图13.14](#figure13.14)的右侧。
- en: D3 has support for scaling, and we’ll use the `scaleLinear` function as demonstrated
    in [listing 13.8a](#listing13.8a). This creates a D3 scale that linearly maps
    the actual radius of our Earth (6,371 KMs) to fit*neatly*within the available
    space.**
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: D3支持缩放，我们将使用[代码列表13.8a](#listing13.8a)中展示的`scaleLinear`函数。这创建了一个D3比例，它将地球的实际半径（6,371千米）线性映射以适应可用的空间，并且*整齐地*嵌入其中。
- en: '**Listing 13.8a Scaling the size of the Earth to fit the space available (extract
    from listing-13.8/app.js)'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: '**[代码列表13.8a] 缩放地球大小以适应可用空间（摘自`listing-13.8/app.js`）**'
- en: '[PRE14]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Also notice in [listing 13.8a](#listing13.8a) how we also account for the orbit
    distance of each object of space junk. The greatest of these values is determined
    using the D3 `max` function.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 还请注意，在[代码列表13.8a](#listing13.8a)中，我们如何也考虑了每个太空垃圾对象的轨道距离。这些值中的最大值是使用D3的`max`函数确定的。
- en: The scale that we produce, `radiusScale`, is a JavaScript function. Nothing
    more or nothing less. We can pass real values (such as the radius of the Earth)
    to this function, and it will produce a scaled value in pixels that fits within
    our browser window.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 我们生成的比例`radiusScale`是一个JavaScript函数。没有更多，也没有更少。我们可以向这个函数传递真实值（如地球的半径），它将生成一个适合我们浏览器窗口的缩放值。
- en: '![c13_14.eps](Images/c13_14.png)'
  id: totrans-160
  prefs: []
  type: TYPE_IMG
  zh: '![c13_14.eps](Images/c13_14.png)'
- en: '[Figure 13.14](#figureanchor13.14) Side-by-side examples to demonstrate the
    effects of scaling. The visualization on the right uses real-world dimensions
    but is scaled down to snuggly fit the available space in the browser window.'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: '[图13.14](#figureanchor13.14) 并排示例以展示缩放效果。右侧的可视化使用了现实世界的尺寸，但已缩小以适应浏览器窗口中可用的空间。'
- en: We also use the same `radiusScale` function to scale the orbit distance for
    our space junk, as you can see in [listing 13.8b](#listing13.8b). The orbit radius
    is derived from the radius of the Earth plus the perigee (nearest orbital approach)
    of the space junk. This value is then passed through `radiusScale` to convert
    the value to pixels. This is then used to position the space junk within the visualization.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还使用相同的`radiusScale`函数来缩放太空垃圾的轨道距离，正如你在[代码列表13.8b](#listing13.8b)中所看到的。轨道半径是从地球半径加上太空垃圾的近地点（最近的轨道接近点）得出的。然后，这个值通过`radiusScale`函数转换成像素值。然后，这个值被用来在可视化中定位太空垃圾。
- en: Listing 13.8b The orbital distance of each object of space junk is also scaled
    to fit (extract from listing-13.8/app.js)
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: '[代码列表13.8b] 太空垃圾每个对象的轨道距离也被缩放以适应（摘自`listing-13.8/app.js`）'
- en: '[PRE15]'
  id: totrans-164
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Okay, we have our scaling sorted. We’re close to having the first version of
    our visualization ready. What we need to do now is make sure our space junk visuals
    are produced in the D3 way rather than the manual loop and append that we used
    earlier.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 好的，我们已经解决了缩放问题。我们几乎准备好了第一个版本的可视化。我们现在需要确保我们的太空垃圾视觉效果是以D3方式生成的，而不是我们之前使用的手动循环和追加。
- en: 13.8.5 Procedural generation the D3 way
  id: totrans-166
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.8.5 D3方式的过程生成
- en: This is where things start to get rather tricky. You must now come to terms
    with what’s known as the D3 concepts of data join and entry selection. These are
    difficult to understand because they have two purposes, although to start with
    we only need one of those. We’ll use this technique now to create our visualization
    from nothing. Later on, when we come to building our animation, we’ll use this
    same technique to add new data to our preexisting visualization.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 这就是事情开始变得相当棘手的地方。你现在必须接受D3的数据连接和条目选择的概念。这些概念难以理解，因为它们有两个目的，尽管一开始我们只需要其中一个。我们现在将使用这项技术从无到有地创建我们的可视化。稍后，当我们开始构建动画时，我们将使用同样的技术向现有的可视化中添加新数据。
- en: I’m telling you this now because it’s difficult to understand how a data join
    works without also understanding that it’s not only for producing a fresh visualization.
    The reason that it’s complicated is that this technique is also for updating an
    existing visualization.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 我现在告诉你这一点，因为如果不理解数据连接不仅用于产生新的可视化，那么很难理解数据连接的工作原理。这个技术之所以复杂，是因为它也用于更新现有的可视化。
- en: What’s the purpose of D3 data join?
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: D3数据连接的目的是什么？
- en: To pair DOM nodes and data records
  id: totrans-170
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为了配对DOM节点和数据记录
- en: To sort out new and existing data records
  id: totrans-171
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为了整理新和现有的数据记录
- en: To animate the addition and removal of data records
  id: totrans-172
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为了动画化数据记录的增加和移除
- en: We’re going to use D3’s `selectAll` function to produce a selection of `g` elements,
    but because we don’t even have any such elements in our visualization yet, this
    is going to give us what’s called an *empty selection*.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用D3的`selectAll`函数来生成一个`g`元素的选择，但由于我们可视化中甚至还没有这样的元素，这将给我们一个所谓的*空选择*。
- en: After calling `selectAll`, we’ll call D3’s `data` function passing in our space
    junk data set. This creates the so-called *data join* and produces a selection
    of DOM nodes that are bound to our data records. But wait, we don’t have any DOM
    nodes yet! What do we get out of this operation? As depicted in [figure 13.15](#figure13.15),
    these aren’t ordinary DOM nodes. We don’t have any DOM nodes in our visualization
    yet, so D3 created a set of placeholder DOM nodes with one placeholder per record
    of data. Soon we’re going to fill in these blanks with actual DOM nodes to represent
    our space junk.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 在调用`selectAll`之后，我们将调用D3的`data`函数，传入我们的太空垃圾数据集。这创建了所谓的*数据连接*，并产生了一个与我们的数据记录绑定的DOM节点选择。但是等等，我们还没有任何DOM节点！这个操作我们得到了什么？如[图13.15](#figure13.15)所示，这些不是普通的DOM节点。在我们的可视化中还没有任何DOM节点，所以D3创建了一组占位符DOM节点，每个数据记录一个占位符。很快，我们将用实际的DOM节点来填充这些空白，以表示我们的太空垃圾。
- en: '![c13_15.eps](Images/c13_15.png)'
  id: totrans-175
  prefs: []
  type: TYPE_IMG
  zh: '![c13_15.eps](Images/c13_15.png)'
- en: '[Figure 13.15](#figureanchor13.15) Our initial data join produces placeholder
    DOM nodes that are bound to our data records.'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: '[图13.15](#figureanchor13.15) 我们最初的数据连接产生了与我们的数据记录绑定的占位符DOM节点。'
- en: '[Figure 13.16](#figure13.16) illustrates how joining an empty selection of
    `g` elements with our data produces the set of placeholder DOM nodes that are
    bound to our data.'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: '[图13.16](#figure13.16) 展示了如何将一个空的`g`元素选择与我们的数据结合，从而产生与我们的数据绑定的占位符DOM节点集。'
- en: If you’re confused at this point, well, I can feel your pain. In my opinion,
    the data join and the concept of placeholder DOM nodes is probably the most confusing
    thing you’ll be confronted with when learning D3\. If you can get your head around
    this, then the rest of D3 won’t be as difficult.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你现在感到困惑，嗯，我能感受到你的痛苦。在我看来，数据连接和占位符DOM节点的概念可能是你在学习D3时遇到的最令人困惑的事情。如果你能理解这一点，那么D3的其他部分就不会那么困难了。
- en: '![c13_16.eps](Images/c13_16.png)'
  id: totrans-179
  prefs: []
  type: TYPE_IMG
  zh: '![c13_16.eps](Images/c13_16.png)'
- en: '[Figure 13.16](#figureanchor13.16) Calling the D3 data function on a selection
    (even an empty selection) joins the selection with our data set. This is called
    a data join.'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: '[图13.16](#figureanchor13.16) 在选择上调用D3数据函数（即使是空选择）将选择与我们的数据集连接起来。这被称为数据连接。'
- en: The selection we now have from the data join represents DOM nodes that don’t
    yet exist. If there were SVG group elements already in our visualization, they’d
    appear in the selection alongside the placeholder elements for new data, but we
    don’t have any group elements yet.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在从数据连接中获得的选择代表尚未存在的DOM节点。如果在我们可视化中已经存在SVG组元素，它们将与新数据的占位符元素一起出现在选择中，但我们目前还没有任何组元素。
- en: '[Listing 13.9](#listing13.9) shows the code that produces our data join. Calling
    `selectAll` yields the empty selection. Our data set is then joined using the
    `data` function. Next, note the use of the `enter` function, which filters the
    selection for new data records. The `enter` function allows us to specify what
    happens when new data is added to our visualization. This is where we call D3’s
    `append` function. When we call `append` in the context of the `enter` selection,
    D3 will replace the placeholder DOM nodes with the elements that we want to add
    to our visualization.'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: '[列表 13.9](#listing13.9) 显示了生成数据连接的代码。调用 `selectAll` 产生一个空的选择。然后使用 `data` 函数将数据集连接起来。接下来，注意
    `enter` 函数的使用，它过滤选择以获取新的数据记录。`enter` 函数允许我们指定当新数据添加到我们的可视化中时会发生什么。这就是我们调用 D3 的
    `append` 函数的地方。当我们处于 `enter` 选择上下文中的 `append` 调用时，D3 将用我们想要添加到可视化中的元素替换占位符 DOM
    节点。'
- en: Listing 13.9 Doing a data join and procedurally generating space junk visuals
    (extract from app.js)
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.9 执行数据连接和程序生成太空垃圾视觉效果（摘自 app.js）
- en: '[PRE16]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: '[Listing 13.9](#listing13.9) defines the core of what I’m calling the visualization
    recipe. This is the instruction to D3 that says, “please take all my space junk
    data and create a visual representation.” If you understand this the way that
    I do, you can see why I like to think of it as a data pipeline. [Listing 13.9](#listing13.9)
    is a snippet of code that consumes data and produces a visualization.'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: '[列表 13.9](#listing13.9) 定义了我所称之为可视化配方核心的内容。这是对 D3 的指令，即“请用我的所有太空垃圾数据创建一个视觉表示。”如果您像我一样理解这一点，您就会明白为什么我喜欢将其视为数据管道。[列表
    13.9](#listing13.9) 是一段消耗数据并生成可视化的代码片段。'
- en: Now that we’ve joined our data and created the space junk visuals, you can run
    this code and inspect the DOM hierarchy in your browser’s DevTools to better understand
    how DOM nodes and data records are bound together. Select one of the space junk
    DOM nodes as shown in [figure 13.17](#figure13.17). Now open the browser’s console.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经连接了数据并创建了太空垃圾视觉效果，您可以运行此代码，并在浏览器 DevTools 中检查 DOM 层次结构，以更好地理解 DOM 节点和数据记录是如何绑定在一起的。选择一个如图
    13.17 所示的空间垃圾 DOM 节点。现在打开浏览器的控制台。
- en: Google Chrome has a special variable named `$0`. If you enter this in the console
    and press Enter, the selected DOM element will be displayed for your inspection.
    Now type `$0.__data__` and press Enter. This displays the data record that’s bound
    to the DOM node. The `__data__` property was added by D3, and it’s instructive
    to see how D3 keeps track of its data bindings.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: Google Chrome 有一个名为 `$0` 的特殊变量。如果您在控制台中输入这个变量并按 Enter 键，所选的 DOM 元素将被显示供您检查。现在输入
    `$0.__data__` 并按 Enter 键。这将显示绑定到 DOM 节点的数据记录。`__data__` 属性是由 D3 添加的，看到 D3 如何跟踪其数据绑定是有教育意义的。
- en: '![c13_17.eps](Images/c13_17.png)'
  id: totrans-188
  prefs: []
  type: TYPE_IMG
  zh: '![c13_17.eps](Images/c13_17.png)'
- en: '[Figure 13.17](#figureanchor13.17) Inspecting the data attached to a bound
    DOM using Chrome’s DevTools'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.17](#figureanchor13.17) 使用 Chrome 的 DevTools 检查绑定到 DOM 的数据'
- en: We’re almost done with the first pass of our visualization, and for the moment,
    we have only one more thing to consider. Soon, though, we’ll return to selections
    and data joins and learn how to add new data into our visualization and animate
    it over time.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的第一轮可视化工作即将完成，目前我们只需考虑最后一件事。不过，很快我们就会回到选择和数据连接，学习如何将新数据添加到我们的可视化中，并随时间对其进行动画处理。
- en: 13.8.6 Loading a data file
  id: totrans-191
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.8.6 加载数据文件
- en: To this point, we’ve only used a small selection of data that’s hard-coded into
    app.js. It’s high time that we let this bad boy loose on real data. In the following
    listing we use D3’s `json` function to asynchronously retrieve our data from the
    web server in JSON format (we could also use CSV data).
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们只使用了一小部分硬编码到 app.js 中的数据。现在是时候让这个家伙在真实数据上大显身手了。在下面的列表中，我们使用 D3 的 `json`
    函数异步从网络服务器以 JSON 格式检索我们的数据（我们也可以使用 CSV 数据）。
- en: Listing 13.10a Using D3 to load a real data file (extract from listing-13.10/app.js)
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.10a 使用 D3 加载真实数据文件（摘自 listing-13.10/app.js）
- en: '[PRE17]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: That’s the first pass of our space junk visualization complete. We’re going
    to add more to it in a moment, but take this opportunity to run the code and use
    your browser’s DevTools to explore and understand the DOM that we have constructed
    using D3\. Your visualization should look similar to [figure 13.18](#figure13.18).
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的空间垃圾可视化第一轮已经完成。我们很快会添加更多内容，但请利用这个机会运行代码，并使用您浏览器的 DevTools 探索和理解我们使用 D3 构建的这个
    DOM。您的可视化应该与 [图 13.18](#figure13.18) 类似。
- en: '![c13_18.tif](Images/c13_18.png)'
  id: totrans-196
  prefs: []
  type: TYPE_IMG
  zh: '![c13_18.tif](Images/c13_18.png)'
- en: '[Figure 13.18](#figureanchor13.18) Our partially completed space junk visualization'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.18](#figureanchor13.18) 我们部分完成的太空垃圾可视化'
- en: Most of the code is presented in [listing 13.10b](#listing13.10b). The most
    difficult thing we’ve learned so far is the concept of the data join and the enter
    selection and how that results in a set of placeholder DOM elements, which we
    then replace with our space junk visuals. As you read [listing 13.10b](#listing13.10b),
    please be on the lookout for the calls to `selectAll`, `data`, `enter,` and `append`.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 大部分代码在 [列表 13.10b](#listing13.10b) 中展示。我们迄今为止学到的最困难的事情是数据连接的概念和进入选择，以及它是如何导致一组占位符
    DOM 元素，然后我们用太空垃圾视觉元素替换它们。当你阅读 [列表 13.10b](#listing13.10b) 时，请注意对 `selectAll`、`data`、`enter,`
    和 `append` 的调用。
- en: Listing 13.10b The code for the space junk visualization so far (extract from
    listing-13.10/app.js)
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.10b 到目前为止的太空垃圾可视化代码（摘自列表-13.10/app.js）
- en: '[PRE18]'
  id: totrans-200
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Once you’ve internalized the code in [listing 13.10b](#listing13.10b), you’ll
    probably realize that there isn’t that much to it. You might even wonder why you
    thought D3 was so difficult in the first place.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你理解了 [列表 13.10b](#listing13.10b) 中的代码，你可能会意识到这并没有多少内容。你甚至可能会 wonder 为什么你最初认为
    D3 是如此困难。
- en: 'Well, we aren’t finished yet, and the code is going to become a bit more complicated.
    Before we’re done in this chapter, we’re going to color-code the space junk according
    to size, add simple interactivity to the visualization, and then the crowning
    glory: we’ll animate the visualization year by year so we can clearly see how
    the space junk has accumulated over time.'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 嗯，我们还没有完成，代码将变得更加复杂。在我们完成本章之前，我们将根据大小对太空垃圾进行颜色编码，向可视化添加简单的交互性，然后是最后的荣耀：我们将按年动画化可视化，以便我们可以清楚地看到太空垃圾是如何随时间积累的。
- en: 13.8.7 Color-coding the space junk
  id: totrans-203
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.8.7 对太空垃圾进行颜色编码
- en: At the start of this chapter, you might have noticed that our data specifies
    the size of each space junk object as either small, medium, or large. We’ll now
    use this information to color-code the space junk in the visualization according
    to size.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章的开头，你可能已经注意到我们的数据指定了每个太空垃圾对象的大小为小、中或大。现在我们将使用这些信息来根据大小对可视化中的太空垃圾进行颜色编码。
- en: We’ll apply the color through CSS classes and styling. In the following listing,
    we assign a CSS class name *SMALL*, *MEDIUM,* or *LARGE* to our space junk visuals.
    This value is pulled directly from the data and becomes the CSS class name.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将通过 CSS 类和样式应用颜色。在下面的列表中，我们为我们的太空垃圾视觉元素分配 CSS 类名 *SMALL*、*MEDIUM* 或 *LARGE*。这个值直接从数据中提取，并成为
    CSS 类名。
- en: Listing 13.11a Setting space junk class based on its size (extract from listing-13.11/app.js)
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.11a 基于大小设置太空垃圾类（摘自列表-13.11/app.js）
- en: '[PRE19]'
  id: totrans-207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: The following listing shows how we can now add CSS styles to set the fill color
    for our `circle` elements differently for the different sizes of space junk.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 下面的列表显示了我们现在如何添加 CSS 样式来为不同大小的太空垃圾元素设置不同的填充颜色。
- en: Listing 13.11b CSS to set the color of space junk based on its size (extract
    from listing-13.11/app.css)
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.11b 基于大小设置太空垃圾颜色的 CSS（摘自列表-13.11/app.css）
- en: '[PRE20]'
  id: totrans-210
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: This hasn’t added much complexity to our code, but it makes the visualization
    look better, and it’s a good example of conditional CSS styling that depends on
    the content of our data.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 这并没有给我们的代码增加多少复杂性，但它使可视化看起来更好，并且是条件 CSS 样式的一个好例子，它依赖于我们数据的内容。
- en: 13.8.8 Adding interactivity
  id: totrans-212
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.8.8 添加交互性
- en: We’ve built an unusual visualization with D3, and this shows its power. But
    we also need to see examples of interactivity and animation to really understand
    how far we can go with D3.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用 D3 建立了一个不寻常的可视化，这展示了它的力量。但我们也需要看到交互性和动画的例子，才能真正理解我们可以用 D3 做到什么程度。
- en: First, let’s tackle interactivity. In [figure 13.19](#figure13.19), we can see
    our newly color-coded space junk in addition to descriptive mouse hover text.
    We’ll create this hover text in the same way that we might create any browser-based
    interactivity with JavaScript. We can respond to user input through events; in
    this case we’ll use mouse `hover` and `unhover`, as shown in the following listing.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，让我们解决交互性。在 [图 13.19](#figure13.19) 中，我们可以看到我们新着色的太空垃圾，以及描述性的鼠标悬停文本。我们将以创建任何基于浏览器的交互性（使用
    JavaScript）的相同方式创建此悬停文本。我们可以通过事件响应用户输入；在这种情况下，我们将使用鼠标 `hover` 和 `unhover`，如下面的列表所示。
- en: '![c13_19.tif](Images/c13_19.png)'
  id: totrans-215
  prefs: []
  type: TYPE_IMG
  zh: '![c13_19.tif](Images/c13_19.png)'
- en: '[Figure 13.19](#figureanchor13.19) Color-coded space junk with mouse hover
    text'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.19](#figureanchor13.19) 带有鼠标悬停文本的颜色编码太空垃圾'
- en: Listing 13.11c Handling mouse hover events for space junk visuals (extract from
    listing-13.11/app.js)
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.11c 处理太空垃圾视觉的鼠标悬停事件（摘自 listing-13.11/app.js）
- en: '[PRE21]'
  id: totrans-218
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: In response to the mouse hover event, we’ll make modifications to the visualization.
    In [listing 13.11d](#listing13.11d), we attach new `text` elements for the descriptive
    text. We also modify the size of the space junk (by increasing the radius of the
    `circle` element). This visually brings attention to the particular object we
    have the mouse pointer hovered over.
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 针对鼠标悬停事件，我们将对可视化进行修改。在 [列表 13.11d](#listing13.11d) 中，我们添加新的 `text` 元素用于描述文本。我们还修改了太空垃圾的大小（通过增加
    `circle` 元素的半径）。这从视觉上吸引了我们对鼠标指针悬停的特定对象的注意。
- en: Listing 13.11d Adding hover text to the visualization while the mouse is hovered
    over space junk (extract from listing-13.11/app.js)
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 13.11d 在鼠标悬停在太空垃圾上时添加悬停文本到可视化（摘自 listing-13.11/app.js）
- en: '[PRE22]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Also note in [listing 13.11d](#listing13.11d) how we clean up in response to
    the mouse unhover event by removing the descriptive text and reverting the space
    junk circles to their original size.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 还请注意，在 [列表 13.11d](#listing13.11d) 中，我们如何通过移除描述文本和将太空垃圾圆圈恢复到原始大小来清理鼠标悬停事件。
- en: 13.8.9 Adding a year-by-year launch animation
  id: totrans-223
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 13.8.9 添加按年发射动画
- en: The final touch to our visualization is a year-by-year animation to show space
    junk being launched and accumulating in orbit. This will complete our understanding
    of the D3 data join, and we’ll learn how it’s used to add new data to an existing
    visualization.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可视化的最后一笔是逐年动画，以显示太空垃圾被发射并积累在轨道上。这将完成我们对 D3 数据连接的理解，我们将学习它是如何用于向现有可视化添加新数据的。
- en: '[Figure 13.20](#figure13.20) shows the general form our animation will take:
    we’ll animate forward in time year by year into the future. Each iteration of
    the animation takes one second in real time, but it represents a whole year of
    launches.'
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.20](#figure13.20) 展示了我们的动画将采取的一般形式：我们将按年逐年向前动画。动画的每一迭代在真实时间中持续一秒，但它代表了一整年的发射。'
- en: '![c13_20.eps](Images/c13_20.png)'
  id: totrans-226
  prefs: []
  type: TYPE_IMG
  zh: '![c13_20.eps](Images/c13_20.png)'
- en: '[Figure 13.20](#figureanchor13.20) Animating the visualization year by year,
    adding space junk for each year in turn'
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 13.20](#figureanchor13.20) 按年逐年动画可视化，每年依次添加太空垃圾'
- en: Before the animation starts, we’ll have an empty visualization. Then as each
    iteration completes, we’ll have more and more space junk added to the visualization,
    and you’ll see it building up around the Earth.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 在动画开始之前，我们将有一个空的可视化。然后随着每一迭代的完成，我们将越来越多地将太空垃圾添加到可视化中，你将看到它围绕地球积累。
- en: In the first iteration of the animation, our D3 data join operates as we saw
    earlier in [figure 13.16](#figure13.16). Our visualization is empty, so we’re
    joining the first year’s data with an empty selection to produce a selection of
    placeholder DOM nodes.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 在动画的第一迭代中，我们的 D3 数据连接操作就像我们在 [图 13.16](#figure13.16) 中看到的那样。我们的可视化是空的，所以我们正在将第一年的数据与空选择连接起来，以产生占位符
    DOM 节点的选择。
- en: 'The second and subsequent iterations all work with the existing visualization
    and add new data to it. Now we do have a selection of existing `g` elements that
    are already bound to data records. [Figure 13.21](#figure13.21) shows that the
    result of our data join is a set of bound DOM nodes: now it contains existing
    DOM nodes for data records that were previously added to the visualization, and
    it also contains placeholder DOM nodes for new data records.'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 第二次及以后的迭代都使用现有的可视化并添加新数据到其中。现在我们确实有一个现有的 `g` 元素的选择，这些元素已经绑定到数据记录上。[图 13.21](#figure13.21)
    显示了我们的数据连接的结果是一组绑定的 DOM 节点：现在它包含之前添加到可视化中的数据记录的现有 DOM 节点，并且它还包含新数据记录的占位符 DOM 节点。
- en: Again, we use the `enter` function and `append` function to replace placeholder
    DOM nodes with space junk visuals, which updates the visualization and adds the
    new data. If you were thinking earlier “what’s the point of the*`enter`*function,”
    maybe now this becomes more obvious. The `enter` function allows us to add new
    elements while ignoring existing elements.**
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 再次强调，我们使用 `enter` 函数和 `append` 函数用太空垃圾视觉效果替换占位符 DOM 节点，这更新了可视化并添加了新数据。如果你之前在想“*`enter`*函数有什么用”，现在可能变得更明显了。`enter`
    函数允许我们在忽略现有元素的同时添加新元素。**
- en: '**[Listing 13.12](#listing13.12) shows the code for our animated visualization.
    Pay attention to how `setInterval` creates the iterations of our animation and
    how the data is filtered for each iteration so that we can progressively feed
    new data into our D3 pipeline.'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: '**[列表13.12](#listing13.12**) 展示了我们动画可视化的代码。注意`setInterval`如何创建动画的迭代，以及数据是如何在每个迭代中过滤的，以便我们可以逐步将新数据输入到我们的D3管道中。'
- en: Note in [listing 13.12](#listing13.12) the D3 `transition` function that’s used
    to animate the addition of the space junk to the visualization. This makes the
    space junk appear to launch from the surface of the Earth and then travel to its
    final position. The radius of the space junk’s circle is also animated to bring
    attention to the launch.
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 注意[列表13.12](#listing13.12)中用于动画化添加太空垃圾到可视化中的D3 `transition` 函数。这使得太空垃圾看起来是从地球表面发射出去，然后到达最终位置。太空垃圾圆的半径也被动画化，以引起对发射的注意。
- en: '![c13_21.eps](Images/c13_21.png)'
  id: totrans-234
  prefs: []
  type: TYPE_IMG
  zh: '![c13_21.eps](Images/c13_21.png)'
- en: '[Figure 13.21](#figureanchor13.21) Joining a non-empty selection with data
    produces selection of bound DOM nodes. This contains existing DOM nodes and also
    placeholder DOM nodes for any new data records.'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: '[图13.21](#figureanchor13.21) 将非空选择与数据连接会产生绑定DOM节点的选择。这包含现有的DOM节点，也为任何新的数据记录提供了占位符DOM节点。'
- en: Listing 13.12 Animating the space junk year by year according to launch dates
    (extract from listing-13.12/app.js)
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 列表13.12 按发射日期逐年动画化太空垃圾（摘自列表-13.12/app.js）
- en: '[PRE23]'
  id: totrans-237
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: This chapter has been an overview of the basic concepts and ideas behind D3\.
    I hope it has inspired you to learn more about D3 and to delve further into the
    world of advanced visualizations.
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 本章概述了D3背后的基本概念和思想。我希望它已经激发了你学习更多关于D3以及深入了解高级可视化世界的兴趣。
- en: Your biggest takeaway should be an understanding of the *data* join and entry
    *selection* concepts in D3\. In my opinion, these two concepts are the hardest
    parts of D3 to get your head around. If you’ve understood these, then you’re well
    on your way to mastering D3, but don’t stop here. D3 is a big API and you have
    much more to explore, so please keep on with it. For more background on D3, please
    see the Stanford paper by Bostock, Ogievetsky, and Heer at [http://vis.stanford.edu/files/2011-D3-InfoVis.pdf](http://vis.stanford.edu/files/2011-D3-InfoVis.pdf)[.](http://.)
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 你最大的收获应该是对D3中的*数据*连接和*选择*概念的理解。在我看来，这两个概念是D3中最难理解的部分。如果你已经理解了这些，那么你已经走上了掌握D3的道路，但不要停下来。D3是一个庞大的API，你还有更多要探索，所以请继续前进。有关D3的更多背景信息，请参阅Bostock、Ogievetsky和Heer在斯坦福大学发表的论文[http://vis.stanford.edu/files/2011-D3-InfoVis.pdf](http://vis.stanford.edu/files/2011-D3-InfoVis.pdf)[.]。
- en: 'The end of the book is now drawing near! We’ve covered the main aspects of
    data wrangling: acquisition, storage, retrieval, cleanup, preparation, transformation,
    visualization, and live data. What still remains? Assuming the code you’ve written
    isn’t for personal or one-time use, which it can be (there’s nothing wrong with
    that), we must now deploy our code to a production environment.'
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 书的结尾现在越来越近了！我们已经涵盖了数据整理的主要方面：获取、存储、检索、清理、准备、转换、可视化和实时数据。还有什么剩下？假设你编写的代码不是用于个人或一次性使用（这没什么不好），我们现在必须将我们的代码部署到生产环境中。
- en: Prototyping, development, and testing are only part of the battle. Putting your
    code in front of your user—or many and often-demanding users—will push your code
    to its limits and is likely to expose many problems. The last chapter, “Getting
    to*production,” provides a tour of these problems and the strategies that can
    help you deal with them.*
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 原型设计、开发和测试只是战斗的一部分。将你的代码展示给你的用户——或者许多经常有要求的用户——将把你的代码推向极限，并可能暴露出许多问题。最后一章，“进入*生产*”，对这些问题和可以帮助你应对它们的策略进行了概述。
- en: '*## Summary'
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: '*## 摘要'
- en: 'You did a crash course in SVG, learning the primitives: `circle`, `text`, and
    `g` elements.'
  id: totrans-243
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你进行了SVG的快速课程，学习了原语：`circle`、`text`和`g`元素。
- en: You learned how to do element selection and creation with D3.
  id: totrans-244
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你学习了如何使用D3进行元素选择和创建。
- en: We configured an element’s state with D3.
  id: totrans-245
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们使用D3配置了一个元素的状态。
- en: We discussed doing a data join to produce an animated D3 visualization from
    data.
  id: totrans-246
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们讨论了如何通过数据连接从数据生成动画化的D3可视化。
- en: We added interactivity to our visualization using mouse events.
  id: totrans-247
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们通过鼠标事件为我们的可视化添加了交互性。
- en: We upgraded to real data by loading a JSON file to produce the visualization.*****
  id: totrans-248
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们通过加载JSON文件升级到真实数据以生成可视化。
