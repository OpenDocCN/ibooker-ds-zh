- en: 14 Integrating JPA and Hibernate with Spring
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 14 集成 JPA 和 Hibernate 与 Spring
- en: This chapter covers
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Introducing Spring Framework and dependency injection
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 介绍 Spring 框架和依赖注入
- en: Examining the data access object (DAO) design pattern
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 检查数据访问对象（DAO）设计模式
- en: Creating and generifying a Spring JPA application using the DAO design pattern
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 DAO 设计模式创建和生成 Spring JPA 应用程序
- en: Creating and generifying a Spring Hibernate application using the DAO design
    pattern
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 DAO 设计模式创建和生成 Spring Hibernate 应用程序
- en: In this chapter, we’ll analyze a few different possibilities for integrating
    Spring and Hibernate. Spring is a lightweight but also flexible and universal
    Java framework. It is open source, and it can be used at the level of any layer
    in a Java application. We’ll investigate the principles behind the Spring Framework
    (*dependency injection*, also known as *inversion of control*), and we’ll use
    Spring together with JPA or Hibernate to build Java persistence applications.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将分析几种将 Spring 和 Hibernate 集成的不同可能性。Spring 是一个轻量级但同时也灵活通用的 Java 框架。它是开源的，可以在
    Java 应用程序的任何一层使用。我们将研究 Spring 框架背后的原则（*依赖注入*，也称为 *控制反转*），并且我们将使用 Spring 与 JPA
    或 Hibernate 一起构建 Java 持久化应用程序。
- en: Note To execute the examples from the source code, you’ll first need to run
    the Ch14.sql script.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：要执行源代码中的示例，你首先需要运行 Ch14.sql 脚本。
- en: 14.1 Spring Framework and dependency injection
  id: totrans-8
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.1 Spring 框架和依赖注入
- en: Spring Framework provides a comprehensive infrastructure for developing Java
    applications. It handles the infrastructure so that you can focus on your application,
    and it enables you to build applications from plain old Java objects (POJOs).
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: Spring 框架为开发 Java 应用程序提供了一个全面的架构。它处理基础设施，以便你可以专注于你的应用程序，并使你能够从普通的 Java 对象（POJOs）构建应用程序。
- en: Rod Johnson created Spring in 2002, beginning with his book *Expert One-on-One
    J2EE Design and Development* (Johnson, 2002). The basic idea behind Spring is
    that it simplifies the traditional approach to designing enterprise applications.
    For a quick introduction to the capabilities of the Spring Framework, the book
    *Spring Start Here* by Laurenţiu Spilcă (Spilcă, 2021) is a good source.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: Rod Johnson 于 2002 年创建了 Spring，始于他的书籍 *Expert One-on-One J2EE Design and Development*（Johnson，2002）。Spring
    背后的基本思想是简化传统的企业应用程序设计方法。要快速了解 Spring 框架的功能，Laurențiu Spilcă 的书籍 *Spring Start
    Here*（Spilcă，2021）是一个很好的资源。
- en: A Java application typically consists of objects that collaborate to solve a
    problem. The objects in a program depend on each other. You can use design patterns
    (factory, builder, proxy, decorator, and so on) to compose classes and objects,
    but this burden is on the side of the developer.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 一个 Java 应用程序通常由协作解决问题的对象组成。程序中的对象相互依赖。你可以使用设计模式（工厂、构建器、代理、装饰器等）来组合类和对象，但这种负担在开发者这边。
- en: Spring implements various design patterns. Spring Framework’s *dependency injection*
    pattern (also known as *inversion of control*, or IoC) supports the creation of
    an application consisting of different components and objects.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: Spring 实现了各种设计模式。Spring 框架的 *依赖注入* 模式（也称为 *控制反转*，或 IoC）支持创建由不同组件和对象组成的应用程序。
- en: 'The key characteristic of a framework is exactly this dependency injection
    or IoC. When you call a method from JDK or a library, you are in control. In contrast,
    with a framework, control is inverted: the framework calls *you* (see figure 14.1).
    You must follow the paradigm provided by the framework and fill out your own code.
    The framework defines a skeleton, and you insert the features to fill out that
    skeleton. Your code is under the control of the framework, and the framework calls
    it. This way, you can focus on implementing the business logic rather than on
    the design.'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 框架的关键特征正是这种依赖注入或 IoC。当你从 JDK 或库中调用方法时，你处于控制地位。相比之下，使用框架时，控制是反转的：框架调用 *你*（见图
    14.1）。你必须遵循框架提供的范式并填写自己的代码。框架定义了一个骨架，而你插入特性来填充这个骨架。你的代码处于框架的控制之下，框架调用它。这样，你可以专注于实现业务逻辑，而不是设计。
- en: '![](../../OEBPS/Images/CH14_F01_Tudose2.png)'
  id: totrans-14
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../../OEBPS/Images/CH14_F01_Tudose2.png)'
- en: Figure 14.1 Your code calls a library. A framework calls your code.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.1 你的代码调用库。框架调用你的代码。
- en: The creation, dependency injection, and general lifecycle of objects under the
    control of the Spring Framework are managed by a container. The container will
    combine the application classes and the configuration information (metadata) to
    get a ready-to-run application (figure 14.2). The container is thus at the core
    of the IoC principle.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: Spring 框架下受控的对象的创建、依赖注入和一般生命周期由一个容器管理。容器将结合应用程序类和配置信息（元数据）以获得一个可运行的应用程序（图 14.2）。因此，容器是
    IoC 原则的核心。
- en: '![](../../OEBPS/Images/CH14_F02_Tudose2.png)'
  id: totrans-17
  prefs: []
  type: TYPE_IMG
  zh: '![](../../OEBPS/Images/CH14_F02_Tudose2.png)'
- en: Figure 14.2 The functionality of the Spring IoC container
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.2 Spring IoC 容器的功能
- en: The objects under the management of the IoC container are called *beans*. The
    beans form the backbone of the Spring application.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 由 IoC 容器管理的对象被称为 *beans*。beans 构成了 Spring 应用的骨架。
- en: 14.2 JPA application using Spring and the DAO pattern
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.2 使用 Spring 和 DAO 模式的 JPA 应用程序
- en: In this section, we’ll look at how we can build a JPA application using Spring
    and the data access object (DAO) design pattern. The DAO design pattern creates
    an abstract interface to a database, supporting access operations without exposing
    any internals of the database.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将探讨如何使用 Spring 和数据访问对象（DAO）设计模式构建 JPA 应用程序。DAO 设计模式创建了一个数据库的抽象接口，支持访问操作而不暴露数据库的任何内部信息。
- en: You may argue that the Spring Data JPA repositories we have created and worked
    with already do this, and that is true. We’ll demonstrate in this chapter how
    to build a DAO class, and we’ll discuss when we should prefer this approach instead
    of using Spring Data JPA.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会争辩说，我们已创建并使用过的 Spring Data JPA 存储库已经做到了这一点，这是真的。在本章中，我们将演示如何构建 DAO 类，并讨论何时应优先选择这种方法而不是使用
    Spring Data JPA。
- en: The CaveatEmptor application contains the `Item` and `Bid` classes (listings
    14.1 and 14.2). The entities will now be managed with the help of the Spring Framework.
    The relationship between the `BID` and `ITEM` tables will be kept through a foreign
    key field on the `BID` table side. A field marked with the `@javax.persistence.Transient`
    annotation is excluded from persistence.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: CaveatEmptor 应用程序包含 `Item` 和 `Bid` 类（列表 14.1 和 14.2）。现在将使用 Spring 框架来管理实体。`BID`
    和 `ITEM` 表之间的关系将通过 `BID` 表侧的外键字段保持。带有 `@javax.persistence.Transient` 注解的字段将排除在持久化之外。
- en: Listing 14.1 The `Item` class
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.1 `Item` 类
- en: '[PRE0]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Ⓐ The `id` field is a generated identifier.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `id` 字段是一个生成的标识符。
- en: Ⓑ The `name` field is not null and must have a size from 2 to 255 characters.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ `name` 字段不为空，且大小必须在 2 到 255 个字符之间。
- en: Ⓒ Each `Item` has a reference to its set of `Bid`s. The field is marked as `@Transient`,
    so it is excluded from persistence.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 每个 `Item` 都有一个对其 `Bid` 集合的引用。该字段被标记为 `@Transient`，因此它被排除在持久化之外。
- en: We’ll move our attention to the `Bid` class, as it looks now. It is also an
    entity, and the relationship between `Item` and `Bid` is one-to-many.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将关注 `Bid` 类，如现在所示。它也是一个实体，`Item` 和 `Bid` 之间的关系是一对多。
- en: Listing 14.2 The `Bid` class
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.2 `Bid` 类
- en: '[PRE1]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Ⓐ The `Bid` entity class contains the `id` field as the generated identifier.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `Bid` 实体类包含 `id` 字段作为生成的标识符。
- en: Ⓑ The `amount` field should not be null.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ `amount` 字段不应为空。
- en: Ⓒ Each `Bid` has a non-optional reference to its `Item`. The fetching will be
    lazy, and the name of the joining column is `ITEM_ID`.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 每个 `Bid` 都有一个非可选的对其 `Item` 的引用。获取将是延迟的，连接列的名称是 `ITEM_ID`。
- en: 'To implement the DAO design pattern, we’ll start by creating two interfaces,
    `ItemDao` and `BidDao`, and we’ll declare the access operations that will be implemented:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 要实现 DAO 设计模式，我们首先将创建两个接口，`ItemDao` 和 `BidDao`，并声明将要实现的操作访问：
- en: '[PRE2]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'The `BidDao` interface is declared as follows:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: '`BidDao` 接口声明如下：'
- en: '[PRE3]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '`@Repository` is a marker annotation indicating that the component represents
    a DAO. Besides marking the annotated class as a Spring component, `@Repository`
    will catch the persistence-specific exceptions and will translate them to Spring
    unchecked exceptions. `@Transactional` will make all the methods from inside the
    class transactional, as discussed in section 11.4.3.'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: '`@Repository` 是一个标记注解，表示该组件代表一个 DAO。除了将注解的类标记为 Spring 组件外，`@Repository` 还会捕获持久化特定的异常并将它们转换为
    Spring 未检查的异常。`@Transactional` 将使类内部的所有方法都具有事务性，如第 11.4.3 节所述。'
- en: An `EntityManager` is not thread-safe by itself. We’ll use `@PersistenceContext`
    so that the container injects a proxy object that is thread-safe. Besides injecting
    the dependency on a container-managed entity manager, the `@PersistenceContext`
    annotation has parameters. Setting the persistence type to `EXTENDED` keeps the
    persistence context for the whole lifecycle of a bean.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: '`EntityManager`本身不是线程安全的。我们将使用`@PersistenceContext`，以便容器注入一个线程安全的代理对象。除了在容器管理的实体管理器上注入依赖项之外，`@PersistenceContext`注解还有参数。将持久化类型设置为`EXTENDED`可以保持整个bean的生命周期中的持久化上下文。'
- en: The implementation of the `ItemDao` interface, `ItemDaoImpl`, is shown in the
    following listing.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: '`ItemDao`接口的实现，`ItemDaoImpl`，如下所示。'
- en: Listing 14.3 The `ItemDaoImpl` class
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 列表14.3 `ItemDaoImpl`类
- en: '[PRE4]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Ⓐ The `ItemDaoImpl` class is annotated with `@Repository` and `@Transactional`.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: '`ItemDaoImpl`类被注解为`@Repository`和`@Transactional`。'
- en: Ⓑ The `EntityManager em` field is injected in the application, as annotated
    with `@PersistenceContext`. Persistence type `EXTENDED` means the persistence
    context is kept for the whole lifecycle of a bean.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: '`EntityManager em`字段注入到应用程序中，因为它被注解为`@PersistenceContext`。持久化类型`EXTENDED`意味着持久化上下文在整个bean的生命周期中保持。'
- en: Ⓒ Retrieve an `Item` by its `id`.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 通过`id`检索`Item`。
- en: Ⓓ Retrieve all `Item` entities.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 检索所有`Item`实体。
- en: Ⓔ Persist an `Item` and all its `Bid`s.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 将`Item`及其所有`Bid`持久化。
- en: Ⓕ Update the `name` field of an `Item`.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 更新`Item`的`name`字段。
- en: Ⓖ Remove all the bids belonging to an `Item` and the `Item` itself.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 移除属于一个`Item`及其本身的`Item`的所有出价。
- en: Ⓗ Search for an `Item` by its `name`.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 通过`name`搜索`Item`。
- en: The implementation of the `BidDao` interface, `BidDaoImpl`, is shown in the
    next listing.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: '`BidDao`接口的实现，`BidDaoImpl`，如下所示。'
- en: Listing 14.4 The `BidDaoImpl` class
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 列表14.4 `BidDaoImpl`类
- en: '[PRE5]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Ⓐ The `BidDaoImpl` class is annotated with `@Repository` and `@Transactional`.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: '`BidDaoImpl`类被注解为`@Repository`和`@Transactional`。'
- en: Ⓑ The `EntityManager em` field is injected in the application, as it is annotated
    with `@PersistenceContext`. Setting the persistence type to `EXTENDED` keeps the
    persistence context for the whole lifecycle of a bean.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: '`EntityManager em`字段注入到应用程序中，因为它被注解为`@PersistenceContext`。将持久化类型设置为`EXTENDED`意味着持久化上下文在整个bean的生命周期中保持不变。'
- en: Ⓒ Retrieve a `Bid` by its `id`.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 通过`id`检索`Bid`。
- en: Ⓓ Retrieve all `Bid` entities.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 检索所有`Bid`实体。
- en: Ⓔ Persist a `Bid`.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 持久化一个`Bid`。
- en: Ⓕ Update the `amount` field of a `Bid`.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 更新`Bid`的`amount`字段。
- en: Ⓖ Remove a `Bid`.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 移除一个`Bid`。
- en: Ⓗ Search for a `Bid` by its `amount`.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 通过`amount`搜索`Bid`。
- en: To work with the database, we’ll provide a special class, `DatabaseService`,
    that will be responsible for populating the database and for removing the information
    from it.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 为了与数据库交互，我们将提供一个特殊的类`DatabaseService`，该类将负责填充数据库并从其中删除信息。
- en: Listing 14.5 The `DatabaseService` class
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 列表14.5 `DatabaseService`类
- en: '[PRE6]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Ⓐ The `EntityManager em` field is injected in the application, as it is annotated
    with `@PersistenceContext`. Setting the persistence type to `EXTENDED` keeps the
    persistence context for the whole lifecycle of a bean.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: '`EntityManager em`字段注入到应用程序中，因为它被注解为`@PersistenceContext`。将持久化类型设置为`EXTENDED`可以保持整个bean的生命周期中的持久化上下文。'
- en: Ⓑ The `ItemDao` `itemDao` field is injected in the application, as it is annotated
    with `@Autowired`. Because the `ItemDaoImpl` class is annotated with `@Repository`,
    Spring will create the needed bean belonging to this class, to be injected here.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: '`ItemDao`的`itemDao`字段注入到应用程序中，因为它被注解为`@Autowired`。因为`ItemDaoImpl`类被注解为`@Repository`，Spring将创建属于此类的所需bean，以在此处注入。'
- en: Ⓒ Generate 10 `Item` objects, each of them having 2 `Bid`s, and insert them
    in the database.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 生成10个`Item`对象，每个对象有2个`Bid`，并将它们插入到数据库中。
- en: Ⓓ Delete all previously inserted `Bid` and `Item` objects.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 删除之前插入的所有`Bid`和`Item`对象。
- en: The standard configuration file for Spring is a Java class that creates and
    sets up the needed beans. The `@EnableTransactionManagement` annotation will enable
    Spring’s annotation-driven transaction management capability. When using XML configuration,
    this annotation is mirrored by the `tx:annotation-driven` element. Every interaction
    with the database should occur within transaction boundaries and Spring needs
    a transaction manager bean.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: Spring的标准配置文件是一个Java类，它创建并设置所需的bean。`@EnableTransactionManagement`注解将启用Spring的基于注解的事务管理功能。当使用XML配置时，此注解由`tx:annotation-driven`元素镜像。每次与数据库的交互都应发生在事务边界内，Spring需要一个事务管理器bean。
- en: We’ll create the following configuration file for the application.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将为应用程序创建以下配置文件。
- en: Listing 14.6 The `SpringConfiguration` class
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.6 `SpringConfiguration` 类
- en: '[PRE7]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Ⓐ The `@EnableTransactionManagement` annotation enables Spring’s annotation-driven
    transaction management capability.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `@EnableTransactionManagement` 注解启用了 Spring 的基于注解的事务管理功能。
- en: Ⓑ Create a data source bean.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 创建一个数据源豆。
- en: Ⓒ Indicate the JDBC properties—the driver.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 指定 JDBC 属性——驱动程序。
- en: Ⓓ The URL of the database.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 数据库的 URL。
- en: Ⓔ The username.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓔ 用户名。
- en: Ⓕ There is no password in this configuration. Modify the credentials to correspond
    to the ones on your machine and use a password in practice.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓕ 此配置中没有密码。修改凭证以与您的机器上的凭证对应，并在实际使用中设置密码。
- en: Ⓖ The `DatabaseService` bean that Spring will use to populate and clear the
    database.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓖ Spring 将使用此 `DatabaseService` 豆来填充和清除数据库。
- en: Ⓗ Create a transaction manager bean based on an entity manager factory.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓗ 基于实体管理器工厂创建一个事务管理器豆。
- en: Ⓘ `LocalContainerEntityManagerFactoryBean` is a factory bean that produces an
    `EntityManagerFactory` following the JPA standard container bootstrap contract.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓘ `LocalContainerEntityManagerFactoryBean` 是一个工厂豆，它根据 JPA 标准容器引导合同生成一个 `EntityManagerFactory`。
- en: Ⓙ Set the persistence unit name, defined in persistence.xml.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓙ 设置持久化单元名称，该名称在 persistence.xml 中定义。
- en: Ⓚ Set the data source.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓚ 设置数据源。
- en: Ⓛ Set the packages to scan for entity classes. Beans are located in `com.manning
    .javapersistence.ch14`, so we set this package to be scanned.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓛ 设置扫描实体类的包。豆位于 `com.manning .javapersistence.ch14`，因此我们将此包设置为扫描包。
- en: Ⓜ Create an `ItemDao` bean.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓜ 创建一个 `ItemDao` 豆。
- en: Ⓝ Create a `BidDao` bean.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓝ 创建一个 `BidDao` 豆。
- en: 'This configuration information is used by Spring to create and inject the beans
    that form the backbone of the application. We can use the alternative XML configuration,
    and the application-context.xml file mirrors the work done in SpringConfiguration
    .java. We would just like to emphasize one thing we mentioned previously: in XML,
    we enable Spring’s annotation-driven transaction management capability with the
    help of the `tx:annotation-driven` element, referencing a transaction manager
    bean:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 此配置信息由 Spring 用于创建和注入构成应用程序骨干的豆。我们可以使用替代的 XML 配置，并且 application-context.xml
    文件反映了 SpringConfiguration .java 中完成的工作。我们只想强调我们之前提到的一点：在 XML 中，我们通过 `tx:annotation-driven`
    元素启用 Spring 的基于注解的事务管理功能，并引用事务管理器豆：
- en: '[PRE8]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: The `SpringExtension` extension is used to integrate the Spring test context
    with the JUnit 5 Jupiter test by implementing several JUnit Jupiter extension
    model callback methods.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `SpringExtension` 扩展将 Spring 测试上下文与 JUnit 5 Jupiter 测试集成，通过实现几个 JUnit Jupiter
    扩展模型回调方法。
- en: 'It is important to use the type `PersistenceContextType.`*EXTENDED* for all
    injected `EntityManager` beans. If we used the default `PersistenceContextType.TRANSACTION`
    type, the returned object would become detached at the end of a transaction’s
    execution. Passing it to the `delete` method would result in an “IllegalArgumentException:
    Removing a detached instance” exception.'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: '对于所有注入的 `EntityManager` 豆，使用类型 `PersistenceContextType.`*EXTENDED* 是很重要的。如果我们使用默认的
    `PersistenceContextType.TRANSACTION` 类型，则在事务执行结束时返回的对象将变为分离的。将其传递给 `delete` 方法会导致“IllegalArgumentException:
    Removing a detached instance”异常。'
- en: It is time to test the functionality we’ve developed for persisting the `Item`
    and `Bid` entities.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 是时候测试我们为持久化 `Item` 和 `Bid` 实体所开发的功能了。
- en: Listing 14.7 The `SpringJpaTest` class
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.7 `SpringJpaTest` 类
- en: '[PRE9]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Ⓐ Extend the test using `SpringExtension`. As previously mentioned, this will
    integrate the Spring TestContext Framework into JUnit 5 by implementing several
    JUnit Jupiter extension model callback methods.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ 使用 `SpringExtension` 扩展测试。如前所述，这将通过实现几个 JUnit Jupiter 扩展模型回调方法将 Spring TestContext
    框架集成到 JUnit 5 中。
- en: Ⓑ The Spring test context is configured using the beans defined in the previously
    presented `SpringConfiguration` class.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 使用之前展示的 `SpringConfiguration` 类中定义的豆配置 Spring 测试上下文。
- en: Ⓒ Alternatively, we can configure the test context using XML. Only one Ⓑ of
    the or Ⓒ lines should be active in the code.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 或者，我们可以使用 XML 配置测试上下文。代码中的 Ⓑ 或 Ⓒ 行中只能有一个是活动的。
- en: Ⓓ Autowire one `DatabaseService` bean, one `ItemDao` bean, and one `BidDao`
    bean.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 自动装配一个 `DatabaseService` 豆、一个 `ItemDao` 豆和一个 `BidDao` 豆。
- en: Ⓔ Before the execution of each test, the content of the database is initialized
    by the `init` method from the injected `DatabaseService`.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓔ 在每个测试执行之前，通过注入的 `DatabaseService` 的 `init` 方法初始化数据库的内容。
- en: Ⓕ Retrieve all `Item`s and all `Bid`s and do verifications.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓕ 检索所有 `Item` 和所有 `Bid` 并进行验证。
- en: 'Ⓖ Find an `Item` by its `name` field and delete it from the database. We will
    use `PersistenceContextTyp`e`.EXTENDED` for all injected `EntityManager` beans.
    Otherwise, passing it to the `delete` method would result in an “IllegalArgument-Exception:
    Removing a detached instance” exception.'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 'Ⓖ 通过 `name` 字段查找 `Item` 并从数据库中删除它。我们将使用 `PersistenceContextTyp`e`.EXTENDED`
    为所有注入的 `EntityManager` 实例。否则，将其传递给 `delete` 方法将导致“IllegalArgument-Exception: Removing
    a detached instance”异常。'
- en: Ⓗ After the successful deletion of the `Item` from the database, trying to find
    it again will throw a `NoResultException`. The rest of the tests can be easily
    investigated in the source code.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓗ 在数据库中成功删除 `Item` 后，再次尝试查找它将抛出 `NoResultException`。其余的测试可以在源代码中轻松调查。
- en: Ⓘ After the execution of each test, the content of the database is erased by
    the `clear` method from the injected `DatabaseService`.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓘ 每次测试执行后，数据库的内容都会被注入的 `DatabaseService` 中的 `clear` 方法清除。
- en: 'When should we apply such a solution using the Spring Framework and the DAO
    design pattern? There are a few situations when we would recommend it:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 我们应该在何时应用Spring框架和DAO设计模式这样的解决方案？以下是一些我们推荐使用该解决方案的情况：
- en: You would like to hand off the task of controlling the entity manager and the
    transactions to the Spring Framework (remember that this is done through the *inversion
    of control*). The tradeoff is that you lose the possibility of debugging the transactions.
    Just be aware of that.
  id: totrans-105
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可能希望将控制实体管理器和事务的任务交给Spring框架（记住这是通过 *控制反转* 实现的）。权衡是，你将失去调试事务的可能性。只是要注意这一点。
- en: You would like to create your own API for managing persistence and either you
    cannot or you do not want to use Spring Data. This might happen when you have
    very particular operations that you need to control, or you want to remove the
    Spring Data overhead (including the ramp-up time for the team to adopt it, introducing
    new dependencies in an already existing project, and the execution delay of Spring
    Data, as was discussed in section 2.7).
  id: totrans-106
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可能想创建自己的API来管理持久化，或者你无法使用Spring Data，或者你不想使用Spring Data。这可能发生在你需要控制非常特定的操作时，或者你想要移除Spring
    Data的开销（包括团队采用它的时间、在现有项目中引入新依赖项以及Spring Data的执行延迟，如第2.7节所述）。
- en: In particular situations, you may want to handle the entity manager and the
    transactions to the Spring Framework and still not implement your own DAO classes.
  id: totrans-107
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在特定情况下，你可能希望将实体管理器和事务处理交给Spring框架，同时仍然不实现自己的DAO类。
- en: We would like to improve on the design of our Spring persistence application.
    The next sections are dedicated to making it more generic and using the Hibernate
    API instead of JPA. We’ll focus on the differences between this first solution
    and our new versions, and we’ll discuss how to introduce the changes.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 我们希望改进我们的Spring持久化应用程序的设计。接下来的几节将致力于使其更加通用，并使用Hibernate API而不是JPA。我们将关注第一个解决方案和我们的新版本之间的差异，并讨论如何引入这些更改。
- en: 14.3 Generifying a JPA application that uses Spring and DAO
  id: totrans-109
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.3 使用Spring和DAO的JPA应用程序的泛化
- en: 'If we take a closer look at the `ItemDao` and `BidDao` interfaces and `ItemDaoImpl`
    and `BidDaoImpl` classes we’ve created, we’ll find a few shortcomings:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们仔细查看我们创建的 `ItemDao` 和 `BidDao` 接口以及 `ItemDaoImpl` 和 `BidDaoImpl` 类，我们会发现一些不足之处：
- en: There are similar operations, such as `getById`, `getAll`, `insert`, and `delete`,
    that differ mainly in the type of argument they receive or in the returned result.
  id: totrans-111
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 存在类似的操作，如 `getById`、`getAll`、`insert` 和 `delete`，它们主要区别在于它们接收的参数类型或返回的结果类型。
- en: The `update` method receives as a second argument the value of a particular
    property. We may need to write multiple methods if we need to update different
    properties of an entity.
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`update` 方法接收一个特定的属性的值作为第二个参数。如果我们需要更新实体的不同属性，我们可能需要编写多个方法。'
- en: Methods such as `findByName` or `findByAmount` are tied to particular properties.
    We may need to write different methods for finding an entity using different properties.
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 类似于 `findByName` 或 `findByAmount` 这样的方法与特定的属性相关联。我们可能需要为使用不同属性查找实体编写不同的方法。
- en: Consequently, we’ll introduce a `GenericDao` interface.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们将引入一个 `GenericDao` 接口。
- en: Listing 14.8 The `GenericDao` interface
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 列表14.8 `GenericDao` 接口
- en: '[PRE10]'
  id: totrans-116
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Ⓐ The `getById` and `getAll` methods have a generic return type.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `getById` 和 `getAll` 方法具有通用的返回类型。
- en: Ⓑ The `insert` and `update` methods have generic input, `T entity`.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ `insert` 和 `update` 方法具有通用的输入，`T entity`。
- en: Ⓒ The `update` and `findByProperty` methods will receive as arguments the `propertyName`
    and the new `propertyValue`.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ `update` 和 `findByProperty` 方法将接收 `propertyName` 和新的 `propertyValue` 作为参数。
- en: We’ll create an abstract implementation of the `GenericDao` interface, called
    `AbstractGenericDao`, as shown in listing 14.9\. Here we’ll write the common functionality
    of all DAO classes, and we’ll let concrete classes implement their specifics.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将创建一个 `GenericDao` 接口的抽象实现，称为 `AbstractGenericDao`，如列表 14.9 所示。在这里，我们将编写所有
    DAO 类的共同功能，并让具体类实现它们的特定功能。
- en: We’ll inject an `EntityManager` `em` field in the application, annotating it
    with `@PersistenceContext`. Setting the persistence type to `EXTENDED` keeps the
    persistence context for the whole lifecycle of a bean.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在应用程序中注入一个 `EntityManager` 字段 `em`，并使用 `@PersistenceContext` 进行注解。将持久化类型设置为
    `EXTENDED` 可以在整个 bean 的生命周期中保持持久化上下文。
- en: Listing 14.9 The `AbstractGenericDao` class
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.9 `AbstractGenericDao` 类
- en: '[PRE11]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Ⓐ The `AbstractGenericDao` class is annotated with `@Repository` and `@Transactional`.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `AbstractGenericDao` 类被注解为 `@Repository` 和 `@Transactional`。
- en: Ⓑ The `EXTENDED` persistence type of the `EntityManager` will keep the persistence
    context for the whole lifecycle of a bean. The field is `protected`, to be eventually
    inherited and used by subclasses.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ `EntityManager` 的 `EXTENDED` 持久化类型将保持整个 bean 生命周期的持久化上下文。该字段是 `protected`
    的，最终将被子类继承和使用。
- en: Ⓒ `clazz` is the effective `Class` field on which the DAO will work.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ `clazz` 是 DAO 将在其上工作的有效 `Class` 字段。
- en: Ⓓ Execute a `SELECT` query using the `clazz` entity and setting the `id` as
    a parameter.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 使用 `clazz` 实体和将 `id` 作为参数执行一个 `SELECT` 查询。
- en: Ⓔ Execute a `SELECT` query using the `clazz` entity and get the list of the
    results.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓔ 使用 `clazz` 实体和获取结果列表执行一个 `SELECT` 查询。
- en: Ⓕ Persist the `entity`.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓕ 持久化 `entity`。
- en: Ⓖ Remove the `entity`.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓖ 删除 `entity`。
- en: Ⓗ Execute an `UPDATE` using the `propertyName`, the `propertyValue,` and the
    `id`.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `propertyName`、`propertyValue` 和 `id` 执行一个 `UPDATE` 操作。
- en: Ⓘ Execute a `SELECT` using the `propertyName` and the `propertyValue`.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓘ 使用 `propertyName` 和 `propertyValue` 执行一个 `SELECT`。
- en: The `AbstractGenericDao` class provides most of the general DAO functionality.
    It only needs to be customized a little for particular DAO classes. The `ItemDaoImpl`
    class will extend the `AbstractGenericDao` class and will override some of the
    methods.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: '`AbstractGenericDao` 类提供了大部分通用 DAO 功能。它只需要对特定 DAO 类进行一点定制。`ItemDaoImpl` 类将扩展
    `AbstractGenericDao` 类并覆盖一些方法。'
- en: Listing 14.10 The `ItemDaoImpl` class extending AbstractGenericDao
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.10 扩展 `AbstractGenericDao` 的 `ItemDaoImpl` 类
- en: '[PRE12]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Ⓐ `ItemDaoImpl` extends `AbstractGenericDao` and is generified by `Item`.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `ItemDaoImpl` 扩展了 `AbstractGenericDao` 并通过 `Item` 进行泛型化。
- en: Ⓑ The constructor sets `Item.class` as the entity class to be managed.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 构造函数将 `Item.class` 设置为要管理的实体类。
- en: Ⓒ Persist the `Item` entity and all its `Bid` entities. The `EntityManager em`
    field is inherited from the `AbstractGenericDao` class.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 持久化 `Item` 实体及其所有 `Bid` 实体。`EntityManager em` 字段是从 `AbstractGenericDao` 类继承而来的。
- en: Ⓓ Remove all the bids belonging to an `Item` and the `Item` itself.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 删除属于 `Item` 及其本身的全部投标。
- en: The `BidDaoImpl` class will simply extend the `AbstractGenericDao` class and
    set the entity class to manage.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: '`BidDaoImpl` 类将简单地扩展 `AbstractGenericDao` 类，并设置要管理的实体类。'
- en: Listing 14.11 The `BidDaoImpl` class extending AbstractGenericDao
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.11 扩展 `AbstractGenericDao` 的 `BidDaoImpl` 类
- en: '[PRE13]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Ⓐ `BidDaoImpl` extends `AbstractGenericDao` and is generified by `Bid`.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `BidDaoImpl` 扩展了 `AbstractGenericDao` 并通过 `Bid` 进行泛型化。
- en: Ⓑ The constructor sets `Bid.class` as the entity class to be managed. All other
    methods are inherited from `AbstractGenericDao` and are fully reusable this way.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 构造函数将 `Bid.class` 设置为要管理的实体类。所有其他方法都从 `AbstractGenericDao` 继承而来，并且以这种方式完全可重用。
- en: 'Some small changes are needed for the configuration and testing classes. The
    `SpringConfiguration` class will now declare the two DAO beans as `GenericDao`:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 需要对配置和测试类进行一些小的更改。`SpringConfiguration` 类现在将声明两个 DAO 实例作为 `GenericDao`：
- en: '[PRE14]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'The `DatabaseService` class will inject the `itemDao` field as `GenericDao`:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: '`DatabaseService` 类将注入 `itemDao` 字段作为 `GenericDao`：'
- en: '[PRE15]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'The `SpringJpaTest` class will inject the `itemDao` and `bidDao` fields as
    `GenericDao`:'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: '`SpringJpaTest` 类将注入 `itemDao` 和 `bidDao` 字段作为 `GenericDao`：'
- en: '[PRE16]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: We have now developed an easily extensible DAO class hierarchy using the JPA
    API. We can reuse the already written generic functionality or we can quickly
    overwrite some methods for particular entities (as was the case for `ItemDaoImpl`).
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在已经使用 JPA API 开发了一个易于扩展的 DAO 类层次结构。我们可以重用已经编写的通用功能，或者我们可以快速覆盖特定实体的一些方法（如
    `ItemDaoImpl` 的情况）。
- en: Let’s now move on to the alternative of implementing a Hibernate application
    using Spring and the DAO pattern.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们转向使用 Spring 和 DAO 模式实现 Hibernate 应用程序的替代方案。
- en: 14.4 Hibernate application using Spring and the DAO pattern
  id: totrans-153
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.4 使用 Spring 和 DAO 模式实现的 Hibernate 应用程序
- en: We’ll now demonstrate how to use Spring and the DAO pattern with the Hibernate
    API. As we previously mentioned, we’ll emphasize only the changes between this
    approach and the previous applications.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们将展示如何使用 Spring 和 DAO 模式与 Hibernate API。正如我们之前提到的，我们将强调这种方法与之前应用程序之间的差异。
- en: Calling `sessionFactory.getCurrentSession()` will create a new `Session`, if
    one does not exist. Otherwise, it will use the existing session from the Hibernate
    context. The session will be automatically flushed and closed when a transaction
    ends. Using `sessionFactory.getCurrentSession()` is ideal in single-threaded applications,
    as using a single session will boost performance. In a multithreaded application,
    the session is not thread-safe, so you should use `sessionFactory.openSession()`
    and explicitly close the opened session. Or, as `Session` implements `AutoCloseable`,
    it can be used in try-with-resources blocks.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 调用 `sessionFactory.getCurrentSession()` 将创建一个新的 `Session`（如果不存在的话）。否则，它将使用 Hibernate
    上下文中的现有会话。当事务结束时，会话将自动刷新和关闭。在单线程应用程序中使用 `sessionFactory.getCurrentSession()` 是理想的，因为使用单个会话将提高性能。在多线程应用程序中，会话不是线程安全的，因此您应该使用
    `sessionFactory.openSession()` 并显式关闭打开的会话。或者，因为 `Session` 实现了 `AutoCloseable`
    接口，它可以在 try-with-resources 块中使用。
- en: As the `Item` and `Bid` classes and the `ItemDao` and `BidDao` interfaces remain
    unchanged, we’ll move on to `ItemDaoImpl` and `BidDaoImpl` and see what they look
    like now.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 由于 `Item` 和 `Bid` 类以及 `ItemDao` 和 `BidDao` 接口保持不变，我们将转向 `ItemDaoImpl` 和 `BidDaoImpl`，看看它们现在是什么样子。
- en: Listing 14.12 The `ItemDaoImpl` class using the Hibernate API
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.12 使用 Hibernate API 的 `ItemDaoImpl` 类
- en: '[PRE17]'
  id: totrans-158
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Ⓐ The `ItemDaoImpl` class is annotated with `@Repository` and `@Transactional`.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `ItemDaoImpl` 类被注解为 `@Repository` 和 `@Transactional`。
- en: Ⓑ The `SessionFactory sessionFactory` field is injected in the application,
    as it is annotated with `@Autowired`.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ `SessionFactory sessionFactory` 字段在应用程序中被注入，因为它被注解为 `@Autowired`。
- en: Ⓒ Retrieve an `Item` by its `id`. Calling `sessionFactory.getCurrentSession()`
    will create a new `Session` if one does not exist.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 通过 `id` 检索一个 `Item`。调用 `sessionFactory.getCurrentSession()` 将创建一个新的 `Session`（如果不存在的话）。
- en: Ⓓ Retrieve all `Item` entities.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 检索所有 `Item` 实体。
- en: Ⓔ Persist an `Item` and all its `Bid`s.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓔ 持久化一个 `Item` 及其所有的 `Bid`。
- en: Ⓕ Update the `name` field of an `Item`.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓕ 更新 `Item` 的 `name` 字段。
- en: Ⓖ Remove all the bids belonging to an `Item` and the `Item` itself.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓖ 删除属于 `Item` 及其本身的全部投标。
- en: Ⓗ Search for an `Item` by its `name`.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓗ 通过 `name` 搜索一个 `Item`。
- en: The `BidDaoImpl` class will also mirror the previously implemented functionality
    that used JPA and `EntityManager`, but it will use the Hibernate API and `SessionFactory`.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: '`BidDaoImpl` 类也将反映之前使用 JPA 和 `EntityManager` 实现的功能，但它将使用 Hibernate API 和 `SessionFactory`。'
- en: There are also important changes in the `SpringConfiguration` class. Moving
    from JPA to Hibernate, the `EntityManagerFactory` bean to be injected will be
    replaced with a `SessionFactory`. Similarly, the `JpaTransactionManager` bean
    to be injected will be replaced with a `HibernateTransactionManager`.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 在 `SpringConfiguration` 类中也有重要的更改。从 JPA 转换到 Hibernate，要注入的 `EntityManagerFactory`
    Bean 将被 `SessionFactory` 替换。同样，要注入的 `JpaTransactionManager` Bean 将被 `HibernateTransactionManager`
    替换。
- en: Listing 14.13 The `SpringConfiguration` class using the Hibernate API
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.13 使用 Hibernate API 的 `SpringConfiguration` 类
- en: '[PRE18]'
  id: totrans-170
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Ⓐ The `@EnableTransactionManagement` annotation will enable Spring’s annotation-driven
    transaction management capability.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `@EnableTransactionManagement` 注解将启用 Spring 的基于注解的事务管理功能。
- en: Ⓑ A `LocalSessionFactoryBean` is the `sessionFactory` object to be injected.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ `LocalSessionFactoryBean` 是要注入的 `sessionFactory` 对象。
- en: Ⓒ Set the data source and the packages to scan.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 设置数据源和要扫描的包。
- en: Ⓓ Set the Hibernate properties that will be provided from a separate method.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 设置将从单独的方法中提供的 Hibernate 属性。
- en: Ⓔ Create the Hibernate properties in a separate method.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓔ 在单独的方法中创建 Hibernate 属性。
- en: Ⓕ Create a data source bean.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓕ 创建一个数据源 Bean。
- en: Ⓖ Indicate the JDBC properties—the driver.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓖ 指定 JDBC 属性——驱动程序。
- en: Ⓗ The URL of the database.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓗ 数据库的 URL。
- en: Ⓘ The username.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓘ 用户名。
- en: Ⓙ There is no password in this configuration. Modify the credentials to correspond
    to the ones on your machine, and use a password in practice.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓙ 此配置中没有密码。修改凭据以匹配您机器上的凭据，并在实际操作中使用密码。
- en: Ⓚ A `DatabaseService` bean will be used by Spring to populate and clear the
    database.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓚ 将使用 `DatabaseService` bean 来填充和清除数据库。
- en: Ⓛ Create a transaction manager bean based on a session factory. Every interaction
    with the database should occur within transaction boundaries, so Spring needs
    a transaction manager bean.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓛ 基于会话工厂创建一个事务管理器 bean。每次与数据库的交互都应该在事务边界内进行，因此 Spring 需要一个事务管理器 bean。
- en: Ⓜ Create an `ItemDao` bean.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓜ 创建一个 `ItemDao` bean。
- en: Ⓝ Create a `BidDao` bean.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓝ 创建一个 `BidDao` bean。
- en: We can use the alternative of XML configuration, and the application-context.xml
    file should mirror the work done in SpringConfiguration.java. Enabling Spring’s
    annotation-driven transaction management capability is done with the help of the
    `tx:annotation-driven` element, referencing a transaction manager bean, instead
    of the `@EnableTransactionManagement` annotation.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用 XML 配置的替代方案，并且 application-context.xml 文件应该反映 SpringConfiguration.java
    中完成的工作。启用 Spring 的基于注解的事务管理功能是通过 `tx:annotation-driven` 元素实现的，该元素引用一个事务管理器 bean，而不是使用
    `@EnableTransactionManagement` 注解。
- en: We’ll now demonstrate how to generify this application that uses the Hibernate
    API instead of JPA. As usual, we’ll focus on the differences from the initial
    solution and how to introduce the changes.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在将演示如何泛型化使用 Hibernate API 而不是 JPA 的应用程序。像往常一样，我们将关注与初始解决方案的差异以及如何引入这些更改。
- en: 14.5 Generifying a Hibernate application that uses Spring and DAO
  id: totrans-187
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.5 泛型化使用 Spring 和 DAO 的 Hibernate 应用程序
- en: 'Keep in mind the shortcomings that we previously identified for the JPA solution
    using Data Access Object:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住我们之前为使用数据访问对象 (DAO) 的 JPA 解决方案确定的缺点：
- en: There are similar operations, such as `getById`, `getAll`, `insert`, and `delete`,
    that differ mainly in the type of argument they receive or in the returned result.
  id: totrans-189
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 存在类似的操作，如 `getById`、`getAll`、`insert` 和 `delete`，它们主要区别在于接收的参数类型或返回的结果类型。
- en: The `update` method receives as a second argument the value of a particular
    property. We may need to write multiple methods if we need to update different
    properties of an entity.
  id: totrans-190
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`update` 方法接收一个特定属性的值作为第二个参数。如果我们需要更新实体的不同属性，我们可能需要编写多个方法。'
- en: Methods such as `findByName` or `findByAmount` are tied to particular properties.
    We may need to write different methods for finding an entity using different properties.
  id: totrans-191
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如 `findByName` 或 `findByAmount` 这样的方法与特定的属性相关联。我们可能需要为使用不同属性查找实体编写不同的方法。
- en: To address these shortcomings, we introduced the `GenericDao` interface, shown
    earlier in listing 14.8\. This interface was implemented by the `AbstractGenericDao`
    class (listing 14.9), which now needs to be rewritten using the Hibernate API.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 为了解决这些缺点，我们引入了 `GenericDao` 接口，如前所述在列表 14.8 中所示。该接口由 `AbstractGenericDao` 类（列表
    14.9）实现，现在需要使用 Hibernate API 重新编写。
- en: Listing 14.14 The `AbstractGenericDao` class using the Hibernate API
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.14 使用 Hibernate API 的 `AbstractGenericDao` 类
- en: '[PRE19]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Ⓐ The `AbstractGenericDao` class is annotated with `@Repository` and `@Transactional`.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `AbstractGenericDao` 类被注解为 `@Repository` 和 `@Transactional`。
- en: Ⓑ The `SessionFactory sessionFactory` field is injected in the application,
    as it is annotated with `@Autowired`. It is `protected`, to be inherited and used
    by subclasses.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ `SessionFactory sessionFactory` 字段被注入到应用程序中，因为它被注解为 `@Autowired`。它是 `protected`
    的，以便被子类继承和使用。
- en: Ⓒ `clazz` is the effective `Class` field on which the DAO will work.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ `clazz` 是 DAO 将在其上工作的有效 `Class` 字段。
- en: Ⓓ Execute a `SELECT` query using the `clazz` entity and setting the `id` as
    a parameter.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 使用 `clazz` 实体和设置 `id` 作为参数执行一个 `SELECT` 查询。
- en: Ⓔ Execute a `SELECT` query using the `clazz` entity and get the list of the
    results.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓔ 使用 `clazz` 实体执行一个 `SELECT` 查询并获取结果列表。
- en: Ⓕ Persist the `entity`.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓕ 持久化 `entity`。
- en: Ⓖ Remove the `entity`.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓖ 移除 `entity`。
- en: Ⓗ Execute an `UPDATE` using the `propertyName`, the `propertyValue,` and the
    `id`.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓗ 使用 `propertyName`、`propertyValue` 和 `id` 执行一个 `UPDATE` 操作。
- en: Ⓘ Execute a `SELECT` using the `propertyName` and the `propertyValue`.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓘ 使用 `propertyName` 和 `propertyValue` 执行一个 `SELECT` 操作。
- en: We’ll customize the `AbstractGenericDao` class when it is extended by `ItemDaoImpl`
    and `BidDaoImpl`, this time using the Hibernate API.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 当 `ItemDaoImpl` 和 `BidDaoImpl` 扩展 `AbstractGenericDao` 类时，我们将自定义该类，这次使用 Hibernate
    API。
- en: The `ItemDaoImpl` class will extend the `AbstractGenericDao` class and will
    override some of the methods.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: '`ItemDaoImpl` 类将扩展 `AbstractGenericDao` 类并重写其中的一些方法。'
- en: Listing 14.15 The `ItemDaoImpl` class using the Hibernate API
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 14.15 使用 Hibernate API 的 `ItemDaoImpl` 类
- en: '[PRE20]'
  id: totrans-207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: Ⓐ `ItemDaoImpl` extends `AbstractGenericDao` and is generified by `Item`.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `ItemDaoImpl` 扩展了 `AbstractGenericDao` 并通过 `Item` 进行泛型化。
- en: Ⓑ The constructor sets `Item.class` as the entity class to be managed.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 构造函数将`Item.class`设置为要管理的实体类。
- en: Ⓒ Persist the `Item` entity and all its `Bid` entities. The `sessionFactory`
    field is inherited from the `AbstractGenericDao` class.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓒ 持久化`Item`实体及其所有`Bid`实体。`sessionFactory`字段继承自`AbstractGenericDao`类。
- en: Ⓓ Remove all the bids belonging to an `Item` and the `Item` itself.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓓ 删除属于`Item`及其本身的全部投标。
- en: The `BidDaoImpl` class will simply extend the `AbstractGenericDao` class and
    set the entity class to manage.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: '`BidDaoImpl`类将简单地扩展`AbstractGenericDao`类，并设置要管理的实体类。'
- en: Listing 14.16 The `BidDaoImpl` class using the Hibernate API
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 列表14.16 使用Hibernate API的`BidDaoImpl`类
- en: '[PRE21]'
  id: totrans-214
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Ⓐ `BidDaoImpl` extends `AbstractGenericDao` and is generified by `Bid`.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓐ `BidDaoImpl`扩展了`AbstractGenericDao`并由`Bid`泛化。
- en: Ⓑ The constructor sets `Bid.class` as the entity class to be managed. All other
    methods are inherited from `AbstractGenericDao` and are fully reusable this way.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: Ⓑ 构造函数将`Bid.class`设置为要管理的实体类。所有其他方法都继承自`AbstractGenericDao`，并且以此方式完全可重用。
- en: We have developed an easily extensible DAO class hierarchy using the Hibernate
    API. We can reuse the already written generic functionality or we can quickly
    overwrite some methods for particular entities (as we did for `ItemDaoImpl`).
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经使用Hibernate API开发了一个易于扩展的DAO类层次结构。我们可以重用已经编写的通用功能，或者我们可以快速覆盖特定实体的一些方法（就像我们对`ItemDaoImpl`所做的那样）。
- en: Summary
  id: totrans-218
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: The dependency injection design pattern is the base of the Spring Framework,
    supporting the creation of applications consisting of different components and
    objects.
  id: totrans-219
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 依赖注入设计模式是Spring框架的基础，支持创建由不同组件和对象组成的应用程序。
- en: You can develop a JPA application using the Spring Framework and the DAO pattern.
    Spring controls the `EntityManager`, the transaction manager, and other beans
    used by the application.
  id: totrans-220
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以使用Spring框架和DAO模式开发JPA应用程序。Spring控制`EntityManager`、事务管理器以及应用程序使用的其他bean。
- en: You can generify a JPA application to provide a generic and easily extensible
    DAO base class. The DAO base class contains the common behavior to be inherited
    by all derived DAOs and will allow them to implement only their particular behavior.
  id: totrans-221
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以将JPA应用程序泛化以提供一个通用且易于扩展的DAO基类。DAO基类包含所有派生DAO需要继承的通用行为，并将允许它们仅实现其特定的行为。
- en: You can develop a Hibernate application using the Spring Framework and the DAO
    pattern. Spring controls the `SessionFactory`, the transaction manager, and other
    beans used by the application.
  id: totrans-222
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以使用Spring框架和DAO模式开发Hibernate应用程序。Spring控制`SessionFactory`、事务管理器以及应用程序使用的其他bean。
- en: You can generify a Hibernate application to provide a generic and easily extensible
    DAO base class. The DAO base class contains the common behavior to be inherited
    by all derived DAOs and will allow them to implement only their particular behavior.
  id: totrans-223
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以将Hibernate应用程序泛化以提供一个通用且易于扩展的DAO基类。DAO基类包含所有派生DAO需要继承的通用行为，并将允许它们仅实现其特定的行为。
